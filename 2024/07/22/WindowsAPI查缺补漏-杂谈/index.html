<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>WindowsAPI查缺补漏-杂谈 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="WindowsAPI查缺补漏-杂谈程序开机自启动之前有讲过，这里讲些别的方法。 将程序快捷方式写入开机自启动程序目录法123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475">
<meta property="og:type" content="article">
<meta property="og:title" content="WindowsAPI查缺补漏-杂谈">
<meta property="og:url" content="http://monoceros.github.io/2024/07/22/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%9D%82%E8%B0%88/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="WindowsAPI查缺补漏-杂谈程序开机自启动之前有讲过，这里讲些别的方法。 将程序快捷方式写入开机自启动程序目录法123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://monoceros.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-07-22T12:36:50.000Z">
<meta property="article:modified_time" content="2024-07-23T14:03:59.221Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="逆向工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://monoceros.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://monoceros.github.io/2024/07/22/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%9D%82%E8%B0%88/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WindowsAPI查缺补漏-杂谈',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-23 22:03:59'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WindowsAPI查缺补漏-杂谈</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-22T12:36:50.000Z" title="发表于 2024-07-22 20:36:50">2024-07-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-23T14:03:59.221Z" title="更新于 2024-07-23 22:03:59">2024-07-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WindowsAPI查缺补漏-杂谈"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="WindowsAPI查缺补漏-杂谈"><a href="#WindowsAPI查缺补漏-杂谈" class="headerlink" title="WindowsAPI查缺补漏-杂谈"></a>WindowsAPI查缺补漏-杂谈</h1><h2 id="程序开机自启动"><a href="#程序开机自启动" class="headerlink" title="程序开机自启动"></a>程序开机自启动</h2><p>之前有讲过，这里讲些别的方法。</p>
<h3 id="将程序快捷方式写入开机自启动程序目录法"><a href="#将程序快捷方式写入开机自启动程序目录法" class="headerlink" title="将程序快捷方式写入开机自启动程序目录法"></a>将程序快捷方式写入开机自启动程序目录法</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Shlobj.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">MyCreateShortcut</span><span class="params">(LPTSTR lpszDestFileName, LPTSTR lpszShortcutFileName,LPTSTR lpszWorkingDirectory, WORD wHotKey, <span class="type">int</span> iShowCmd, LPTSTR lpszDescription)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    GUID guid = &#123; <span class="number">0xB97D20BB</span>, <span class="number">0xF46A</span>, <span class="number">0x4C97</span>, &#123;<span class="number">0xBA</span>, <span class="number">0x10</span>, <span class="number">0x5E</span>, <span class="number">0x36</span>, <span class="number">0x08</span>, <span class="number">0x43</span>, <span class="number">0x08</span>, <span class="number">0x54</span>&#125; &#125;;</span><br><span class="line">    LPTSTR lpStrStartup;                        <span class="comment">// 返回当前用户的开机自动启动程序目录</span></span><br><span class="line">    TCHAR szDestFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;     <span class="comment">// 可执行文件完整路径</span></span><br><span class="line">    TCHAR szFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;         <span class="comment">// 可执行文件名称</span></span><br><span class="line">    TCHAR szShortcutFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;; <span class="comment">// 快捷方式的保存路径</span></span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_OK: &#123;</span><br><span class="line">                    <span class="comment">// 获取当前用户的开机自动启动程序目录</span></span><br><span class="line">                    <span class="built_in">SHGetKnownFolderPath</span>(guid, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;lpStrStartup);</span><br><span class="line">                    <span class="comment">// 获取当前进程的可执行文件完整路径</span></span><br><span class="line">                    <span class="built_in">GetModuleFileName</span>(<span class="literal">NULL</span>, szDestFileName, _countof(szDestFileName));</span><br><span class="line">                    <span class="comment">// 拼凑快捷方式的保存路径</span></span><br><span class="line">                    <span class="comment">// 开机自动启动程序目录后面加一个反斜杠</span></span><br><span class="line">                    <span class="built_in">StringCchCopy</span>(szShortcutFileName, _countof(szShortcutFileName), lpStrStartup);</span><br><span class="line">                    <span class="keyword">if</span> (szShortcutFileName[_tcslen(szShortcutFileName) - <span class="number">1</span>] != <span class="built_in">TEXT</span>(<span class="string">&#x27;\\&#x27;</span>))</span><br><span class="line">                        <span class="built_in">StringCchCat</span>(szShortcutFileName, _countof(szShortcutFileName), <span class="built_in">TEXT</span>(<span class="string">&quot;\\&quot;</span>));</span><br><span class="line">                    <span class="comment">// 可执行文件名称.lnk</span></span><br><span class="line">                    <span class="built_in">StringCchCopy</span>(szFileName, _countof(szFileName), _tcsrchr(szDestFileName, <span class="built_in">TEXT</span>(<span class="string">&#x27;\\&#x27;</span>)) + <span class="number">1</span>);</span><br><span class="line">                    *(_tcsrchr(szFileName, <span class="built_in">TEXT</span>(<span class="string">&#x27;.&#x27;</span>)) + <span class="number">1</span>) = <span class="built_in">TEXT</span>(<span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">                    <span class="built_in">StringCchCat</span>(szFileName, _countof(szFileName), <span class="built_in">TEXT</span>(<span class="string">&quot;lnk&quot;</span>));</span><br><span class="line">                    <span class="comment">// 开机自动启动程序目录\可执行文件名称.lnk</span></span><br><span class="line">                    <span class="built_in">StringCchCat</span>(szShortcutFileName, _countof(szShortcutFileName), szFileName);</span><br><span class="line">                    <span class="comment">// 调用自定义函数MyCreateShortcut创建快捷方式</span></span><br><span class="line">                    <span class="built_in">MyCreateShortcut</span>(szDestFileName, szShortcutFileName, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                    <span class="built_in">CoTaskMemFree</span>(lpStrStartup);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*********************************************************************************</span></span><br><span class="line"><span class="comment">  * 函数功能：		通过调用COM库接口函数创建程序快捷方式</span></span><br><span class="line"><span class="comment">  * 输入参数的说明：</span></span><br><span class="line"><span class="comment">    1. lpszDestFileName参数表示快捷方式指向的目标文件路径，必须指定</span></span><br><span class="line"><span class="comment">    2. lpszShortcutFileName参数表示快捷方式的保存路径(扩展名为.lnk)，必须指定</span></span><br><span class="line"><span class="comment">    3. lpszWorkingDirectory参数表示起始位置(工作目录)，如果设置为NULL表示程序所在目录</span></span><br><span class="line"><span class="comment">    4. wHotKey参数表示快捷键，设置为0表示不设置快捷键</span></span><br><span class="line"><span class="comment">    5. iShowCmd参数表示运行方式，可以设置为SW_SHOWNORMAL、SW_SHOWMINNOACTIVE或SW_SHOWMAXIMIZED</span></span><br><span class="line"><span class="comment">       分别表示常规窗口、最小化或最大化，设置为0表示常规窗口</span></span><br><span class="line"><span class="comment">    6. lpszDescription参数表示备注(描述)，可以设置为NULL</span></span><br><span class="line"><span class="comment">  * 注意：该函数需要使用tchar.h和Shlobj.h头文件</span></span><br><span class="line"><span class="comment">**********************************************************************************/</span></span><br><span class="line"><span class="function">BOOL <span class="title">MyCreateShortcut</span><span class="params">(LPTSTR lpszDestFileName, LPTSTR lpszShortcutFileName, LPTSTR lpszWorkingDirectory, WORD wHotKey, <span class="type">int</span> iShowCmd, LPTSTR lpszDescription)</span> </span>&#123;</span><br><span class="line">    HRESULT hr;</span><br><span class="line">    <span class="keyword">if</span> (lpszDestFileName == <span class="literal">NULL</span> || lpszShortcutFileName == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 初始化COM库</span></span><br><span class="line">    <span class="built_in">CoInitializeEx</span>(<span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 创建一个IShellLink对象</span></span><br><span class="line">    IShellLink* pShellLink;</span><br><span class="line">    hr = <span class="built_in">CoCreateInstance</span>(CLSID_ShellLink, <span class="literal">NULL</span>, CLSCTX_SERVER, IID_IShellLink, (LPVOID*)&amp;pShellLink);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 使用返回的IShellLink对象中的方法设置快捷方式的属性</span></span><br><span class="line">    <span class="comment">// 目标文件路径</span></span><br><span class="line">    pShellLink-&gt;<span class="built_in">SetPath</span>(lpszDestFileName);</span><br><span class="line">    <span class="comment">// 起始位置(工作目录)</span></span><br><span class="line">    <span class="keyword">if</span> (!lpszWorkingDirectory) &#123;</span><br><span class="line">        TCHAR szWorkingDirectory[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="built_in">StringCchCopy</span>(szWorkingDirectory, _countof(szWorkingDirectory), lpszDestFileName);</span><br><span class="line">        LPTSTR lpsz = _tcsrchr(szWorkingDirectory, <span class="built_in">TEXT</span>(<span class="string">&#x27;\\&#x27;</span>));</span><br><span class="line">        *lpsz = <span class="built_in">TEXT</span>(<span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">        pShellLink-&gt;<span class="built_in">SetWorkingDirectory</span>(szWorkingDirectory);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pShellLink-&gt;<span class="built_in">SetWorkingDirectory</span>(lpszWorkingDirectory);</span><br><span class="line">    <span class="comment">// 快捷键(低字节表示虚拟键码，高字节表示修饰键)</span></span><br><span class="line">    <span class="keyword">if</span> (wHotKey != <span class="number">0</span>)</span><br><span class="line">        pShellLink-&gt;<span class="built_in">SetHotkey</span>(wHotKey);</span><br><span class="line">    <span class="comment">// 运行方式</span></span><br><span class="line">    <span class="keyword">if</span> (!iShowCmd)</span><br><span class="line">        pShellLink-&gt;<span class="built_in">SetShowCmd</span>(SW_SHOWNORMAL);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pShellLink-&gt;<span class="built_in">SetShowCmd</span>(iShowCmd);</span><br><span class="line">    <span class="comment">// 备注(描述)</span></span><br><span class="line">    <span class="keyword">if</span> (lpszDescription != <span class="literal">NULL</span>)</span><br><span class="line">        pShellLink-&gt;<span class="built_in">SetDescription</span>(lpszDescription);</span><br><span class="line">    <span class="comment">// 调用IShellLink的父类IUnknown中的QueryInterface方法获取IPersistFile对象</span></span><br><span class="line">    IPersistFile* pPersistFile;</span><br><span class="line">    hr = pShellLink-&gt;<span class="built_in">QueryInterface</span>(IID_IPersistFile, (LPVOID*)&amp;pPersistFile);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) &#123;</span><br><span class="line">        pShellLink-&gt;<span class="built_in">Release</span>();</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 使用获取到的IPersistFile对象中的Save方法保存快捷方式到指定位置</span></span><br><span class="line">    pPersistFile-&gt;<span class="built_in">Save</span>(lpszShortcutFileName, TRUE);</span><br><span class="line">    <span class="comment">// 释放相关对象</span></span><br><span class="line">    pPersistFile-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    pShellLink-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 关闭COM库</span></span><br><span class="line">    <span class="built_in">CoUninitialize</span>();</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="创建计划任务法"><a href="#创建计划任务法" class="headerlink" title="创建计划任务法"></a>创建计划任务法</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Taskschd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;comdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;taskschd.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 创建任务计划</span></span><br><span class="line"><span class="function">BOOL <span class="title">MyCreateTaskScheduler</span><span class="params">(LPCTSTR lpszTaskName, LPCTSTR lpszProgramPath,LPCTSTR lpszParameter, LPCTSTR lpszAuthor)</span></span>;</span><br><span class="line"><span class="comment">// 删除任务计划</span></span><br><span class="line"><span class="function">BOOL <span class="title">MyDeleteTaskScheduler</span><span class="params">(LPCTSTR lpszTaskName)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_OK: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">MyCreateTaskScheduler</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;开机运行HelloWindows&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;F:\\Source\\Windows\\Chapter2\\HelloWindows\\Debug\\HelloWindows.exe&quot;</span>), <span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;老王出品&quot;</span>)))</span><br><span class="line">                        <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;创建任务计划成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;操作成功&quot;</span>), MB_OK);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_DELETE: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">MyDeleteTaskScheduler</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;开机运行HelloWindows&quot;</span>)))</span><br><span class="line">                        <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;删除任务计划成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;操作成功&quot;</span>), MB_OK);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*********************************************************************************</span></span><br><span class="line"><span class="comment">  * 函数功能：		通过调用COM库接口函数创建任务计划实现程序开机自动启动</span></span><br><span class="line"><span class="comment">  * 输入参数的说明：</span></span><br><span class="line"><span class="comment">    1. lpszTaskName参数表示任务名称，必须指定</span></span><br><span class="line"><span class="comment">    2. lpszProgramPath参数表示要开机自动启动的程序路径，必须指定</span></span><br><span class="line"><span class="comment">    3. lpszParameter参数表示程序参数，不需要可以设置为NULL</span></span><br><span class="line"><span class="comment">    4. lpszAuthor参数表示创建者，不需要可以设置为NULL</span></span><br><span class="line"><span class="comment">  * 注意：该函数需要使用Taskschd.h和comdef.h头文件，并需要taskschd.lib导入库</span></span><br><span class="line"><span class="comment">**********************************************************************************/</span></span><br><span class="line"><span class="function">BOOL <span class="title">MyCreateTaskScheduler</span><span class="params">(LPCTSTR lpszTaskName, LPCTSTR lpszProgramPath, LPCTSTR lpszParameter, LPCTSTR lpszAuthor)</span> </span>&#123;</span><br><span class="line">    HRESULT hr;</span><br><span class="line">    <span class="keyword">if</span> (!lpszTaskName || !lpszProgramPath)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 初始化COM并设置COM安全级别</span></span><br><span class="line">    hr = <span class="built_in">CoInitializeEx</span>(<span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    hr = <span class="built_in">CoInitializeSecurity</span>(<span class="literal">NULL</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, RPC_C_AUTHN_LEVEL_PKT_PRIVACY, RPC_C_IMP_LEVEL_IMPERSONATE, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 创建一个ITaskService对象</span></span><br><span class="line">    ITaskService* pTaskService;</span><br><span class="line">    hr = <span class="built_in">CoCreateInstance</span>(CLSID_TaskScheduler, <span class="literal">NULL</span>, CLSCTX_SERVER, IID_ITaskService, (LPVOID*)&amp;pTaskService);</span><br><span class="line">    <span class="comment">// 先连接到本地电脑任务服务，然后才可以使用ITaskService对象中的其他方法</span></span><br><span class="line">    hr = pTaskService-&gt;<span class="built_in">Connect</span>(<span class="type">_variant_t</span>(), <span class="type">_variant_t</span>(), <span class="type">_variant_t</span>(), <span class="type">_variant_t</span>());</span><br><span class="line">    <span class="comment">// 获取根任务文件夹的路径</span></span><br><span class="line">    ITaskFolder* pTaskFolder;</span><br><span class="line">    hr = pTaskService-&gt;<span class="built_in">GetFolder</span>((BSTR)<span class="built_in">TEXT</span>(<span class="string">&quot;\\&quot;</span>), &amp;pTaskFolder);</span><br><span class="line">    <span class="comment">// 如果已经存在相同任务名称的任务计划，则删除</span></span><br><span class="line">    pTaskFolder-&gt;<span class="built_in">DeleteTask</span>((BSTR)lpszTaskName, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 创建ITaskDefinition对象(任务定义对象)，使用ITaskDefinition对象定义任务的信息</span></span><br><span class="line">    ITaskDefinition* pTaskDefinition;</span><br><span class="line">    hr = pTaskService-&gt;<span class="built_in">NewTask</span>(<span class="number">0</span>, &amp;pTaskDefinition);</span><br><span class="line">    pTaskService-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 设置注册信息</span></span><br><span class="line">    IRegistrationInfo* pRegistrationInfo;</span><br><span class="line">    hr = pTaskDefinition-&gt;<span class="built_in">get_RegistrationInfo</span>(&amp;pRegistrationInfo);</span><br><span class="line">    hr = pRegistrationInfo-&gt;<span class="built_in">put_Author</span>((BSTR)lpszAuthor);</span><br><span class="line">    pRegistrationInfo-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 设置主体信息</span></span><br><span class="line">    IPrincipal* pPrincipal;</span><br><span class="line">    hr = pTaskDefinition-&gt;<span class="built_in">get_Principal</span>(&amp;pPrincipal);</span><br><span class="line">    hr = pPrincipal-&gt;<span class="built_in">put_LogonType</span>(TASK_LOGON_INTERACTIVE_TOKEN);</span><br><span class="line">    hr = pPrincipal-&gt;<span class="built_in">put_RunLevel</span>(TASK_RUNLEVEL_HIGHEST);</span><br><span class="line">    pPrincipal-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 设置配置信息</span></span><br><span class="line">    ITaskSettings* pTaskSettings;</span><br><span class="line">    hr = pTaskDefinition-&gt;<span class="built_in">get_Settings</span>(&amp;pTaskSettings);</span><br><span class="line">    hr = pTaskSettings-&gt;<span class="built_in">put_StopIfGoingOnBatteries</span>(VARIANT_FALSE);</span><br><span class="line">    hr = pTaskSettings-&gt;<span class="built_in">put_DisallowStartIfOnBatteries</span>(VARIANT_FALSE);</span><br><span class="line">    hr = pTaskSettings-&gt;<span class="built_in">put_AllowDemandStart</span>(VARIANT_TRUE);</span><br><span class="line">    hr = pTaskSettings-&gt;<span class="built_in">put_StartWhenAvailable</span>(VARIANT_FALSE);</span><br><span class="line">    hr = pTaskSettings-&gt;<span class="built_in">put_MultipleInstances</span>(TASK_INSTANCES_PARALLEL);</span><br><span class="line">    hr = pTaskSettings-&gt;<span class="built_in">put_WakeToRun</span>(VARIANT_TRUE);</span><br><span class="line">    pTaskSettings-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 获取IActionCollection对象</span></span><br><span class="line">    IActionCollection* pActionCollection;</span><br><span class="line">    hr = pTaskDefinition-&gt;<span class="built_in">get_Actions</span>(&amp;pActionCollection);</span><br><span class="line">    <span class="comment">// 创建执行操作</span></span><br><span class="line">    IAction* pAction;</span><br><span class="line">    hr = pActionCollection-&gt;<span class="built_in">Create</span>(TASK_ACTION_EXEC, &amp;pAction);</span><br><span class="line">    pActionCollection-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 获取IExecAction对象</span></span><br><span class="line">    IExecAction* pExecAction;</span><br><span class="line">    hr = pAction-&gt;<span class="built_in">QueryInterface</span>(IID_IExecAction, (LPVOID*)&amp;pExecAction);</span><br><span class="line">    pAction-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 设置可执行文件路径和参数</span></span><br><span class="line">    hr = pExecAction-&gt;<span class="built_in">put_Path</span>((BSTR)lpszProgramPath);</span><br><span class="line">    hr = pExecAction-&gt;<span class="built_in">put_Arguments</span>((BSTR)lpszParameter);</span><br><span class="line">    pExecAction-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 获取ITriggerCollection对象</span></span><br><span class="line">    ITriggerCollection* pTriggerCollection;</span><br><span class="line">    hr = pTaskDefinition-&gt;<span class="built_in">get_Triggers</span>(&amp;pTriggerCollection);</span><br><span class="line">    <span class="comment">// 创建触发器</span></span><br><span class="line">    ITrigger* pTrigger;</span><br><span class="line">    hr = pTriggerCollection-&gt;<span class="built_in">Create</span>(TASK_TRIGGER_LOGON, &amp;pTrigger);</span><br><span class="line">    pTriggerCollection-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 保存任务到根任务文件夹</span></span><br><span class="line">    IRegisteredTask* pRegisteredTask;</span><br><span class="line">    hr = pTaskFolder-&gt;<span class="built_in">RegisterTaskDefinition</span>((BSTR)lpszTaskName, pTaskDefinition, TASK_CREATE_OR_UPDATE, <span class="type">_variant_t</span>(), <span class="type">_variant_t</span>(), TASK_LOGON_INTERACTIVE_TOKEN, <span class="type">_variant_t</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>)), &amp;pRegisteredTask);</span><br><span class="line">    <span class="comment">// 释放相关对象</span></span><br><span class="line">    pRegisteredTask-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    pTaskDefinition-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    pTaskFolder-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 关闭COM库</span></span><br><span class="line">    <span class="built_in">CoUninitialize</span>();</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">MyDeleteTaskScheduler</span><span class="params">(LPCTSTR lpszTaskName)</span> </span>&#123;</span><br><span class="line">    HRESULT hr;</span><br><span class="line">    <span class="keyword">if</span> (!lpszTaskName)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 初始化COM并设置COM安全级别</span></span><br><span class="line">    hr = <span class="built_in">CoInitializeEx</span>(<span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    hr = <span class="built_in">CoInitializeSecurity</span>(<span class="literal">NULL</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, RPC_C_AUTHN_LEVEL_PKT_PRIVACY, RPC_C_IMP_LEVEL_IMPERSONATE, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 创建一个ITaskService对象</span></span><br><span class="line">    ITaskService* pTaskService;</span><br><span class="line">    hr = <span class="built_in">CoCreateInstance</span>(CLSID_TaskScheduler, <span class="literal">NULL</span>, CLSCTX_SERVER, IID_ITaskService, (LPVOID*)&amp;pTaskService);</span><br><span class="line">    <span class="comment">// 先连接到本地电脑任务服务，然后才可以使用ITaskService对象中的其他方法</span></span><br><span class="line">    hr = pTaskService-&gt;<span class="built_in">Connect</span>(<span class="type">_variant_t</span>(), <span class="type">_variant_t</span>(), <span class="type">_variant_t</span>(), <span class="type">_variant_t</span>());</span><br><span class="line">    <span class="comment">// 获取根任务文件夹的路径</span></span><br><span class="line">    ITaskFolder* pTaskFolder;</span><br><span class="line">    hr = pTaskService-&gt;<span class="built_in">GetFolder</span>((BSTR)<span class="built_in">TEXT</span>(<span class="string">&quot;\\&quot;</span>), &amp;pTaskFolder);</span><br><span class="line">    <span class="comment">// 删除任务计划</span></span><br><span class="line">    pTaskFolder-&gt;<span class="built_in">DeleteTask</span>((BSTR)lpszTaskName, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 释放相关对象</span></span><br><span class="line">    pTaskFolder-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    pTaskService-&gt;<span class="built_in">Release</span>();</span><br><span class="line">    <span class="comment">// 关闭COM库</span></span><br><span class="line">    <span class="built_in">CoUninitialize</span>();</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="系统服务"><a href="#系统服务" class="headerlink" title="系统服务"></a>系统服务</h2><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>用<code>OpenSCManager</code>建立到指定计算机上服务控制管理器的链接，并打开指定服务控制管理器数据库，成功返回服务控制管理器句柄，失败返回NULL，不需要时用<code>CloseServiceHandle</code>关闭服务句柄。</p>
<p>用<code>EnumServicesStatuesEx</code>枚举服务控制管理器数据库中的服务，返回一个ENUM_SERVICE_STATUS_PROCESS结构数组，每个数组元素对应一个服务的信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_ENUM_SERVICE_STATUS_PROCESS</span> &#123;</span><br><span class="line">	LPTSTR                    lpServiceName; <span class="comment">//服务名称</span></span><br><span class="line">	LPTSTR                    lpDisplayName; <span class="comment">//用来标识服务的显示名称</span></span><br><span class="line">	SERVICE_STATUS_PROCESS    ServiceStatusProcess;</span><br><span class="line">&#125; ENUM_SERVICE_STATUS_PROCESS, * LPENUM_SERVICE_STATUS_PROCESS;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SERVICE_STATUS_PROCESS</span> &#123;</span><br><span class="line">	DWORD   dwServiceType; <span class="comment">//服务类型</span></span><br><span class="line">	DWORD   dwCurrentState; <span class="comment">//服务当前状态</span></span><br><span class="line">	DWORD   dwControlsAccepted; <span class="comment">//服务可接收并在其处理函数中处理的控制代码 以及对应类型的通知</span></span><br><span class="line">	DWORD   dwWin32ExitCode; <span class="comment">//用于报告启动或停止时发生错误的错误代码</span></span><br><span class="line">	DWORD   dwServiceSpecificExitCode; <span class="comment">//服务启动或停止时发生错误的服务特定错误代码</span></span><br><span class="line">	DWORD   dwCheckPoint; <span class="comment">//用于跟踪服务操作的进度</span></span><br><span class="line">	DWORD   dwWaitHint; <span class="comment">//服务操作所需估计事件</span></span><br><span class="line">	DWORD   dwProcessId; <span class="comment">//服务的进程ID</span></span><br><span class="line">	DWORD   dwServiceFlags; <span class="comment">//服务是否在系统进程中运行</span></span><br><span class="line">&#125; SERVICE_STATUS_PROCESS, * LPSERVICE_STATUS_PROCESS;</span><br></pre></td></tr></table></figure>

<p>dwCurrentState可以是：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SERVICE_START_PENDING</td>
<td>正在启动</td>
</tr>
<tr>
<td>SERVICE_RUNNING</td>
<td>正在运行</td>
</tr>
<tr>
<td>SERVICE_STOP_PENDING</td>
<td>正在停止</td>
</tr>
<tr>
<td>SERVICE_STOPPED</td>
<td>已停止</td>
</tr>
<tr>
<td>SERVICE_PAUSE_PENDING</td>
<td>正在暂停</td>
</tr>
<tr>
<td>SERVICE_PAUSED</td>
<td>已暂停</td>
</tr>
<tr>
<td>SERVICE_CONTINUE_PENDING</td>
<td>正在继续</td>
</tr>
</tbody></table>
<p>dwControlsAccepted字段常用的有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SERVICE_ACCEPT_STOP</td>
<td>可以停止</td>
</tr>
<tr>
<td>SERVICE_ACCEPT_PAUSE_CONTINUE</td>
<td>可以暂停并继续</td>
</tr>
</tbody></table>
<p>用<code>OpenService</code>打开服务，执行成功返回服务句柄，失败NULL，不需要时用<code>CloseServiceHandle</code>关闭服务句柄。再用<code>QueryServiceConfig</code>查询该服务配置参数，返回QUERY_SERVICE_CONFIG结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_QUERY_SERVICE_CONFIG</span> &#123;</span><br><span class="line">	DWORD   dwServiceType; <span class="comment">//服务类型</span></span><br><span class="line">	DWORD   dwStartType; <span class="comment">//启动类型</span></span><br><span class="line">	DWORD   dwErrorControl; <span class="comment">//无法启动时采取的措施</span></span><br><span class="line">	LPTSTR  lpBinaryPathName; <span class="comment">//服务的文件路径</span></span><br><span class="line">	LPTSTR  lpLoadOrderGroup; <span class="comment">//服务所属加载顺序组名称</span></span><br><span class="line">	DWORD   dwTagId; <span class="comment">//lpLoadOrderGroup指定组中此服务UID</span></span><br><span class="line">	LPTSTR  lpDependencies; <span class="comment">//服务名或加载顺序组名的数组指针</span></span><br><span class="line">	LPTSTR  lpServiceStartName; <span class="comment">//进程运行时将登录的账户名称</span></span><br><span class="line">	LPTSTR  lpDisplayName; <span class="comment">//服务显示名称</span></span><br><span class="line">&#125; QUERY_SERVICE_CONFIG, * LPQUERY_SERVICE_CONFIG;</span><br></pre></td></tr></table></figure>

<p>dwStartType有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SERVICE_BOOT_START</td>
<td>自动启动，用于驱动程序</td>
</tr>
<tr>
<td>SERVICE_SYSTEM_START</td>
<td>手动启动，用于驱动程序</td>
</tr>
<tr>
<td>SERVICE_AUTO_START</td>
<td>自动启动</td>
</tr>
<tr>
<td>SERVICE_DEMAND_START</td>
<td>手动启动</td>
</tr>
<tr>
<td>SERVICE_DISABLED</td>
<td>禁用</td>
</tr>
</tbody></table>
<p>用<code>QueryServiceConfig2</code>可查询服务其他配置，其中第2个参数为SERVICE_CONFIG_DESCRIPTION时返回SERVICE_DESCRIPTION结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SERVICE_DESCRIPTION</span> &#123;</span><br><span class="line">    LPTSTR      lpDescription; <span class="comment">//服务描述字符串</span></span><br><span class="line">&#125; SERVICE_DESCRIPTION, *LPSERVICE_DESCRIPTION;</span><br></pre></td></tr></table></figure>

<h3 id="StartService"><a href="#StartService" class="headerlink" title="StartService"></a>StartService</h3><p>启动指定服务：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">StartService</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ SC_HANDLE hService, <span class="comment">//服务句柄 需要SERVICE_START访问权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwNumServiceArgs, <span class="comment">//lpServiceArgVectos数组元素个数</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR* lpServiceArgVectors <span class="comment">//传递给服务的ServiceMain函数的参数数组</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;<span class="comment">//成功返回非0 失败0</span></span><br></pre></td></tr></table></figure>

<h3 id="ControlService"><a href="#ControlService" class="headerlink" title="ControlService"></a>ControlService</h3><p>向指定服务发送控制代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">ControlService</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ SC_HANDLE hService, <span class="comment">//服务句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwControl, <span class="comment">//控制代码</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_ LPSERVICE_STATUS lpServiceStatus <span class="comment">//返回最新服务状态信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回非0 失败0</span></span><br></pre></td></tr></table></figure>

<p>dwControl控制代码可以是：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SERVICE_CONTROL_STOP</td>
<td>通知服务停止服务，需要SERVICE_STOP访问权限</td>
</tr>
<tr>
<td>SERVICE_CONTROL_PAUSE</td>
<td>通知服务暂停服务，需要SERVICE_PAUSE_CONTINUE访问权限</td>
</tr>
<tr>
<td>SERVICE_CONTROL_CONTINUE</td>
<td>通知暂停的服务恢复，需要SERVICE_PAUSE_CONTINUE访问权限</td>
</tr>
<tr>
<td>SERVICE_CONTROL_SHUTDOWN</td>
<td>通知服务系统正在关闭</td>
</tr>
</tbody></table>
<h3 id="ChangeServiceConfig"><a href="#ChangeServiceConfig" class="headerlink" title="ChangeServiceConfig"></a>ChangeServiceConfig</h3><p>更改指定服务配置参数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">ChangeServiceConfig</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ SC_HANDLE hService, <span class="comment">//服务句柄 需要SERVICE_CHANGE_CONFIG访问权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwServiceType, <span class="comment">//服务类型 不需要则设置为SERVICE_NO_CHANGE</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwStartType, <span class="comment">//启动类型 不需要则设置为SERVICE_NO_CHANGE</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwErrorControl, <span class="comment">//错误控制 不需要则设置为SERVICE_NO_CHANGE</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpBinaryPathName, <span class="comment">//文件路径</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpLoadOrderGroup, <span class="comment">//所属加载顺序组名</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_opt_ LPDWORD lpdwTagId, <span class="comment">//返回lpLoadOrderGroup指定组中此服务UID</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpDependencies, <span class="comment">//服务名或加载顺序组名数组指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpServiceStartName, <span class="comment">//服务进程运行时将登录的账户名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpPassword, <span class="comment">//lpServiceStartName指定账户名的密码</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpDisplayName <span class="comment">//服务显示名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回非0 失败0</span></span><br></pre></td></tr></table></figure>

<p>要更改指定服务其他配置参数用<code>ChangeServiceConfig2</code>。</p>
<h3 id="CreateService"><a href="#CreateService" class="headerlink" title="CreateService"></a>CreateService</h3><p>创建一个服务对象并将其添加到服务控制管理器数据库中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SC_HANDLE WINAPI <span class="title">CreateService</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ SC_HANDLE hSCManager, <span class="comment">//SCM数据库句柄 需要SC_MANAGER_CREATE_SERVICE权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPCTSTR lpServiceName, <span class="comment">//服务名称 最长256字符</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpDisplayName, <span class="comment">//显示名称 最长256字符</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwDesiredAccess, <span class="comment">//服务访问权限 可SERVICE_ALL_ACCESS</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwServiceType, <span class="comment">//服务类型 通常SERVICE_WIN32_OWN_PROCESS</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwStartType, <span class="comment">//启动类型 可SERVICE_AUTO_START</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwErrorControl, <span class="comment">//错误控制 可SERVICE_ERROR_NORMAL</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpBinaryPathName, <span class="comment">//服务文件路径 包含空格则用引号引起来</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpLoadOrderGroup, <span class="comment">//服务所属加载顺序组名</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_opt_ LPDWORD lpdwTagId, <span class="comment">//返回lpLoadOrderGroup组中此服务UID</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpDependencies, <span class="comment">//服务名或加载顺序组名称的数组指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpServiceStartName, <span class="comment">//服务进程运行时将登录的账户名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpPassword <span class="comment">//lpServiceStartName指定的账户名密码</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回服务句柄 失败NULL</span></span><br></pre></td></tr></table></figure>

<h3 id="DeleteService"><a href="#DeleteService" class="headerlink" title="DeleteService"></a>DeleteService</h3><p>将指定服务从服务控制管理器数据库中删除：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DeleteService</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ SC_HANDLE hService <span class="comment">//服务句柄 需要DELETE访问权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="实例：系统服务管理器仿真"><a href="#实例：系统服务管理器仿真" class="headerlink" title="实例：系统服务管理器仿真"></a>实例：系统服务管理器仿真</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Commctrl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Comctl32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;\&quot;/manifestdependency:type=&#x27;win32&#x27; name=&#x27;Microsoft.Windows.Common-Controls&#x27; version=&#x27;6.0.0.0&#x27; processorArchitecture=&#x27;*&#x27; publicKeyToken=&#x27;6595b64144ccf1df&#x27; language=&#x27;*&#x27;\&quot;&quot;</span>)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_ITEMDATA</span>&#123;</span><br><span class="line">   TCHAR m_szServiceName[<span class="number">256</span>];     <span class="comment">// 服务名称</span></span><br><span class="line">   TCHAR m_szDisplayName[<span class="number">256</span>];     <span class="comment">// 显示名称</span></span><br><span class="line">   DWORD m_dwCurrentState;         <span class="comment">// 服务状态</span></span><br><span class="line">   DWORD m_dwControlsAccepted;     <span class="comment">// 控制代码</span></span><br><span class="line">   DWORD m_dwStartType;            <span class="comment">// 启动类型</span></span><br><span class="line">&#125;ITEMDATA, * PITEMDATA;</span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hInstance;</span><br><span class="line">HWND g_hwndDlg;                     <span class="comment">// 对话框窗口句柄</span></span><br><span class="line">HWND g_hwndList;                    <span class="comment">// 列表视图控件句柄</span></span><br><span class="line">BOOL g_bAscendingDisplayName;       <span class="comment">// 是否已按显示名称升序排列</span></span><br><span class="line">BOOL g_bAscendingCurrentState;      <span class="comment">// 是否已按服务状态升序排列</span></span><br><span class="line">BOOL g_bAscendingStartType;         <span class="comment">// 是否已按启动类型升序排列</span></span><br><span class="line">LPCTSTR arrlpStrCurrentState[] = &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;已停止&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;正在启动&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;正在停止&quot;</span>),<span class="built_in">TEXT</span>(<span class="string">&quot;正在运行&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;正在继续&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;正在暂停&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;已暂停&quot;</span>) &#125;;</span><br><span class="line">LPCTSTR arrlpStrStartType[] = &#123; <span class="built_in">TEXT</span>(<span class="string">&quot;自动(用于驱动程序服务)&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;手动(用于驱动程序服务)&quot;</span>),<span class="built_in">TEXT</span>(<span class="string">&quot;自动&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;手动&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;禁用&quot;</span>) &#125;;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProcCreateService</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 获取服务列表</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetServiceList</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 列表视图控件排序回调函数</span></span><br><span class="line"><span class="function"><span class="type">int</span> CALLBACK <span class="title">CompareFunc</span><span class="params">(LPARAM lParam1, LPARAM lParam2, LPARAM lParamSort)</span></span>;</span><br><span class="line"><span class="comment">// 获取选中服务的当前状态和配置参数，启用禁用相关菜单项</span></span><br><span class="line"><span class="function">VOID <span class="title">QueryServiceStatusAndConfig</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 启动服务</span></span><br><span class="line"><span class="function">BOOL <span class="title">StartTheService</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 控制服务状态，停止服务、暂停服务、继续服务</span></span><br><span class="line"><span class="function">BOOL <span class="title">ControlCurrentState</span><span class="params">(DWORD dwControl, DWORD dwNewCurrentState)</span></span>;</span><br><span class="line"><span class="comment">// 控制启动类型，设为自动启动、设为手动启动、设为已禁用</span></span><br><span class="line"><span class="function">BOOL <span class="title">ChangeTheServiceConfig</span><span class="params">(DWORD dwStartType)</span></span>;</span><br><span class="line"><span class="comment">// 添加服务</span></span><br><span class="line"><span class="function">BOOL <span class="title">CreateAService</span><span class="params">(LPCTSTR lpBinaryPathName, LPCTSTR lpServiceName, LPCTSTR lpDisplayName, DWORD dwStartType, DWORD dwServiceType = SERVICE_WIN32_OWN_PROCESS, LPCTSTR lpDescription = <span class="literal">NULL</span>, DWORD dwDesiredAccess = SERVICE_ALL_ACCESS, DWORD dwErrorControl = SERVICE_ERROR_NORMAL)</span></span>;</span><br><span class="line"><span class="comment">// 删除服务</span></span><br><span class="line"><span class="function">BOOL <span class="title">DeleteTheService</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    g_hInstance = hInstance;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>&#123;</span><br><span class="line">   INT_PTR nResult;</span><br><span class="line">   <span class="keyword">switch</span> (uMsg)&#123;</span><br><span class="line">       <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">           g_hwndDlg = hwndDlg;</span><br><span class="line">           g_hwndList = <span class="built_in">GetDlgItem</span>(hwndDlg, IDC_LIST_SERVICE);</span><br><span class="line">           <span class="comment">// 设置列表视图控件的扩展样式</span></span><br><span class="line">           <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETEXTENDEDLISTVIEWSTYLE, <span class="number">0</span>, LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES);</span><br><span class="line">           <span class="comment">// 设置列标题：服务的显示名称、服务状态、启动类型、文件路径、服务描述</span></span><br><span class="line">           LVCOLUMN lvc;</span><br><span class="line">           <span class="built_in">ZeroMemory</span>(&amp;lvc, <span class="built_in">sizeof</span>(LVCOLUMN));</span><br><span class="line">           lvc.mask = LVCF_SUBITEM | LVCF_WIDTH | LVCF_TEXT;</span><br><span class="line">           lvc.iSubItem = <span class="number">0</span>; lvc.cx = <span class="number">260</span>; lvc.pszText = (LPTSTR)<span class="built_in">TEXT</span>(<span class="string">&quot;服务的显示名称&quot;</span>);</span><br><span class="line">           <span class="built_in">SendMessage</span>(g_hwndList, LVM_INSERTCOLUMN, <span class="number">0</span>, (LPARAM)&amp;lvc);</span><br><span class="line">           lvc.iSubItem = <span class="number">1</span>; lvc.cx = <span class="number">80</span>; lvc.pszText = (LPTSTR)<span class="built_in">TEXT</span>(<span class="string">&quot;服务状态&quot;</span>);</span><br><span class="line">           <span class="built_in">SendMessage</span>(g_hwndList, LVM_INSERTCOLUMN, <span class="number">1</span>, (LPARAM)&amp;lvc);</span><br><span class="line">           lvc.iSubItem = <span class="number">2</span>; lvc.cx = <span class="number">80</span>; lvc.pszText = (LPTSTR)<span class="built_in">TEXT</span>(<span class="string">&quot;启动类型&quot;</span>);</span><br><span class="line">           <span class="built_in">SendMessage</span>(g_hwndList, LVM_INSERTCOLUMN, <span class="number">2</span>, (LPARAM)&amp;lvc);</span><br><span class="line">           lvc.iSubItem = <span class="number">3</span>; lvc.cx = <span class="number">300</span>; lvc.pszText = (LPTSTR)<span class="built_in">TEXT</span>(<span class="string">&quot;文件路径&quot;</span>);</span><br><span class="line">           <span class="built_in">SendMessage</span>(g_hwndList, LVM_INSERTCOLUMN, <span class="number">3</span>, (LPARAM)&amp;lvc);</span><br><span class="line">           lvc.iSubItem = <span class="number">4</span>; lvc.cx = <span class="number">300</span>; lvc.pszText = (LPTSTR)<span class="built_in">TEXT</span>(<span class="string">&quot;服务描述&quot;</span>);</span><br><span class="line">           <span class="built_in">SendMessage</span>(g_hwndList, LVM_INSERTCOLUMN, <span class="number">4</span>, (LPARAM)&amp;lvc);</span><br><span class="line">           <span class="comment">// 获取服务列表</span></span><br><span class="line">           <span class="built_in">GetServiceList</span>();</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">case</span> WM_SIZE: &#123;</span><br><span class="line">           <span class="comment">// 根据父窗口客户区的大小调整列表视图控件的大小</span></span><br><span class="line">           <span class="built_in">MoveWindow</span>(g_hwndList, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">LOWORD</span>(lParam), <span class="built_in">HIWORD</span>(lParam), TRUE);</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">case</span> WM_NOTIFY: &#123;</span><br><span class="line">           <span class="comment">// 当用户点击列标题的时候</span></span><br><span class="line">           <span class="keyword">if</span> (((LPNMHDR)lParam)-&gt;code == LVN_COLUMNCLICK) &#123;</span><br><span class="line">               LPNMLISTVIEW pNMLV = (LPNMLISTVIEW)lParam;</span><br><span class="line">               <span class="keyword">if</span> (pNMLV-&gt;iSubItem &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                   <span class="built_in">SendMessage</span>(g_hwndList, LVM_SORTITEMS, pNMLV-&gt;iSubItem, (LPARAM)CompareFunc);</span><br><span class="line">                   <span class="keyword">switch</span> (pNMLV-&gt;iSubItem) &#123;</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">0</span>: &#123;</span><br><span class="line">                           g_bAscendingDisplayName = ~g_bAscendingDisplayName;</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;;</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">                           g_bAscendingCurrentState = ~g_bAscendingCurrentState;</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;;</span><br><span class="line">                       <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">                           g_bAscendingStartType = ~g_bAscendingStartType;</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;;</span><br><span class="line">                   &#125;;</span><br><span class="line">               &#125;;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 弹出快捷菜单</span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (((LPNMHDR)lParam)-&gt;code == NM_RCLICK) &#123;</span><br><span class="line">               <span class="keyword">if</span> (((LPNMITEMACTIVATE)lParam)-&gt;iItem &lt; <span class="number">0</span>)</span><br><span class="line">                   <span class="keyword">return</span> FALSE;</span><br><span class="line">               POINT pt = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">               <span class="built_in">GetCursorPos</span>(&amp;pt);</span><br><span class="line">               <span class="built_in">TrackPopupMenu</span>(<span class="built_in">GetSubMenu</span>(<span class="built_in">GetMenu</span>(hwndDlg), <span class="number">0</span>), TPM_LEFTALIGN | TPM_TOPALIGN, pt.x, pt.y, <span class="number">0</span>, hwndDlg, <span class="literal">NULL</span>);</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">case</span> WM_INITMENUPOPUP: &#123;</span><br><span class="line">           <span class="comment">// 在显示弹出菜单之前，获取选中服务的当前状态和配置参数，启用禁用相关菜单项</span></span><br><span class="line">           <span class="built_in">QueryServiceStatusAndConfig</span>();</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">           <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_ADD: &#123;</span><br><span class="line">                   nResult = <span class="built_in">DialogBoxParam</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_CREATESERVICE), hwndDlg, DialogProcCreateService, <span class="literal">NULL</span>);</span><br><span class="line">                   <span class="keyword">if</span> (nResult == <span class="number">2</span>)</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;创建服务成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span> <span class="keyword">if</span> (nResult == <span class="number">1</span>)</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;创建服务失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_DELETE: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">DeleteTheService</span>())</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;删除服务成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;删除服务失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_START: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">StartTheService</span>())</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;启动服务成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;启动服务失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_STOP: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">ControlCurrentState</span>(SERVICE_CONTROL_STOP, SERVICE_STOPPED))</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;停止服务成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;停止服务失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_PAUSE: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">ControlCurrentState</span>(SERVICE_CONTROL_PAUSE, SERVICE_PAUSED))</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;暂停服务成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;暂停服务失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_CONTINUE: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">ControlCurrentState</span>(SERVICE_CONTROL_CONTINUE, SERVICE_RUNNING))</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;继续服务成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;继续服务失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_AUTO: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">ChangeTheServiceConfig</span>(SERVICE_AUTO_START))</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;设为自动启动成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;设为自动启动失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_DEMAND: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">ChangeTheServiceConfig</span>(SERVICE_DEMAND_START))</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;设为手动启动成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;设为手动启动失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_DISABLE: &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">ChangeTheServiceConfig</span>(SERVICE_DISABLED))</span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;设为已禁用成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;设为已禁用失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> ID_SERVICE_REFRESH: &#123;</span><br><span class="line">                   <span class="comment">// 刷新列表的时候按显示名称升序排列</span></span><br><span class="line">                   g_bAscendingDisplayName = FALSE;</span><br><span class="line">                   <span class="built_in">GetServiceList</span>();</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                   <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">GetServiceList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SC_HANDLE hSCManager = <span class="literal">NULL</span>;    <span class="comment">// 服务控制管理器数据库的句柄</span></span><br><span class="line">    LPBYTE lpServices = <span class="literal">NULL</span>;       <span class="comment">// 缓冲区指针，返回ENUM_SERVICE_STATUS_PROCESS结构数组</span></span><br><span class="line">    DWORD dwcbBufSize = <span class="number">0</span>;          <span class="comment">// 上面缓冲区的大小</span></span><br><span class="line">    DWORD dwcbBytesNeeded;          <span class="comment">// lpServices设为NULL，dwcbBufSize设为0，返回所需的缓冲区大小</span></span><br><span class="line">    DWORD dwServicesReturned;       <span class="comment">// 返回服务个数</span></span><br><span class="line">    DWORD dwResumeHandle = <span class="number">0</span>;       <span class="comment">// 枚举的起点</span></span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 打开本地计算机的服务控制管理器数据库，返回服务控制管理器数据库的句柄</span></span><br><span class="line">    hSCManager = <span class="built_in">OpenSCManager</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_CONNECT | SC_MANAGER_ENUMERATE_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (!hSCManager)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 枚举服务控制管理器数据库中的服务，首先获取所需的缓冲区大小(字节单位)</span></span><br><span class="line">    <span class="built_in">EnumServicesStatusEx</span>(hSCManager, SC_ENUM_PROCESS_INFO, SERVICE_WIN32, SERVICE_STATE_ALL, <span class="literal">NULL</span>, dwcbBufSize, &amp;dwcbBytesNeeded, &amp;dwServicesReturned, &amp;dwResumeHandle, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 分配合适大小的缓冲区进行枚举服务</span></span><br><span class="line">    lpServices = <span class="keyword">new</span> BYTE[dwcbBytesNeeded];</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(lpServices, dwcbBytesNeeded);</span><br><span class="line">    dwResumeHandle = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">EnumServicesStatusEx</span>(hSCManager, SC_ENUM_PROCESS_INFO, SERVICE_WIN32, SERVICE_STATE_ALL, lpServices, dwcbBytesNeeded, &amp;dwcbBytesNeeded, &amp;dwServicesReturned, &amp;dwResumeHandle, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 先释放所有项目数据，然后删除所有列表项</span></span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;lvi, <span class="built_in">sizeof</span>(LVITEM));</span><br><span class="line">    <span class="type">int</span> nCount = <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETITEMCOUNT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nCount; i++) &#123;</span><br><span class="line">        lvi.iItem = i; lvi.mask = LVIF_PARAM;</span><br><span class="line">        <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        <span class="built_in">delete</span> (PITEMDATA)(lvi.lParam);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_DELETEALLITEMS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    LPENUM_SERVICE_STATUS_PROCESS pEnumServiceStatus = (LPENUM_SERVICE_STATUS_PROCESS)lpServices;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;lvi, <span class="built_in">sizeof</span>(LVITEM));</span><br><span class="line">    <span class="comment">// 遍历获取到的ENUM_SERVICE_STATUS_PROCESS结构数组</span></span><br><span class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwServicesReturned; i++) &#123;</span><br><span class="line">        <span class="comment">// 设置与列表项相关联的项目数据</span></span><br><span class="line">        PITEMDATA pItemData = <span class="keyword">new</span> ITEMDATA;</span><br><span class="line">        <span class="built_in">ZeroMemory</span>(pItemData, <span class="built_in">sizeof</span>(ITEMDATA));</span><br><span class="line">        <span class="built_in">StringCchCopy</span>(pItemData-&gt;m_szServiceName, _countof(pItemData-&gt;m_szServiceName), pEnumServiceStatus[i].lpServiceName);</span><br><span class="line">        <span class="built_in">StringCchCopy</span>(pItemData-&gt;m_szDisplayName, _countof(pItemData-&gt;m_szDisplayName), pEnumServiceStatus[i].lpDisplayName);</span><br><span class="line">        pItemData-&gt;m_dwCurrentState = pEnumServiceStatus[i].ServiceStatusProcess.dwCurrentState;</span><br><span class="line">        pItemData-&gt;m_dwControlsAccepted = pEnumServiceStatus[i].ServiceStatusProcess.dwControlsAccepted;</span><br><span class="line">        lvi.iItem = <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETITEMCOUNT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        lvi.mask = LVIF_TEXT | LVIF_PARAM;</span><br><span class="line">        lvi.lParam = (LPARAM)pItemData;</span><br><span class="line">        <span class="comment">// 第1列，服务的显示名称</span></span><br><span class="line">        lvi.iSubItem = <span class="number">0</span>; lvi.pszText = pEnumServiceStatus[i].lpDisplayName;</span><br><span class="line">        <span class="built_in">SendMessage</span>(g_hwndList, LVM_INSERTITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        lvi.mask = LVIF_TEXT;</span><br><span class="line">        <span class="comment">// 第2列，服务状态</span></span><br><span class="line">        lvi.iSubItem = <span class="number">1</span>; lvi.pszText = (LPTSTR)arrlpStrCurrentState[pEnumServiceStatus[i].ServiceStatusProcess.dwCurrentState];</span><br><span class="line">        <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        <span class="comment">// 第3列，启动类型</span></span><br><span class="line">        SC_HANDLE hService;</span><br><span class="line">        LPQUERY_SERVICE_CONFIG lpServiceConfig = <span class="literal">NULL</span>;<span class="comment">// 返回服务配置参数的缓冲区指针</span></span><br><span class="line">        DWORD dwcbBufSizeService = <span class="number">0</span>;                 <span class="comment">// 上面缓冲区的大小</span></span><br><span class="line">        DWORD dwcbBytesNeededService;                 <span class="comment">// 上面两参数设为NULL和0,返回所需缓冲区大小</span></span><br><span class="line">        <span class="comment">// 打开服务返回一个服务句柄</span></span><br><span class="line">        hService = <span class="built_in">OpenService</span>(hSCManager, pEnumServiceStatus[i].lpServiceName, SERVICE_QUERY_CONFIG);</span><br><span class="line">        <span class="comment">// 查询该服务的配置参数，首先获取所需的缓冲区大小(字节单位)</span></span><br><span class="line">        <span class="built_in">QueryServiceConfig</span>(hService, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwcbBytesNeededService);</span><br><span class="line">        <span class="comment">// 分配合适大小的缓冲区查询该服务的配置参数</span></span><br><span class="line">        lpServiceConfig = (LPQUERY_SERVICE_CONFIG)<span class="keyword">new</span> BYTE[dwcbBytesNeededService];</span><br><span class="line">        <span class="built_in">ZeroMemory</span>(lpServiceConfig, dwcbBytesNeededService);</span><br><span class="line">        <span class="built_in">QueryServiceConfig</span>(hService, lpServiceConfig, dwcbBytesNeededService, &amp;dwcbBytesNeededService);</span><br><span class="line">        lvi.iSubItem = <span class="number">2</span>; lvi.pszText = (LPTSTR)arrlpStrStartType[lpServiceConfig-&gt;dwStartType];</span><br><span class="line">        <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        pItemData-&gt;m_dwStartType = lpServiceConfig-&gt;dwStartType;</span><br><span class="line">        <span class="comment">// 第4列，文件路径</span></span><br><span class="line">        lvi.iSubItem = <span class="number">3</span>; lvi.pszText = lpServiceConfig-&gt;lpBinaryPathName;</span><br><span class="line">        <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        <span class="keyword">delete</span>[]lpServiceConfig;</span><br><span class="line">        <span class="comment">// 第5列，服务描述</span></span><br><span class="line">        LPBYTE lpBufferService2;        <span class="comment">// 返回服务其他配置参数的缓冲区指针</span></span><br><span class="line">        DWORD dwcbBufSizeService2 = <span class="number">0</span>;  <span class="comment">// 上面缓冲区的大小</span></span><br><span class="line">        DWORD dwcbBytesNeededService2;  <span class="comment">// 上面两参数设为NULL和0,返回所需缓冲区大小</span></span><br><span class="line">        <span class="comment">// 查询该服务的其他配置参数，首先获取所需的缓冲区大小(字节单位)</span></span><br><span class="line">        <span class="built_in">QueryServiceConfig2</span>(hService, SERVICE_CONFIG_DESCRIPTION, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;dwcbBytesNeededService2);</span><br><span class="line">        <span class="comment">// 分配合适大小的缓冲区查询该服务的其他配置参数</span></span><br><span class="line">        lpBufferService2 = <span class="keyword">new</span> BYTE[dwcbBytesNeededService2];</span><br><span class="line">        <span class="built_in">ZeroMemory</span>(lpBufferService2, dwcbBytesNeededService2);</span><br><span class="line">        <span class="built_in">QueryServiceConfig2</span>(hService, SERVICE_CONFIG_DESCRIPTION, lpBufferService2, dwcbBytesNeededService2, &amp;dwcbBytesNeededService2);</span><br><span class="line">        lvi.iSubItem = <span class="number">4</span>; lvi.pszText = ((LPSERVICE_DESCRIPTION)lpBufferService2)-&gt;lpDescription;</span><br><span class="line">        <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        <span class="keyword">delete</span>[]lpBufferService2;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 按显示名称升序排列</span></span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_SORTITEMS, <span class="number">0</span>, (LPARAM)CompareFunc);</span><br><span class="line">    g_bAscendingDisplayName = ~g_bAscendingDisplayName;</span><br><span class="line">    <span class="keyword">delete</span>[]lpServices;</span><br><span class="line">    <span class="comment">// 关闭服务控制管理器数据库句柄</span></span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> CALLBACK <span class="title">CompareFunc</span><span class="params">(LPARAM lParam1, LPARAM lParam2, LPARAM lParamSort)</span> </span>&#123;</span><br><span class="line">    LPCTSTR lpStr1, lpStr2;</span><br><span class="line">    <span class="keyword">switch</span> (lParamSort) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: &#123;</span><br><span class="line">            lpStr1 = ((PITEMDATA)lParam1)-&gt;m_szDisplayName;</span><br><span class="line">            lpStr2 = ((PITEMDATA)lParam2)-&gt;m_szDisplayName;</span><br><span class="line">            <span class="keyword">if</span> (!g_bAscendingDisplayName)</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">CompareStringEx</span>(LOCALE_NAME_USER_DEFAULT, LINGUISTIC_IGNORECASE | SORT_DIGITSASNUMBERS, lpStr1, <span class="number">-1</span>, lpStr2, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) - <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">CompareStringEx</span>(LOCALE_NAME_USER_DEFAULT, LINGUISTIC_IGNORECASE | SORT_DIGITSASNUMBERS, lpStr2, <span class="number">-1</span>, lpStr1, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) - <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">            lpStr1 = arrlpStrCurrentState[((PITEMDATA)lParam1)-&gt;m_dwCurrentState];</span><br><span class="line">            lpStr2 = arrlpStrCurrentState[((PITEMDATA)lParam2)-&gt;m_dwCurrentState];</span><br><span class="line">            <span class="keyword">if</span> (!g_bAscendingCurrentState)</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">CompareStringEx</span>(LOCALE_NAME_USER_DEFAULT, LINGUISTIC_IGNORECASE | SORT_DIGITSASNUMBERS, lpStr1, <span class="number">-1</span>, lpStr2, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) - <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">CompareStringEx</span>(LOCALE_NAME_USER_DEFAULT, LINGUISTIC_IGNORECASE | SORT_DIGITSASNUMBERS, lpStr2, <span class="number">-1</span>, lpStr1, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) - <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">            lpStr1 = arrlpStrStartType[((PITEMDATA)lParam1)-&gt;m_dwStartType];</span><br><span class="line">            lpStr2 = arrlpStrStartType[((PITEMDATA)lParam2)-&gt;m_dwStartType];</span><br><span class="line">            <span class="keyword">if</span> (!g_bAscendingStartType)</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">CompareStringEx</span>(LOCALE_NAME_USER_DEFAULT, LINGUISTIC_IGNORECASE | SORT_DIGITSASNUMBERS, lpStr1, <span class="number">-1</span>, lpStr2, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) - <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">CompareStringEx</span>(LOCALE_NAME_USER_DEFAULT, LINGUISTIC_IGNORECASE | SORT_DIGITSASNUMBERS, lpStr2, <span class="number">-1</span>, lpStr1, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) - <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">QueryServiceStatusAndConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> nSelected;</span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PITEMDATA pItemData;</span><br><span class="line">    HMENU hMenu = <span class="built_in">GetMenu</span>(g_hwndDlg);</span><br><span class="line">    nSelected = <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 因为是调用GetMenu获取的菜单栏句柄，而不是调用LoadMenu加载的菜单资源，</span></span><br><span class="line">    <span class="comment">// 所以每次都需要设置每个菜单项的状态，只有添加服务和刷新列表这两个菜单项一直处于启用状态</span></span><br><span class="line">    <span class="keyword">if</span> (nSelected &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_DELETE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_START, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_STOP, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_PAUSE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_CONTINUE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_AUTO, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_DEMAND, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_DISABLE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_DELETE, MF_BYCOMMAND | MF_ENABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_START, MF_BYCOMMAND | MF_ENABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_STOP, MF_BYCOMMAND | MF_ENABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_PAUSE, MF_BYCOMMAND | MF_ENABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_CONTINUE, MF_BYCOMMAND | MF_ENABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_AUTO, MF_BYCOMMAND | MF_ENABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_DEMAND, MF_BYCOMMAND | MF_ENABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_DISABLE, MF_BYCOMMAND | MF_ENABLED);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 获取选中列表项的项目数据</span></span><br><span class="line">    lvi.mask = LVIF_PARAM; lvi.iItem = nSelected;</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">    pItemData = (PITEMDATA)(lvi.lParam);</span><br><span class="line">    <span class="comment">// 禁用启动服务、停止服务、暂停服务、继续服务这些菜单项中不应该启用的</span></span><br><span class="line">    <span class="keyword">if</span> (pItemData-&gt;m_dwCurrentState == SERVICE_START_PENDING || pItemData-&gt;m_dwCurrentState == SERVICE_RUNNING) &#123;</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_START, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="keyword">if</span> (!(pItemData-&gt;m_dwControlsAccepted &amp; SERVICE_ACCEPT_STOP))</span><br><span class="line">            <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_STOP, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="keyword">if</span> (!(pItemData-&gt;m_dwControlsAccepted &amp; SERVICE_ACCEPT_PAUSE_CONTINUE))</span><br><span class="line">            <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_PAUSE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_CONTINUE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pItemData-&gt;m_dwCurrentState == SERVICE_STOP_PENDING || pItemData-&gt;m_dwCurrentState == SERVICE_STOPPED) &#123;</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_STOP, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_PAUSE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_CONTINUE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pItemData-&gt;m_dwCurrentState == SERVICE_PAUSE_PENDING || pItemData-&gt;m_dwCurrentState == SERVICE_PAUSED) &#123;</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_START, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="keyword">if</span> (!(pItemData-&gt;m_dwControlsAccepted &amp; SERVICE_ACCEPT_STOP))</span><br><span class="line">            <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_STOP, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_PAUSE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="keyword">if</span> (!(pItemData-&gt;m_dwControlsAccepted &amp; SERVICE_ACCEPT_PAUSE_CONTINUE))</span><br><span class="line">            <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_CONTINUE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pItemData-&gt;m_dwCurrentState == SERVICE_CONTINUE_PENDING) &#123;</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_START, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="keyword">if</span> (!(pItemData-&gt;m_dwControlsAccepted &amp; SERVICE_ACCEPT_STOP))</span><br><span class="line">            <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_STOP, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="keyword">if</span> (!(pItemData-&gt;m_dwControlsAccepted &amp; SERVICE_ACCEPT_PAUSE_CONTINUE))</span><br><span class="line">            <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_PAUSE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_CONTINUE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 禁用设为自动启动、设为手动启动、设为已禁用这些菜单项中不应该启用的</span></span><br><span class="line">    <span class="keyword">if</span> (pItemData-&gt;m_dwStartType == SERVICE_AUTO_START)</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_AUTO, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pItemData-&gt;m_dwStartType == SERVICE_DEMAND_START)</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_DEMAND, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pItemData-&gt;m_dwStartType == SERVICE_DISABLED)</span><br><span class="line">        <span class="built_in">EnableMenuItem</span>(hMenu, ID_SERVICE_DISABLE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">StartTheService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> nSelected;</span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PITEMDATA pItemData;</span><br><span class="line">    SC_HANDLE hSCManager = <span class="literal">NULL</span>;    <span class="comment">// 服务控制管理器数据库的句柄</span></span><br><span class="line">    SC_HANDLE hService;             <span class="comment">// 服务句柄</span></span><br><span class="line">    <span class="comment">// 获取选中列表项的项目数据</span></span><br><span class="line">    nSelected = <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    lvi.mask = LVIF_PARAM; lvi.iItem = nSelected;</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">    pItemData = (PITEMDATA)(lvi.lParam);</span><br><span class="line">    hSCManager = <span class="built_in">OpenSCManager</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_CONNECT);</span><br><span class="line">    <span class="keyword">if</span> (!hSCManager)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    hService = <span class="built_in">OpenService</span>(hSCManager, pItemData-&gt;m_szServiceName, SERVICE_START);</span><br><span class="line">    <span class="keyword">if</span> (!hService) &#123;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">StartService</span>(hService, <span class="number">0</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    pItemData-&gt;m_dwCurrentState = SERVICE_RUNNING;</span><br><span class="line">    lvi.mask = LVIF_TEXT;</span><br><span class="line">    lvi.iItem = nSelected; lvi.iSubItem = <span class="number">1</span>;</span><br><span class="line">    lvi.pszText = (LPTSTR)arrlpStrCurrentState[SERVICE_RUNNING];</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">ControlCurrentState</span><span class="params">(DWORD dwControl, DWORD dwNewCurrentState)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> nSelected;</span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PITEMDATA pItemData;</span><br><span class="line">    SC_HANDLE hSCManager = <span class="literal">NULL</span>;    <span class="comment">// 服务控制管理器数据库的句柄</span></span><br><span class="line">    SC_HANDLE hService;             <span class="comment">// 服务句柄</span></span><br><span class="line">    SERVICE_STATUS serviceStatus = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 获取选中列表项的项目数据</span></span><br><span class="line">    nSelected = <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    lvi.mask = LVIF_PARAM; lvi.iItem = nSelected;</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">    pItemData = (PITEMDATA)(lvi.lParam);</span><br><span class="line">    hSCManager = <span class="built_in">OpenSCManager</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_CONNECT);</span><br><span class="line">    <span class="keyword">if</span> (!hSCManager)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    hService = <span class="built_in">OpenService</span>(hSCManager, pItemData-&gt;m_szServiceName, SERVICE_STOP | SERVICE_PAUSE_CONTINUE);</span><br><span class="line">    <span class="keyword">if</span> (!hService) &#123;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ControlService</span>(hService, dwControl, &amp;serviceStatus)) &#123;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 实际编程中应根据返回的最新服务状态信息的SERVICE_STATUS结构进行合理化处理，</span></span><br><span class="line">    <span class="comment">// 而不应该简单地使用传递过来的dwNewCurrentState参数</span></span><br><span class="line">    pItemData-&gt;m_dwCurrentState = dwNewCurrentState;</span><br><span class="line">    lvi.mask = LVIF_TEXT;</span><br><span class="line">    lvi.iItem = nSelected; lvi.iSubItem = <span class="number">1</span>;</span><br><span class="line">    lvi.pszText = (LPTSTR)arrlpStrCurrentState[dwNewCurrentState];</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">ChangeTheServiceConfig</span><span class="params">(DWORD dwStartType)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> nSelected;</span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PITEMDATA pItemData;</span><br><span class="line">    SC_HANDLE hSCManager = <span class="literal">NULL</span>;    <span class="comment">// 服务控制管理器数据库的句柄</span></span><br><span class="line">    SC_HANDLE hService;             <span class="comment">// 服务句柄</span></span><br><span class="line">    <span class="comment">// 获取选中列表项的项目数据</span></span><br><span class="line">    nSelected = <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    lvi.mask = LVIF_PARAM; lvi.iItem = nSelected;</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">    pItemData = (PITEMDATA)(lvi.lParam);</span><br><span class="line">    hSCManager = <span class="built_in">OpenSCManager</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_CONNECT);</span><br><span class="line">    <span class="keyword">if</span> (!hSCManager)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    hService = <span class="built_in">OpenService</span>(hSCManager, pItemData-&gt;m_szServiceName, SERVICE_CHANGE_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (!hService) &#123;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ChangeServiceConfig</span>(hService, SERVICE_NO_CHANGE, dwStartType, SERVICE_NO_CHANGE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    pItemData-&gt;m_dwStartType = dwStartType;</span><br><span class="line">    lvi.mask = LVIF_TEXT;</span><br><span class="line">    lvi.iItem = nSelected; lvi.iSubItem = <span class="number">2</span>;</span><br><span class="line">    lvi.pszText = (LPTSTR)arrlpStrStartType[dwStartType];</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProcCreateService</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    TCHAR szFile[MAX_PATH] = &#123; <span class="number">0</span> &#125;;             <span class="comment">// 返回用户选择的文件名的缓冲区</span></span><br><span class="line">    TCHAR szFileTitle[MAX_PATH] = &#123; <span class="number">0</span> &#125;;        <span class="comment">// 返回用户所选文件的文件名和扩展名的缓冲区</span></span><br><span class="line">    OPENFILENAME ofn = &#123; <span class="built_in">sizeof</span>(OPENFILENAME) &#125;;</span><br><span class="line">    <span class="type">static</span> HWND hwndCombo;</span><br><span class="line">    <span class="type">int</span> nIndex, nCount;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    TCHAR szBinaryPathName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;   <span class="comment">// 文件路径</span></span><br><span class="line">    TCHAR szServiceName[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;           <span class="comment">// 服务名称</span></span><br><span class="line">    TCHAR szDisplayName[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;           <span class="comment">// 显示名称</span></span><br><span class="line">    TCHAR szDescription[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;          <span class="comment">// 服务描述</span></span><br><span class="line">    DWORD dwStartType;                          <span class="comment">// 启动类型</span></span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            <span class="comment">// 添加列表项，设置项目数据为服务的启动类型数值，默认选中自动启动</span></span><br><span class="line">            hwndCombo = <span class="built_in">GetDlgItem</span>(hwndDlg, IDC_COMBO_STARTTYPE);</span><br><span class="line">            nIndex = <span class="built_in">SendMessage</span>(hwndCombo, CB_ADDSTRING, <span class="number">0</span>, (LPARAM)<span class="built_in">TEXT</span>(<span class="string">&quot;自动启动&quot;</span>));</span><br><span class="line">            <span class="built_in">SendMessage</span>(hwndCombo, CB_SETITEMDATA, nIndex, <span class="number">0x00000002</span>);</span><br><span class="line">            nIndex = <span class="built_in">SendMessage</span>(hwndCombo, CB_ADDSTRING, <span class="number">0</span>, (LPARAM)<span class="built_in">TEXT</span>(<span class="string">&quot;手动启动&quot;</span>));</span><br><span class="line">            <span class="built_in">SendMessage</span>(hwndCombo, CB_SETITEMDATA, nIndex, <span class="number">0x00000003</span>);</span><br><span class="line">            nIndex = <span class="built_in">SendMessage</span>(hwndCombo, CB_ADDSTRING, <span class="number">0</span>, (LPARAM)<span class="built_in">TEXT</span>(<span class="string">&quot;禁用&quot;</span>));</span><br><span class="line">            <span class="built_in">SendMessage</span>(hwndCombo, CB_SETITEMDATA, nIndex, <span class="number">0x00000004</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(hwndCombo, CB_SETCURSEL, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 设置服务名称、显示名称和服务描述编辑控件的最大字符个数</span></span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_SERVICENAME), EM_SETLIMITTEXT, _countof(szServiceName) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_DISPLAYNAME), EM_SETLIMITTEXT, _countof(szDisplayName) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_DESCRIPTION), EM_SETLIMITTEXT, _countof(szDescription) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_BROWSE: &#123;</span><br><span class="line">                    ofn.hwndOwner = hwndDlg;</span><br><span class="line">                    ofn.lpstrFilter = <span class="built_in">TEXT</span>(<span class="string">&quot;EXE文件(*.exe)\0*.exe\0所有文件(*.*)\0*.*\0&quot;</span>);</span><br><span class="line">                    ofn.lpstrFile = szFile;</span><br><span class="line">                    ofn.nMaxFile = _countof(szFile);</span><br><span class="line">                    ofn.lpstrFileTitle = szFileTitle;</span><br><span class="line">                    ofn.nMaxFileTitle = _countof(szFileTitle);</span><br><span class="line">                    ofn.lpstrTitle = <span class="built_in">TEXT</span>(<span class="string">&quot;请选择要打开的文件&quot;</span>);</span><br><span class="line">                    ofn.Flags = OFN_EXPLORER | OFN_PATHMUSTEXIST | OFN_FILEMUSTEXIST;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">GetOpenFileName</span>(&amp;ofn)) &#123;</span><br><span class="line">                        *(_tcsrchr(szFileTitle, <span class="built_in">TEXT</span>(<span class="string">&#x27;.&#x27;</span>))) = <span class="built_in">TEXT</span>(<span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">                        <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_BINARYPATHNAME, szFile);</span><br><span class="line">                        <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_SERVICENAME, szFileTitle);</span><br><span class="line">                        <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_DISPLAYNAME, szFileTitle);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDOK: &#123;</span><br><span class="line">                    nCount = <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_BINARYPATHNAME, szBinaryPathName, _countof(szBinaryPathName));</span><br><span class="line">                    <span class="keyword">if</span> (nCount &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                        <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;请输入服务的完整路径&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                        <span class="keyword">return</span> TRUE;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    nCount = <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_SERVICENAME, szServiceName, _countof(szServiceName));</span><br><span class="line">                    <span class="keyword">if</span> (nCount &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;请输入服务名称&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                        <span class="keyword">return</span> TRUE;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    nCount = <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_DISPLAYNAME, szDisplayName, _countof(szDisplayName));</span><br><span class="line">                    <span class="keyword">if</span> (nCount &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;请输入显示名称&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                        <span class="keyword">return</span> TRUE;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_DESCRIPTION, szDescription, _countof(szDescription));</span><br><span class="line">                    nIndex = <span class="built_in">SendMessage</span>(hwndCombo, CB_GETCURSEL, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    dwStartType = <span class="built_in">SendMessage</span>(hwndCombo, CB_GETITEMDATA, nIndex, <span class="number">0</span>);</span><br><span class="line">                    <span class="comment">// 调用自定义函数CreateAService创建服务</span></span><br><span class="line">                    bRet = <span class="built_in">CreateAService</span>(szBinaryPathName, szServiceName, szDisplayName, dwStartType, SERVICE_WIN32_OWN_PROCESS, szDescription);</span><br><span class="line">                    <span class="keyword">if</span> (bRet)</span><br><span class="line">                        <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">2</span>);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">CreateAService</span><span class="params">(LPCTSTR lpBinaryPathName, LPCTSTR lpServiceName, LPCTSTR lpDisplayName, DWORD dwStartType, DWORD dwServiceType, LPCTSTR lpDescription, DWORD dwDesiredAccess, DWORD dwErrorControl)</span> </span>&#123;</span><br><span class="line">    SC_HANDLE hSCManager = <span class="literal">NULL</span>;                    <span class="comment">// 服务控制管理器数据库的句柄</span></span><br><span class="line">    SC_HANDLE hService;                             <span class="comment">// 服务句柄</span></span><br><span class="line">    SERVICE_DESCRIPTION serviceDescription = &#123; <span class="number">0</span> &#125;; <span class="comment">// 服务描述</span></span><br><span class="line">    hSCManager = <span class="built_in">OpenSCManager</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class="line">    <span class="keyword">if</span> (!hSCManager)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 创建服务</span></span><br><span class="line">    hService = <span class="built_in">CreateService</span>(hSCManager, lpServiceName, lpDisplayName, dwDesiredAccess, dwServiceType, dwStartType, dwErrorControl, lpBinaryPathName, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hService) &#123;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 设置服务描述</span></span><br><span class="line">    <span class="keyword">if</span> (!lpDescription) &#123;</span><br><span class="line">        serviceDescription.lpDescription = (LPTSTR)lpDescription;</span><br><span class="line">        <span class="built_in">ChangeServiceConfig2</span>(hService, SERVICE_CONFIG_DESCRIPTION, &amp;serviceDescription);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 刷新列表，按显示名称升序排列</span></span><br><span class="line">    g_bAscendingDisplayName = FALSE;</span><br><span class="line">    <span class="built_in">GetServiceList</span>();</span><br><span class="line">    <span class="comment">// 找到新添加列表项的索引</span></span><br><span class="line">    LVFINDINFO lvfi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    lvfi.flags = LVFI_STRING;</span><br><span class="line">    lvfi.psz = lpDisplayName;</span><br><span class="line">    <span class="type">int</span> nIndex = <span class="built_in">SendMessage</span>(g_hwndList, LVM_FINDITEM, <span class="number">-1</span>, (LPARAM)&amp;lvfi);</span><br><span class="line">    <span class="comment">// 设置为选中状态</span></span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;; lvi.state = lvi.stateMask = LVIS_SELECTED;</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_SETITEMSTATE, nIndex, (LPARAM)&amp;lvi);</span><br><span class="line">    <span class="comment">// 把新添加的列表项滚动到可见视图中</span></span><br><span class="line">    <span class="type">int</span> nCount = <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETCOUNTPERPAGE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nIndex &gt; nCount) &#123;</span><br><span class="line">        DWORD dw = <span class="built_in">SendMessage</span>(g_hwndList, LVM_APPROXIMATEVIEWRECT, nIndex - <span class="number">2</span>, <span class="built_in">MAKELPARAM</span>(<span class="number">-1</span>, <span class="number">-1</span>));</span><br><span class="line">        <span class="built_in">SendMessage</span>(g_hwndList, LVM_SCROLL, <span class="number">0</span>, <span class="built_in">HIWORD</span>(dw));</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">DeleteTheService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> nSelected;</span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PITEMDATA pItemData;</span><br><span class="line">    SC_HANDLE hSCManager = <span class="literal">NULL</span>;    <span class="comment">// 服务控制管理器数据库的句柄</span></span><br><span class="line">    SC_HANDLE hService;             <span class="comment">// 服务句柄</span></span><br><span class="line">    <span class="comment">// 获取选中列表项的项目数据</span></span><br><span class="line">    nSelected = <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    lvi.mask = LVIF_PARAM; lvi.iItem = nSelected;</span><br><span class="line">    <span class="built_in">SendMessage</span>(g_hwndList, LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">    pItemData = (PITEMDATA)(lvi.lParam);</span><br><span class="line">    hSCManager = <span class="built_in">OpenSCManager</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_CONNECT);</span><br><span class="line">    <span class="keyword">if</span> (!hSCManager)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    hService = <span class="built_in">OpenService</span>(hSCManager, pItemData-&gt;m_szServiceName, DELETE);</span><br><span class="line">    <span class="keyword">if</span> (!hService) &#123;</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">DeleteService</span>(hService))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span>[]pItemData;</span><br><span class="line">        <span class="built_in">SendMessage</span>(g_hwndList, LVM_DELETEITEM, nSelected, <span class="number">0</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hService);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(hSCManager);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="服务程序的编写"><a href="#服务程序的编写" class="headerlink" title="服务程序的编写"></a>服务程序的编写</h3><h4 id="概览-1"><a href="#概览-1" class="headerlink" title="概览"></a>概览</h4><p>服务类型可以是：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SERVICE_KERNEL_DRIVER</td>
<td>驱动程序服务</td>
</tr>
<tr>
<td>SERVICE_FILE_SYSTEM_DRIVER</td>
<td>文件系统驱动程序服务</td>
</tr>
<tr>
<td>SERVICE_WIN32_OWN_PROCESS</td>
<td>在自己进程中运行的服务</td>
</tr>
<tr>
<td>SERVICE_WIN32_SHARE_PROCESS</td>
<td>与一个或多个其他服务共享一个进程</td>
</tr>
</tbody></table>
<p>当服务控制管理器SCM启动服务程序时，将等待服务程序调用<code>StartServiceCtrlDispatcher</code>。SCM通过命名管道向服务控制调度线程发送控制请求，该线程创建新线程以在启动新服务时调用对应<code>ServiceMain</code>，并调用服务对应处理函数来处理服务控制请求。其中服务入口点函数定义格式为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID WINAPI <span class="title">ServiceMain</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwArgc, <span class="comment">//lpszArgv参数字符串数组元素个数</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPTSTR* lpszArgv <span class="comment">//参数字符串数组 第一个参数为服务名称 没有为NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在<code>ServiceMain</code>中应先初始化全局变量，并立即用<code>RegisterServiceCtrlHandlerEx</code>注册一个服务控制函数来处理该服务的控制请求。随后执行初始化工作：当初始化工作执行时间预计少于1秒时直接在<code>ServiceMain</code>中初始化，超过1秒应选下面俩方法之一，对于自启动服务推荐第一种：</p>
<ul>
<li>用<code>SetServiceStatus</code>，其中第二个参数<code>SERVICE_STATUS.dwCurrentState=SERVICE_RUNNING;SERVICE_STATUS.dwControlsAccepted=0;</code>，标识服务正在运行但不接受任何控制请求，这样SCM可去管理其他服务，而不是已知等待服务初始化完成。</li>
<li>同上但<code>SERVICE_STATUS.dwCurrentState=SERVICE_PENDING;</code>，表示服务正在启动中且不接受任何控制请求，启动该服务的程序可用<code>QueryServiceStatusEx</code>从SCM获取最新检查点值并可用该值向用户报告进度。</li>
</ul>
<p>初始化完成后用<code>SetServiceStatus</code>将服务状态设置为SERVICE_RUNNING并指定服务可接收的控制请求。最后执行服务任务。</p>
<p>服务控制处理函数应根据传递来的控制代码执行对应任务，并用<code>SetServiceStatus</code>将新的服务状态报告给SCM，处理完后可返回NO_ERROR。</p>
<h4 id="StartServiceCtrlDispatcher"><a href="#StartServiceCtrlDispatcher" class="headerlink" title="StartServiceCtrlDispatcher"></a>StartServiceCtrlDispatcher</h4><p>将调用线程连接到服务控制管理器，使线程称为服务控制调度进程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">StartServiceCtrlDispatcher</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ CONST LPSERVICE_TABLE_ENTRY lpServiceTable</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回非0 失败0</span></span><br></pre></td></tr></table></figure>

<p>参数lpServiceTable指向一个SERVICE_TABLE_ENTRY结构数组，最后一个数组元素以空结构结尾。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SERVICE_TABLE_ENTRY</span> &#123;</span><br><span class="line">    LPTSTR                      lpServiceName; <span class="comment">//服务名称</span></span><br><span class="line">    LPSERVICE_MAIN_FUNCTIONW    lpServiceProc; <span class="comment">//服务入口点函数ServiceMain指针</span></span><br><span class="line">&#125;SERVICE_TABLE_ENTRY, *LPSERVICE_TABLE_ENTRY;</span><br></pre></td></tr></table></figure>

<h4 id="RegisterServiceCtrlHandlerEx"><a href="#RegisterServiceCtrlHandlerEx" class="headerlink" title="RegisterServiceCtrlHandlerEx"></a>RegisterServiceCtrlHandlerEx</h4><p>注册一个服务控制处理函数来处理对服务的控制请求：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SERVICE_STATUS_HANDLER WINAPI <span class="title">RegisterServiceCtrlHandlerEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPCTSTR lpServiceName, <span class="comment">//服务名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPHANDLER_FUNCITON_EX lpHandlerProc, <span class="comment">//服务控制处理函数指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPVOID lpContext <span class="comment">//用户自定义数据</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回服务状态句柄 失败0</span></span><br></pre></td></tr></table></figure>

<p>其中服务控制处理函数定义格式为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">HandlerEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwControl, <span class="comment">//控制代码</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwEventType, <span class="comment">//发生事件类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPVOID lpEventData, <span class="comment">//事件数据</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPVOID lpContext <span class="comment">//用户自定义数据</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wtsapi32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Userenv.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Wtsapi32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Userenv.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 服务入口点函数</span></span><br><span class="line"><span class="function">VOID WINAPI <span class="title">ServiceMain</span><span class="params">(DWORD dwArgc, LPTSTR* lpszArgv)</span></span>;</span><br><span class="line"><span class="comment">// 服务控制处理函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">HandlerEx</span><span class="params">(DWORD dwControl, DWORD dwEventType, LPVOID lpEventData, LPVOID lpContext)</span></span>;</span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">TCHAR g_szServiceName[] = <span class="built_in">TEXT</span>(<span class="string">&quot;MyService&quot;</span>);    <span class="comment">// 服务名称</span></span><br><span class="line">SERVICE_STATUS_HANDLE g_hServiceStatus;         <span class="comment">// 服务状态句柄</span></span><br><span class="line">SERVICE_STATUS g_serviceStatus = &#123; <span class="number">0</span> &#125;;         <span class="comment">// 服务状态结构</span></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, TCHAR* argv[]) &#123;</span><br><span class="line">    CONST SERVICE_TABLE_ENTRY serviceTableEntry[] = &#123; &#123;g_szServiceName, ServiceMain&#125;, &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125; &#125;;</span><br><span class="line">    <span class="comment">// 将调用线程连接到SCM，从而使该线程成为服务控制调度线程</span></span><br><span class="line">    <span class="built_in">StartServiceCtrlDispatcher</span>(serviceTableEntry);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID WINAPI <span class="title">ServiceMain</span><span class="params">(DWORD dwArgc, LPTSTR* lpszArgv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 注册一个服务控制处理函数HandlerEx，该函数返回一个服务状态句柄hServiceStatus</span></span><br><span class="line">    g_hServiceStatus = <span class="built_in">RegisterServiceCtrlHandlerEx</span>(g_szServiceName, HandlerEx, <span class="literal">NULL</span>);</span><br><span class="line">    g_serviceStatus.dwServiceType = SERVICE_WIN32_OWN_PROCESS;</span><br><span class="line">    g_serviceStatus.dwCurrentState = SERVICE_RUNNING;</span><br><span class="line">    g_serviceStatus.dwControlsAccepted = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">SetServiceStatus</span>(g_hServiceStatus, &amp;g_serviceStatus);</span><br><span class="line">    <span class="comment">// 初始化工作</span></span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">2000</span>);</span><br><span class="line">    g_serviceStatus.dwCurrentState = SERVICE_RUNNING;</span><br><span class="line">    g_serviceStatus.dwControlsAccepted = SERVICE_ACCEPT_STOP | SERVICE_ACCEPT_PAUSE_CONTINUE | SERVICE_ACCEPT_SHUTDOWN;</span><br><span class="line">    <span class="built_in">SetServiceStatus</span>(g_hServiceStatus, &amp;g_serviceStatus);</span><br><span class="line">    <span class="comment">// 执行服务任务，这里可以是你想执行的任何代码</span></span><br><span class="line">    <span class="built_in">ShellExecute</span>(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;open&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;F:\\Source\\Windows\\Chapter6\\HelloWindows7\\Debug\\HelloWindows.exe&quot;</span>), <span class="literal">NULL</span>, <span class="literal">NULL</span>, SW_SHOW);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">HandlerEx</span><span class="params">(DWORD dwControl, DWORD dwEventType, LPVOID lpEventData, LPVOID lpContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (dwControl) &#123;</span><br><span class="line">        <span class="keyword">case</span> SERVICE_CONTROL_SHUTDOWN: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> SERVICE_CONTROL_STOP: &#123;</span><br><span class="line">            g_serviceStatus.dwCurrentState = SERVICE_STOP_PENDING;</span><br><span class="line">            <span class="built_in">SetServiceStatus</span>(g_hServiceStatus, &amp;g_serviceStatus);</span><br><span class="line">            <span class="comment">// 可以做一些清理工作</span></span><br><span class="line">            g_serviceStatus.dwCurrentState = SERVICE_STOPPED;</span><br><span class="line">            <span class="built_in">SetServiceStatus</span>(g_hServiceStatus, &amp;g_serviceStatus);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> SERVICE_CONTROL_PAUSE: &#123;</span><br><span class="line">            g_serviceStatus.dwCurrentState = SERVICE_PAUSE_PENDING;</span><br><span class="line">            <span class="built_in">SetServiceStatus</span>(g_hServiceStatus, &amp;g_serviceStatus);</span><br><span class="line">            g_serviceStatus.dwCurrentState = SERVICE_PAUSED;</span><br><span class="line">            <span class="built_in">SetServiceStatus</span>(g_hServiceStatus, &amp;g_serviceStatus);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> SERVICE_CONTROL_CONTINUE: &#123;</span><br><span class="line">            g_serviceStatus.dwCurrentState = SERVICE_CONTINUE_PENDING;</span><br><span class="line">            <span class="built_in">SetServiceStatus</span>(g_hServiceStatus, &amp;g_serviceStatus);</span><br><span class="line">            g_serviceStatus.dwCurrentState = SERVICE_RUNNING;</span><br><span class="line">            <span class="built_in">SetServiceStatus</span>(g_hServiceStatus, &amp;g_serviceStatus);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="突破SESSION-0隔离创建GUI"><a href="#突破SESSION-0隔离创建GUI" class="headerlink" title="突破SESSION 0隔离创建GUI"></a>突破SESSION 0隔离创建GUI</h3><h4 id="概览-2"><a href="#概览-2" class="headerlink" title="概览"></a>概览</h4><p>WTS开头函数指的是Windows终端服务。</p>
<p>可用<code>WTSSendMessage</code>在用户会话中显示一个消息框，如需要实现更复杂的GUI用<code>CreateProcessAsUser</code>在用户会话创建一个进程。</p>
<p>访问令牌时描述进程或线程安全环境的一个内核对象，信息包括与进程或线程关联的用户账户ID和特权。用户登录时系统将用户密码与安全数据库中信息比较，通过验证时系统生成一个访问令牌，该用户账户运行的每个进程都有此访问令牌副本。</p>
<p>要用<code>CreateProcessAsUser</code>需要用<code>WTSQueryUserToken</code>，并建议在创建线程前：</p>
<ul>
<li>用<code>DuplicateTokenEx</code>复制一份用户访问令牌句柄，用来创建进程。需要时用<code>SetTokenInformation</code>设置访问令牌信息，如设置会话ID为当前登录用户即可以使新进程以SYSTEM身份运行。</li>
<li>用<code>CreateEnvironmentBlock</code>获取环境变量块，用于创建进程的lpEnvironment参数。</li>
</ul>
<h4 id="WTSSendMessage"><a href="#WTSSendMessage" class="headerlink" title="WTSSendMessage"></a>WTSSendMessage</h4><p>在用户会话中显示消息框：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TCHAR szTitle[] = <span class="built_in">TEXT</span>(<span class="string">&quot;消息标题&quot;</span>);</span><br><span class="line">TCHAR szMessage[] = <span class="built_in">TEXT</span>(<span class="string">&quot;消息内容&quot;</span>);</span><br><span class="line">DWORD dwSessionId, dwResponse;</span><br><span class="line">dwSessionId = <span class="built_in">WTSGetActiveConsoleSessionId</span>();</span><br><span class="line"><span class="built_in">WTSSendMessage</span>(WTS_CURRENT_SERVER_HANDLE, dwSessionId, szTitle, <span class="built_in">sizeof</span>(szTitle), szMessage, <span class="built_in">sizeof</span>(szMessage), MB_OK, <span class="number">0</span>, &amp;dwResponse, TRUE);</span><br></pre></td></tr></table></figure>

<h4 id="WTSGetActiveConsoleSessionId"><a href="#WTSGetActiveConsoleSessionId" class="headerlink" title="WTSGetActiveConsoleSessionId"></a>WTSGetActiveConsoleSessionId</h4><p>获取当前连接到物理控制台的会话ID。物理控制台指屏幕、鼠标和键盘，这里即获取当前登录用户会话ID：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">WTSGetActiveConsoleSessionId</span><span class="params">(VOID)</span></span>; <span class="comment">//成功返回当前登录用户会话ID 通常1 没有用户登录0xFFFFFFFF</span></span><br></pre></td></tr></table></figure>

<h4 id="CreateProcessAsUser"><a href="#CreateProcessAsUser" class="headerlink" title="CreateProcessAsUser"></a>CreateProcessAsUser</h4><p>在用户会话中创建一个具有GUI的进程，一些参数同<code>CreateProcess</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">CreateProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HANDLE hToken, <span class="comment">//访问令牌句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpApplicationName,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_opt_ LPTSTR lpCommandLine,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBTUES lpProcessAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bInheritHandles,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPVOID lpEnvironment,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpCurrentDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="WTSQueryUserToken"><a href="#WTSQueryUserToken" class="headerlink" title="WTSQueryUserToken"></a>WTSQueryUserToken</h4><p>查询指定会话ID对应的登录用户的主访问令牌：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">WTSQueryUserToken</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ ULONG SessionId, <span class="comment">//会话ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_ PHANDLE phToken <span class="comment">//返回主访问令牌句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回非0 失败0</span></span><br></pre></td></tr></table></figure>

<p>需要用<code>CloseHandle</code>关闭句柄。</p>
<h4 id="DuplicateTokenEx"><a href="#DuplicateTokenEx" class="headerlink" title="DuplicateTokenEx"></a>DuplicateTokenEx</h4><p>复制一份访问令牌句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">DuplicateTokenEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HANDLE hExistingToken, <span class="comment">//现有令牌句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwDesiredAccess, <span class="comment">//新令牌句柄访问权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPSECURITY_ATTRIBUTES lpTokenAttributes, <span class="comment">//安全描述符 通常NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ SECURITY_IMPERSONATION_LEVEL ImpersonationLevel, <span class="comment">//新令牌模拟级别</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ TOKEN_TYPE TokenType, <span class="comment">//新令牌类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_ PHANDLE phNewToken <span class="comment">//返回新令牌句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回非0 失败0</span></span><br></pre></td></tr></table></figure>

<p>对于dwDesiredAccess，为0表示使用与现有令牌句柄相同访问权限，为MAXIMUM_ALLOWED表示使用对调用者有效的所有访问权限。在这个使用场景下ImpersonationLevel为SecurityIdentification，TokenType为TokenPrimary。TokenPrimary表示新令牌是可以在<code>CreateProcessAsUser</code>中使用的主令牌，允许模仿客户端服务程序创建具有客户端安全环境的进程。</p>
<p>需要<code>CloseHandle</code>关闭令牌句柄。</p>
<h4 id="CreateEnvironmentBlock"><a href="#CreateEnvironmentBlock" class="headerlink" title="CreateEnvironmentBlock"></a>CreateEnvironmentBlock</h4><p>获取指定用户环境变量块：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">CreateEnvironmentBlock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_ LPVOID* lpEnvironment, <span class="comment">//返回环境变量块指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ HANDLE hToken, <span class="comment">//访问令牌句柄 为NULL则返回环境块仅包含系统变量</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ BOOL bInherit <span class="comment">//是否继承当前进程环境变量</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>默认情况下<code>CreateProcessAsUser</code>的lpEnvironment参数接收ANSI字符，所以其dwCreationFlags应指定CREATE_UNICODE_ENVIRONMENT。用<code>DestroyEnvironmentBlock</code>释放环境变量块。</p>
<h4 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CreateUIProcess</span><span class="params">(LPCTSTR lpApplicationName, LPTSTR lpCommandLine)</span> </span>&#123;</span><br><span class="line">    DWORD dwSessionId;                                      <span class="comment">// 当前登录用户的Session ID</span></span><br><span class="line">    HANDLE hProcessToken = <span class="literal">NULL</span>, hProcessTokenDup = <span class="literal">NULL</span>;   <span class="comment">// 访问令牌句柄</span></span><br><span class="line">    LPVOID lpEnvironment = <span class="literal">NULL</span>;</span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 获取与服务进程关联的访问令牌</span></span><br><span class="line">    <span class="built_in">OpenProcessToken</span>(<span class="built_in">GetCurrentProcess</span>(), TOKEN_ALL_ACCESS, &amp;hProcessToken);</span><br><span class="line">    <span class="comment">// 复制一份访问令牌句柄</span></span><br><span class="line">    <span class="built_in">DuplicateTokenEx</span>(hProcessToken, MAXIMUM_ALLOWED, <span class="literal">NULL</span>, SecurityIdentification, TokenPrimary, &amp;hProcessTokenDup);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hProcessToken);</span><br><span class="line">    <span class="comment">// 设置访问令牌句柄的Session ID为当前登录用户</span></span><br><span class="line">    dwSessionId = <span class="built_in">WTSGetActiveConsoleSessionId</span>();</span><br><span class="line">    <span class="built_in">SetTokenInformation</span>(hProcessTokenDup, TokenSessionId, &amp;dwSessionId, <span class="built_in">sizeof</span>(dwSessionId));</span><br><span class="line">    <span class="comment">// 获取当前登录用户的环境变量块</span></span><br><span class="line">    <span class="built_in">CreateEnvironmentBlock</span>(&amp;lpEnvironment, hProcessTokenDup, FALSE);</span><br><span class="line">    <span class="comment">// 创建进程</span></span><br><span class="line">    <span class="built_in">CreateProcessAsUser</span>(hProcessTokenDup, lpApplicationName, lpCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_UNICODE_ENVIRONMENT, lpEnvironment, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hProcessTokenDup);</span><br><span class="line">    <span class="built_in">DestroyEnvironmentBlock</span>(lpEnvironment);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="用户账户控制UAC"><a href="#用户账户控制UAC" class="headerlink" title="用户账户控制UAC"></a>用户账户控制UAC</h2><h3 id="自动提示用户提升权限"><a href="#自动提示用户提升权限" class="headerlink" title="自动提示用户提升权限"></a>自动提示用户提升权限</h3><p>项目属性中链接器的清单文件设置页中有UAC执行级别选项，可选值有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>requireAdministrator</td>
<td>程序必须以管理员权限启动，否则不运行</td>
</tr>
<tr>
<td>highestAvailable</td>
<td>程序以当前用户可获得的最高权限运行</td>
</tr>
<tr>
<td>asInvoker</td>
<td>程序以父进程相同权限运行</td>
</tr>
</tbody></table>
<h3 id="用ShellExecuteEx以管理员权限启动"><a href="#用ShellExecuteEx以管理员权限启动" class="headerlink" title="用ShellExecuteEx以管理员权限启动"></a>用<code>ShellExecuteEx</code>以管理员权限启动</h3><p>函数声明：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">ShellExecuteEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_Inout_ LPSHELLEXECUTEINFO pExecInfo</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中参数结构包含要执行的应用程序信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_SHELLEXECUTEINFOA</span> &#123;</span><br><span class="line">	DWORD     cbSize;</span><br><span class="line">	ULONG     fMask;</span><br><span class="line">	HWND      hwnd;</span><br><span class="line">	LPCSTR    lpVerb; <span class="comment">//为runas表示以管理员权限启动</span></span><br><span class="line">	LPCSTR    lpFile; <span class="comment">//指定应用程序</span></span><br><span class="line">	LPCSTR    lpParameters;</span><br><span class="line">	LPCSTR    lpDirectory;</span><br><span class="line">	<span class="type">int</span>       nShow;</span><br><span class="line">	HINSTANCE hInstApp;</span><br><span class="line">	<span class="type">void</span>* lpIDList;</span><br><span class="line">	LPCSTR    lpClass;</span><br><span class="line">	HKEY      hkeyClass;</span><br><span class="line">	DWORD     dwHotKey;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		HANDLE hIcon;</span><br><span class="line">		HANDLE hMonitor;</span><br><span class="line">	&#125; DUMMYUNIONNAME;</span><br><span class="line">	HANDLE    hProcess;</span><br><span class="line">&#125; SHELLEXECUTEINFOA, * LPSHELLEXECUTEINFOA;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SHELLEXECUTEINFO sei = &#123; <span class="built_in">sizeof</span>(sei) &#125;;</span><br><span class="line">sei.lpVerb = <span class="built_in">TEXT</span>(<span class="string">&quot;runas&quot;</span>);</span><br><span class="line">sei.lpFile = <span class="built_in">TEXT</span>(<span class="string">&quot;F:\\...\\xxx.exe&quot;</span>);</span><br><span class="line">sei.nShow = SW_SHOWNORMAL;</span><br><span class="line">DWORD dwStatus;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">ShellExecuteEx</span>(&amp;sei)) &#123;</span><br><span class="line">	dwStatus = <span class="built_in">GetLastError</span>();</span><br><span class="line">	<span class="keyword">if</span> (dwStatus == ERROR_CANCELLED) &#123;</span><br><span class="line">		<span class="comment">//用户拒绝提权</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dwStatus == ERROR_FILE_NOT_FOUND) &#123;</span><br><span class="line">		<span class="comment">//文件未找到</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h3><p>绕过UAC提权提示以管理员权限运行程序，即Bypass UAC，方法很多但失效也很快，这里用COM提升名字对象技术实现。</p>
<p>为<code>CoCreateInstanceAsAdmin</code>指定CMSTPLUA组件的CLSID和ICMLuaUtil接口的IID，即可返回ICMLuaUtil接口指针，用它的<code>ShellExec</code>方法即可。其中ICMLuaUtil接口需要自己定义，<code>CoCreateInstanceAsAdmin</code>要自己定义但官方MSDN已提供。</p>
<p>还需要将DLL注入系统信任程序中执行，如taskmgr.exe、CompMgrmtLauncher.exe和rundll32.dll，这里选择直接拿rundll32.exe运行DLL，该程序32位和64位DLL都能运行，命令格式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32.exe DllName FunctionName [Arguments]</span><br></pre></td></tr></table></figure>

<p>其中DllName必须DLL完整路径名，FunctionName为导出函数名称。Arguments为可选的传递给导出函数的参数。其中导出函数原型为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID CALLBACK <span class="title">FunctionName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	HWND hwnd,</span></span></span><br><span class="line"><span class="params"><span class="function">	HINSTANCE hInstance,</span></span></span><br><span class="line"><span class="params"><span class="function">	LPSTR lpCmdLine,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">int</span> nCmdShow</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>如果需要禁用用户计算机UAC，可以把HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System下的EnableLUA键值项设置为0。</p>
<p>这里被运行的DLL头文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">typedef</span> interface ICMLuaUtil ICMLuaUtil;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">ICMLuaUtilVtbl</span> &#123;</span><br><span class="line">    <span class="function">BEGIN_INTERFACE</span></span><br><span class="line"><span class="function">        <span class="title">HRESULT</span><span class="params">(STDMETHODCALLTYPE* QueryInterface)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            __RPC__in       ICMLuaUtil* This,</span></span></span><br><span class="line"><span class="params"><span class="function">            __RPC__in       REFIID      riid,</span></span></span><br><span class="line"><span class="params"><span class="function">            _COM_Outptr_    <span class="type">void</span>**      ppvObject</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">        <span class="built_in">ULONG</span>(STDMETHODCALLTYPE* AddRef)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">ULONG</span>(STDMETHODCALLTYPE* Release)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method1)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method2)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method3)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method4)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method5)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method6)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* ShellExec)(</span><br><span class="line">            __RPC__in ICMLuaUtil* This,</span><br><span class="line">            _In_      LPCWSTR   lpFile,</span><br><span class="line">            _In_opt_  LPCTSTR   lpParameters,</span><br><span class="line">            _In_opt_  LPCTSTR   lpDirectory,</span><br><span class="line">            _In_      ULONG     fMask,</span><br><span class="line">            _In_      ULONG     nShow</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* SetRegistryStringValue)(</span><br><span class="line">            __RPC__in ICMLuaUtil* This,</span><br><span class="line">            _In_      HKEY hKey,</span><br><span class="line">            _In_opt_  LPCTSTR lpSubKey,</span><br><span class="line">            _In_opt_  LPCTSTR lpValueName,</span><br><span class="line">            _In_      LPCTSTR lpValueString</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method9)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method10)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method11)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method12)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method13)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method14)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method15)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method16)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method17)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method18)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method19)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">        <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method20)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    END_INTERFACE</span><br><span class="line">&#125; *PICMLuaUtilVtbl;</span><br><span class="line">interface ICMLuaUtil &#123;</span><br><span class="line">    CONST_VTBL <span class="keyword">struct</span> <span class="title class_">ICMLuaUtilVtbl</span>* lpVtbl;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API VOID CALLBACK <span class="title">PassUAC</span><span class="params">(HWND hwnd, HINSTANCE hInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span></span>;</span><br><span class="line"><span class="comment">// 内部函数</span></span><br><span class="line"><span class="function">HRESULT <span class="title">CoCreateInstanceAsAdmin</span><span class="params">(HWND hwnd, REFCLSID rclsid, REFIID riid, LPVOID* ppVoid)</span></span>;</span><br></pre></td></tr></table></figure>

<p>DLL源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;objbase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PassUAC.h&quot;</span></span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">VOID CALLBACK <span class="title">PassUAC</span><span class="params">(HWND hwnd, HINSTANCE hInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    CLSID clsid;</span><br><span class="line">    IID iid;</span><br><span class="line">    ICMLuaUtil* pCMLuaUtil = <span class="literal">NULL</span>;</span><br><span class="line">    LPVOID pVoid = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// CMSTPLUA组件的CLSID：3E5FC7F9-9A51-4367-9063-A120244FBEC7</span></span><br><span class="line">    <span class="built_in">CLSIDFromString</span>(<span class="string">L&quot;&#123;3E5FC7F9-9A51-4367-9063-A120244FBEC7&#125;&quot;</span>, &amp;clsid);</span><br><span class="line">    <span class="comment">// ICMLuaUtil接口的IID：6EDD6D74-C007-4E75-B76A-E5740995E24C</span></span><br><span class="line">    <span class="built_in">IIDFromString</span>(<span class="string">L&quot;&#123;6EDD6D74-C007-4E75-B76A-E5740995E24C&#125;&quot;</span>, &amp;iid);</span><br><span class="line">    <span class="comment">// 初始化COM库</span></span><br><span class="line">    <span class="built_in">CoInitializeEx</span>(<span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 以管理员权限创建COM对象，返回ICMLuaUtil接口的指针</span></span><br><span class="line">    <span class="built_in">CoCreateInstanceAsAdmin</span>(<span class="literal">NULL</span>, clsid, iid, (LPVOID*)&amp;pCMLuaUtil);</span><br><span class="line">    <span class="comment">// 命令行参数转换为宽字节</span></span><br><span class="line">    <span class="type">int</span> nCchWideChar = <span class="built_in">MultiByteToWideChar</span>(CP_ACP, <span class="number">0</span>, lpCmdLine, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    WCHAR* lpWideCharStr = <span class="keyword">new</span> WCHAR[nCchWideChar];</span><br><span class="line">    <span class="built_in">MultiByteToWideChar</span>(CP_ACP, <span class="number">0</span>, lpCmdLine, <span class="number">-1</span>, lpWideCharStr, nCchWideChar);</span><br><span class="line">    <span class="comment">// 启动程序</span></span><br><span class="line">    pCMLuaUtil-&gt;lpVtbl-&gt;<span class="built_in">ShellExec</span>(pCMLuaUtil, lpWideCharStr, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, SW_SHOWNORMAL);</span><br><span class="line">    <span class="comment">// 清理工作</span></span><br><span class="line">    pCMLuaUtil-&gt;lpVtbl-&gt;<span class="built_in">Release</span>(pCMLuaUtil);</span><br><span class="line">    <span class="keyword">delete</span>[] lpWideCharStr;</span><br><span class="line">    <span class="built_in">CoUninitialize</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 内部函数</span></span><br><span class="line"><span class="function">HRESULT <span class="title">CoCreateInstanceAsAdmin</span><span class="params">(HWND hwnd, REFCLSID rclsid, REFIID riid, LPVOID* ppVoid)</span> </span>&#123;</span><br><span class="line">    WCHAR wszCLSID[<span class="number">50</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WCHAR wszDisplayName[<span class="number">300</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    BIND_OPTS3 bindOpts3;</span><br><span class="line">    <span class="comment">// 构造显示名称，格式：Elevation:Administrator!new:&#123;guid&#125;</span></span><br><span class="line">    <span class="built_in">StringFromGUID2</span>(rclsid, wszCLSID, _countof(wszCLSID));</span><br><span class="line">    <span class="built_in">StringCchPrintfW</span>(wszDisplayName, _countof(wszDisplayName), <span class="string">L&quot;Elevation:Administrator!new:%s&quot;</span>, wszCLSID);</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;bindOpts3, <span class="built_in">sizeof</span>(BIND_OPTS3));</span><br><span class="line">    bindOpts3.cbStruct = <span class="built_in">sizeof</span>(BIND_OPTS3);</span><br><span class="line">    bindOpts3.dwClassContext = CLSCTX_LOCAL_SERVER;</span><br><span class="line">    bindOpts3.hwnd = hwnd;</span><br><span class="line">    <span class="comment">// 根据显示名称创建名字对象，返回riid参数指定的接口指针</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CoGetObject</span>(wszDisplayName, &amp;bindOpts3, riid, ppVoid);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>执行也简单，就是拼个命令行字符串：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    TCHAR szRundll32Path[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;C:\\Windows\\System32\\rundll32.exe&quot;</span>);</span><br><span class="line">    TCHAR szDllPath[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;F:\\Source\\Windows\\Chapter20\\PassUAC\\Debug\\PassUAC.dll&quot;</span>);</span><br><span class="line">    TCHAR szExcuteFileName[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;F:\\Source\\Windows\\Chapter20\\ProcessList.exe&quot;</span>);</span><br><span class="line">    TCHAR szParameters[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_CALL: &#123;</span><br><span class="line">                    <span class="built_in">wsprintf</span>(szParameters, <span class="built_in">TEXT</span>(<span class="string">&quot;\&quot;%s\&quot; %s \&quot;%s\&quot;&quot;</span>), szDllPath, <span class="built_in">TEXT</span>(<span class="string">&quot;PassUAC&quot;</span>), szExcuteFileName);</span><br><span class="line">                    <span class="built_in">ShellExecute</span>(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;open&quot;</span>), szRundll32Path, szParameters, <span class="literal">NULL</span>, SW_SHOW);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="用户界面特权隔离"><a href="#用户界面特权隔离" class="headerlink" title="用户界面特权隔离"></a>用户界面特权隔离</h2><h3 id="概览-3"><a href="#概览-3" class="headerlink" title="概览"></a>概览</h3><p>强制完整性控制MIC：使一种控制对安全对象访问的机制，是对自主访问控制的补充，在对安全对象的自主访问控制列表DACL进行访问前需要评估，MIC使用完整性级别和强制策略来评估访问。安全主体和安全对象被分配了完整性级别，完整性级别决定了他们的保护或访问级别。具有低完整性级别的主体无法写入具有中完整性级别的对象，即使该对象DACL允许写访问。完整性级别有4个：“低”、“中”、“高”和“系统”。标准用户获得“中”，提升用户获得“高”。</p>
<p>Windows消息子系统采用了MIC，从而实现了用户界面特权隔离UIPI。UIPI阻止一个进程向完整性级别更高的进程所属窗口发送消息，除了WM_NULL、WM_MOVE、WM_SIZE、WM_GETTEXT、WM_GETTEXTLENGTH、WM_GETTHOTKEY、WM_GETICON、WM_RENDERFORMAT、WM_DRAWCLIPBOARD、WM_CHANGECBCHAIN、WM_THEMECHANGED。启用UIPI后不能用<code>SendMessage</code>&#x2F;<code>PostMessage</code>向更高权限进程窗口发送消息，函数虽会被成功调用但消息会被删除，也不能用线程挂钩附加到更高权限的进程、不能用日志钩子监控更高权限的进程、不能将DLL注入更高权限的进程等。但低完整性级别与较高完整性级别进程之间通信可用剪贴板、共享内存、IPC、Socket、COM接口和命名管道等。</p>
<p>实例：在启用UAC情况下，explorer.exe完整性级别是“中”。explorer.exe作为父进程启动其他进程都从该父进程继承访问令牌和完整性级别。explorer.exe向软件拖拽文件实际上是explorer.exe向该进程发送WM_DROPFILES消息，想要成功发送则explorer.exee完整性级别必须低于该进程。</p>
<h3 id="ChangeWindowMessageFilterEx"><a href="#ChangeWindowMessageFilterEx" class="headerlink" title="ChangeWindowMessageFilterEx"></a>ChangeWindowMessageFilterEx</h3><p>修改指定窗口UIPI消息过滤器：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">ChangeWindowMessageFilterEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HWND hwnd, <span class="comment">//要修改UIPI消息过滤器的窗口句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ UINT message, <span class="comment">//允许消息过滤器通过或阻止的消息类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD action, <span class="comment">//要执行的操作</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_Inout_opt_ PCHANGEFILTERSTRUCT pChangeFilterStruct</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>action可以是：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>MSGFLT_ALLOW</td>
<td>允许消息通过。hwnd窗口能接收message指定的消息，即使来自较低权限进程</td>
</tr>
<tr>
<td>MSGFLT_DISALLOW</td>
<td>当消息来自较低权限进程，阻止要传递到hwnd窗口的message指定的消息</td>
</tr>
<tr>
<td>MSGFLT_RESET</td>
<td>将hwnd指定窗口的UIPI消息过滤器重置为默认值</td>
</tr>
</tbody></table>
<p>pChangeFilterStruct用于获取函数调用的扩展结果信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tagCHANGEFILTERSTRUCT</span> &#123;</span><br><span class="line">	DWORD cbSize; <span class="comment">//结构大小 单位字节</span></span><br><span class="line">	DWORD ExtStatus; <span class="comment">//函数调用的扩展结果信息</span></span><br><span class="line">&#125; CHANGEFILTERSTRUCT, * PCHANGEFILTERSTRUCT;</span><br></pre></td></tr></table></figure>

<h3 id="ChangeWindowMessageFilter"><a href="#ChangeWindowMessageFilter" class="headerlink" title="ChangeWindowMessageFilter"></a>ChangeWindowMessageFilter</h3><p>修改整个进程UIPI消息过滤器：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">ChangeWindowMessageFilter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ UINT message,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwFlag <span class="comment">//添加MSGFLT_ADD 删除MSGFLT_REMOVE</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="窗口查找与枚举"><a href="#窗口查找与枚举" class="headerlink" title="窗口查找与枚举"></a>窗口查找与枚举</h2><h3 id="概览-4"><a href="#概览-4" class="headerlink" title="概览"></a>概览</h3><p>重叠窗口和弹出窗口都可以是顶级窗口，顶级窗口的父窗口为桌面窗口，一般枚举桌面窗口所有子窗口实现顶级窗口枚举。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hwnd = <span class="built_in">GetWindow</span>(<span class="built_in">GetDesktopWindow</span>(), GW_CHILD);</span><br><span class="line"><span class="built_in">wihle</span>(hwnd != <span class="literal">NULL</span>) &#123;</span><br><span class="line">	<span class="built_in">GetWindowText</span>(hwnd, szTitle, _countof(szTitle)); <span class="comment">//窗口标题</span></span><br><span class="line">	<span class="built_in">GetClassName</span>(hwnd, szClassName, _countof(szClassName)); <span class="comment">//窗口类名</span></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	hwnd = <span class="built_in">GetWindow</span>(hwnd, GW_HWNDNEXT); <span class="comment">//下一个子窗口</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>处理完每个顶级窗口句柄后，可继续枚举该窗口的子窗口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hwndChild = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">while</span> (hwndChild = <span class="built_in">FindWindowEx</span>(hwnd, hwndChild, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">	<span class="built_in">SendMessage</span>(hwndChild, WM_GETTEXT, _countof(szTitle), (LPARAM)szTitle); <span class="comment">//获取其他窗口的子窗口标题只能发送消息</span></span><br><span class="line">	<span class="built_in">GetClassName</span>(hwndChild, szClassName, _countof(szClassName));</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这种方法有时不靠谱，可能会陷入死循环或引用已被销毁的窗口句柄。推荐用<code>EnumWindows</code>。</p>
<h3 id="FindWindowEx"><a href="#FindWindowEx" class="headerlink" title="FindWindowEx"></a>FindWindowEx</h3><p>查找指定父窗口中具有指定窗口类名和窗口标题的子窗口句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HWND <span class="title">FindWindowEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ HWND hWndParent, <span class="comment">//父窗口句柄 NULL表示桌面窗口作父窗口</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ HWND hWndChildAfter, <span class="comment">//开始搜索的子窗口句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpszClass, <span class="comment">//窗口类名</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPCTSTR lpszWindow <span class="comment">//窗口标题</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回窗口句柄 失败NULL</span></span><br></pre></td></tr></table></figure>

<p>当hWndParent和hWndChildAfter同时为NULL则查找所有顶级窗口。</p>
<h3 id="EnumWindows"><a href="#EnumWindows" class="headerlink" title="EnumWindows"></a>EnumWindows</h3><p>枚举顶级窗口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">EnumWindows</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ WNDENUMPROC lpEnumFunc, <span class="comment">//回调函数</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPARAM lParam <span class="comment">//传递给回调函数的参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中回调函数定义格式为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL CALLBACK <span class="title">EnumWindowsProc</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HWND hwnd, <span class="comment">//顶级窗口句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPARAM lParam <span class="comment">//传递过来的参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>回调函数处理完后返回TRUE表示继续枚举，返回FALSE停止枚举。</p>
<h3 id="EnumChildWindows"><a href="#EnumChildWindows" class="headerlink" title="EnumChildWindows"></a>EnumChildWindows</h3><p>枚举顶级窗口中的子窗口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">EnumChildWindows</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ HWND hWndParent, <span class="comment">//父窗口句柄 为NULL等效EnumWindows</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ WNDENUMPROC lpEnumFunc, <span class="comment">//回调函数 与EnumWindows的回调函数定义格式相同</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPARAM lParam <span class="comment">//传递给回调函数的参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="任务栏通知区域图标与气泡通知"><a href="#任务栏通知区域图标与气泡通知" class="headerlink" title="任务栏通知区域图标与气泡通知"></a>任务栏通知区域图标与气泡通知</h2><h3 id="Shell-NotifyIcon"><a href="#Shell-NotifyIcon" class="headerlink" title="Shell_NotifyIcon"></a>Shell_NotifyIcon</h3><p>在通知区域添加、修改或删除图标：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">Shell_NotifyIcon</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwMessage, <span class="comment">//要执行的操作</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ PNOTIFYICONDATA lpData</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>dwMessage常见值有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>NIM_ADD</td>
<td>将图标添加到通知区域</td>
</tr>
<tr>
<td>NIM_MODIFY</td>
<td>修改通知区域图标</td>
</tr>
<tr>
<td>NIM_DELETE</td>
<td>从通知区域中删除图标</td>
</tr>
</tbody></table>
<p>通过lpData的uID或guidItem字段指定图标的ID或GUID。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NOTIFYICONDATA</span> &#123;</span><br><span class="line">	DWORD cbSize; <span class="comment">//该结构大小</span></span><br><span class="line">	HWND hWnd; <span class="comment">//用于接收通知区域图标的通知消息的窗口句柄</span></span><br><span class="line">	UINT uID; <span class="comment">//通知区域图标ID</span></span><br><span class="line">	UINT uFlags; <span class="comment">//标志哪个字段有效</span></span><br><span class="line">	UINT uCallbackMessage; <span class="comment">//自定义消息ID</span></span><br><span class="line">	HICON hIcon; <span class="comment">//要添加、修改或删除的图标句柄</span></span><br><span class="line">	TCHAR  szTip[<span class="number">128</span>]; <span class="comment">//标准工具提示文本</span></span><br><span class="line">	DWORD dwState;</span><br><span class="line">	DWORD dwStateMask;</span><br><span class="line">	TCHAR  szInfo[<span class="number">256</span>]; <span class="comment">//气球通知的文本</span></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		UINT  uTimeout;</span><br><span class="line">		UINT  uVersion;</span><br><span class="line">	&#125; DUMMYUNIONNAME;</span><br><span class="line">	TCHAR  szInfoTitle[<span class="number">64</span>]; <span class="comment">//气球通知标题</span></span><br><span class="line">	DWORD dwInfoFlags;</span><br><span class="line">	GUID guidItem; <span class="comment">//图标GUID 指定后覆盖uID字段</span></span><br><span class="line">	HICON hBalloonIcon;</span><br><span class="line">&#125; NOTIFYICONDATA, * PNOTIFYICONDATA;</span><br></pre></td></tr></table></figure>

<p>当通知区域图标上发生鼠标事件时发送uCallbackMessage字段指定的自定义消息，当uVersion字段为0或NOTIFYICON_VERSION时，消息的wParam为通知区域图标ID，lParam为具体鼠标事件如WM_MOUSEMOVE、WM_LBUTTONUP、WM_RBUTTONUP等。</p>
<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h3><p>如果需要实现通知区域图标修改或闪动，则创建一个计时器，计时器消息中用用<code>Shell_NotifyIcon</code>和NIM_MODIFY参数，hIcon设置为NULL表示不显示图标。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 通知消息</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WM_TRAYMSG (WM_APP + 100)</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hInstance;</span><br><span class="line">HWND g_hwndDlg;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    g_hInstance = hInstance;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    NOTIFYICONDATA nid = &#123; <span class="built_in">sizeof</span>(NOTIFYICONDATA) &#125;;</span><br><span class="line">    POINT pt;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="comment">// 为程序设置一个图标</span></span><br><span class="line">            <span class="built_in">SendMessage</span>(hwndDlg, WM_SETICON, ICON_BIG, (LPARAM)<span class="built_in">LoadIcon</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_ICON_BIRD)));</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> ID_PROGRAM_SHOW: &#123;               <span class="comment">// 显示 菜单项</span></span><br><span class="line">                    <span class="built_in">ShowWindow</span>(hwndDlg, SW_SHOW);</span><br><span class="line">                    <span class="built_in">SetForegroundWindow</span>(hwndDlg);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> ID_PROGRAM_EXIT: &#123;              <span class="comment">// 退出 菜单项</span></span><br><span class="line">                    <span class="built_in">SendMessage</span>(hwndDlg, WM_SYSCOMMAND, SC_CLOSE, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_SYSCOMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (wParam &amp; <span class="number">0xFFF0</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> SC_MINIMIZE: &#123;</span><br><span class="line">                    <span class="comment">// 添加通知区域图标</span></span><br><span class="line">                    nid.hWnd = hwndDlg;</span><br><span class="line">                    nid.uID = IDI_ICON_BIRD;</span><br><span class="line">                    nid.uFlags = NIF_MESSAGE | NIF_ICON | NIF_TIP | NIF_INFO;</span><br><span class="line">                    nid.uCallbackMessage = WM_TRAYMSG;</span><br><span class="line">                    nid.hIcon = <span class="built_in">LoadIcon</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_ICON_BIRD));</span><br><span class="line">                    <span class="built_in">StringCchCopy</span>(nid.szTip, _countof(nid.szTip), <span class="built_in">TEXT</span>(<span class="string">&quot;NotifyIcon程序\n作者：老王&quot;</span>));</span><br><span class="line">                    <span class="built_in">StringCchCopy</span>(nid.szInfoTitle, _countof(nid.szInfoTitle), <span class="built_in">TEXT</span>(<span class="string">&quot;气球通知的标题&quot;</span>));</span><br><span class="line">                    <span class="built_in">StringCchCopy</span>(nid.szInfo, _countof(nid.szInfo), <span class="built_in">TEXT</span>(<span class="string">&quot;气球通知的文本1\n气球通知的文本2&quot;</span>));</span><br><span class="line">                    <span class="built_in">Shell_NotifyIcon</span>(NIM_ADD, &amp;nid);</span><br><span class="line">                    <span class="comment">// 隐藏窗口</span></span><br><span class="line">                    <span class="built_in">ShowWindow</span>(hwndDlg, SW_HIDE);</span><br><span class="line">                    <span class="keyword">return</span> TRUE;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> SC_CLOSE: &#123;</span><br><span class="line">                    <span class="comment">// 删除通知区域图标</span></span><br><span class="line">                    nid.hWnd = hwndDlg;</span><br><span class="line">                    nid.uID = IDI_ICON_BIRD;</span><br><span class="line">                    <span class="built_in">Shell_NotifyIcon</span>(NIM_DELETE, &amp;nid);</span><br><span class="line">                    <span class="built_in">SendMessage</span>(hwndDlg, WM_CLOSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">return</span> TRUE;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_TRAYMSG: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (lParam) &#123;</span><br><span class="line">                <span class="keyword">case</span> WM_LBUTTONUP: &#123;                <span class="comment">// 鼠标左键点击</span></span><br><span class="line">                    <span class="comment">// 显示窗口</span></span><br><span class="line">                    <span class="built_in">ShowWindow</span>(hwndDlg, SW_SHOW);</span><br><span class="line">                    <span class="built_in">SetForegroundWindow</span>(hwndDlg);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> WM_RBUTTONUP: &#123;                  <span class="comment">// 鼠标右键点击</span></span><br><span class="line">                    <span class="comment">// 弹出快捷菜单</span></span><br><span class="line">                    <span class="built_in">GetCursorPos</span>(&amp;pt);</span><br><span class="line">                    <span class="built_in">TrackPopupMenu</span>(<span class="built_in">GetSubMenu</span>(<span class="built_in">LoadMenu</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDR_MENU_POPUP)), <span class="number">0</span>), TPM_LEFTALIGN | TPM_TOPALIGN, pt.x, pt.y, <span class="number">0</span>, hwndDlg, <span class="literal">NULL</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://Monoceros.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://monoceros.github.io/2024/07/22/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%9D%82%E8%B0%88/">http://monoceros.github.io/2024/07/22/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%9D%82%E8%B0%88/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Monoceros.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">逆向工程</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/23/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" title="Windows软件调试初探-启动过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows软件调试初探-启动过程</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/22/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" title="WindowsAPI查缺补漏-异常处理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">WindowsAPI查缺补漏-异常处理</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/16/Angr%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/" title="Angr做题笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="title">Angr做题笔记</div></div></a></div><div><a href="/2023/10/29/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%AC%94%E8%AE%B0/" title="Angr符号执行笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">Angr符号执行笔记</div></div></a></div><div><a href="/2023/11/09/C-%E7%97%85%E6%AF%92%E6%8A%80%E6%9C%AF/" title="C++病毒技术"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="title">C++病毒技术</div></div></a></div><div><a href="/2023/11/15/CvxPy%E6%95%B4%E6%95%B0%E8%A7%84%E5%88%92%E7%AC%94%E8%AE%B0/" title="CvxPy整数规划笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-15</div><div class="title">CvxPy整数规划笔记</div></div></a></div><div><a href="/2023/10/21/IDA%E5%9C%A8Kali-Linux%E4%B8%8B%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/" title="IDA在Kali Linux下的远程动态调试笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-21</div><div class="title">IDA在Kali Linux下的远程动态调试笔记</div></div></a></div><div><a href="/2023/10/29/IDA%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="IDA脚本编程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">IDA脚本编程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">智邮普创工作室安全组/Nepnep联合战队</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">259</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">QQ:1295625063（不找对象）</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%9D%82%E8%B0%88"><span class="toc-number">1.</span> <span class="toc-text">WindowsAPI查缺补漏-杂谈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.</span> <span class="toc-text">程序开机自启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%A8%8B%E5%BA%8F%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F%E5%86%99%E5%85%A5%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8%E7%A8%8B%E5%BA%8F%E7%9B%AE%E5%BD%95%E6%B3%95"><span class="toc-number">1.1.1.</span> <span class="toc-text">将程序快捷方式写入开机自启动程序目录法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text">创建计划任务法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">系统服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%A7%88"><span class="toc-number">1.2.1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StartService"><span class="toc-number">1.2.2.</span> <span class="toc-text">StartService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ControlService"><span class="toc-number">1.2.3.</span> <span class="toc-text">ControlService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ChangeServiceConfig"><span class="toc-number">1.2.4.</span> <span class="toc-text">ChangeServiceConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CreateService"><span class="toc-number">1.2.5.</span> <span class="toc-text">CreateService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DeleteService"><span class="toc-number">1.2.6.</span> <span class="toc-text">DeleteService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8%E4%BB%BF%E7%9C%9F"><span class="toc-number">1.2.7.</span> <span class="toc-text">实例：系统服务管理器仿真</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%BC%96%E5%86%99"><span class="toc-number">1.2.8.</span> <span class="toc-text">服务程序的编写</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%A7%88-1"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StartServiceCtrlDispatcher"><span class="toc-number">1.2.8.2.</span> <span class="toc-text">StartServiceCtrlDispatcher</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RegisterServiceCtrlHandlerEx"><span class="toc-number">1.2.8.3.</span> <span class="toc-text">RegisterServiceCtrlHandlerEx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.2.8.4.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AA%81%E7%A0%B4SESSION-0%E9%9A%94%E7%A6%BB%E5%88%9B%E5%BB%BAGUI"><span class="toc-number">1.2.9.</span> <span class="toc-text">突破SESSION 0隔离创建GUI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%A7%88-2"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WTSSendMessage"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">WTSSendMessage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WTSGetActiveConsoleSessionId"><span class="toc-number">1.2.9.3.</span> <span class="toc-text">WTSGetActiveConsoleSessionId</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateProcessAsUser"><span class="toc-number">1.2.9.4.</span> <span class="toc-text">CreateProcessAsUser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WTSQueryUserToken"><span class="toc-number">1.2.9.5.</span> <span class="toc-text">WTSQueryUserToken</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DuplicateTokenEx"><span class="toc-number">1.2.9.6.</span> <span class="toc-text">DuplicateTokenEx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateEnvironmentBlock"><span class="toc-number">1.2.9.7.</span> <span class="toc-text">CreateEnvironmentBlock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.2.9.8.</span> <span class="toc-text">例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%B4%A6%E6%88%B7%E6%8E%A7%E5%88%B6UAC"><span class="toc-number">1.3.</span> <span class="toc-text">用户账户控制UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%8F%90%E7%A4%BA%E7%94%A8%E6%88%B7%E6%8F%90%E5%8D%87%E6%9D%83%E9%99%90"><span class="toc-number">1.3.1.</span> <span class="toc-text">自动提示用户提升权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8ShellExecuteEx%E4%BB%A5%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90%E5%90%AF%E5%8A%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">用ShellExecuteEx以管理员权限启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass-UAC"><span class="toc-number">1.3.3.</span> <span class="toc-text">Bypass UAC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E7%89%B9%E6%9D%83%E9%9A%94%E7%A6%BB"><span class="toc-number">1.4.</span> <span class="toc-text">用户界面特权隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%A7%88-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ChangeWindowMessageFilterEx"><span class="toc-number">1.4.2.</span> <span class="toc-text">ChangeWindowMessageFilterEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ChangeWindowMessageFilter"><span class="toc-number">1.4.3.</span> <span class="toc-text">ChangeWindowMessageFilter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E6%9F%A5%E6%89%BE%E4%B8%8E%E6%9E%9A%E4%B8%BE"><span class="toc-number">1.5.</span> <span class="toc-text">窗口查找与枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%A7%88-4"><span class="toc-number">1.5.1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FindWindowEx"><span class="toc-number">1.5.2.</span> <span class="toc-text">FindWindowEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnumWindows"><span class="toc-number">1.5.3.</span> <span class="toc-text">EnumWindows</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnumChildWindows"><span class="toc-number">1.5.4.</span> <span class="toc-text">EnumChildWindows</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%A0%8F%E9%80%9A%E7%9F%A5%E5%8C%BA%E5%9F%9F%E5%9B%BE%E6%A0%87%E4%B8%8E%E6%B0%94%E6%B3%A1%E9%80%9A%E7%9F%A5"><span class="toc-number">1.6.</span> <span class="toc-text">任务栏通知区域图标与气泡通知</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Shell-NotifyIcon"><span class="toc-number">1.6.1.</span> <span class="toc-text">Shell_NotifyIcon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-2"><span class="toc-number">1.6.2.</span> <span class="toc-text">例子</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/06/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E6%89%98%E7%AE%A1/" title="Windows软件调试初探-托管">Windows软件调试初探-托管</a><time datetime="2024-08-06T07:17:13.000Z" title="发表于 2024-08-06 15:17:13">2024-08-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/31/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-PE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/" title="WindowsAPI查缺补漏-PE文件格式解析">WindowsAPI查缺补漏-PE文件格式解析</a><time datetime="2024-07-31T00:51:12.000Z" title="发表于 2024-07-31 08:51:12">2024-07-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/26/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-WinSock%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" title="WindowsAPI查缺补漏-WinSock网络编程">WindowsAPI查缺补漏-WinSock网络编程</a><time datetime="2024-07-26T07:48:34.000Z" title="发表于 2024-07-26 15:48:34">2024-07-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/25/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E5%9E%AB%E7%89%87/" title="Windows软件调试初探-垫片">Windows软件调试初探-垫片</a><time datetime="2024-07-25T12:51:47.000Z" title="发表于 2024-07-25 20:51:47">2024-07-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/25/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E7%89%B9%E6%AE%8A%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8/" title="Windows软件调试初探-特殊过程调用">Windows软件调试初探-特殊过程调用</a><time datetime="2024-07-25T00:55:09.000Z" title="发表于 2024-07-25 08:55:09">2024-07-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>