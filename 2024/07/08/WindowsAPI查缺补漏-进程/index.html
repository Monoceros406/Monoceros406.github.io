<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>WindowsAPI查缺补漏-进程 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="WindowsAPI查缺补漏-进程创建进程ShellExecute打开i可执行文件、文档文件、网址等。 12345678HINSTANCE ShellExecute(    _In_opt_ HWND hwnd, &#x2F;&#x2F;父窗口句柄    _In_opt_ LPCTSTR lpOperation, &#x2F;&#x2F;指定的操作    _In_ LPCTSTR lpFile, &#x2F;&#x2F;要操作的文件或文件夹    _In_">
<meta property="og:type" content="article">
<meta property="og:title" content="WindowsAPI查缺补漏-进程">
<meta property="og:url" content="http://monoceros.github.io/2024/07/08/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E8%BF%9B%E7%A8%8B/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="WindowsAPI查缺补漏-进程创建进程ShellExecute打开i可执行文件、文档文件、网址等。 12345678HINSTANCE ShellExecute(    _In_opt_ HWND hwnd, &#x2F;&#x2F;父窗口句柄    _In_opt_ LPCTSTR lpOperation, &#x2F;&#x2F;指定的操作    _In_ LPCTSTR lpFile, &#x2F;&#x2F;要操作的文件或文件夹    _In_">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://monoceros.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-07-08T10:28:14.000Z">
<meta property="article:modified_time" content="2024-07-23T02:10:10.082Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="逆向工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://monoceros.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://monoceros.github.io/2024/07/08/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E8%BF%9B%E7%A8%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WindowsAPI查缺补漏-进程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-23 10:10:10'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">289</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WindowsAPI查缺补漏-进程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-08T10:28:14.000Z" title="发表于 2024-07-08 18:28:14">2024-07-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-23T02:10:10.082Z" title="更新于 2024-07-23 10:10:10">2024-07-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WindowsAPI查缺补漏-进程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="WindowsAPI查缺补漏-进程"><a href="#WindowsAPI查缺补漏-进程" class="headerlink" title="WindowsAPI查缺补漏-进程"></a>WindowsAPI查缺补漏-进程</h1><h2 id="创建进程"><a href="#创建进程" class="headerlink" title="创建进程"></a>创建进程</h2><h3 id="ShellExecute"><a href="#ShellExecute" class="headerlink" title="ShellExecute"></a>ShellExecute</h3><p>打开i可执行文件、文档文件、网址等。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HINSTANCE <span class="title">ShellExecute</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HWND hwnd, <span class="comment">//父窗口句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpOperation, <span class="comment">//指定的操作</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCTSTR lpFile, <span class="comment">//要操作的文件或文件夹</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpParameters, <span class="comment">//当lpFile为可执行文件时 为命令行参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpDirectory, <span class="comment">//要操作的文件的默认工作目录</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ INT nShowCmd <span class="comment">//显示标志</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>lpOperation可以是：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>open</td>
<td>由关联的默认程序打开lpFile文件&#x2F;文件夹</td>
</tr>
<tr>
<td>explore</td>
<td>资源管理器打开lpFIle文件夹</td>
</tr>
<tr>
<td>edit</td>
<td>用编辑器（记事本）打开lpFile指定的文档，不是文档则调用失败</td>
</tr>
<tr>
<td>print</td>
<td>打印lpFile指定的文件，不是文档文件则失败</td>
</tr>
<tr>
<td>find</td>
<td>从lpDirectory目录开始搜索</td>
</tr>
</tbody></table>
<p>执行成功返回大于32的HINSTANCE类型值，失败返回：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>操作系统内存或资源不足</td>
</tr>
<tr>
<td>ERROR_FILE_NOT_FOUND</td>
<td>找不到指定文件</td>
</tr>
<tr>
<td>ERROR_PATH_NOT_FOUND</td>
<td>找不到指定路径</td>
</tr>
<tr>
<td>ERROR_BAD_FORMAT</td>
<td>.exe文件无效</td>
</tr>
<tr>
<td>SE_ERR_ACCESSDENIED</td>
<td>操作系统拒绝对指定文件的访问</td>
</tr>
<tr>
<td>SE_ERR_ASSOCINCOMPLETE</td>
<td>文件名关联不完整或无效</td>
</tr>
<tr>
<td>SE_ERR_DLLNOTFOUND</td>
<td>找不到指定动态链接库</td>
</tr>
<tr>
<td>SE_ERR_FNF</td>
<td>找不到指定文件</td>
</tr>
<tr>
<td>SE_ERR_NOASSOC</td>
<td>没有关联的应用程序，或文件不可打印</td>
</tr>
<tr>
<td>SE_ERR_OOM</td>
<td>没有足够的内存来完成操作</td>
</tr>
<tr>
<td>SE_ERR_PNF</td>
<td>找不到指定路径</td>
</tr>
<tr>
<td>SE_ERR_SHARE</td>
<td>发生共享冲突</td>
</tr>
</tbody></table>
<h3 id="WinExec"><a href="#WinExec" class="headerlink" title="WinExec"></a>WinExec</h3><p>运行指定程序，已废弃用<code>CreateProcess</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UINT WINAPI <span class="title">WinExec</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCSTR lpCmdLine, <span class="comment">//要执行的应用程序的命令行</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uCmdShow <span class="comment">//显示标志</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">//成功返回值大于31</span></span></span><br></pre></td></tr></table></figure>

<h3 id="CreateProcess"><a href="#CreateProcess" class="headerlink" title="CreateProcess"></a>CreateProcess</h3><p>为指定名称的可执行文件创建进程以及进程的主线程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">CreateProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpApplicationName, <span class="comment">//要执行的可执行文件名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_opt_ LPTSTR lpCommandLine, <span class="comment">//命令行参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBTUES lpProcessAttributes, <span class="comment">//新进程的安全属性结构</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpThreadAttributes, <span class="comment">//新进程的主线程安全属性结构</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bInheritHandles, <span class="comment">//调用进程句柄是否可被新进程继承</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags, <span class="comment">//创建标志和进程优先级 可0</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPVOID lpEnvironment, <span class="comment">//指向新进程环境快的指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpCurrentDirectory, <span class="comment">//指向新进程当前目录</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPSTARTUPINFO lpStartupInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>dwCreationFlags中创建标志可以是：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>DEBUG_PROCESS</td>
<td>父进程调试子进程及子进程生成的所有进程，子进程发生特定事件时通知父进程</td>
</tr>
<tr>
<td>DEBUG_ONLY_THIS_PROCESS</td>
<td>同DEBUG_PROCESS，但孙进程不通知父进程</td>
</tr>
<tr>
<td>CREATE_SUSPENDED</td>
<td>新进程的主线程处于挂起状态，用<code>ResumeThread</code>恢复运行</td>
</tr>
<tr>
<td>EXTENDED_STARTUPINFO_PRESENT</td>
<td>使用扩展启动信息创建进程</td>
</tr>
<tr>
<td>CREATE_UNICODE_ENVIRONMENT</td>
<td>lpEnvironment参数使用Unicode字符</td>
</tr>
<tr>
<td>CREATE_DEFAULT_ERROR_MODE</td>
<td>新进程不继承调用进程错误模式，使用默认错误模式</td>
</tr>
<tr>
<td>DETACHED_PROCESS</td>
<td>CUI进程时不使用父进程控制台窗口，可用<code>AllocConsole</code>创建新的控制台。</td>
</tr>
<tr>
<td>CREATE_NEW_CONSOLE</td>
<td>CUI进程时新建一个控制台窗口</td>
</tr>
<tr>
<td>CREATE_NO_WINDOW</td>
<td>CUI进程时不创建控制台窗口</td>
</tr>
</tbody></table>
<p>dwCreationFlags中进程优先级可以是：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>REALTIME_PRIORITY_CLASS</td>
<td>实时</td>
</tr>
<tr>
<td>HIGH_PRIORITY_CLASS</td>
<td>高</td>
</tr>
<tr>
<td>ABOVE_NORMAL_PRIORITY_CLASS</td>
<td>高于标准</td>
</tr>
<tr>
<td>NORMAL_PRIORITY_CLASS</td>
<td>标准</td>
</tr>
<tr>
<td>BELOW_NORMAL_PRIORITY_CLASS</td>
<td>低于标准</td>
</tr>
<tr>
<td>IDLE_PRIORITY_CLASS</td>
<td>低</td>
</tr>
</tbody></table>
<p>lpStartupInfo中STARTUPINFO或STARTUPINFOEX结构为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_STARTUPINFO</span> &#123;</span><br><span class="line">    DWORD   cb; <span class="comment">//该结构大小</span></span><br><span class="line">    LPWSTR  lpReserved; <span class="comment">//NULL</span></span><br><span class="line">    LPWSTR  lpDesktop; <span class="comment">//桌面名称 通常NULL</span></span><br><span class="line">    LPWSTR  lpTitle; <span class="comment">//控制台窗口标题</span></span><br><span class="line">    DWORD   dwX; <span class="comment">//窗口左上角X坐标 单位像素</span></span><br><span class="line">    DWORD   dwY; <span class="comment">//窗口左上角Y坐标 单位像素</span></span><br><span class="line">    DWORD   dwXSize; <span class="comment">//窗口宽度 单位像素</span></span><br><span class="line">    DWORD   dwYSize; <span class="comment">//窗口高度 单位像素</span></span><br><span class="line">    DWORD   dwXCountChars; <span class="comment">//屏幕缓冲区宽度 单位字符列</span></span><br><span class="line">    DWORD   dwYCountChars; <span class="comment">//屏幕缓冲区高度 单位字符行</span></span><br><span class="line">    DWORD   dwFillAttribute; <span class="comment">//文本/背景颜色</span></span><br><span class="line">    DWORD   dwFlags; <span class="comment">//位掩码 该结构哪个字段有效</span></span><br><span class="line">    WORD    wShowWindow; <span class="comment">//显示标志</span></span><br><span class="line">    WORD    cbReserved2; <span class="comment">//0</span></span><br><span class="line">    LPBYTE  lpReserved2; <span class="comment">//NULL</span></span><br><span class="line">    HANDLE  hStdInput; <span class="comment">//标准输入句柄</span></span><br><span class="line">    HANDLE  hStdOutput; <span class="comment">//标准输出句柄</span></span><br><span class="line">    HANDLE  hStdError; <span class="comment">//标准错误句柄</span></span><br><span class="line">&#125; STARTUPINFO, * LPSTARTUPINFO;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_STARTUPINFOEX</span> &#123; <span class="comment">//使用时在lpCreationFlags中指定EXTENDED_STARTUPINFO_PRESENT</span></span><br><span class="line">    STARTUPINFO StartupInfo;</span><br><span class="line">    LPPROC_THREAD_ATTRIBUTE_LIST lpAttributeList; <span class="comment">//属性列表</span></span><br><span class="line">&#125; STARTUPINFOEX, * LPSTARTUPINFOEX;</span><br></pre></td></tr></table></figure>

<p>dwFlags常用标志有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>有效字段</th>
</tr>
</thead>
<tbody><tr>
<td>STARTF_USESIZE</td>
<td>dwXSize dwYSize</td>
</tr>
<tr>
<td>STARTF_USESHOWWINDOW</td>
<td>wShowWindow</td>
</tr>
<tr>
<td>STARTF_USEPOSITION</td>
<td>dwX dwY</td>
</tr>
<tr>
<td>STARTF_USECOUNTCHARS</td>
<td>dwXCountChars dwYCountChars</td>
</tr>
<tr>
<td>STARTF_USEFILLATTRIBUTE</td>
<td>dwFillAttribute</td>
</tr>
<tr>
<td>STARTF_USESTDHANDLES</td>
<td>hStdInput hStdOutput hStdError</td>
</tr>
</tbody></table>
<p>对于lpProcessInformation参数的PROCESS_INFORMATION结构记录新进程的信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PROCESS_INFORMATION</span> &#123;</span><br><span class="line">    HANDLE hProcess; <span class="comment">//新进程句柄</span></span><br><span class="line">    HANDLE hThread; <span class="comment">//主线程句柄</span></span><br><span class="line">    DWORD  dwProcessId; <span class="comment">//进程ID</span></span><br><span class="line">    DWORD  dwThreadId; <span class="comment">//主线程ID</span></span><br><span class="line">&#125; PROCESS_INFORMATION, * PPROCESS_INFORMATION, * LPPROCESS_INFORMATION;</span><br></pre></td></tr></table></figure>

<p>因为系统打开进程内核对象和线程内核对象时，句柄的计数会加1，所以获取后要及时关闭句柄。</p>
<p>例如运行记事本并打开D:\Text.txt文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TCHAR szCommandLine[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;Notepad D:\\Test.txt&quot;</span>);</span><br><span class="line">STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="built_in">GetStartupInfo</span>(&amp;si);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi)) &#123;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="GetStartupInfo"><a href="#GetStartupInfo" class="headerlink" title="GetStartupInfo"></a>GetStartupInfo</h3><p>获取当前进程STARTINFO结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID WINAPI <span class="title">GetStartupInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPSTARTUPINFO lpStartupInfo</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="GetModuleHandle"><a href="#GetModuleHandle" class="headerlink" title="GetModuleHandle"></a>GetModuleHandle</h3><p>获取调用进程中指定模块的模块句柄（基地址）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HMODULE WINAPI <span class="title">GetModuleHandle</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpModuleName <span class="comment">//调用进程地址空间中加载的一个模块的名称</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">//没找到返回NULL</span></span></span><br></pre></td></tr></table></figure>

<p>当lpModuleName设置为NULL时获取调用进程的可执行文件模块加载基地址，即使在DLL中也返回可执行文件模块基地址。</p>
<h3 id="GetModuleFileName"><a href="#GetModuleFileName" class="headerlink" title="GetModuleFileName"></a>GetModuleFileName</h3><p>获取当前进程已加载模块完整路径，已废弃用<code>GetModuleFileNameEx</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">GetModuleFileName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HMODULE hModule,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPTSTR lpFilename,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD nSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="GetModuleFileNameEx"><a href="#GetModuleFileNameEx" class="headerlink" title="GetModuleFileNameEx"></a>GetModuleFileNameEx</h3><p>后去当前&#x2F;另一个进程中已加载模块完整路径：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">GetModuleFileNameEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//包含hModule的进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HMODULE hModule, <span class="comment">//模块句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPTSTR lpFilename, <span class="comment">//返回文件完整路径</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD nSize <span class="comment">//lpFileName缓冲区大小 单位字符</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>需要对hProcess的PROCESS_QUERY_INFORMATION和PROCESS_VM_READ访问权限。</p>
<p>函数成功则返回复制到缓冲区中字符个数，不含终止空字符，失败返回0。</p>
<h3 id="WaitForInputIdle"><a href="#WaitForInputIdle" class="headerlink" title="WaitForInputIdle"></a>WaitForInputIdle</h3><p>创建子进程后，<code>CreateProcess</code>马上返回，但子进程加载和初始化需要时间。用<code>WaitForInputIdle</code>挂起调用线程直到指定进程初始化完毕或函数等待超时返回。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">WaitForInputIdle</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//等待该进程输入空闲</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwMilliseconds <span class="comment">//等待时间 单位毫秒 INFINITE永久等待</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>返回值有：0等待成功、WAIT_TIMEOUT超时时间已过、WAIT_FAILED发生错误。</p>
<h3 id="GetMappedFileName"><a href="#GetMappedFileName" class="headerlink" title="GetMappedFileName"></a>GetMappedFileName</h3><p>检查指定内存地址是否位于指定进程地址空间中，并返回进程所对应可执行文件名：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">GetMappedFileName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//进程句柄 需要PROCESS_QUERY_INFORMATION和PROCESS_VM_READ访问权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPVOID lpv, <span class="comment">//内存地址</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPTSTR lpFileName, <span class="comment">//返回可执行文件名称的缓冲区</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In DWORD nSize <span class="comment">//缓冲区大小 单位字节</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">//成功返回复制到缓冲区字符串长 失败0</span></span></span><br></pre></td></tr></table></figure>

<p>返回的文件名称路径为本机系统路径格式如\Device\HarddiskVolume2\，已废弃用<code>GetModuleFileNameEx</code>&#x2F;<code>QueryFullProcessImageName</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GetModuleFileNameEx</span>(pi.hProcess, <span class="literal">NULL</span>, szImageFile, _countof(szImageFile));</span><br><span class="line"></span><br><span class="line">DWORD dwLen = _countof(szImageFile);</span><br><span class="line"><span class="built_in">QueryFullProcessImageName</span>(pi.hProcess, <span class="number">0</span>, szImageFile, &amp;dwLen);</span><br></pre></td></tr></table></figure>

<h2 id="多进程间共享内核对象"><a href="#多进程间共享内核对象" class="headerlink" title="多进程间共享内核对象"></a>多进程间共享内核对象</h2><h3 id="GetCurrentProcess-GetCurrentThread"><a href="#GetCurrentProcess-GetCurrentThread" class="headerlink" title="GetCurrentProcess&#x2F;GetCurrentThread"></a>GetCurrentProcess&#x2F;GetCurrentThread</h3><p>俩大抽象。</p>
<p>获取当前进程&#x2F;调用线程句柄，但获取的都是伪句柄。当前进程伪句柄为0xFFFFFFFF，调用线程伪句柄为0xFFFFFFFE。伪句柄不能由子进程继承，不使用时不用关闭。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE WINAPI <span class="title">GetCurrentProcess</span><span class="params">(VOID)</span></span>;</span><br><span class="line"><span class="function">HANDLE WINAPI <span class="title">GetCurrentThread</span><span class="params">(VOID)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="GetCurrentProcessId-GetCurrentThreadId"><a href="#GetCurrentProcessId-GetCurrentThreadId" class="headerlink" title="GetCurrentProcessId&#x2F;GetCurrentThreadId"></a>GetCurrentProcessId&#x2F;GetCurrentThreadId</h3><p>获取当前进程&#x2F;调用线程的ID：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">GetCurrentProcessId</span><span class="params">(VOID)</span></span>;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">GetCurrentThreadId</span><span class="params">(VOID)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="GetProcessId-GetThreadId"><a href="#GetProcessId-GetThreadId" class="headerlink" title="GetProcessId&#x2F;GetThreadId"></a>GetProcessId&#x2F;GetThreadId</h3><p>获取指定进程&#x2F;线程的ID：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">GetProcessId</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE Process</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">GetThreadId</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE Thread</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="OpenProcess"><a href="#OpenProcess" class="headerlink" title="OpenProcess"></a>OpenProcess</h3><p>通过进程ID获取进程句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE WINAPI <span class="title">OpenProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwDesiredAccess, <span class="comment">//对进程访问权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bInheritHandle, <span class="comment">//句柄是否可被调用进程的子进程继承</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwProcessId <span class="comment">//进程ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">//成功返回指定ID进程句柄 失败返回NULL</span></span></span><br></pre></td></tr></table></figure>

<p>成功打开一个进程句柄大致进程对象引用计数加1，不需要时用<code>CloseHandle</code>关闭。</p>
<p>dwDesiredAccess指定访问权限，常用的有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>允许的操作</th>
</tr>
</thead>
<tbody><tr>
<td>PROCESS_QUERY_INFORMATION</td>
<td>获取进程相关信息，如访问令牌、退出码、进程优先级</td>
</tr>
<tr>
<td>PROCESS_SET_INFORMATION</td>
<td>设置进程相关信息，如进程优先级</td>
</tr>
<tr>
<td>PROCESS_SUSPEND_RESUME</td>
<td>挂起或恢复进程</td>
</tr>
<tr>
<td>PROCESS_TERMINATE</td>
<td>用<code>TerminateProcess</code>终止进程</td>
</tr>
<tr>
<td>PROCESS_DUP_HANDLE</td>
<td>用<code>DuplicateHandle</code>复制句柄</td>
</tr>
<tr>
<td>PROCESS_VM_OPERATION</td>
<td>修改进程地址空间，如写入内存、修改页面保护属性</td>
</tr>
<tr>
<td>PROCESS_VM_READ</td>
<td>对进程地址空间读取</td>
</tr>
<tr>
<td>PROCESS_VM_WRITE</td>
<td>对进程地址空间写入</td>
</tr>
<tr>
<td>PROCESS_CREATE_PROCESS</td>
<td>创建进程</td>
</tr>
<tr>
<td>PROCESS_CREATE_THREAD</td>
<td>创建线程</td>
</tr>
<tr>
<td>SYNCHRONIZE</td>
<td>调用等待函数等待进程终止</td>
</tr>
<tr>
<td>PROCESS_ALL_ACCESS</td>
<td>所有可能的访问权限</td>
</tr>
</tbody></table>
<p>当打开系统空闲进程或csrss等系统关键进程，函数调用也失败。</p>
<h3 id="GetProcessIdOfThread"><a href="#GetProcessIdOfThread" class="headerlink" title="GetProcessIdOfThread"></a>GetProcessIdOfThread</h3><p>根据线程句柄获取所在进程的ID：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">GetProcessIdOfThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hThread</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="DuplicateHandle"><a href="#DuplicateHandle" class="headerlink" title="DuplicateHandle"></a>DuplicateHandle</h3><p>复制内核对象句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">DuplicateHandle</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hSourceProcessHandle, <span class="comment">//源进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hSourceHandle, <span class="comment">//源进程中源内核对象句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hTargetProcessHandle, <span class="comment">//目标进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPHANDLE lpTargetHandle, <span class="comment">//目标内核对象句柄指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwDesiredAccess, <span class="comment">//新句柄访问权限 可0</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL bInheritHandle, <span class="comment">//新句柄是否可被目标进程的子进程继承 通常TRUE</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwOptions <span class="comment">//操作选项 可0</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>dwOptions有组合：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>DUPLICATE_CLOSE_SOURCE</td>
<td>复制后关闭源句柄，内核对象引用计数不变</td>
</tr>
<tr>
<td>DUPLICATE_SAME_ACCESS</td>
<td>复制访问权限，忽略dwDesiredAccess参数</td>
</tr>
</tbody></table>
<p>可以用于32位和64位进程之间复制句柄。</p>
<h2 id="进程终止"><a href="#进程终止" class="headerlink" title="进程终止"></a>进程终止</h2><h3 id="ExitProcess"><a href="#ExitProcess" class="headerlink" title="ExitProcess"></a>ExitProcess</h3><p>终止调用进程及其所有线程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID WINAPI <span class="title">ExitProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uExitCode <span class="comment">//进程和所有线程的退出码</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>该函数不返回，因为进程已终止。</p>
<h3 id="TerminateProcess"><a href="#TerminateProcess" class="headerlink" title="TerminateProcess"></a>TerminateProcess</h3><p>无条件终止调用进程或其他进程及其所有线程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">TerminateProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uExitCode <span class="comment">//进程和所有线程的退出码</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>其中hProcess需要对该进程的PROCESS_TERMINATE访问权限。</p>
<h3 id="GetExitCodeProcess"><a href="#GetExitCodeProcess" class="headerlink" title="GetExitCodeProcess"></a>GetExitCodeProcess</h3><p>获取一个进程的退出码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">GetExitCodeProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPDWORD lpExitCode <span class="comment">//返回进程退出码</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>其中hProcess需要对该进程的PROCESS_QUERY_INFORMATION访问权限。</p>
<p>该函数立即返回，当进程尚未终止时退出码为STILL_ACTIVE。</p>
<h2 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h2><h3 id="WM-COPYDATA法"><a href="#WM-COPYDATA法" class="headerlink" title="WM_COPYDATA法"></a>WM_COPYDATA法</h3><p>注意<code>SendMessage</code>将指定消息发送到若干个窗口，直到窗口过程处理完消息后函数才返回。<code>PostMessage</code>将消息投递到一个线程的消息队列后立即返回，由线程分发。注意<code>PostMessage</code>、<code>SendNotifyMessage</code>、<code>SendMessageCallback</code>的wParam和lParam参数不能传递指针，这些函数立即返回后指针指向的内存会被释放，<code>GetLastError</code>返回ERROR_MESSAGE_SYNC_ONLY。</p>
<p>用<code>SendMessage</code>、<code>SendNotifyMessage</code>、<code>SendMessageCallback</code>、<code>PostMessage</code>、<code>PostThreadMessage</code>发送WM_COPYDATA消息，wParam为目标进程窗口句柄，lParam为指向COPYDATASTRUCT结构的指针，目标进程窗口过程处理完WM_COPYDATA后应返回TRUE。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tagCOPYDATASTRUCT</span> &#123;</span><br><span class="line">    ULONG_PTR dwData; <span class="comment">//传递给目标进程的数据</span></span><br><span class="line">    DWORD cbData; <span class="comment">//lpData指向数据的大小 单位字节</span></span><br><span class="line">    _Field_size_bytes_(cbData) PVOID lpData; <span class="comment">//传递给目标进程的数据指针 可NULL</span></span><br><span class="line">&#125; COPYDATASTRUCT, * PCOPYDATASTRUCT;</span><br></pre></td></tr></table></figure>

<p>对于lpData，目标进程不可以修改共享内存数据v，应提前把数据v复制到自己所属进程的缓冲区中。</p>
<h4 id="FindWindow"><a href="#FindWindow" class="headerlink" title="FindWindow"></a>FindWindow</h4><p>查找具有指定窗口类名和窗口标题的窗口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HWND WINAPI <span class="title">FindWindow</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpClassName, <span class="comment">//窗口类名</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpWindowName <span class="comment">//窗口标题</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">//成功返回句柄 失败返回NULL</span></span></span><br></pre></td></tr></table></figure>

<p>参数不区分大小写。</p>
<p>lpClassName可以是用<code>RegisterClass</code>或<code>RegisterClassEx</code>注册的窗口类名称，也可以是任何预定义的控件类名称，如对话框窗口类名为#32770。</p>
<h4 id="StringCchPrintf"><a href="#StringCchPrintf" class="headerlink" title="StringCchPrintf"></a>StringCchPrintf</h4><p>微软建议使用的格式化字符串，之前学了这里不讲：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">StringCchPrintf</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPTSTR pszDest, <span class="comment">//目标缓冲区 以0结尾</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T cchDest, <span class="comment">//pszDest大小 单位字符 最大STRSAFE_MAX_CCH</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCTSTR pszFormat, <span class="comment">//格式字符串</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ...</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>发送方：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DataStructure.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    COPYDATASTRUCT cds = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PersonStruct ps = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ScoreStruct ss = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szBuf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    HWND hwndTarget;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_PERSON: &#123;</span><br><span class="line">                    <span class="comment">// 查找具有指定类名和窗口名的窗口的窗口句柄</span></span><br><span class="line">                    hwndTarget = <span class="built_in">FindWindow</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#32770&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;接收数据&quot;</span>));</span><br><span class="line">                    <span class="keyword">if</span> (hwndTarget) &#123;</span><br><span class="line">                        <span class="comment">// 获取姓名、年龄、存款</span></span><br><span class="line">                        <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_NAME, ps.m_szName, _countof(ps.m_szName));</span><br><span class="line">                        ps.m_nAge = <span class="built_in">GetDlgItemInt</span>(hwndDlg, IDC_EDIT_AGE, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">                        <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_MONEY, szBuf, _countof(szBuf));</span><br><span class="line">                        ps.m_dMoney = _ttof(szBuf);</span><br><span class="line">                        <span class="comment">// 发送WM_COPYDATA消息</span></span><br><span class="line">                        cds.dwData = PERSONDATA;</span><br><span class="line">                        cds.cbData = <span class="built_in">sizeof</span>(PersonStruct);</span><br><span class="line">                        cds.lpData = &amp;ps;</span><br><span class="line">                        <span class="built_in">SendMessage</span>(hwndTarget, WM_COPYDATA, (WPARAM)hwndTarget, (LPARAM)&amp;cds);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_SCORE: &#123;</span><br><span class="line">                    <span class="comment">// 查找具有指定类名和窗口名的窗口的窗口句柄</span></span><br><span class="line">                    hwndTarget = <span class="built_in">FindWindow</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#32770&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;接收数据&quot;</span>));</span><br><span class="line">                    <span class="keyword">if</span> (hwndTarget) &#123;</span><br><span class="line">                        <span class="comment">// 获取语文、数学、英语成绩</span></span><br><span class="line">                        <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_CHINESE, szBuf, _countof(szBuf));</span><br><span class="line">                        ss.m_dChinese = _ttof(szBuf);</span><br><span class="line">                        <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_MATH, szBuf, _countof(szBuf));</span><br><span class="line">                        ss.m_dMath = _ttof(szBuf);</span><br><span class="line">                        <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_ENGLISH, szBuf, _countof(szBuf));</span><br><span class="line">                        ss.m_dEnglish = _ttof(szBuf);</span><br><span class="line">                        <span class="comment">// 发送WM_COPYDATA消息</span></span><br><span class="line">                        cds.dwData = SCOREDATA;</span><br><span class="line">                        cds.cbData = <span class="built_in">sizeof</span>(ScoreStruct);</span><br><span class="line">                        cds.lpData = &amp;ss;</span><br><span class="line">                        <span class="built_in">SendMessage</span>(hwndTarget, WM_COPYDATA, (WPARAM)hwndTarget, (LPARAM)&amp;cds);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接收方：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../CopyDataDemo/DataStructure.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    PCOPYDATASTRUCT pCDS;</span><br><span class="line">    PPersonStruct pPS;</span><br><span class="line">    PScoreStruct pSS;</span><br><span class="line">    TCHAR szBuf[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COPYDATA: &#123;</span><br><span class="line">            pCDS = (PCOPYDATASTRUCT)lParam;</span><br><span class="line">            <span class="keyword">if</span> (pCDS-&gt;dwData == PERSONDATA) &#123;</span><br><span class="line">                pPS = (PPersonStruct)(pCDS-&gt;lpData);</span><br><span class="line">                <span class="built_in">StringCchPrintf</span>(szBuf, _countof(szBuf), <span class="built_in">TEXT</span>(<span class="string">&quot;个人信息：\n姓名：%s\n年龄：%d\n存款：%.2lf&quot;</span>), pPS-&gt;m_szName, pPS-&gt;m_nAge, pPS-&gt;m_dMoney);</span><br><span class="line">                <span class="built_in">MessageBox</span>(hwndDlg, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;个人信息&quot;</span>), MB_OK);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (pCDS-&gt;dwData == SCOREDATA) &#123;</span><br><span class="line">                pSS = (PScoreStruct)pCDS-&gt;lpData;</span><br><span class="line">                <span class="built_in">StringCchPrintf</span>(szBuf, _countof(szBuf), <span class="built_in">TEXT</span>(<span class="string">&quot;考试成绩：\n语文：%6.2lf\n数学：%6.2lf\n英语：%6.2lf&quot;</span>), pSS-&gt;m_dChinese, pSS-&gt;m_dMath, pSS-&gt;m_dEnglish);</span><br><span class="line">                <span class="built_in">MessageBox</span>(hwndDlg, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;考试成绩&quot;</span>), MB_OK);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>数据结构定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 常量定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PERSONDATA  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCOREDATA   2</span></span><br><span class="line"><span class="comment">// 数据结构定义</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PersonStruct</span>&#123;</span><br><span class="line">    TCHAR   m_szName[<span class="number">32</span>];   <span class="comment">// 姓名</span></span><br><span class="line">    <span class="type">int</span>     m_nAge;         <span class="comment">// 年龄</span></span><br><span class="line">    <span class="type">double</span>  m_dMoney;       <span class="comment">// 存款</span></span><br><span class="line">&#125;PersonStruct, *PPersonStruct;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_ScoreStruct</span>&#123;</span><br><span class="line">    <span class="type">double</span>  m_dChinese;     <span class="comment">// 语文</span></span><br><span class="line">    <span class="type">double</span>  m_dMath;        <span class="comment">// 数学</span></span><br><span class="line">    <span class="type">double</span>  m_dEnglish;     <span class="comment">// 英语</span></span><br><span class="line">&#125;ScoreStruct, *PScoreStruct;</span><br></pre></td></tr></table></figure>

<h3 id="匿名管道法"><a href="#匿名管道法" class="headerlink" title="匿名管道法"></a>匿名管道法</h3><h4 id="CreatePipe"><a href="#CreatePipe" class="headerlink" title="CreatePipe"></a>CreatePipe</h4><p>创建一个匿名管道：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">CreatePipe</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PHANDLE hReadPipe, <span class="comment">//读取句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PHANDLE hWritePipe, <span class="comment">//写入句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpPipeAttributes, <span class="comment">//安全属性结构</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD nSize <span class="comment">//管道缓冲区大小 单位字节 0表示默认大小</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>管道读写用<code>WriteFile</code>和<code>ReadFile</code>，句柄hReadPipe和hWritePipe需要用<code>CloseHandle</code>关闭。因为用于父进程与子进程之间传输数据，创建匿名管道时lpPipeAttributes要设置为可继承，如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HANDLE hReadPipe, hWritePipe;</span><br><span class="line">SECURITY_ATTRIBUTES sa = &#123; <span class="built_in">sizeof</span>(sa) &#125;;</span><br><span class="line">sa.bInheritHandle = TRUE;</span><br><span class="line"><span class="built_in">CreatePipe</span>(&amp;hReadPipe, &amp;hWritePipe, &amp;sa, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h4 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 常量定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE    1024</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HWND g_hwndDlg;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 线程函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="comment">// 初始化编辑控件</span></span><br><span class="line">            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_URL, <span class="built_in">TEXT</span>(<span class="string">&quot;www.baidu.com&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_PING: &#123;</span><br><span class="line">                    <span class="comment">// 创建线程</span></span><br><span class="line">                    <span class="keyword">if</span> ((hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">                        <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建匿名管道</span></span><br><span class="line">    HANDLE hReadPipe, hWritePipe;</span><br><span class="line">    SECURITY_ATTRIBUTES sa = &#123; <span class="built_in">sizeof</span>(sa) &#125;;</span><br><span class="line">    sa.bInheritHandle = TRUE;</span><br><span class="line">    <span class="built_in">CreatePipe</span>(&amp;hReadPipe, &amp;hWritePipe, &amp;sa, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 创建子进程，把子进程Ping的输出重定向到匿名管道的写入句柄</span></span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(si) &#125;;</span><br><span class="line">    si.dwFlags = STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW;</span><br><span class="line">    si.hStdOutput = si.hStdError = hWritePipe;</span><br><span class="line">    si.wShowWindow = SW_HIDE;</span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line">    <span class="comment">// 命令行参数拼接为：Ping www.baidu.com的形式</span></span><br><span class="line">    TCHAR szCommandLine[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;Ping &quot;</span>);</span><br><span class="line">    TCHAR szURL[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">GetDlgItemText</span>(g_hwndDlg, IDC_EDIT_URL, szURL, _countof(szURL));</span><br><span class="line">    <span class="built_in">StringCchCat</span>(szCommandLine, _countof(szCommandLine), szURL);</span><br><span class="line">    <span class="comment">// 创建Ping子进程</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi)) &#123;</span><br><span class="line">        CHAR szBuf[BUF_SIZE + <span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        CHAR szOutput[BUF_SIZE * <span class="number">8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        DWORD dwNumOfBytesRead;</span><br><span class="line">        <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">        <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">            <span class="comment">// 读取匿名管道的读取句柄</span></span><br><span class="line">            <span class="built_in">ZeroMemory</span>(szBuf, <span class="built_in">sizeof</span>(szBuf));</span><br><span class="line">            <span class="built_in">ReadFile</span>(hReadPipe, szBuf, BUF_SIZE, &amp;dwNumOfBytesRead, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (dwNumOfBytesRead == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// Ping控制台的输出是ANSI编码，因此使用StringCchCatA和SetDlgItemTextA</span></span><br><span class="line">            <span class="comment">// 把读取到的数据追加到szOutput缓冲区</span></span><br><span class="line">            <span class="built_in">StringCchCatA</span>(szOutput, _countof(szOutput), szBuf);</span><br><span class="line">            <span class="comment">// 显示到编辑控件中</span></span><br><span class="line">            <span class="built_in">SetDlgItemTextA</span>(g_hwndDlg, IDC_EDIT_CONTENT, szOutput);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hReadPipe);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hWritePipe);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="命名管道法"><a href="#命名管道法" class="headerlink" title="命名管道法"></a>命名管道法</h3><p>略。</p>
<h3 id="邮件槽法"><a href="#邮件槽法" class="headerlink" title="邮件槽法"></a>邮件槽法</h3><p>邮件槽是一种进程间单向通信机制，创建并拥有邮件槽的进程称为邮件槽服务器，邮件槽服务器从邮件槽中读取数据，其他进程可打开邮件槽并写入数据，这些进程称为邮件槽客户端。</p>
<h4 id="CreateMailslot"><a href="#CreateMailslot" class="headerlink" title="CreateMailslot"></a>CreateMailslot</h4><p>创建一个指定名称的邮件槽内核对象：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE WINAPI <span class="title">CreateMailslot</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCTSTR lpName, <span class="comment">//邮件槽名称 格式&quot;\\.\mailslot\邮件槽名&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD nMaxMessageSize, <span class="comment">//可写入邮件槽的单条消息最大大小 单位字节 0任意大小</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD lReadTimeout, <span class="comment">//等待写入邮件槽的时间 单位毫秒 MAILSLOT_WAIT_FOREVER一直等待可读取的消息</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPSECURITY_ATTRIBUTES lpSecurityAttributes <span class="comment">//安全属性结构</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">//成功返回邮件槽句柄 失败返回INVALID_HANDLE_VALUE</span></span></span><br></pre></td></tr></table></figure>

<p>指定名称邮件槽已存在时<code>GetLastError</code>返回ERROR_ALREADY_EXISTS。</p>
<p>用<code>CreateFile</code>打开邮件槽，用<code>WriteFile</code>向邮件槽写入数据，用<code>ReadFile</code>读取数据。读取数据前应用<code>GetMailslotInfo</code>确定邮件槽中是否由消息。不需要读写数据时用<code>CloseHandle</code>关闭邮件槽句柄。</p>
<h4 id="GetMailslotInfo"><a href="#GetMailslotInfo" class="headerlink" title="GetMailslotInfo"></a>GetMailslotInfo</h4><p>确定邮件槽中是否有消息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">GetMailslotInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hMailslot, <span class="comment">//邮件槽句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpMaxMessageSize, <span class="comment">//单条消息最大大小 单位字节</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpNextSize, <span class="comment">//下一条待读取消息大小 单位字节 MAILSLOT_NO_MESSAGE没有待读取消息</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpMessageCount, <span class="comment">//待读取消息总数量</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpReadTimeout <span class="comment">//读取操作可等待时间 单位毫秒</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h4><p>服务端：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    TCHAR szMailslotName[] = <span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\mailslot\\99F1755D-31FD-4CE5-8183-3F438316E8D7&quot;</span>);</span><br><span class="line">    <span class="type">static</span> HANDLE hMailslot;</span><br><span class="line">    DWORD dwNextSize, dwMessageCount, dwNumOfBytesRead;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            <span class="comment">// 创建邮件槽</span></span><br><span class="line">            hMailslot = <span class="built_in">CreateMailslot</span>(szMailslotName, <span class="number">0</span>, MAILSLOT_WAIT_FOREVER, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (hMailslot == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">GetLastError</span>() == ERROR_ALREADY_EXISTS)</span><br><span class="line">                    <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;指定名称的邮件槽已经存在&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;CreateMailslot函数调用失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                <span class="built_in">ExitProcess</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 创建计时器</span></span><br><span class="line">            <span class="built_in">SetTimer</span>(hwndDlg, <span class="number">1</span>, <span class="number">1000</span>, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_TIMER: &#123;</span><br><span class="line">            <span class="comment">// 在调用ReadFile函数读取数据以前，先调用GetMailslotInfo函数来确定邮件槽中是否有消息</span></span><br><span class="line">            <span class="built_in">GetMailslotInfo</span>(hMailslot, <span class="literal">NULL</span>, &amp;dwNextSize, &amp;dwMessageCount, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwMessageCount; i++) &#123;</span><br><span class="line">                LPBYTE lpBuf = <span class="keyword">new</span> BYTE[dwNextSize];</span><br><span class="line">                <span class="built_in">ZeroMemory</span>(lpBuf, dwNextSize);</span><br><span class="line">                <span class="built_in">ReadFile</span>(hMailslot, lpBuf, dwNextSize, &amp;dwNumOfBytesRead, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_LIST_MSG), LB_ADDSTRING, <span class="number">0</span>, (LPARAM)(LPTSTR)lpBuf);</span><br><span class="line">                <span class="keyword">delete</span>[]lpBuf;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">CloseHandle</span>(hMailslot);</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>客户端：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    TCHAR szMailslotName[] = <span class="built_in">TEXT</span>(<span class="string">&quot;\\\\.\\mailslot\\99F1755D-31FD-4CE5-8183-3F438316E8D7&quot;</span>);</span><br><span class="line">    HANDLE hMailslot;</span><br><span class="line">    TCHAR szBuf[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_SEND: &#123;</span><br><span class="line">                    <span class="comment">// 打开邮槽</span></span><br><span class="line">                    hMailslot = <span class="built_in">CreateFile</span>(szMailslotName, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                    <span class="keyword">if</span> (hMailslot != INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">                        <span class="comment">// 写入数据</span></span><br><span class="line">                        n = <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_MSG, szBuf, _countof(szBuf));</span><br><span class="line">                        <span class="built_in">WriteFile</span>(hMailslot, szBuf, (n + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR), <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                        <span class="built_in">CloseHandle</span>(hMailslot);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="进程枚举"><a href="#进程枚举" class="headerlink" title="进程枚举"></a>进程枚举</h2><h3 id="TlHelp32法"><a href="#TlHelp32法" class="headerlink" title="TlHelp32法"></a>TlHelp32法</h3><h4 id="CreateToolhelp32Snapshot"><a href="#CreateToolhelp32Snapshot" class="headerlink" title="CreateToolhelp32Snapshot"></a>CreateToolhelp32Snapshot</h4><p>捕获系统中当前正在运行的所有进程的快照，得到一个进程列表：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE WINAPI <span class="title">CreateToolhelp32Snapshot</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwFlags, <span class="comment">//标志</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD th32ProcessID <span class="comment">//进程ID 0表示当前ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>dwFlags可以是组合：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>枚举对象</th>
</tr>
</thead>
<tbody><tr>
<td>TH32CS_SNAPPROCESS</td>
<td>系统所有进程，忽略th32ProcessID</td>
</tr>
<tr>
<td>TH32CS_SNAPTHREAD</td>
<td>系统所有线程，忽略th32ProcessID</td>
</tr>
<tr>
<td>TH32CS_SNAPHEAPLIST</td>
<td>th32ProcessID指定进程中所有堆</td>
</tr>
<tr>
<td>TH32CS_SNAPMODULE</td>
<td>th32ProcessID指定进程中所有模块</td>
</tr>
<tr>
<td>TH32CS_SNAPMODULE32</td>
<td>64位进程中32位模块</td>
</tr>
<tr>
<td>TH32CS_SNAPALL</td>
<td>上面所有</td>
</tr>
<tr>
<td>TH32CS_INHERIT</td>
<td>快照句柄可继承</td>
</tr>
</tbody></table>
<h4 id="Process32First-Process32Next"><a href="#Process32First-Process32Next" class="headerlink" title="Process32First&#x2F;Process32Next"></a>Process32First&#x2F;Process32Next</h4><p>获取快照中第一个&#x2F;其他进程信息，直到<code>Process32Next</code>返回FALSE：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">Process32First</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hSnapshot, <span class="comment">//快照句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPPROCESSENTRY32 lppe <span class="comment">//返回进程信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">Process32Next</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hSnapshot,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPPROCESSENTRY32 lppe</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中PROCESSENTRY32结构为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">tagPROCESSENTRY32</span> &#123;</span><br><span class="line">    DWORD   dwSize; <span class="comment">//该结构大小</span></span><br><span class="line">    DWORD   cntUsage; <span class="comment">//0</span></span><br><span class="line">    DWORD   th32ProcessID; <span class="comment">//进程ID</span></span><br><span class="line">    ULONG_PTR th32DefaultHeapID; <span class="comment">//0</span></span><br><span class="line">    DWORD   th32ModuleID; <span class="comment">//0</span></span><br><span class="line">    DWORD   cntThreads; <span class="comment">//进程启动的线程个数</span></span><br><span class="line">    DWORD   th32ParentProcessID; <span class="comment">//进程的父进程ID</span></span><br><span class="line">    LONG    pcPriClassBase; <span class="comment">//进程创建的线程的基本优先级</span></span><br><span class="line">    DWORD   dwFlags; <span class="comment">//0</span></span><br><span class="line">    CHAR    szExeFile[MAX_PATH]; <span class="comment">//进程的可执行文件名称</span></span><br><span class="line">&#125; PROCESSENTRY32;</span><br></pre></td></tr></table></figure>

<p>szExeFile返回的只是文件名不带路径。</p>
<h4 id="QueryFullProcessImageName"><a href="#QueryFullProcessImageName" class="headerlink" title="QueryFullProcessImageName"></a>QueryFullProcessImageName</h4><p>获取一个进程对应可执行文件的完整路径：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">QueryFullProcessImageName</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwFlags, <span class="comment">//返回路径格式</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPTSTR lpExeName, <span class="comment">//返回可执行文件路径的缓冲区</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PDWORD lpdwSize <span class="comment">//缓冲区大小 单位字符 不含终止空字符</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>dwFlags一般为0，表示普通格式，设置为PROCESS_NAME_NATIVE表示本机系统路径格式，如\Device\HarddiskVolumn3\Windows\System32\svchost.exe。</p>
<p>还有一种更高效的替代方法：用<code>GetModuleFileNameEx</code>，hModule为NULL表示获取hProcess进程的可执行文件完整路径。</p>
<h4 id="OpenProcessToken"><a href="#OpenProcessToken" class="headerlink" title="OpenProcessToken"></a>OpenProcessToken</h4><p>打开与进程关联的访问令牌以获得一个访问令牌句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">OpenProcessToken</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE ProcessHandle, <span class="comment">//进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD DesiredAccess, <span class="comment">//请求的访问令牌访问类型 可TOKEN_ALL_ACCESS</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Outptr_ PHANDLE TokenHandle <span class="comment">//返回ProcessHandle进程关联的访问令牌句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>不用时用<code>CloseHandle</code>关闭。</p>
<h4 id="LookupPrivilegeValue"><a href="#LookupPrivilegeValue" class="headerlink" title="LookupPrivilegeValue"></a>LookupPrivilegeValue</h4><p>获取指定特权名称在系统中的本地唯一标识符LUID：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">LookupPrivilegeValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPCTSTR lpSystemName, <span class="comment">//系统名称 本地系统NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCTSTR lpName, <span class="comment">//特权名称 如调试权限SE_DEBUG_NAME</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PLUID lpLuid <span class="comment">//返回lpName在lpSystemName系统中LUID</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="AdjustTokenPrivileges"><a href="#AdjustTokenPrivileges" class="headerlink" title="AdjustTokenPrivileges"></a>AdjustTokenPrivileges</h4><p>启用访问令牌句柄中指定的特权名称：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">AdjustTokenPrivileges</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE TokenHandle, <span class="comment">//进程访问令牌句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL DisableAllPrivileges, <span class="comment">//是否禁用所有特权 一般FALSE</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PTOKEN_PRIVILEGES NewState,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD BufferLength, <span class="comment">//PreviousState缓冲区大小 单位字节</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PTOKEN_PRIVILEGES PreviousState, <span class="comment">//返回进程的先前特权状态</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PDWORD ReturnLength <span class="comment">//返回PreviousState参数所需缓冲区大小</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>其中TOKEN_PRIVILEGES结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TOKEN_PRIVILEGES</span> &#123;</span><br><span class="line">    DWORD PrivilegeCount; <span class="comment">//Privileges数组元素个数</span></span><br><span class="line">    LUID_AND_ATTRIBUTES Privileges[ANYSIZE_ARRAY];</span><br><span class="line">&#125; TOKEN_PRIVILEGES, *PTOKEN_PRIVILEGES;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LUID_AND_ATTRIBUTES</span> &#123;</span><br><span class="line">    LUID Luid; <span class="comment">//代表特权名称的LUID</span></span><br><span class="line">    DWORD Attributes; <span class="comment">//启用SE_PRIVILEGE_ENABLE 移除SE_PRIVILEGE_REMOVED 禁用None</span></span><br><span class="line">&#125; LUID_AND_ATTRIBUTES, * PLUID_AND_ATTRIBUTES;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ANYSIZE_ARRAY 1</span></span><br></pre></td></tr></table></figure>

<h4 id="例子-3"><a href="#例子-3" class="headerlink" title="例子"></a>例子</h4><p>注意Windows中不存在暂停和恢复进程的概念，暂停一个进程中所有线程时，指定TH32CS_SNAPTHREAD标志获取线程列表，并改用<code>Thread32First</code>和<code>Thread32Next</code>枚举。同理枚举模块时指定TH32CS_SNAPMODULE并使用<code>Module32First</code>和<code>Module32Next</code>，枚举堆时指定TH32CS_SNAPHEAPLIST并使用<code>Heap32First</code>he<code>Heap32Next</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Commctrl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Psapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Comctl32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;\&quot;/manifestdependency:type=&#x27;win32&#x27; name=&#x27;Microsoft.Windows.Common-Controls&#x27; version=&#x27;6.0.0.0&#x27; processorArchitecture=&#x27;*&#x27; publicKeyToken=&#x27;6595b64144ccf1df&#x27; language=&#x27;*&#x27;\&quot;&quot;</span>)</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hInstance;</span><br><span class="line">HWND g_hwndDlg;                 <span class="comment">// 对话框窗口句柄</span></span><br><span class="line">HIMAGELIST g_hImagListSmall;    <span class="comment">// 列表视图控件所用的图像列表</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 显示进程列表</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetProcessList</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 提升本进程的权限</span></span><br><span class="line"><span class="function">BOOL <span class="title">AdjustPrivileges</span><span class="params">(HANDLE hProcess, LPCTSTR lpPrivilegeName = SE_DEBUG_NAME)</span></span>;</span><br><span class="line"><span class="comment">// 暂停、恢复进程</span></span><br><span class="line"><span class="function">VOID <span class="title">SuspendProcess</span><span class="params">(DWORD dwProcessId, BOOL bSuspend)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    g_hInstance = hInstance;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>&#123;</span><br><span class="line">    LVCOLUMN lvc = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    POINT pt = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">int</span> nSelected, nRet;</span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szProcessName[MAX_PATH] = &#123; <span class="number">0</span> &#125;, szProcessID[<span class="number">16</span>] = &#123; <span class="number">0</span> &#125;, szBuf[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    HANDLE hProcess;</span><br><span class="line">    HMENU hMenu;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg)&#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="comment">// 设置列表视图控件的扩展样式</span></span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_LIST_PROCESS), LVM_SETEXTENDEDLISTVIEWSTYLE, <span class="number">0</span>, LVS_EX_FULLROWSELECT | LVS_EX_GRIDLINES);</span><br><span class="line">            <span class="comment">// 设置列标题：进程名称、进程ID、父进程ID、可执行文件路径</span></span><br><span class="line">            lvc.mask = LVCF_SUBITEM | LVCF_WIDTH | LVCF_TEXT;</span><br><span class="line">            lvc.iSubItem = <span class="number">0</span>; lvc.cx = <span class="number">150</span>; lvc.pszText = <span class="built_in">TEXT</span>(<span class="string">&quot;进程名称&quot;</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_LIST_PROCESS), LVM_INSERTCOLUMN, <span class="number">0</span>, (LPARAM)&amp;lvc);</span><br><span class="line">            lvc.iSubItem = <span class="number">1</span>; lvc.cx = <span class="number">60</span>; lvc.pszText = <span class="built_in">TEXT</span>(<span class="string">&quot;进程ID&quot;</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_LIST_PROCESS), LVM_INSERTCOLUMN, <span class="number">1</span>, (LPARAM)&amp;lvc);</span><br><span class="line">            lvc.iSubItem = <span class="number">2</span>; lvc.cx = <span class="number">60</span>; lvc.pszText = <span class="built_in">TEXT</span>(<span class="string">&quot;父进程ID&quot;</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_LIST_PROCESS), LVM_INSERTCOLUMN, <span class="number">2</span>, (LPARAM)&amp;lvc);</span><br><span class="line">            lvc.iSubItem = <span class="number">3</span>; lvc.cx = <span class="number">260</span>; lvc.pszText = <span class="built_in">TEXT</span>(<span class="string">&quot;可执行文件路径&quot;</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_LIST_PROCESS), LVM_INSERTCOLUMN, <span class="number">3</span>, (LPARAM)&amp;lvc);</span><br><span class="line">            <span class="comment">// 为列表视图控件设置图像列表</span></span><br><span class="line">            g_hImagListSmall = <span class="built_in">ImageList_Create</span>(<span class="built_in">GetSystemMetrics</span>(SM_CXSMICON), <span class="built_in">GetSystemMetrics</span>(SM_CYSMICON), ILC_MASK | ILC_COLOR32, <span class="number">500</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_SETIMAGELIST, LVSIL_SMALL, (LPARAM)g_hImagListSmall);</span><br><span class="line">            <span class="comment">// 提升本进程的权限</span></span><br><span class="line">            <span class="built_in">AdjustPrivileges</span>(<span class="built_in">GetCurrentProcess</span>());</span><br><span class="line">            <span class="comment">// 显示进程列表</span></span><br><span class="line">            <span class="built_in">GetProcessList</span>();</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> ID_REFRESH: &#123;</span><br><span class="line">                    <span class="comment">// 显示进程列表</span></span><br><span class="line">                    <span class="built_in">GetProcessList</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> ID_TERMINATE: &#123;</span><br><span class="line">                    <span class="comment">// 结束选定进程</span></span><br><span class="line">                    nSelected = <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="comment">// 确定要结束进程吗？</span></span><br><span class="line">                    lvi.iItem = nSelected; lvi.iSubItem = <span class="number">0</span>;</span><br><span class="line">                    lvi.mask = LVIF_TEXT;</span><br><span class="line">                    lvi.pszText = szProcessName;</span><br><span class="line">                    lvi.cchTextMax = _countof(szProcessName);</span><br><span class="line">                    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">                    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;确定要结束 %s 进程吗？&quot;</span>), lvi.pszText);</span><br><span class="line">                    nRet = <span class="built_in">MessageBox</span>(hwndDlg, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;结束进程&quot;</span>), MB_OKCANCEL | MB_ICONINFORMATION | MB_DEFBUTTON2);</span><br><span class="line">                    <span class="keyword">if</span> (nRet == IDCANCEL)</span><br><span class="line">                        <span class="keyword">return</span> FALSE;</span><br><span class="line">                    <span class="comment">// 获取进程句柄</span></span><br><span class="line">                    lvi.iSubItem = <span class="number">1</span>;</span><br><span class="line">                    lvi.pszText = szProcessID;</span><br><span class="line">                    lvi.cchTextMax = _countof(szProcessID);</span><br><span class="line">                    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">                    hProcess = <span class="built_in">OpenProcess</span>(PROCESS_TERMINATE, FALSE, _ttoi(lvi.pszText));</span><br><span class="line">                    <span class="keyword">if</span> (hProcess) &#123;</span><br><span class="line">                        <span class="comment">// 结束进程</span></span><br><span class="line">                        bRet = <span class="built_in">TerminateProcess</span>(hProcess, <span class="number">0</span>);</span><br><span class="line">                        <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">if</span> (!bRet) &#123;</span><br><span class="line">                        <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;结束 %s 进程失败&quot;</span>), szProcessName);</span><br><span class="line">                        <span class="built_in">MessageBox</span>(hwndDlg, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">// 删除列表项</span></span><br><span class="line">                        <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_DELETEITEM, nSelected, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> ID_OPEN: &#123;</span><br><span class="line">                    <span class="comment">// 打开文件所在位置</span></span><br><span class="line">                    nSelected = <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    lvi.iItem = nSelected; lvi.iSubItem = <span class="number">3</span>;</span><br><span class="line">                    lvi.mask = LVIF_TEXT;</span><br><span class="line">                    lvi.pszText = szProcessName;</span><br><span class="line">                    lvi.cchTextMax = _countof(szProcessName);</span><br><span class="line">                    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">                    <span class="comment">// 打开父目录并选定指定文件的命令：Explorer.exe /select,文件名称</span></span><br><span class="line">                    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;/select,%s&quot;</span>), lvi.pszText);</span><br><span class="line">                    <span class="built_in">ShellExecute</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;open&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;Explorer.exe&quot;</span>), szBuf, <span class="literal">NULL</span>, SW_SHOW);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> ID_SUSPEND: &#123;</span><br><span class="line">                    <span class="comment">// 暂停进程</span></span><br><span class="line">                    nSelected = <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    lvi.iItem = nSelected; lvi.iSubItem = <span class="number">1</span>;</span><br><span class="line">                    lvi.mask = LVIF_TEXT;</span><br><span class="line">                    lvi.pszText = szProcessID;</span><br><span class="line">                    lvi.cchTextMax = _countof(szProcessID);</span><br><span class="line">                    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">                    <span class="built_in">SuspendProcess</span>(_ttoi(lvi.pszText), TRUE);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> ID_RESUME: &#123;</span><br><span class="line">                    <span class="comment">// 恢复进程</span></span><br><span class="line">                    nSelected = <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    lvi.iItem = nSelected; lvi.iSubItem = <span class="number">1</span>;</span><br><span class="line">                    lvi.mask = LVIF_TEXT;</span><br><span class="line">                    lvi.pszText = szProcessID;</span><br><span class="line">                    lvi.cchTextMax = _countof(szProcessID);</span><br><span class="line">                    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">                    <span class="built_in">SuspendProcess</span>(_ttoi(lvi.pszText), FALSE);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">ImageList_Destroy</span>(g_hImagListSmall);</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_NOTIFY: &#123;</span><br><span class="line">            <span class="keyword">if</span> (((LPNMHDR)lParam)-&gt;idFrom == IDC_LIST_PROCESS &amp;&amp; ((LPNMHDR)lParam)-&gt;code == NM_RCLICK) &#123;</span><br><span class="line">                <span class="keyword">if</span> (((LPNMITEMACTIVATE)lParam)-&gt;iItem &lt; <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> FALSE;</span><br><span class="line">                <span class="comment">// 如果可执行文件路径一列为空，则禁用结束该进程、打开文件所在位置、暂停进程、结束进程菜单</span></span><br><span class="line">                nSelected = <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETSELECTIONMARK, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                hMenu = <span class="built_in">LoadMenu</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDR_MENU));</span><br><span class="line">                lvi.iItem = nSelected; lvi.iSubItem = <span class="number">3</span>;</span><br><span class="line">                lvi.mask = LVIF_TEXT;</span><br><span class="line">                lvi.pszText = szProcessName;</span><br><span class="line">                lvi.cchTextMax = _countof(szProcessName);</span><br><span class="line">                <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">                <span class="keyword">if</span> (_tcsicmp(lvi.pszText, <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">EnableMenuItem</span>(hMenu, ID_TERMINATE, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">                    <span class="built_in">EnableMenuItem</span>(hMenu, ID_OPEN, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">                    <span class="built_in">EnableMenuItem</span>(hMenu, ID_SUSPEND, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">                    <span class="built_in">EnableMenuItem</span>(hMenu, ID_RESUME, MF_BYCOMMAND | MF_DISABLED);</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="comment">// 弹出快捷菜单</span></span><br><span class="line">                <span class="built_in">GetCursorPos</span>(&amp;pt);</span><br><span class="line">                <span class="built_in">TrackPopupMenu</span>(<span class="built_in">GetSubMenu</span>(hMenu, <span class="number">0</span>), TPM_LEFTALIGN | TPM_TOPALIGN, pt.x, pt.y, <span class="number">0</span>, hwndDlg, <span class="literal">NULL</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">GetProcessList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HANDLE hSnapshot;</span><br><span class="line">    PROCESSENTRY32 pe = &#123; <span class="built_in">sizeof</span>(PROCESSENTRY32) &#125;;</span><br><span class="line">    BOOL bRet;</span><br><span class="line">    HANDLE hProcess;</span><br><span class="line">    TCHAR szPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szBuf[<span class="number">16</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD dwLen;</span><br><span class="line">    SHFILEINFO fi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">int</span> nImage;</span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 删除图像列表中的所有图像</span></span><br><span class="line">    <span class="built_in">ImageList_Remove</span>(g_hImagListSmall, <span class="number">-1</span>);</span><br><span class="line">    <span class="comment">// 删除所有列表项</span></span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_DELETEALLITEMS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;CreateToolhelp32Snapshot函数调用失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    bRet = <span class="built_in">Process32First</span>(hSnapshot, &amp;pe);</span><br><span class="line">    <span class="keyword">while</span> (bRet) &#123;</span><br><span class="line">        nImage = <span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">ZeroMemory</span>(szPath, <span class="built_in">sizeof</span>(szPath));</span><br><span class="line">        hProcess = <span class="built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION, FALSE, pe.th32ProcessID);</span><br><span class="line">        <span class="keyword">if</span> (hProcess) &#123;</span><br><span class="line">            <span class="comment">// 获取可执行文件路径</span></span><br><span class="line">            dwLen = _countof(szPath);</span><br><span class="line">            <span class="built_in">QueryFullProcessImageName</span>(hProcess, <span class="number">0</span>, szPath, &amp;dwLen);</span><br><span class="line">            <span class="comment">// 获取程序图标</span></span><br><span class="line">            <span class="built_in">SHGetFileInfo</span>(szPath, <span class="number">0</span>, &amp;fi, <span class="built_in">sizeof</span>(SHFILEINFO), SHGFI_ICON | SHGFI_SMALLICON);</span><br><span class="line">            <span class="keyword">if</span> (fi.hIcon)</span><br><span class="line">                nImage = <span class="built_in">ImageList_AddIcon</span>(g_hImagListSmall, fi.hIcon);</span><br><span class="line">            <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">        &#125;;</span><br><span class="line">        lvi.mask = LVIF_TEXT | LVIF_IMAGE;</span><br><span class="line">        lvi.iItem = <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_GETITEMCOUNT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 第1列，进程名称</span></span><br><span class="line">        lvi.iSubItem = <span class="number">0</span>; lvi.pszText = pe.szExeFile; lvi.iImage = nImage;</span><br><span class="line">        <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_INSERTITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        <span class="keyword">if</span> (fi.hIcon)</span><br><span class="line">            <span class="built_in">DestroyIcon</span>(fi.hIcon);</span><br><span class="line">        <span class="comment">// 第2列，进程ID</span></span><br><span class="line">        lvi.mask = LVIF_TEXT;</span><br><span class="line">        lvi.iSubItem = <span class="number">1</span>; _itot_s(pe.th32ProcessID, szBuf, _countof(szBuf), <span class="number">10</span>); lvi.pszText = szBuf;</span><br><span class="line">        <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        <span class="comment">// 第3列，父进程ID</span></span><br><span class="line">        lvi.iSubItem = <span class="number">2</span>; _itot_s(pe.th32ParentProcessID, szBuf, _countof(szBuf), <span class="number">10</span>); lvi.pszText = szBuf;</span><br><span class="line">        <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        <span class="comment">// 第4列，可执行文件路径</span></span><br><span class="line">        lvi.iSubItem = <span class="number">3</span>; lvi.pszText = szPath;</span><br><span class="line">        <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_LIST_PROCESS), LVM_SETITEM, <span class="number">0</span>, (LPARAM)&amp;lvi);</span><br><span class="line">        bRet = <span class="built_in">Process32Next</span>(hSnapshot, &amp;pe);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">SuspendProcess</span><span class="params">(DWORD dwProcessId, BOOL bSuspend)</span> </span>&#123;</span><br><span class="line">    HANDLE hSnapshot = INVALID_HANDLE_VALUE;</span><br><span class="line">    THREADENTRY32 te = &#123; <span class="built_in">sizeof</span>(THREADENTRY32) &#125;;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">    hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPTHREAD, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    bRet = <span class="built_in">Thread32First</span>(hSnapshot, &amp;te);</span><br><span class="line">    <span class="keyword">while</span> (bRet) &#123;</span><br><span class="line">        <span class="keyword">if</span> (te.th32OwnerProcessID == dwProcessId) &#123;</span><br><span class="line">            hThread = <span class="built_in">OpenThread</span>(THREAD_SUSPEND_RESUME, FALSE, te.th32ThreadID);</span><br><span class="line">            <span class="keyword">if</span> (hThread) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bSuspend)</span><br><span class="line">                    <span class="built_in">SuspendThread</span>(hThread);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">ResumeThread</span>(hThread);</span><br><span class="line">                <span class="comment">// 关闭线程句柄</span></span><br><span class="line">                <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        bRet = <span class="built_in">Thread32Next</span>(hSnapshot, &amp;te);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">AdjustPrivileges</span><span class="params">(HANDLE hProcess, LPCTSTR lpPrivilegeName)</span> </span>&#123;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    TOKEN_PRIVILEGES tokenPrivileges;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">OpenProcessToken</span>(hProcess, TOKEN_ALL_ACCESS, &amp;hToken)) &#123;</span><br><span class="line">        LUID luid;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">LookupPrivilegeValue</span>(<span class="literal">NULL</span>, lpPrivilegeName, &amp;luid)) &#123;</span><br><span class="line">            tokenPrivileges.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">            tokenPrivileges.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">            tokenPrivileges.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">AdjustTokenPrivileges</span>(hToken, FALSE, &amp;tokenPrivileges, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>))</span><br><span class="line">                <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hToken);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="EnumProcesses法"><a href="#EnumProcesses法" class="headerlink" title="EnumProcesses法"></a>EnumProcesses法</h3><h4 id="EnumProceses"><a href="#EnumProceses" class="headerlink" title="EnumProceses"></a>EnumProceses</h4><p>系统维护正在运行的进程的列表，用这个获取进程ID。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">EnumProcesses</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PDWORD lpidProcess, <span class="comment">//接收进程ID列表</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD cb, <span class="comment">//lpidProcess数组大小 单位字节</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPDWORD lpcbNeeded <span class="comment">//返回字节数 进程个数即为*lpcbNeeded/sizeof(DWORD)</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="NtQueryInformationProcess-ZwQueryInformationProcess"><a href="#NtQueryInformationProcess-ZwQueryInformationProcess" class="headerlink" title="NtQueryInformationProcess&#x2F;ZwQueryInformationProcess"></a>NtQueryInformationProcess&#x2F;ZwQueryInformationProcess</h4><p>获取指定进程信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;Ntdll.lib&quot;</span>)</span></span><br><span class="line"><span class="function">NTSTATUS WINAPI <span class="title">NtQueryInformationProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE ProcessHandle, <span class="comment">//进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PROCESSINFOCLASS ProcessInformationClass, <span class="comment">//要获取的进程信息类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PVOID ProcessInformation, <span class="comment">//返回所请求信息的缓冲区</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ ULONG ProcessInformationLength, <span class="comment">//ProcessInformation缓冲区大小 单位字节</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PULONG ReturnLength <span class="comment">//请求信息大小</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>其中ProcessInformationClass可以是：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
<th>ProcessInformation类型</th>
<th>上层封装</th>
</tr>
</thead>
<tbody><tr>
<td>ProcessBasicInformation</td>
<td>是否正在被调试的进程环境快PEB结构、进程ID、父进程ID等</td>
<td>PROCESS_BASIC_INFORMATION</td>
<td><code>CheckRemoteDebuggerPresent</code>、<code>GetProcessId</code></td>
</tr>
<tr>
<td>ProcessDebugPort</td>
<td>该进程调试器的端口号，非0表示在Ring3调试器控制下运行</td>
<td>DWORD_PTR</td>
<td><code>CheckRemoteDebuggerPresent</code>、<code>IsDebuggerPresent</code></td>
</tr>
<tr>
<td>ProcessWow64Information</td>
<td>非0表示该进程正在WOW64环境中运行，0反之</td>
<td>ULONG_PTR</td>
<td><code>IsWow64Process</code></td>
</tr>
<tr>
<td>ProcessImageFileName</td>
<td>该进程文件名称字段</td>
<td>UNICODE_STRING</td>
<td><code>QueryFullProcessImageName</code>、<code>GetProcessImageFileName</code></td>
</tr>
<tr>
<td>ProcessBreakOnTermination</td>
<td>非0表示系统关键进程，0反之，需要PROCESS_QUERY_LIMITED_INFORMATION权限</td>
<td>ULONG</td>
<td><code>IsProcessCritical</code></td>
</tr>
</tbody></table>
<p>对于PROCESS_BASIC_INFORMATION结构有：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PROCESS_BASIC_INFORMATION</span> &#123;</span><br><span class="line">    PVOID Reserved1;</span><br><span class="line">    PPEB PebBaseAddress; <span class="comment">//进程环境块PEB结构指针</span></span><br><span class="line">    PVOID Reserved2[<span class="number">2</span>];</span><br><span class="line">    ULONG_PTR UniqueProcessId; <span class="comment">//进程ID</span></span><br><span class="line">    PVOID Reserved3; <span class="comment">//父进程ID</span></span><br><span class="line">&#125; PROCESS_BASIC_INFORMATION;</span><br><span class="line"><span class="keyword">typedef</span> PROCESS_BASIC_INFORMATION *PPROCESS_BASIC_INFORMATION;</span><br></pre></td></tr></table></figure>

<h2 id="系统关键进程"><a href="#系统关键进程" class="headerlink" title="系统关键进程"></a>系统关键进程</h2><h3 id="LoadLibrary"><a href="#LoadLibrary" class="headerlink" title="LoadLibrary"></a>LoadLibrary</h3><p>将指定模块加载到调用进程地址空间中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HMODULE <span class="title">LoadLibrary</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCTSTR lpLibFileName <span class="comment">//模块名称 可相对路径或绝对路径</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">//失败NULL</span></span></span><br></pre></td></tr></table></figure>

<p>注意该函数只是一个宏，实际为<code>LoadLibraryA</code>或<code>LoadLibraryW</code>。</p>
<h3 id="LoadLibraryEx"><a href="#LoadLibraryEx" class="headerlink" title="LoadLibraryEx"></a>LoadLibraryEx</h3><p>同<code>LoadLibrary</code>，可指定加载选项：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HMODULE WINAPI <span class="title">LoadLibraryEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPCTSTR lpLibFileName,</span></span></span><br><span class="line"><span class="params"><span class="function">	_Reserved_ HANDLE hFile, <span class="comment">//必须NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwFlags <span class="comment">//加载选项</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>当dwFlags为0时同<code>LoadLibrary</code>，常用选项有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>DONT_RESOLVE_DLL_REFERENCES</td>
<td>lpLibFileName指定的为DLL模块时系统不会调用其<code>DllMain</code>，也不会加载其引用的其他模块</td>
</tr>
<tr>
<td>LOAD_LIBRARY_AS_DATAFILE</td>
<td>把lpLibFileName指定的模块作为数据文件映射到调用进程虚拟地址空间，映射后没有可执行属性，函数返回模块句柄，可与LOAD_LIBRARY_AS_IMAGE_RESOURCE一同使用</td>
</tr>
<tr>
<td>LOAD_LIBRARY_AS_DATAFILE_EXCLUSIVE</td>
<td>同LOAD_LIBRARY_AS_DATAFILE，但以独占访问模式打开模块文件。</td>
</tr>
<tr>
<td>LOAD_LIBRARY_AS_IMAGE_RESOURCE</td>
<td>把lpLibFileName指定的模块作为数据文件映射到调用进程虚拟地址空间，并对模块中相对虚拟地址RVA修复使用户可直接使用模块中虚拟地址而不必根据映射到的地址进行转换</td>
</tr>
</tbody></table>
<h3 id="FreeLibrary"><a href="#FreeLibrary" class="headerlink" title="FreeLibrary"></a>FreeLibrary</h3><p>释放模块并减少引用次数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">FreeLibrary</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HMODULE hLibModule <span class="comment">//模块句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="GetProcAddress"><a href="#GetProcAddress" class="headerlink" title="GetProcAddress"></a>GetProcAddress</h3><p>获取其中一个函数地址：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">INT_PTR</span> <span class="params">(FAR WINAPI *FARPROC)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">FARPROC <span class="title">GetProcAddress</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HMODULE hModule, <span class="comment">//模块句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCSTR lpProcName <span class="comment">//函数名称/序数 区分大小写</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="comment">//失败NULL</span></span></span><br></pre></td></tr></table></figure>

<h3 id="RtlSetProcessIsCritical"><a href="#RtlSetProcessIsCritical" class="headerlink" title="RtlSetProcessIsCritical"></a>RtlSetProcessIsCritical</h3><p>未公开API，将一个进程设置为系统关键进程，强制结束将导致系统崩溃。这玩意儿也不知道咋用，暂且定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">RtlSetProcessIsCritical</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL NewValue, </span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PBOOL OldValue, </span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ BOOL CheckFlag</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="例子-4"><a href="#例子-4" class="headerlink" title="例子"></a>例子</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;\&quot;/manifestdependency:type=&#x27;win32&#x27; name=&#x27;Microsoft.Windows.Common-Controls&#x27; version=&#x27;6.0.0.0&#x27; processorArchitecture=&#x27;*&#x27; publicKeyToken=&#x27;6595b64144ccf1df&#x27; language=&#x27;*&#x27;\&quot;&quot;</span>)</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(__cdecl* pfnRtlSetProcessIsCritical)</span><span class="params">(_In_ BOOL NewValue, _Out_opt_ PBOOL OldValue, _In_ BOOL CheckFlag)</span></span>;</span><br><span class="line">pfnRtlSetProcessIsCritical pRtlSetProcessIsCritical;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> HMODULE hNtdll;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            hNtdll = <span class="built_in">LoadLibrary</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Ntdll.dll&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (hNtdll) &#123;</span><br><span class="line">                pRtlSetProcessIsCritical = (pfnRtlSetProcessIsCritical)<span class="built_in">GetProcAddress</span>(hNtdll, <span class="string">&quot;RtlSetProcessIsCritical&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (pRtlSetProcessIsCritical)</span><br><span class="line">                    <span class="built_in">pRtlSetProcessIsCritical</span>(TRUE, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">FreeLibrary</span>(hNtdll);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (pRtlSetProcessIsCritical)</span><br><span class="line">                        <span class="built_in">pRtlSetProcessIsCritical</span>(FALSE, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">                    <span class="keyword">if</span> (hNtdll)</span><br><span class="line">                        <span class="built_in">FreeLibrary</span>(hNtdll);</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="进程环境块PEB"><a href="#进程环境块PEB" class="headerlink" title="进程环境块PEB"></a>进程环境块PEB</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PEB</span> &#123;</span><br><span class="line">    BYTE Reserved1[<span class="number">2</span>];</span><br><span class="line">    BYTE BeingDebugged; <span class="comment">//当前进程是否正被调试 0或1</span></span><br><span class="line">    BYTE Reserved2[<span class="number">1</span>];</span><br><span class="line">    PVOID Reserved3[<span class="number">2</span>];</span><br><span class="line">    PPEB_LDR_DATA Ldr;</span><br><span class="line">    PRTL_USER_PROCESS_PARAMETERS ProcessParameters;</span><br><span class="line">    PVOID Reserved4[<span class="number">3</span>];</span><br><span class="line">    PVOID AtlThunkSListPtr;</span><br><span class="line">    PVOID Reserved5;</span><br><span class="line">    ULONG Reserved6;</span><br><span class="line">    PVOID Reserved7;</span><br><span class="line">    ULONG Reserved8;</span><br><span class="line">    ULONG AtlThunkSListPtr32;</span><br><span class="line">    PVOID Reserved9[<span class="number">45</span>];</span><br><span class="line">    BYTE Reserved10[<span class="number">96</span>];</span><br><span class="line">    PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;</span><br><span class="line">    BYTE Reserved11[<span class="number">128</span>];</span><br><span class="line">    PVOID Reserved12[<span class="number">1</span>];</span><br><span class="line">    ULONG SessionId; <span class="comment">//会话ID</span></span><br><span class="line">&#125; PEB, * PPEB;</span><br></pre></td></tr></table></figure>

<h3 id="Ldr字段"><a href="#Ldr字段" class="headerlink" title="Ldr字段"></a>Ldr字段</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PEB_LDR_DATA</span> &#123;</span><br><span class="line">    BYTE Reserved1[<span class="number">8</span>];</span><br><span class="line">    PVOID Reserved2[<span class="number">3</span>];</span><br><span class="line">    LIST_ENTRY InMemoryOrderModuleList; <span class="comment">//进程已加载模块的双向链表头</span></span><br><span class="line">&#125; PEB_LDR_DATA, * PPEB_LDR_DATA;</span><br></pre></td></tr></table></figure>

<p>其中LIST_ENTRY作双向链表头和节点定义分别为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span>* Flink; <span class="comment">//指向第一个节点 空链表则指向链表头</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span>* Blink; <span class="comment">//指向最后一个节点 空链表则指向链表头</span></span><br><span class="line">&#125; LIST_ENTRY, * PLIST_ENTRY, * RESTRICTED_POINTER PRLIST_ENTRY;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span>* Flink; <span class="comment">//指向下一个节点 最后一个节点指向链表头</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span>* Blink; <span class="comment">//指向上一个节点 第一个节点指向链表头</span></span><br><span class="line">&#125; LIST_ENTRY, * PLIST_ENTRY, * RESTRICTED_POINTER PRLIST_ENTRY;</span><br></pre></td></tr></table></figure>

<p>LIST_ENTRY通过<code>CONTAINING_RECORD</code>计算LDR_DATA_TABLE_ENTRY结构地址：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONTAINING_RECORD(address, type, field) ((type*)((PCHAR)(address)-(ULONG_PTR)(&amp;((type*)0)-&gt;field)))</span></span><br></pre></td></tr></table></figure>

<p>其中LDR_DATA_TABLE_ENTRY有：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LDR_DATA_TABLE_ENTRY</span> &#123;</span><br><span class="line">    PVOID Reserved1[<span class="number">2</span>];</span><br><span class="line">    LIST_ENTRY InMemoryOrderLinks;</span><br><span class="line">    PVOID Reserved2[<span class="number">2</span>];</span><br><span class="line">    PVOID DllBase; <span class="comment">//模块基地址</span></span><br><span class="line">    PVOID Reserved3[<span class="number">2</span>];</span><br><span class="line">    UNICODE_STRING FullDllName; <span class="comment">//模块文件完整路径</span></span><br><span class="line">    BYTE Reserved4[<span class="number">8</span>];</span><br><span class="line">    PVOID Reserved5[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        ULONG CheckSum; <span class="comment">//校验和</span></span><br><span class="line">        PVOID Reserved6;</span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    ULONG TimeDateStamp; <span class="comment">//时间戳</span></span><br><span class="line">&#125; LDR_DATA_TABLE_ENTRY, * PLDR_DATA_TABLE_ENTRY;</span><br></pre></td></tr></table></figure>

<p>例如枚举指定进程已加载模块信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PROCESS_BASIC_INFORMATION pbi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">PLIST_ENTRY pListEntry = <span class="literal">NULL</span>;</span><br><span class="line">PLDR_DATA_TABLE_ENTRY pDataTableEntry = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">NtQueryInformationProcess</span>(<span class="built_in">GetCurrentProcess</span>(), ProcessBasicInformation, &amp;pbi, <span class="built_in">sizeof</span>(PROCESS_BASIC_INFORMATION), <span class="literal">NULL</span>);</span><br><span class="line">pListEntry = pbi.PebBaseAddress-&gt;Ldr-&gt;InMemoryOrderModuleList.Flink; <span class="comment">//第一个节点</span></span><br><span class="line"><span class="keyword">if</span> (pListEntry != &amp;(pbi.PebBaseAddress-&gt;Ldr-&gt;InMemoryOrderModuleList)) <span class="comment">//链表为空则第一个节点指向链表头</span></span><br><span class="line">	<span class="keyword">while</span> (pListEntry != &amp;(pbi.PebBaseAddress-&gt;Ldr-&gt;InMemoryOrderModuleList)) &#123; <span class="comment">//最后一个节点的Flink指向链表头</span></span><br><span class="line">		pDataTableEntry = <span class="built_in">CONTAINING_RECORD</span>(pListEntry, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);</span><br><span class="line">		pListEntry = pListEntry-&gt;Flink; <span class="comment">//指向下一个节点</span></span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="ProcessParameters字段"><a href="#ProcessParameters字段" class="headerlink" title="ProcessParameters字段"></a>ProcessParameters字段</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_RTL_USER_PROCESS_PARAMETERS</span> &#123;</span><br><span class="line">    BYTE Reserved1[<span class="number">16</span>];</span><br><span class="line">    PVOID Reserved2[<span class="number">10</span>];</span><br><span class="line">    UNICODE_STRING ImagePathName; <span class="comment">//进程文件完整路径</span></span><br><span class="line">    UNICODE_STRING CommandLine; <span class="comment">//传递给进程的命令行参数</span></span><br><span class="line">&#125; RTL_USER_PROCESS_PARAMETERS, * PRTL_USER_PROCESS_PARAMETERS;</span><br></pre></td></tr></table></figure>

<p>在x64下可以修改，但没法进行伪装。</p>
<h2 id="进程调试"><a href="#进程调试" class="headerlink" title="进程调试"></a>进程调试</h2><h3 id="进程空间读写"><a href="#进程空间读写" class="headerlink" title="进程空间读写"></a>进程空间读写</h3><h4 id="ReadProcessMemory"><a href="#ReadProcessMemory" class="headerlink" title="ReadProcessMemory"></a>ReadProcessMemory</h4><p>读指定进程地址空间地址处内存数据：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">ReadProcessMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//进程句柄 需要PROCESS_VM_READ权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCVOID lpBaseAddress, <span class="comment">//hProcess进程中基地址</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPVOID lpBuffer, <span class="comment">//返回hProcess进程中从lpBaseAddress开始的nSize字节数据</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T nSize, <span class="comment">//要读取的字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PSIZE_T lpNumberOfBytesRead <span class="comment">//返回实际读取字节数</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="WriteProcessMemory"><a href="#WriteProcessMemory" class="headerlink" title="WriteProcessMemory"></a>WriteProcessMemory</h4><p>向指定进程地址空间地址处写入数据：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">WriteProcessMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//需要PROCESS_VM_WRITE和PROCESS_VM_OPERATION权限</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPVOID lpBaseAddress,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPCVOID lpBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T nSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PSIZE_T lpNumberOfBytesWritten</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="例子-5"><a href="#例子-5" class="headerlink" title="例子"></a>例子</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    TCHAR szCommandLine[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;Test.exe&quot;</span>);</span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    LPVOID lpBaseAddress = (LPVOID)<span class="number">0x009E1009</span>;</span><br><span class="line">    WORD wCodeOld, wCodeNew = <span class="number">0x9090</span>;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_LOADTEST: &#123;</span><br><span class="line">                    <span class="built_in">GetStartupInfo</span>(&amp;si);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">ReadProcessMemory</span>(pi.hProcess, lpBaseAddress, &amp;wCodeOld, <span class="built_in">sizeof</span>(WORD), <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                            <span class="comment">// 目标进程lpBaseAddress地址处的数据内容是否为0x1774，如果是则替换</span></span><br><span class="line">                            <span class="keyword">if</span> (wCodeOld == <span class="number">0x1774</span>) &#123;</span><br><span class="line">                                <span class="comment">// 改写机器码</span></span><br><span class="line">                                <span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpBaseAddress, &amp;wCodeNew, <span class="built_in">sizeof</span>(WORD), <span class="literal">NULL</span>);</span><br><span class="line">                                <span class="built_in">ResumeThread</span>(pi.hThread);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;目标软件版本错误&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                                <span class="built_in">TerminateProcess</span>(pi.hProcess, <span class="number">0</span>);</span><br><span class="line">                            &#125;;</span><br><span class="line">                        &#125;;</span><br><span class="line">                        <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">                        <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="获取模块基地址"><a href="#获取模块基地址" class="headerlink" title="获取模块基地址"></a>获取模块基地址</h3><h4 id="EnumProcessModules法"><a href="#EnumProcessModules法" class="headerlink" title="EnumProcessModules法"></a>EnumProcessModules法</h4><p>获取进程中每个模块句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">EnumProcessModules</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PMODULE lphModule, <span class="comment">//接收模块句柄列表的数组</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD cb, <span class="comment">//lphModule数组大小 单位字节</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPDWORD lpcbNeeded <span class="comment">//返回所需字节数 模块个数为*lpcbNeeded/sizeof(HMODULE)</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>其中第一个模块句柄就是主程序模块的句柄。例如获取主程序模块基地址：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HMODULE hModule;</span><br><span class="line">DWORD dwNeeded;</span><br><span class="line"><span class="built_in">EnumProcessModules</span>(hProcess, &amp;hModule, <span class="built_in">sizeof</span>(HMODULE), &amp;dwNeeded);</span><br></pre></td></tr></table></figure>

<h4 id="VirtualQueryEx法"><a href="#VirtualQueryEx法" class="headerlink" title="VirtualQueryEx法"></a>VirtualQueryEx法</h4><p>通过<code>GetThreadContext</code>获取目标进程主线程环境，<code>context.Eax</code>寄存器为程序入口点地址。再用<code>VirutalQueryEx</code>查询进程虚拟地址空间页面信息，其中<code>MEMORY_BASIC_INFORMATION.AllocationBase</code>是空间区域&#x2F;可执行模块基地址。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TCHAR szCommandLine[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;ThreeThousandYears.exe&quot;</span>); <span class="comment">// 目标程序</span></span><br><span class="line">MEMORY_BASIC_INFORMATION mbi = &#123; <span class="number">0</span> &#125;;                           <span class="comment">// VirtualQueryEx参数</span></span><br><span class="line">SIZE_T nBufSize;                                                <span class="comment">// VirtualQueryEx返回值</span></span><br><span class="line">TCHAR szImageFile[MAX_PATH] = &#123; <span class="number">0</span> &#125;;                            <span class="comment">// 目标程序完整路径</span></span><br><span class="line">TCHAR szBuf[MAX_PATH * <span class="number">2</span>] = &#123; <span class="number">0</span> &#125;;                              <span class="comment">// 缓冲区</span></span><br><span class="line">STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">CONTEXT context = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="comment">// 创建一个挂起的进程</span></span><br><span class="line"><span class="built_in">GetStartupInfo</span>(&amp;si);</span><br><span class="line"><span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line"><span class="comment">// 获取目标进程主线程环境</span></span><br><span class="line">context.ContextFlags = CONTEXT_ALL;</span><br><span class="line"><span class="built_in">GetThreadContext</span>(pi.hThread, &amp;context);</span><br><span class="line"><span class="comment">// context.Eax是程序入口点地址</span></span><br><span class="line">nBufSize = <span class="built_in">VirtualQueryEx</span>(pi.hProcess, (LPVOID)context.Rax, &amp;mbi, <span class="built_in">sizeof</span>(mbi));</span><br><span class="line"><span class="keyword">if</span> (nBufSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">GetMappedFileName</span>(pi.hProcess, (LPVOID)context.Rax, szImageFile, _countof(szImageFile));</span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;%s 基地址：0x%p&quot;</span>), szImageFile, mbi.AllocationBase);</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="GetSystemInfo法"><a href="#GetSystemInfo法" class="headerlink" title="GetSystemInfo法"></a>GetSystemInfo法</h4><p>以暂停模式启动目标进程后，可执行模块本身已经在内存中映射，但依赖的DLL模块还没有映射。用<code>GetSystemInfo</code>查询进程地址空间最小&#x2F;大内存地址、页面大小，从最小内存地址<code>lpMinAppAddress</code>开始递增查找第一个MEM_IMAGE类型已提交页面即属于可执行模块空间区域。<code>MEMORY_BASIC_INFORMATION.AllocationBase</code>是空间区域&#x2F;可执行模块基地址。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//变量继承VirtualQueryEx法</span></span><br><span class="line">SYSTEM_INFO systemInfo = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">LPVOID lpMinAppAddress = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">// 获取进程地址空间的最小、最大内存地址，和页面大小</span></span><br><span class="line"><span class="built_in">GetSystemInfo</span>(&amp;systemInfo);</span><br><span class="line">lpMinAppAddress = systemInfo.lpMinimumApplicationAddress;</span><br><span class="line"><span class="comment">// 从最小内存地址开始查找第一个具有MEM_IMAGE存储类型的页面(页面状态为已提交)</span></span><br><span class="line"><span class="keyword">while</span> (lpMinAppAddress &lt; systemInfo.lpMaximumApplicationAddress) &#123;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;mbi, <span class="built_in">sizeof</span>(MEMORY_BASIC_INFORMATION));</span><br><span class="line">    nBufSize = <span class="built_in">VirtualQueryEx</span>(pi.hProcess, lpMinAppAddress, &amp;mbi, <span class="built_in">sizeof</span>(mbi));</span><br><span class="line">    <span class="keyword">if</span> (nBufSize == <span class="number">0</span>) &#123;</span><br><span class="line">        lpMinAppAddress = (LPBYTE)lpMinAppAddress + systemInfo.dwPageSize;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (mbi.State) &#123;</span><br><span class="line">        <span class="keyword">case</span> MEM_RESERVE:</span><br><span class="line">        <span class="keyword">case</span> MEM_FREE: &#123;</span><br><span class="line">            lpMinAppAddress = (LPBYTE)(mbi.BaseAddress) + mbi.RegionSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> MEM_COMMIT: &#123;</span><br><span class="line">            <span class="keyword">if</span> (mbi.Type == MEM_IMAGE) &#123;</span><br><span class="line">                <span class="built_in">GetMappedFileName</span>(pi.hProcess, lpMinAppAddress, szImageFile, _countof(szImageFile));</span><br><span class="line">                <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;%s 基地址：0x%p&quot;</span>), szImageFile, mbi.AllocationBase);</span><br><span class="line">                <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            lpMinAppAddress = (LPBYTE)(mbi.BaseAddress) + mbi.RegionSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 找到了就退出循环</span></span><br><span class="line">    <span class="keyword">if</span> (mbi.Type == MEM_IMAGE)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">ResumeThread</span>(pi.hThread);</span><br><span class="line"><span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line"><span class="built_in">CloseHandle</span>(pi.hProcess);</span><br></pre></td></tr></table></figure>

<h2 id="调试API"><a href="#调试API" class="headerlink" title="调试API"></a>调试API</h2><h3 id="DebugActiveProcess"><a href="#DebugActiveProcess" class="headerlink" title="DebugActiveProcess"></a>DebugActiveProcess</h3><p>使进程进入被调试状态：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">DebugActiveProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwProcessId <span class="comment">//进程ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="DebugActiveProcessStop"><a href="#DebugActiveProcessStop" class="headerlink" title="DebugActiveProcessStop"></a>DebugActiveProcessStop</h3><p>停止堆指定进程的调试：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DebugActiveProcessStop</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwProcessId <span class="comment">//进程ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="WaitForDebugEvent"><a href="#WaitForDebugEvent" class="headerlink" title="WaitForDebugEvent"></a>WaitForDebugEvent</h3><p>等待正在调试的进程发生调试事件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">WaitForDebugEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPDEBUG_EVENT lpDebugEvent, <span class="comment">//返回调试事件信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwMilliseconds <span class="comment">//等待调试事件发生的毫秒数 0立即返回 INFINITE一直等待</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>其中DEBUG_EVENT有：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DEBUG_EVENT</span> &#123;</span><br><span class="line">    DWORD dwDebugEventCode; <span class="comment">//调试事件类型</span></span><br><span class="line">    DWORD dwProcessId; <span class="comment">//发生调试事件的进程ID</span></span><br><span class="line">    DWORD dwThreadId; <span class="comment">//发生调试事件的线程ID</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        EXCEPTION_DEBUG_INFO Exception; <span class="comment">//EXCEPTION_DEBUG_EVENT</span></span><br><span class="line">        CREATE_THREAD_DEBUG_INFO CreateThread; <span class="comment">//CREATE_THREAD_DEBUG_EVENT</span></span><br><span class="line">        CREATE_PROCESS_DEBUG_INFO CreateProcessInfo; <span class="comment">//CREATE_PROCESS_DEBUG_EVENT</span></span><br><span class="line">        EXIT_THREAD_DEBUG_INFO ExitThread; <span class="comment">//EXIT_THREAD_DEBUG_EVENT</span></span><br><span class="line">        EXIT_PROCESS_DEBUG_INFO ExitProcess; <span class="comment">//EXIT_PROCESS_DEBUG_EVENT</span></span><br><span class="line">        LOAD_DLL_DEBUG_INFO LoadDll; <span class="comment">//LOAD_DLL_DEBUG_EVENT</span></span><br><span class="line">        UNLOAD_DLL_DEBUG_INFO UnloadDll; <span class="comment">//UNLOAD_DLL_DEBUG_EVENT</span></span><br><span class="line">        OUTPUT_DEBUG_STRING_INFO DebugString; <span class="comment">//OUTPUT_DEBUG_STRING_EVENT</span></span><br><span class="line">        RIP_INFO RipInfo; <span class="comment">//RIP_EVENT</span></span><br><span class="line">    &#125; u;</span><br><span class="line">&#125; DEBUG_EVENT, * LPDEBUG_EVENT;</span><br></pre></td></tr></table></figure>

<p>不同调试事件类型有：</p>
<table>
<thead>
<tr>
<th>调试事件类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>EXCEPTION_DEBUG_EVENT</td>
<td>被调试进程发生异常事件或被调试进程开始执行第一条指令</td>
</tr>
<tr>
<td>CREATE_THREAD_DEBUG_EVENT</td>
<td>被调试进程创建了一个新线程，主线程除外</td>
</tr>
<tr>
<td>CREATE_PROCESS_DEBUG_EVENT</td>
<td>被调试进程被创建但还未开始运行，或正在运行的进程被附加到调试器</td>
</tr>
<tr>
<td>EXIT_THREAD_DEBUG_EVENT</td>
<td>被调试进程中有线程结束</td>
</tr>
<tr>
<td>EXIT_PROCESS_DEBUG_EVENT</td>
<td>被调试进程退出</td>
</tr>
<tr>
<td>LOAD_DLL_DEBUG_EVENT</td>
<td>被调试进程加载一个DLL，或系统根据导入表加载DLL，或被调试进程用<code>LoadLibrary</code>加载DLL</td>
</tr>
<tr>
<td>UNLOAD_DLL_DEBUG_EVENT</td>
<td>一个DLL从被调试进程中卸载时</td>
</tr>
<tr>
<td>OUTPUT_DEBUG_STRING_EVENT</td>
<td>被调试进程用<code>DebugOutputString</code>时</td>
</tr>
<tr>
<td>RIP_EVENT</td>
<td>调试发生错误</td>
</tr>
</tbody></table>
<p>对于CREATE_THREAD_DEBUG_EVENT，<code>u.CreateProcessInfo</code>字段有CREATE_PROCESS_DEBUG_INFO结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_CREATE_PROCESS_DEBUG_INFO</span> &#123;</span><br><span class="line">    HANDLE hFile; <span class="comment">//进程可执行映像文件句柄</span></span><br><span class="line">    HANDLE hProcess; <span class="comment">//进程句柄</span></span><br><span class="line">    HANDLE hThread; <span class="comment">//初始线程句柄</span></span><br><span class="line">    LPVOID lpBaseOfImage; <span class="comment">//可执行文件加载到的基地址</span></span><br><span class="line">    DWORD dwDebugInfoFileOffset; <span class="comment">//可执行文件中调试信息偏移量</span></span><br><span class="line">    DWORD nDebugInfoSize; <span class="comment">//文件中调试信息大小 单位字节</span></span><br><span class="line">    LPVOID lpThreadLocalBase; <span class="comment">//线程本地存储相关</span></span><br><span class="line">    LPTHREAD_START_ROUTINE lpStartAddress; <span class="comment">//指向线程起始地址</span></span><br><span class="line">    LPVOID lpImageName; <span class="comment">//可执行文件名称</span></span><br><span class="line">    WORD fUnicode; <span class="comment">//非0则lpImageName为Unicode 0表示ANSI</span></span><br><span class="line">&#125; CREATE_PROCESS_DEBUG_INFO, * LPCREATE_PROCESS_DEBUG_INFO;</span><br></pre></td></tr></table></figure>

<p>对于EXCEPTION_DEBUG_EVENT，<code>u.Exception</code>字段有EXCEPTION_DEBUG_INFO结构：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_EXCEPTION_RECORD</span> &#123;</span><br><span class="line">    DWORD ExceptionCode; <span class="comment">//异常代码</span></span><br><span class="line">    DWORD ExceptionFlags; <span class="comment">//异常标志</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EXCEPTION_RECORD</span>* ExceptionRecord;</span><br><span class="line">    PVOID ExceptionAddress; <span class="comment">//发生异常的地址</span></span><br><span class="line">    DWORD NumberParameters;</span><br><span class="line">    ULONG_PTR ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS];</span><br><span class="line">&#125; EXCEPTION_RECORD;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_EXCEPTION_DEBUG_INFO</span> &#123;</span><br><span class="line">    EXCEPTION_RECORD ExceptionRecord;</span><br><span class="line">    DWORD dwFirstChance; <span class="comment">//是否第一次发生异常</span></span><br><span class="line">&#125; EXCEPTION_DEBUG_INFO, * LPEXCEPTION_DEBUG_INFO;</span><br></pre></td></tr></table></figure>

<p>其中ExceptionCode异常代码有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>EXCEPTION_BREAKPOINT</td>
<td>遇到断点，如<code>int 3</code>断点</td>
</tr>
<tr>
<td>EXCEPTION_SINGLE_STEP</td>
<td>跟踪陷阱或单步中断。单步中断指当发现TF位为1时触发异常并暂停，系统自动将TF置0。每条指令都单步中断时需要手动TF置1</td>
</tr>
<tr>
<td>EXCEPTION_ACCESS_VIOLATION</td>
<td>线程试图读取或写入对其没有适当访问权限的虚拟地址</td>
</tr>
</tbody></table>
<p>注：标志寄存器前16位分别为：</p>
<table>
<thead>
<tr>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
<th>11</th>
<th>12</th>
<th>13</th>
<th>14</th>
<th>15</th>
</tr>
</thead>
<tbody><tr>
<td>CF</td>
<td></td>
<td>PF</td>
<td></td>
<td>AF</td>
<td></td>
<td>ZF</td>
<td>SF</td>
<td>TF</td>
<td>IF</td>
<td>DF</td>
<td>OF</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>ExceptionsFlags为异常标志，为0表示程序可继续执行的异常；为EXCEPTION_NONCONTINUABLE表示程序不可继续执行的异常，这时继续执行会发生EXCEPTION_NONCONTINUABLE_EXCEPTION异常。</p>
<p>当发生嵌套异常时，ExceptionRecord指向EXCEPTION_RECORD结构，包含另一个异常的异常信息；没发生嵌套异常则为NULL。</p>
<p>ExceptionInformation数组为描述异常的附加参数，该字段通常为NULL。NumberParameters为ExceptionInformation数组元素个数，最多EXCEPTION_MAXIMUM_PARAMETERS个，通常为0。目前这两个字段只有EXCEPTION_ACCESS_VIOLATION和EXCEPTION_IN_PAGE_ERROR用到了。</p>
<p>对于EXCEPTION_ACCESS_VIOLATION，ExceptionInformation[0]为0表示试图读取非法地址，为1表示试图写入非法地址，为8表示数据执行保护DEP检测到线程执行没可执行权限内存页中的代码。ExceptionInformation[1]为不可访问数据的内存地址。对于EXCEPTION_IN_PAGE_ERROR的ExceptionInformation前两个元素同上，ExceptionInformation[2]表示导致异常的NTSTATUS代码。</p>
<h3 id="ContinueDebugEvent"><a href="#ContinueDebugEvent" class="headerlink" title="ContinueDebugEvent"></a>ContinueDebugEvent</h3><p>恢复被调试进程运行：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">ContinueDebugEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwProcessId, <span class="comment">//被恢复运行的进程ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwThreadId, <span class="comment">//被恢复运行的线程ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwContinueStatus <span class="comment">//继续执行选项</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>dwProcessId和dwThreadId从DEBUG_EVENT中返回即可。有常用dwContinueStatus：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>DBG_CONTINUE</td>
<td>当指定线程发生EXCEPTION_DEBUG_EVENT则停止所有异常处理并继续执行该线程，将异常标记为已处理；发生其他调试事件则继续执行</td>
</tr>
<tr>
<td>DBG_EXCEPTION_NOT_HANDLED</td>
<td>当指定线程发生EXCEPTION_DEBUG_EVENT则使用被调试进程结构化异常处理程序处理，否则进程终止；发生其他调试事件则继续执行</td>
</tr>
<tr>
<td>DBG_REPLY_LATER</td>
<td>继续执行指定线程，再次触发相同异常</td>
</tr>
</tbody></table>
<h3 id="例子-6"><a href="#例子-6" class="headerlink" title="例子"></a>例子</h3><p>常见的调试器处理调试事件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">DEBUG_EVENT debugEvent;</span><br><span class="line"><span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">    <span class="built_in">WaitForDebugEvent</span>(&amp;debugEvent, INFINITE);</span><br><span class="line">    <span class="keyword">if</span> (debugEvent.dwDebugEventCode == EXCEPTION_DEBUG_EVENT) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (debugEvent.u.ExceptionRecord.ExceptionCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> EXCEPTION_BREAKPOINT: &#123; <span class="comment">//断点中断</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">case</span> EXCEPTION_SINGLE_STEP: &#123; <span class="comment">//单步中断</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">case</span> EXCEPTION_ACCESS_VIOLATION: &#123; <span class="comment">//访问违规</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == CREATE_THREAD_DEBUG_EVENT) &#123;</span><br><span class="line">        <span class="comment">//一般用GetThreadContext SetThreadContext SuspendThread ResumeThread</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == CREATE_PROCESS_DEBUG_EVENT) &#123;</span><br><span class="line">        <span class="comment">//一般用GetThreadContext SetThreadContext SuspendThread ResumeThread ReadProcessMemory WriteProcessMemory</span></span><br><span class="line">        <span class="built_in">CloseHandle</span>(debugEvent.u.CreateProcessInfo.hFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == EXIT_THREAD_DEBUG_EVENT) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == EXIT_PROCESS_DEBUG_EVENT) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == LOAD_DLL_DEBUG_EVENT) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="built_in">CloseHandle</span>(debugEvent.u.LoadDll.hFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == UNLOAD_DLL_DEBUG_EVENT) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == OUTPUT_DEBUG_STRING_EVENT) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == RIP_EVENT) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">ContinueDebugEvent</span>(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="例子-7"><a href="#例子-7" class="headerlink" title="例子"></a>例子</h3><p>内存读写：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    TCHAR szCommandLine[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;Test.exe&quot;</span>);</span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    LPVOID lpBaseAddr;</span><br><span class="line">    WORD wCodeOld, wCodeNew = <span class="number">0x9090</span>;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_LOADTEST: &#123;</span><br><span class="line">                    <span class="built_in">GetStartupInfo</span>(&amp;si);</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, DEBUG_ONLY_THIS_PROCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    DEBUG_EVENT debugEvent;</span><br><span class="line">                    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">                        <span class="comment">// 等待调试事件发生</span></span><br><span class="line">                        <span class="built_in">WaitForDebugEventEx</span>(&amp;debugEvent, INFINITE);</span><br><span class="line">                        <span class="comment">// 处理调试事件</span></span><br><span class="line">                        <span class="keyword">if</span> (debugEvent.dwDebugEventCode == CREATE_PROCESS_DEBUG_EVENT) &#123;</span><br><span class="line">                            lpBaseAddr = (LPBYTE)(debugEvent.u.CreateProcessInfo.lpBaseOfImage) + <span class="number">0x1009</span>;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">ReadProcessMemory</span>(pi.hProcess, lpBaseAddr, &amp;wCodeOld, <span class="built_in">sizeof</span>(WORD), <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                                <span class="comment">// 目标进程lpBaseAddr地址处的数据内容是否为0x1774，如果是则替换</span></span><br><span class="line">                                <span class="keyword">if</span> (wCodeOld == <span class="number">0x1774</span>)</span><br><span class="line">                                    <span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpBaseAddr, &amp;wCodeNew, <span class="built_in">sizeof</span>(WORD), <span class="literal">NULL</span>);</span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;目标软件版本错误&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">                                    <span class="built_in">TerminateProcess</span>(pi.hProcess, <span class="number">0</span>);</span><br><span class="line">                                &#125;;</span><br><span class="line">                            &#125;;</span><br><span class="line">                            <span class="built_in">CloseHandle</span>(debugEvent.u.CreateProcessInfo.hFile);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == EXIT_PROCESS_DEBUG_EVENT) &#123;</span><br><span class="line">                            <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;被调试进程退出&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;;</span><br><span class="line">                        <span class="comment">// 处理完一个调试事件以后调用ContinueDebugEvent恢复线程执行并继续等待下个调试事件</span></span><br><span class="line">                        <span class="built_in">ContinueDebugEvent</span>(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">                    <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="例子-8"><a href="#例子-8" class="headerlink" title="例子"></a>例子</h3><p>UPX脱壳：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    TCHAR szCommandLine[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;Test_UPX.exe&quot;</span>);</span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">static</span> LPVOID lpPopad, lpPatch;<span class="comment">// popad地址(基地址 + 0x18C4E)，补丁地址(基地址 + 0x1000 + 0x9)</span></span><br><span class="line">    BYTE bInt3 = <span class="number">0xCC</span>;             <span class="comment">// popad指令地址处写入int 3指令的机器码0xCC</span></span><br><span class="line">    BYTE bOld = <span class="number">0x61</span>;              <span class="comment">// 恢复popad指令的机器码</span></span><br><span class="line">    WORD wCodeNew = <span class="number">0x9090</span>;</span><br><span class="line">    DEBUG_EVENT debugEvent;</span><br><span class="line">    CONTEXT context;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_LOADTEST: &#123;</span><br><span class="line">                    <span class="built_in">GetStartupInfo</span>(&amp;si);</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, DEBUG_ONLY_THIS_PROCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi))</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">                        <span class="comment">// 等待调试事件发生</span></span><br><span class="line">                        <span class="built_in">WaitForDebugEvent</span>(&amp;debugEvent, INFINITE);</span><br><span class="line">                        <span class="comment">// 进程被创建</span></span><br><span class="line">                        <span class="keyword">if</span> (debugEvent.dwDebugEventCode == CREATE_PROCESS_DEBUG_EVENT) &#123;</span><br><span class="line">                            <span class="comment">// lpPopad, lpPatch</span></span><br><span class="line">                            lpPopad = (LPBYTE)(debugEvent.u.CreateProcessInfo.lpBaseOfImage) + <span class="number">0x18C4E</span>;</span><br><span class="line">                            lpPatch = (LPBYTE)(debugEvent.u.CreateProcessInfo.lpBaseOfImage) + <span class="number">0x1000</span> + <span class="number">0x9</span>;</span><br><span class="line">                            <span class="comment">// popad指令处下int 3断点</span></span><br><span class="line">                            <span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpPopad, &amp;bInt3, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">                            <span class="built_in">CloseHandle</span>(debugEvent.u.CreateProcessInfo.hFile);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 被调试进程中发生异常事件</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == EXCEPTION_DEBUG_EVENT) &#123;</span><br><span class="line">                            <span class="keyword">switch</span> (debugEvent.u.Exception.ExceptionRecord.ExceptionCode) &#123;</span><br><span class="line">                                <span class="keyword">case</span> EXCEPTION_BREAKPOINT: &#123;         <span class="comment">// 断点中断</span></span><br><span class="line">                                    context.ContextFlags = CONTEXT_CONTROL;</span><br><span class="line">                                    <span class="built_in">GetThreadContext</span>(pi.hThread, &amp;context);</span><br><span class="line">                                    <span class="comment">// int 3指令执行以后才会发生异常，这时候eip已经指向了下一条指令</span></span><br><span class="line">                                    <span class="keyword">if</span> (context.Rip == (DWORD)((LPBYTE)lpPopad + <span class="number">1</span>)) &#123;</span><br><span class="line">                                        <span class="comment">// popad指令处的int 3断点改回原popad指令</span></span><br><span class="line">                                        <span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpPopad, &amp;bOld, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line">                                        <span class="comment">// 内存补丁，JE指令修改为两个NOP指令</span></span><br><span class="line">                                        <span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpPatch, &amp;wCodeNew, <span class="number">2</span>, <span class="literal">NULL</span>);</span><br><span class="line">                                        <span class="comment">// 重新执行popad指令</span></span><br><span class="line">                                        context.Rip -= <span class="number">1</span>;</span><br><span class="line">                                        <span class="built_in">SetThreadContext</span>(pi.hThread, &amp;context);</span><br><span class="line">                                    &#125;;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;;</span><br><span class="line">                                <span class="keyword">case</span> EXCEPTION_SINGLE_STEP: &#123;         <span class="comment">// 单步中断</span></span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;;</span><br><span class="line">                            &#125;;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 被调试进程退出</span></span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (debugEvent.dwDebugEventCode == EXIT_PROCESS_DEBUG_EVENT)</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">// 处理完一个调试事件以后调用ContinueDebugEvent恢复线程执行并继续等待下个事件</span></span><br><span class="line">                        <span class="built_in">ContinueDebugEvent</span>(debugEvent.dwProcessId, debugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">                    <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="线程环境"><a href="#线程环境" class="headerlink" title="线程环境"></a>线程环境</h2><h3 id="GetThreadContext-SetThreadContext"><a href="#GetThreadContext-SetThreadContext" class="headerlink" title="GetThreadContext&#x2F;SetThreadContext"></a>GetThreadContext&#x2F;SetThreadContext</h3><p>获取&#x2F;设置线程环境：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">GetThreadContext</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hThread, <span class="comment">//线程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ LPCONTEXT lpContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">SetThreadContext</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hThread,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST LPCONTEXT lpContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中CONTEXT在x64下为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">DECLSPEC_ALIGN</span>(<span class="number">16</span>) DECLSPEC_NOINITALL _CONTEXT &#123;</span><br><span class="line">    DWORD64 P1Home;</span><br><span class="line">    DWORD64 P2Home;</span><br><span class="line">    DWORD64 P3Home;</span><br><span class="line">    DWORD64 P4Home;</span><br><span class="line">    DWORD64 P5Home;</span><br><span class="line">    DWORD64 P6Home;</span><br><span class="line">    DWORD ContextFlags; <span class="comment">//线程环境标志</span></span><br><span class="line">    DWORD MxCsr;</span><br><span class="line">    WORD   SegCs;</span><br><span class="line">    WORD   SegDs;</span><br><span class="line">    WORD   SegEs;</span><br><span class="line">    WORD   SegFs;</span><br><span class="line">    WORD   SegGs;</span><br><span class="line">    WORD   SegSs;</span><br><span class="line">    DWORD EFlags;</span><br><span class="line">    DWORD64 Dr0;</span><br><span class="line">    DWORD64 Dr1;</span><br><span class="line">    DWORD64 Dr2;</span><br><span class="line">    DWORD64 Dr3;</span><br><span class="line">    DWORD64 Dr6;</span><br><span class="line">    DWORD64 Dr7;</span><br><span class="line">    DWORD64 Rax;</span><br><span class="line">    DWORD64 Rcx;</span><br><span class="line">    DWORD64 Rdx;</span><br><span class="line">    DWORD64 Rbx;</span><br><span class="line">    DWORD64 Rsp;</span><br><span class="line">    DWORD64 Rbp;</span><br><span class="line">    DWORD64 Rsi;</span><br><span class="line">    DWORD64 Rdi;</span><br><span class="line">    DWORD64 R8;</span><br><span class="line">    DWORD64 R9;</span><br><span class="line">    DWORD64 R10;</span><br><span class="line">    DWORD64 R11;</span><br><span class="line">    DWORD64 R12;</span><br><span class="line">    DWORD64 R13;</span><br><span class="line">    DWORD64 R14;</span><br><span class="line">    DWORD64 R15;</span><br><span class="line">    DWORD64 Rip;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        XMM_SAVE_AREA32 FltSave;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            M128A Header[<span class="number">2</span>];</span><br><span class="line">            M128A Legacy[<span class="number">8</span>];</span><br><span class="line">            M128A Xmm0;</span><br><span class="line">            M128A Xmm1;</span><br><span class="line">            M128A Xmm2;</span><br><span class="line">            M128A Xmm3;</span><br><span class="line">            M128A Xmm4;</span><br><span class="line">            M128A Xmm5;</span><br><span class="line">            M128A Xmm6;</span><br><span class="line">            M128A Xmm7;</span><br><span class="line">            M128A Xmm8;</span><br><span class="line">            M128A Xmm9;</span><br><span class="line">            M128A Xmm10;</span><br><span class="line">            M128A Xmm11;</span><br><span class="line">            M128A Xmm12;</span><br><span class="line">            M128A Xmm13;</span><br><span class="line">            M128A Xmm14;</span><br><span class="line">            M128A Xmm15;</span><br><span class="line">        &#125; DUMMYSTRUCTNAME;</span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    M128A VectorRegister[<span class="number">26</span>];</span><br><span class="line">    DWORD64 VectorControl;</span><br><span class="line">    DWORD64 DebugControl;</span><br><span class="line">    DWORD64 LastBranchToRip;</span><br><span class="line">    DWORD64 LastBranchFromRip;</span><br><span class="line">    DWORD64 LastExceptionToRip;</span><br><span class="line">    DWORD64 LastExceptionFromRip;</span><br><span class="line">&#125; CONTEXT, * PCONTEXT;</span><br></pre></td></tr></table></figure>

<p>根据线程环境标志ContextFlag可多选，分为：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>所含寄存器</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>CONTEXT_CONTROL</td>
<td>SegSs, Rsp, SegCs, Rip, EFlags</td>
<td>控制寄存器</td>
</tr>
<tr>
<td>CONTEXT_INTEGER</td>
<td>Rax, Rcx, Rdx, Rbx, Rbp, Rsi, Rdi, R8-R15</td>
<td>整数寄存器</td>
</tr>
<tr>
<td>CONTEXT_SEGMENTS</td>
<td>SegDs, SegEs, SegFs, SegGs</td>
<td>段寄存器</td>
</tr>
<tr>
<td>CONTEXT_FLOATING_POINT</td>
<td>Xmm0-Xmm15</td>
<td>浮点寄存器</td>
</tr>
<tr>
<td>CONTEXT_DEBUG_REGISTERS</td>
<td>Dr0-Dr3, Dr6-Dr7</td>
<td>调试寄存器</td>
</tr>
</tbody></table>
<p>注意用这俩函数前应暂停线程，获取&#x2F;设置相关寄存器值后再恢复线程运行，防止函数执行到一半被Windows切走。例如更改Rip等值时需要目标线程的THREAD_GET_CONTEXT和TRHEAD_SET_CONTEXT权限，如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONTEXT Context;</span><br><span class="line">Context.Rip = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">SetThreadContext</span>(hThread, &amp;Context);</span><br><span class="line"><span class="built_in">ResumeThread</span>(hThread);</span><br></pre></td></tr></table></figure>

<h2 id="Spy"><a href="#Spy" class="headerlink" title="Spy++"></a>Spy++</h2><h3 id="WindowFromPoint"><a href="#WindowFromPoint" class="headerlink" title="WindowFromPoint"></a>WindowFromPoint</h3><p>获取指定坐标处窗口的窗口句柄，可能不准确：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HWND WINAPI <span class="title">WindowFromPoint</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ POINT Point <span class="comment">//指定坐标</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="GetParent"><a href="#GetParent" class="headerlink" title="GetParent"></a>GetParent</h3><p>获取指定窗口的父窗口句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HWND WINAPI <span class="title">GetParent</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HWND hWnd <span class="comment">//指定窗口</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="GetWindow"><a href="#GetWindow" class="headerlink" title="GetWindow"></a>GetWindow</h3><p>获取与指定窗口具有指定关系的窗口句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HWND WINAPI <span class="title">GetWindow</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HWND hWnd, <span class="comment">//指定窗口</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uCmd <span class="comment">//指定关系</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>uCmd可以有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>GW_HWNDFIRST</td>
<td>同一级别中Z顺序最高的窗口</td>
</tr>
<tr>
<td>GW_HWNDLAST</td>
<td>同一级别中Z顺序最低的窗口</td>
</tr>
<tr>
<td>GW_HWNDNEXT</td>
<td>同一级别中下一个Z顺序窗口</td>
</tr>
<tr>
<td>GW_HWNDPREV</td>
<td>同一级别中上一个Z顺序窗口</td>
</tr>
<tr>
<td>GW_CHILD</td>
<td>Z顺序最高的，即第一个子窗口</td>
</tr>
</tbody></table>
<h3 id="GetWindowThreadProcessId"><a href="#GetWindowThreadProcessId" class="headerlink" title="GetWindowThreadProcessId"></a>GetWindowThreadProcessId</h3><p>根据窗口句柄获取创建该窗口的进程&#x2F;线程ID：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">GetWindowThreadProcessId</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HWND hWnd, <span class="comment">//窗口句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ LPDWORD lpdwProcessId <span class="comment">//返回创建该窗口的进程ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回创建该窗口的线程ID</span></span><br></pre></td></tr></table></figure>

<h3 id="例子-9"><a href="#例子-9" class="headerlink" title="例子"></a>例子</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;\&quot;/manifestdependency:type=&#x27;win32&#x27; name=&#x27;Microsoft.Windows.Common-Controls&#x27; version=&#x27;6.0.0.0&#x27; processorArchitecture=&#x27;*&#x27; publicKeyToken=&#x27;6595b64144ccf1df&#x27; language=&#x27;*&#x27;\&quot;&quot;</span>)</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hInstance;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 获取目标窗口句柄</span></span><br><span class="line"><span class="function">HWND <span class="title">SmallestWindowFromPoint</span><span class="params">(POINT pt)</span></span>;</span><br><span class="line"><span class="comment">// 获取父进程ID</span></span><br><span class="line"><span class="function">DWORD <span class="title">GetParentProcessIDByID</span><span class="params">(DWORD dwProcessId)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    g_hInstance = hInstance;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>&#123;</span><br><span class="line">   <span class="type">static</span> HCURSOR hCursorDrag;     <span class="comment">// 拖动时的光标句柄</span></span><br><span class="line">   <span class="type">static</span> HICON hIconNormal;       <span class="comment">// 正常情况下图像静态控件所用的图标句柄</span></span><br><span class="line">   <span class="type">static</span> HICON hIconDrag;         <span class="comment">// 拖动时的图像静态控件所用的图标句柄</span></span><br><span class="line">   <span class="type">static</span> HWND hwndTarget;         <span class="comment">// 目标窗口句柄</span></span><br><span class="line">   <span class="type">static</span> HDC hdcDesk;             <span class="comment">// 桌面设备环境句柄，用于在目标窗口周围绘制闪动矩形</span></span><br><span class="line">   RECT rect;</span><br><span class="line">   POINT pt;</span><br><span class="line">   DWORD dwProcessID, dwParentProcessID, dwCtrlID;</span><br><span class="line">   TCHAR szBuf[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">   LPTSTR lpBuf = <span class="literal">NULL</span>;</span><br><span class="line">   <span class="type">int</span> nLen;</span><br><span class="line">   <span class="keyword">switch</span> (uMsg)&#123;</span><br><span class="line">       <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">           <span class="comment">// 为对话框程序左上角设置一个图标</span></span><br><span class="line">           <span class="built_in">SendMessage</span>(hwndDlg, WM_SETICON, ICON_SMALL, (LPARAM)<span class="built_in">LoadIcon</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_ICON_MAIN)));</span><br><span class="line">           <span class="comment">// 拖动时的光标句柄，正常情况下和拖动时的图像静态控件所用的图标句柄</span></span><br><span class="line">           hCursorDrag = <span class="built_in">LoadCursor</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDC_CURSOR_DRAG));</span><br><span class="line">           hIconNormal = <span class="built_in">LoadIcon</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_ICON_NORMAL));</span><br><span class="line">           hIconDrag = <span class="built_in">LoadIcon</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDI_ICON_DRAG));</span><br><span class="line">           <span class="comment">// 桌面设备环境，用于在目标窗口周围绘制闪动矩形</span></span><br><span class="line">           hdcDesk = <span class="built_in">CreateDC</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;DISPLAY&quot;</span>), <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">           <span class="built_in">SelectObject</span>(hdcDesk, <span class="built_in">CreatePen</span>(PS_SOLID, <span class="number">2</span>, <span class="built_in">RGB</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>)));</span><br><span class="line">           <span class="built_in">SetROP2</span>(hdcDesk, R2_NOTXORPEN);</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">           <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">               <span class="keyword">case</span> IDC_CHK_TOPMOST: &#123;</span><br><span class="line">                   <span class="comment">// 窗口置顶</span></span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">IsDlgButtonChecked</span>(hwndDlg, IDC_CHK_TOPMOST) == BST_CHECKED)</span><br><span class="line">                       <span class="built_in">SetWindowPos</span>(hwndDlg, HWND_TOPMOST, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, SWP_NOSIZE | SWP_NOMOVE);</span><br><span class="line">                   <span class="keyword">else</span></span><br><span class="line">                       <span class="built_in">SetWindowPos</span>(hwndDlg, HWND_NOTOPMOST, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, SWP_NOSIZE | SWP_NOMOVE);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> IDC_BTN_MODIFYTITLE: &#123;</span><br><span class="line">                   <span class="comment">// 修改标题</span></span><br><span class="line">                   nLen = <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_WINDOWTITLE), WM_GETTEXTLENGTH, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                   lpBuf = <span class="keyword">new</span> TCHAR[nLen + <span class="number">1</span>];</span><br><span class="line">                   <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_WINDOWTITLE), WM_GETTEXT, (nLen + <span class="number">1</span>), (LPARAM)lpBuf);</span><br><span class="line">                   <span class="built_in">SendMessage</span>(hwndTarget, WM_SETTEXT, <span class="number">0</span>, (LPARAM)lpBuf);</span><br><span class="line">                   <span class="keyword">delete</span>[] lpBuf;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">               <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                   <span class="built_in">DeleteDC</span>(hdcDesk);</span><br><span class="line">                   <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;;</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">case</span> WM_LBUTTONDOWN: &#123;</span><br><span class="line">           <span class="comment">// 开始拖动</span></span><br><span class="line">           <span class="built_in">GetWindowRect</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_STATIC_ICON), &amp;rect);</span><br><span class="line">           <span class="built_in">GetCursorPos</span>(&amp;pt);</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">PtInRect</span>(&amp;rect, pt)) &#123;</span><br><span class="line">               <span class="built_in">SetCapture</span>(hwndDlg);</span><br><span class="line">               <span class="built_in">SetCursor</span>(hCursorDrag);</span><br><span class="line">               <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_STATIC_ICON), STM_SETIMAGE, IMAGE_ICON, (LPARAM)hIconDrag);</span><br><span class="line">               <span class="built_in">SetTimer</span>(hwndDlg, <span class="number">1</span>, <span class="number">200</span>, <span class="literal">NULL</span>);</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">case</span> WM_LBUTTONUP: &#123;</span><br><span class="line">           <span class="comment">// 停止拖动</span></span><br><span class="line">           <span class="built_in">ReleaseCapture</span>();</span><br><span class="line">           <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_STATIC_ICON), STM_SETIMAGE, IMAGE_ICON, (LPARAM)hIconNormal);</span><br><span class="line">           <span class="built_in">KillTimer</span>(hwndDlg, <span class="number">1</span>);</span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="keyword">case</span> WM_TIMER: &#123;</span><br><span class="line">           <span class="built_in">GetCursorPos</span>(&amp;pt);</span><br><span class="line">           hwndTarget = <span class="built_in">SmallestWindowFromPoint</span>(pt);</span><br><span class="line">           <span class="comment">// 显示窗口句柄</span></span><br><span class="line">           <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;0x%08X&quot;</span>), (UINT_PTR)hwndTarget);</span><br><span class="line">           <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_WINDOWHANDLE, szBuf);</span><br><span class="line">           <span class="comment">// 显示窗口类名</span></span><br><span class="line">           <span class="built_in">GetClassName</span>(hwndTarget, szBuf, _countof(szBuf));</span><br><span class="line">           <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_CLASSNAME, szBuf);</span><br><span class="line">           <span class="comment">// 显示窗口过程</span></span><br><span class="line">           <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;0x%08X&quot;</span>), (ULONG_PTR)<span class="built_in">GetClassLongPtr</span>(hwndTarget, GCLP_WNDPROC));</span><br><span class="line">           <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_WNDPROC, szBuf);</span><br><span class="line">           <span class="comment">// 如果是子窗口控件，显示ID</span></span><br><span class="line">           <span class="keyword">if</span> (dwCtrlID = <span class="built_in">GetDlgCtrlID</span>(hwndTarget)) &#123;</span><br><span class="line">               <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;%d&quot;</span>), dwCtrlID);</span><br><span class="line">               <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_CONTROLID, szBuf);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_CONTROLID, <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">           <span class="comment">// 显示窗口标题</span></span><br><span class="line">           nLen = <span class="built_in">SendMessage</span>(hwndTarget, WM_GETTEXTLENGTH, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">           <span class="keyword">if</span> (nLen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               lpBuf = <span class="keyword">new</span> TCHAR[nLen + <span class="number">1</span>];</span><br><span class="line">               <span class="built_in">SendMessage</span>(hwndTarget, WM_GETTEXT, (nLen + <span class="number">1</span>), (LPARAM)lpBuf);</span><br><span class="line">               <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_WINDOWTITLE), WM_SETTEXT, <span class="number">0</span>, (LPARAM)lpBuf);</span><br><span class="line">               <span class="keyword">delete</span>[] lpBuf;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_WINDOWTITLE), WM_SETTEXT, <span class="number">0</span>, (LPARAM)<span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">           <span class="comment">// 显示进程ID</span></span><br><span class="line">           <span class="built_in">GetWindowThreadProcessId</span>(hwndTarget, &amp;dwProcessID);</span><br><span class="line">           <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;%d&quot;</span>), dwProcessID);</span><br><span class="line">           <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_PROCESSID, szBuf);</span><br><span class="line">           <span class="comment">// 显示父进程ID</span></span><br><span class="line">           <span class="keyword">if</span> ((dwParentProcessID = <span class="built_in">GetParentProcessIDByID</span>(dwProcessID)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;%d&quot;</span>), dwParentProcessID);</span><br><span class="line">               <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_PARENTPROCESSID, szBuf);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">               <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_PARENTPROCESSID, <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">           <span class="comment">// 目标窗口周围矩形闪动</span></span><br><span class="line">           <span class="built_in">GetWindowRect</span>(hwndTarget, &amp;rect);</span><br><span class="line">           <span class="keyword">if</span> (rect.left &lt; <span class="number">0</span>) rect.left = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span> (rect.top &lt; <span class="number">0</span>) rect.top = <span class="number">0</span>;</span><br><span class="line">           <span class="built_in">Rectangle</span>(hdcDesk, rect.left, rect.top, rect.right, rect.bottom);   <span class="comment">// 绘制洋红色矩形</span></span><br><span class="line">           <span class="built_in">Sleep</span>(<span class="number">200</span>);</span><br><span class="line">           <span class="built_in">Rectangle</span>(hdcDesk, rect.left, rect.top, rect.right, rect.bottom);   <span class="comment">// 擦除洋红色矩形</span></span><br><span class="line">           <span class="keyword">return</span> TRUE;</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">HWND <span class="title">SmallestWindowFromPoint</span><span class="params">(POINT pt)</span> </span>&#123;</span><br><span class="line">    RECT rect, rcTemp;</span><br><span class="line">    HWND hwnd, hwndParent, hwndTemp;</span><br><span class="line">    hwnd = <span class="built_in">WindowFromPoint</span>(pt);</span><br><span class="line">    <span class="keyword">if</span> (hwnd != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">GetWindowRect</span>(hwnd, &amp;rect);</span><br><span class="line">        hwndParent = <span class="built_in">GetParent</span>(hwnd);</span><br><span class="line">        <span class="comment">// 如果hwnd窗口具有父窗口</span></span><br><span class="line">        <span class="keyword">if</span> (hwndParent != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// 查找和hwnd同一级别的下一个Z顺序窗口</span></span><br><span class="line">            hwndTemp = hwnd;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                hwndTemp = <span class="built_in">GetWindow</span>(hwndTemp, GW_HWNDNEXT);</span><br><span class="line">                <span class="comment">// 如果找到的和hwnd同一级别的下一个Z顺序窗口 包含指定的坐标点pt并且可见</span></span><br><span class="line">                <span class="built_in">GetWindowRect</span>(hwndTemp, &amp;rcTemp);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">PtInRect</span>(&amp;rcTemp, pt) &amp;&amp; <span class="built_in">IsWindowVisible</span>(hwndTemp))</span><br><span class="line">                    <span class="comment">// 找到的窗口是不是比hwnd窗口更小</span></span><br><span class="line">                    <span class="keyword">if</span> (((rcTemp.right - rcTemp.left) * (rcTemp.bottom - rcTemp.top)) &lt; ((rect.right - rect.left) * (rect.bottom - rect.top))); &#123;</span><br><span class="line">                    hwnd = hwndTemp;</span><br><span class="line">                    <span class="built_in">GetWindowRect</span>(hwnd, &amp;rect);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (hwndTemp != <span class="literal">NULL</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> hwnd;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD <span class="title">GetParentProcessIDByID</span><span class="params">(DWORD dwProcessId)</span> </span>&#123;</span><br><span class="line">    HANDLE hSnapshot;</span><br><span class="line">    PROCESSENTRY32 pe = &#123; <span class="built_in">sizeof</span>(PROCESSENTRY32) &#125;;</span><br><span class="line">    BOOL bRet;</span><br><span class="line">    hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    bRet = <span class="built_in">Process32First</span>(hSnapshot, &amp;pe);</span><br><span class="line">    <span class="keyword">while</span> (bRet) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pe.th32ProcessID == dwProcessId)</span><br><span class="line">            <span class="keyword">return</span> pe.th32ParentProcessID;</span><br><span class="line">        bRet = <span class="built_in">Process32Next</span>(hSnapshot, &amp;pe);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="自删除"><a href="#自删除" class="headerlink" title="自删除"></a>自删除</h2><p>用ping实现延迟5秒，第一个del删除该.exe文件，第二个del %0删除该批处理。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    CHAR szApplicationName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;               <span class="comment">// 本程序文件路径</span></span><br><span class="line">    TCHAR szCmdPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;                      <span class="comment">// cmd.exe文件路径</span></span><br><span class="line">    TCHAR szBatFilePath[MAX_PATH];                          <span class="comment">// .bat文件路径</span></span><br><span class="line">    TCHAR szBatFileName[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;删除程序.bat&quot;</span>);   <span class="comment">// .bat文件名称</span></span><br><span class="line">    CHAR szBatFileContent[MAX_PATH * <span class="number">3</span>] = &#123; <span class="number">0</span> &#125;;            <span class="comment">// .bat文件内容</span></span><br><span class="line">    CHAR szBatFileContentFormat[MAX_PATH] = &#123; <span class="string">&quot;@ping 127.0.0.1 -n 5 &gt;nul\r\ndel \&quot;%s\&quot;\r\ndel %%0&quot;</span> &#125;;</span><br><span class="line">    HANDLE hFile;</span><br><span class="line">    TCHAR szCommandLine[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;/c &quot;</span>);            <span class="comment">// CreateProcess的lpCommandLine参数</span></span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    si.dwFlags = STARTF_USESHOWWINDOW;</span><br><span class="line">    si.wShowWindow = SW_HIDE;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL:</span><br><span class="line">                <span class="comment">// 本程序文件路径</span></span><br><span class="line">                <span class="built_in">GetModuleFileNameA</span>(<span class="literal">NULL</span>, szApplicationName, _countof(szApplicationName));</span><br><span class="line">                <span class="comment">// cmd.exe文件路径</span></span><br><span class="line">                <span class="built_in">GetEnvironmentVariable</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ComSpec&quot;</span>), szCmdPath, _countof(szCmdPath));</span><br><span class="line">                <span class="comment">// .bat文件路径，放到系统临时目录</span></span><br><span class="line">                <span class="built_in">GetTempPath</span>(_countof(szBatFilePath), szBatFilePath);</span><br><span class="line">                <span class="keyword">if</span> (szBatFilePath[_tcslen(szBatFilePath) - <span class="number">1</span>] != <span class="built_in">TEXT</span>(<span class="string">&#x27;\\&#x27;</span>))</span><br><span class="line">                    <span class="built_in">StringCchCat</span>(szBatFilePath, _countof(szBatFilePath), <span class="built_in">TEXT</span>(<span class="string">&quot;\\&quot;</span>));</span><br><span class="line">                <span class="built_in">StringCchCat</span>(szBatFilePath, _countof(szBatFilePath), szBatFileName);</span><br><span class="line">                <span class="comment">// 创建.bat文件，写入内容</span></span><br><span class="line">                hFile = <span class="built_in">CreateFile</span>(szBatFilePath, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="built_in">wsprintfA</span>(szBatFileContent, szBatFileContentFormat, szApplicationName);</span><br><span class="line">                <span class="built_in">WriteFile</span>(hFile, szBatFileContent, <span class="built_in">strlen</span>(szBatFileContent), <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">                <span class="comment">// 创建进程，执行.bat批处理文件</span></span><br><span class="line">                <span class="built_in">StringCchCat</span>(szCommandLine, _countof(szCommandLine), szBatFilePath);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">CreateProcess</span>(szCmdPath, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_NEW_CONSOLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi)) &#123;</span><br><span class="line">                    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">                    <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://Monoceros.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://monoceros.github.io/2024/07/08/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E8%BF%9B%E7%A8%8B/">http://monoceros.github.io/2024/07/08/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E8%BF%9B%E7%A8%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Monoceros.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">逆向工程</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/13/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%89%AA%E8%B4%B4%E6%9D%BF/" title="WindowsAPI查缺补漏-剪贴板"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">WindowsAPI查缺补漏-剪贴板</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/12/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%96%87%E4%BB%B6%E9%A9%B1%E5%8A%A8%E5%99%A8%E7%9B%AE%E5%BD%95/" title="WindowsAPI查缺补漏-文件驱动器目录"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">WindowsAPI查缺补漏-文件驱动器目录</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/16/Angr%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/" title="Angr做题笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="title">Angr做题笔记</div></div></a></div><div><a href="/2023/10/29/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%AC%94%E8%AE%B0/" title="Angr符号执行笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">Angr符号执行笔记</div></div></a></div><div><a href="/2023/11/09/C-%E7%97%85%E6%AF%92%E6%8A%80%E6%9C%AF/" title="C++病毒技术"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="title">C++病毒技术</div></div></a></div><div><a href="/2023/11/15/CvxPy%E6%95%B4%E6%95%B0%E8%A7%84%E5%88%92%E7%AC%94%E8%AE%B0/" title="CvxPy整数规划笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-15</div><div class="title">CvxPy整数规划笔记</div></div></a></div><div><a href="/2023/10/21/IDA%E5%9C%A8Kali-Linux%E4%B8%8B%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/" title="IDA在Kali Linux下的远程动态调试笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-21</div><div class="title">IDA在Kali Linux下的远程动态调试笔记</div></div></a></div><div><a href="/2023/10/29/IDA%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="IDA脚本编程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">IDA脚本编程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">智邮普创工作室安全组/Nepnep联合战队</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">289</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">QQ:1295625063（不找对象）</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">WindowsAPI查缺补漏-进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">创建进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ShellExecute"><span class="toc-number">1.1.1.</span> <span class="toc-text">ShellExecute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WinExec"><span class="toc-number">1.1.2.</span> <span class="toc-text">WinExec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CreateProcess"><span class="toc-number">1.1.3.</span> <span class="toc-text">CreateProcess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetStartupInfo"><span class="toc-number">1.1.4.</span> <span class="toc-text">GetStartupInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetModuleHandle"><span class="toc-number">1.1.5.</span> <span class="toc-text">GetModuleHandle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetModuleFileName"><span class="toc-number">1.1.6.</span> <span class="toc-text">GetModuleFileName</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetModuleFileNameEx"><span class="toc-number">1.1.7.</span> <span class="toc-text">GetModuleFileNameEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WaitForInputIdle"><span class="toc-number">1.1.8.</span> <span class="toc-text">WaitForInputIdle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetMappedFileName"><span class="toc-number">1.1.9.</span> <span class="toc-text">GetMappedFileName</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B%E9%97%B4%E5%85%B1%E4%BA%AB%E5%86%85%E6%A0%B8%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.</span> <span class="toc-text">多进程间共享内核对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GetCurrentProcess-GetCurrentThread"><span class="toc-number">1.2.1.</span> <span class="toc-text">GetCurrentProcess&#x2F;GetCurrentThread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetCurrentProcessId-GetCurrentThreadId"><span class="toc-number">1.2.2.</span> <span class="toc-text">GetCurrentProcessId&#x2F;GetCurrentThreadId</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetProcessId-GetThreadId"><span class="toc-number">1.2.3.</span> <span class="toc-text">GetProcessId&#x2F;GetThreadId</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenProcess"><span class="toc-number">1.2.4.</span> <span class="toc-text">OpenProcess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetProcessIdOfThread"><span class="toc-number">1.2.5.</span> <span class="toc-text">GetProcessIdOfThread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DuplicateHandle"><span class="toc-number">1.2.6.</span> <span class="toc-text">DuplicateHandle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%BB%88%E6%AD%A2"><span class="toc-number">1.3.</span> <span class="toc-text">进程终止</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ExitProcess"><span class="toc-number">1.3.1.</span> <span class="toc-text">ExitProcess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TerminateProcess"><span class="toc-number">1.3.2.</span> <span class="toc-text">TerminateProcess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetExitCodeProcess"><span class="toc-number">1.3.3.</span> <span class="toc-text">GetExitCodeProcess</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">1.4.</span> <span class="toc-text">进程间通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WM-COPYDATA%E6%B3%95"><span class="toc-number">1.4.1.</span> <span class="toc-text">WM_COPYDATA法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FindWindow"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">FindWindow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StringCchPrintf"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">StringCchPrintf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93%E6%B3%95"><span class="toc-number">1.4.2.</span> <span class="toc-text">匿名管道法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CreatePipe"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">CreatePipe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93%E6%B3%95"><span class="toc-number">1.4.3.</span> <span class="toc-text">命名管道法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%AE%E4%BB%B6%E6%A7%BD%E6%B3%95"><span class="toc-number">1.4.4.</span> <span class="toc-text">邮件槽法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateMailslot"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">CreateMailslot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GetMailslotInfo"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">GetMailslotInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-2"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%9E%9A%E4%B8%BE"><span class="toc-number">1.5.</span> <span class="toc-text">进程枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TlHelp32%E6%B3%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">TlHelp32法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateToolhelp32Snapshot"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">CreateToolhelp32Snapshot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Process32First-Process32Next"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">Process32First&#x2F;Process32Next</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#QueryFullProcessImageName"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">QueryFullProcessImageName</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenProcessToken"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">OpenProcessToken</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LookupPrivilegeValue"><span class="toc-number">1.5.1.5.</span> <span class="toc-text">LookupPrivilegeValue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AdjustTokenPrivileges"><span class="toc-number">1.5.1.6.</span> <span class="toc-text">AdjustTokenPrivileges</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-3"><span class="toc-number">1.5.1.7.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnumProcesses%E6%B3%95"><span class="toc-number">1.5.2.</span> <span class="toc-text">EnumProcesses法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EnumProceses"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">EnumProceses</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQueryInformationProcess-ZwQueryInformationProcess"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">NtQueryInformationProcess&#x2F;ZwQueryInformationProcess</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%85%B3%E9%94%AE%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.6.</span> <span class="toc-text">系统关键进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadLibrary"><span class="toc-number">1.6.1.</span> <span class="toc-text">LoadLibrary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadLibraryEx"><span class="toc-number">1.6.2.</span> <span class="toc-text">LoadLibraryEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FreeLibrary"><span class="toc-number">1.6.3.</span> <span class="toc-text">FreeLibrary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetProcAddress"><span class="toc-number">1.6.4.</span> <span class="toc-text">GetProcAddress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RtlSetProcessIsCritical"><span class="toc-number">1.6.5.</span> <span class="toc-text">RtlSetProcessIsCritical</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-4"><span class="toc-number">1.6.6.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%8E%AF%E5%A2%83%E5%9D%97PEB"><span class="toc-number">1.7.</span> <span class="toc-text">进程环境块PEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ldr%E5%AD%97%E6%AE%B5"><span class="toc-number">1.7.1.</span> <span class="toc-text">Ldr字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessParameters%E5%AD%97%E6%AE%B5"><span class="toc-number">1.7.2.</span> <span class="toc-text">ProcessParameters字段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E8%AF%95"><span class="toc-number">1.8.</span> <span class="toc-text">进程调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%A9%BA%E9%97%B4%E8%AF%BB%E5%86%99"><span class="toc-number">1.8.1.</span> <span class="toc-text">进程空间读写</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ReadProcessMemory"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">ReadProcessMemory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WriteProcessMemory"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">WriteProcessMemory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-5"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">1.8.2.</span> <span class="toc-text">获取模块基地址</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EnumProcessModules%E6%B3%95"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">EnumProcessModules法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VirtualQueryEx%E6%B3%95"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">VirtualQueryEx法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GetSystemInfo%E6%B3%95"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">GetSystemInfo法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95API"><span class="toc-number">1.9.</span> <span class="toc-text">调试API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DebugActiveProcess"><span class="toc-number">1.9.1.</span> <span class="toc-text">DebugActiveProcess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DebugActiveProcessStop"><span class="toc-number">1.9.2.</span> <span class="toc-text">DebugActiveProcessStop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WaitForDebugEvent"><span class="toc-number">1.9.3.</span> <span class="toc-text">WaitForDebugEvent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ContinueDebugEvent"><span class="toc-number">1.9.4.</span> <span class="toc-text">ContinueDebugEvent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-6"><span class="toc-number">1.9.5.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-7"><span class="toc-number">1.9.6.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-8"><span class="toc-number">1.9.7.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%8E%AF%E5%A2%83"><span class="toc-number">1.10.</span> <span class="toc-text">线程环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GetThreadContext-SetThreadContext"><span class="toc-number">1.10.1.</span> <span class="toc-text">GetThreadContext&#x2F;SetThreadContext</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spy"><span class="toc-number">1.11.</span> <span class="toc-text">Spy++</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WindowFromPoint"><span class="toc-number">1.11.1.</span> <span class="toc-text">WindowFromPoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetParent"><span class="toc-number">1.11.2.</span> <span class="toc-text">GetParent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetWindow"><span class="toc-number">1.11.3.</span> <span class="toc-text">GetWindow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GetWindowThreadProcessId"><span class="toc-number">1.11.4.</span> <span class="toc-text">GetWindowThreadProcessId</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-9"><span class="toc-number">1.11.5.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%88%A0%E9%99%A4"><span class="toc-number">1.12.</span> <span class="toc-text">自删除</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-DEX%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%9D%E6%8E%A2/" title="安卓逆向入门-DEX文件格式初探">安卓逆向入门-DEX文件格式初探</a><time datetime="2024-10-28T11:03:36.000Z" title="发表于 2024-10-28 19:03:36">2024-10-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Unidbg%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Unidbg入门">安卓逆向入门-Unidbg入门</a><time datetime="2024-10-28T11:02:59.000Z" title="发表于 2024-10-28 19:02:59">2024-10-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Unicorn%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Unicorn入门">安卓逆向入门-Unicorn入门</a><time datetime="2024-10-28T11:02:18.000Z" title="发表于 2024-10-28 19:02:18">2024-10-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Frida%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Frida入门">安卓逆向入门-Frida入门</a><time datetime="2024-10-28T11:01:16.000Z" title="发表于 2024-10-28 19:01:16">2024-10-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-%E5%AE%89%E5%85%A8%E5%9F%BA%E7%BA%BF/" title="安卓逆向入门-安全基线">安卓逆向入门-安全基线</a><time datetime="2024-10-28T11:00:42.000Z" title="发表于 2024-10-28 19:00:42">2024-10-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>