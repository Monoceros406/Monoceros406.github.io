<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Windows软件调试初探-进程与线程 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Windows软件调试初探-进程与线程进程资源每个进程都有这些资源：  一个虚拟地址空间。 全局唯一Cid，即PID。 一个可执行映像，即该进程可执行文件在内存中的表示。 一个或多个线程。 一个内核空间中的EPROCESS。 一个内核空间中的对象句柄表。 一个用于描述内存目录表起始位置的基地址，即页目录基地址DirBase。当CPU切换到该进程时，将该地址加载到页表基地址寄存器如CR3或TTBR，">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows软件调试初探-进程与线程">
<meta property="og:url" content="http://monoceros.github.io/2024/07/18/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="Windows软件调试初探-进程与线程进程资源每个进程都有这些资源：  一个虚拟地址空间。 全局唯一Cid，即PID。 一个可执行映像，即该进程可执行文件在内存中的表示。 一个或多个线程。 一个内核空间中的EPROCESS。 一个内核空间中的对象句柄表。 一个用于描述内存目录表起始位置的基地址，即页目录基地址DirBase。当CPU切换到该进程时，将该地址加载到页表基地址寄存器如CR3或TTBR，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://monoceros.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-07-18T02:03:59.000Z">
<meta property="article:modified_time" content="2024-08-13T02:25:24.088Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="逆向工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://monoceros.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://monoceros.github.io/2024/07/18/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Windows软件调试初探-进程与线程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-13 10:25:24'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">263</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Windows软件调试初探-进程与线程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-18T02:03:59.000Z" title="发表于 2024-07-18 10:03:59">2024-07-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-13T02:25:24.088Z" title="更新于 2024-08-13 10:25:24">2024-08-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Windows软件调试初探-进程与线程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Windows软件调试初探-进程与线程"><a href="#Windows软件调试初探-进程与线程" class="headerlink" title="Windows软件调试初探-进程与线程"></a>Windows软件调试初探-进程与线程</h1><h2 id="进程资源"><a href="#进程资源" class="headerlink" title="进程资源"></a>进程资源</h2><p>每个进程都有这些资源：</p>
<ul>
<li>一个虚拟地址空间。</li>
<li>全局唯一Cid，即PID。</li>
<li>一个可执行映像，即该进程可执行文件在内存中的表示。</li>
<li>一个或多个线程。</li>
<li>一个内核空间中的EPROCESS。</li>
<li>一个内核空间中的对象句柄表。</li>
<li>一个用于描述内存目录表起始位置的基地址，即页目录基地址DirBase。当CPU切换到该进程时，将该地址加载到页表基地址寄存器如CR3或TTBR，再由RVA翻译为正确物理地址。</li>
<li>一个用户空间中的PEB。</li>
<li>一个访问令牌。</li>
</ul>
<p>例如列出系统所有进程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">6: kd&gt; !process 0 0</span><br><span class="line">**** NT ACTIVE PROCESS DUMP ****</span><br><span class="line">PROCESS ffff84898203c440</span><br><span class="line">    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000</span><br><span class="line">    DirBase: 001ad002  ObjectTable: ffffe18f2b814040  HandleCount: 2564.</span><br><span class="line">    Image: System</span><br><span class="line"></span><br><span class="line">PROCESS ffff8489820c6040</span><br><span class="line">    SessionId: none  Cid: 0078    Peb: 00000000  ParentCid: 0004</span><br><span class="line">    DirBase: 99d00002  ObjectTable: ffffe18f2b825b80  HandleCount:   0.</span><br><span class="line">    Image: Registry</span><br><span class="line"></span><br><span class="line">PROCESS ffff84898205d040</span><br><span class="line">    SessionId: none  Cid: 01e0    Peb: 3062840000  ParentCid: 0004</span><br><span class="line">    DirBase: 77100002  ObjectTable: ffffe18f2c1ab340  HandleCount:  52.</span><br><span class="line">    Image: smss.exe</span><br><span class="line">...</span><br><span class="line">6: kd&gt; !process 0 0 wermgr.exe</span><br><span class="line">PROCESS ffff84899855d580</span><br><span class="line">    SessionId: 0  Cid: 1840    Peb: cd79837000  ParentCid: 0644</span><br><span class="line">    DirBase: 173e00002  ObjectTable: ffffe18f347c0d80  HandleCount:  16.</span><br><span class="line">    Image: wermgr.exe</span><br></pre></td></tr></table></figure>

<p>DirBase的高20位为该进程页目录的页帧编号PFN，低12位含义因CR4的PCIDE位第17位不同。PCIDE位1时CPU缓存多个进程页表信息，低12位为进程上下文ID。为应对CPU的Meltdown和Spectry漏洞，NT内核引入KVA影子安全补丁，启用PCIDE功能。</p>
<p>例如：启用了KVA影子，使用模式1，该模式要求PCID功能支持。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">6: kd&gt; dd nt!KiKvaShadow L1</span><br><span class="line">fffff800`06465840  00000001</span><br><span class="line">6: kd&gt; dd nt!KiKvaShadowMode L1</span><br><span class="line">fffff800`0644e4f8  00000001</span><br><span class="line">6: kd&gt; dd nt!KiFlushPcid L1</span><br><span class="line">fffff800`0644e249  00000001</span><br><span class="line">6: kd&gt; .formats cr4</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     00000000`00170778</span><br><span class="line">  Decimal: 1509240</span><br><span class="line">  Octal:   0000000000000005603570</span><br><span class="line">  Binary:  00000000 00000000 00000000 00000000 00000000 00010111 00000111 01111000</span><br><span class="line">  Chars:   .......x</span><br><span class="line">  Time:    Sun Jan 18 19:14:00 1970</span><br><span class="line">  Float:   low 2.1149e-039 high 0</span><br><span class="line">  Double:  7.45664e-318</span><br></pre></td></tr></table></figure>

<p>已知PFN后，用以下命令列出物理地址到RVA间映射：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!ptov 1f350</span><br></pre></td></tr></table></figure>

<h2 id="EPROCESS结构"><a href="#EPROCESS结构" class="headerlink" title="EPROCESS结构"></a>EPROCESS结构</h2><p>结构定义如下，这玩意儿变得很勤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line">6: kd&gt; dt _EPROCESS</span><br><span class="line">nt!_EPROCESS</span><br><span class="line">   +0x000 Pcb              : _KPROCESS //内核进程块 与任务调度有关</span><br><span class="line">   +0x2d8 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x2e0 UniqueProcessId  : Ptr64 Void //进程ID</span><br><span class="line">   +0x2e8 ActiveProcessLinks : _LIST_ENTRY</span><br><span class="line">   +0x2f8 RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +0x300 Flags2           : Uint4B</span><br><span class="line">   +0x300 JobNotReallyActive : Pos 0, 1 Bit</span><br><span class="line">   +0x300 AccountingFolded : Pos 1, 1 Bit</span><br><span class="line">   +0x300 NewProcessReported : Pos 2, 1 Bit</span><br><span class="line">   +0x300 ExitProcessReported : Pos 3, 1 Bit</span><br><span class="line">   +0x300 ReportCommitChanges : Pos 4, 1 Bit</span><br><span class="line">   +0x300 LastReportMemory : Pos 5, 1 Bit</span><br><span class="line">   +0x300 ForceWakeCharge  : Pos 6, 1 Bit</span><br><span class="line">   +0x300 CrossSessionCreate : Pos 7, 1 Bit</span><br><span class="line">   +0x300 NeedsHandleRundown : Pos 8, 1 Bit</span><br><span class="line">   +0x300 RefTraceEnabled  : Pos 9, 1 Bit</span><br><span class="line">   +0x300 PicoCreated      : Pos 10, 1 Bit</span><br><span class="line">   +0x300 EmptyJobEvaluated : Pos 11, 1 Bit</span><br><span class="line">   +0x300 DefaultPagePriority : Pos 12, 3 Bits</span><br><span class="line">   +0x300 PrimaryTokenFrozen : Pos 15, 1 Bit</span><br><span class="line">   +0x300 ProcessVerifierTarget : Pos 16, 1 Bit</span><br><span class="line">   +0x300 RestrictSetThreadContext : Pos 17, 1 Bit</span><br><span class="line">   +0x300 AffinityPermanent : Pos 18, 1 Bit</span><br><span class="line">   +0x300 AffinityUpdateEnable : Pos 19, 1 Bit</span><br><span class="line">   +0x300 PropagateNode    : Pos 20, 1 Bit</span><br><span class="line">   +0x300 ExplicitAffinity : Pos 21, 1 Bit</span><br><span class="line">   +0x300 ProcessExecutionState : Pos 22, 2 Bits</span><br><span class="line">   +0x300 EnableReadVmLogging : Pos 24, 1 Bit</span><br><span class="line">   +0x300 EnableWriteVmLogging : Pos 25, 1 Bit</span><br><span class="line">   +0x300 FatalAccessTerminationRequested : Pos 26, 1 Bit</span><br><span class="line">   +0x300 DisableSystemAllowedCpuSet : Pos 27, 1 Bit</span><br><span class="line">   +0x300 ProcessStateChangeRequest : Pos 28, 2 Bits</span><br><span class="line">   +0x300 ProcessStateChangeInProgress : Pos 30, 1 Bit</span><br><span class="line">   +0x300 InPrivate        : Pos 31, 1 Bit</span><br><span class="line">   +0x304 Flags            : Uint4B</span><br><span class="line">   +0x304 CreateReported   : Pos 0, 1 Bit</span><br><span class="line">   +0x304 NoDebugInherit   : Pos 1, 1 Bit</span><br><span class="line">   +0x304 ProcessExiting   : Pos 2, 1 Bit //正在退出标志</span><br><span class="line">   +0x304 ProcessDelete    : Pos 3, 1 Bit //删除标志</span><br><span class="line">   +0x304 ManageExecutableMemoryWrites : Pos 4, 1 Bit</span><br><span class="line">   +0x304 VmDeleted        : Pos 5, 1 Bit</span><br><span class="line">   +0x304 OutswapEnabled   : Pos 6, 1 Bit</span><br><span class="line">   +0x304 Outswapped       : Pos 7, 1 Bit</span><br><span class="line">   +0x304 FailFastOnCommitFail : Pos 8, 1 Bit</span><br><span class="line">   +0x304 Wow64VaSpace4Gb  : Pos 9, 1 Bit</span><br><span class="line">   +0x304 AddressSpaceInitialized : Pos 10, 2 Bits</span><br><span class="line">   +0x304 SetTimerResolution : Pos 12, 1 Bit</span><br><span class="line">   +0x304 BreakOnTermination : Pos 13, 1 Bit</span><br><span class="line">   +0x304 DeprioritizeViews : Pos 14, 1 Bit</span><br><span class="line">   +0x304 WriteWatch       : Pos 15, 1 Bit</span><br><span class="line">   +0x304 ProcessInSession : Pos 16, 1 Bit</span><br><span class="line">   +0x304 OverrideAddressSpace : Pos 17, 1 Bit</span><br><span class="line">   +0x304 HasAddressSpace  : Pos 18, 1 Bit</span><br><span class="line">   +0x304 LaunchPrefetched : Pos 19, 1 Bit</span><br><span class="line">   +0x304 Background       : Pos 20, 1 Bit</span><br><span class="line">   +0x304 VmTopDown        : Pos 21, 1 Bit</span><br><span class="line">   +0x304 ImageNotifyDone  : Pos 22, 1 Bit</span><br><span class="line">   +0x304 PdeUpdateNeeded  : Pos 23, 1 Bit</span><br><span class="line">   +0x304 VdmAllowed       : Pos 24, 1 Bit</span><br><span class="line">   +0x304 ProcessRundown   : Pos 25, 1 Bit</span><br><span class="line">   +0x304 ProcessInserted  : Pos 26, 1 Bit</span><br><span class="line">   +0x304 DefaultIoPriority : Pos 27, 3 Bits</span><br><span class="line">   +0x304 ProcessSelfDelete : Pos 30, 1 Bit</span><br><span class="line">   +0x304 SetTimerResolutionLink : Pos 31, 1 Bit</span><br><span class="line">   +0x308 CreateTime       : _LARGE_INTEGER //创建时间</span><br><span class="line">   +0x310 ProcessQuotaUsage : [2] Uint8B</span><br><span class="line">   +0x320 ProcessQuotaPeak : [2] Uint8B</span><br><span class="line">   +0x330 PeakVirtualSize  : Uint8B</span><br><span class="line">   +0x338 VirtualSize      : Uint8B</span><br><span class="line">   +0x340 SessionProcessLinks : _LIST_ENTRY</span><br><span class="line">   +0x350 ExceptionPortData : Ptr64 Void //异常端口</span><br><span class="line">   +0x350 ExceptionPortValue : Uint8B</span><br><span class="line">   +0x350 ExceptionPortState : Pos 0, 3 Bits</span><br><span class="line">   +0x358 Token            : _EX_FAST_REF //访问令牌</span><br><span class="line">   +0x360 MmReserved       : Uint8B</span><br><span class="line">   +0x368 AddressCreationLock : _EX_PUSH_LOCK</span><br><span class="line">   +0x370 PageTableCommitmentLock : _EX_PUSH_LOCK</span><br><span class="line">   +0x378 RotateInProgress : Ptr64 _ETHREAD</span><br><span class="line">   +0x380 ForkInProgress   : Ptr64 _ETHREAD</span><br><span class="line">   +0x388 CommitChargeJob  : Ptr64 _EJOB</span><br><span class="line">   +0x390 CloneRoot        : _RTL_AVL_TREE</span><br><span class="line">   +0x398 NumberOfPrivatePages : Uint8B</span><br><span class="line">   +0x3a0 NumberOfLockedPages : Uint8B</span><br><span class="line">   +0x3a8 Win32Process     : Ptr64 Void</span><br><span class="line">   +0x3b0 Job              : Ptr64 _EJOB</span><br><span class="line">   +0x3b8 SectionObject    : Ptr64 Void</span><br><span class="line">   +0x3c0 SectionBaseAddress : Ptr64 Void</span><br><span class="line">   +0x3c8 Cookie           : Uint4B</span><br><span class="line">   +0x3d0 WorkingSetWatch  : Ptr64 _PAGEFAULT_HISTORY</span><br><span class="line">   +0x3d8 Win32WindowStation : Ptr64 Void</span><br><span class="line">   +0x3e0 InheritedFromUniqueProcessId : Ptr64 Void</span><br><span class="line">   +0x3e8 LdtInformation   : Ptr64 Void</span><br><span class="line">   +0x3f0 OwnerProcessId   : Uint8B</span><br><span class="line">   +0x3f8 Peb              : Ptr64 _PEB //进程环境块</span><br><span class="line">   +0x400 Session          : Ptr64 _MM_SESSION_SPACE //所属会话对象</span><br><span class="line">   +0x408 AweInfo          : Ptr64 Void</span><br><span class="line">   +0x410 QuotaBlock       : Ptr64 _EPROCESS_QUOTA_BLOCK</span><br><span class="line">   +0x418 ObjectTable      : Ptr64 _HANDLE_TABLE //对象句柄表</span><br><span class="line">   +0x420 DebugPort        : Ptr64 Void //用户态调试端口</span><br><span class="line">   +0x428 WoW64Process     : Ptr64 _EWOW64PROCESS</span><br><span class="line">   +0x430 DeviceMap        : Ptr64 Void</span><br><span class="line">   +0x438 EtwDataSource    : Ptr64 Void</span><br><span class="line">   +0x440 PageDirectoryPte : Uint8B</span><br><span class="line">   +0x448 ImageFilePointer : Ptr64 _FILE_OBJECT</span><br><span class="line">   +0x450 ImageFileName    : [15] UChar</span><br><span class="line">   +0x45f PriorityClass    : UChar</span><br><span class="line">   +0x460 SecurityPort     : Ptr64 Void</span><br><span class="line">   +0x468 SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO</span><br><span class="line">   +0x470 JobLinks         : _LIST_ENTRY</span><br><span class="line">   +0x480 HighestUserAddress : Ptr64 Void</span><br><span class="line">   +0x488 ThreadListHead   : _LIST_ENTRY //线程列表</span><br><span class="line">   +0x498 ActiveThreads    : Uint4B</span><br><span class="line">   +0x49c ImagePathHash    : Uint4B</span><br><span class="line">   +0x4a0 DefaultHardErrorProcessing : Uint4B</span><br><span class="line">   +0x4a4 LastThreadExitStatus : Int4B</span><br><span class="line">   +0x4a8 PrefetchTrace    : _EX_FAST_REF</span><br><span class="line">   +0x4b0 LockedPagesList  : Ptr64 Void</span><br><span class="line">   +0x4b8 ReadOperationCount : _LARGE_INTEGER</span><br><span class="line">   +0x4c0 WriteOperationCount : _LARGE_INTEGER</span><br><span class="line">   +0x4c8 OtherOperationCount : _LARGE_INTEGER</span><br><span class="line">   +0x4d0 ReadTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x4d8 WriteTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x4e0 OtherTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x4e8 CommitChargeLimit : Uint8B</span><br><span class="line">   +0x4f0 CommitCharge     : Uint8B</span><br><span class="line">   +0x4f8 CommitChargePeak : Uint8B</span><br><span class="line">   +0x500 Vm               : _MMSUPPORT_FULL</span><br><span class="line">   +0x610 MmProcessLinks   : _LIST_ENTRY</span><br><span class="line">   +0x620 ModifiedPageCount : Uint4B</span><br><span class="line">   +0x624 ExitStatus       : Int4B</span><br><span class="line">   +0x628 VadRoot          : _RTL_AVL_TREE //虚拟地址描述符VAD 用!vad查看</span><br><span class="line">   +0x630 VadHint          : Ptr64 Void</span><br><span class="line">   +0x638 VadCount         : Uint8B</span><br><span class="line">   +0x640 VadPhysicalPages : Uint8B</span><br><span class="line">   +0x648 VadPhysicalPagesLimit : Uint8B</span><br><span class="line">   +0x650 AlpcContext      : _ALPC_PROCESS_CONTEXT</span><br><span class="line">   +0x670 TimerResolutionLink : _LIST_ENTRY</span><br><span class="line">   +0x680 TimerResolutionStackRecord : Ptr64 _PO_DIAG_STACK_RECORD</span><br><span class="line">   +0x688 RequestedTimerResolution : Uint4B</span><br><span class="line">   +0x68c SmallestTimerResolution : Uint4B</span><br><span class="line">   +0x690 ExitTime         : _LARGE_INTEGER //退出时间</span><br><span class="line">   +0x698 InvertedFunctionTable : Ptr64 _INVERTED_FUNCTION_TABLE</span><br><span class="line">   +0x6a0 InvertedFunctionTableLock : _EX_PUSH_LOCK</span><br><span class="line">   +0x6a8 ActiveThreadsHighWatermark : Uint4B</span><br><span class="line">   +0x6ac LargePrivateVadCount : Uint4B</span><br><span class="line">   +0x6b0 ThreadListLock   : _EX_PUSH_LOCK</span><br><span class="line">   +0x6b8 WnfContext       : Ptr64 Void</span><br><span class="line">   +0x6c0 ServerSilo       : Ptr64 _EJOB</span><br><span class="line">   +0x6c8 SignatureLevel   : UChar</span><br><span class="line">   +0x6c9 SectionSignatureLevel : UChar</span><br><span class="line">   +0x6ca Protection       : _PS_PROTECTION</span><br><span class="line">   +0x6cb HangCount        : Pos 0, 4 Bits</span><br><span class="line">   +0x6cb GhostCount       : Pos 4, 4 Bits</span><br><span class="line">   +0x6cc Flags3           : Uint4B</span><br><span class="line">   +0x6cc Minimal          : Pos 0, 1 Bit</span><br><span class="line">   +0x6cc ReplacingPageRoot : Pos 1, 1 Bit</span><br><span class="line">   +0x6cc Crashed          : Pos 2, 1 Bit</span><br><span class="line">   +0x6cc JobVadsAreTracked : Pos 3, 1 Bit</span><br><span class="line">   +0x6cc VadTrackingDisabled : Pos 4, 1 Bit</span><br><span class="line">   +0x6cc AuxiliaryProcess : Pos 5, 1 Bit</span><br><span class="line">   +0x6cc SubsystemProcess : Pos 6, 1 Bit</span><br><span class="line">   +0x6cc IndirectCpuSets  : Pos 7, 1 Bit</span><br><span class="line">   +0x6cc RelinquishedCommit : Pos 8, 1 Bit</span><br><span class="line">   +0x6cc HighGraphicsPriority : Pos 9, 1 Bit</span><br><span class="line">   +0x6cc CommitFailLogged : Pos 10, 1 Bit</span><br><span class="line">   +0x6cc ReserveFailLogged : Pos 11, 1 Bit</span><br><span class="line">   +0x6cc SystemProcess    : Pos 12, 1 Bit</span><br><span class="line">   +0x6cc HideImageBaseAddresses : Pos 13, 1 Bit</span><br><span class="line">   +0x6cc AddressPolicyFrozen : Pos 14, 1 Bit</span><br><span class="line">   +0x6cc ProcessFirstResume : Pos 15, 1 Bit</span><br><span class="line">   +0x6cc ForegroundExternal : Pos 16, 1 Bit</span><br><span class="line">   +0x6cc ForegroundSystem : Pos 17, 1 Bit</span><br><span class="line">   +0x6cc HighMemoryPriority : Pos 18, 1 Bit</span><br><span class="line">   +0x6d0 DeviceAsid       : Int4B</span><br><span class="line">   +0x6d8 SvmData          : Ptr64 Void</span><br><span class="line">   +0x6e0 SvmProcessLock   : _EX_PUSH_LOCK</span><br><span class="line">   +0x6e8 SvmLock          : Uint8B</span><br><span class="line">   +0x6f0 SvmProcessDeviceListHead : _LIST_ENTRY</span><br><span class="line">   +0x700 LastFreezeInterruptTime : Uint8B</span><br><span class="line">   +0x708 DiskCounters     : Ptr64 _PROCESS_DISK_COUNTERS</span><br><span class="line">   +0x710 PicoContext      : Ptr64 Void</span><br><span class="line">   +0x718 TrustletIdentity : Uint8B</span><br><span class="line">   +0x720 EnclaveTable     : Ptr64 Void</span><br><span class="line">   +0x728 EnclaveNumber    : Uint8B</span><br><span class="line">   +0x730 EnclaveLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x738 HighPriorityFaultsAllowed : Uint4B</span><br><span class="line">   +0x740 EnergyContext    : Ptr64 _PO_PROCESS_ENERGY_CONTEXT</span><br><span class="line">   +0x748 VmContext        : Ptr64 Void</span><br><span class="line">   +0x750 SequenceNumber   : Uint8B</span><br><span class="line">   +0x758 CreateInterruptTime : Uint8B</span><br><span class="line">   +0x760 CreateUnbiasedInterruptTime : Uint8B</span><br><span class="line">   +0x768 TotalUnbiasedFrozenTime : Uint8B</span><br><span class="line">   +0x770 LastAppStateUpdateTime : Uint8B</span><br><span class="line">   +0x778 LastAppStateUptime : Pos 0, 61 Bits</span><br><span class="line">   +0x778 LastAppState     : Pos 61, 3 Bits</span><br><span class="line">   +0x780 SharedCommitCharge : Uint8B</span><br><span class="line">   +0x788 SharedCommitLock : _EX_PUSH_LOCK</span><br><span class="line">   +0x790 SharedCommitLinks : _LIST_ENTRY</span><br><span class="line">   +0x7a0 AllowedCpuSets   : Uint8B</span><br><span class="line">   +0x7a8 DefaultCpuSets   : Uint8B</span><br><span class="line">   +0x7a0 AllowedCpuSetsIndirect : Ptr64 Uint8B</span><br><span class="line">   +0x7a8 DefaultCpuSetsIndirect : Ptr64 Uint8B</span><br><span class="line">   +0x7b0 DiskIoAttribution : Ptr64 Void</span><br><span class="line">   +0x7b8 DxgProcess       : Ptr64 Void</span><br><span class="line">   +0x7c0 Win32KFilterSet  : Uint4B</span><br><span class="line">   +0x7c8 ProcessTimerDelay : _PS_INTERLOCKED_TIMER_DELAY_VALUES</span><br><span class="line">   +0x7d0 KTimerSets       : Uint4B</span><br><span class="line">   +0x7d4 KTimer2Sets      : Uint4B</span><br><span class="line">   +0x7d8 ThreadTimerSets  : Uint4B</span><br><span class="line">   +0x7e0 VirtualTimerListLock : Uint8B</span><br><span class="line">   +0x7e8 VirtualTimerListHead : _LIST_ENTRY</span><br><span class="line">   +0x7f8 WakeChannel      : _WNF_STATE_NAME</span><br><span class="line">   +0x7f8 WakeInfo         : _PS_PROCESS_WAKE_INFORMATION</span><br><span class="line">   +0x828 MitigationFlags  : Uint4B</span><br><span class="line">   +0x828 MitigationFlagsValues : &lt;unnamed-tag&gt;</span><br><span class="line">   +0x82c MitigationFlags2 : Uint4B</span><br><span class="line">   +0x82c MitigationFlags2Values : &lt;unnamed-tag&gt;</span><br><span class="line">   +0x830 PartitionObject  : Ptr64 Void</span><br><span class="line">   +0x838 SecurityDomain   : Uint8B</span><br><span class="line">   +0x840 CoverageSamplerContext : Ptr64 Void</span><br></pre></td></tr></table></figure>

<p>显示某个进程关键信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">6: kd&gt; !process ffff84898fdf1080</span><br><span class="line">PROCESS ffff84898fdf1080</span><br><span class="line">    SessionId: 0  Cid: 1430    Peb: 65e5a30000  ParentCid: 0398</span><br><span class="line">    DirBase: 438650002  ObjectTable: ffffe18f306d8100  HandleCount: 132.</span><br><span class="line">    Image: WmiApSrv.exe</span><br><span class="line">    VadRoot ffff84898fdf7a30 Vads 56 Clone 0 Private 306. Modified 3. Locked 0.</span><br><span class="line">    DeviceMap ffffe18f2b818ad0</span><br><span class="line">    Token                             ffffe18f306d4060</span><br><span class="line">    ElapsedTime                       00:00:11.319</span><br><span class="line">    UserTime                          00:00:00.000</span><br><span class="line">    KernelTime                        00:00:00.000</span><br><span class="line">    QuotaPoolUsage[PagedPool]         61072</span><br><span class="line">    QuotaPoolUsage[NonPagedPool]      7880</span><br><span class="line">    Working Set Sizes (now,min,max)  (1592, 50, 345) (6368KB, 200KB, 1380KB)</span><br><span class="line">    PeakWorkingSetSize                1536</span><br><span class="line">    VirtualSize                       2101312 Mb</span><br><span class="line">    PeakVirtualSize                   2101312 Mb</span><br><span class="line">    PageFaultCount                    1602</span><br><span class="line">    MemoryPriority                    BACKGROUND</span><br><span class="line">    BasePriority                      8</span><br><span class="line">    CommitCharge                      349</span><br><span class="line"></span><br><span class="line">        THREAD ffff84898fdf2080  Cid 1430.1434  Teb: 00000065e5a31000 Win32Thread: 0000000000000000 WAIT: (UserRequest) UserMode Non-Alertable</span><br><span class="line">            ffff84898fdaaf40  SynchronizationEvent</span><br><span class="line">        Not impersonating</span><br><span class="line">        DeviceMap                 ffffe18f2b818ad0</span><br><span class="line">        Owning Process            ffff84898fdf1080       Image:         WmiApSrv.exe</span><br><span class="line">        Attached Process          N/A            Image:         N/A</span><br><span class="line">        Wait Start TickCount      787            Ticks: 719 (0:00:00:11.234)</span><br><span class="line">        Context Switch Count      66             IdealProcessor: 3             </span><br><span class="line">        UserTime                  00:00:00.000</span><br><span class="line">        KernelTime                00:00:00.015</span><br><span class="line">        Win32 Start Address 0x00007ff7666696a0</span><br><span class="line">        Stack Init ffff978957a17b90 Current ffff978957a175c0</span><br><span class="line">        Base ffff978957a18000 Limit ffff978957a11000 Call 0000000000000000</span><br><span class="line">        Priority 9 BasePriority 8 PriorityDecrement 0 IoPriority 2 PagePriority 5</span><br><span class="line">        Child-SP          RetAddr               Call Site</span><br><span class="line">        ffff9789`57a17600 fffff800`060395d6     nt!KiSwapContext+0x76</span><br><span class="line">        ffff9789`57a17740 fffff800`06038dcb     nt!KiSwapThread+0x2c6</span><br><span class="line">        ffff9789`57a17810 fffff800`060384ef     nt!KiCommitThreadWait+0x13b</span><br><span class="line">        ffff9789`57a178b0 fffff800`064e5f2c     nt!KeWaitForSingleObject+0x1ff</span><br><span class="line">        ffff9789`57a17990 fffff800`061b9d43     nt!NtWaitForSingleObject+0xfc</span><br><span class="line">        ffff9789`57a17a00 00007ffd`84ee9f84     nt!KiSystemServiceCopyEnd+0x13 (TrapFrame @ ffff9789`57a17a00)</span><br><span class="line">        00000065`e58bf7c8 00000000`00000000     0x00007ffd`84ee9f84</span><br><span class="line">        </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>查Token：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">6: kd&gt; !token ffffe18f306d4060</span><br><span class="line">_TOKEN 0xffffe18f306d4060</span><br><span class="line">TS Session ID: 0</span><br><span class="line">User: S-1-5-18</span><br><span class="line">User Groups: </span><br><span class="line"> 00 S-1-16-16384</span><br><span class="line">    Attributes - GroupIntegrity GroupIntegrityEnabled </span><br><span class="line"> 01 S-1-1-0</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 02 S-1-5-32-545</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 03 S-1-5-6</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 04 S-1-2-1</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 05 S-1-5-11</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 06 S-1-5-15</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 07 S-1-5-80-1851371743-411767070-3743290205-1090512353-603110601</span><br><span class="line">    Attributes - Default Enabled Owner </span><br><span class="line"> 08 S-1-5-5-0-261335</span><br><span class="line">    Attributes - Mandatory Default Enabled Owner LogonId </span><br><span class="line"> 09 S-1-2-0</span><br><span class="line">    Attributes - Mandatory Default Enabled </span><br><span class="line"> 10 S-1-5-32-544</span><br><span class="line">    Attributes - Default Enabled Owner </span><br><span class="line">Primary Group: S-1-5-18</span><br><span class="line">Privs: </span><br><span class="line"> 03 0x000000003 SeAssignPrimaryTokenPrivilege     Attributes - </span><br><span class="line"> 04 0x000000004 SeLockMemoryPrivilege             Attributes - Enabled Default </span><br><span class="line"> 05 0x000000005 SeIncreaseQuotaPrivilege          Attributes - </span><br><span class="line"> 07 0x000000007 SeTcbPrivilege                    Attributes - Enabled Default </span><br><span class="line"> 08 0x000000008 SeSecurityPrivilege               Attributes - </span><br><span class="line"> 09 0x000000009 SeTakeOwnershipPrivilege          Attributes - </span><br><span class="line"> 10 0x00000000a SeLoadDriverPrivilege             Attributes - </span><br><span class="line"> 11 0x00000000b SeSystemProfilePrivilege          Attributes - Enabled Default </span><br><span class="line"> 12 0x00000000c SeSystemtimePrivilege             Attributes - </span><br><span class="line"> 13 0x00000000d SeProfileSingleProcessPrivilege   Attributes - Enabled Default </span><br><span class="line"> 14 0x00000000e SeIncreaseBasePriorityPrivilege   Attributes - Enabled Default </span><br><span class="line"> 15 0x00000000f SeCreatePagefilePrivilege         Attributes - Enabled Default </span><br><span class="line"> 16 0x000000010 SeCreatePermanentPrivilege        Attributes - Enabled Default </span><br><span class="line"> 17 0x000000011 SeBackupPrivilege                 Attributes - </span><br><span class="line"> 18 0x000000012 SeRestorePrivilege                Attributes - </span><br><span class="line"> 19 0x000000013 SeShutdownPrivilege               Attributes - </span><br><span class="line"> 20 0x000000014 SeDebugPrivilege                  Attributes - Enabled Default </span><br><span class="line"> 21 0x000000015 SeAuditPrivilege                  Attributes - Enabled Default </span><br><span class="line"> 22 0x000000016 SeSystemEnvironmentPrivilege      Attributes - </span><br><span class="line"> 23 0x000000017 SeChangeNotifyPrivilege           Attributes - Enabled Default </span><br><span class="line"> 25 0x000000019 SeUndockPrivilege                 Attributes - </span><br><span class="line"> 28 0x00000001c SeManageVolumePrivilege           Attributes - </span><br><span class="line"> 29 0x00000001d SeImpersonatePrivilege            Attributes - Enabled Default </span><br><span class="line"> 30 0x00000001e SeCreateGlobalPrivilege           Attributes - Enabled Default </span><br><span class="line"> 33 0x000000021 SeIncreaseWorkingSetPrivilege     Attributes - Enabled Default </span><br><span class="line"> 34 0x000000022 SeTimeZonePrivilege               Attributes - Enabled Default </span><br><span class="line"> 35 0x000000023 SeCreateSymbolicLinkPrivilege     Attributes - Enabled Default </span><br><span class="line"> 36 0x000000024 SeDelegateSessionUserImpersonatePrivilege  Attributes - Enabled Default </span><br><span class="line">Authentication ID:         (0,3e7)</span><br><span class="line">Impersonation Level:       Anonymous</span><br><span class="line">TokenType:                 Primary</span><br><span class="line">Source: Advapi             TokenFlags: 0x2000 ( Token in use )</span><br><span class="line">Token ID: 4000d            ParentToken ID: 0</span><br><span class="line">Modified ID:               (0, 3fd3a)</span><br><span class="line">RestrictedSidCount: 0      RestrictedSids: 0x0000000000000000</span><br><span class="line">OriginatingLogonSession: 3e7</span><br><span class="line">PackageSid: (null)</span><br><span class="line">CapabilityCount: 0      Capabilities: 0x0000000000000000</span><br><span class="line">LowboxNumberEntry: 0x0000000000000000</span><br><span class="line">Security Attributes:</span><br><span class="line">Unable to get the offset of nt!_AUTHZBASEP_SECURITY_ATTRIBUTE.ListLink</span><br><span class="line">Process Token TrustLevelSid: (null)</span><br></pre></td></tr></table></figure>

<p>观察令牌对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">6: kd&gt; dt nt!_TOKEN ffffe18f306d4060</span><br><span class="line">   +0x000 TokenSource      : _TOKEN_SOURCE</span><br><span class="line">   +0x010 TokenId          : _LUID</span><br><span class="line">   +0x018 AuthenticationId : _LUID</span><br><span class="line">   +0x020 ParentTokenId    : _LUID</span><br><span class="line">   +0x028 ExpirationTime   : _LARGE_INTEGER 0x06207526`b64ceb90</span><br><span class="line">   +0x030 TokenLock        : 0xffff8489`8fdfbb00 _ERESOURCE</span><br><span class="line">   +0x038 ModifiedId       : _LUID</span><br><span class="line">   +0x040 Privileges       : _SEP_TOKEN_PRIVILEGES</span><br><span class="line">   +0x058 AuditPolicy      : _SEP_AUDIT_POLICY</span><br><span class="line">   +0x078 SessionId        : 0</span><br><span class="line">   +0x07c UserAndGroupCount : 0xc</span><br><span class="line">   +0x080 RestrictedSidCount : 0</span><br><span class="line">   +0x084 VariableLength   : 0x19c</span><br><span class="line">   +0x088 DynamicCharged   : 0x1000</span><br><span class="line">   +0x08c DynamicAvailable : 0</span><br><span class="line">   +0x090 DefaultOwnerIndex : 0</span><br><span class="line">   +0x098 UserAndGroups    : 0xffffe18f`306d44f0 _SID_AND_ATTRIBUTES</span><br><span class="line">   +0x0a0 RestrictedSids   : (null) </span><br><span class="line">   +0x0a8 PrimaryGroup     : 0xffffe18f`3065e6f0 Void</span><br><span class="line">   +0x0b0 DynamicPart      : 0xffffe18f`3065e6f0  -&gt; 0x101</span><br><span class="line">   +0x0b8 DefaultDacl      : 0xffffe18f`3065e6fc _ACL</span><br><span class="line">   +0x0c0 TokenType        : 1 ( TokenPrimary )</span><br><span class="line">   +0x0c4 ImpersonationLevel : 0 ( SecurityAnonymous )</span><br><span class="line">   +0x0c8 TokenFlags       : 0x2000</span><br><span class="line">   +0x0cc TokenInUse       : 0x1 &#x27;&#x27;</span><br><span class="line">   +0x0d0 IntegrityLevelIndex : 1</span><br><span class="line">   +0x0d4 MandatoryPolicy  : 3</span><br><span class="line">   +0x0d8 LogonSession     : 0xffffe18f`2b814d50 _SEP_LOGON_SESSION_REFERENCES</span><br><span class="line">   +0x0e0 OriginatingLogonSession : _LUID</span><br><span class="line">   +0x0e8 SidHash          : _SID_AND_ATTRIBUTES_HASH</span><br><span class="line">   +0x1f8 RestrictedSidHash : _SID_AND_ATTRIBUTES_HASH</span><br><span class="line">   +0x308 pSecurityAttributes : 0xffffe18f`306d1880 _AUTHZBASEP_SECURITY_ATTRIBUTES_INFORMATION</span><br><span class="line">   +0x310 Package          : (null) </span><br><span class="line">   +0x318 Capabilities     : (null) </span><br><span class="line">   +0x320 CapabilityCount  : 0</span><br><span class="line">   +0x328 CapabilitiesHash : _SID_AND_ATTRIBUTES_HASH</span><br><span class="line">   +0x438 LowboxNumberEntry : (null) </span><br><span class="line">   +0x440 LowboxHandlesEntry : (null) </span><br><span class="line">   +0x448 pClaimAttributes : (null) </span><br><span class="line">   +0x450 TrustLevelSid    : (null) </span><br><span class="line">   +0x458 TrustLinkedToken : (null) </span><br><span class="line">   +0x460 IntegrityLevelSidValue : (null) </span><br><span class="line">   +0x468 TokenSidValues   : (null) </span><br><span class="line">   +0x470 IndexEntry       : 0xffffe18f`306d3130 _SEP_LUID_TO_INDEX_MAP_ENTRY</span><br><span class="line">   +0x478 DiagnosticInfo   : (null) </span><br><span class="line">   +0x480 BnoIsolationHandlesEntry : (null) </span><br><span class="line">   +0x488 SessionObject    : (null) </span><br><span class="line">   +0x490 VariablePart     : 0xffffe18f`306d45b0</span><br></pre></td></tr></table></figure>

<h2 id="PEB结构"><a href="#PEB结构" class="headerlink" title="PEB结构"></a>PEB结构</h2><p>EPROCESS中PEB结构为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">6: kd&gt; dt _PEB</span><br><span class="line">nt!_PEB</span><br><span class="line">   +0x000 InheritedAddressSpace : UChar</span><br><span class="line">   +0x001 ReadImageFileExecOptions : UChar</span><br><span class="line">   +0x002 BeingDebugged    : UChar //是否正在被调试</span><br><span class="line">   +0x003 BitField         : UChar</span><br><span class="line">   +0x003 ImageUsesLargePages : Pos 0, 1 Bit</span><br><span class="line">   +0x003 IsProtectedProcess : Pos 1, 1 Bit</span><br><span class="line">   +0x003 IsImageDynamicallyRelocated : Pos 2, 1 Bit</span><br><span class="line">   +0x003 SkipPatchingUser32Forwarders : Pos 3, 1 Bit</span><br><span class="line">   +0x003 IsPackagedProcess : Pos 4, 1 Bit</span><br><span class="line">   +0x003 IsAppContainer   : Pos 5, 1 Bit</span><br><span class="line">   +0x003 IsProtectedProcessLight : Pos 6, 1 Bit</span><br><span class="line">   +0x003 IsLongPathAwareProcess : Pos 7, 1 Bit</span><br><span class="line">   +0x004 Padding0         : [4] UChar</span><br><span class="line">   +0x008 Mutant           : Ptr64 Void</span><br><span class="line">   +0x010 ImageBaseAddress : Ptr64 Void //执行映像基地址</span><br><span class="line">   +0x018 Ldr              : Ptr64 _PEB_LDR_DATA</span><br><span class="line">   +0x020 ProcessParameters : Ptr64 _RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">   +0x028 SubSystemData    : Ptr64 Void</span><br><span class="line">   +0x030 ProcessHeap      : Ptr64 Void //进程堆</span><br><span class="line">   +0x038 FastPebLock      : Ptr64 _RTL_CRITICAL_SECTION</span><br><span class="line">   +0x040 AtlThunkSListPtr : Ptr64 _SLIST_HEADER</span><br><span class="line">   +0x048 IFEOKey          : Ptr64 Void</span><br><span class="line">   +0x050 CrossProcessFlags : Uint4B</span><br><span class="line">   +0x050 ProcessInJob     : Pos 0, 1 Bit</span><br><span class="line">   +0x050 ProcessInitializing : Pos 1, 1 Bit</span><br><span class="line">   +0x050 ProcessUsingVEH  : Pos 2, 1 Bit</span><br><span class="line">   +0x050 ProcessUsingVCH  : Pos 3, 1 Bit</span><br><span class="line">   +0x050 ProcessUsingFTH  : Pos 4, 1 Bit</span><br><span class="line">   +0x050 ProcessPreviouslyThrottled : Pos 5, 1 Bit</span><br><span class="line">   +0x050 ProcessCurrentlyThrottled : Pos 6, 1 Bit</span><br><span class="line">   +0x050 ReservedBits0    : Pos 7, 25 Bits</span><br><span class="line">   +0x054 Padding1         : [4] UChar</span><br><span class="line">   +0x058 KernelCallbackTable : Ptr64 Void</span><br><span class="line">   +0x058 UserSharedInfoPtr : Ptr64 Void</span><br><span class="line">   +0x060 SystemReserved   : Uint4B</span><br><span class="line">   +0x064 AtlThunkSListPtr32 : Uint4B</span><br><span class="line">   +0x068 ApiSetMap        : Ptr64 Void</span><br><span class="line">   +0x070 TlsExpansionCounter : Uint4B</span><br><span class="line">   +0x074 Padding2         : [4] UChar</span><br><span class="line">   +0x078 TlsBitmap        : Ptr64 Void</span><br><span class="line">   +0x080 TlsBitmapBits    : [2] Uint4B</span><br><span class="line">   +0x088 ReadOnlySharedMemoryBase : Ptr64 Void</span><br><span class="line">   +0x090 SharedData       : Ptr64 Void</span><br><span class="line">   +0x098 ReadOnlyStaticServerData : Ptr64 Ptr64 Void</span><br><span class="line">   +0x0a0 AnsiCodePageData : Ptr64 Void</span><br><span class="line">   +0x0a8 OemCodePageData  : Ptr64 Void</span><br><span class="line">   +0x0b0 UnicodeCaseTableData : Ptr64 Void</span><br><span class="line">   +0x0b8 NumberOfProcessors : Uint4B //CPU个数</span><br><span class="line">   +0x0bc NtGlobalFlag     : Uint4B //全局标志</span><br><span class="line">   +0x0c0 CriticalSectionTimeout : _LARGE_INTEGER</span><br><span class="line">   +0x0c8 HeapSegmentReserve : Uint8B //默认进程堆总保留空间</span><br><span class="line">   +0x0d0 HeapSegmentCommit : Uint8B //默认进程堆已提交空间</span><br><span class="line">   +0x0d8 HeapDeCommitTotalFreeThreshold : Uint8B</span><br><span class="line">   +0x0e0 HeapDeCommitFreeBlockThreshold : Uint8B</span><br><span class="line">   +0x0e8 NumberOfHeaps    : Uint4B //堆个数</span><br><span class="line">   +0x0ec MaximumNumberOfHeaps : Uint4B //堆最多个数</span><br><span class="line">   +0x0f0 ProcessHeaps     : Ptr64 Ptr64 Void //保存堆句柄得数组地址</span><br><span class="line">   +0x0f8 GdiSharedHandleTable : Ptr64 Void //GDI共享句柄表</span><br><span class="line">   +0x100 ProcessStarterHelper : Ptr64 Void</span><br><span class="line">   +0x108 GdiDCAttributeList : Uint4B</span><br><span class="line">   +0x10c Padding3         : [4] UChar</span><br><span class="line">   +0x110 LoaderLock       : Ptr64 _RTL_CRITICAL_SECTION</span><br><span class="line">   +0x118 OSMajorVersion   : Uint4B //操作系统主版本号</span><br><span class="line">   +0x11c OSMinorVersion   : Uint4B //操作系统子版本号</span><br><span class="line">   +0x120 OSBuildNumber    : Uint2B //操作系统构建号</span><br><span class="line">   +0x122 OSCSDVersion     : Uint2B //Service Pack版本号</span><br><span class="line">   +0x124 OSPlatformId     : Uint4B //操作系统类别 NT为2 9x为1 WindowsCE为3</span><br><span class="line">   +0x128 ImageSubsystem   : Uint4B //环境子系统ID</span><br><span class="line">   +0x12c ImageSubsystemMajorVersion : Uint4B //环境子系统主版本号</span><br><span class="line">   +0x130 ImageSubsystemMinorVersion : Uint4B //环境子系统子版本号</span><br><span class="line">   +0x134 Padding4         : [4] UChar</span><br><span class="line">   +0x138 ActiveProcessAffinityMask : Uint8B</span><br><span class="line">   +0x140 GdiHandleBuffer  : [60] Uint4B</span><br><span class="line">   +0x230 PostProcessInitRoutine : Ptr64     void </span><br><span class="line">   +0x238 TlsExpansionBitmap : Ptr64 Void</span><br><span class="line">   +0x240 TlsExpansionBitmapBits : [32] Uint4B</span><br><span class="line">   +0x2c0 SessionId        : Uint4B //所属会话ID</span><br><span class="line">   +0x2c4 Padding5         : [4] UChar</span><br><span class="line">   +0x2c8 AppCompatFlags   : _ULARGE_INTEGER</span><br><span class="line">   +0x2d0 AppCompatFlagsUser : _ULARGE_INTEGER</span><br><span class="line">   +0x2d8 pShimData        : Ptr64 Void</span><br><span class="line">   +0x2e0 AppCompatInfo    : Ptr64 Void</span><br><span class="line">   +0x2e8 CSDVersion       : _UNICODE_STRING</span><br><span class="line">   +0x2f8 ActivationContextData : Ptr64 _ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +0x300 ProcessAssemblyStorageMap : Ptr64 _ASSEMBLY_STORAGE_MAP</span><br><span class="line">   +0x308 SystemDefaultActivationContextData : Ptr64 _ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +0x310 SystemAssemblyStorageMap : Ptr64 _ASSEMBLY_STORAGE_MAP</span><br><span class="line">   +0x318 MinimumStackCommit : Uint8B</span><br><span class="line">   +0x320 FlsCallback      : Ptr64 _FLS_CALLBACK_INFO</span><br><span class="line">   +0x328 FlsListHead      : _LIST_ENTRY</span><br><span class="line">   +0x338 FlsBitmap        : Ptr64 Void</span><br><span class="line">   +0x340 FlsBitmapBits    : [4] Uint4B</span><br><span class="line">   +0x350 FlsHighIndex     : Uint4B</span><br><span class="line">   +0x358 WerRegistrationData : Ptr64 Void</span><br><span class="line">   +0x360 WerShipAssertPtr : Ptr64 Void</span><br><span class="line">   +0x368 pUnused          : Ptr64 Void</span><br><span class="line">   +0x370 pImageHeaderHash : Ptr64 Void</span><br><span class="line">   +0x378 TracingFlags     : Uint4B</span><br><span class="line">   +0x378 HeapTracingEnabled : Pos 0, 1 Bit</span><br><span class="line">   +0x378 CritSecTracingEnabled : Pos 1, 1 Bit</span><br><span class="line">   +0x378 LibLoaderTracingEnabled : Pos 2, 1 Bit</span><br><span class="line">   +0x378 SpareTracingBits : Pos 3, 29 Bits</span><br><span class="line">   +0x37c Padding6         : [4] UChar</span><br><span class="line">   +0x380 CsrServerReadOnlySharedMemoryBase : Uint8B</span><br><span class="line">   +0x388 TppWorkerpListLock : Uint8B</span><br><span class="line">   +0x390 TppWorkerpList   : _LIST_ENTRY</span><br><span class="line">   +0x3a0 WaitOnAddressHashTable : [128] Ptr64 Void</span><br><span class="line">   +0x7a0 TelemetryCoverageHeader : Ptr64 Void</span><br><span class="line">   +0x7a8 CloudFileFlags   : Uint4B</span><br><span class="line">   +0x7ac CloudFileDiagFlags : Uint4B</span><br><span class="line">   +0x7b0 PlaceholderCompatibilityMode : Char</span><br><span class="line">   +0x7b1 PlaceholderCompatibilityModeReserved : [7] Char</span><br></pre></td></tr></table></figure>

<p>也可以用<code>!peb</code>命令观察某地址处PEB结构。</p>
<h2 id="内核模式和用户模式"><a href="#内核模式和用户模式" class="headerlink" title="内核模式和用户模式"></a>内核模式和用户模式</h2><p>例如Win32应用程序中调用Kernel32.dll导出的<code>Kernel32!ReadFile</code>后堆参数进行检查，再调用<code>Ntdll!NtReadFile</code>。<code>Ntdll!NtReadFile</code>将系统服务号，如0xa1等放入RAX，参数指针放入EDX，用<code>int 2e</code>发出调用。用<code>!idt 2e</code>看到2e号向量对应服务例程是<code>Nt!KiSystemService</code>，即内核态中用来分发系统调用的例程，在NtOsKrnl.exe中。<code>Nt!KiSystemService</code>进行权限检查和准备内核栈，根据系统服务分发表SSDT查找要调用的服务函数<code>NtReadFile</code>地址和参数描述。<code>KiSystemService</code>通过<code>iret</code>将执行权返回<code>NtDll!NtReadFile</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// attributes: thunk</span></span><br><span class="line"><span class="function">BOOL __stdcall <span class="title">ReadFile</span><span class="params">(HANDLE hFile, LPVOID lpBuffer, DWORD nNumberOfBytesToRead, LPDWORD lpNumberOfBytesRead, LPOVERLAPPED lpOverlapped)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __imp_ReadFile(hFile, lpBuffer, nNumberOfBytesToRead, lpNumberOfBytesRead, lpOverlapped);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">__int64 <span class="title">NtReadFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    __int64 result; <span class="comment">// rax</span></span><br><span class="line">    result = <span class="number">6LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((MEMORY[<span class="number">0x7FFE0308</span>] &amp; <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">        __asm &#123; <span class="type">int</span>     <span class="number">2</span>Eh; DOS <span class="number">2</span> + internal - EXECUTE COMMAND &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        __asm &#123; syscall; Low latency system call &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>从奔腾Ⅱ开始，在Windows XP或Windows Server 2003及以上在启动时检测是否支持快速系统调用命令。IA-32的奔腾Ⅱ引入<code>sysenter</code>&#x2F;<code>sysexit</code>，AMD K7引入<code>syscall</code>&#x2F;<code>sysreturn</code>。当支持快速系统调用时，系统启动时在全局描述表GDT中建立4个段描述符，依次排列为<code>sysenter</code>进入内核模式时使用的代码段CS和栈段SS，以及<code>sysexit</code>从内核模式返回用户模式使用的代码段和栈段。然后设置下表所示MSR，SYSENTER_EIP_MSR为<code>sysenter</code>要跳转到的目标例程<code>Nt!KiFastCallEntry</code>，SYSENTER_CS_MSR为<code>Nt!KiFastCallEntry</code>所在代码段KGDT_R0_CODE，SYSENTER_ESP_MSR为新栈指针即SYSENTER_CS_MSR+8。最后将SystemCallStub代码片段复制到SharedUserData内存区，该内存区将被映射到每个Win32进程空间中，每次快速系统调用时NTDLL.DLL中残根stub函数调用SystemCallStub代码片段。</p>
<table>
<thead>
<tr>
<th>MSR名称</th>
<th>MSR地址</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>SYSENTER_CS_MSR</td>
<td>174h</td>
<td>目标代码段CS选择子</td>
</tr>
<tr>
<td>SYSENTER_ESP_MSR</td>
<td>175h</td>
<td>目标ESP</td>
</tr>
<tr>
<td>SYSENTER_EIP_MSR</td>
<td>176h</td>
<td>目标EIP</td>
</tr>
</tbody></table>
<p>每个系统MSR都不同，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdmsr 174</span><br></pre></td></tr></table></figure>

<p>快速系统调用模式切换总结为：</p>
<table>
<thead>
<tr>
<th>发起系统调用</th>
<th>入口内核例程</th>
<th>返回</th>
<th>返回内核例程</th>
</tr>
</thead>
<tbody><tr>
<td><code>int 2e</code></td>
<td><code>KiSystemService</code></td>
<td><code>iret</code></td>
<td><code>KiSystemCallExit</code></td>
</tr>
<tr>
<td><code>sysenter</code></td>
<td><code>KiFastCallEntry</code></td>
<td><code>sysexit</code></td>
<td><code>KiSystemCallExit2</code></td>
</tr>
<tr>
<td><code>syscall</code></td>
<td><code>KiFastCallEntry</code></td>
<td><code>sysret</code></td>
<td><code>KiSystemCallExit3</code></td>
</tr>
</tbody></table>
<p>IA-32下快速系统调用实例<code>ReadFile</code>：Win32程序用<code>Kernel32!ReadFile()</code>调用<code>NtDll!NtReadFile()</code>，转到<code>SharedUserData!SystemCallStub</code>用<code>sysenter</code>进入<code>nt!KiFastCallEntry</code>，通过<code>Nt!KiSystemService</code>调用<code>Nt!NtReadFile</code>。返回时<code>Nt!KiSystemService</code>通过<code>Nt!KiSystemCallExit2</code>用<code>sysexit</code>退出内核模式回到<code>SharedUserData!SystemCallStub</code>。</p>
<p>内核模式也可主动调用用户模式例程，称为逆向调用。由<code>Nt!KiCallUserMode</code>发起调用，进入用户模式执行<code>NtDll!KiUserCallbackDispatcher</code>。用户模式完成后执行<code>int 2b</code>返回动作，对应<code>Nt!KiCallbackReturn</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !idt 2b</span><br><span class="line"></span><br><span class="line">Dumping IDT: 80b95400</span><br><span class="line"></span><br><span class="line">2b:	82848e50 nt!KiCallbackReturn</span><br></pre></td></tr></table></figure>

<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><p>类似EPROCESS，在内核模式下也有ETHREAD。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; .thread</span><br><span class="line">Implicit thread is now fffff807`10727600</span><br><span class="line">0: kd&gt; dt _ETHREAD fffff807`10727600</span><br><span class="line">ntdll!_ETHREAD</span><br><span class="line">   +0x000 Tcb              : _KTHREAD //线程控制块TCB 供内核调度线程</span><br><span class="line">   +0x430 CreateTime       : _LARGE_INTEGER 0x0</span><br><span class="line">   +0x438 ExitTime         : _LARGE_INTEGER 0x0</span><br><span class="line">   +0x438 KeyedWaitChain   : _LIST_ENTRY [ 0x00000000`00000000 - 0x00000000`00000000 ]</span><br><span class="line">   +0x448 PostBlockList    : _LIST_ENTRY [ 0x00000000`00000000 - 0xfffff807`0fdf8ce0 ]</span><br><span class="line">   +0x448 ForwardLinkShadow : (null) </span><br><span class="line">   +0x450 StartAddress     : 0xfffff807`0fdf8ce0 Void</span><br><span class="line">   +0x458 TerminationPort  : (null) </span><br><span class="line">   +0x458 ReaperLink       : (null) </span><br><span class="line">   +0x458 KeyedWaitValue   : (null) </span><br><span class="line">   +0x460 ActiveTimerListLock : 0</span><br><span class="line">   +0x468 ActiveTimerListHead : _LIST_ENTRY [ 0x00000000`00000000 - 0x00000000`00000000 ]</span><br><span class="line">   +0x478 Cid              : _CLIENT_ID</span><br><span class="line">   +0x488 KeyedWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +0x488 AlpcWaitSemaphore : _KSEMAPHORE</span><br><span class="line">   +0x4a8 ClientSecurity   : _PS_CLIENT_SECURITY_CONTEXT</span><br><span class="line">   +0x4b0 IrpList          : _LIST_ENTRY [ 0x00000000`00000000 - 0x00000000`00000000 ]</span><br><span class="line">   +0x4c0 TopLevelIrp      : 0</span><br><span class="line">   +0x4c8 DeviceToVerify   : (null) </span><br><span class="line">   +0x4d0 Win32StartAddress : 0xfffff807`0fdf8ce0 Void</span><br><span class="line">   +0x4d8 ChargeOnlySession : (null) </span><br><span class="line">   +0x4e0 LegacyPowerObject : (null) </span><br><span class="line">   +0x4e8 ThreadListEntry  : _LIST_ENTRY [ 0xffffe600`62472628 - 0xfffff807`10724fe0 ]</span><br><span class="line">   +0x4f8 RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">   +0x500 ThreadLock       : _EX_PUSH_LOCK</span><br><span class="line">   +0x508 ReadClusterSize  : 0</span><br><span class="line">   +0x50c MmLockOrdering   : 0n0</span><br><span class="line">   +0x510 CrossThreadFlags : 0x5000</span><br><span class="line">   +0x510 Terminated       : 0y0</span><br><span class="line">   +0x510 ThreadInserted   : 0y0</span><br><span class="line">   +0x510 HideFromDebugger : 0y0</span><br><span class="line">   +0x510 ActiveImpersonationInfo : 0y0</span><br><span class="line">   +0x510 HardErrorsAreDisabled : 0y0</span><br><span class="line">   +0x510 BreakOnTermination : 0y0</span><br><span class="line">   +0x510 SkipCreationMsg  : 0y0</span><br><span class="line">   +0x510 SkipTerminationMsg : 0y0</span><br><span class="line">   +0x510 CopyTokenOnOpen  : 0y0</span><br><span class="line">   +0x510 ThreadIoPriority : 0y000</span><br><span class="line">   +0x510 ThreadPagePriority : 0y101</span><br><span class="line">   +0x510 RundownFail      : 0y0</span><br><span class="line">   +0x510 UmsForceQueueTermination : 0y0</span><br><span class="line">   +0x510 IndirectCpuSets  : 0y0</span><br><span class="line">   +0x510 DisableDynamicCodeOptOut : 0y0</span><br><span class="line">   +0x510 ExplicitCaseSensitivity : 0y0</span><br><span class="line">   +0x510 PicoNotifyExit   : 0y0</span><br><span class="line">   +0x510 DbgWerUserReportActive : 0y0</span><br><span class="line">   +0x510 ForcedSelfTrimActive : 0y0</span><br><span class="line">   +0x510 SamplingCoverage : 0y0</span><br><span class="line">   +0x510 ReservedCrossThreadFlags : 0y00000000 (0)</span><br><span class="line">   +0x514 SameThreadPassiveFlags : 0</span><br><span class="line">   +0x514 ActiveExWorker   : 0y0</span><br><span class="line">   +0x514 MemoryMaker      : 0y0</span><br><span class="line">   +0x514 StoreLockThread  : 0y00</span><br><span class="line">   +0x514 ClonedThread     : 0y0</span><br><span class="line">   +0x514 KeyedEventInUse  : 0y0</span><br><span class="line">   +0x514 SelfTerminate    : 0y0</span><br><span class="line">   +0x514 RespectIoPriority : 0y0</span><br><span class="line">   +0x514 ActivePageLists  : 0y0</span><br><span class="line">   +0x514 SecureContext    : 0y0</span><br><span class="line">   +0x514 ZeroPageThread   : 0y0</span><br><span class="line">   +0x514 WorkloadClass    : 0y0</span><br><span class="line">   +0x514 ReservedSameThreadPassiveFlags : 0y00000000000000000000 (0)</span><br><span class="line">   +0x518 SameThreadApcFlags : 0</span><br><span class="line">   +0x518 OwnsProcessAddressSpaceExclusive : 0y0</span><br><span class="line">   +0x518 OwnsProcessAddressSpaceShared : 0y0</span><br><span class="line">   +0x518 HardFaultBehavior : 0y0</span><br><span class="line">   +0x518 StartAddressInvalid : 0y0</span><br><span class="line">   +0x518 EtwCalloutActive : 0y0</span><br><span class="line">   +0x518 SuppressSymbolLoad : 0y0</span><br><span class="line">   +0x518 Prefetching      : 0y0</span><br><span class="line">   +0x518 OwnsVadExclusive : 0y0</span><br><span class="line">   +0x519 SystemPagePriorityActive : 0y0</span><br><span class="line">   +0x519 SystemPagePriority : 0y000</span><br><span class="line">   +0x519 AllowUserWritesToExecutableMemory : 0y0</span><br><span class="line">   +0x519 AllowKernelWritesToExecutableMemory : 0y0</span><br><span class="line">   +0x519 OwnsVadShared    : 0y0</span><br><span class="line">   +0x51c CacheManagerActive : 0 &#x27;&#x27;</span><br><span class="line">   +0x51d DisablePageFaultClustering : 0 &#x27;&#x27;</span><br><span class="line">   +0x51e ActiveFaultCount : 0 &#x27;&#x27;</span><br><span class="line">   +0x51f LockOrderState   : 0 &#x27;&#x27;</span><br><span class="line">   +0x520 PerformanceCountLowReserved : 0</span><br><span class="line">   +0x524 PerformanceCountHighReserved : 0n0</span><br><span class="line">   +0x528 AlpcMessageId    : 0</span><br><span class="line">   +0x530 AlpcMessage      : (null) </span><br><span class="line">   +0x530 AlpcReceiveAttributeSet : 0</span><br><span class="line">   +0x538 AlpcWaitListEntry : _LIST_ENTRY [ 0x00000000`00000000 - 0x00000000`00000000 ]</span><br><span class="line">   +0x548 ExitStatus       : 0n0</span><br><span class="line">   +0x54c CacheManagerCount : 0</span><br><span class="line">   +0x550 IoBoostCount     : 0</span><br><span class="line">   +0x554 IoQoSBoostCount  : 0</span><br><span class="line">   +0x558 IoQoSThrottleCount : 0</span><br><span class="line">   +0x55c KernelStackReference : 0</span><br><span class="line">   +0x560 BoostList        : _LIST_ENTRY [ 0xfffff807`10727b60 - 0xfffff807`10727b60 ]</span><br><span class="line">   +0x570 DeboostList      : _LIST_ENTRY [ 0xfffff807`10727b70 - 0xfffff807`10727b70 ]</span><br><span class="line">   +0x580 BoostListLock    : 0</span><br><span class="line">   +0x588 IrpListLock      : 0</span><br><span class="line">   +0x590 ReservedForSynchTracking : (null) </span><br><span class="line">   +0x598 CmCallbackListHead : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x5a0 ActivityId       : (null) </span><br><span class="line">   +0x5a8 SeLearningModeListHead : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x5b0 VerifierContext  : (null) </span><br><span class="line">   +0x5b8 AdjustedClientToken : (null) </span><br><span class="line">   +0x5c0 WorkOnBehalfThread : (null) </span><br><span class="line">   +0x5c8 PropertySet      : _PS_PROPERTY_SET</span><br><span class="line">   +0x5e0 PicoContext      : (null) </span><br><span class="line">   +0x5e8 UserFsBase       : 0</span><br><span class="line">   +0x5f0 UserGsBase       : 0</span><br><span class="line">   +0x5f8 EnergyValues     : (null) </span><br><span class="line">   +0x600 SelectedCpuSets  : 0</span><br><span class="line">   +0x600 SelectedCpuSetsIndirect : (null) </span><br><span class="line">   +0x608 Silo             : (null) </span><br><span class="line">   +0x610 ThreadName       : (null) </span><br><span class="line">   +0x618 SetContextState  : (null) </span><br><span class="line">   +0x620 LastExpectedRunTime : 0</span><br><span class="line">   +0x624 HeapData         : 0x98c90000</span><br><span class="line">   +0x628 OwnerEntryListHead : _LIST_ENTRY [ 0x00000000`00000000 - 0x00000000`00000000 ]</span><br><span class="line">   +0x638 DisownedOwnerEntryListLock : 0</span><br><span class="line">   +0x640 DisownedOwnerEntryListHead : _LIST_ENTRY [ 0x00000000`00000000 - 0x00000000`00000000 ]</span><br><span class="line">   +0x650 LockEntries      : [6] _KLOCK_ENTRY</span><br><span class="line">   +0x890 CmDbgInfo        : (null) </span><br></pre></td></tr></table></figure>

<p>第一个成员KTHREAD结构为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; dt _KTHREAD</span><br><span class="line">ntdll!_KTHREAD</span><br><span class="line">   +0x000 Header           : _DISPATCHER_HEADER</span><br><span class="line">   +0x018 SListFaultAddress : Ptr64 Void</span><br><span class="line">   +0x020 QuantumTarget    : Uint8B</span><br><span class="line">   +0x028 InitialStack     : Ptr64 Void</span><br><span class="line">   +0x030 StackLimit       : Ptr64 Void</span><br><span class="line">   +0x038 StackBase        : Ptr64 Void</span><br><span class="line">   +0x040 ThreadLock       : Uint8B</span><br><span class="line">   +0x048 CycleTime        : Uint8B</span><br><span class="line">   +0x050 CurrentRunTime   : Uint4B</span><br><span class="line">   +0x054 ExpectedRunTime  : Uint4B</span><br><span class="line">   +0x058 KernelStack      : Ptr64 Void</span><br><span class="line">   +0x060 StateSaveArea    : Ptr64 _XSAVE_FORMAT</span><br><span class="line">   +0x068 SchedulingGroup  : Ptr64 _KSCHEDULING_GROUP</span><br><span class="line">   +0x070 WaitRegister     : _KWAIT_STATUS_REGISTER</span><br><span class="line">   +0x071 Running          : UChar</span><br><span class="line">   +0x072 Alerted          : [2] UChar</span><br><span class="line">   +0x074 AutoBoostActive  : Pos 0, 1 Bit</span><br><span class="line">   +0x074 ReadyTransition  : Pos 1, 1 Bit</span><br><span class="line">   +0x074 WaitNext         : Pos 2, 1 Bit</span><br><span class="line">   +0x074 SystemAffinityActive : Pos 3, 1 Bit</span><br><span class="line">   +0x074 Alertable        : Pos 4, 1 Bit</span><br><span class="line">   +0x074 UserStackWalkActive : Pos 5, 1 Bit</span><br><span class="line">   +0x074 ApcInterruptRequest : Pos 6, 1 Bit</span><br><span class="line">   +0x074 QuantumEndMigrate : Pos 7, 1 Bit</span><br><span class="line">   +0x074 UmsDirectedSwitchEnable : Pos 8, 1 Bit</span><br><span class="line">   +0x074 TimerActive      : Pos 9, 1 Bit</span><br><span class="line">   +0x074 SystemThread     : Pos 10, 1 Bit</span><br><span class="line">   +0x074 ProcessDetachActive : Pos 11, 1 Bit</span><br><span class="line">   +0x074 CalloutActive    : Pos 12, 1 Bit</span><br><span class="line">   +0x074 ScbReadyQueue    : Pos 13, 1 Bit</span><br><span class="line">   +0x074 ApcQueueable     : Pos 14, 1 Bit</span><br><span class="line">   +0x074 ReservedStackInUse : Pos 15, 1 Bit</span><br><span class="line">   +0x074 UmsPerformingSyscall : Pos 16, 1 Bit</span><br><span class="line">   +0x074 TimerSuspended   : Pos 17, 1 Bit</span><br><span class="line">   +0x074 SuspendedWaitMode : Pos 18, 1 Bit</span><br><span class="line">   +0x074 SuspendSchedulerApcWait : Pos 19, 1 Bit</span><br><span class="line">   +0x074 CetUserShadowStack : Pos 20, 1 Bit</span><br><span class="line">   +0x074 BypassProcessFreeze : Pos 21, 1 Bit</span><br><span class="line">   +0x074 Reserved         : Pos 22, 10 Bits</span><br><span class="line">   +0x074 MiscFlags        : Int4B</span><br><span class="line">   +0x078 ThreadFlagsSpare : Pos 0, 2 Bits</span><br><span class="line">   +0x078 AutoAlignment    : Pos 2, 1 Bit</span><br><span class="line">   +0x078 DisableBoost     : Pos 3, 1 Bit</span><br><span class="line">   +0x078 AlertedByThreadId : Pos 4, 1 Bit</span><br><span class="line">   +0x078 QuantumDonation  : Pos 5, 1 Bit</span><br><span class="line">   +0x078 EnableStackSwap  : Pos 6, 1 Bit</span><br><span class="line">   +0x078 GuiThread        : Pos 7, 1 Bit</span><br><span class="line">   +0x078 DisableQuantum   : Pos 8, 1 Bit</span><br><span class="line">   +0x078 ChargeOnlySchedulingGroup : Pos 9, 1 Bit</span><br><span class="line">   +0x078 DeferPreemption  : Pos 10, 1 Bit</span><br><span class="line">   +0x078 QueueDeferPreemption : Pos 11, 1 Bit</span><br><span class="line">   +0x078 ForceDeferSchedule : Pos 12, 1 Bit</span><br><span class="line">   +0x078 SharedReadyQueueAffinity : Pos 13, 1 Bit</span><br><span class="line">   +0x078 FreezeCount      : Pos 14, 1 Bit</span><br><span class="line">   +0x078 TerminationApcRequest : Pos 15, 1 Bit</span><br><span class="line">   +0x078 AutoBoostEntriesExhausted : Pos 16, 1 Bit</span><br><span class="line">   +0x078 KernelStackResident : Pos 17, 1 Bit</span><br><span class="line">   +0x078 TerminateRequestReason : Pos 18, 2 Bits</span><br><span class="line">   +0x078 ProcessStackCountDecremented : Pos 20, 1 Bit</span><br><span class="line">   +0x078 RestrictedGuiThread : Pos 21, 1 Bit</span><br><span class="line">   +0x078 VpBackingThread  : Pos 22, 1 Bit</span><br><span class="line">   +0x078 ThreadFlagsSpare2 : Pos 23, 1 Bit</span><br><span class="line">   +0x078 EtwStackTraceApcInserted : Pos 24, 8 Bits</span><br><span class="line">   +0x078 ThreadFlags      : Int4B</span><br><span class="line">   +0x07c Tag              : UChar</span><br><span class="line">   +0x07d SystemHeteroCpuPolicy : UChar</span><br><span class="line">   +0x07e UserHeteroCpuPolicy : Pos 0, 7 Bits</span><br><span class="line">   +0x07e ExplicitSystemHeteroCpuPolicy : Pos 7, 1 Bit</span><br><span class="line">   +0x07f Spare0           : UChar</span><br><span class="line">   +0x080 SystemCallNumber : Uint4B</span><br><span class="line">   +0x084 ReadyTime        : Uint4B</span><br><span class="line">   +0x088 FirstArgument    : Ptr64 Void</span><br><span class="line">   +0x090 TrapFrame        : Ptr64 _KTRAP_FRAME</span><br><span class="line">   +0x098 ApcState         : _KAPC_STATE</span><br><span class="line">   +0x098 ApcStateFill     : [43] UChar</span><br><span class="line">   +0x0c3 Priority         : Char</span><br><span class="line">   +0x0c4 UserIdealProcessor : Uint4B</span><br><span class="line">   +0x0c8 WaitStatus       : Int8B</span><br><span class="line">   +0x0d0 WaitBlockList    : Ptr64 _KWAIT_BLOCK</span><br><span class="line">   +0x0d8 WaitListEntry    : _LIST_ENTRY</span><br><span class="line">   +0x0d8 SwapListEntry    : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x0e8 Queue            : Ptr64 _DISPATCHER_HEADER</span><br><span class="line">   +0x0f0 Teb              : Ptr64 Void</span><br><span class="line">   +0x0f8 RelativeTimerBias : Uint8B</span><br><span class="line">   +0x100 Timer            : _KTIMER</span><br><span class="line">   +0x140 WaitBlock        : [4] _KWAIT_BLOCK</span><br><span class="line">   +0x140 WaitBlockFill4   : [20] UChar</span><br><span class="line">   +0x154 ContextSwitches  : Uint4B</span><br><span class="line">   +0x140 WaitBlockFill5   : [68] UChar</span><br><span class="line">   +0x184 State            : UChar //线程状态</span><br><span class="line">   +0x185 Spare13          : Char</span><br><span class="line">   +0x186 WaitIrql         : UChar</span><br><span class="line">   +0x187 WaitMode         : Char</span><br><span class="line">   +0x140 WaitBlockFill6   : [116] UChar</span><br><span class="line">   +0x1b4 WaitTime         : Uint4B</span><br><span class="line">   +0x140 WaitBlockFill7   : [164] UChar</span><br><span class="line">   +0x1e4 KernelApcDisable : Int2B</span><br><span class="line">   +0x1e6 SpecialApcDisable : Int2B</span><br><span class="line">   +0x1e4 CombinedApcDisable : Uint4B</span><br><span class="line">   +0x140 WaitBlockFill8   : [40] UChar</span><br><span class="line">   +0x168 ThreadCounters   : Ptr64 _KTHREAD_COUNTERS</span><br><span class="line">   +0x140 WaitBlockFill9   : [88] UChar</span><br><span class="line">   +0x198 XStateSave       : Ptr64 _XSTATE_SAVE</span><br><span class="line">   +0x140 WaitBlockFill10  : [136] UChar</span><br><span class="line">   +0x1c8 Win32Thread      : Ptr64 Void</span><br><span class="line">   +0x140 WaitBlockFill11  : [176] UChar</span><br><span class="line">   +0x1f0 Ucb              : Ptr64 _UMS_CONTROL_BLOCK</span><br><span class="line">   +0x1f8 Uch              : Ptr64 _KUMS_CONTEXT_HEADER</span><br><span class="line">   +0x200 ThreadFlags2     : Int4B</span><br><span class="line">   +0x200 BamQosLevel      : Pos 0, 8 Bits</span><br><span class="line">   +0x200 ThreadFlags2Reserved : Pos 8, 24 Bits</span><br><span class="line">   +0x204 Spare21          : Uint4B</span><br><span class="line">   +0x208 QueueListEntry   : _LIST_ENTRY</span><br><span class="line">   +0x218 NextProcessor    : Uint4B</span><br><span class="line">   +0x218 NextProcessorNumber : Pos 0, 31 Bits</span><br><span class="line">   +0x218 SharedReadyQueue : Pos 31, 1 Bit</span><br><span class="line">   +0x21c QueuePriority    : Int4B</span><br><span class="line">   +0x220 Process          : Ptr64 _KPROCESS</span><br><span class="line">   +0x228 UserAffinity     : _GROUP_AFFINITY</span><br><span class="line">   +0x228 UserAffinityFill : [10] UChar</span><br><span class="line">   +0x232 PreviousMode     : Char</span><br><span class="line">   +0x233 BasePriority     : Char</span><br><span class="line">   +0x234 PriorityDecrement : Char</span><br><span class="line">   +0x234 ForegroundBoost  : Pos 0, 4 Bits</span><br><span class="line">   +0x234 UnusualBoost     : Pos 4, 4 Bits</span><br><span class="line">   +0x235 Preempted        : UChar</span><br><span class="line">   +0x236 AdjustReason     : UChar</span><br><span class="line">   +0x237 AdjustIncrement  : Char</span><br><span class="line">   +0x238 AffinityVersion  : Uint8B</span><br><span class="line">   +0x240 Affinity         : _GROUP_AFFINITY</span><br><span class="line">   +0x240 AffinityFill     : [10] UChar</span><br><span class="line">   +0x24a ApcStateIndex    : UChar</span><br><span class="line">   +0x24b WaitBlockCount   : UChar</span><br><span class="line">   +0x24c IdealProcessor   : Uint4B</span><br><span class="line">   +0x250 NpxState         : Uint8B</span><br><span class="line">   +0x258 SavedApcState    : _KAPC_STATE</span><br><span class="line">   +0x258 SavedApcStateFill : [43] UChar</span><br><span class="line">   +0x283 WaitReason       : UChar</span><br><span class="line">   +0x284 SuspendCount     : Char</span><br><span class="line">   +0x285 Saturation       : Char</span><br><span class="line">   +0x286 SListFaultCount  : Uint2B</span><br><span class="line">   +0x288 SchedulerApc     : _KAPC</span><br><span class="line">   +0x288 SchedulerApcFill0 : [1] UChar</span><br><span class="line">   +0x289 ResourceIndex    : UChar</span><br><span class="line">   +0x288 SchedulerApcFill1 : [3] UChar</span><br><span class="line">   +0x28b QuantumReset     : UChar</span><br><span class="line">   +0x288 SchedulerApcFill2 : [4] UChar</span><br><span class="line">   +0x28c KernelTime       : Uint4B</span><br><span class="line">   +0x288 SchedulerApcFill3 : [64] UChar</span><br><span class="line">   +0x2c8 WaitPrcb         : Ptr64 _KPRCB</span><br><span class="line">   +0x288 SchedulerApcFill4 : [72] UChar</span><br><span class="line">   +0x2d0 LegoData         : Ptr64 Void</span><br><span class="line">   +0x288 SchedulerApcFill5 : [83] UChar</span><br><span class="line">   +0x2db CallbackNestingLevel : UChar</span><br><span class="line">   +0x2dc UserTime         : Uint4B</span><br><span class="line">   +0x2e0 SuspendEvent     : _KEVENT</span><br><span class="line">   +0x2f8 ThreadListEntry  : _LIST_ENTRY</span><br><span class="line">   +0x308 MutantListHead   : _LIST_ENTRY</span><br><span class="line">   +0x318 AbEntrySummary   : UChar</span><br><span class="line">   +0x319 AbWaitEntryCount : UChar</span><br><span class="line">   +0x31a AbAllocationRegionCount : UChar</span><br><span class="line">   +0x31b SystemPriority   : Char</span><br><span class="line">   +0x31c SecureThreadCookie : Uint4B</span><br><span class="line">   +0x320 LockEntries      : Ptr64 _KLOCK_ENTRY</span><br><span class="line">   +0x328 PropagateBoostsEntry : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x330 IoSelfBoostsEntry : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x338 PriorityFloorCounts : [16] UChar</span><br><span class="line">   +0x348 PriorityFloorCountsReserved : [16] UChar</span><br><span class="line">   +0x358 PriorityFloorSummary : Uint4B</span><br><span class="line">   +0x35c AbCompletedIoBoostCount : Int4B</span><br><span class="line">   +0x360 AbCompletedIoQoSBoostCount : Int4B</span><br><span class="line">   +0x364 KeReferenceCount : Int2B</span><br><span class="line">   +0x366 AbOrphanedEntrySummary : UChar</span><br><span class="line">   +0x367 AbOwnedEntryCount : UChar</span><br><span class="line">   +0x368 ForegroundLossTime : Uint4B</span><br><span class="line">   +0x370 GlobalForegroundListEntry : _LIST_ENTRY</span><br><span class="line">   +0x370 ForegroundDpcStackListEntry : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x378 InGlobalForegroundList : Uint8B</span><br><span class="line">   +0x380 ReadOperationCount : Int8B</span><br><span class="line">   +0x388 WriteOperationCount : Int8B</span><br><span class="line">   +0x390 OtherOperationCount : Int8B</span><br><span class="line">   +0x398 ReadTransferCount : Int8B</span><br><span class="line">   +0x3a0 WriteTransferCount : Int8B</span><br><span class="line">   +0x3a8 OtherTransferCount : Int8B</span><br><span class="line">   +0x3b0 QueuedScb        : Ptr64 _KSCB</span><br><span class="line">   +0x3b8 ThreadTimerDelay : Uint4B</span><br><span class="line">   +0x3bc ThreadFlags3     : Int4B</span><br><span class="line">   +0x3bc ThreadFlags3Reserved : Pos 0, 8 Bits</span><br><span class="line">   +0x3bc PpmPolicy        : Pos 8, 2 Bits</span><br><span class="line">   +0x3bc ThreadFlags3Reserved2 : Pos 10, 22 Bits</span><br><span class="line">   +0x3c0 TracingPrivate   : [1] Uint8B</span><br><span class="line">   +0x3c8 SchedulerAssist  : Ptr64 Void</span><br><span class="line">   +0x3d0 AbWaitObject     : Ptr64 Void</span><br><span class="line">   +0x3d8 ReservedPreviousReadyTimeValue : Uint4B</span><br><span class="line">   +0x3e0 KernelWaitTime   : Uint8B</span><br><span class="line">   +0x3e8 UserWaitTime     : Uint8B</span><br><span class="line">   +0x3f0 GlobalUpdateVpThreadPriorityListEntry : _LIST_ENTRY</span><br><span class="line">   +0x3f0 UpdateVpThreadPriorityDpcStackListEntry : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x3f8 InGlobalUpdateVpThreadPriorityList : Uint8B</span><br><span class="line">   +0x400 SchedulerAssistPriorityFloor : Int4B</span><br><span class="line">   +0x404 Spare28          : Uint4B</span><br><span class="line">   +0x408 EndPadding       : [5] Uint8B</span><br></pre></td></tr></table></figure>

<p>上述State状态有：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>值</th>
<th>含义</th>
<th>可转换到的状态</th>
</tr>
</thead>
<tbody><tr>
<td>Initialized</td>
<td>0</td>
<td>正在创建和初始化</td>
<td>DeferredReady</td>
</tr>
<tr>
<td>Ready</td>
<td>1</td>
<td>就绪，可被分发调度运行</td>
<td>Running</td>
</tr>
<tr>
<td>Running</td>
<td>2</td>
<td>正在某个CPU上运行</td>
<td>Waiting、Terminated</td>
</tr>
<tr>
<td>Standby</td>
<td>3</td>
<td>待命，即下一个要执行的线程</td>
<td>Running、DeferredReady、被抢先Preempt</td>
</tr>
<tr>
<td>Terminated</td>
<td>4</td>
<td>结束执行</td>
<td></td>
</tr>
<tr>
<td>Waiting</td>
<td>5</td>
<td>等待，如睡眠函数、取消息函数、等待同步对象等，主动放弃执行机会</td>
<td>Transition、DeferredReady、Running</td>
</tr>
<tr>
<td>Transition</td>
<td>6</td>
<td>过渡状态，线程已可以运行但内核栈被交换出内存，交换回后进入Standby</td>
<td>DeferredReady</td>
</tr>
<tr>
<td>DeferredReady</td>
<td>7</td>
<td>延迟就绪，为缩短扫描调度数据库加锁时间，内核把就绪线程设置为次状态</td>
<td>Ready</td>
</tr>
<tr>
<td>Gate Wait</td>
<td>8</td>
<td>门状态，等待门分发器对象时进入</td>
<td></td>
</tr>
</tbody></table>
<p>上述WaitReason为KWAIT_REASON枚举类型，常见如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; dt _KWAIT_REASON</span><br><span class="line">nt!_KWAIT_REASON</span><br><span class="line">   Executive = 0n0 //驱动程序调用等待函数时</span><br><span class="line">   FreePage = 0n1 //等待空闲页</span><br><span class="line">   PageIn = 0n2 //等待把交换处的内存页换回</span><br><span class="line">   PoolAllocation = 0n3</span><br><span class="line">   DelayExecution = 0n4 //延迟执行 一般Sleep或NtDelayExecution</span><br><span class="line">   Suspended = 0n5 //线程被挂起</span><br><span class="line">   UserRequest = 0n6 //驱动程序代表应用代码调用等待函数</span><br><span class="line">   WrExecutive = 0n7 //LPC函数用这个常量调用等待函数</span><br><span class="line">   WrFreePage = 0n8 //等待空闲页</span><br><span class="line">   WrPageIn = 0n9 //等待交换出去的内存页换回内存</span><br><span class="line">   WrPoolAllocation = 0n10 //内核池有关</span><br><span class="line">   WrDelayExecution = 0n11 //同DelayExecution</span><br><span class="line">   WrSuspended = 0n12 //同Suspended</span><br><span class="line">   WrUserRequest = 0n13 //同UserRequest</span><br><span class="line">   WrEventPair = 0n14 //服务端和客户端使用一对时间对象时 用此常量调用等待函数</span><br><span class="line">   WrQueue = 0n15 //等待队列对象</span><br><span class="line">   WrLpcReceive = 0n16 //LPC通信时 为接收数据而等待对方发送</span><br><span class="line">   WrLpcReply = 0n17 //LPC通信时 为发送数据而等待对方接收</span><br><span class="line">   WrVirtualMemory = 0n18 //内存管理器用这个函数调用等待函数</span><br><span class="line">   WrPageOut = 0n19 //内存管理器冲洗缓冲区并把内存中数据写入磁盘时用此常量调用等待函数</span><br><span class="line">   WrRendezvous = 0n20</span><br><span class="line">   WrKeyedEvent = 0n21</span><br><span class="line">   WrTerminated = 0n22</span><br><span class="line">   WrProcessInSwap = 0n23</span><br><span class="line">   WrCpuRateControl = 0n24</span><br><span class="line">   WrCalloutStack = 0n25</span><br><span class="line">   WrKernel = 0n26</span><br><span class="line">   WrResource = 0n27</span><br><span class="line">   WrPushLock = 0n28</span><br><span class="line">   WrMutex = 0n29 //等待互斥量</span><br><span class="line">   WrQuantumEnd = 0n30 //时间片用完</span><br><span class="line">   WrDispatchInt = 0n31</span><br><span class="line">   WrPreempted = 0n32 //被剥夺执行权</span><br><span class="line">   WrYieldExecution = 0n33 //主动放弃执行权</span><br><span class="line">   WrFastMutex = 0n34 //等待高速互斥量</span><br><span class="line">   WrGuardedMutex = 0n35 //等待保护互斥量</span><br><span class="line">   WrRundown = 0n36</span><br><span class="line">   WrAlertByThreadId = 0n37</span><br><span class="line">   WrDeferredPreempt = 0n38</span><br><span class="line">   WrPhysicalFault = 0n39</span><br><span class="line">   MaximumWaitReason = 0n40 //最大有效值</span><br></pre></td></tr></table></figure>

<p>每个CPU有一个处理器控制块PRCB，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line">1: kd&gt; dt _KPRCB</span><br><span class="line">ntdll!_KPRCB</span><br><span class="line">   +0x000 MxCsr            : Uint4B</span><br><span class="line">   +0x004 LegacyNumber     : UChar</span><br><span class="line">   +0x005 ReservedMustBeZero : UChar</span><br><span class="line">   +0x006 InterruptRequest : UChar</span><br><span class="line">   +0x007 IdleHalt         : UChar</span><br><span class="line">   +0x008 CurrentThread    : Ptr64 _KTHREAD</span><br><span class="line">   +0x010 NextThread       : Ptr64 _KTHREAD</span><br><span class="line">   +0x018 IdleThread       : Ptr64 _KTHREAD</span><br><span class="line">   +0x020 NestingLevel     : UChar</span><br><span class="line">   +0x021 ClockOwner       : UChar</span><br><span class="line">   +0x022 PendingTickFlags : UChar</span><br><span class="line">   +0x022 PendingTick      : Pos 0, 1 Bit</span><br><span class="line">   +0x022 PendingBackupTick : Pos 1, 1 Bit</span><br><span class="line">   +0x023 IdleState        : UChar</span><br><span class="line">   +0x024 Number           : Uint4B</span><br><span class="line">   +0x028 RspBase          : Uint8B</span><br><span class="line">   +0x030 PrcbLock         : Uint8B</span><br><span class="line">   +0x038 PriorityState    : Ptr64 Char</span><br><span class="line">   +0x040 CpuType          : Char</span><br><span class="line">   +0x041 CpuID            : Char</span><br><span class="line">   +0x042 CpuStep          : Uint2B</span><br><span class="line">   +0x042 CpuStepping      : UChar</span><br><span class="line">   +0x043 CpuModel         : UChar</span><br><span class="line">   +0x044 MHz              : Uint4B</span><br><span class="line">   +0x048 HalReserved      : [8] Uint8B</span><br><span class="line">   +0x088 MinorVersion     : Uint2B</span><br><span class="line">   +0x08a MajorVersion     : Uint2B</span><br><span class="line">   +0x08c BuildType        : UChar</span><br><span class="line">   +0x08d CpuVendor        : UChar</span><br><span class="line">   +0x08e CoresPerPhysicalProcessor : UChar</span><br><span class="line">   +0x08f LogicalProcessorsPerCore : UChar</span><br><span class="line">   +0x090 TscFrequency     : Uint8B</span><br><span class="line">   +0x098 PrcbPad04        : [5] Uint8B</span><br><span class="line">   +0x0c0 ParentNode       : Ptr64 _KNODE</span><br><span class="line">   +0x0c8 GroupSetMember   : Uint8B</span><br><span class="line">   +0x0d0 Group            : UChar</span><br><span class="line">   +0x0d1 GroupIndex       : UChar</span><br><span class="line">   +0x0d2 PrcbPad05        : [2] UChar</span><br><span class="line">   +0x0d4 InitialApicId    : Uint4B</span><br><span class="line">   +0x0d8 ScbOffset        : Uint4B</span><br><span class="line">   +0x0dc ApicMask         : Uint4B</span><br><span class="line">   +0x0e0 AcpiReserved     : Ptr64 Void</span><br><span class="line">   +0x0e8 CFlushSize       : Uint4B</span><br><span class="line">   +0x0ec PrcbFlags        : _KPRCBFLAG</span><br><span class="line">   +0x0f0 TrappedSecurityDomain : Uint8B</span><br><span class="line">   +0x0f8 BpbState         : UChar</span><br><span class="line">   +0x0f8 BpbCpuIdle       : Pos 0, 1 Bit</span><br><span class="line">   +0x0f8 BpbFlushRsbOnTrap : Pos 1, 1 Bit</span><br><span class="line">   +0x0f8 BpbIbpbOnReturn  : Pos 2, 1 Bit</span><br><span class="line">   +0x0f8 BpbIbpbOnTrap    : Pos 3, 1 Bit</span><br><span class="line">   +0x0f8 BpbIbpbOnRetpolineExit : Pos 4, 1 Bit</span><br><span class="line">   +0x0f8 BpbStateReserved : Pos 5, 3 Bits</span><br><span class="line">   +0x0f9 BpbFeatures      : UChar</span><br><span class="line">   +0x0f9 BpbClearOnIdle   : Pos 0, 1 Bit</span><br><span class="line">   +0x0f9 BpbEnabled       : Pos 1, 1 Bit</span><br><span class="line">   +0x0f9 BpbSmep          : Pos 2, 1 Bit</span><br><span class="line">   +0x0f9 BpbFeaturesReserved : Pos 3, 5 Bits</span><br><span class="line">   +0x0fa BpbCurrentSpecCtrl : UChar</span><br><span class="line">   +0x0fb BpbKernelSpecCtrl : UChar</span><br><span class="line">   +0x0fc BpbNmiSpecCtrl   : UChar</span><br><span class="line">   +0x0fd BpbUserSpecCtrl  : UChar</span><br><span class="line">   +0x0fe PairRegister     : Int2B</span><br><span class="line">   +0x0f0 PrcbPad11        : [2] Uint8B</span><br><span class="line">   +0x100 ProcessorState   : _KPROCESSOR_STATE</span><br><span class="line">   +0x6c0 ExtendedSupervisorState : Ptr64 _XSAVE_AREA_HEADER</span><br><span class="line">   +0x6c8 ProcessorSignature : Uint4B</span><br><span class="line">   +0x6cc ProcessorFlags   : Uint4B</span><br><span class="line">   +0x6d0 BpbRetpolineExitSpecCtrl : UChar</span><br><span class="line">   +0x6d1 BpbTrappedRetpolineExitSpecCtrl : UChar</span><br><span class="line">   +0x6d2 BpbTrappedBpbState : UChar</span><br><span class="line">   +0x6d2 BpbTrappedCpuIdle : Pos 0, 1 Bit</span><br><span class="line">   +0x6d2 BpbTrappedFlushRsbOnTrap : Pos 1, 1 Bit</span><br><span class="line">   +0x6d2 BpbTrappedIbpbOnReturn : Pos 2, 1 Bit</span><br><span class="line">   +0x6d2 BpbTrappedIbpbOnTrap : Pos 3, 1 Bit</span><br><span class="line">   +0x6d2 BpbTrappedIbpbOnRetpolineExit : Pos 4, 1 Bit</span><br><span class="line">   +0x6d2 BpbtrappedBpbStateReserved : Pos 5, 3 Bits</span><br><span class="line">   +0x6d3 BpbRetpolineState : UChar</span><br><span class="line">   +0x6d3 BpbRunningNonRetpolineCode : Pos 0, 1 Bit</span><br><span class="line">   +0x6d3 BpbIndirectCallsSafe : Pos 1, 1 Bit</span><br><span class="line">   +0x6d3 BpbRetpolineEnabled : Pos 2, 1 Bit</span><br><span class="line">   +0x6d3 BpbRetpolineStateReserved : Pos 3, 5 Bits</span><br><span class="line">   +0x6d4 PrcbPad12b       : Uint4B</span><br><span class="line">   +0x6d0 PrcbPad12a       : Uint8B</span><br><span class="line">   +0x6d8 PrcbPad12        : [3] Uint8B</span><br><span class="line">   +0x6f0 LockQueue        : [17] _KSPIN_LOCK_QUEUE</span><br><span class="line">   +0x800 PPLookasideList  : [16] _PP_LOOKASIDE_LIST</span><br><span class="line">   +0x900 PPNxPagedLookasideList : [32] _GENERAL_LOOKASIDE_POOL</span><br><span class="line">   +0x1500 PPNPagedLookasideList : [32] _GENERAL_LOOKASIDE_POOL</span><br><span class="line">   +0x2100 PPPagedLookasideList : [32] _GENERAL_LOOKASIDE_POOL</span><br><span class="line">   +0x2d00 PrcbPad20        : Uint8B</span><br><span class="line">   +0x2d08 DeferredReadyListHead : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x2d10 MmPageFaultCount : Int4B</span><br><span class="line">   +0x2d14 MmCopyOnWriteCount : Int4B</span><br><span class="line">   +0x2d18 MmTransitionCount : Int4B</span><br><span class="line">   +0x2d1c MmDemandZeroCount : Int4B</span><br><span class="line">   +0x2d20 MmPageReadCount  : Int4B</span><br><span class="line">   +0x2d24 MmPageReadIoCount : Int4B</span><br><span class="line">   +0x2d28 MmDirtyPagesWriteCount : Int4B</span><br><span class="line">   +0x2d2c MmDirtyWriteIoCount : Int4B</span><br><span class="line">   +0x2d30 MmMappedPagesWriteCount : Int4B</span><br><span class="line">   +0x2d34 MmMappedWriteIoCount : Int4B</span><br><span class="line">   +0x2d38 KeSystemCalls    : Uint4B</span><br><span class="line">   +0x2d3c KeContextSwitches : Uint4B</span><br><span class="line">   +0x2d40 PrcbPad40        : Uint4B</span><br><span class="line">   +0x2d44 CcFastReadNoWait : Uint4B</span><br><span class="line">   +0x2d48 CcFastReadWait   : Uint4B</span><br><span class="line">   +0x2d4c CcFastReadNotPossible : Uint4B</span><br><span class="line">   +0x2d50 CcCopyReadNoWait : Uint4B</span><br><span class="line">   +0x2d54 CcCopyReadWait   : Uint4B</span><br><span class="line">   +0x2d58 CcCopyReadNoWaitMiss : Uint4B</span><br><span class="line">   +0x2d5c IoReadOperationCount : Int4B</span><br><span class="line">   +0x2d60 IoWriteOperationCount : Int4B</span><br><span class="line">   +0x2d64 IoOtherOperationCount : Int4B</span><br><span class="line">   +0x2d68 IoReadTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x2d70 IoWriteTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x2d78 IoOtherTransferCount : _LARGE_INTEGER</span><br><span class="line">   +0x2d80 PacketBarrier    : Int4B</span><br><span class="line">   +0x2d84 TargetCount      : Int4B</span><br><span class="line">   +0x2d88 IpiFrozen        : Uint4B</span><br><span class="line">   +0x2d8c PrcbPad30        : Uint4B</span><br><span class="line">   +0x2d90 IsrDpcStats      : Ptr64 Void</span><br><span class="line">   +0x2d98 DeviceInterrupts : Uint4B</span><br><span class="line">   +0x2d9c LookasideIrpFloat : Int4B</span><br><span class="line">   +0x2da0 InterruptLastCount : Uint4B</span><br><span class="line">   +0x2da4 InterruptRate    : Uint4B</span><br><span class="line">   +0x2da8 PrcbPad31        : Uint8B</span><br><span class="line">   +0x2db0 PairPrcb         : Ptr64 _KPRCB</span><br><span class="line">   +0x2db8 StaticAffinity   : _KSTATIC_AFFINITY_BLOCK</span><br><span class="line">   +0x3058 PrcbPad35        : [5] Uint8B</span><br><span class="line">   +0x3080 InterruptObjectPool : _SLIST_HEADER</span><br><span class="line">   +0x3090 DpcRuntimeHistoryHashTable : Ptr64 _RTL_HASH_TABLE</span><br><span class="line">   +0x3098 DpcRuntimeHistoryHashTableCleanupDpc : Ptr64 _KDPC</span><br><span class="line">   +0x30a0 CurrentDpcRoutine : Ptr64     void </span><br><span class="line">   +0x30a8 CurrentDpcRuntimeHistoryCached : Uint8B</span><br><span class="line">   +0x30b0 CurrentDpcStartTime : Uint8B</span><br><span class="line">   +0x30b8 PrcbPad41        : [1] Uint8B</span><br><span class="line">   +0x30c0 DpcData          : [2] _KDPC_DATA</span><br><span class="line">   +0x3110 DpcStack         : Ptr64 Void</span><br><span class="line">   +0x3118 MaximumDpcQueueDepth : Int4B</span><br><span class="line">   +0x311c DpcRequestRate   : Uint4B</span><br><span class="line">   +0x3120 MinimumDpcRate   : Uint4B</span><br><span class="line">   +0x3124 DpcLastCount     : Uint4B</span><br><span class="line">   +0x3128 ThreadDpcEnable  : UChar</span><br><span class="line">   +0x3129 QuantumEnd       : UChar</span><br><span class="line">   +0x312a DpcRoutineActive : UChar</span><br><span class="line">   +0x312b IdleSchedule     : UChar</span><br><span class="line">   +0x312c DpcRequestSummary : Int4B</span><br><span class="line">   +0x312c DpcRequestSlot   : [2] Int2B</span><br><span class="line">   +0x312c NormalDpcState   : Int2B</span><br><span class="line">   +0x312e ThreadDpcState   : Int2B</span><br><span class="line">   +0x312c DpcNormalProcessingActive : Pos 0, 1 Bit</span><br><span class="line">   +0x312c DpcNormalProcessingRequested : Pos 1, 1 Bit</span><br><span class="line">   +0x312c DpcNormalThreadSignal : Pos 2, 1 Bit</span><br><span class="line">   +0x312c DpcNormalTimerExpiration : Pos 3, 1 Bit</span><br><span class="line">   +0x312c DpcNormalDpcPresent : Pos 4, 1 Bit</span><br><span class="line">   +0x312c DpcNormalLocalInterrupt : Pos 5, 1 Bit</span><br><span class="line">   +0x312c DpcNormalSpare   : Pos 6, 10 Bits</span><br><span class="line">   +0x312c DpcThreadActive  : Pos 16, 1 Bit</span><br><span class="line">   +0x312c DpcThreadRequested : Pos 17, 1 Bit</span><br><span class="line">   +0x312c DpcThreadSpare   : Pos 18, 14 Bits</span><br><span class="line">   +0x3130 PrcbPad93        : Uint4B</span><br><span class="line">   +0x3134 LastTick         : Uint4B</span><br><span class="line">   +0x3138 ClockInterrupts  : Uint4B</span><br><span class="line">   +0x313c ReadyScanTick    : Uint4B</span><br><span class="line">   +0x3140 InterruptObject  : [256] Ptr64 Void</span><br><span class="line">   +0x3940 TimerTable       : _KTIMER_TABLE</span><br><span class="line">   +0x7b58 PrcbPad92        : [10] Uint4B</span><br><span class="line">   +0x7b80 DpcGate          : _KGATE</span><br><span class="line">   +0x7b98 PrcbPad52        : Ptr64 Void</span><br><span class="line">   +0x7ba0 CallDpc          : _KDPC</span><br><span class="line">   +0x7be0 ClockKeepAlive   : Int4B</span><br><span class="line">   +0x7be4 PrcbPad60        : [2] UChar</span><br><span class="line">   +0x7be6 NmiActive        : UChar</span><br><span class="line">   +0x7be7 MceActive        : UChar</span><br><span class="line">   +0x7be6 CombinedNmiMceActive : Uint2B</span><br><span class="line">   +0x7be8 DpcWatchdogPeriod : Int4B</span><br><span class="line">   +0x7bec DpcWatchdogCount : Int4B</span><br><span class="line">   +0x7bf0 KeSpinLockOrdering : Int4B</span><br><span class="line">   +0x7bf4 DpcWatchdogProfileCumulativeDpcThreshold : Uint4B</span><br><span class="line">   +0x7bf8 CachedPtes       : Ptr64 Void</span><br><span class="line">   +0x7c00 WaitListHead     : _LIST_ENTRY</span><br><span class="line">   +0x7c10 WaitLock         : Uint8B</span><br><span class="line">   +0x7c18 ReadySummary     : Uint4B</span><br><span class="line">   +0x7c1c AffinitizedSelectionMask : Int4B</span><br><span class="line">   +0x7c20 QueueIndex       : Uint4B</span><br><span class="line">   +0x7c24 PrcbPad75        : [2] Uint4B</span><br><span class="line">   +0x7c2c DpcWatchdogSequenceNumber : Uint4B</span><br><span class="line">   +0x7c30 TimerExpirationDpc : _KDPC</span><br><span class="line">   +0x7c70 ScbQueue         : _RTL_RB_TREE</span><br><span class="line">   +0x7c80 DispatcherReadyListHead : [32] _LIST_ENTRY //每个优先级对应的就绪线程</span><br><span class="line">   +0x7e80 InterruptCount   : Uint4B</span><br><span class="line">   +0x7e84 KernelTime       : Uint4B</span><br><span class="line">   +0x7e88 UserTime         : Uint4B</span><br><span class="line">   +0x7e8c DpcTime          : Uint4B</span><br><span class="line">   +0x7e90 InterruptTime    : Uint4B</span><br><span class="line">   +0x7e94 AdjustDpcThreshold : Uint4B</span><br><span class="line">   +0x7e98 DebuggerSavedIRQL : UChar</span><br><span class="line">   +0x7e99 GroupSchedulingOverQuota : UChar</span><br><span class="line">   +0x7e9a DeepSleep        : UChar</span><br><span class="line">   +0x7e9b PrcbPad80        : UChar</span><br><span class="line">   +0x7e9c DpcTimeCount     : Uint4B</span><br><span class="line">   +0x7ea0 DpcTimeLimit     : Uint4B</span><br><span class="line">   +0x7ea4 PeriodicCount    : Uint4B</span><br><span class="line">   +0x7ea8 PeriodicBias     : Uint4B</span><br><span class="line">   +0x7eac AvailableTime    : Uint4B</span><br><span class="line">   +0x7eb0 KeExceptionDispatchCount : Uint4B</span><br><span class="line">   +0x7eb4 ReadyThreadCount : Uint4B</span><br><span class="line">   +0x7eb8 ReadyQueueExpectedRunTime : Uint8B</span><br><span class="line">   +0x7ec0 StartCycles      : Uint8B</span><br><span class="line">   +0x7ec8 TaggedCyclesStart : Uint8B</span><br><span class="line">   +0x7ed0 TaggedCycles     : [3] Uint8B</span><br><span class="line">   +0x7ee8 AffinitizedCycles : Uint8B</span><br><span class="line">   +0x7ef0 ImportantCycles  : Uint8B</span><br><span class="line">   +0x7ef8 UnimportantCycles : Uint8B</span><br><span class="line">   +0x7f00 DpcWatchdogProfileSingleDpcThreshold : Uint4B</span><br><span class="line">   +0x7f04 MmSpinLockOrdering : Int4B</span><br><span class="line">   +0x7f08 CachedStack      : Ptr64 Void</span><br><span class="line">   +0x7f10 PageColor        : Uint4B</span><br><span class="line">   +0x7f14 NodeColor        : Uint4B</span><br><span class="line">   +0x7f18 NodeShiftedColor : Uint4B</span><br><span class="line">   +0x7f1c SecondaryColorMask : Uint4B</span><br><span class="line">   +0x7f20 PrcbPad81        : [6] UChar</span><br><span class="line">   +0x7f26 ExceptionStackActive : UChar</span><br><span class="line">   +0x7f27 TbFlushListActive : UChar</span><br><span class="line">   +0x7f28 ExceptionStack   : Ptr64 Void</span><br><span class="line">   +0x7f30 PrcbPad82        : [1] Uint8B</span><br><span class="line">   +0x7f38 CycleTime        : Uint8B</span><br><span class="line">   +0x7f40 Cycles           : [4] [2] Uint8B</span><br><span class="line">   +0x7f80 CcFastMdlReadNoWait : Uint4B</span><br><span class="line">   +0x7f84 CcFastMdlReadWait : Uint4B</span><br><span class="line">   +0x7f88 CcFastMdlReadNotPossible : Uint4B</span><br><span class="line">   +0x7f8c CcMapDataNoWait  : Uint4B</span><br><span class="line">   +0x7f90 CcMapDataWait    : Uint4B</span><br><span class="line">   +0x7f94 CcPinMappedDataCount : Uint4B</span><br><span class="line">   +0x7f98 CcPinReadNoWait  : Uint4B</span><br><span class="line">   +0x7f9c CcPinReadWait    : Uint4B</span><br><span class="line">   +0x7fa0 CcMdlReadNoWait  : Uint4B</span><br><span class="line">   +0x7fa4 CcMdlReadWait    : Uint4B</span><br><span class="line">   +0x7fa8 CcLazyWriteHotSpots : Uint4B</span><br><span class="line">   +0x7fac CcLazyWriteIos   : Uint4B</span><br><span class="line">   +0x7fb0 CcLazyWritePages : Uint4B</span><br><span class="line">   +0x7fb4 CcDataFlushes    : Uint4B</span><br><span class="line">   +0x7fb8 CcDataPages      : Uint4B</span><br><span class="line">   +0x7fbc CcLostDelayedWrites : Uint4B</span><br><span class="line">   +0x7fc0 CcFastReadResourceMiss : Uint4B</span><br><span class="line">   +0x7fc4 CcCopyReadWaitMiss : Uint4B</span><br><span class="line">   +0x7fc8 CcFastMdlReadResourceMiss : Uint4B</span><br><span class="line">   +0x7fcc CcMapDataNoWaitMiss : Uint4B</span><br><span class="line">   +0x7fd0 CcMapDataWaitMiss : Uint4B</span><br><span class="line">   +0x7fd4 CcPinReadNoWaitMiss : Uint4B</span><br><span class="line">   +0x7fd8 CcPinReadWaitMiss : Uint4B</span><br><span class="line">   +0x7fdc CcMdlReadNoWaitMiss : Uint4B</span><br><span class="line">   +0x7fe0 CcMdlReadWaitMiss : Uint4B</span><br><span class="line">   +0x7fe4 CcReadAheadIos   : Uint4B</span><br><span class="line">   +0x7fe8 MmCacheTransitionCount : Int4B</span><br><span class="line">   +0x7fec MmCacheReadCount : Int4B</span><br><span class="line">   +0x7ff0 MmCacheIoCount   : Int4B</span><br><span class="line">   +0x7ff4 PrcbPad91        : Uint4B</span><br><span class="line">   +0x7ff8 MmInternal       : Ptr64 Void</span><br><span class="line">   +0x8000 PowerState       : _PROCESSOR_POWER_STATE</span><br><span class="line">   +0x8200 HyperPte         : Ptr64 Void</span><br><span class="line">   +0x8208 ScbList          : _LIST_ENTRY</span><br><span class="line">   +0x8218 ForceIdleDpc     : _KDPC</span><br><span class="line">   +0x8258 DpcWatchdogDpc   : _KDPC</span><br><span class="line">   +0x8298 DpcWatchdogTimer : _KTIMER</span><br><span class="line">   +0x82d8 Cache            : [5] _CACHE_DESCRIPTOR</span><br><span class="line">   +0x8314 CacheCount       : Uint4B</span><br><span class="line">   +0x8318 CachedCommit     : Uint4B</span><br><span class="line">   +0x831c CachedResidentAvailable : Uint4B</span><br><span class="line">   +0x8320 WheaInfo         : Ptr64 Void</span><br><span class="line">   +0x8328 EtwSupport       : Ptr64 Void</span><br><span class="line">   +0x8330 ExSaPageArray    : Ptr64 Void</span><br><span class="line">   +0x8338 KeAlignmentFixupCount : Uint4B</span><br><span class="line">   +0x833c PrcbPad95        : Uint4B</span><br><span class="line">   +0x8340 HypercallPageList : _SLIST_HEADER</span><br><span class="line">   +0x8350 StatisticsPage   : Ptr64 Uint8B</span><br><span class="line">   +0x8358 GenerationTarget : Uint8B</span><br><span class="line">   +0x8360 PrcbPad85        : [4] Uint8B</span><br><span class="line">   +0x8380 HypercallCachedPages : Ptr64 Void</span><br><span class="line">   +0x8388 VirtualApicAssist : Ptr64 Void</span><br><span class="line">   +0x8390 PackageProcessorSet : _KAFFINITY_EX</span><br><span class="line">   +0x8438 PackageId        : Uint4B</span><br><span class="line">   +0x843c PrcbPad86        : Uint4B</span><br><span class="line">   +0x8440 SharedReadyQueueMask : Uint8B</span><br><span class="line">   +0x8448 SharedReadyQueue : Ptr64 _KSHARED_READY_QUEUE</span><br><span class="line">   +0x8450 SharedQueueScanOwner : Uint4B</span><br><span class="line">   +0x8454 ScanSiblingIndex : Uint4B</span><br><span class="line">   +0x8458 CoreProcessorSet : Uint8B</span><br><span class="line">   +0x8460 ScanSiblingMask  : Uint8B</span><br><span class="line">   +0x8468 LLCMask          : Uint8B</span><br><span class="line">   +0x8470 CacheProcessorMask : [5] Uint8B</span><br><span class="line">   +0x8498 ProcessorProfileControlArea : Ptr64 _PROCESSOR_PROFILE_CONTROL_AREA</span><br><span class="line">   +0x84a0 ProfileEventIndexAddress : Ptr64 Void</span><br><span class="line">   +0x84a8 DpcWatchdogProfile : Ptr64 Ptr64 Void</span><br><span class="line">   +0x84b0 DpcWatchdogProfileCurrentEmptyCapture : Ptr64 Ptr64 Void</span><br><span class="line">   +0x84b8 SchedulerAssist  : Ptr64 Void</span><br><span class="line">   +0x84c0 SynchCounters    : _SYNCH_COUNTERS</span><br><span class="line">   +0x8578 PrcbPad94        : Uint8B</span><br><span class="line">   +0x8580 FsCounters       : _FILESYSTEM_DISK_COUNTERS</span><br><span class="line">   +0x8590 VendorString     : [13] UChar</span><br><span class="line">   +0x859d PrcbPad100       : [3] UChar</span><br><span class="line">   +0x85a0 FeatureBits      : Uint8B</span><br><span class="line">   +0x85a8 UpdateSignature  : _LARGE_INTEGER</span><br><span class="line">   +0x85b0 PteBitCache      : Uint8B</span><br><span class="line">   +0x85b8 PteBitOffset     : Uint4B</span><br><span class="line">   +0x85bc PrcbPad105       : Uint4B</span><br><span class="line">   +0x85c0 Context          : Ptr64 _CONTEXT</span><br><span class="line">   +0x85c8 ContextFlagsInit : Uint4B</span><br><span class="line">   +0x85cc PrcbPad115       : Uint4B</span><br><span class="line">   +0x85d0 ExtendedState    : Ptr64 _XSAVE_AREA</span><br><span class="line">   +0x85d8 IsrStack         : Ptr64 Void</span><br><span class="line">   +0x85e0 EntropyTimingState : _KENTROPY_TIMING_STATE</span><br><span class="line">   +0x8730 PrcbPad110       : Uint8B</span><br><span class="line">   +0x8738 StibpPairingTrace : &lt;anonymous-tag&gt;</span><br><span class="line">   +0x8770 AbSelfIoBoostsList : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x8778 AbPropagateBoostsList : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x8780 AbDpc            : _KDPC</span><br><span class="line">   +0x87c0 IoIrpStackProfilerCurrent : _IOP_IRP_STACK_PROFILER</span><br><span class="line">   +0x8814 IoIrpStackProfilerPrevious : _IOP_IRP_STACK_PROFILER</span><br><span class="line">   +0x8868 SecureFault      : _KSECURE_FAULT_INFORMATION</span><br><span class="line">   +0x8878 PrcbPad120       : Uint8B</span><br><span class="line">   +0x8880 LocalSharedReadyQueue : _KSHARED_READY_QUEUE</span><br><span class="line">   +0x8af0 PrcbPad125       : [2] Uint8B</span><br><span class="line">   +0x8b00 TimerExpirationTraceCount : Uint4B</span><br><span class="line">   +0x8b04 PrcbPad127       : Uint4B</span><br><span class="line">   +0x8b08 TimerExpirationTrace : [16] _KTIMER_EXPIRATION_TRACE</span><br><span class="line">   +0x8c08 PrcbPad128       : [7] Uint8B</span><br><span class="line">   +0x8c40 Mailbox          : Ptr64 _REQUEST_MAILBOX</span><br><span class="line">   +0x8c48 PrcbPad130       : [7] Uint8B</span><br><span class="line">   +0x8c80 McheckContext    : [2] _MACHINE_CHECK_CONTEXT</span><br><span class="line">   +0x8d20 PrcbPad134       : [4] Uint8B</span><br><span class="line">   +0x8d40 SelfmapLockHandle : [4] _KLOCK_QUEUE_HANDLE</span><br><span class="line">   +0x8da0 PrcbPad134a      : [4] Uint8B</span><br><span class="line">   +0x8dc0 PrcbPad138       : [128] UChar</span><br><span class="line">   +0x8e40 PrcbPad138a      : [64] UChar</span><br><span class="line">   +0x8e80 KernelDirectoryTableBase : Uint8B</span><br><span class="line">   +0x8e88 RspBaseShadow    : Uint8B</span><br><span class="line">   +0x8e90 UserRspShadow    : Uint8B</span><br><span class="line">   +0x8e98 ShadowFlags      : Uint4B</span><br><span class="line">   +0x8e9c PrcbPad138b      : Uint4B</span><br><span class="line">   +0x8ea0 PrcbPad138c      : Uint8B</span><br><span class="line">   +0x8ea8 PrcbPad138d      : Uint2B</span><br><span class="line">   +0x8eaa PrcbPad138e      : Uint2B</span><br><span class="line">   +0x8eac DbgMceNestingLevel : Uint4B</span><br><span class="line">   +0x8eb0 DbgMceFlags      : Uint4B</span><br><span class="line">   +0x8eb4 PrcbPad139b      : Uint4B</span><br><span class="line">   +0x8eb8 PrcbPad140       : [505] Uint8B</span><br><span class="line">   +0x9e80 PrcbPad140a      : [8] Uint8B</span><br><span class="line">   +0x9ec0 PrcbPad141       : [504] Uint8B</span><br><span class="line">   +0xae80 PrcbPad141a      : [64] UChar</span><br><span class="line">   +0xaec0 RequestMailbox   : [1] _REQUEST_MAILBOX</span><br></pre></td></tr></table></figure>

<p>其中DispatcherReadyListHead的32个元素对应32个优先级，每个元素为LIST_ENTRY链表头，挂接对应优先级就绪进程。</p>
<p>ETHREAD一般用更为友好的方式显示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0: kd&gt; !thread</span><br><span class="line">THREAD fffff80710727600  Cid 0000.0000  Teb: 0000000000000000 Win32Thread: 0000000000000000 RUNNING on processor 0</span><br><span class="line">Not impersonating</span><br><span class="line">DeviceMap                 ffffa48a85247ba0</span><br><span class="line">Owning Process            fffff80710724a00       Image:         Idle</span><br><span class="line">Attached Process          ffff8f8d11476040       Image:         System</span><br><span class="line">Wait Start TickCount      18350          Ticks: 3452 (0:00:00:53.937)</span><br><span class="line">Context Switch Count      46719          IdealProcessor: 0             </span><br><span class="line">UserTime                  00:00:00.000</span><br><span class="line">KernelTime                00:05:19.328</span><br><span class="line">Win32 Start Address nt!KiIdleLoop (0xfffff8070fdf8ce0)</span><br><span class="line">Stack Init fffff80714e7fc90 Current fffff80714e7fc20</span><br><span class="line">Base fffff80714e80000 Limit fffff80714e7a000 Call 0000000000000000</span><br><span class="line">Priority 0 BasePriority 0 PriorityDecrement 0 IoPriority 0 PagePriority 5</span><br><span class="line">Child-SP          RetAddr               : Args to Child                                                           : Call Site</span><br><span class="line">fffff807`14e8dc58 fffff807`0fe93972     : fffff807`0d516180 00000000`00000001 00000000`00000000 00000000`00005529 : nt!DbgBreakPointWithStatus</span><br><span class="line">fffff807`14e8dc60 fffff807`0fe87427     : 00000000`00000000 00000000`00000246 00000000`0000552a fffff807`0d516180 : nt!KdCheckForDebugBreak+0x112216</span><br><span class="line">fffff807`14e8dc90 fffff807`0fd2c2cd     : 00000000`00000000 fffff807`0d516180 00000000`00000246 00000000`0000552a : nt!KeAccumulateTicks+0x15e377</span><br><span class="line">fffff807`14e8dcf0 fffff807`0fd2c871     : 00000000`0000552a 00000000`000032c3 fffff807`0d516180 00000000`00000001 : nt!KiUpdateRunTime+0x5d</span><br><span class="line">fffff807`14e8dd40 fffff807`0fd266e3     : fffff807`14e7f510 00000000`00000000 fffff807`10631650 00000000`00000000 : nt!KiUpdateTime+0x4a1</span><br><span class="line">fffff807`14e8de80 fffff807`0fd2eff2     : fffff807`14e7f510 fffff807`14e7f590 fffff807`14e7f500 00000000`00000000 : nt!KeClockInterruptNotify+0x2e3</span><br><span class="line">fffff807`14e8df30 fffff807`0fc2ecd5     : 00000003`ebc24363 fffff807`106f39e0 fffff807`106f3a90 ffff8f8d`1143d010 : nt!HalpTimerClockInterrupt+0xe2</span><br><span class="line">fffff807`14e8df60 fffff807`0fdf6cba     : fffff807`14e7f590 fffff807`106f39e0 00000000`ffffffff 00000000`00000000 : nt!KiCallInterruptServiceRoutine+0xa5</span><br><span class="line">fffff807`14e8dfb0 fffff807`0fdf7227     : 00000000`00000000 00000000`00000000 ffffe600`6252a100 ffff8f8d`12a2f000 : nt!KiInterruptSubDispatchNoLockNoEtw+0xfa (TrapFrame @ fffff807`14e8de70)</span><br><span class="line">fffff807`14e7f510 fffff807`0fdf100f     : fffff807`0fd8d02e 00000003`ebbfe4a9 fffff807`0d516180 00000000`00000000 : nt!KiInterruptDispatchNoLockNoEtw+0x37 (TrapFrame @ fffff807`14e7f510)</span><br><span class="line">fffff807`14e7f6a8 fffff807`0fd8d02e     : 00000003`ebbfe4a9 fffff807`0d516180 00000000`00000000 000003bb`9a9aa6ef : nt!HalProcessorIdle+0xf</span><br><span class="line">fffff807`14e7f6b0 fffff807`0fd28246     : 00000000`000016e5 00000000`00000000 00000000`00000000 00000000`0000aa54 : nt!PpmIdleGuestExecute+0xe</span><br><span class="line">fffff807`14e7f6f0 fffff807`0fd27004     : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!PpmIdleExecuteTransition+0x10c6</span><br><span class="line">fffff807`14e7faf0 fffff807`0fdf8d34     : 00000000`00000000 fffff807`10727600 ffff8f8d`13eed080 00000000`00000723 : nt!PoIdle+0x374</span><br><span class="line">fffff807`14e7fc60 00000000`00000000     : fffff807`14e80000 fffff807`14e7a000 00000000`00000000 00000000`00000000 : nt!KiIdleLoop+0x54</span><br></pre></td></tr></table></figure>

<p>显示就绪状态的线程用<code>!ready</code>。</p>
<p>线程环境块TEBy用<code>!teb</code>获取位置，结构为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; !teb</span><br><span class="line">TEB at 0056a000</span><br><span class="line">    ExceptionList:        047cfabc</span><br><span class="line">    StackBase:            047d0000</span><br><span class="line">    StackLimit:           047cc000</span><br><span class="line">    SubSystemTib:         00000000</span><br><span class="line">    FiberData:            00001e00</span><br><span class="line">    ArbitraryUserPointer: 00000000</span><br><span class="line">    Self:                 0056a000</span><br><span class="line">    EnvironmentPointer:   00000000</span><br><span class="line">    ClientId:             0000024c . 00000be4</span><br><span class="line">    RpcHandle:            00000000</span><br><span class="line">    Tls Storage:          00000000</span><br><span class="line">    PEB Address:          00552000</span><br><span class="line">    LastErrorValue:       0</span><br><span class="line">    LastStatusValue:      0</span><br><span class="line">    Count Owned Locks:    0</span><br><span class="line">    HardErrorMode:        0</span><br><span class="line">0: kd&gt; dt _TEB</span><br><span class="line">win32k!_TEB</span><br><span class="line">   +0x000 NtTib            : _NT_TIB</span><br><span class="line">   +0x038 EnvironmentPointer : Ptr64 Void</span><br><span class="line">   +0x040 ClientId         : _CLIENT_ID</span><br><span class="line">   +0x050 ActiveRpcHandle  : Ptr64 Void</span><br><span class="line">   +0x058 ThreadLocalStoragePointer : Ptr64 Void</span><br><span class="line">   +0x060 ProcessEnvironmentBlock : Ptr64 _PEB</span><br><span class="line">   +0x068 LastErrorValue   : Uint4B</span><br><span class="line">   +0x06c CountOfOwnedCriticalSections : Uint4B</span><br><span class="line">   +0x070 CsrClientThread  : Ptr64 Void</span><br><span class="line">   +0x078 Win32ThreadInfo  : Ptr64 Void</span><br><span class="line">   +0x080 User32Reserved   : [26] Uint4B</span><br><span class="line">   +0x0e8 UserReserved     : [5] Uint4B</span><br><span class="line">   +0x100 WOW32Reserved    : Ptr64 Void</span><br><span class="line">   +0x108 CurrentLocale    : Uint4B</span><br><span class="line">   +0x10c FpSoftwareStatusRegister : Uint4B</span><br><span class="line">   +0x110 ReservedForDebuggerInstrumentation : [16] Ptr64 Void</span><br><span class="line">   +0x190 SystemReserved1  : [30] Ptr64 Void</span><br><span class="line">   +0x280 PlaceholderCompatibilityMode : Char</span><br><span class="line">   +0x281 PlaceholderHydrationAlwaysExplicit : UChar</span><br><span class="line">   +0x282 PlaceholderReserved : [10] Char</span><br><span class="line">   +0x28c ProxiedProcessId : Uint4B</span><br><span class="line">   +0x290 _ActivationStack : _ACTIVATION_CONTEXT_STACK</span><br><span class="line">   +0x2b8 WorkingOnBehalfTicket : [8] UChar</span><br><span class="line">   +0x2c0 ExceptionCode    : Int4B</span><br><span class="line">   +0x2c4 Padding0         : [4] UChar</span><br><span class="line">   +0x2c8 ActivationContextStackPointer : Ptr64 _ACTIVATION_CONTEXT_STACK</span><br><span class="line">   +0x2d0 InstrumentationCallbackSp : Uint8B</span><br><span class="line">   +0x2d8 InstrumentationCallbackPreviousPc : Uint8B</span><br><span class="line">   +0x2e0 InstrumentationCallbackPreviousSp : Uint8B</span><br><span class="line">   +0x2e8 TxFsContext      : Uint4B</span><br><span class="line">   +0x2ec InstrumentationCallbackDisabled : UChar</span><br><span class="line">   +0x2ed UnalignedLoadStoreExceptions : UChar</span><br><span class="line">   +0x2ee Padding1         : [2] UChar</span><br><span class="line">   +0x2f0 GdiTebBatch      : _GDI_TEB_BATCH</span><br><span class="line">   +0x7d8 RealClientId     : _CLIENT_ID</span><br><span class="line">   +0x7e8 GdiCachedProcessHandle : Ptr64 Void</span><br><span class="line">   +0x7f0 GdiClientPID     : Uint4B</span><br><span class="line">   +0x7f4 GdiClientTID     : Uint4B</span><br><span class="line">   +0x7f8 GdiThreadLocalInfo : Ptr64 Void</span><br><span class="line">   +0x800 Win32ClientInfo  : [62] Uint8B</span><br><span class="line">   +0x9f0 glDispatchTable  : [233] Ptr64 Void</span><br><span class="line">   +0x1138 glReserved1      : [29] Uint8B</span><br><span class="line">   +0x1220 glReserved2      : Ptr64 Void</span><br><span class="line">   +0x1228 glSectionInfo    : Ptr64 Void</span><br><span class="line">   +0x1230 glSection        : Ptr64 Void</span><br><span class="line">   +0x1238 glTable          : Ptr64 Void</span><br><span class="line">   +0x1240 glCurrentRC      : Ptr64 Void</span><br><span class="line">   +0x1248 glContext        : Ptr64 Void</span><br><span class="line">   +0x1250 LastStatusValue  : Uint4B</span><br><span class="line">   +0x1254 Padding2         : [4] UChar</span><br><span class="line">   +0x1258 StaticUnicodeString : _UNICODE_STRING</span><br><span class="line">   +0x1268 StaticUnicodeBuffer : [261] Wchar</span><br><span class="line">   +0x1472 Padding3         : [6] UChar</span><br><span class="line">   +0x1478 DeallocationStack : Ptr64 Void</span><br><span class="line">   +0x1480 TlsSlots         : [64] Ptr64 Void</span><br><span class="line">   +0x1680 TlsLinks         : _LIST_ENTRY</span><br><span class="line">   +0x1690 Vdm              : Ptr64 Void</span><br><span class="line">   +0x1698 ReservedForNtRpc : Ptr64 Void</span><br><span class="line">   +0x16a0 DbgSsReserved    : [2] Ptr64 Void</span><br><span class="line">   +0x16b0 HardErrorMode    : Uint4B</span><br><span class="line">   +0x16b4 Padding4         : [4] UChar</span><br><span class="line">   +0x16b8 Instrumentation  : [11] Ptr64 Void</span><br><span class="line">   +0x1710 ActivityId       : _GUID</span><br><span class="line">   +0x1720 SubProcessTag    : Ptr64 Void</span><br><span class="line">   +0x1728 PerflibData      : Ptr64 Void</span><br><span class="line">   +0x1730 EtwTraceData     : Ptr64 Void</span><br><span class="line">   +0x1738 WinSockData      : Ptr64 Void</span><br><span class="line">   +0x1740 GdiBatchCount    : Uint4B</span><br><span class="line">   +0x1744 CurrentIdealProcessor : _PROCESSOR_NUMBER</span><br><span class="line">   +0x1744 IdealProcessorValue : Uint4B</span><br><span class="line">   +0x1744 ReservedPad0     : UChar</span><br><span class="line">   +0x1745 ReservedPad1     : UChar</span><br><span class="line">   +0x1746 ReservedPad2     : UChar</span><br><span class="line">   +0x1747 IdealProcessor   : UChar</span><br><span class="line">   +0x1748 GuaranteedStackBytes : Uint4B</span><br><span class="line">   +0x174c Padding5         : [4] UChar</span><br><span class="line">   +0x1750 ReservedForPerf  : Ptr64 Void</span><br><span class="line">   +0x1758 ReservedForOle   : Ptr64 Void</span><br><span class="line">   +0x1760 WaitingOnLoaderLock : Uint4B</span><br><span class="line">   +0x1764 Padding6         : [4] UChar</span><br><span class="line">   +0x1768 SavedPriorityState : Ptr64 Void</span><br><span class="line">   +0x1770 ReservedForCodeCoverage : Uint8B</span><br><span class="line">   +0x1778 ThreadPoolData   : Ptr64 Void</span><br><span class="line">   +0x1780 TlsExpansionSlots : Ptr64 Ptr64 Void</span><br><span class="line">   +0x1788 DeallocationBStore : Ptr64 Void</span><br><span class="line">   +0x1790 BStoreLimit      : Ptr64 Void</span><br><span class="line">   +0x1798 MuiGeneration    : Uint4B</span><br><span class="line">   +0x179c IsImpersonating  : Uint4B</span><br><span class="line">   +0x17a0 NlsCache         : Ptr64 Void</span><br><span class="line">   +0x17a8 pShimData        : Ptr64 Void</span><br><span class="line">   +0x17b0 HeapData         : Uint4B</span><br><span class="line">   +0x17b4 Padding7         : [4] UChar</span><br><span class="line">   +0x17b8 CurrentTransactionHandle : Ptr64 Void</span><br><span class="line">   +0x17c0 ActiveFrame      : Ptr64 _TEB_ACTIVE_FRAME</span><br><span class="line">   +0x17c8 FlsData          : Ptr64 Void</span><br><span class="line">   +0x17d0 PreferredLanguages : Ptr64 Void</span><br><span class="line">   +0x17d8 UserPrefLanguages : Ptr64 Void</span><br><span class="line">   +0x17e0 MergedPrefLanguages : Ptr64 Void</span><br><span class="line">   +0x17e8 MuiImpersonation : Uint4B</span><br><span class="line">   +0x17ec CrossTebFlags    : Uint2B</span><br><span class="line">   +0x17ec SpareCrossTebBits : Pos 0, 16 Bits</span><br><span class="line">   +0x17ee SameTebFlags     : Uint2B</span><br><span class="line">   +0x17ee SafeThunkCall    : Pos 0, 1 Bit</span><br><span class="line">   +0x17ee InDebugPrint     : Pos 1, 1 Bit</span><br><span class="line">   +0x17ee HasFiberData     : Pos 2, 1 Bit</span><br><span class="line">   +0x17ee SkipThreadAttach : Pos 3, 1 Bit</span><br><span class="line">   +0x17ee WerInShipAssertCode : Pos 4, 1 Bit</span><br><span class="line">   +0x17ee RanProcessInit   : Pos 5, 1 Bit</span><br><span class="line">   +0x17ee ClonedThread     : Pos 6, 1 Bit</span><br><span class="line">   +0x17ee SuppressDebugMsg : Pos 7, 1 Bit</span><br><span class="line">   +0x17ee DisableUserStackWalk : Pos 8, 1 Bit</span><br><span class="line">   +0x17ee RtlExceptionAttached : Pos 9, 1 Bit</span><br><span class="line">   +0x17ee InitialThread    : Pos 10, 1 Bit</span><br><span class="line">   +0x17ee SessionAware     : Pos 11, 1 Bit</span><br><span class="line">   +0x17ee LoadOwner        : Pos 12, 1 Bit</span><br><span class="line">   +0x17ee LoaderWorker     : Pos 13, 1 Bit</span><br><span class="line">   +0x17ee SkipLoaderInit   : Pos 14, 1 Bit</span><br><span class="line">   +0x17ee SpareSameTebBits : Pos 15, 1 Bit</span><br><span class="line">   +0x17f0 TxnScopeEnterCallback : Ptr64 Void</span><br><span class="line">   +0x17f8 TxnScopeExitCallback : Ptr64 Void</span><br><span class="line">   +0x1800 TxnScopeContext  : Ptr64 Void</span><br><span class="line">   +0x1808 LockCount        : Uint4B</span><br><span class="line">   +0x180c WowTebOffset     : Int4B</span><br><span class="line">   +0x1810 ResourceRetValue : Ptr64 Void</span><br><span class="line">   +0x1818 ReservedForWdf   : Ptr64 Void</span><br><span class="line">   +0x1820 ReservedForCrt   : Uint8B</span><br><span class="line">   +0x1828 EffectiveContainerId : _GUID</span><br></pre></td></tr></table></figure>

<h2 id="WoW进程"><a href="#WoW进程" class="headerlink" title="WoW进程"></a>WoW进程</h2><p>x86与x64运行模式转化（用户层）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~ //当前进程所有线程</span><br><span class="line">~0s //转到0号线程上下文</span><br><span class="line">.effmach amd64 //转为x64运行模式 栈帧回溯将出现wow64、wow64cpu、wow64win等转接层DLL</span><br><span class="line">.effmach x86 //切换为32位模式</span><br></pre></td></tr></table></figure>

<p>在x86模式下查看栈帧时，能看到俩ntdll模块，一个64位一个32位，32位的加上基地址后缀如“ntdll_77700000”。WoW进程中每个进程俩PEB，每个线程俩TEB，俩栈，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!wow64exts.info</span><br></pre></td></tr></table></figure>

<p>其中Guest指x86，Native指x64。在32位NTDLL.DLL中如<code>NtReadFile</code>跳转<code>WoW64SystemServiceCall</code>，进入<code>wow64cpu!KiFastSystemCall</code>，跳转33号段选择子，即32位兼容模式过度64位模式方法。</p>
<p>系统对WoW进程注册表访问实施注册表重定向，如”HKEY_LOCAL_MACHINE\Software”重定向到“HKEY_LOACL_MACHINE\Software\Wow6432Node”等。一些COM组件有关等表键修改时同时修改32位和64位表键，这叫“注册表反射”。WoW进程访问系统文件目录时被自动重定向到SysWOW64或SysArm32目录中，这叫文件系统重定向。</p>
<p>最小进程是一类并列于NT进程的特殊进程，只需创建进程时指定一个特殊标志，但资料有限未完全研究清楚。该进程只创建进程空间，不自动想进程空间中添加内容。目前只有内存压缩技术、基于虚拟化的安全VBS和注册表进程Registry使用了最小进程。当某进程的EPROCESS结构的Flags字段的Flags3为1表示该进程为最小进程。内存压缩技术打开方式如下，有MemCompression进程创建。内存压缩进程在任务管理器中不显示。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enable-MMAgent</span><span class="literal">-mc</span></span><br></pre></td></tr></table></figure>

<p>Registry进程有3个线程，两个线程入口函数为<code>CmpLazyWriteWorker</code>用于把修改过的注册表数据成批写回硬盘工作线程。另一个线程叫<code>CmpDummyThreadRoutine</code>，启动后等待<code>CmpDummpyThreadEvent</code>事件，等待成功则用<code>KeBugCheckEx</code>触发蓝屏崩溃，其用途为占位，不让内存管理器把它内存页交换出去。Registry进程在任务管理器中有时显示。</p>
<p>Pico进程时最小进程一个子类，但运行时并列于NT进程和最小进程，与NT内核之间交互需要PICO提供器，如WSL子系统核心驱动LXCORE。</p>
<p>在WSL启动早期，LXCORE用<code>nt!PsRegisterPicoProvider</code>注册Pico提供器，它有俩参数为结构指针，第一个字段表示大小，后面是LXCORE提供给内核的回调函数。如Pico进程执行系统调用时，NT内核逆向调用<code>LXCORE!PicoSystemCallDispatch</code>转交给LXCORE继续分发处理。当Pico进程内发生错误时，NT内核<code>nt!KiDispatchException</code>逆向调用<code>LXCORE!PicoDispatchException</code>。注册成功后NT内核也返回一个类似结构供Pico提供器调用。</p>
<p>WSL中每个Linux进程都是一个Pico进程，EPROCESS显示为System Process，该结构Flags2的第10位PicoCreated标志位为，PicoContext字段指向Pico提供器使用的Pico上下文结构。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://Monoceros.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://monoceros.github.io/2024/07/18/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/">http://monoceros.github.io/2024/07/18/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Monoceros.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">逆向工程</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/20/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E6%9E%B6%E6%9E%84%E5%92%8C%E7%B3%BB%E7%BB%9F%E9%83%A8%E4%BB%B6/" title="Windows软件调试初探-架构和系统部件"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows软件调试初探-架构和系统部件</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/" title="WindowsAPI查缺补漏-动态链接库"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">WindowsAPI查缺补漏-动态链接库</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/16/Angr%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/" title="Angr做题笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="title">Angr做题笔记</div></div></a></div><div><a href="/2023/10/29/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%AC%94%E8%AE%B0/" title="Angr符号执行笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">Angr符号执行笔记</div></div></a></div><div><a href="/2023/11/09/C-%E7%97%85%E6%AF%92%E6%8A%80%E6%9C%AF/" title="C++病毒技术"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="title">C++病毒技术</div></div></a></div><div><a href="/2023/11/15/CvxPy%E6%95%B4%E6%95%B0%E8%A7%84%E5%88%92%E7%AC%94%E8%AE%B0/" title="CvxPy整数规划笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-15</div><div class="title">CvxPy整数规划笔记</div></div></a></div><div><a href="/2023/10/21/IDA%E5%9C%A8Kali-Linux%E4%B8%8B%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/" title="IDA在Kali Linux下的远程动态调试笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-21</div><div class="title">IDA在Kali Linux下的远程动态调试笔记</div></div></a></div><div><a href="/2023/10/29/IDA%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="IDA脚本编程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">IDA脚本编程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">智邮普创工作室安全组/Nepnep联合战队</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">263</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">QQ:1295625063（不找对象）</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">Windows软件调试初探-进程与线程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%B5%84%E6%BA%90"><span class="toc-number">1.1.</span> <span class="toc-text">进程资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EPROCESS%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">EPROCESS结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PEB%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">PEB结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%A8%A1%E5%BC%8F%E5%92%8C%E7%94%A8%E6%88%B7%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">内核模式和用户模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.5.</span> <span class="toc-text">线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WoW%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.6.</span> <span class="toc-text">WoW进程</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/C-%E6%BA%90%E7%A0%81%E5%85%8D%E6%9D%80%E5%85%A5%E9%97%A8/" title="C++源码免杀入门">C++源码免杀入门</a><time datetime="2024-08-21T01:44:55.000Z" title="发表于 2024-08-21 09:44:55">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/21/CobaltStrike4-8%E5%88%9D%E6%8E%A2/" title="CobaltStrike4.8初探">CobaltStrike4.8初探</a><time datetime="2024-08-21T00:38:27.000Z" title="发表于 2024-08-21 08:38:27">2024-08-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/15/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E7%94%A8%E6%88%B7%E6%80%81%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/" title="Windows软件调试初探-用户态调试过程">Windows软件调试初探-用户态调试过程</a><time datetime="2024-08-14T23:21:21.000Z" title="发表于 2024-08-15 07:21:21">2024-08-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/11/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E7%94%A8%E6%88%B7%E6%80%81%E8%B0%83%E8%AF%95%E6%A8%A1%E5%9E%8B/" title="Windows软件调试初探-用户态调试模型">Windows软件调试初探-用户态调试模型</a><time datetime="2024-08-11T12:51:29.000Z" title="发表于 2024-08-11 20:51:29">2024-08-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/06/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E6%89%98%E7%AE%A1/" title="Windows软件调试初探-托管">Windows软件调试初探-托管</a><time datetime="2024-08-06T07:17:13.000Z" title="发表于 2024-08-06 15:17:13">2024-08-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>