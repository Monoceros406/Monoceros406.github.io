<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>WindowsAPI查缺补漏-动态链接库 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="WindowsAPI查缺补漏-动态链接库静态链接库静态链接库头文件： 123#pragma onceint funAdd(int a, int b);int funMul(int a, int b);  静态链接源文件： 1234567#include &quot;StaticLinkLibrary.h&quot;int funAdd(int a, int b) &amp;#123;    return">
<meta property="og:type" content="article">
<meta property="og:title" content="WindowsAPI查缺补漏-动态链接库">
<meta property="og:url" content="http://monoceros.github.io/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="WindowsAPI查缺补漏-动态链接库静态链接库静态链接库头文件： 123#pragma onceint funAdd(int a, int b);int funMul(int a, int b);  静态链接源文件： 1234567#include &quot;StaticLinkLibrary.h&quot;int funAdd(int a, int b) &amp;#123;    return">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://monoceros.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-07-14T07:41:58.000Z">
<meta property="article:modified_time" content="2024-07-15T11:33:49.308Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="逆向工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://monoceros.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://monoceros.github.io/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WindowsAPI查缺补漏-动态链接库',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-15 19:33:49'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">249</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WindowsAPI查缺补漏-动态链接库</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-14T07:41:58.000Z" title="发表于 2024-07-14 15:41:58">2024-07-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-15T11:33:49.308Z" title="更新于 2024-07-15 19:33:49">2024-07-15</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WindowsAPI查缺补漏-动态链接库"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="WindowsAPI查缺补漏-动态链接库"><a href="#WindowsAPI查缺补漏-动态链接库" class="headerlink" title="WindowsAPI查缺补漏-动态链接库"></a>WindowsAPI查缺补漏-动态链接库</h1><h2 id="静态链接库"><a href="#静态链接库" class="headerlink" title="静态链接库"></a>静态链接库</h2><p>静态链接库头文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">funAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">funMul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br></pre></td></tr></table></figure>

<p>静态链接源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;StaticLinkLibrary.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">funAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">funMul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>调用方：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;StaticLinkLibrary.h&quot;</span>                  <span class="comment">// StaticLinkLibrary.h头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;StaticLinkLibrary.lib&quot;</span>)   <span class="comment">// StaticLinkLibrary.lib对象库</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    TCHAR szBuf[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;funAdd(5, 6) = %d\nfunMul(5, 6) = %d&quot;</span>), <span class="built_in">funAdd</span>(<span class="number">5</span>, <span class="number">6</span>), <span class="built_in">funMul</span>(<span class="number">5</span>, <span class="number">6</span>));</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="动态链接库"><a href="#动态链接库" class="headerlink" title="动态链接库"></a>动态链接库</h2><p>DLL头文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的变量、类和函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_VARABLE   extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_CLASS     __declspec(dllexport)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_VARABLE   extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_CLASS     __declspec(dllimport)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/****************************************************************/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_POSITION</span> &#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">&#125;POSITION, * PPOSITION;</span><br><span class="line"><span class="comment">// 导出变量</span></span><br><span class="line">DLL_VARABLE <span class="type">int</span> nValue;   <span class="comment">// 导出普通变量</span></span><br><span class="line">DLL_VARABLE POSITION ps;  <span class="comment">// 导出结构体变量</span></span><br><span class="line"><span class="comment">// 导出类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DLL_CLASS</span> CStudent &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CStudent</span>(LPTSTR lpName, <span class="type">int</span> nAge);</span><br><span class="line">    ~<span class="built_in">CStudent</span>();</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">LPTSTR  <span class="title">GetName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span>     <span class="title">GetAge</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    TCHAR   m_szName[<span class="number">64</span>];</span><br><span class="line">    <span class="type">int</span>     m_nAge;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API <span class="type">int</span> WINAPI <span class="title">funAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"><span class="function">DLL_API <span class="type">int</span> WINAPI <span class="title">funMul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br></pre></td></tr></table></figure>

<p>DLL源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出变量、类和函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DllSample.h&quot;</span></span></span><br><span class="line"><span class="comment">// 变量</span></span><br><span class="line"><span class="type">int</span> nValue;   <span class="comment">// 普通变量</span></span><br><span class="line">POSITION ps;  <span class="comment">// 结构体变量</span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            nValue = <span class="number">5</span>;</span><br><span class="line">            ps.x = <span class="number">6</span>;</span><br><span class="line">            ps.y = <span class="number">7</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 类</span></span><br><span class="line">CStudent::<span class="built_in">CStudent</span>(LPTSTR lpName, <span class="type">int</span> nAge) &#123;</span><br><span class="line">    <span class="keyword">if</span> (m_szName)</span><br><span class="line">        <span class="built_in">StringCchCopy</span>(m_szName, _countof(m_szName), lpName);</span><br><span class="line">    m_nAge = nAge;</span><br><span class="line">&#125;;</span><br><span class="line">CStudent::~<span class="built_in">CStudent</span>() &#123;&#125;;</span><br><span class="line"><span class="function">LPTSTR <span class="title">CStudent::GetName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_szName;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CStudent::GetAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_nAge;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 函数</span></span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">funAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">funMul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但不建议从DLL中导出变量和类，好孩子不要这么干。调用时需要.h、.lib和.dll。静态链接库.lib为对象库，包含函数实现代码，而DLL的.lib为导入库，里面只有连接到.dll的符号列表。</p>
<p>C++编译器对函数导出名有命名规则，函数名以“?”开头，后面是函数名，在“@@YA”后面表示参数列表，用代号表示如X为void、D为char、E为unsigned char、F为short、H为int、I为unsigned int、N为double等，最后以“@Z”结尾。如上述<code>funAdd</code>的导出名为<code>?funAdd@@YAHHH@Z</code>。这样命名规则导致C++编译的DLL没法被其他语言调用，解决方法是用关键字<code>extern &quot;C&quot;</code>强制使用标准C函数名称，调用约定默认为<code>__cdecl</code>，当强制改为<code>__stdcall</code>调用约定时，函数导出名前加下划线，结尾“@”后加参数传递给函数的字节数，如<code>_funAdd@8</code>。如果仍然要导出<code>funAdd</code>函数时，新建模块定义.def文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPORTS</span><br><span class="line">	funAdd</span><br><span class="line">	funMul</span><br></pre></td></tr></table></figure>

<p>然后对DLL的隐式链接：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DllSample.h&quot;</span>                  <span class="comment">// DllSample.h头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;DllSample.lib&quot;</span>)   <span class="comment">// DllSample.lib导入库文件</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    TCHAR szBuf[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szBuf2[<span class="number">512</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 测试导出变量</span></span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;nValue = %d\nps.x = %d, ps.y = %d\n&quot;</span>), nValue, ps.x, ps.y);</span><br><span class="line">    <span class="built_in">StringCchCopy</span>(szBuf2, _countof(szBuf2), szBuf);</span><br><span class="line">    <span class="comment">// 测试导出类</span></span><br><span class="line">    <span class="function">CStudent <span class="title">student</span><span class="params">((LPTSTR)TEXT(<span class="string">&quot;老王&quot;</span>), <span class="number">40</span>)</span></span>;</span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;姓名：%s， 年龄：%d\n&quot;</span>), student.<span class="built_in">GetName</span>(), student.<span class="built_in">GetAge</span>());</span><br><span class="line">    <span class="built_in">StringCchCat</span>(szBuf2, _countof(szBuf2), szBuf);</span><br><span class="line">    <span class="comment">// 测试导出函数</span></span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;funAdd(5, 6) = %d\nfunMul(5, 6) = %d&quot;</span>), <span class="built_in">funAdd</span>(<span class="number">5</span>, <span class="number">6</span>), <span class="built_in">funMul</span>(<span class="number">5</span>, <span class="number">6</span>));</span><br><span class="line">    <span class="built_in">StringCchCat</span>(szBuf2, _countof(szBuf2), szBuf);</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, szBuf2, <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>发行时应带上.dll文件，定位DLL文件的顺序为：可执行文件目录、Windows系统目录、Windows目录、进程当前目录、PATH环境变量列出的所有目录。</p>
<p>VC++编译使用&#x2F;MT或&#x2F;MTd选项时多线程静态链接C运行时库，程序体积增大但可在其他机器上正常运行；使用&#x2F;MD或&#x2F;MDd选项时多线程动态链接C运行时库，程序体积减小但可能出现缺少相关动态链接库的错误。</p>
<h3 id="入口点函数DllMain"><a href="#入口点函数DllMain" class="headerlink" title="入口点函数DllMain"></a>入口点函数<code>DllMain</code></h3><p>代码如上，处理一些调用DLL入口点函数的原因码，如果不需要空着就行。常见的有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>DLL_PROCESS_ATTACH</td>
<td>DLL第一次被映射到进程地址空间中时引发，后续如果再有线程用<code>LoadLibrary(Ex)</code>映射时不会引发，返回TRUE初始化成功，返回FALSE则整个进程直接退出。隐式链接时lpvReserved非NULL，显式链接为NULL。</td>
</tr>
<tr>
<td>DLL_PROCESS_DETACH</td>
<td>DLL被从进程内存空间撤销映射时引发，用<code>TerminateProcess</code>终止进程时不会引发，DLL加载失败、进程终止或<code>FreeLibrary</code>卸载DLL时引发，忽略返回值。用<code>FreeLibrary</code>或DLL加载失败而卸载DLL时lpvReserved为NULL，进程终止导致DLL卸载时lpvReserved为非NULL。</td>
</tr>
<tr>
<td>DLL_THREAD_ATTACH</td>
<td>进程中创建一个新线程时引发，一般用于新线程初始化。地址空间所有DLL都会被通知，所有DLL该通知都执行结束后才创建，主线程的创建不引发该通知，忽略返回值。</td>
</tr>
<tr>
<td>DLL_THREAD_DETACH</td>
<td>进程中有一个线程正在退出时引发，一般用于相关善后。所有DLL都处理完该通知时该线程才退出，用<code>TerminateProcess</code>终止进程时不会引发，DLL加载失败、进程终止或<code>FreeLibrary</code>卸载DLL时不引发。</td>
</tr>
</tbody></table>
<h3 id="延迟加载DLL"><a href="#延迟加载DLL" class="headerlink" title="延迟加载DLL"></a>延迟加载DLL</h3><p>即显式加载DLL。编译器在可执行模块中嵌入<code>__delayLoadHelper2</code>函数，延迟加载DLL函数时跳转该函数，该函数解析延迟加载导入表，并用<code>LoadLibrary(Ex)</code>和<code>GetProcAddress</code>等函数完成加载和函数地址解析。当延迟加载的DLL不存在时，或当DLL中一个函数不存在时，该函数抛出一个异常，可用结构化异常处理SEH捕捉异常来继续运行，否则进程终止。</p>
<h4 id="FUnloadDelayLoadedDLL2"><a href="#FUnloadDelayLoadedDLL2" class="headerlink" title="__FUnloadDelayLoadedDLL2"></a>__FUnloadDelayLoadedDLL2</h4><p>当希望一个延迟加载的DLL在进程结束或DLL卸载时不会被立即释放内存，下次加载时速度更快时，可对链接器开启&#x2F;DELAY:UNLOAD选项。当确实要把某个延迟加载的DLL从内存中释放时使用该函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BOOL WINAPI __FUnloadDelayLoadedDLL2(</span><br><span class="line">	LPCSTR szDll <span class="comment">//ANSI字符串 区分大小写</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="DragQueryFile"><a href="#DragQueryFile" class="headerlink" title="DragQueryFile"></a>DragQueryFile</h4><p>查询所拖放文件的名称：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UINT <span class="title">DragQueryFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HDROP hDrop,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ UINT iFile, <span class="comment">//要查询的文件索引</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_ LPTSTR lpszFile, <span class="comment">//返回指定索引的文件名的缓冲区</span></span></span></span><br><span class="line"><span class="params"><span class="function">	UINT cch <span class="comment">//lpszFile缓冲区大小 单位字符</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回复制到lpszFile缓冲区字符数 不含终止空字符</span></span><br></pre></td></tr></table></figure>

<p>对于iFile，文件索引从0开始，设置为0xFFFFFFFF时函数返回所拖放文件总数。该值介于0和所拖放文件总数之间时将指定索引文件名复制到lpszFile缓冲区。 当lpszFile为NULL则函数返回所需缓冲区大小，单位字符，不含终止空字符。</p>
<p>要创建一个支持拖放的窗口时，<code>CreateWindowEx</code>的dwExStyle指定WS_EX_ACCEPTFILES，程序接收WM_DROPFILES消息，wParam为所拖放文件信息的HDROP类型结构句柄，lParam缺省，处理完该消息应返回0。</p>
<p>例如获取所有拖动文件的文件名：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HDROP hDrop;</span><br><span class="line">UINT uDragCount;</span><br><span class="line">TCHAR szFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">case</span> WM_DROPFILES: &#123;</span><br><span class="line">	hDrop = (HDROP)wParam;</span><br><span class="line">	uDragCount = <span class="built_in">DragQueryFile</span>(hDrop, <span class="number">0xFFFFFFFF</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; uDragCount; i++) &#123;</span><br><span class="line">		<span class="built_in">DragQueryFile</span>(hDrop, i, szFileName, _countof(szFileName));</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="DragQueryPoint"><a href="#DragQueryPoint" class="headerlink" title="DragQueryPoint"></a>DragQueryPoint</h4><p>查询拖动操作期间鼠标指针位置：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DragQueryPoint</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HDROP hDrop,</span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_ PPOINT lppt</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="DragFinish"><a href="#DragFinish" class="headerlink" title="DragFinish"></a>DragFinish</h4><p>释放系统为拖动操作分配的内存：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DragFinish</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	HDROP hDrop</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>GetMd5.dll源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GetMd5.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetMd5</span><span class="params">(LPCTSTR lpFileName, LPTSTR lpMd5)</span> </span>&#123;</span><br><span class="line">    HANDLE hFile, hFileMap;</span><br><span class="line">    HCRYPTPROV hProv, hHash;</span><br><span class="line">    TCHAR szContainer[] = <span class="built_in">TEXT</span>(<span class="string">&quot;MyKeyContainer&quot;</span>);</span><br><span class="line">    LPVOID lpMemory;</span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    hFile = <span class="built_in">CreateFile</span>(lpFileName, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 获取指定加密服务提供程序(CSP)中指定密钥容器的句柄</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CryptAcquireContext</span>(&amp;hProv, szContainer, <span class="literal">NULL</span>, PROV_RSA_FULL, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">CryptAcquireContext</span>(&amp;hProv, szContainer, <span class="literal">NULL</span>, PROV_RSA_FULL, CRYPT_NEWKEYSET))</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 创建加密服务提供程序(CSP)哈希对象的句柄，第2个参数指定为不同的值可以获取不同的哈希例如SHA</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CryptCreateHash</span>(hProv, CALG_MD5, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;hHash))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 为了能够处理大型文件，所以使用内存映射文件。为hFile文件对象创建一个文件映射内核对象</span></span><br><span class="line">    hFileMap = <span class="built_in">CreateFileMapping</span>(hFile, <span class="literal">NULL</span>, PAGE_READONLY, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hFileMap)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 获取文件大小，内存分配粒度</span></span><br><span class="line">    __int64 qwFileSize;</span><br><span class="line">    DWORD dwFileSizeHigh;</span><br><span class="line">    SYSTEM_INFO si;</span><br><span class="line">    qwFileSize = <span class="built_in">GetFileSize</span>(hFile, &amp;dwFileSizeHigh);</span><br><span class="line">    qwFileSize += (((__int64)dwFileSizeHigh) &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    <span class="built_in">GetSystemInfo</span>(&amp;si);</span><br><span class="line">    <span class="comment">// 把文件映射对象hFileMap不断映射到进程的虚拟地址空间中</span></span><br><span class="line">    __int64 qwFileOffset = <span class="number">0</span>;   <span class="comment">// 文件映射对象偏移量</span></span><br><span class="line">    DWORD dwBytesInBlock;       <span class="comment">// 本次映射大小</span></span><br><span class="line">    <span class="keyword">while</span> (qwFileSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        dwBytesInBlock = si.dwAllocationGranularity;</span><br><span class="line">        <span class="keyword">if</span> (qwFileSize &lt; dwBytesInBlock)</span><br><span class="line">            dwBytesInBlock = (DWORD)qwFileSize;</span><br><span class="line">        lpMemory = <span class="built_in">MapViewOfFile</span>(hFileMap, FILE_MAP_READ, (DWORD)(qwFileOffset &gt;&gt; <span class="number">32</span>), (DWORD)(qwFileOffset &amp; <span class="number">0xFFFFFFFF</span>), dwBytesInBlock);</span><br><span class="line">        <span class="keyword">if</span> (!lpMemory)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        <span class="comment">// 对已映射部分进行操作，将数据添加到哈希对象</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">CryptHashData</span>(hHash, (LPBYTE)lpMemory, dwBytesInBlock, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        <span class="comment">// 取消本次映射，进行下一轮映射</span></span><br><span class="line">        <span class="built_in">UnmapViewOfFile</span>(lpMemory);</span><br><span class="line">        qwFileOffset += dwBytesInBlock;</span><br><span class="line">        qwFileSize -= dwBytesInBlock;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 获取哈希值中的字节数</span></span><br><span class="line">    DWORD dwHashLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CryptGetHashParam</span>(hHash, HP_HASHVAL, <span class="literal">NULL</span>, &amp;dwHashLen, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 获取哈希值</span></span><br><span class="line">    LPBYTE lpHash = <span class="keyword">new</span> BYTE[dwHashLen];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CryptGetHashParam</span>(hHash, HP_HASHVAL, lpHash, &amp;dwHashLen, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwHashLen; i++)</span><br><span class="line">        <span class="built_in">wsprintf</span>(lpMd5 + i * <span class="number">2</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;%02X&quot;</span>), lpHash[i]);</span><br><span class="line">    <span class="keyword">delete</span>[]lpHash;</span><br><span class="line">    <span class="comment">// 关闭文件映射内核对象句柄</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFileMap);</span><br><span class="line">    <span class="comment">// 关闭文件句柄</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">    <span class="comment">// 释放哈希句柄</span></span><br><span class="line">    <span class="built_in">CryptDestroyHash</span>(hHash);</span><br><span class="line">    <span class="comment">// 释放CSP句柄</span></span><br><span class="line">    <span class="built_in">CryptReleaseContext</span>(hProv, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  CryptAcquireContext函数用于获取指定加密服务提供程序(CSP)中指定密钥容器的句柄，返回的句柄用于调用所选CSP的CryptoAPI函数；</span></span><br><span class="line"><span class="comment">  CryptCreateHash函数启动数据流的哈希处理， 该函数创建加密服务提供程序(CSP)哈希对象的句柄，该句柄可以用于后续的CryptHashData函数调用；</span></span><br><span class="line"><span class="comment">  CryptHashData函数用于将数据添加到指定的哈希对象，可以多次调用该函数来计算长数据流或不连续数据流的哈希；</span></span><br><span class="line"><span class="comment">  CryptGetHashParam函数用于获取具体的哈希值。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>GetMd5.dll头文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API BOOL <span class="title">GetMd5</span><span class="params">(LPCTSTR lpFileName, LPTSTR lpMd5)</span></span>;</span><br></pre></td></tr></table></figure>

<p>调用者：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Shlwapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;delayimp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GetMd5.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Shlwapi.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;GetMd5.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hInstance;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    g_hInstance = hInstance;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HRSRC hResBlock;</span><br><span class="line">    HANDLE hRes;</span><br><span class="line">    LPVOID lpDll;</span><br><span class="line">    DWORD dwDllSize;</span><br><span class="line">    HANDLE hFile;</span><br><span class="line">    TCHAR szFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szMd5[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    HDROP hDrop;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            <span class="comment">// 关于ChangeWindowMessageFilterEx函数，请参见用户界面特权隔离一节</span></span><br><span class="line">            <span class="built_in">ChangeWindowMessageFilterEx</span>(hwndDlg, WM_DROPFILES, MSGFLT_ALLOW, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">ChangeWindowMessageFilterEx</span>(hwndDlg, <span class="number">0x49</span>, MSGFLT_ALLOW, <span class="literal">NULL</span>);<span class="comment">// 0x49 == WM_COPYGLOBALDATA</span></span><br><span class="line">            <span class="comment">//ChangeWindowMessageFilter(WM_DROPFILES, MSGFLT_ADD);</span></span><br><span class="line">            <span class="comment">//ChangeWindowMessageFilter(0x49, MSGFLT_ADD);          </span></span><br><span class="line">             <span class="comment">// 如果当前目录下不存在GetMd5.dll</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">PathFileExists</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GetMd5.dll&quot;</span>))) &#123;</span><br><span class="line">                hResBlock = <span class="built_in">FindResource</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDR_MYDLL), <span class="built_in">TEXT</span>(<span class="string">&quot;MyDll&quot;</span>));</span><br><span class="line">                <span class="keyword">if</span> (!hResBlock)</span><br><span class="line">                    <span class="keyword">return</span> FALSE;</span><br><span class="line">                hRes = <span class="built_in">LoadResource</span>(g_hInstance, hResBlock);</span><br><span class="line">                <span class="keyword">if</span> (!hRes)</span><br><span class="line">                    <span class="keyword">return</span> FALSE;</span><br><span class="line">                lpDll = <span class="built_in">LockResource</span>(hRes);</span><br><span class="line">                dwDllSize = <span class="built_in">SizeofResource</span>(g_hInstance, hResBlock);</span><br><span class="line">                hFile = <span class="built_in">CreateFile</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GetMd5.dll&quot;</span>), GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">                    <span class="keyword">return</span> FALSE;</span><br><span class="line">                <span class="built_in">WriteFile</span>(hFile, lpDll, dwDllSize, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_GETMD5: &#123;</span><br><span class="line">                    <span class="comment">// 获取指定文件的MD5</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_FILENAME, szFileName, _countof(szFileName)))</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">GetMd5</span>(szFileName, szMd5)) &#123;</span><br><span class="line">                            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_MD5, szMd5);</span><br><span class="line">                            <span class="comment">// 卸载延迟加载的dll</span></span><br><span class="line">                            __FUnloadDelayLoadedDLL2(<span class="string">&quot;GetMd5.dll&quot;</span>);</span><br><span class="line">                        &#125;;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_DROPFILES: &#123;</span><br><span class="line">            hDrop = (HDROP)wParam;</span><br><span class="line">            <span class="built_in">DragQueryFile</span>(hDrop, <span class="number">0</span>, szFileName, _countof(szFileName));</span><br><span class="line">            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_FILENAME, szFileName);</span><br><span class="line">            <span class="built_in">DragFinish</span>(hDrop);</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="线程局部存储"><a href="#线程局部存储" class="headerlink" title="线程局部存储"></a>线程局部存储</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>线程局部存储TLS结构包含索引数组（或进程位数组）和存储槽。索引数组为4字，一共64位，每一位对应存储槽数组中的一个元素。存储槽为一个64个LPVOID类型元素的数组，每个LPVOID元素为一个指向具体内容的指针。每一个线程都有一个存储槽，但线程之间共用同一个索引数组。索引数组的每一位为1则代表所有线程的存储槽该数组索引位置均有地址指向数据，为0则没有。索引数组位数最少为TLS_MINIMUM_AVAILABLE即64个，需要时系统分配更多，最高记录1088个。用<code>NtCurrentTeb</code>获取当前线程的线程环境块TEB结构指针。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TEB</span> &#123;</span><br><span class="line">	PVOID Reserved1[<span class="number">12</span>];</span><br><span class="line">	PPEB  ProcessEnvironmentBlock; <span class="comment">//进程环境块PEB结构指针</span></span><br><span class="line">	PVOID Reserved2[<span class="number">399</span>];</span><br><span class="line">	BYTE  Reserved3[<span class="number">1952</span>];</span><br><span class="line">	PVOID TlsSlots[<span class="number">64</span>]; <span class="comment">//线程存储槽</span></span><br><span class="line">	BYTE  Reserved4[<span class="number">8</span>];</span><br><span class="line">	PVOID Reserved5[<span class="number">26</span>];</span><br><span class="line">	PVOID ReservedForOle;</span><br><span class="line">	PVOID Reserved6[<span class="number">4</span>];</span><br><span class="line">	PVOID TlsExpansionSlots;</span><br><span class="line">&#125; TEB, * PTEB;</span><br></pre></td></tr></table></figure>

<h3 id="TlsAlloc"><a href="#TlsAlloc" class="headerlink" title="TlsAlloc"></a>TlsAlloc</h3><p>从进程中分配一个TLS索引，把索引数组某位设为1，且每个线程存储槽中该索引位置初始化为NULL，进程中每个线程可使用该索引操作自己的数据。分配到的TLS索引为了每个线程都要访问，一般要设为全局变量。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">TlsAlloc</span><span class="params">(VOID)</span></span>; <span class="comment">//成功返回TLS索引 失败TLS_OUT_OF_INDEXES</span></span><br></pre></td></tr></table></figure>

<h3 id="TlsSetValue"><a href="#TlsSetValue" class="headerlink" title="TlsSetValue"></a>TlsSetValue</h3><p>在存储槽指定索引处写入数据：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">TlsSetValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwTlsIndex, <span class="comment">//TLS索引</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ LPVOID lpTlsValue <span class="comment">//要存储在调用线程TLS插槽中指定索引处的值</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="TlsGetValue"><a href="#TlsGetValue" class="headerlink" title="TlsGetValue"></a>TlsGetValue</h3><p>获取存储槽中指定索引处的数据：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID WINAPI <span class="title">TlsGetValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwTlsIndex <span class="comment">//TLS索引</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回调用线程存储槽中指定索引处值 失败返回0且GetLastError为ERROR_SUCCESS</span></span><br></pre></td></tr></table></figure>

<h3 id="TlsFree"><a href="#TlsFree" class="headerlink" title="TlsFree"></a>TlsFree</h3><p>释放TLS索引，把索引数组中对应位置0，并把每个线程存储槽中该索引位置数据化NULL。注意它不释放内容指针指向内存，自己搞的自己手动释放。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">TlsFree</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwTlsIndex <span class="comment">//TLS索引</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THREADCOUNT 5</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">DWORD g_dwTlsIndex;</span><br><span class="line">HWND g_hwndDlg;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 线程函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HANDLE hThread[THREADCOUNT] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_OK: &#123;</span><br><span class="line">                    <span class="comment">// 从进程中分配一个TLS索引</span></span><br><span class="line">                    g_dwTlsIndex = <span class="built_in">TlsAlloc</span>();</span><br><span class="line">                    <span class="keyword">if</span> (g_dwTlsIndex == TLS_OUT_OF_INDEXES) &#123;</span><br><span class="line">                        <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;TlsAlloc函数调用失败！&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                        <span class="keyword">return</span> FALSE;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="comment">// 创建THREADCOUNT个线程</span></span><br><span class="line">                    <span class="built_in">SetDlgItemText</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS, <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; THREADCOUNT; i++)</span><br><span class="line">                        <span class="keyword">if</span> ((hThread[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, (LPVOID)i, <span class="number">0</span>, <span class="literal">NULL</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">                            <span class="built_in">CloseHandle</span>(hThread[i]);</span><br><span class="line">                    <span class="comment">// 等待所有线程结束，释放TLS索引</span></span><br><span class="line">                    <span class="built_in">WaitForMultipleObjects</span>(THREADCOUNT, hThread, TRUE, INFINITE);</span><br><span class="line">                    <span class="built_in">TlsFree</span>(g_dwTlsIndex);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span> </span>&#123;</span><br><span class="line">    LPVOID lpData = <span class="literal">NULL</span>;</span><br><span class="line">    TCHAR szBuf[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    lpData = <span class="keyword">new</span> BYTE[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(lpData, <span class="number">256</span>);</span><br><span class="line">    <span class="comment">// 在自己的存储槽中指定索引处写入数据</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">TlsSetValue</span>(g_dwTlsIndex, lpData)) &#123;</span><br><span class="line">        <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;线程%d调用TlsSetValue失败&quot;</span>), (INT)lpParameter);</span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">        <span class="keyword">delete</span>[]lpData;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 获取自己的存储槽中指定索引处的数据</span></span><br><span class="line">    lpData = <span class="built_in">TlsGetValue</span>(g_dwTlsIndex);</span><br><span class="line">    <span class="keyword">if</span> (!lpData &amp;&amp; <span class="built_in">GetLastError</span>() != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;线程%d调用TlsGetValue失败&quot;</span>), (INT)lpParameter);</span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 每个线程存储槽中指定索引处的数据显示到编辑控件中</span></span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;线程%d的索引%d处的值：0x%p\r\n&quot;</span>), (INT)lpParameter, g_dwTlsIndex, lpData);</span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS), EM_SETSEL, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS), EM_REPLACESEL, TRUE, (LPARAM)szBuf);</span><br><span class="line">    <span class="keyword">delete</span>[]lpData;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="静态TLS"><a href="#静态TLS" class="headerlink" title="静态TLS"></a>静态TLS</h3><p>使用这种方式声明为全局变量或静态变量：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__declspec(thread) LPVOID gt_lpData;</span><br></pre></td></tr></table></figure>

<p>该前缀在编译链接时把变量放到.tls区段，如果是Release版本可能会被优化到别的区段。一般用gt_前缀表示全局TLS变量，用st_表示静态TLS变量。当然每个线程的该变量都是独立的，上面那个例子可以改写成：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THREADCOUNT 5</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">__declspec(thread) LPVOID gt_lpData = <span class="literal">NULL</span>;</span><br><span class="line">HWND g_hwndDlg;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 线程函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HANDLE hThread[THREADCOUNT];</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_OK: &#123;</span><br><span class="line">                    <span class="comment">// 创建THREADCOUNT个线程</span></span><br><span class="line">                    <span class="built_in">SetDlgItemText</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS, <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; THREADCOUNT; i++)</span><br><span class="line">                        <span class="keyword">if</span> ((hThread[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, (LPVOID)i, <span class="number">0</span>, <span class="literal">NULL</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">                            <span class="built_in">CloseHandle</span>(hThread[i]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span> </span>&#123;</span><br><span class="line">    TCHAR szBuf[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    gt_lpData = <span class="keyword">new</span> BYTE[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(gt_lpData, <span class="number">256</span>);</span><br><span class="line">    <span class="comment">// 每个线程的静态TLS数据显示到编辑控件中</span></span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;线程%d的gt_lpData值：0x%p\r\n&quot;</span>), (INT)lpParameter, gt_lpData);</span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS), EM_SETSEL, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS), EM_REPLACESEL, TRUE, (LPARAM)szBuf);</span><br><span class="line">    <span class="keyword">delete</span>[]gt_lpData;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Windows钩子"><a href="#Windows钩子" class="headerlink" title="Windows钩子"></a>Windows钩子</h2><h3 id="SetWindowsHookEx"><a href="#SetWindowsHookEx" class="headerlink" title="SetWindowsHookEx"></a>SetWindowsHookEx</h3><p>将应用程序定义的钩子函数安装到钩子链中，钩子函数用于监视系统某些类型事件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HHOOK WINAPI <span class="title">SetWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ INT idHook, <span class="comment">//要安装的钩子函数类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HOOKPROC lpfn, <span class="comment">//指向钩子函数指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HINSTANCE hMod, <span class="comment">//包含钩子函数的DLL模块句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ DWORD dwThreadId <span class="comment">//与钩子函数关联的线程ID 即被监视进程</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回钩子函数句柄 失败NULL</span></span><br></pre></td></tr></table></figure>

<p>idHook钩子函数类型常用的有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>WH_GETMESSAGE</td>
<td>用<code>GetMessage</code>或<code>PeekMessage</code>获取消息时调用钩子函数。</td>
</tr>
<tr>
<td>WH_KEYBOARD</td>
<td>用<code>GetMessage</code>或<code>PeekMessage</code>获取键盘消息WM_KEYUP或WM_KEYDOWN时调用钩子函数。</td>
</tr>
<tr>
<td>WH_MOUSE</td>
<td>用<code>GetMessage</code>或<code>PeekMessage</code>获取鼠标消息时调用钩子函数。</td>
</tr>
<tr>
<td>WH_CALLWNDPROC</td>
<td>系统消息发送到目标从窗口过程前调用钩子函数。</td>
</tr>
<tr>
<td>WH_CALLWNDPROCRET</td>
<td>目标窗口过程处理完消息后调用钩子函数。</td>
</tr>
<tr>
<td>WH_DEBUG</td>
<td>&#x2F;调用其他钩子函数前调用本钩子函数。</td>
</tr>
<tr>
<td>WH_CBT</td>
<td>激活&#x2F;创建&#x2F;销毁&#x2F;最小化&#x2F;最大化&#x2F;移动&#x2F;调整窗口前、完成系统命令前、从系统消息队列中删除鼠标&#x2F;键盘事件前、设置键盘焦点前、与系统消息队列同步前调用钩子函数。</td>
</tr>
<tr>
<td>WH_FOREGROUNDIDLE</td>
<td>前台线程即将变为空闲时调用钩子函数。</td>
</tr>
<tr>
<td>WH_JOURNALRECORD</td>
<td>记录发送给系统消息队列所有信息，钩子函数不需要在DLL中。</td>
</tr>
<tr>
<td>WH_JOURNALPLAYBACK</td>
<td>回放日志记录钩子记录的系统事件，钩子函数不需要在DLL中。</td>
</tr>
<tr>
<td>WH_MSGFILTER</td>
<td>用户对对话框&#x2F;消息框&#x2F;菜单&#x2F;滚动条操作后，系统发送对应消息前调用钩子函数，局部钩子。</td>
</tr>
<tr>
<td>WH_SYSMSGFILTER</td>
<td>同WH_MSGFILTER，系统钩子。</td>
</tr>
<tr>
<td>WH_SHELL</td>
<td>Windows Shell接收通知事件前调用钩子函数，如Shell被激活&#x2F;重绘。</td>
</tr>
</tbody></table>
<p>当监视当前进程时，lpfn指向的钩子函数位于当前进程程序代码中，hMod为NULL，dwThreadId设置为当前进程的线程ID。当监视其他进程时，lpfn指向的钩子函数必须位于DLL中，hMod为包含钩子函数的DLL模块句柄，dwThreadId设置为其他进程创建的线程ID。当设置全局系统钩子时，lpfn指向的钩子函数必须位于DLL中，hMod为包含钩子函数的DLL模块句柄，dwThreadId为0。</p>
<p>钩子回调函数定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">HookProc</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	INT nCode,</span></span></span><br><span class="line"><span class="params"><span class="function">	WPARAM wParam,</span></span></span><br><span class="line"><span class="params"><span class="function">	LPARAM lParam</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="CallNextHookEx"><a href="#CallNextHookEx" class="headerlink" title="CallNextHookEx"></a>CallNextHookEx</h3><p>把消息事件传递给钩子链中下一个钩子函数。系统中可安装多个不同类型或相同类型的钩子，每种钩子有维护一个钩子链，是同种类型钩子的钩子函数指针列表，最近加入的钩子放在链表头部，每个钩子函数有义务把消息事件传递下去。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT WINAPI <span class="title">CallNextHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ HHOOK hhk, <span class="comment">//忽略</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ INT nCode,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ WPARAM wParam,</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ LPARAM lParam</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>nCode、wParam、lParam用钩子函数同名参数即可。</p>
<h3 id="UnhookWindowsHookEx"><a href="#UnhookWindowsHookEx" class="headerlink" title="UnhookWindowsHookEx"></a>UnhookWindowsHookEx</h3><p>卸载安装在钩子链中的钩子函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">UnhookWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ HHOOK hhk <span class="comment">//钩子句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="ToUnicode"><a href="#ToUnicode" class="headerlink" title="ToUnicode"></a>ToUnicode</h3><p>把虚拟键码转为Unicode字符：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INT WINAPI <span class="title">ToUnicode</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ UINT wVirtKey, <span class="comment">//要转换的虚拟键码</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ UINT wScanCode, <span class="comment">//按键扫描码</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_opt_ CONST PBYTE lpKeyState, <span class="comment">//指向包含当前键盘状态的256字节数组指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_Out_ LPWSTR pwszBuff, <span class="comment">//接收转换后的Unicode字符缓冲区</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ INT cchBuff, <span class="comment">//pwszBuff缓冲区大小 单位字符</span></span></span></span><br><span class="line"><span class="params"><span class="function">	_In_ UINT wFlags <span class="comment">//为0或1则菜单处于活动状态</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>就钩子函数应用场景来说，wVirtKey用wParam，wScanCode用lParam高16位即可，lpKeyState不讲了看下面例子用法。</p>
<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h3><p>定义一个WH_KEYBOARD键盘钩子的钩子函数。对于回调函数的nCode，当小于0时钩子函数必须将消息传递给<code>CallNextHookEx</code>并返回其返回值，当为HC_ACTION时表示wParam和lParam中含有有关击键消息，处理完用<code>CallNextHookEx</code>传递下去，也可以直接返回TRUE丢弃信息并组织信息向下传播。wParam包含虚拟键码，lParam包含消息重复计数、扫描码、扩展键标志、状态描述吗、先前键状态标志、转换状态标志等。</p>
<p>DLL头文件为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API BOOL <span class="title">InstallHook</span><span class="params">(<span class="type">int</span> idHook, DWORD dwThreadId, HWND hwnd)</span></span>;</span><br><span class="line"><span class="function">DLL_API BOOL <span class="title">UninstallHook</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 内部函数</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">KeyboardProc</span><span class="params">(<span class="type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span></span>;</span><br></pre></td></tr></table></figure>

<p>DLL源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;HookDll.h&quot;</span></span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hMod;</span><br><span class="line">HHOOK g_hHookKeyboard;</span><br><span class="line">TCHAR g_szBuf[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg(<span class="string">&quot;Shared&quot;</span>)</span></span><br><span class="line">    HWND  g_hwnd = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg()</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/SECTION:Shared,RWS&quot;</span>)</span></span><br><span class="line">    <span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">            <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">                g_hMod = hModule;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">            <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">            <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line">    <span class="function">BOOL <span class="title">InstallHook</span><span class="params">(<span class="type">int</span> idHook, DWORD dwThreadId, HWND hwnd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!g_hHookKeyboard) &#123;</span><br><span class="line">            g_hwnd = hwnd;</span><br><span class="line">            g_hHookKeyboard = <span class="built_in">SetWindowsHookEx</span>(idHook, KeyboardProc, g_hMod, dwThreadId);</span><br><span class="line">            <span class="keyword">if</span> (!g_hHookKeyboard)</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">BOOL <span class="title">UninstallHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (g_hHookKeyboard)</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">UnhookWindowsHookEx</span>(g_hHookKeyboard))</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">        g_hHookKeyboard = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">// 内部函数</span></span><br><span class="line">    <span class="function">LRESULT CALLBACK <span class="title">KeyboardProc</span><span class="params">(<span class="type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">        BYTE bKeyState[<span class="number">256</span>];</span><br><span class="line">        COPYDATASTRUCT copyDataStruct = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> (nCode &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">CallNextHookEx</span>(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line">        <span class="keyword">if</span> (nCode == HC_ACTION) &#123;</span><br><span class="line">            <span class="built_in">GetKeyboardState</span>(bKeyState);</span><br><span class="line">            bKeyState[VK_SHIFT] = <span class="built_in">HIBYTE</span>(<span class="built_in">GetKeyState</span>(VK_SHIFT));</span><br><span class="line">            <span class="built_in">ZeroMemory</span>(g_szBuf, <span class="built_in">sizeof</span>(g_szBuf));</span><br><span class="line">            <span class="built_in">ToUnicode</span>(wParam, lParam &gt;&gt; <span class="number">16</span>, bKeyState, g_szBuf, _countof(g_szBuf), <span class="number">0</span>);</span><br><span class="line">            copyDataStruct.cbData = <span class="built_in">sizeof</span>(g_szBuf);</span><br><span class="line">            copyDataStruct.lpData = g_szBuf;</span><br><span class="line">            <span class="built_in">SendMessage</span>(g_hwnd, WM_COPYDATA, (WPARAM)g_hwnd, (LPARAM)&amp;copyDataStruct);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CallNextHookEx</span>(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>监视程序：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;HookDll.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;HookDll.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_INSTALLHOOK: &#123;</span><br><span class="line">                    <span class="built_in">InstallHook</span>(WH_KEYBOARD, <span class="number">0</span>, hwndDlg);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_UNINSTALLHOOK: &#123;</span><br><span class="line">                    <span class="built_in">UninstallHook</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">UninstallHook</span>();</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COPYDATA: &#123;</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_KEYBOARD), EM_SETSEL, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_KEYBOARD), EM_REPLACESEL, TRUE, (LPARAM)(LPTSTR)(((PCOPYDATASTRUCT)lParam)-&gt;lpData));</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>获取其他窗口信息时最好用<code>PostMessage</code>而不是<code>SendMessage</code>，要不处理事件可能过长。</p>
<h2 id="变量共享"><a href="#变量共享" class="headerlink" title="变量共享"></a>变量共享</h2><p>创建一个叫“Shared”的区段，里面放个变量。注意只能将已初始化的变量保存到自定义段中，没初始化就跑别的段去了。结尾表示自定义段结束，回到默认段。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg(<span class="string">&quot;Shared&quot;</span>)</span></span><br><span class="line">	HWND g_hwnd = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg()</span></span><br></pre></td></tr></table></figure>

<p>为“Shared”段指定相关属性，R为READ，W为WRITE，E为EXECUTE，S为SHARED。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;/SECTION:Shared,RWS&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<h2 id="DLL注入"><a href="#DLL注入" class="headerlink" title="DLL注入"></a>DLL注入</h2></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://Monoceros.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://monoceros.github.io/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/">http://monoceros.github.io/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Monoceros.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">逆向工程</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/18/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/" title="Windows软件调试初探-进程与线程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows软件调试初探-进程与线程</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/13/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%89%AA%E8%B4%B4%E6%9D%BF/" title="WindowsAPI查缺补漏-剪贴板"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">WindowsAPI查缺补漏-剪贴板</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/16/Angr%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/" title="Angr做题笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="title">Angr做题笔记</div></div></a></div><div><a href="/2023/10/29/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%AC%94%E8%AE%B0/" title="Angr符号执行笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">Angr符号执行笔记</div></div></a></div><div><a href="/2023/11/09/C-%E7%97%85%E6%AF%92%E6%8A%80%E6%9C%AF/" title="C++病毒技术"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="title">C++病毒技术</div></div></a></div><div><a href="/2023/11/15/CvxPy%E6%95%B4%E6%95%B0%E8%A7%84%E5%88%92%E7%AC%94%E8%AE%B0/" title="CvxPy整数规划笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-15</div><div class="title">CvxPy整数规划笔记</div></div></a></div><div><a href="/2023/10/21/IDA%E5%9C%A8Kali-Linux%E4%B8%8B%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/" title="IDA在Kali Linux下的远程动态调试笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-21</div><div class="title">IDA在Kali Linux下的远程动态调试笔记</div></div></a></div><div><a href="/2023/10/29/IDA%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="IDA脚本编程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">IDA脚本编程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">智邮普创工作室安全组/Nepnep联合战队</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">249</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">暂无公告</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">WindowsAPI查缺补漏-动态链接库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="toc-number">1.1.</span> <span class="toc-text">静态链接库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="toc-number">1.2.</span> <span class="toc-text">动态链接库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9%E5%87%BD%E6%95%B0DllMain"><span class="toc-number">1.2.1.</span> <span class="toc-text">入口点函数DllMain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BDDLL"><span class="toc-number">1.2.2.</span> <span class="toc-text">延迟加载DLL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FUnloadDelayLoadedDLL2"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">__FUnloadDelayLoadedDLL2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DragQueryFile"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">DragQueryFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DragQueryPoint"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">DragQueryPoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DragFinish"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">DragFinish</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%B1%80%E9%83%A8%E5%AD%98%E5%82%A8"><span class="toc-number">1.3.</span> <span class="toc-text">线程局部存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TlsAlloc"><span class="toc-number">1.3.2.</span> <span class="toc-text">TlsAlloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TlsSetValue"><span class="toc-number">1.3.3.</span> <span class="toc-text">TlsSetValue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TlsGetValue"><span class="toc-number">1.3.4.</span> <span class="toc-text">TlsGetValue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TlsFree"><span class="toc-number">1.3.5.</span> <span class="toc-text">TlsFree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.3.6.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81TLS"><span class="toc-number">1.3.7.</span> <span class="toc-text">静态TLS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E9%92%A9%E5%AD%90"><span class="toc-number">1.4.</span> <span class="toc-text">Windows钩子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SetWindowsHookEx"><span class="toc-number">1.4.1.</span> <span class="toc-text">SetWindowsHookEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CallNextHookEx"><span class="toc-number">1.4.2.</span> <span class="toc-text">CallNextHookEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UnhookWindowsHookEx"><span class="toc-number">1.4.3.</span> <span class="toc-text">UnhookWindowsHookEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ToUnicode"><span class="toc-number">1.4.4.</span> <span class="toc-text">ToUnicode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-2"><span class="toc-number">1.4.5.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%85%B1%E4%BA%AB"><span class="toc-number">1.5.</span> <span class="toc-text">变量共享</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DLL%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.</span> <span class="toc-text">DLL注入</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/18/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/" title="Windows软件调试初探-进程与线程">Windows软件调试初探-进程与线程</a><time datetime="2024-07-18T02:03:59.000Z" title="发表于 2024-07-18 10:03:59">2024-07-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/" title="WindowsAPI查缺补漏-动态链接库">WindowsAPI查缺补漏-动态链接库</a><time datetime="2024-07-14T07:41:58.000Z" title="发表于 2024-07-14 15:41:58">2024-07-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/13/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%89%AA%E8%B4%B4%E6%9D%BF/" title="WindowsAPI查缺补漏-剪贴板">WindowsAPI查缺补漏-剪贴板</a><time datetime="2024-07-13T08:21:18.000Z" title="发表于 2024-07-13 16:21:18">2024-07-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/08/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E8%BF%9B%E7%A8%8B/" title="WindowsAPI查缺补漏-进程">WindowsAPI查缺补漏-进程</a><time datetime="2024-07-08T10:28:14.000Z" title="发表于 2024-07-08 18:28:14">2024-07-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/12/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%96%87%E4%BB%B6%E9%A9%B1%E5%8A%A8%E5%99%A8%E7%9B%AE%E5%BD%95/" title="WindowsAPI查缺补漏-文件驱动器目录">WindowsAPI查缺补漏-文件驱动器目录</a><time datetime="2024-06-12T13:04:28.000Z" title="发表于 2024-06-12 21:04:28">2024-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>