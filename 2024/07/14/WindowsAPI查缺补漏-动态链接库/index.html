<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>WindowsAPI查缺补漏-动态链接库 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="WindowsAPI查缺补漏-动态链接库静态链接库静态链接库头文件： 123#pragma onceint funAdd(int a, int b);int funMul(int a, int b);  静态链接源文件： 1234567#include &quot;StaticLinkLibrary.h&quot;int funAdd(int a, int b) &amp;#123;    return">
<meta property="og:type" content="article">
<meta property="og:title" content="WindowsAPI查缺补漏-动态链接库">
<meta property="og:url" content="https://monoceros406.github.io/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="WindowsAPI查缺补漏-动态链接库静态链接库静态链接库头文件： 123#pragma onceint funAdd(int a, int b);int funMul(int a, int b);  静态链接源文件： 1234567#include &quot;StaticLinkLibrary.h&quot;int funAdd(int a, int b) &amp;#123;    return">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://monoceros406.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-07-14T07:41:58.000Z">
<meta property="article:modified_time" content="2025-05-11T02:12:54.535Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="WinAPI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://monoceros406.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://monoceros406.github.io/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WindowsAPI查缺补漏-动态链接库',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-11 10:12:54'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="The Blog of Monoceros406" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">319</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WindowsAPI查缺补漏-动态链接库</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-14T07:41:58.000Z" title="发表于 2024-07-14 15:41:58">2024-07-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-11T02:12:54.535Z" title="更新于 2025-05-11 10:12:54">2025-05-11</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WindowsAPI查缺补漏-动态链接库"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="WindowsAPI查缺补漏-动态链接库"><a href="#WindowsAPI查缺补漏-动态链接库" class="headerlink" title="WindowsAPI查缺补漏-动态链接库"></a>WindowsAPI查缺补漏-动态链接库</h1><h2 id="静态链接库"><a href="#静态链接库" class="headerlink" title="静态链接库"></a>静态链接库</h2><p>静态链接库头文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">funAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">funMul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br></pre></td></tr></table></figure>

<p>静态链接源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;StaticLinkLibrary.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">funAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">funMul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>调用方：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;StaticLinkLibrary.h&quot;</span>                  <span class="comment">// StaticLinkLibrary.h头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;StaticLinkLibrary.lib&quot;</span>)   <span class="comment">// StaticLinkLibrary.lib对象库</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    TCHAR szBuf[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;funAdd(5, 6) = %d\nfunMul(5, 6) = %d&quot;</span>), <span class="built_in">funAdd</span>(<span class="number">5</span>, <span class="number">6</span>), <span class="built_in">funMul</span>(<span class="number">5</span>, <span class="number">6</span>));</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="动态链接库"><a href="#动态链接库" class="headerlink" title="动态链接库"></a>动态链接库</h2><p>DLL头文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的变量、类和函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_VARABLE   extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_CLASS     __declspec(dllexport)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_VARABLE   extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_CLASS     __declspec(dllimport)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/****************************************************************/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_POSITION</span> &#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">&#125;POSITION, * PPOSITION;</span><br><span class="line"><span class="comment">// 导出变量</span></span><br><span class="line">DLL_VARABLE <span class="type">int</span> nValue;   <span class="comment">// 导出普通变量</span></span><br><span class="line">DLL_VARABLE POSITION ps;  <span class="comment">// 导出结构体变量</span></span><br><span class="line"><span class="comment">// 导出类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DLL_CLASS</span> CStudent &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CStudent</span>(LPTSTR lpName, <span class="type">int</span> nAge);</span><br><span class="line">    ~<span class="built_in">CStudent</span>();</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">LPTSTR  <span class="title">GetName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int</span>     <span class="title">GetAge</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    TCHAR   m_szName[<span class="number">64</span>];</span><br><span class="line">    <span class="type">int</span>     m_nAge;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API <span class="type">int</span> WINAPI <span class="title">funAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br><span class="line"><span class="function">DLL_API <span class="type">int</span> WINAPI <span class="title">funMul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span>;</span><br></pre></td></tr></table></figure>

<p>DLL源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出变量、类和函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DllSample.h&quot;</span></span></span><br><span class="line"><span class="comment">// 变量</span></span><br><span class="line"><span class="type">int</span> nValue;   <span class="comment">// 普通变量</span></span><br><span class="line">POSITION ps;  <span class="comment">// 结构体变量</span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            nValue = <span class="number">5</span>;</span><br><span class="line">            ps.x = <span class="number">6</span>;</span><br><span class="line">            ps.y = <span class="number">7</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 类</span></span><br><span class="line">CStudent::<span class="built_in">CStudent</span>(LPTSTR lpName, <span class="type">int</span> nAge) &#123;</span><br><span class="line">    <span class="keyword">if</span> (m_szName)</span><br><span class="line">        <span class="built_in">StringCchCopy</span>(m_szName, _countof(m_szName), lpName);</span><br><span class="line">    m_nAge = nAge;</span><br><span class="line">&#125;;</span><br><span class="line">CStudent::~<span class="built_in">CStudent</span>() &#123;&#125;;</span><br><span class="line"><span class="function">LPTSTR <span class="title">CStudent::GetName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_szName;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CStudent::GetAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_nAge;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 函数</span></span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">funAdd</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">funMul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但不建议从DLL中导出变量和类，好孩子不要这么干。调用时需要.h、.lib和.dll。静态链接库.lib为对象库，包含函数实现代码，而DLL的.lib为导入库，里面只有连接到.dll的符号列表。</p>
<p>C++编译器对函数导出名有命名规则，函数名以“?”开头，后面是函数名，在“@@YA”后面表示参数列表，用代号表示如X为void、D为char、E为unsigned char、F为short、H为int、I为unsigned int、N为double等，最后以“@Z”结尾。如上述<code>funAdd</code>的导出名为<code>?funAdd@@YAHHH@Z</code>。这样命名规则导致C++编译的DLL没法被其他语言调用，解决方法是用关键字<code>extern &quot;C&quot;</code>强制使用标准C函数名称，调用约定默认为<code>__cdecl</code>，当强制改为<code>__stdcall</code>调用约定时，函数导出名前加下划线，结尾“@”后加参数传递给函数的字节数，如<code>_funAdd@8</code>。如果仍然要导出<code>funAdd</code>函数时，新建模块定义.def文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPORTS</span><br><span class="line">    funAdd</span><br><span class="line">    funMul</span><br></pre></td></tr></table></figure>

<p>然后对DLL的隐式链接：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DllSample.h&quot;</span>                  <span class="comment">// DllSample.h头文件</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;DllSample.lib&quot;</span>)   <span class="comment">// DllSample.lib导入库文件</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    TCHAR szBuf[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szBuf2[<span class="number">512</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 测试导出变量</span></span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;nValue = %d\nps.x = %d, ps.y = %d\n&quot;</span>), nValue, ps.x, ps.y);</span><br><span class="line">    <span class="built_in">StringCchCopy</span>(szBuf2, _countof(szBuf2), szBuf);</span><br><span class="line">    <span class="comment">// 测试导出类</span></span><br><span class="line">    <span class="function">CStudent <span class="title">student</span><span class="params">((LPTSTR)TEXT(<span class="string">&quot;老王&quot;</span>), <span class="number">40</span>)</span></span>;</span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;姓名：%s， 年龄：%d\n&quot;</span>), student.<span class="built_in">GetName</span>(), student.<span class="built_in">GetAge</span>());</span><br><span class="line">    <span class="built_in">StringCchCat</span>(szBuf2, _countof(szBuf2), szBuf);</span><br><span class="line">    <span class="comment">// 测试导出函数</span></span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;funAdd(5, 6) = %d\nfunMul(5, 6) = %d&quot;</span>), <span class="built_in">funAdd</span>(<span class="number">5</span>, <span class="number">6</span>), <span class="built_in">funMul</span>(<span class="number">5</span>, <span class="number">6</span>));</span><br><span class="line">    <span class="built_in">StringCchCat</span>(szBuf2, _countof(szBuf2), szBuf);</span><br><span class="line">    <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, szBuf2, <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>发行时应带上.dll文件，定位DLL文件的顺序为：可执行文件目录、Windows系统目录、Windows目录、进程当前目录、PATH环境变量列出的所有目录。</p>
<p>VC++编译使用&#x2F;MT或&#x2F;MTd选项时多线程静态链接C运行时库，程序体积增大但可在其他机器上正常运行；使用&#x2F;MD或&#x2F;MDd选项时多线程动态链接C运行时库，程序体积减小但可能出现缺少相关动态链接库的错误。</p>
<h3 id="入口点函数DllMain"><a href="#入口点函数DllMain" class="headerlink" title="入口点函数DllMain"></a>入口点函数<code>DllMain</code></h3><p>代码如上，处理一些调用DLL入口点函数的原因码，如果不需要空着就行。常见的有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>DLL_PROCESS_ATTACH</td>
<td>DLL第一次被映射到进程地址空间中时引发，后续如果再有线程用<code>LoadLibrary(Ex)</code>映射时不会引发，返回TRUE初始化成功，返回FALSE则整个进程直接退出。隐式链接时lpvReserved非NULL，显式链接为NULL。</td>
</tr>
<tr>
<td>DLL_PROCESS_DETACH</td>
<td>DLL被从进程内存空间撤销映射时引发，用<code>TerminateProcess</code>终止进程时不会引发，DLL加载失败、进程终止或<code>FreeLibrary</code>卸载DLL时引发，忽略返回值。用<code>FreeLibrary</code>或DLL加载失败而卸载DLL时lpvReserved为NULL，进程终止导致DLL卸载时lpvReserved为非NULL。</td>
</tr>
<tr>
<td>DLL_THREAD_ATTACH</td>
<td>进程中创建一个新线程时引发，一般用于新线程初始化。地址空间所有DLL都会被通知，所有DLL该通知都执行结束后才创建，主线程的创建不引发该通知，忽略返回值。</td>
</tr>
<tr>
<td>DLL_THREAD_DETACH</td>
<td>进程中有一个线程正在退出时引发，一般用于相关善后。所有DLL都处理完该通知时该线程才退出，用<code>TerminateProcess</code>终止进程时不会引发，DLL加载失败、进程终止或<code>FreeLibrary</code>卸载DLL时不引发。</td>
</tr>
</tbody></table>
<h3 id="延迟加载DLL"><a href="#延迟加载DLL" class="headerlink" title="延迟加载DLL"></a>延迟加载DLL</h3><p>即显式加载DLL。编译器在可执行模块中嵌入<code>__delayLoadHelper2</code>函数，延迟加载DLL函数时跳转该函数，该函数解析延迟加载导入表，并用<code>LoadLibrary(Ex)</code>和<code>GetProcAddress</code>等函数完成加载和函数地址解析。当延迟加载的DLL不存在时，或当DLL中一个函数不存在时，该函数抛出一个异常，可用结构化异常处理SEH捕捉异常来继续运行，否则进程终止。</p>
<h4 id="FUnloadDelayLoadedDLL2"><a href="#FUnloadDelayLoadedDLL2" class="headerlink" title="__FUnloadDelayLoadedDLL2"></a>__FUnloadDelayLoadedDLL2</h4><p>当希望一个延迟加载的DLL在进程结束或DLL卸载时不会被立即释放内存，下次加载时速度更快时，可对链接器开启&#x2F;DELAY:UNLOAD选项。当确实要把某个延迟加载的DLL从内存中释放时使用该函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BOOL WINAPI __FUnloadDelayLoadedDLL2(</span><br><span class="line">    LPCSTR szDll <span class="comment">//ANSI字符串 区分大小写</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="DragQueryFile"><a href="#DragQueryFile" class="headerlink" title="DragQueryFile"></a>DragQueryFile</h4><p>查询所拖放文件的名称：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UINT <span class="title">DragQueryFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HDROP hDrop,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT iFile, <span class="comment">//要查询的文件索引</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPTSTR lpszFile, <span class="comment">//返回指定索引的文件名的缓冲区</span></span></span></span><br><span class="line"><span class="params"><span class="function">    UINT cch <span class="comment">//lpszFile缓冲区大小 单位字符</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回复制到lpszFile缓冲区字符数 不含终止空字符</span></span><br></pre></td></tr></table></figure>

<p>对于iFile，文件索引从0开始，设置为0xFFFFFFFF时函数返回所拖放文件总数。该值介于0和所拖放文件总数之间时将指定索引文件名复制到lpszFile缓冲区。 当lpszFile为NULL则函数返回所需缓冲区大小，单位字符，不含终止空字符。</p>
<p>要创建一个支持拖放的窗口时，<code>CreateWindowEx</code>的dwExStyle指定WS_EX_ACCEPTFILES，程序接收WM_DROPFILES消息，wParam为所拖放文件信息的HDROP类型结构句柄，lParam缺省，处理完该消息应返回0。</p>
<p>例如获取所有拖动文件的文件名：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HDROP hDrop;</span><br><span class="line">UINT uDragCount;</span><br><span class="line">TCHAR szFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">case</span> WM_DROPFILES: &#123;</span><br><span class="line">    hDrop = (HDROP)wParam;</span><br><span class="line">    uDragCount = <span class="built_in">DragQueryFile</span>(hDrop, <span class="number">0xFFFFFFFF</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; uDragCount; i++) &#123;</span><br><span class="line">        <span class="built_in">DragQueryFile</span>(hDrop, i, szFileName, _countof(szFileName));</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="DragQueryPoint"><a href="#DragQueryPoint" class="headerlink" title="DragQueryPoint"></a>DragQueryPoint</h4><p>查询拖动操作期间鼠标指针位置：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DragQueryPoint</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HDROP hDrop,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PPOINT lppt</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="DragFinish"><a href="#DragFinish" class="headerlink" title="DragFinish"></a>DragFinish</h4><p>释放系统为拖动操作分配的内存：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DragFinish</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    HDROP hDrop</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>GetMd5.dll源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GetMd5.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数</span></span><br><span class="line"><span class="function">BOOL <span class="title">GetMd5</span><span class="params">(LPCTSTR lpFileName, LPTSTR lpMd5)</span> </span>&#123;</span><br><span class="line">    HANDLE hFile, hFileMap;</span><br><span class="line">    HCRYPTPROV hProv, hHash;</span><br><span class="line">    TCHAR szContainer[] = <span class="built_in">TEXT</span>(<span class="string">&quot;MyKeyContainer&quot;</span>);</span><br><span class="line">    LPVOID lpMemory;</span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    hFile = <span class="built_in">CreateFile</span>(lpFileName, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 获取指定加密服务提供程序(CSP)中指定密钥容器的句柄</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CryptAcquireContext</span>(&amp;hProv, szContainer, <span class="literal">NULL</span>, PROV_RSA_FULL, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">CryptAcquireContext</span>(&amp;hProv, szContainer, <span class="literal">NULL</span>, PROV_RSA_FULL, CRYPT_NEWKEYSET))</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 创建加密服务提供程序(CSP)哈希对象的句柄，第2个参数指定为不同的值可以获取不同的哈希例如SHA</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CryptCreateHash</span>(hProv, CALG_MD5, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;hHash))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 为了能够处理大型文件，所以使用内存映射文件。为hFile文件对象创建一个文件映射内核对象</span></span><br><span class="line">    hFileMap = <span class="built_in">CreateFileMapping</span>(hFile, <span class="literal">NULL</span>, PAGE_READONLY, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hFileMap)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 获取文件大小，内存分配粒度</span></span><br><span class="line">    __int64 qwFileSize;</span><br><span class="line">    DWORD dwFileSizeHigh;</span><br><span class="line">    SYSTEM_INFO si;</span><br><span class="line">    qwFileSize = <span class="built_in">GetFileSize</span>(hFile, &amp;dwFileSizeHigh);</span><br><span class="line">    qwFileSize += (((__int64)dwFileSizeHigh) &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    <span class="built_in">GetSystemInfo</span>(&amp;si);</span><br><span class="line">    <span class="comment">// 把文件映射对象hFileMap不断映射到进程的虚拟地址空间中</span></span><br><span class="line">    __int64 qwFileOffset = <span class="number">0</span>;   <span class="comment">// 文件映射对象偏移量</span></span><br><span class="line">    DWORD dwBytesInBlock;       <span class="comment">// 本次映射大小</span></span><br><span class="line">    <span class="keyword">while</span> (qwFileSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        dwBytesInBlock = si.dwAllocationGranularity;</span><br><span class="line">        <span class="keyword">if</span> (qwFileSize &lt; dwBytesInBlock)</span><br><span class="line">            dwBytesInBlock = (DWORD)qwFileSize;</span><br><span class="line">        lpMemory = <span class="built_in">MapViewOfFile</span>(hFileMap, FILE_MAP_READ, (DWORD)(qwFileOffset &gt;&gt; <span class="number">32</span>), (DWORD)(qwFileOffset &amp; <span class="number">0xFFFFFFFF</span>), dwBytesInBlock);</span><br><span class="line">        <span class="keyword">if</span> (!lpMemory)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        <span class="comment">// 对已映射部分进行操作，将数据添加到哈希对象</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">CryptHashData</span>(hHash, (LPBYTE)lpMemory, dwBytesInBlock, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        <span class="comment">// 取消本次映射，进行下一轮映射</span></span><br><span class="line">        <span class="built_in">UnmapViewOfFile</span>(lpMemory);</span><br><span class="line">        qwFileOffset += dwBytesInBlock;</span><br><span class="line">        qwFileSize -= dwBytesInBlock;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 获取哈希值中的字节数</span></span><br><span class="line">    DWORD dwHashLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CryptGetHashParam</span>(hHash, HP_HASHVAL, <span class="literal">NULL</span>, &amp;dwHashLen, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 获取哈希值</span></span><br><span class="line">    LPBYTE lpHash = <span class="keyword">new</span> BYTE[dwHashLen];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CryptGetHashParam</span>(hHash, HP_HASHVAL, lpHash, &amp;dwHashLen, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwHashLen; i++)</span><br><span class="line">        <span class="built_in">wsprintf</span>(lpMd5 + i * <span class="number">2</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;%02X&quot;</span>), lpHash[i]);</span><br><span class="line">    <span class="keyword">delete</span>[]lpHash;</span><br><span class="line">    <span class="comment">// 关闭文件映射内核对象句柄</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFileMap);</span><br><span class="line">    <span class="comment">// 关闭文件句柄</span></span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">    <span class="comment">// 释放哈希句柄</span></span><br><span class="line">    <span class="built_in">CryptDestroyHash</span>(hHash);</span><br><span class="line">    <span class="comment">// 释放CSP句柄</span></span><br><span class="line">    <span class="built_in">CryptReleaseContext</span>(hProv, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  CryptAcquireContext函数用于获取指定加密服务提供程序(CSP)中指定密钥容器的句柄，返回的句柄用于调用所选CSP的CryptoAPI函数；</span></span><br><span class="line"><span class="comment">  CryptCreateHash函数启动数据流的哈希处理， 该函数创建加密服务提供程序(CSP)哈希对象的句柄，该句柄可以用于后续的CryptHashData函数调用；</span></span><br><span class="line"><span class="comment">  CryptHashData函数用于将数据添加到指定的哈希对象，可以多次调用该函数来计算长数据流或不连续数据流的哈希；</span></span><br><span class="line"><span class="comment">  CryptGetHashParam函数用于获取具体的哈希值。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>GetMd5.dll头文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API BOOL <span class="title">GetMd5</span><span class="params">(LPCTSTR lpFileName, LPTSTR lpMd5)</span></span>;</span><br></pre></td></tr></table></figure>

<p>调用者：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Shlwapi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;delayimp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;GetMd5.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Shlwapi.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;GetMd5.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hInstance;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    g_hInstance = hInstance;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HRSRC hResBlock;</span><br><span class="line">    HANDLE hRes;</span><br><span class="line">    LPVOID lpDll;</span><br><span class="line">    DWORD dwDllSize;</span><br><span class="line">    HANDLE hFile;</span><br><span class="line">    TCHAR szFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szMd5[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    HDROP hDrop;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            <span class="comment">// 关于ChangeWindowMessageFilterEx函数，请参见用户界面特权隔离一节</span></span><br><span class="line">            <span class="built_in">ChangeWindowMessageFilterEx</span>(hwndDlg, WM_DROPFILES, MSGFLT_ALLOW, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">ChangeWindowMessageFilterEx</span>(hwndDlg, <span class="number">0x49</span>, MSGFLT_ALLOW, <span class="literal">NULL</span>);<span class="comment">// 0x49 == WM_COPYGLOBALDATA</span></span><br><span class="line">            <span class="comment">//ChangeWindowMessageFilter(WM_DROPFILES, MSGFLT_ADD);</span></span><br><span class="line">            <span class="comment">//ChangeWindowMessageFilter(0x49, MSGFLT_ADD);          </span></span><br><span class="line">             <span class="comment">// 如果当前目录下不存在GetMd5.dll</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">PathFileExists</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GetMd5.dll&quot;</span>))) &#123;</span><br><span class="line">                hResBlock = <span class="built_in">FindResource</span>(g_hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDR_MYDLL), <span class="built_in">TEXT</span>(<span class="string">&quot;MyDll&quot;</span>));</span><br><span class="line">                <span class="keyword">if</span> (!hResBlock)</span><br><span class="line">                    <span class="keyword">return</span> FALSE;</span><br><span class="line">                hRes = <span class="built_in">LoadResource</span>(g_hInstance, hResBlock);</span><br><span class="line">                <span class="keyword">if</span> (!hRes)</span><br><span class="line">                    <span class="keyword">return</span> FALSE;</span><br><span class="line">                lpDll = <span class="built_in">LockResource</span>(hRes);</span><br><span class="line">                dwDllSize = <span class="built_in">SizeofResource</span>(g_hInstance, hResBlock);</span><br><span class="line">                hFile = <span class="built_in">CreateFile</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GetMd5.dll&quot;</span>), GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, <span class="literal">NULL</span>, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">                    <span class="keyword">return</span> FALSE;</span><br><span class="line">                <span class="built_in">WriteFile</span>(hFile, lpDll, dwDllSize, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_GETMD5: &#123;</span><br><span class="line">                    <span class="comment">// 获取指定文件的MD5</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_FILENAME, szFileName, _countof(szFileName)))</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">GetMd5</span>(szFileName, szMd5)) &#123;</span><br><span class="line">                            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_MD5, szMd5);</span><br><span class="line">                            <span class="comment">// 卸载延迟加载的dll</span></span><br><span class="line">                            __FUnloadDelayLoadedDLL2(<span class="string">&quot;GetMd5.dll&quot;</span>);</span><br><span class="line">                        &#125;;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_DROPFILES: &#123;</span><br><span class="line">            hDrop = (HDROP)wParam;</span><br><span class="line">            <span class="built_in">DragQueryFile</span>(hDrop, <span class="number">0</span>, szFileName, _countof(szFileName));</span><br><span class="line">            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_FILENAME, szFileName);</span><br><span class="line">            <span class="built_in">DragFinish</span>(hDrop);</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="线程局部存储"><a href="#线程局部存储" class="headerlink" title="线程局部存储"></a>线程局部存储</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>线程局部存储TLS结构包含索引数组（或进程位数组）和存储槽。索引数组为4字，一共64位，每一位对应存储槽数组中的一个元素。存储槽为一个64个LPVOID类型元素的数组，每个LPVOID元素为一个指向具体内容的指针。每一个线程都有一个存储槽，但线程之间共用同一个索引数组。索引数组的每一位为1则代表所有线程的存储槽该数组索引位置均有地址指向数据，为0则没有。索引数组位数最少为TLS_MINIMUM_AVAILABLE即64个，需要时系统分配更多，最高记录1088个。用<code>NtCurrentTeb</code>获取当前线程的线程环境块TEB结构指针。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TEB</span> &#123;</span><br><span class="line">    PVOID Reserved1[<span class="number">12</span>];</span><br><span class="line">    PPEB  ProcessEnvironmentBlock; <span class="comment">//进程环境块PEB结构指针</span></span><br><span class="line">    PVOID Reserved2[<span class="number">399</span>];</span><br><span class="line">    BYTE  Reserved3[<span class="number">1952</span>];</span><br><span class="line">    PVOID TlsSlots[<span class="number">64</span>]; <span class="comment">//线程存储槽</span></span><br><span class="line">    BYTE  Reserved4[<span class="number">8</span>];</span><br><span class="line">    PVOID Reserved5[<span class="number">26</span>];</span><br><span class="line">    PVOID ReservedForOle;</span><br><span class="line">    PVOID Reserved6[<span class="number">4</span>];</span><br><span class="line">    PVOID TlsExpansionSlots;</span><br><span class="line">&#125; TEB, * PTEB;</span><br></pre></td></tr></table></figure>

<h3 id="TlsAlloc"><a href="#TlsAlloc" class="headerlink" title="TlsAlloc"></a>TlsAlloc</h3><p>从进程中分配一个TLS索引，把索引数组某位设为1，且每个线程存储槽中该索引位置初始化为NULL，进程中每个线程可使用该索引操作自己的数据。分配到的TLS索引为了每个线程都要访问，一般要设为全局变量。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">TlsAlloc</span><span class="params">(VOID)</span></span>; <span class="comment">//成功返回TLS索引 失败TLS_OUT_OF_INDEXES</span></span><br></pre></td></tr></table></figure>

<h3 id="TlsSetValue"><a href="#TlsSetValue" class="headerlink" title="TlsSetValue"></a>TlsSetValue</h3><p>在存储槽指定索引处写入数据：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">TlsSetValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwTlsIndex, <span class="comment">//TLS索引</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ LPVOID lpTlsValue <span class="comment">//要存储在调用线程TLS插槽中指定索引处的值</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="TlsGetValue"><a href="#TlsGetValue" class="headerlink" title="TlsGetValue"></a>TlsGetValue</h3><p>获取存储槽中指定索引处的数据：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID WINAPI <span class="title">TlsGetValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwTlsIndex <span class="comment">//TLS索引</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回调用线程存储槽中指定索引处值 失败返回0且GetLastError为ERROR_SUCCESS</span></span><br></pre></td></tr></table></figure>

<h3 id="TlsFree"><a href="#TlsFree" class="headerlink" title="TlsFree"></a>TlsFree</h3><p>释放TLS索引，把索引数组中对应位置0，并把每个线程存储槽中该索引位置数据化NULL。注意它不释放内容指针指向内存，自己搞的自己手动释放。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">TlsFree</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwTlsIndex <span class="comment">//TLS索引</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THREADCOUNT 5</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">DWORD g_dwTlsIndex;</span><br><span class="line">HWND g_hwndDlg;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 线程函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HANDLE hThread[THREADCOUNT] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_OK: &#123;</span><br><span class="line">                    <span class="comment">// 从进程中分配一个TLS索引</span></span><br><span class="line">                    g_dwTlsIndex = <span class="built_in">TlsAlloc</span>();</span><br><span class="line">                    <span class="keyword">if</span> (g_dwTlsIndex == TLS_OUT_OF_INDEXES) &#123;</span><br><span class="line">                        <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;TlsAlloc函数调用失败！&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">                        <span class="keyword">return</span> FALSE;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="comment">// 创建THREADCOUNT个线程</span></span><br><span class="line">                    <span class="built_in">SetDlgItemText</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS, <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; THREADCOUNT; i++)</span><br><span class="line">                        <span class="keyword">if</span> ((hThread[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, (LPVOID)i, <span class="number">0</span>, <span class="literal">NULL</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">                            <span class="built_in">CloseHandle</span>(hThread[i]);</span><br><span class="line">                    <span class="comment">// 等待所有线程结束，释放TLS索引</span></span><br><span class="line">                    <span class="built_in">WaitForMultipleObjects</span>(THREADCOUNT, hThread, TRUE, INFINITE);</span><br><span class="line">                    <span class="built_in">TlsFree</span>(g_dwTlsIndex);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span> </span>&#123;</span><br><span class="line">    LPVOID lpData = <span class="literal">NULL</span>;</span><br><span class="line">    TCHAR szBuf[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    lpData = <span class="keyword">new</span> BYTE[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(lpData, <span class="number">256</span>);</span><br><span class="line">    <span class="comment">// 在自己的存储槽中指定索引处写入数据</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">TlsSetValue</span>(g_dwTlsIndex, lpData)) &#123;</span><br><span class="line">        <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;线程%d调用TlsSetValue失败&quot;</span>), (INT)lpParameter);</span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">        <span class="keyword">delete</span>[]lpData;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 获取自己的存储槽中指定索引处的数据</span></span><br><span class="line">    lpData = <span class="built_in">TlsGetValue</span>(g_dwTlsIndex);</span><br><span class="line">    <span class="keyword">if</span> (!lpData &amp;&amp; <span class="built_in">GetLastError</span>() != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;线程%d调用TlsGetValue失败&quot;</span>), (INT)lpParameter);</span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;错误提示&quot;</span>), MB_OK);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 每个线程存储槽中指定索引处的数据显示到编辑控件中</span></span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;线程%d的索引%d处的值：0x%p\r\n&quot;</span>), (INT)lpParameter, g_dwTlsIndex, lpData);</span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS), EM_SETSEL, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS), EM_REPLACESEL, TRUE, (LPARAM)szBuf);</span><br><span class="line">    <span class="keyword">delete</span>[]lpData;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="静态TLS"><a href="#静态TLS" class="headerlink" title="静态TLS"></a>静态TLS</h3><p>使用这种方式声明为全局变量或静态变量：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__declspec(thread) LPVOID gt_lpData;</span><br></pre></td></tr></table></figure>

<p>该前缀在编译链接时把变量放到.tls区段，如果是Release版本可能会被优化到别的区段。一般用gt_前缀表示全局TLS变量，用st_表示静态TLS变量。当然每个线程的该变量都是独立的，上面那个例子可以改写成：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 宏定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THREADCOUNT 5</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">__declspec(thread) LPVOID gt_lpData = <span class="literal">NULL</span>;</span><br><span class="line">HWND g_hwndDlg;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="comment">// 线程函数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HANDLE hThread[THREADCOUNT];</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_OK: &#123;</span><br><span class="line">                    <span class="comment">// 创建THREADCOUNT个线程</span></span><br><span class="line">                    <span class="built_in">SetDlgItemText</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS, <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; THREADCOUNT; i++)</span><br><span class="line">                        <span class="keyword">if</span> ((hThread[i] = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, (LPVOID)i, <span class="number">0</span>, <span class="literal">NULL</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">                            <span class="built_in">CloseHandle</span>(hThread[i]);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span> </span>&#123;</span><br><span class="line">    TCHAR szBuf[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    gt_lpData = <span class="keyword">new</span> BYTE[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(gt_lpData, <span class="number">256</span>);</span><br><span class="line">    <span class="comment">// 每个线程的静态TLS数据显示到编辑控件中</span></span><br><span class="line">    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;线程%d的gt_lpData值：0x%p\r\n&quot;</span>), (INT)lpParameter, gt_lpData);</span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS), EM_SETSEL, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(g_hwndDlg, IDC_EDIT_TLSSLOTS), EM_REPLACESEL, TRUE, (LPARAM)szBuf);</span><br><span class="line">    <span class="keyword">delete</span>[]gt_lpData;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Windows钩子"><a href="#Windows钩子" class="headerlink" title="Windows钩子"></a>Windows钩子</h2><h3 id="SetWindowsHookEx"><a href="#SetWindowsHookEx" class="headerlink" title="SetWindowsHookEx"></a>SetWindowsHookEx</h3><p>将应用程序定义的钩子函数安装到钩子链中，钩子函数用于监视系统某些类型事件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HHOOK WINAPI <span class="title">SetWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ INT idHook, <span class="comment">//要安装的钩子函数类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HOOKPROC lpfn, <span class="comment">//指向钩子函数指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HINSTANCE hMod, <span class="comment">//包含钩子函数的DLL模块句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwThreadId <span class="comment">//与钩子函数关联的线程ID 即被监视进程</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功返回钩子函数句柄 失败NULL</span></span><br></pre></td></tr></table></figure>

<p>idHook钩子函数类型常用的有：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>WH_GETMESSAGE</td>
<td>用<code>GetMessage</code>或<code>PeekMessage</code>获取消息时调用钩子函数。</td>
</tr>
<tr>
<td>WH_KEYBOARD</td>
<td>用<code>GetMessage</code>或<code>PeekMessage</code>获取键盘消息WM_KEYUP或WM_KEYDOWN时调用钩子函数。</td>
</tr>
<tr>
<td>WH_MOUSE</td>
<td>用<code>GetMessage</code>或<code>PeekMessage</code>获取鼠标消息时调用钩子函数。</td>
</tr>
<tr>
<td>WH_CALLWNDPROC</td>
<td>系统消息发送到目标从窗口过程前调用钩子函数。</td>
</tr>
<tr>
<td>WH_CALLWNDPROCRET</td>
<td>目标窗口过程处理完消息后调用钩子函数。</td>
</tr>
<tr>
<td>WH_DEBUG</td>
<td>&#x2F;调用其他钩子函数前调用本钩子函数。</td>
</tr>
<tr>
<td>WH_CBT</td>
<td>激活&#x2F;创建&#x2F;销毁&#x2F;最小化&#x2F;最大化&#x2F;移动&#x2F;调整窗口前、完成系统命令前、从系统消息队列中删除鼠标&#x2F;键盘事件前、设置键盘焦点前、与系统消息队列同步前调用钩子函数。</td>
</tr>
<tr>
<td>WH_FOREGROUNDIDLE</td>
<td>前台线程即将变为空闲时调用钩子函数。</td>
</tr>
<tr>
<td>WH_JOURNALRECORD</td>
<td>记录发送给系统消息队列所有信息，钩子函数不需要在DLL中。</td>
</tr>
<tr>
<td>WH_JOURNALPLAYBACK</td>
<td>回放日志记录钩子记录的系统事件，钩子函数不需要在DLL中。</td>
</tr>
<tr>
<td>WH_MSGFILTER</td>
<td>用户对对话框&#x2F;消息框&#x2F;菜单&#x2F;滚动条操作后，系统发送对应消息前调用钩子函数，局部钩子。</td>
</tr>
<tr>
<td>WH_SYSMSGFILTER</td>
<td>同WH_MSGFILTER，系统钩子。</td>
</tr>
<tr>
<td>WH_SHELL</td>
<td>Windows Shell接收通知事件前调用钩子函数，如Shell被激活&#x2F;重绘。</td>
</tr>
</tbody></table>
<p>当监视当前进程时，lpfn指向的钩子函数位于当前进程程序代码中，hMod为NULL，dwThreadId设置为当前进程的线程ID。当监视其他进程时，lpfn指向的钩子函数必须位于DLL中，hMod为包含钩子函数的DLL模块句柄，dwThreadId设置为其他进程创建的线程ID。当设置全局系统钩子时，lpfn指向的钩子函数必须位于DLL中，hMod为包含钩子函数的DLL模块句柄，dwThreadId为0。</p>
<p>钩子回调函数定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">HookProc</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    INT nCode,</span></span></span><br><span class="line"><span class="params"><span class="function">    WPARAM wParam,</span></span></span><br><span class="line"><span class="params"><span class="function">    LPARAM lParam</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="CallNextHookEx"><a href="#CallNextHookEx" class="headerlink" title="CallNextHookEx"></a>CallNextHookEx</h3><p>把消息事件传递给钩子链中下一个钩子函数。系统中可安装多个不同类型或相同类型的钩子，每种钩子有维护一个钩子链，是同种类型钩子的钩子函数指针列表，最近加入的钩子放在链表头部，每个钩子函数有义务把消息事件传递下去。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT WINAPI <span class="title">CallNextHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HHOOK hhk, <span class="comment">//忽略</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ INT nCode,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ WPARAM wParam,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPARAM lParam</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>nCode、wParam、lParam用钩子函数同名参数即可。</p>
<h3 id="UnhookWindowsHookEx"><a href="#UnhookWindowsHookEx" class="headerlink" title="UnhookWindowsHookEx"></a>UnhookWindowsHookEx</h3><p>卸载安装在钩子链中的钩子函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">UnhookWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HHOOK hhk <span class="comment">//钩子句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="ToUnicode"><a href="#ToUnicode" class="headerlink" title="ToUnicode"></a>ToUnicode</h3><p>把虚拟键码转为Unicode字符：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INT WINAPI <span class="title">ToUnicode</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT wVirtKey, <span class="comment">//要转换的虚拟键码</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT wScanCode, <span class="comment">//按键扫描码</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ CONST PBYTE lpKeyState, <span class="comment">//指向包含当前键盘状态的256字节数组指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPWSTR pwszBuff, <span class="comment">//接收转换后的Unicode字符缓冲区</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ INT cchBuff, <span class="comment">//pwszBuff缓冲区大小 单位字符</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT wFlags <span class="comment">//为0或1则菜单处于活动状态</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>就钩子函数应用场景来说，wVirtKey用wParam，wScanCode用lParam高16位即可，lpKeyState不讲了看下面例子用法。</p>
<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子"></a>例子</h3><p>定义一个WH_KEYBOARD键盘钩子的钩子函数。对于回调函数的nCode，当小于0时钩子函数必须将消息传递给<code>CallNextHookEx</code>并返回其返回值，当为HC_ACTION时表示wParam和lParam中含有有关击键消息，处理完用<code>CallNextHookEx</code>传递下去，也可以直接返回TRUE丢弃信息并组织信息向下传播。wParam包含虚拟键码，lParam包含消息重复计数、扫描码、扩展键标志、状态描述吗、先前键状态标志、转换状态标志等。</p>
<p>DLL头文件为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API BOOL <span class="title">InstallHook</span><span class="params">(<span class="type">int</span> idHook, DWORD dwThreadId, HWND hwnd)</span></span>;</span><br><span class="line"><span class="function">DLL_API BOOL <span class="title">UninstallHook</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 内部函数</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">KeyboardProc</span><span class="params">(<span class="type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span></span>;</span><br></pre></td></tr></table></figure>

<p>DLL源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;HookDll.h&quot;</span></span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hMod;</span><br><span class="line">HHOOK g_hHookKeyboard;</span><br><span class="line">TCHAR g_szBuf[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg(<span class="string">&quot;Shared&quot;</span>)</span></span><br><span class="line">    HWND  g_hwnd = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg()</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/SECTION:Shared,RWS&quot;</span>)</span></span><br><span class="line">    <span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">            <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">                g_hMod = hModule;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">            <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">            <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line">    <span class="function">BOOL <span class="title">InstallHook</span><span class="params">(<span class="type">int</span> idHook, DWORD dwThreadId, HWND hwnd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!g_hHookKeyboard) &#123;</span><br><span class="line">            g_hwnd = hwnd;</span><br><span class="line">            g_hHookKeyboard = <span class="built_in">SetWindowsHookEx</span>(idHook, KeyboardProc, g_hMod, dwThreadId);</span><br><span class="line">            <span class="keyword">if</span> (!g_hHookKeyboard)</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function">BOOL <span class="title">UninstallHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (g_hHookKeyboard)</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">UnhookWindowsHookEx</span>(g_hHookKeyboard))</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">        g_hHookKeyboard = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">// 内部函数</span></span><br><span class="line">    <span class="function">LRESULT CALLBACK <span class="title">KeyboardProc</span><span class="params">(<span class="type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">        BYTE bKeyState[<span class="number">256</span>];</span><br><span class="line">        COPYDATASTRUCT copyDataStruct = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> (nCode &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">CallNextHookEx</span>(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line">        <span class="keyword">if</span> (nCode == HC_ACTION) &#123;</span><br><span class="line">            <span class="built_in">GetKeyboardState</span>(bKeyState);</span><br><span class="line">            bKeyState[VK_SHIFT] = <span class="built_in">HIBYTE</span>(<span class="built_in">GetKeyState</span>(VK_SHIFT));</span><br><span class="line">            <span class="built_in">ZeroMemory</span>(g_szBuf, <span class="built_in">sizeof</span>(g_szBuf));</span><br><span class="line">            <span class="built_in">ToUnicode</span>(wParam, lParam &gt;&gt; <span class="number">16</span>, bKeyState, g_szBuf, _countof(g_szBuf), <span class="number">0</span>);</span><br><span class="line">            copyDataStruct.cbData = <span class="built_in">sizeof</span>(g_szBuf);</span><br><span class="line">            copyDataStruct.lpData = g_szBuf;</span><br><span class="line">            <span class="built_in">SendMessage</span>(g_hwnd, WM_COPYDATA, (WPARAM)g_hwnd, (LPARAM)&amp;copyDataStruct);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CallNextHookEx</span>(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>监视程序：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;HookDll.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;HookDll.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_INSTALLHOOK: &#123;</span><br><span class="line">                    <span class="built_in">InstallHook</span>(WH_KEYBOARD, <span class="number">0</span>, hwndDlg);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_UNINSTALLHOOK: &#123;</span><br><span class="line">                    <span class="built_in">UninstallHook</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">UninstallHook</span>();</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COPYDATA: &#123;</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_KEYBOARD), EM_SETSEL, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">            <span class="built_in">SendMessage</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_EDIT_KEYBOARD), EM_REPLACESEL, TRUE, (LPARAM)(LPTSTR)(((PCOPYDATASTRUCT)lParam)-&gt;lpData));</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>获取其他窗口信息时最好用<code>PostMessage</code>而不是<code>SendMessage</code>，要不处理事件可能过长。</p>
<h2 id="变量共享"><a href="#变量共享" class="headerlink" title="变量共享"></a>变量共享</h2><p>创建一个叫“Shared”的区段，里面放个变量。注意只能将已初始化的变量保存到自定义段中，没初始化就跑别的段去了。结尾表示自定义段结束，回到默认段。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg(<span class="string">&quot;Shared&quot;</span>)</span></span><br><span class="line">    HWND g_hwnd = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> data_seg()</span></span><br></pre></td></tr></table></figure>

<p>为“Shared”段指定相关属性，R为READ，W为WRITE，E为EXECUTE，S为SHARED。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;/SECTION:Shared,RWS&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<h2 id="DLL注入"><a href="#DLL注入" class="headerlink" title="DLL注入"></a>DLL注入</h2><h3 id="前提芝士"><a href="#前提芝士" class="headerlink" title="前提芝士"></a>前提芝士</h3><p>下面小节有杂七杂八的新芝士，这里一口气介绍完。</p>
<p>对于桌面上图标，每个图标都为一个列表项。发送LVM_GETITEMTEXT获取列表项文本，wParam为列表项索引，lParam为指向LVITEM结构的指针。 发送LVM_GETITEMPOSITION获取列表项位置，wParam指定为列表项索引，lParam为指向POINT结构指针，返回列表项左上角坐标。发送LVM_FINDITEM查找桌面上具有指定列表项文本的列表项，wParam指定开始搜索的列表项索引，不包括指定项，-1从头开始，lParam是指向LVFINDINFO结构指针，包含有关要搜索内容信息。发送LVM_SETITEMPOSITION设置该列表项位置，wParam为列表项索引，LOWORD(lParam)和HIWORD(lParam)为左上角的X、Y坐标。</p>
<p>系统中程序管理器Program Manager窗口类名为Progman（Win10为WorkerW？），其下有一个窗口类名SHELLDLL_DefView的子窗口，旗下有一个窗口类名为SysListView32的子窗口，即桌面列表视图控件。</p>
<h4 id="GetTopWindow"><a href="#GetTopWindow" class="headerlink" title="GetTopWindow"></a>GetTopWindow</h4><p>查找指定父窗口关联的第一个子窗口句柄：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HWND WINAPI <span class="title">GetTopWindow</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ HWND hWnd <span class="comment">//父窗口句柄 为NULL则返回桌面窗口顶层窗口句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="GetNativeSystemInfo"><a href="#GetNativeSystemInfo" class="headerlink" title="GetNativeSystemInfo"></a>GetNativeSystemInfo</h4><p>之前<code>GetSystemInfo</code>返回的SYSTEM_INFO结构的wProcessorArchitecture如果为PROCESSOR_ARCHITECTURE_INTEL则32位，为PROCESSOR_ARCHITECTURE_AMD64或PROCESSOR_ARCHITECTURE_IA64则64位，但这返回的是系统架构。如果想要获取当前进程为64位还是在WoW64下运行的32位应用程序，如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">Is64bitSystem</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">    SYSTEM_INFO si = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">GetNativeSystemInfo</span>(&amp;si);</span><br><span class="line">    <span class="keyword">if</span> (si.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_AMD64 || si.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_IA64)</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="IsWow64Process"><a href="#IsWow64Process" class="headerlink" title="IsWow64Process"></a>IsWow64Process</h4><p>判断一个进程是否运行在WoW64环境中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">IsWow64Process</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//进程句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PBOOL Wow64Process <span class="comment">//返回TRUE或FALSE</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>hProcess需要PROCESS_QUERY_INFORMATION或PROCESS_QUERY_LIMITED_INFORMATION。</p>
<h4 id="CreateRemoteThread"><a href="#CreateRemoteThread" class="headerlink" title="CreateRemoteThread"></a>CreateRemoteThread</h4><p>在其他进程中创建一个远程线程：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE WINAPI <span class="title">CreateRemoteThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE hProcess, <span class="comment">//目标远程进程</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPSECURITY_ATTRIBUTES lpThreadAttributes, <span class="comment">//线程安全属性结构</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ SIZE_T dwStackSize, <span class="comment">//线程栈空间大小 单位字节</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPTHREAD_START_ROUTINE lpStartAddress, <span class="comment">//线程函数指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ LPVOID lpParameter, <span class="comment">//传递给线程函数的参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ DWORD dwCreationFlags, <span class="comment">//线程创建标志</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ LPDWORD lpThreadId <span class="comment">//返回线程ID</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="SystemParameterInfo"><a href="#SystemParameterInfo" class="headerlink" title="SystemParameterInfo"></a>SystemParameterInfo</h4><p>用于获取或设置系统参数，包括桌面、图标、输入（键盘、鼠标、输入语言等）、菜单、电源、屏保、超时、UI效果、窗口和辅助功能等。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">SystemParameterInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uiAction, <span class="comment">//要获取或设置的系统参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT uiParam, <span class="comment">//参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PVOID pvParam, <span class="comment">//参数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT fWinIni <span class="comment">//选项</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>uiAction系统参数很多自己去查MSDN，其决定uiParam和pvParam的具体含义。当fWinIni为SPIF_UPDATEINIFILE表示将新的系统参数写入用户配置文件，为SPIF_SENDCHANGE表示既写入用户配置文件也广播WM_SETTINGCHANGE消息到所有顶级窗口，为0则不需要。</p>
<h4 id="Wow64DisableWow64FsRedirection-Wow64RevertWow64FsRedirection"><a href="#Wow64DisableWow64FsRedirection-Wow64RevertWow64FsRedirection" class="headerlink" title="Wow64DisableWow64FsRedirection&#x2F;Wow64RevertWow64FsRedirection"></a>Wow64DisableWow64FsRedirection&#x2F;Wow64RevertWow64FsRedirection</h4><p>禁用&#x2F;恢复调用线程的文件系统重定向：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL WINAPI <span class="title">Wow64DisableWow64FsRedirection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PVOID* ppOldValue <span class="comment">//返回一些WoW64文件系统重定向信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">Wow64RevertWow64FsRedirection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PVOID pOldValue <span class="comment">//Wow64DisableWow64FsRedirection返回的文件重定向信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这俩玩意儿一般这么配合着用：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LPVOID pOldValue = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">Wow64DisableWow64FsRedirection</span>(&amp;pOldValue);</span><br><span class="line"><span class="built_in">Wow64RevertWow64FsRedirection</span>(&amp;pOldValue);</span><br></pre></td></tr></table></figure>

<h3 id="Windows钩子注入"><a href="#Windows钩子注入" class="headerlink" title="Windows钩子注入"></a>Windows钩子注入</h3><p>被注入的DLL头文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API BOOL <span class="title">InstallHook</span><span class="params">(<span class="type">int</span> idHook, DWORD dwThreadId)</span></span>;<span class="comment">// 两参数分别是钩子类型和资源管理器线程ID</span></span><br><span class="line"><span class="function">DLL_API BOOL <span class="title">UninstallHook</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>被注入的DLL源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Commctrl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DIPSHookDll.h&quot;</span></span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HINSTANCE g_hMod;</span><br><span class="line">HHOOK g_hHook;</span><br><span class="line">TCHAR g_szRegSubKey[] = <span class="built_in">TEXT</span>(<span class="string">&quot;Software\\Desktop Item Position Saver&quot;</span>);</span><br><span class="line"><span class="comment">// 内部函数</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">GetMsgProc</span><span class="params">(<span class="type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">SaveListViewItemPositions</span><span class="params">(HWND hwndLV)</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">RestoreListViewItemPositions</span><span class="params">(HWND hwndLV)</span></span>;</span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            g_hMod = hModule;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">BOOL <span class="title">InstallHook</span><span class="params">(<span class="type">int</span> idHook, DWORD dwThreadId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!g_hHook) &#123;</span><br><span class="line">        g_hHook = <span class="built_in">SetWindowsHookEx</span>(idHook, GetMsgProc, g_hMod, dwThreadId);</span><br><span class="line">        <span class="keyword">if</span> (!g_hHook)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 消息钩子已经安装，通知资源管理器线程调用GetMsgProc钩子函数(为了及时响应所以主动通知)</span></span><br><span class="line">    <span class="built_in">PostThreadMessage</span>(dwThreadId, WM_NULL, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">UninstallHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_hHook)</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">UnhookWindowsHookEx</span>(g_hHook))</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    g_hHook = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 内部函数</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">GetMsgProc</span><span class="params">(<span class="type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// dll是否是刚被注入</span></span><br><span class="line">    <span class="type">static</span> BOOL bFirst = TRUE;</span><br><span class="line">    <span class="keyword">if</span> (nCode &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CallNextHookEx</span>(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line">    <span class="keyword">if</span> (nCode == HC_ACTION)</span><br><span class="line">        <span class="keyword">if</span> (bFirst) &#123;</span><br><span class="line">            bFirst = FALSE;</span><br><span class="line">            <span class="comment">// 在资源管理器进程中创建一个服务器窗口来处理控制程序的请求(保存、恢复桌面图标等)</span></span><br><span class="line">            <span class="built_in">CreateDialogParam</span>(g_hMod, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CallNextHookEx</span>(<span class="literal">NULL</span>, nCode, wParam, lParam);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_APP: &#123;</span><br><span class="line">            <span class="keyword">if</span> (lParam)</span><br><span class="line">                <span class="built_in">SaveListViewItemPositions</span>((HWND)wParam);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">RestoreListViewItemPositions</span>((HWND)wParam);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_CLOSE: &#123;</span><br><span class="line">            <span class="built_in">DestroyWindow</span>(hwndDlg);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">SaveListViewItemPositions</span><span class="params">(HWND hwndLV)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> nCount;</span><br><span class="line">    HKEY hKey;</span><br><span class="line">    LVITEM lvi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    POINT pt;</span><br><span class="line">    <span class="comment">// 先删除旧注册表</span></span><br><span class="line">    <span class="built_in">RegDeleteKey</span>(HKEY_CURRENT_USER, g_szRegSubKey);</span><br><span class="line">    <span class="comment">// 获取桌面列表项总数</span></span><br><span class="line">    nCount = <span class="built_in">SendMessage</span>(hwndLV, LVM_GETITEMCOUNT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 创建子键HKEY_CURRENT_USER\Software\Desktop Item Position Saver</span></span><br><span class="line">    <span class="built_in">RegCreateKeyEx</span>(HKEY_CURRENT_USER, g_szRegSubKey, <span class="number">0</span>, <span class="literal">NULL</span>, REG_OPTION_NON_VOLATILE, KEY_SET_VALUE, <span class="literal">NULL</span>, &amp;hKey, <span class="literal">NULL</span>);</span><br><span class="line">    lvi.mask = LVIF_TEXT;</span><br><span class="line">    lvi.pszText = szName;</span><br><span class="line">    lvi.cchTextMax = _countof(szName);</span><br><span class="line">    <span class="comment">// 为每个列表项创建一个键值项，以列表项的文本为键名，以列表项的位置为键值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nCount; i++) &#123;</span><br><span class="line">        <span class="built_in">ZeroMemory</span>(szName, _countof(szName) * <span class="built_in">sizeof</span>(TCHAR));</span><br><span class="line">        <span class="built_in">SendMessage</span>(hwndLV, LVM_GETITEMTEXT, i, (LPARAM)&amp;lvi);</span><br><span class="line">        <span class="built_in">SendMessage</span>(hwndLV, LVM_GETITEMPOSITION, i, (LPARAM)&amp;pt);</span><br><span class="line">        <span class="built_in">RegSetValueEx</span>(hKey, szName, <span class="number">0</span>, REG_BINARY, (LPBYTE)&amp;pt, <span class="built_in">sizeof</span>(pt));</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">RestoreListViewItemPositions</span><span class="params">(HWND hwndLV)</span> </span>&#123;</span><br><span class="line">    HKEY hKey;</span><br><span class="line">    TCHAR szName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    POINT pt;</span><br><span class="line">    DWORD dwType;</span><br><span class="line">    LONG_PTR lStyle;</span><br><span class="line">    LONG lResult;</span><br><span class="line">    LVFINDINFO lvfi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">int</span> nItem;</span><br><span class="line">    <span class="comment">// 打开子键HKEY_CURRENT_USER\Software\Desktop Item Position Saver</span></span><br><span class="line">    <span class="built_in">RegOpenKeyEx</span>(HKEY_CURRENT_USER, g_szRegSubKey, <span class="number">0</span>, KEY_QUERY_VALUE, &amp;hKey);</span><br><span class="line">    <span class="comment">// 关闭桌面图标自动排列</span></span><br><span class="line">    lStyle = <span class="built_in">GetWindowLongPtr</span>(hwndLV, GWL_STYLE);</span><br><span class="line">    <span class="keyword">if</span> (lStyle &amp; LVS_AUTOARRANGE)</span><br><span class="line">        <span class="built_in">SetWindowLongPtr</span>(hwndLV, GWL_STYLE, lStyle &amp; ~LVS_AUTOARRANGE);</span><br><span class="line">    <span class="comment">// 枚举子键HKEY_CURRENT_USER\Software\Desktop Item Position Saver下的所有键值项</span></span><br><span class="line">    lResult = ERROR_SUCCESS;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; lResult != ERROR_NO_MORE_ITEMS; i++) &#123;</span><br><span class="line">        DWORD dwchName = _countof(szName);</span><br><span class="line">        DWORD dwcbDaata = <span class="built_in">sizeof</span>(pt);</span><br><span class="line">        lResult = <span class="built_in">RegEnumValue</span>(hKey, i, szName, &amp;dwchName, <span class="literal">NULL</span>, &amp;dwType, (LPBYTE)&amp;pt, &amp;dwcbDaata);</span><br><span class="line">        <span class="keyword">if</span> (lResult == ERROR_NO_MORE_ITEMS)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// 查找桌面上具有指定列表项文本的列表项，重新设置该列表项的位置</span></span><br><span class="line">        lvfi.flags = LVFI_STRING;</span><br><span class="line">        lvfi.psz = szName;</span><br><span class="line">        <span class="keyword">if</span> ((dwType == REG_BINARY) &amp;&amp; (dwcbDaata == <span class="built_in">sizeof</span>(pt))) &#123;</span><br><span class="line">            nItem = <span class="built_in">SendMessage</span>(hwndLV, LVM_FINDITEM, <span class="number">-1</span>, (LPARAM)&amp;lvfi);</span><br><span class="line">            <span class="keyword">if</span> (nItem != <span class="number">-1</span>)</span><br><span class="line">                <span class="built_in">SendMessage</span>(hwndLV, LVM_SETITEMPOSITION, nItem, <span class="built_in">MAKELPARAM</span>(pt.x, pt.y));</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">SetWindowLongPtr</span>(hwndLV, GWL_STYLE, lStyle);</span><br><span class="line">    <span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制程序：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DIPSHookDll.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;DIPSHookDll.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> HWND hwndLV;</span><br><span class="line">    HWND hwndDIPSServer;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            hwndLV = <span class="built_in">GetTopWindow</span>(<span class="built_in">GetTopWindow</span>(<span class="built_in">FindWindow</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ProgMan&quot;</span>), <span class="literal">NULL</span>)));</span><br><span class="line">            <span class="comment">// 禁用保存桌面图标、恢复桌面图标和卸载消息钩子按钮</span></span><br><span class="line">            <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_SAVE), FALSE);</span><br><span class="line">            <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_RESTORE), FALSE);</span><br><span class="line">            <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_UNINSTALLHOOK), FALSE);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_INSTALLHOOK: &#123;</span><br><span class="line">                    <span class="built_in">InstallHook</span>(WH_GETMESSAGE, <span class="built_in">GetWindowThreadProcessId</span>(hwndLV, <span class="literal">NULL</span>));</span><br><span class="line">                    <span class="comment">// 启用保存桌面图标、恢复桌面图标和卸载消息钩子按钮</span></span><br><span class="line">                    <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_SAVE), TRUE);</span><br><span class="line">                    <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_RESTORE), TRUE);</span><br><span class="line">                    <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_UNINSTALLHOOK), TRUE);</span><br><span class="line">                    <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;安装消息钩子成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功&quot;</span>), MB_OK);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_UNINSTALLHOOK: &#123;</span><br><span class="line">                    <span class="comment">// 获取服务器窗口句柄</span></span><br><span class="line">                    hwndDIPSServer = <span class="built_in">FindWindow</span>(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;DIPSServer&quot;</span>));</span><br><span class="line">                    <span class="comment">// 使用SendMessage而不是PostMessage，确保钩子卸载以前，服务器对话框已经销毁</span></span><br><span class="line">                    <span class="built_in">SendMessage</span>(hwndDIPSServer, WM_CLOSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">UninstallHook</span>();</span><br><span class="line">                    <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_SAVE), FALSE);</span><br><span class="line">                    <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_RESTORE), FALSE);</span><br><span class="line">                    <span class="built_in">EnableWindow</span>(<span class="built_in">GetDlgItem</span>(hwndDlg, IDC_BTN_UNINSTALLHOOK), FALSE);</span><br><span class="line">                    <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;卸载消息钩子成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功&quot;</span>), MB_OK);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_SAVE: &#123;</span><br><span class="line">                    <span class="comment">// 获取服务器窗口句柄</span></span><br><span class="line">                    hwndDIPSServer = <span class="built_in">FindWindow</span>(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;DIPSServer&quot;</span>));</span><br><span class="line">                    <span class="built_in">SendMessage</span>(hwndDIPSServer, WM_APP, (WPARAM)hwndLV, TRUE);</span><br><span class="line">                    <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;保存桌面图标成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功&quot;</span>), MB_OK);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_RESTORE: &#123;</span><br><span class="line">                    <span class="comment">// 获取服务器窗口句柄</span></span><br><span class="line">                    hwndDIPSServer = <span class="built_in">FindWindow</span>(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;DIPSServer&quot;</span>));</span><br><span class="line">                    <span class="built_in">SendMessage</span>(hwndDIPSServer, WM_APP, (WPARAM)hwndLV, FALSE);</span><br><span class="line">                    <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;恢复桌面图标成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;成功&quot;</span>), MB_OK);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">FindWindow</span>(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;DIPSServer&quot;</span>)))</span><br><span class="line">                        <span class="built_in">SendMessage</span>(hwndDlg, WM_COMMAND, IDC_BTN_UNINSTALLHOOK, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="远程线程注入"><a href="#远程线程注入" class="headerlink" title="远程线程注入"></a>远程线程注入</h3><p>用<code>CreateRemoteThread</code>在目标进程中创建远程线程，但麻烦的是lpStartAddress线程函数也必须在目标进程地址空间中。我们无法将可执行代码等直接写入目标进程地址空间，获取API函数因ASLR也异常麻烦。但Kernel32.dll、User32.dll和Gdi32.dll等常用DLL在不同进程中被载入相同内存地址，但每次开机加载地址会变一次。</p>
<p>方法就是直接拿<code>CreateRemoteThread</code>启动<code>LoadLibraryA</code>&#x2F;<code>LoadLibraryW</code>，字符串参数用<code>VirtualAllocEx</code>在目标进程分配内存地址，用<code>WriteProcessMemory</code>写入DLL文件名称。</p>
<p>DLL源文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    TCHAR szBuf[MAX_PATH] = &#123; <span class="number">0</span> &#125;;          <span class="comment">// 模块名称</span></span><br><span class="line">    LPBYTE lpAddress = <span class="literal">NULL</span>;                <span class="comment">// 页面区域的起始地址</span></span><br><span class="line">    MEMORY_BASIC_INFORMATION mbi = &#123; <span class="number">0</span> &#125;;   <span class="comment">// 返回页面信息</span></span><br><span class="line">    <span class="type">int</span> nLen;</span><br><span class="line">    TCHAR szModName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    HWND hwndRemoteApp;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            <span class="comment">// RemoteApp的窗口句柄</span></span><br><span class="line">            hwndRemoteApp = <span class="built_in">FindWindow</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;#32770&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;RemoteApp&quot;</span>));</span><br><span class="line">            <span class="keyword">while</span> (<span class="built_in">VirtualQuery</span>(lpAddress, &amp;mbi, <span class="built_in">sizeof</span>(mbi)) == <span class="built_in">sizeof</span>(mbi)) &#123;</span><br><span class="line">                <span class="comment">// 页面区域中页面的状态为MEM_FREE空闲</span></span><br><span class="line">                <span class="keyword">if</span> (mbi.State == MEM_FREE)</span><br><span class="line">                    mbi.AllocationBase = mbi.BaseAddress;</span><br><span class="line">                <span class="keyword">if</span> ((mbi.AllocationBase == <span class="literal">NULL</span>) || (mbi.AllocationBase == hModule) || (mbi.BaseAddress != mbi.AllocationBase))</span><br><span class="line">                    <span class="comment">// 如果空间区域的基地址为NULL，或者空间区域的基地址是本模块基地址，或者页面区域的基地址并不是空间区域的基地址(每一个模块就是一块空间区域)，则不要将模块名称添加到列表中</span></span><br><span class="line">                    nLen = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// 获取加载到空间区域基地址处的模块文件名</span></span><br><span class="line">                    nLen = <span class="built_in">GetModuleFileName</span>(<span class="built_in">HMODULE</span>(mbi.AllocationBase), szModName, _countof(szModName));</span><br><span class="line">                <span class="keyword">if</span> (nLen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">wsprintf</span>(szBuf, <span class="built_in">TEXT</span>(<span class="string">&quot;%p\t%s\r\n&quot;</span>), mbi.AllocationBase, szModName);</span><br><span class="line">                    <span class="comment">// 模块名称显示到RemoteApp的编辑控件中</span></span><br><span class="line">                    <span class="built_in">SendDlgItemMessage</span>(hwndRemoteApp, <span class="number">1005</span>, EM_SETSEL, <span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">                    <span class="built_in">SendDlgItemMessage</span>(hwndRemoteApp, <span class="number">1005</span>, EM_REPLACESEL, TRUE, (LPARAM)szBuf);</span><br><span class="line">                &#125;;</span><br><span class="line">                lpAddress += mbi.RegionSize;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制程序：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HWND g_hwndDlg;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">(DWORD dwProcessId, LPTSTR lpDllPath)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">EjectDll</span><span class="params">(DWORD dwProcessId, LPTSTR lpDllPath)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwProcessId;</span><br><span class="line">    TCHAR szDllPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_PROCESSID, <span class="built_in">TEXT</span>(<span class="string">&quot;请输入进程ID&quot;</span>));</span><br><span class="line">            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_DLLPATH, <span class="built_in">TEXT</span>(<span class="string">&quot;F:\\Source\\Windows\\Chapter16\\RemoteDll\\Debug\\RemoteDll.dll&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_INJECT: &#123;</span><br><span class="line">                    <span class="comment">// 创建新线程完成对目标进程中dll的注入</span></span><br><span class="line">                    hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                    <span class="keyword">if</span> (hThread)</span><br><span class="line">                        <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_EJECT: &#123;</span><br><span class="line">                    dwProcessId = <span class="built_in">GetDlgItemInt</span>(hwndDlg, IDC_EDIT_PROCESSID, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">                    <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_DLLPATH, szDllPath, _countof(szDllPath));</span><br><span class="line">                    <span class="built_in">EjectDll</span>(dwProcessId, szDllPath);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">SendMessage</span>(hwndDlg, WM_COMMAND, IDC_BTN_EJECT, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span> </span>&#123;</span><br><span class="line">    DWORD dwProcessId;</span><br><span class="line">    TCHAR szDllPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    dwProcessId = <span class="built_in">GetDlgItemInt</span>(g_hwndDlg, IDC_EDIT_PROCESSID, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">    <span class="built_in">GetDlgItemText</span>(g_hwndDlg, IDC_EDIT_DLLPATH, szDllPath, _countof(szDllPath));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">InjectDll</span>(dwProcessId, szDllPath);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">(DWORD dwProcessId, LPTSTR lpDllPath)</span> </span>&#123;</span><br><span class="line">    HANDLE hProcess = <span class="literal">NULL</span>;</span><br><span class="line">    LPTSTR lpDllPathRemote = <span class="literal">NULL</span>;</span><br><span class="line">    HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">    hProcess = <span class="built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION | PROCESS_CREATE_THREAD | PROCESS_VM_OPERATION | PROCESS_VM_WRITE, FALSE, dwProcessId);</span><br><span class="line">    <span class="keyword">if</span> (!hProcess)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (1)    调用VirtualAllocEx函数在远程进程的地址空间中分配一块内存；</span></span><br><span class="line">    <span class="type">int</span> cbDllPath = (_tcslen(lpDllPath) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR);</span><br><span class="line">    lpDllPathRemote = (LPTSTR)<span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, cbDllPath, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (!lpDllPathRemote)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (2)    调用WriteProcessMemory函数把要注入的dll的路径复制到第1步分配的内存中；</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteProcessMemory</span>(hProcess, lpDllPathRemote, lpDllPath, cbDllPath, <span class="literal">NULL</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (3)    调用GetProcAddress函数得到LoadLibraryA / LoadLibraryW函数(Kernel32.dll)的实际地址；</span></span><br><span class="line">    PTHREAD_START_ROUTINE pfnThreadRtn = (PTHREAD_START_ROUTINE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32&quot;</span>)), <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pfnThreadRtn)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (4)    调用CreateRemoteThread函数在远程进程中创建一个线程</span></span><br><span class="line">    hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, pfnThreadRtn, lpDllPathRemote, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hThread)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">    <span class="comment">// (5)    调用VirtualFreeEx函数释放第1步分配的内存；</span></span><br><span class="line">    <span class="keyword">if</span> (!lpDllPathRemote)</span><br><span class="line">        <span class="built_in">VirtualFreeEx</span>(hProcess, lpDllPathRemote, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="keyword">if</span> (hThread)</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">    <span class="keyword">if</span> (hProcess)</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">EjectDll</span><span class="params">(DWORD dwProcessId, LPTSTR lpDllPath)</span> </span>&#123;</span><br><span class="line">    HANDLE hSnapshot;</span><br><span class="line">    MODULEENTRY32 me = &#123; <span class="built_in">sizeof</span>(MODULEENTRY32) &#125;;</span><br><span class="line">    BOOL bRet;</span><br><span class="line">    BOOL bFound = FALSE;</span><br><span class="line">    HANDLE hProcess = <span class="literal">NULL</span>;</span><br><span class="line">    HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">    hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPMODULE, dwProcessId);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    bRet = <span class="built_in">Module32First</span>(hSnapshot, &amp;me);</span><br><span class="line">    <span class="keyword">while</span> (bRet) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_tcsicmp(<span class="built_in">TEXT</span>(<span class="string">&quot;RemoteDll.dll&quot;</span>), me.szModule) == <span class="number">0</span> || _tcsicmp(lpDllPath, me.szExePath) == <span class="number">0</span>) &#123;</span><br><span class="line">            bFound = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        bRet = <span class="built_in">Module32Next</span>(hSnapshot, &amp;me);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!bFound)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    hProcess = <span class="built_in">OpenProcess</span>(PROCESS_QUERY_INFORMATION | PROCESS_CREATE_THREAD | PROCESS_VM_OPERATION, FALSE, dwProcessId);</span><br><span class="line">    <span class="keyword">if</span> (!hProcess)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (6)    调用GetProcAddress得到FreeLibrary函数(Kernel32.dll)的实际地址；</span></span><br><span class="line">    PTHREAD_START_ROUTINE pfnThreadRtn = (PTHREAD_START_ROUTINE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32&quot;</span>)), <span class="string">&quot;FreeLibrary&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pfnThreadRtn)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (7)    调用CreateRemoteThread函数在远程进程中创建一个新线程，</span></span><br><span class="line">    <span class="comment">// 让该线程调用FreeLibrary函数并在参数中传入已注入dll的模块地址以卸载该dll</span></span><br><span class="line">    hThread = <span class="built_in">CreateRemoteThread</span>(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, pfnThreadRtn, me.modBaseAddr, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hThread)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThread, INFINITE);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot != INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">    <span class="keyword">if</span> (hThread)</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">    <span class="keyword">if</span> (hProcess)</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="函数转发机制注入"><a href="#函数转发机制注入" class="headerlink" title="函数转发机制注入"></a>函数转发机制注入</h3><p>如kernel32.dll有许多转发函数，用VS Developer Command Prompt：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">dumpbin -exports kernel32.dll</span><br><span class="line">Microsoft (R) COFF/PE Dumper Version 14.39.33523.0</span><br><span class="line">Copyright (C) Microsoft Corporation.  All rights reserved.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Dump of file kernel32.dll</span><br><span class="line"></span><br><span class="line">File Type: DLL</span><br><span class="line"></span><br><span class="line">  Section contains the following exports <span class="keyword">for</span> KERNEL32.dll</span><br><span class="line"></span><br><span class="line">    00000000 characteristics</span><br><span class="line">    2EE8ABD0 time <span class="built_in">date</span> stamp</span><br><span class="line">        0.00 version</span><br><span class="line">           1 ordinal base</span><br><span class="line">        1671 number of <span class="built_in">functions</span></span><br><span class="line">        1671 number of names</span><br><span class="line"></span><br><span class="line">    ordinal hint RVA      name</span><br><span class="line"></span><br><span class="line">          1    0          AcquireSRWLockExclusive (forwarded to NTDLL.RtlAcquireSRWLockExclusive)</span><br><span class="line">          2    1          AcquireSRWLockShared (forwarded to NTDLL.RtlAcquireSRWLockShared)</span><br><span class="line">          3    2 000187B0 ActivateActCtx</span><br><span class="line">          4    3 00014620 ActivateActCtxWorker</span><br><span class="line">          5    4 00020FA0 ActivatePackageVirtualizationContext</span><br></pre></td></tr></table></figure>

<p>如前2个函数没有RVA，因为kernel32.dll中根本没有转发函数的实现，调用时直接转发到NTDLL.DLL对应函数中。实现具有函数转发器功能的DLL可以：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/export:被转发函数=某模块.目标函数&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>函数转发代码用AheadLib批量生成。例如一个单纯的函数转发器：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/export:MyMessageBox=User32.MessageBoxW&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>调用程序：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HMODULE hFunctionForwarder = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span><span class="params">(WINAPI* pfnMyMessageBox)</span><span class="params">(HWND hWnd, LPCTSTR lpText, LPCTSTR lpCaption, UINT uType)</span></span>;</span><br><span class="line">    pfnMyMessageBox pMyMessageBox = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_MYMESSAGEBOX: &#123;</span><br><span class="line">                    hFunctionForwarder = <span class="built_in">LoadLibrary</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FunctionForwarderDll.dll&quot;</span>));</span><br><span class="line">                    <span class="keyword">if</span> (hFunctionForwarder) &#123;</span><br><span class="line">                        pMyMessageBox = (pfnMyMessageBox)<span class="built_in">GetProcAddress</span>(hFunctionForwarder, <span class="string">&quot;MyMessageBox&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (pMyMessageBox)</span><br><span class="line">                            <span class="built_in">pMyMessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;MyMessageBox&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">                        <span class="built_in">FreeLibrary</span>(hFunctionForwarder);</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>假如某个程序调用SomeDLL.dll，那么我们利用函数转发搞一个新的SomeDLL.dll，旧的更名为SomeDLLReplace.dll，然后不需要拦截的直接从SomeDLL.dll转发到SomeDLLReplace.dll中。</p>
<p>实例：DrawDll.dll中导出一个绘制矩形和绘制椭圆的函数，然后DrawDll2.dll更名为DrawDll.dll并替换，实际链接新的DrawDllReplace.dll，实施DLL劫持，可执行程序DrawApp对DrawDll.dll调用时矩形函数画椭圆，椭圆函数画矩形。</p>
<p>DrawDll.h：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API VOID <span class="title">DrawRectangle</span><span class="params">(HWND hwnd)</span></span>;</span><br><span class="line"><span class="function">DLL_API VOID <span class="title">DrawEllipse</span><span class="params">(HWND hwnd)</span></span>;</span><br></pre></td></tr></table></figure>

<p>DrawDll.cpp：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DrawDll.h&quot;</span></span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">VOID <span class="title">DrawRectangle</span><span class="params">(HWND hwnd)</span> </span>&#123;</span><br><span class="line">    HDC hdc;</span><br><span class="line">    hdc = <span class="built_in">GetDC</span>(hwnd);</span><br><span class="line">    <span class="built_in">Rectangle</span>(hdc, <span class="number">10</span>, <span class="number">10</span>, <span class="number">110</span>, <span class="number">110</span>);</span><br><span class="line">    <span class="built_in">ReleaseDC</span>(hwnd, hdc);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">DrawEllipse</span><span class="params">(HWND hwnd)</span> </span>&#123;</span><br><span class="line">    HDC hdc;</span><br><span class="line">    hdc = <span class="built_in">GetDC</span>(hwnd);</span><br><span class="line">    <span class="built_in">Ellipse</span>(hdc, <span class="number">10</span>, <span class="number">10</span>, <span class="number">110</span>, <span class="number">110</span>);</span><br><span class="line">    <span class="built_in">ReleaseDC</span>(hwnd, hdc);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>DrawDll2.cpp：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/export:DrawRectangle=DrawDllReplace.DrawRectangle&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker, <span class="string">&quot;/export:DrawEllipse=DrawDllReplace.DrawEllipse&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>DrawDllReplace.h：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// 声明导出的函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllexport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_API       extern <span class="string">&quot;C&quot;</span> __declspec(dllimport)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">DLL_API VOID <span class="title">DrawRectangle</span><span class="params">(HWND hwnd)</span></span>;</span><br><span class="line"><span class="function">DLL_API VOID <span class="title">DrawEllipse</span><span class="params">(HWND hwnd)</span></span>;</span><br></pre></td></tr></table></figure>

<p>DrawDllReplace.cpp：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义DLL的导出函数</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DLL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DrawDllReplace.h&quot;</span></span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 导出函数</span></span><br><span class="line"><span class="function">VOID <span class="title">DrawRectangle</span><span class="params">(HWND hwnd)</span> </span>&#123;</span><br><span class="line">    HDC hdc;</span><br><span class="line">    hdc = <span class="built_in">GetDC</span>(hwnd);</span><br><span class="line">    <span class="built_in">Ellipse</span>(hdc, <span class="number">10</span>, <span class="number">10</span>, <span class="number">110</span>, <span class="number">110</span>);</span><br><span class="line">    <span class="built_in">ReleaseDC</span>(hwnd, hdc);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">DrawEllipse</span><span class="params">(HWND hwnd)</span> </span>&#123;</span><br><span class="line">    HDC hdc;</span><br><span class="line">    hdc = <span class="built_in">GetDC</span>(hwnd);</span><br><span class="line">    <span class="built_in">Rectangle</span>(hdc, <span class="number">10</span>, <span class="number">10</span>, <span class="number">110</span>, <span class="number">110</span>);</span><br><span class="line">    <span class="built_in">ReleaseDC</span>(hwnd, hdc);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>DrawApp.cpp：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DrawDll.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;DrawDll.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> BOOL bFirst = TRUE;</span><br><span class="line">    <span class="type">static</span> BOOL bRect;</span><br><span class="line">    HDC hdc;</span><br><span class="line">    PAINTSTRUCT ps;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_DRAWRECT: &#123;</span><br><span class="line">                    bFirst = FALSE;</span><br><span class="line">                    bRect = TRUE;</span><br><span class="line">                    <span class="built_in">InvalidateRect</span>(hwndDlg, <span class="literal">NULL</span>, TRUE);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_DRAWELLIPSE: &#123;</span><br><span class="line">                    bFirst = FALSE;</span><br><span class="line">                    bRect = FALSE;</span><br><span class="line">                    <span class="built_in">InvalidateRect</span>(hwndDlg, <span class="literal">NULL</span>, TRUE);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_PAINT: &#123;</span><br><span class="line">            hdc = <span class="built_in">BeginPaint</span>(hwndDlg, &amp;ps);</span><br><span class="line">            <span class="keyword">if</span> (!bFirst) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bRect)</span><br><span class="line">                    <span class="built_in">DrawRectangle</span>(hwndDlg);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">DrawEllipse</span>(hwndDlg);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="built_in">EndPaint</span>(hwndDlg, &amp;ps);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="CreateProcess写ShellCode注入"><a href="#CreateProcess写ShellCode注入" class="headerlink" title="CreateProcess写ShellCode注入"></a>CreateProcess写ShellCode注入</h3><p>用<code>CreateProcess</code>以挂起模式创建一个子进程，在子进程主线程运行前可项子进程地址空间注入ShellCode并率先获得执行权，ShellCode执行完成再转去执行主线程原代码。</p>
<p>以下代码ShellCode中最后部分需要根据实际更改。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">CreateProcessAndInjectDll</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_CREATE: &#123;</span><br><span class="line">                    <span class="built_in">CreateProcessAndInjectDll</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">CreateProcessAndInjectDll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR szExePath[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;ThreeThousandYears.exe&quot;</span>);</span><br><span class="line">    TCHAR szDllPath[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;MessageBoxDll.dll&quot;</span>);</span><br><span class="line">    BOOL bRet;</span><br><span class="line">    <span class="comment">// 29字节的机器指令和MAX_PATH * sizeof(TCHAR)字节的要注入的dll的名称</span></span><br><span class="line">    BYTE ShellCode[<span class="number">29</span> + <span class="function">MAX_PATH * <span class="title">sizeof</span><span class="params">(TCHAR)</span>] </span>= &#123;</span><br><span class="line">        <span class="number">0x60</span>,                           <span class="comment">// pushad</span></span><br><span class="line">        <span class="number">0x9C</span>,                           <span class="comment">// pushfd</span></span><br><span class="line">        <span class="number">0x68</span>,<span class="number">0xAA</span>,<span class="number">0xBB</span>,<span class="number">0xCC</span>,<span class="number">0xDD</span>,       <span class="comment">// push [0xDDCCBBAA](0xDDCCBBAA是目标进程中要注入的dll的名称)</span></span><br><span class="line">        <span class="number">0xFF</span>,<span class="number">0x15</span>,<span class="number">0xDD</span>,<span class="number">0xCC</span>,<span class="number">0xBB</span>,<span class="number">0xAA</span>,  <span class="comment">// call [0xDDCCBBAA](0xDDCCBBAA是LoadLibraryW函数的地址)</span></span><br><span class="line">        <span class="number">0x9D</span>,                           <span class="comment">// popfd</span></span><br><span class="line">        <span class="number">0x61</span>,                           <span class="comment">// popad</span></span><br><span class="line">        <span class="number">0xFF</span>,<span class="number">0x25</span>,<span class="number">0xAA</span>,<span class="number">0xBB</span>,<span class="number">0xCC</span>,<span class="number">0xDD</span>,  <span class="comment">// jmp [0xDDCCBBAA](0xDDCCBBAA为目标进程原入口点)</span></span><br><span class="line">        <span class="number">0xAA</span>,<span class="number">0xAA</span>,<span class="number">0xAA</span>,<span class="number">0xAA</span>,            <span class="comment">// 保存loadlibraryW函数地址的4字节数据区域</span></span><br><span class="line">        <span class="number">0xAA</span>,<span class="number">0xAA</span>,<span class="number">0xAA</span>,<span class="number">0xAA</span>,            <span class="comment">// 保存目标进程原入口点地址的4字节数据区域</span></span><br><span class="line">        <span class="number">0</span>,                              <span class="comment">// 往后开始就是存放要注入的dll名称的数据区域</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 以挂起模式创建一个进程</span></span><br><span class="line">    bRet = <span class="built_in">CreateProcess</span>(szExePath, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line">    <span class="keyword">if</span> (!bRet)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 获取目标进程主线程环境(EIP)</span></span><br><span class="line">    CONTEXT context;</span><br><span class="line">    context.ContextFlags = CONTEXT_FULL;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">GetThreadContext</span>(pi.hThread, &amp;context))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 获得LoadLibraryW函数的地址</span></span><br><span class="line">    DWORD dwLoadLibraryWAddr = (DWORD)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dwLoadLibraryWAddr)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 在目标进程中分配内存，存放ShellCode</span></span><br><span class="line">    LPVOID lpMemoryRemote = <span class="built_in">VirtualAllocEx</span>(pi.hProcess, <span class="literal">NULL</span>, <span class="number">29</span> + MAX_PATH * <span class="built_in">sizeof</span>(TCHAR), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (!lpMemoryRemote)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// push [0xDDCCBBAA](0xDDCCBBAA是目标进程中要注入的dll的名称) 偏移ShellCode + 3</span></span><br><span class="line">    *(PDWORD)(ShellCode + <span class="number">3</span>) = (DWORD)lpMemoryRemote + <span class="number">29</span>;</span><br><span class="line">    <span class="comment">// call [0xDDCCBBAA](0xDDCCBBAA是LoadLibraryW函数的地址)      偏移ShellCode + 9</span></span><br><span class="line">    *(PDWORD)(ShellCode + <span class="number">9</span>) = (DWORD)lpMemoryRemote + <span class="number">21</span>;</span><br><span class="line">    <span class="comment">// jmp [0xDDCCBBAA](0xDDCCBBAA为目标进程原入口点)             偏移ShellCode + 17</span></span><br><span class="line">    *(PDWORD)(ShellCode + <span class="number">17</span>) = (DWORD)lpMemoryRemote + <span class="number">25</span>;</span><br><span class="line">    <span class="comment">// 保存loadlibraryW函数地址的4字节数据区域                    偏移ShellCode + 21</span></span><br><span class="line">    *(PDWORD)(ShellCode + <span class="number">21</span>) = dwLoadLibraryWAddr;</span><br><span class="line">    <span class="comment">// 保存目标进程原入口点地址的4字节数据区域                    偏移ShellCode + 25</span></span><br><span class="line">    *(PDWORD)(ShellCode + <span class="number">25</span>) = context.Eip;</span><br><span class="line">    <span class="comment">// 往后开始就是存放要注入的dll名称的数据区域                  偏移ShellCode + 29</span></span><br><span class="line">    <span class="built_in">memcpy_s</span>(ShellCode + <span class="number">29</span>, MAX_PATH * <span class="built_in">sizeof</span>(TCHAR), szDllPath, <span class="built_in">sizeof</span>(szDllPath));</span><br><span class="line">    <span class="comment">// 把shellcode写入目标进程</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpMemoryRemote, ShellCode, <span class="number">29</span> + MAX_PATH * <span class="built_in">sizeof</span>(TCHAR), <span class="literal">NULL</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 修改目标进程的EIP，执行被注入的代码</span></span><br><span class="line">    context.Eip = (DWORD)lpMemoryRemote;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">SetThreadContext</span>(pi.hThread, &amp;context))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 恢复目标进程的执行</span></span><br><span class="line">    <span class="built_in">ResumeThread</span>(pi.hThread);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">    <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="APC机制注入"><a href="#APC机制注入" class="headerlink" title="APC机制注入"></a>APC机制注入</h3><p>Windows为每个线程维护一个APC队列，类似于远程线程注入，用<code>QueueUserAPC</code>把APC回调函数设为<code>LoadLibraryA</code>&#x2F;<code>LoadLibraryW</code>地址。因为不知道目标进程中哪些线程处于可通知等待状态，为确保成功需要向目标进程每个线程都注入APC。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;TlHelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HWND g_hwndDlg;</span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">(DWORD dwProcessId, LPTSTR lpDllPath)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">EjectDll</span><span class="params">(DWORD dwProcessId, LPTSTR lpDllPath)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwProcessId;</span><br><span class="line">    TCHAR szDllPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_PROCESSID, <span class="built_in">TEXT</span>(<span class="string">&quot;请输入进程ID&quot;</span>));</span><br><span class="line">            <span class="built_in">SetDlgItemText</span>(hwndDlg, IDC_EDIT_DLLPATH, <span class="built_in">TEXT</span>(<span class="string">&quot;F:\\Source\\Windows\\Chapter16\\RemoteDll2\\Debug\\RemoteDll.dll&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_INJECT: &#123;</span><br><span class="line">                    <span class="comment">// 创建新线程完成对目标进程中dll的注入</span></span><br><span class="line">                    hThread = <span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">                    <span class="keyword">if</span> (hThread)</span><br><span class="line">                        <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_EJECT: &#123;</span><br><span class="line">                    dwProcessId = <span class="built_in">GetDlgItemInt</span>(hwndDlg, IDC_EDIT_PROCESSID, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">                    <span class="built_in">GetDlgItemText</span>(hwndDlg, IDC_EDIT_DLLPATH, szDllPath, _countof(szDllPath));</span><br><span class="line">                    <span class="built_in">EjectDll</span>(dwProcessId, szDllPath);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">SendMessage</span>(hwndDlg, WM_COMMAND, IDC_BTN_EJECT, <span class="number">0</span>);</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(LPVOID lpParameter)</span> </span>&#123;</span><br><span class="line">    DWORD dwProcessId;</span><br><span class="line">    TCHAR szDllPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    dwProcessId = <span class="built_in">GetDlgItemInt</span>(g_hwndDlg, IDC_EDIT_PROCESSID, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">    <span class="built_in">GetDlgItemText</span>(g_hwndDlg, IDC_EDIT_DLLPATH, szDllPath, _countof(szDllPath));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">InjectDll</span>(dwProcessId, szDllPath);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">(DWORD dwProcessId, LPTSTR lpDllPath)</span> </span>&#123;</span><br><span class="line">    HANDLE hProcess = <span class="literal">NULL</span>;</span><br><span class="line">    LPTSTR lpDllPathRemote = <span class="literal">NULL</span>;</span><br><span class="line">    hProcess = <span class="built_in">OpenProcess</span>(PROCESS_VM_OPERATION | PROCESS_VM_WRITE, FALSE, dwProcessId);</span><br><span class="line">    <span class="keyword">if</span> (!hProcess)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (1)    调用VirtualAllocEx函数在远程进程的地址空间中分配一块内存；</span></span><br><span class="line">    SIZE_T cbDllPath = (_tcslen(lpDllPath) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR);</span><br><span class="line">    lpDllPathRemote = (LPTSTR)<span class="built_in">VirtualAllocEx</span>(hProcess, <span class="literal">NULL</span>, cbDllPath, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (!lpDllPathRemote)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (2)    调用WriteProcessMemory函数把要注入的dll的路径复制到第1步分配的内存中；</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteProcessMemory</span>(hProcess, lpDllPathRemote, lpDllPath, cbDllPath, <span class="literal">NULL</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (3)    调用GetProcAddress函数得到LoadLibraryA / LoadLibraryW函数(Kernel32.dll)的实际地址；</span></span><br><span class="line">    HMODULE hModule = <span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32&quot;</span>));</span><br><span class="line">    PAPCFUNC pfnAPC = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (hModule != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pfnAPC = (PAPCFUNC)<span class="built_in">GetProcAddress</span>(hModule, <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!pfnAPC)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// (4)    遍历目标进程中的线程</span></span><br><span class="line">    HANDLE hSnapshot = INVALID_HANDLE_VALUE;</span><br><span class="line">    THREADENTRY32 te = &#123; <span class="built_in">sizeof</span>(THREADENTRY32) &#125;;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">    hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPTHREAD, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    bRet = <span class="built_in">Thread32First</span>(hSnapshot, &amp;te);</span><br><span class="line">    <span class="keyword">while</span> (bRet) &#123;</span><br><span class="line">        <span class="keyword">if</span> (te.th32OwnerProcessID == dwProcessId) &#123;</span><br><span class="line">            hThread = <span class="built_in">OpenThread</span>(THREAD_SET_CONTEXT, FALSE, te.th32ThreadID);</span><br><span class="line">            <span class="keyword">if</span> (hThread) &#123;</span><br><span class="line">                <span class="built_in">QueueUserAPC</span>(pfnAPC, hThread, (ULONG_PTR)lpDllPathRemote);</span><br><span class="line">                <span class="comment">// 关闭线程句柄</span></span><br><span class="line">                <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">                hThread = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        bRet = <span class="built_in">Thread32Next</span>(hSnapshot, &amp;te);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">    <span class="comment">//// (5)    调用VirtualFreeEx函数释放第1步分配的内存；</span></span><br><span class="line">    <span class="comment">//if (!lpDllPathRemote)</span></span><br><span class="line">    <span class="comment">//    VirtualFreeEx(hProcess, lpDllPathRemote, 0, MEM_RELEASE);</span></span><br><span class="line">    <span class="keyword">if</span> (hProcess)</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hProcess);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 自定义函数EjectDll不保证卸载成功</span></span><br><span class="line"><span class="function">BOOL <span class="title">EjectDll</span><span class="params">(DWORD dwProcessId, LPTSTR lpDllPath)</span> </span>&#123;</span><br><span class="line">    HANDLE hSnapshot = INVALID_HANDLE_VALUE;</span><br><span class="line">    MODULEENTRY32 me = &#123; <span class="built_in">sizeof</span>(MODULEENTRY32) &#125;;</span><br><span class="line">    THREADENTRY32 te = &#123; <span class="built_in">sizeof</span>(THREADENTRY32) &#125;;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    BOOL bFound = FALSE;</span><br><span class="line">    <span class="comment">// 调用GetProcAddress函数得到FreeLibrary函数(Kernel32.dll)的实际地址</span></span><br><span class="line">    HMODULE hModule = <span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32&quot;</span>));</span><br><span class="line">    PAPCFUNC pfnAPC = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (hModule != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pfnAPC = (PAPCFUNC)<span class="built_in">GetProcAddress</span>(hModule, <span class="string">&quot;FreeLibrary&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!pfnAPC)</span><br><span class="line">            <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 获取目标进程中RemoteDll.dll的模块句柄</span></span><br><span class="line">    hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPMODULE, dwProcessId);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    bRet = <span class="built_in">Module32First</span>(hSnapshot, &amp;me);</span><br><span class="line">    <span class="keyword">while</span> (bRet) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_tcsicmp(<span class="built_in">TEXT</span>(<span class="string">&quot;RemoteDll.dll&quot;</span>), me.szModule) == <span class="number">0</span> || _tcsicmp(lpDllPath, me.szExePath) == <span class="number">0</span>) &#123;</span><br><span class="line">            bFound = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        bRet = <span class="built_in">Module32Next</span>(hSnapshot, &amp;me);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">    <span class="keyword">if</span> (!bFound)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// 遍历目标进程中的线程</span></span><br><span class="line">    hSnapshot = INVALID_HANDLE_VALUE;</span><br><span class="line">    bRet = FALSE;</span><br><span class="line">    HANDLE hThread = <span class="literal">NULL</span>;</span><br><span class="line">    hSnapshot = <span class="built_in">CreateToolhelp32Snapshot</span>(TH32CS_SNAPTHREAD, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    bRet = <span class="built_in">Thread32First</span>(hSnapshot, &amp;te);</span><br><span class="line">    <span class="keyword">while</span> (bRet) &#123;</span><br><span class="line">        <span class="keyword">if</span> (te.th32OwnerProcessID == dwProcessId) &#123;</span><br><span class="line">            hThread = <span class="built_in">OpenThread</span>(THREAD_SET_CONTEXT, FALSE, te.th32ThreadID);</span><br><span class="line">            <span class="keyword">if</span> (hThread) &#123;</span><br><span class="line">                <span class="built_in">QueueUserAPC</span>(pfnAPC, hThread, (ULONG_PTR)(me.modBaseAddr));</span><br><span class="line">                <span class="comment">// 关闭线程句柄</span></span><br><span class="line">                <span class="built_in">CloseHandle</span>(hThread);</span><br><span class="line">                hThread = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        bRet = <span class="built_in">Thread32Next</span>(hSnapshot, &amp;te);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hSnapshot);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="输入法机制注入"><a href="#输入法机制注入" class="headerlink" title="输入法机制注入"></a>输入法机制注入</h3><p>用户切换输入法时，输入法管理器加载所选择输入法对应的.ime文件到当前活动进程中，这实际上是个DLL。只需在该.ime文件<code>DllMain</code>函数的DLL_PROCESS_ATTACH中调用<code>LoadLibrary</code>加载被注入的DLL即可。</p>
<p>输入法.ime工程必须添加一个版本信息资源Version，其中FILETYPE为VFT_DRV，FILESUBTYPE为VFT2_DRV_INPUTMETHOD，其他信息无关紧要。还要在项目属性的目标文件扩展名改为.ime。</p>
<p>如果编译成32位在64位机器下跑时则要注意文件系统重定向问题，这时需要更改代码中系统目录。</p>
<p>输入法.ime文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> HANDLE  hFileMap;</span><br><span class="line">    <span class="type">static</span> LPVOID  lpMemory;</span><br><span class="line">    <span class="type">static</span> TCHAR   szInjectDllName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;        <span class="comment">// 注入dll完整路径</span></span><br><span class="line">    <span class="type">static</span> HMODULE hModuleInject;                            <span class="comment">// 注入dll模块句柄</span></span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            <span class="comment">// 打开命名文件映射内核对象，从内存映射文件中获取注入dll的完整路径</span></span><br><span class="line">            hFileMap = <span class="built_in">CreateFileMapping</span>(INVALID_HANDLE_VALUE, <span class="literal">NULL</span>, PAGE_READWRITE, <span class="number">0</span>, <span class="number">4096</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;DEAE59A6-F81B-4DC4-B375-68437206A1A4&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (!hFileMap)</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">            <span class="comment">// 把文件映射对象hFileMap的全部映射到进程的虚拟地址空间中</span></span><br><span class="line">            lpMemory = <span class="built_in">MapViewOfFile</span>(hFileMap, FILE_MAP_READ | FILE_MAP_WRITE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!lpMemory)</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">            <span class="comment">// 获取注入dll的完整路径</span></span><br><span class="line">            <span class="built_in">StringCchCopy</span>(szInjectDllName, _countof(szInjectDllName), (LPTSTR)lpMemory);</span><br><span class="line">            <span class="comment">// 加载注入dll</span></span><br><span class="line">            hModuleInject = <span class="built_in">LoadLibrary</span>(szInjectDllName);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="built_in">UnmapViewOfFile</span>(lpMemory);</span><br><span class="line">            <span class="built_in">CloseHandle</span>(hFileMap);</span><br><span class="line">            <span class="keyword">if</span> (hModuleInject)</span><br><span class="line">                <span class="built_in">FreeLibrary</span>(hModuleInject);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>要被注入的.dll：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            <span class="built_in">MessageBox</span>(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;我是通过输入法注入的dll&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>安装、卸载和清理输入法文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(linker,<span class="string">&quot;\&quot;/manifestdependency:type=&#x27;win32&#x27; name=&#x27;Microsoft.Windows.Common-Controls&#x27; version=&#x27;6.0.0.0&#x27; processorArchitecture=&#x27;*&#x27; publicKeyToken=&#x27;6595b64144ccf1df&#x27; language=&#x27;*&#x27;\&quot;&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Imm32.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">HWND  g_hwndDlg;</span><br><span class="line">HKL   g_hklDefault;     <span class="comment">// 原来的默认输入法的键盘布局句柄</span></span><br><span class="line">HKL   g_hklMy;          <span class="comment">// 自己的输入法的键盘布局句柄</span></span><br><span class="line">TCHAR g_szKLID[<span class="number">16</span>];     <span class="comment">// 自己的输入法的键盘布局句柄的字符串形式</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">InstallMyIME</span><span class="params">()</span></span>;    <span class="comment">// 安装输入法</span></span><br><span class="line"><span class="function">VOID <span class="title">UninstallMyIME</span><span class="params">()</span></span>;  <span class="comment">// 卸载输入法</span></span><br><span class="line"><span class="function">VOID <span class="title">ClearMyIME</span><span class="params">()</span></span>;      <span class="comment">// 清理输入法</span></span><br><span class="line"><span class="type">int</span> WINAPI _tWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow) &#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> HANDLE hFileMap;</span><br><span class="line">    <span class="type">static</span> LPVOID lpMemory;</span><br><span class="line">    TCHAR         szInjectDllName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;      <span class="comment">// 注入dll完整路径</span></span><br><span class="line">    LPTSTR        lpStr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            g_hwndDlg = hwndDlg;</span><br><span class="line">            <span class="comment">// 同目录下注入dll的完整路径</span></span><br><span class="line">            <span class="built_in">GetModuleFileName</span>(<span class="literal">NULL</span>, szInjectDllName, _countof(szInjectDllName));</span><br><span class="line">            <span class="keyword">if</span> (lpStr = _tcsrchr(szInjectDllName, <span class="built_in">TEXT</span>(<span class="string">&#x27;\\&#x27;</span>)))</span><br><span class="line">                <span class="built_in">StringCchCopy</span>(lpStr + <span class="number">1</span>, _tcslen(<span class="built_in">TEXT</span>(<span class="string">&quot;MyIMETestDll.dll&quot;</span>)) + <span class="number">1</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;MyIMETestDll.dll&quot;</span>));</span><br><span class="line">            <span class="comment">// 创建一个命名文件映射内核对象，4096字节，用于存放注入dll的完整路径</span></span><br><span class="line">            hFileMap = <span class="built_in">CreateFileMapping</span>(INVALID_HANDLE_VALUE, <span class="literal">NULL</span>, PAGE_READWRITE, <span class="number">0</span>, <span class="number">4096</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;DEAE59A6-F81B-4DC4-B375-68437206A1A4&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (!hFileMap) &#123;</span><br><span class="line">                <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;CreateFileMapping调用失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">                <span class="keyword">return</span> TRUE;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 把文件映射对象hFileMap的全部映射到进程的虚拟地址空间中</span></span><br><span class="line">            lpMemory = <span class="built_in">MapViewOfFile</span>(hFileMap, FILE_MAP_READ | FILE_MAP_WRITE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!lpMemory) &#123;</span><br><span class="line">                <span class="built_in">MessageBox</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;MapViewOfFile调用失败&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">                <span class="keyword">return</span> TRUE;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 复制注入dll的完整路径到内存映射文件</span></span><br><span class="line">            <span class="built_in">StringCchCopy</span>((LPTSTR)lpMemory, MAX_PATH, szInjectDllName);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_INJECT: &#123;</span><br><span class="line">                    <span class="built_in">InstallMyIME</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_EJECT: &#123;</span><br><span class="line">                    <span class="built_in">UninstallMyIME</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_CLEAR: &#123;</span><br><span class="line">                    <span class="built_in">ClearMyIME</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_CLOSE: &#123;</span><br><span class="line">            <span class="built_in">UnmapViewOfFile</span>(lpMemory);</span><br><span class="line">            <span class="built_in">CloseHandle</span>(hFileMap);</span><br><span class="line">            <span class="built_in">UninstallMyIME</span>();</span><br><span class="line">            <span class="built_in">ClearMyIME</span>();</span><br><span class="line">            <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">InstallMyIME</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 复制.ime文件到系统目录中</span></span><br><span class="line">    <span class="built_in">CopyFile</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;MyIME.ime&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;C:\\WINDOWS\\system32\\MyIME.ime&quot;</span>), FALSE);</span><br><span class="line">    <span class="comment">// 获取当前默认输入法的键盘布局句柄(句柄包括语言ID和物理布局ID)，通过全局变量g_hklDefault返回</span></span><br><span class="line">    <span class="built_in">SystemParametersInfo</span>(SPI_GETDEFAULTINPUTLANG, <span class="number">0</span>, &amp;g_hklDefault, FALSE);</span><br><span class="line">    <span class="comment">// 安装自己的输入法(我这里返回值为0xE0200804)</span></span><br><span class="line">    g_hklMy = <span class="built_in">ImmInstallIME</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;MyIME.ime&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;我的输入法&quot;</span>));</span><br><span class="line">    <span class="built_in">StringCchPrintf</span>(g_szKLID, _countof(g_szKLID), <span class="built_in">TEXT</span>(<span class="string">&quot;%08X&quot;</span>), (DWORD)g_hklMy);</span><br><span class="line">    <span class="comment">// 如果自己的输入法安装成功</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ImmIsIME</span>(g_hklMy)) &#123;</span><br><span class="line">        <span class="comment">// 加载自己的输入法到系统中</span></span><br><span class="line">        <span class="built_in">LoadKeyboardLayout</span>(g_szKLID, KLF_ACTIVATE);</span><br><span class="line">        <span class="comment">// LoadKeyboardLayout在调用进程没有具有键盘焦点的窗口时调用失败 保险起见投递一条WM_INPUTLANGCHANGEREQUEST消息到前台窗口(模拟用户选择新的输入法)</span></span><br><span class="line">        <span class="built_in">PostMessage</span>(<span class="built_in">GetForegroundWindow</span>(), WM_INPUTLANGCHANGEREQUEST, INPUTLANGCHANGE_SYSCHARSET, (LPARAM)g_hklMy);</span><br><span class="line">        <span class="comment">// 设置为默认输入法</span></span><br><span class="line">        <span class="built_in">SystemParametersInfo</span>(SPI_SETDEFAULTINPUTLANG, <span class="number">0</span>, &amp;g_hklMy, SPIF_SENDCHANGE);</span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;我的输入法已经设置为默认输入法&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">UninstallMyIME</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 先设置回原来的默认输入法</span></span><br><span class="line">    <span class="built_in">SystemParametersInfo</span>(SPI_SETDEFAULTINPUTLANG, <span class="number">0</span>, &amp;g_hklDefault, SPIF_SENDCHANGE);</span><br><span class="line">    <span class="comment">// 卸载自己的输入法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">UnloadKeyboardLayout</span>(g_hklMy))</span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;我的输入法已经卸载成功&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">ClearMyIME</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 删除HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Keyboard Layouts\E0200804子键</span></span><br><span class="line">    TCHAR szSubKey[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;SYSTEM\\CurrentControlSet\\Control\\Keyboard Layouts\\&quot;</span>);</span><br><span class="line">    <span class="built_in">StringCchCat</span>(szSubKey, _countof(szSubKey), g_szKLID);</span><br><span class="line">    <span class="built_in">RegDeleteKey</span>(HKEY_LOCAL_MACHINE, szSubKey);</span><br><span class="line">    <span class="comment">// 删除HKEY_CURRENT_USER\Keyboard Layout\Preload下面键值为&quot;E0200804&quot;的键值项</span></span><br><span class="line">    HKEY    hKey;</span><br><span class="line">    LPCTSTR lpSubKey = <span class="built_in">TEXT</span>(<span class="string">&quot;Keyboard Layout\\Preload&quot;</span>);</span><br><span class="line">    DWORD   dwIndex = <span class="number">0</span>;</span><br><span class="line">    TCHAR   szValueName[<span class="number">16</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD   dwchValueName;</span><br><span class="line">    TCHAR   szValueData[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    DWORD   dwcbValueData;</span><br><span class="line">    LONG    lRet;</span><br><span class="line">    <span class="built_in">RegOpenKeyEx</span>(HKEY_CURRENT_USER, lpSubKey, <span class="number">0</span>, KEY_READ | KEY_WRITE, &amp;hKey);</span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">        dwchValueName = _countof(szValueName);</span><br><span class="line">        dwcbValueData = <span class="built_in">sizeof</span>(szValueData);</span><br><span class="line">        lRet = <span class="built_in">RegEnumValue</span>(hKey, dwIndex, szValueName, &amp;dwchValueName, <span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPBYTE)szValueData, &amp;dwcbValueData);</span><br><span class="line">        <span class="keyword">if</span> (lRet == ERROR_NO_MORE_ITEMS)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (_tcsicmp(g_szKLID, szValueData) == <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">RegDeleteValue</span>(hKey, szValueName);</span><br><span class="line">        dwIndex++;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 删除输入法文件</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">DeleteFile</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;C:\\WINDOWS\\system32\\MyIME.ime&quot;</span>))) &#123;</span><br><span class="line">        <span class="comment">// 下次重新启动系统以后删除</span></span><br><span class="line">        <span class="built_in">MoveFileEx</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;C:\\WINDOWS\\system32\\MyIME.ime&quot;</span>), <span class="literal">NULL</span>, MOVEFILE_DELAY_UNTIL_REBOOT);</span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;我的输入法已清理完毕，重启后删除.ime文件&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">MessageBox</span>(g_hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;我的输入法已清理完毕&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;提示&quot;</span>), MB_OK);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Shadow-API"><a href="#Shadow-API" class="headerlink" title="Shadow API"></a>Shadow API</h2><p>Shadow API能过调试器对API下的断点。例如要过<code>MessageBox</code>时，Win10中该API的实现在USER32.DLL中，内容为直接调用<code>user32!MessageBoxTimeoutW</code>。选择用<code>VirtualAlloc</code>申请一块内存空间，把<code>MessageBoxW</code>的代码复制到其中，然后调用时直接调用该内存空间。但是其中汇编<code>call</code>指令二进制码需要进行修改，二进制下4字节为<code>MessageBoxTimeoutW</code>函数地址减<code>call MessageBoxTimeoutW</code>下一条指令地址，这里要修改的偏移为22。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(WINAPI* pfnMessageBoxW)</span><span class="params">(HWND hWnd, LPCWSTR lpText, LPCWSTR lpCaption, UINT uType)</span></span>;</span><br><span class="line">    pfnMessageBoxW pMessageBoxW = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">static</span> pfnMessageBoxW pMessageBoxWNew = <span class="literal">NULL</span>;   <span class="comment">// 分配内存空间存放MessageBoxW函数机器码</span></span><br><span class="line">    BYTE bArr[<span class="number">30</span>] = &#123; <span class="number">0</span> &#125;;                          <span class="comment">// 存放MessageBoxW函数实现代码的缓冲区</span></span><br><span class="line">    LPBYTE pMessageBoxTimeoutW = <span class="literal">NULL</span>;              <span class="comment">// MessageBoxTimeoutW函数的地址</span></span><br><span class="line">    DWORD dwReplace;                                <span class="comment">// MessageBoxTimeoutW函数的相对地址</span></span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            <span class="comment">// 获取MessageBoxW函数的地址，并读取函数数据</span></span><br><span class="line">            pMessageBoxW = (pfnMessageBoxW)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;User32.dll&quot;</span>)), <span class="string">&quot;MessageBoxW&quot;</span>);</span><br><span class="line">            <span class="built_in">ReadProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), pMessageBoxW, bArr, <span class="built_in">sizeof</span>(bArr), <span class="literal">NULL</span>);</span><br><span class="line">            <span class="comment">// 分配内存空间存放MessageBoxW函数，可读可写可执行</span></span><br><span class="line">            pMessageBoxWNew = (pfnMessageBoxW)<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, <span class="built_in">sizeof</span>(bArr), MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">            <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), pMessageBoxWNew, bArr, <span class="built_in">sizeof</span>(bArr), <span class="literal">NULL</span>);</span><br><span class="line">            <span class="comment">// 获取MessageBoxTimeoutW函数的地址</span></span><br><span class="line">            pMessageBoxTimeoutW = (LPBYTE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;User32.dll&quot;</span>)), <span class="string">&quot;MessageBoxTimeoutW&quot;</span>);</span><br><span class="line">            <span class="comment">// 计算并修改相对地址，就是pMessageBoxWNew函数偏移22的DWORD数据</span></span><br><span class="line">            dwReplace = pMessageBoxTimeoutW - (LPBYTE)pMessageBoxWNew - <span class="number">26</span>;</span><br><span class="line">            <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), (LPBYTE)pMessageBoxWNew + <span class="number">22</span>, &amp;dwReplace, <span class="number">4</span>, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_OK: &#123;</span><br><span class="line">                    <span class="comment">// 如果在调试器中对MessageBoxW函数下了int3断点，有可能第一个字节被修改为0xCC</span></span><br><span class="line">                    <span class="keyword">if</span> (*(LPBYTE)pMessageBoxWNew == <span class="number">0xCC</span>)</span><br><span class="line">                        *(LPBYTE)pMessageBoxWNew = <span class="number">0x8B</span>;</span><br><span class="line">                    <span class="built_in">pMessageBoxWNew</span>(hwndDlg, <span class="built_in">TEXT</span>(<span class="string">&quot;内容&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;标题&quot;</span>), MB_OK);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="综合实战：API-HOOK"><a href="#综合实战：API-HOOK" class="headerlink" title="综合实战：API HOOK"></a>综合实战：API HOOK</h2><p>下面讲的只适用于32位下，</p>
<p>例如一个模仿视频移动水印的程序，有一个图像静态控件，每隔2秒用<code>ExtTextOut</code>把蓝色水印位置变一下，每隔5秒用<code>DrawText</code>把红色水印位置变一下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;Winmm.lib&quot;</span>)</span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    HDC hdc;</span><br><span class="line">    HFONT hFont, hFontOld;</span><br><span class="line">    TCHAR szTextBlue[] = <span class="built_in">TEXT</span>(<span class="string">&quot;用户名：老王&quot;</span>);    <span class="comment">// 蓝色水印</span></span><br><span class="line">    TCHAR szTextRed[] = <span class="built_in">TEXT</span>(<span class="string">&quot;Powered By 老王&quot;</span>);  <span class="comment">// 红色水印</span></span><br><span class="line">    <span class="type">static</span> SIZE sizeBlue, sizeRed;                <span class="comment">// 蓝色、红色水印字符串的宽度高度</span></span><br><span class="line">    <span class="type">static</span> RECT rcBlue, rcRed;                    <span class="comment">// 要绘制的蓝色、红色水印的开始位置范围</span></span><br><span class="line">    <span class="type">static</span> RECT rcExtTextOut = &#123; <span class="number">0</span> &#125;;             <span class="comment">// 保存ExtTextOut函数的上次绘制区域</span></span><br><span class="line">    <span class="type">static</span> RECT rcDrawText = &#123; <span class="number">0</span> &#125;;               <span class="comment">// 保存DrawText函数的上次绘制区域</span></span><br><span class="line">    RECT rcClient;</span><br><span class="line">    <span class="type">int</span> x, y;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_INITDIALOG: &#123;</span><br><span class="line">            <span class="built_in">PlaySound</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;三生石上刻相思.wav&quot;</span>), <span class="literal">NULL</span>, SND_FILENAME | SND_ASYNC | SND_LOOP);</span><br><span class="line">            <span class="comment">// 蓝色、红色水印字符串的宽度高度</span></span><br><span class="line">            hdc = <span class="built_in">GetDC</span>(hwndDlg);</span><br><span class="line">            hFont = <span class="built_in">CreateFont</span>(<span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, GB2312_CHARSET, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;宋体&quot;</span>));</span><br><span class="line">            hFontOld = (HFONT)<span class="built_in">SelectObject</span>(hdc, hFont);</span><br><span class="line">            <span class="built_in">GetTextExtentPoint32</span>(hdc, szTextBlue, _tcslen(szTextBlue), &amp;sizeBlue);</span><br><span class="line">            <span class="built_in">GetTextExtentPoint32</span>(hdc, szTextRed, _tcslen(szTextRed), &amp;sizeRed);</span><br><span class="line">            <span class="built_in">SelectObject</span>(hdc, hFontOld);</span><br><span class="line">            <span class="built_in">ReleaseDC</span>(hwndDlg, hdc);</span><br><span class="line">            <span class="comment">// 要绘制的蓝色、红色水印的矩形范围</span></span><br><span class="line">            <span class="built_in">GetClientRect</span>(hwndDlg, &amp;rcClient);</span><br><span class="line">            <span class="built_in">SetRect</span>(&amp;rcBlue, <span class="number">0</span>, <span class="number">0</span>, rcClient.right - sizeBlue.cx, rcClient.bottom - sizeBlue.cy);</span><br><span class="line">            <span class="built_in">SetRect</span>(&amp;rcRed, <span class="number">0</span>, <span class="number">0</span>, rcClient.right - sizeRed.cx, rcClient.bottom - sizeRed.cy);</span><br><span class="line">            <span class="comment">// 创建两个计时器，分别显示蓝色、红色水印</span></span><br><span class="line">            <span class="built_in">SetTimer</span>(hwndDlg, <span class="number">1</span>, <span class="number">2000</span>, <span class="literal">NULL</span>);       <span class="comment">// 蓝色水印，2秒触发一次</span></span><br><span class="line">            <span class="built_in">SetTimer</span>(hwndDlg, <span class="number">2</span>, <span class="number">5000</span>, <span class="literal">NULL</span>);       <span class="comment">// 红色水印，5秒触发一次</span></span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_TIMER: &#123;</span><br><span class="line">            hdc = <span class="built_in">GetDC</span>(hwndDlg);</span><br><span class="line">            <span class="built_in">SetBkMode</span>(hdc, TRANSPARENT);</span><br><span class="line">            hFont = <span class="built_in">CreateFont</span>(<span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, GB2312_CHARSET, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;宋体&quot;</span>));</span><br><span class="line">            hFontOld = (HFONT)<span class="built_in">SelectObject</span>(hdc, hFont);</span><br><span class="line">            <span class="keyword">switch</span> (wParam) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>: &#123;</span><br><span class="line">                    <span class="comment">// 处理蓝色水印，2秒触发一次，要绘制的字符串的开始位置随机</span></span><br><span class="line">                    <span class="built_in">InvalidateRect</span>(hwndDlg, &amp;rcExtTextOut, TRUE);   <span class="comment">// 擦除上次的文字</span></span><br><span class="line">                    <span class="built_in">SetTextColor</span>(hdc, <span class="built_in">RGB</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>));</span><br><span class="line">                    <span class="built_in">srand</span>((UINT)<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line">                    x = <span class="built_in">rand</span>() % (rcBlue.right + <span class="number">1</span>);</span><br><span class="line">                    y = <span class="built_in">rand</span>() % (rcBlue.bottom + <span class="number">1</span>);</span><br><span class="line">                    <span class="built_in">SetRect</span>(&amp;rcExtTextOut, x, y, x + sizeBlue.cx, y + sizeBlue.cy);</span><br><span class="line">                    <span class="built_in">ExtTextOut</span>(hdc, x, y, <span class="number">0</span>, <span class="literal">NULL</span>, szTextBlue, _tcslen(szTextBlue), <span class="literal">NULL</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line">                    <span class="comment">// 处理红色水印，5秒触发一次，要绘制的字符串的开始位置随机</span></span><br><span class="line">                    <span class="built_in">InvalidateRect</span>(hwndDlg, &amp;rcDrawText, TRUE);     <span class="comment">// 擦除上次的文字</span></span><br><span class="line">                    <span class="built_in">SetTextColor</span>(hdc, <span class="built_in">RGB</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">                    <span class="built_in">srand</span>(<span class="built_in">GetTickCount</span>());</span><br><span class="line">                    x = <span class="built_in">rand</span>() % (rcRed.right + <span class="number">1</span>);</span><br><span class="line">                    y = <span class="built_in">rand</span>() % (rcRed.bottom + <span class="number">1</span>);</span><br><span class="line">                    <span class="built_in">SetRect</span>(&amp;rcDrawText, x, y, x + sizeRed.cx, y + sizeRed.cy);</span><br><span class="line">                    <span class="built_in">DrawText</span>(hdc, szTextRed, _tcslen(szTextRed), &amp;rcDrawText, DT_SINGLELINE);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="built_in">SelectObject</span>(hdc, hFontOld);</span><br><span class="line">            <span class="built_in">DeleteObject</span>(hFont);</span><br><span class="line">            <span class="built_in">ReleaseDC</span>(hwndDlg, hdc);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_SIZE: &#123;</span><br><span class="line">            <span class="built_in">SetRect</span>(&amp;rcBlue, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">LOWORD</span>(lParam) - sizeBlue.cx, <span class="built_in">HIWORD</span>(lParam) - sizeBlue.cy);</span><br><span class="line">            <span class="built_in">SetRect</span>(&amp;rcRed, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">LOWORD</span>(lParam) - sizeRed.cx, <span class="built_in">HIWORD</span>(lParam) - sizeRed.cy);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>选择用远程线程注入方式注入一个DLL：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;resource.h&quot;</span></span></span><br><span class="line"><span class="comment">// 函数声明</span></span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">BOOL <span class="title">EjectDll</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nCmdShow)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DialogBoxParam</span>(hInstance, <span class="built_in">MAKEINTRESOURCE</span>(IDD_MAIN), <span class="literal">NULL</span>, DialogProc, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">INT_PTR CALLBACK <span class="title">DialogProc</span><span class="params">(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (uMsg) &#123;</span><br><span class="line">        <span class="keyword">case</span> WM_COMMAND: &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">LOWORD</span>(wParam)) &#123;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_INJECT: &#123;</span><br><span class="line">                    <span class="built_in">InjectDll</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDC_BTN_EJECT: &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">case</span> IDCANCEL: &#123;</span><br><span class="line">                    <span class="built_in">EndDialog</span>(hwndDlg, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">InjectDll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TCHAR szCommandLine[MAX_PATH] = <span class="built_in">TEXT</span>(<span class="string">&quot;FloatingWaterMark.exe&quot;</span>);</span><br><span class="line">    STARTUPINFO si = &#123; <span class="built_in">sizeof</span>(STARTUPINFO) &#125;;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">//LPCTSTR lpDllPath = TEXT(&quot;..\\..\\FWMDll\\Release\\FWMDll.dll&quot;);</span></span><br><span class="line">    LPCTSTR lpDllPath = <span class="built_in">TEXT</span>(<span class="string">&quot;..\\..\\FWMDll\\Release\\FWMDll_修改.dll&quot;</span>);</span><br><span class="line">    <span class="comment">//LPCTSTR lpDllPath = TEXT(&quot;..\\..\\FWMDll2\\Release\\FWMDll.dll&quot;);</span></span><br><span class="line">    <span class="comment">//LPCTSTR lpDllPath = TEXT(&quot;..\\..\\..\\Detours\\InjectDll\\Release\\InjectDll.dll&quot;);</span></span><br><span class="line">    LPTSTR lpDllPathRemote = <span class="literal">NULL</span>;</span><br><span class="line">    HANDLE hThreadRemote = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">GetStartupInfo</span>(&amp;si);</span><br><span class="line">    <span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, szCommandLine, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, CREATE_SUSPENDED, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line">    <span class="comment">// (1)    调用VirtualAllocEx函数在远程进程的地址空间中分配一块内存；</span></span><br><span class="line">    <span class="type">int</span> cbDllPath = (_tcslen(lpDllPath) + <span class="number">1</span>) * <span class="built_in">sizeof</span>(TCHAR);</span><br><span class="line">    lpDllPathRemote = (LPTSTR)<span class="built_in">VirtualAllocEx</span>(pi.hProcess, <span class="literal">NULL</span>, cbDllPath, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (!lpDllPathRemote)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (2)    调用WriteProcessMemory函数把要注入的dll的路径复制到第1步分配的内存中；</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">WriteProcessMemory</span>(pi.hProcess, lpDllPathRemote, lpDllPath, cbDllPath, <span class="literal">NULL</span>))</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (3)    调用GetProcAddress函数得到LoadLibraryA / LoadLibraryW函数(Kernel32.dll)的实际地址；</span></span><br><span class="line">    PTHREAD_START_ROUTINE pfnThreadRtn = (PTHREAD_START_ROUTINE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Kernel32&quot;</span>)), <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pfnThreadRtn)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="comment">// (4)    调用CreateRemoteThread函数在远程进程中创建一个线程</span></span><br><span class="line">    hThreadRemote = <span class="built_in">CreateRemoteThread</span>(pi.hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, pfnThreadRtn, lpDllPathRemote, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hThreadRemote)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    <span class="built_in">WaitForSingleObject</span>(hThreadRemote, INFINITE);</span><br><span class="line">    <span class="built_in">ResumeThread</span>(pi.hThread);</span><br><span class="line">    <span class="comment">// (5)    调用VirtualFreeEx函数释放第1步分配的内存；</span></span><br><span class="line">    <span class="keyword">if</span> (!lpDllPathRemote)</span><br><span class="line">        <span class="built_in">VirtualFreeEx</span>(pi.hProcess, lpDllPathRemote, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="keyword">if</span> (!pi.hThread)</span><br><span class="line">        <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">    <span class="keyword">if</span> (!pi.hProcess)</span><br><span class="line">        <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOL <span class="title">EjectDll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>被注入的DLL，选择修改该API开头为<code>call</code>，跳转到自定义函数中，这里不需要导出函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line">LPBYTE pExtTextOutW;</span><br><span class="line">TCHAR szText1[] = <span class="built_in">TEXT</span>(<span class="string">&quot;屏幕&quot;</span>);</span><br><span class="line">TCHAR szText2[] = <span class="built_in">TEXT</span>(<span class="string">&quot;用户名&quot;</span>);</span><br><span class="line">TCHAR szText3[] = <span class="built_in">TEXT</span>(<span class="string">&quot;购买者&quot;</span>);</span><br><span class="line">TCHAR szTextReplace[] = <span class="built_in">TEXT</span>(<span class="string">&quot;                                                              &quot;</span>);</span><br><span class="line">LPTSTR lpStr;</span><br><span class="line"><span class="function">VOID <span class="title">InterceptExtTextOutW</span><span class="params">(LPTSTR lpText)</span></span>;</span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    BYTE bExtTextOutWCall[] = &#123; <span class="number">0xFF</span>,  <span class="number">0x74</span>,  <span class="number">0x24</span>,  <span class="number">0x18</span>,  <span class="number">0xE8</span>,  <span class="number">0x00</span>,  <span class="number">0x00</span>,  <span class="number">0x00</span>,  <span class="number">0x00</span>,  <span class="number">0x90</span>,  <span class="number">0x90</span>,  <span class="number">0x90</span>,  <span class="number">0x90</span> &#125;;</span><br><span class="line">    DWORD dwOldProtect;</span><br><span class="line">    MEMORY_BASIC_INFORMATION mbi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_ATTACH: &#123;</span><br><span class="line">            <span class="comment">// 获取ExtTextOutW函数的地址</span></span><br><span class="line">            pExtTextOutW = (LPBYTE)<span class="built_in">GetProcAddress</span>(<span class="built_in">GetModuleHandle</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Gdi32.dll&quot;</span>)), <span class="string">&quot;ExtTextOutW&quot;</span>);</span><br><span class="line">            *(LPINT)(bExtTextOutWCall + <span class="number">5</span>) = (INT)InterceptExtTextOutW - (INT)pExtTextOutW - <span class="number">0x9</span>;</span><br><span class="line">            <span class="comment">// 把ExtTextOutW函数起始处改为Call</span></span><br><span class="line">            <span class="built_in">VirtualQuery</span>(pExtTextOutW, &amp;mbi, <span class="built_in">sizeof</span>(mbi));</span><br><span class="line">            <span class="built_in">VirtualProtect</span>(pExtTextOutW, <span class="number">512</span>, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect);</span><br><span class="line">            <span class="built_in">WriteProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), pExtTextOutW, bExtTextOutWCall, <span class="built_in">sizeof</span>(bExtTextOutWCall), <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">VirtualProtect</span>(pExtTextOutW, <span class="number">512</span>, mbi.Protect, &amp;dwOldProtect);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_ATTACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_THREAD_DETACH: &#123;&#125;;</span><br><span class="line">        <span class="keyword">case</span> DLL_PROCESS_DETACH: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//_declspec(naked)表示不对函数做栈处理 如函数开头初始化（ebp作指针、开辟局部变量控件、保存某些寄存器值）和函数尾部（平衡栈、恢复保存寄存器、ret）</span></span><br><span class="line">_declspec(naked) <span class="function">VOID <span class="title">InterceptExtTextOutW</span><span class="params">(LPTSTR lpText)</span> </span>&#123;</span><br><span class="line">    _asm &#123;</span><br><span class="line">        <span class="comment">// 大多数函数开头就是这个样子</span></span><br><span class="line">        push ebp</span><br><span class="line">        mov  ebp, esp</span><br><span class="line">        sub  esp, <span class="number">0x10</span></span><br><span class="line">        push ebx</span><br><span class="line">        push esi</span><br><span class="line">        push edi</span><br><span class="line">        <span class="comment">// 额外保存ecx和edx，eax和esp暂时不需要关心</span></span><br><span class="line">        push ecx</span><br><span class="line">        push edx</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 下面的C++代码中可能会有一些push指令，但是没关系，编译器会自动恢复esp的值，我们无需关心</span></span><br><span class="line">    <span class="keyword">if</span> ((lpStr = _tcsstr(lpText, szText1)) || (lpStr = _tcsstr(lpText, szText2)) || (lpStr = _tcsstr(lpText, szText3)))</span><br><span class="line">        <span class="built_in">memcpy</span>(lpStr, szTextReplace, _tcslen(lpStr) * <span class="built_in">sizeof</span>(TCHAR));</span><br><span class="line">    _asm &#123;</span><br><span class="line">        <span class="comment">// 恢复edx和ecx</span></span><br><span class="line">        pop edx</span><br><span class="line">        pop ecx</span><br><span class="line">        <span class="comment">// 大多数函数结尾都是这个样子</span></span><br><span class="line">        pop edi</span><br><span class="line">        pop esi</span><br><span class="line">        pop ebx</span><br><span class="line">        mov esp, ebp</span><br><span class="line">        pop ebp</span><br><span class="line">        <span class="comment">// 修改ExtTextOutW函数的时候，有一个push和call，导致esp减了8个字节</span></span><br><span class="line">        add esp, <span class="number">8</span></span><br><span class="line">        <span class="comment">// 已经恢复各通用寄存器和堆栈空间布局，开始执行原ExtTextOutW函数开头的一些指令行</span></span><br><span class="line">        mov  edi, edi</span><br><span class="line">        push ebp</span><br><span class="line">        mov  ebp, esp</span><br><span class="line">        push ecx</span><br><span class="line">        mov  dword ptr[ebp - <span class="number">0x4</span>], <span class="number">0x49414E</span></span><br><span class="line">        <span class="comment">// 跳转到我们修改过的指令的下一条指令行继续执行，就是ExtTextOutW + 0xD地址处</span></span><br><span class="line">        mov eax, pExtTextOutW</span><br><span class="line">        add eax, <span class="number">0xD</span></span><br><span class="line">        jmp eax</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/">https://monoceros406.github.io/2024/07/14/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://monoceros406.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/WinAPI/">WinAPI</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/18/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B/" title="Windows软件调试初探-进程与线程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows软件调试初探-进程与线程</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/13/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%89%AA%E8%B4%B4%E6%9D%BF/" title="WindowsAPI查缺补漏-剪贴板"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">WindowsAPI查缺补漏-剪贴板</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/07/21/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-INI%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%8E%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%93%8D%E4%BD%9C/" title="WindowsAPI查缺补漏-INI配置文件与注册表操作"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-21</div><div class="title">WindowsAPI查缺补漏-INI配置文件与注册表操作</div></div></a></div><div><a href="/2024/06/12/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" title="WindowsAPI查缺补漏-内存管理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-12</div><div class="title">WindowsAPI查缺补漏-内存管理</div></div></a></div><div><a href="/2024/07/13/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%89%AA%E8%B4%B4%E6%9D%BF/" title="WindowsAPI查缺补漏-剪贴板"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-13</div><div class="title">WindowsAPI查缺补漏-剪贴板</div></div></a></div><div><a href="/2024/06/05/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="WindowsAPI查缺补漏-多线程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-05</div><div class="title">WindowsAPI查缺补漏-多线程</div></div></a></div><div><a href="/2024/07/31/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-PE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/" title="WindowsAPI查缺补漏-PE文件格式解析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-31</div><div class="title">WindowsAPI查缺补漏-PE文件格式解析</div></div></a></div><div><a href="/2024/07/22/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%9D%82%E8%B0%88/" title="WindowsAPI查缺补漏-杂谈"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-22</div><div class="title">WindowsAPI查缺补漏-杂谈</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">Windows系统安全爱好者</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">319</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://monoceros406.github.io/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">哪里排版出锅了请告诉我QwQ  QQ:1295625063</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">WindowsAPI查缺补漏-动态链接库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="toc-number">1.1.</span> <span class="toc-text">静态链接库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93"><span class="toc-number">1.2.</span> <span class="toc-text">动态链接库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9%E5%87%BD%E6%95%B0DllMain"><span class="toc-number">1.2.1.</span> <span class="toc-text">入口点函数DllMain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BDDLL"><span class="toc-number">1.2.2.</span> <span class="toc-text">延迟加载DLL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FUnloadDelayLoadedDLL2"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">__FUnloadDelayLoadedDLL2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DragQueryFile"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">DragQueryFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DragQueryPoint"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">DragQueryPoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DragFinish"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">DragFinish</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%B1%80%E9%83%A8%E5%AD%98%E5%82%A8"><span class="toc-number">1.3.</span> <span class="toc-text">线程局部存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TlsAlloc"><span class="toc-number">1.3.2.</span> <span class="toc-text">TlsAlloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TlsSetValue"><span class="toc-number">1.3.3.</span> <span class="toc-text">TlsSetValue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TlsGetValue"><span class="toc-number">1.3.4.</span> <span class="toc-text">TlsGetValue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TlsFree"><span class="toc-number">1.3.5.</span> <span class="toc-text">TlsFree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.3.6.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81TLS"><span class="toc-number">1.3.7.</span> <span class="toc-text">静态TLS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E9%92%A9%E5%AD%90"><span class="toc-number">1.4.</span> <span class="toc-text">Windows钩子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SetWindowsHookEx"><span class="toc-number">1.4.1.</span> <span class="toc-text">SetWindowsHookEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CallNextHookEx"><span class="toc-number">1.4.2.</span> <span class="toc-text">CallNextHookEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UnhookWindowsHookEx"><span class="toc-number">1.4.3.</span> <span class="toc-text">UnhookWindowsHookEx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ToUnicode"><span class="toc-number">1.4.4.</span> <span class="toc-text">ToUnicode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90-2"><span class="toc-number">1.4.5.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%85%B1%E4%BA%AB"><span class="toc-number">1.5.</span> <span class="toc-text">变量共享</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DLL%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.</span> <span class="toc-text">DLL注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%8F%90%E8%8A%9D%E5%A3%AB"><span class="toc-number">1.6.1.</span> <span class="toc-text">前提芝士</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GetTopWindow"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">GetTopWindow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GetNativeSystemInfo"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">GetNativeSystemInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IsWow64Process"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">IsWow64Process</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateRemoteThread"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">CreateRemoteThread</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemParameterInfo"><span class="toc-number">1.6.1.5.</span> <span class="toc-text">SystemParameterInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Wow64DisableWow64FsRedirection-Wow64RevertWow64FsRedirection"><span class="toc-number">1.6.1.6.</span> <span class="toc-text">Wow64DisableWow64FsRedirection&#x2F;Wow64RevertWow64FsRedirection</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E9%92%A9%E5%AD%90%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.2.</span> <span class="toc-text">Windows钩子注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.3.</span> <span class="toc-text">远程线程注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%BD%AC%E5%8F%91%E6%9C%BA%E5%88%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.4.</span> <span class="toc-text">函数转发机制注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CreateProcess%E5%86%99ShellCode%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.5.</span> <span class="toc-text">CreateProcess写ShellCode注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APC%E6%9C%BA%E5%88%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.6.</span> <span class="toc-text">APC机制注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E6%B3%95%E6%9C%BA%E5%88%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">1.6.7.</span> <span class="toc-text">输入法机制注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shadow-API"><span class="toc-number">1.7.</span> <span class="toc-text">Shadow API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E5%AE%9E%E6%88%98%EF%BC%9AAPI-HOOK"><span class="toc-number">1.8.</span> <span class="toc-text">综合实战：API HOOK</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/11/Qt6%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E5%B8%B8%E7%94%A8%E6%8E%A7%E4%BB%B6%E7%AE%80%E4%BB%8B/" title="Qt6开发入门-常用控件简介">Qt6开发入门-常用控件简介</a><time datetime="2025-05-11T03:15:46.000Z" title="发表于 2025-05-11 11:15:46">2025-05-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/11/Qt6%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-Qt%E6%A1%86%E6%9E%B6%E7%BB%BC%E8%BF%B0/" title="Qt6开发入门-Qt框架综述">Qt6开发入门-Qt框架综述</a><time datetime="2025-05-11T01:55:46.000Z" title="发表于 2025-05-11 09:55:46">2025-05-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/05/C-%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" title="C++后端开发入门-环境配置与多线程编程">C++后端开发入门-环境配置与多线程编程</a><time datetime="2025-05-05T14:17:09.000Z" title="发表于 2025-05-05 22:17:09">2025-05-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/05/Qt6%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%85%A5%E9%97%A8/" title="Qt6开发入门-环境配置与入门">Qt6开发入门-环境配置与入门</a><time datetime="2025-05-05T13:30:44.000Z" title="发表于 2025-05-05 21:30:44">2025-05-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/05/03/%E5%B7%AE%E5%88%86%E9%9A%90%E7%A7%81%E5%AE%9E%E8%B7%B5%E5%85%A5%E9%97%A8/" title="差分隐私实践入门">差分隐私实践入门</a><time datetime="2025-05-03T08:15:35.000Z" title="发表于 2025-05-03 16:15:35">2025-05-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>