<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Windows驱动开发入门-WFP过滤平台 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Windows驱动开发入门-WFP过滤平台碎碎念本节讲网络传输层过滤，其中传输层接口TDI接口技术已被淘汰，取代其的新技术称为Windows过滤平台WFP。WFP包含用户态API和内核态API，本节只讲内核态开发。 WFP分为两大层次模块，用户态基础过滤引擎BFE和内核态过滤引擎KMFE。基础过滤引擎对上提供C调用方式的API以及RPC接口，这些接口封装在fwpuclnt.dll中。基础过滤引擎对">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows驱动开发入门-WFP过滤平台">
<meta property="og:url" content="https://monoceros406.github.io/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-WFP%E8%BF%87%E6%BB%A4%E5%B9%B3%E5%8F%B0/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="Windows驱动开发入门-WFP过滤平台碎碎念本节讲网络传输层过滤，其中传输层接口TDI接口技术已被淘汰，取代其的新技术称为Windows过滤平台WFP。WFP包含用户态API和内核态API，本节只讲内核态开发。 WFP分为两大层次模块，用户态基础过滤引擎BFE和内核态过滤引擎KMFE。基础过滤引擎对上提供C调用方式的API以及RPC接口，这些接口封装在fwpuclnt.dll中。基础过滤引擎对">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://monoceros406.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-10-08T11:19:52.000Z">
<meta property="article:modified_time" content="2024-10-08T11:20:28.148Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="逆向工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://monoceros406.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://monoceros406.github.io/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-WFP%E8%BF%87%E6%BB%A4%E5%B9%B3%E5%8F%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Windows驱动开发入门-WFP过滤平台',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-08 19:20:28'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="The Blog of Monoceros406" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Windows驱动开发入门-WFP过滤平台</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-08T11:19:52.000Z" title="发表于 2024-10-08 19:19:52">2024-10-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-08T11:20:28.148Z" title="更新于 2024-10-08 19:20:28">2024-10-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Windows驱动开发入门-WFP过滤平台"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Windows驱动开发入门-WFP过滤平台"><a href="#Windows驱动开发入门-WFP过滤平台" class="headerlink" title="Windows驱动开发入门-WFP过滤平台"></a>Windows驱动开发入门-WFP过滤平台</h1><h2 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h2><p>本节讲网络传输层过滤，其中传输层接口TDI接口技术已被淘汰，取代其的新技术称为Windows过滤平台WFP。WFP包含用户态API和内核态API，本节只讲内核态开发。</p>
<p>WFP分为两大层次模块，用户态基础过滤引擎BFE和内核态过滤引擎KMFE。基础过滤引擎对上提供C调用方式的API以及RPC接口，这些接口封装在fwpuclnt.dll中。基础过滤引擎对下和内核态过滤引擎交互，受内核态过滤引擎控制。内核态过滤引擎与系统网络协议栈交互，通过垫片（此垫片非彼垫片）内核模块从网络协议栈Tcpip.sys中获取网络数据，垫片被插入到网络协议栈各个层中。垫片获取到数据后，通过内核态过滤引擎提供的分类API，把数据传到WFP相应分层中。内核态过滤引擎分为若干个分层，每个分层中存在一个或多个子层和过滤器，子层是分层的更小划分。子层被赋予不同权重，同一个子层中，WFP按照权重从大到小把数据交给相应子层。</p>
<p>例如TCP&#x2F;IP协议栈中从上到下有数据流分层垫片、ALE网络连接管理、传输分层垫片（TCP&#x2F;UDP）、网络分层垫片（IPv4&#x2F;IPv6），他们通过分类API，与内核态过滤引擎不同子层交互，后者从上到小有流&#x2F;报文数据分层、发送.接收ALE分层、发送&#x2F;接收传输分层、发送&#x2F;接收IP分层。</p>
<p>WFP架构中存在过滤器数据结构，里面保存网络数据包的拦截规则和处理动作，开发者可向WFP的内核态过滤引擎添加过滤器。</p>
<p>本节代码报fwpsk.h语法错误的话，在<code>DriverEntry</code>例程文件最开头补上<code>#define NDIS620</code>，表示NDIS版本6.20，用别的版本的话可以自己查对应的操作系统版本。若链接错误需要在项目属性的链接器中添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WDMSec.lib;FwpKClnt.lib;Fwpuclnt.lib;NTOSKrnl.lib;NetIO.lib;NDIS.lib;UUID.lib;advapi32.lib;kernel32.lib;</span><br></pre></td></tr></table></figure>

<h2 id="基本对象模型"><a href="#基本对象模型" class="headerlink" title="基本对象模型"></a>基本对象模型</h2><p>内核态过滤引擎检查网络数据包是否命中过滤器的规则，对于命中规则的过滤器，内核态过滤引擎执行这些过滤器中指定的动作。动作有放行或拦截网络数据包。一个分层中可能有多个子层和多个过滤器，一次网络事件可能同时命中多个过滤器规则。此时过滤仲裁器模块计算出最终过滤动作并交由内核态过滤引擎，后者将最终过滤结果反馈给垫片。</p>
<p>垫片安插在系统网络协议栈的不同层中，获取网络协议栈的数据。安插在不同协议层的垫片获取到的数据不同。垫片还能把内核态过滤引擎的过滤结果反馈给网络协议栈。</p>
<p>呼出接口Callout由一系列回调函数和一个GUID组成。当网络数据命中某过滤器规则且过滤器指定一个呼出接口时，该呼出接口内的回调函数会被调用。不同呼出接口的回调函数实现不同功能，系统内置了一部分呼出接口，开发者也可向系统注册自己的呼出接口来完成特定逻辑。FWPS_CALLOUT结构描述呼出接口信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_CALLOUT FWPS_CALLOUT3</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPS_CALLOUT3_</span> &#123;</span><br><span class="line">    <span class="comment">// Uniquely identifies the callout. This must be the same GUID supplied to</span></span><br><span class="line">    GUID calloutKey; <span class="comment">// FwpmCalloutAdd0. 该呼出接口的唯一标识</span></span><br><span class="line">    UINT32 flags; <span class="comment">// Flags 特性 一般0</span></span><br><span class="line">    <span class="comment">//下面仨回调函数</span></span><br><span class="line">    FWPS_CALLOUT_CLASSIFY_FN3 classifyFn; <span class="comment">// Pointer to the classification function.</span></span><br><span class="line">    FWPS_CALLOUT_NOTIFY_FN3 notifyFn; <span class="comment">// Pointer to the notification function.</span></span><br><span class="line">    FWPS_CALLOUT_FLOW_DELETE_NOTIFY_FN0 flowDeleteFn; <span class="comment">// Pointer to the flow delete function.</span></span><br><span class="line">&#125; FWPS_CALLOUT3;</span><br></pre></td></tr></table></figure>

<p>内核态中，每个分层用64位的LUID标识，称为运行时过滤分层标识。用户态中，每个分层用129位的GUID标识，称为管理过滤分层标识。部分常用管理过滤分层标识如下，分别位接收&#x2F;发送IPv4&#x2F;6网络数据包层：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FWPM_LAYER_INBOUND_IPPACKET_V4</span><br><span class="line">FWPM_LAYER_INBOUND_IPPACKET_V6</span><br><span class="line">FWPM_LAYER_OUTBOUND_IPPACKET_V4</span><br><span class="line">FWPM_LAYER_OUTBOUND_IPPACKET_V6</span><br></pre></td></tr></table></figure>

<p>子层结构体定义为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPM_SUBLAYER0_</span> &#123;</span><br><span class="line">    GUID subLayerKey; <span class="comment">//子层标识</span></span><br><span class="line">    FWPM_DISPLAY_DATA0 displayData; <span class="comment">//显示数据</span></span><br><span class="line">    UINT32 flags; <span class="comment">//子层特性 FWPM_SUBLAYER_FLAG_PERSISTENT标识为永久性子层 与基础过滤引擎生命周期相同</span></span><br><span class="line">    PGUID providerKey;</span><br><span class="line">    FWP_BYTE_BLOB providerData;</span><br><span class="line">    UINT16 weight; <span class="comment">//子层权重</span></span><br><span class="line">&#125; 	FWPM_SUBLAYER0;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPM_DISPLAY_DATA0_</span> &#123;</span><br><span class="line">    <span class="type">wchar_t</span>* name; <span class="comment">//对象名字</span></span><br><span class="line">    <span class="type">wchar_t</span>* description; <span class="comment">//对象描述</span></span><br><span class="line">&#125; 	FWPM_DISPLAY_DATA0;</span><br></pre></td></tr></table></figure>

<p>过滤器中的规则称为过滤条件，当一个过滤器中所有过滤条件全部成立时，才认为该过滤器规则被命中。使用过滤器时必需明确过滤器被添加到内核态过滤引擎哪个分层中，同一分层中可存在多个过滤器，不同过滤器被赋予不同权重，同子层内权重互相不能相同。过滤器还可关联呼出接口，当过滤器规则命中时WFP执行该过滤器关联的呼出接口内的回调函数。回调函数返回过滤结果允许或拦截到WFP。过滤器结构如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FWPM_FILTER FWPM_FILTER0</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPM_FILTER0_</span> FWPM_FILTER0;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPM_FILTER0_</span> &#123;</span><br><span class="line">    GUID filterKey; <span class="comment">//过滤器唯一标识 指定0则过滤引擎自动分配</span></span><br><span class="line">    FWPM_DISPLAY_DATA0 displayData;</span><br><span class="line">    UINT32 flags;</span><br><span class="line">    PGUID providerKey;</span><br><span class="line">    FWP_BYTE_BLOB providerData;</span><br><span class="line">    GUID layerKey; <span class="comment">//管理过滤分层标识</span></span><br><span class="line">    GUID subLayerKey; <span class="comment">//子层GUID 添加到哪个子层 设为IID_NULL则被添加到默认子层</span></span><br><span class="line">    FWP_VALUE0 weight; <span class="comment">//权重</span></span><br><span class="line">    UINT32 numFilterConditions; <span class="comment">//过滤条件个数</span></span><br><span class="line">    FWPM_FILTER_CONDITION0* filterCondition; <span class="comment">//过滤条件数组</span></span><br><span class="line">    FWPM_ACTION0 action;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        UINT64 rawContext;</span><br><span class="line">        GUID providerContextKey;</span><br><span class="line">    &#125;;</span><br><span class="line">    PGUID reserved;</span><br><span class="line">    UINT64 filterId;</span><br><span class="line">    FWP_VALUE0 effectiveWeight;</span><br><span class="line">&#125; 	FWPM_FILTER0;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWP_VALUE0_</span> &#123;</span><br><span class="line">    FWP_DATA_TYPE type;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        UINT8 uint8;</span><br><span class="line">        UINT16 uint16;</span><br><span class="line">        UINT32 uint32;</span><br><span class="line">        PUINT64 uint64;</span><br><span class="line">        INT8 int8;</span><br><span class="line">        INT16 int16;</span><br><span class="line">        INT32 int32;</span><br><span class="line">        PINT64 int64;</span><br><span class="line">        FLOAT float32;</span><br><span class="line">        PDOUBLE double64;</span><br><span class="line">        FWP_BYTE_ARRAY16* byteArray16;</span><br><span class="line">        FWP_BYTE_BLOB* byteBlob;</span><br><span class="line">        SID* sid;</span><br><span class="line">        FWP_BYTE_BLOB* sd;</span><br><span class="line">        FWP_TOKEN_INFORMATION* tokenInformation;</span><br><span class="line">        FWP_BYTE_BLOB* tokenAccessInformation;</span><br><span class="line">        LPWSTR unicodeString;</span><br><span class="line">        FWP_BYTE_ARRAY6* byteArray6;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; 	FWP_VALUE0;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">FWP_DATA_TYPE_</span> &#123; <span class="comment">//weight.type的取值决定匿名结构体成员</span></span><br><span class="line">    FWP_EMPTY = <span class="number">0</span>, <span class="comment">//权重自动分配</span></span><br><span class="line">    FWP_UINT8 = (FWP_EMPTY + <span class="number">1</span>),</span><br><span class="line">    FWP_UINT16 = (FWP_UINT8 + <span class="number">1</span>), <span class="comment">//权重高63~60位 低60位自动分配</span></span><br><span class="line">    FWP_UINT32 = (FWP_UINT16 + <span class="number">1</span>),</span><br><span class="line">    FWP_UINT64 = (FWP_UINT32 + <span class="number">1</span>),</span><br><span class="line">    FWP_INT8 = (FWP_UINT64 + <span class="number">1</span>),</span><br><span class="line">    FWP_INT16 = (FWP_INT8 + <span class="number">1</span>),</span><br><span class="line">    FWP_INT32 = (FWP_INT16 + <span class="number">1</span>),</span><br><span class="line">    FWP_INT64 = (FWP_INT32 + <span class="number">1</span>),</span><br><span class="line">    FWP_FLOAT = (FWP_INT64 + <span class="number">1</span>),</span><br><span class="line">    FWP_DOUBLE = (FWP_FLOAT + <span class="number">1</span>),</span><br><span class="line">    FWP_BYTE_ARRAY16_TYPE = (FWP_DOUBLE + <span class="number">1</span>),</span><br><span class="line">    FWP_BYTE_BLOB_TYPE = (FWP_BYTE_ARRAY16_TYPE + <span class="number">1</span>),</span><br><span class="line">    FWP_SID = (FWP_BYTE_BLOB_TYPE + <span class="number">1</span>),</span><br><span class="line">    FWP_SECURITY_DESCRIPTOR_TYPE = (FWP_SID + <span class="number">1</span>),</span><br><span class="line">    FWP_TOKEN_INFORMATION_TYPE = (FWP_SECURITY_DESCRIPTOR_TYPE + <span class="number">1</span>),</span><br><span class="line">    FWP_TOKEN_ACCESS_INFORMATION_TYPE = (FWP_TOKEN_INFORMATION_TYPE + <span class="number">1</span>),</span><br><span class="line">    FWP_UNICODE_STRING_TYPE = (FWP_TOKEN_ACCESS_INFORMATION_TYPE + <span class="number">1</span>),</span><br><span class="line">    FWP_BYTE_ARRAY6_TYPE = (FWP_UNICODE_STRING_TYPE + <span class="number">1</span>),</span><br><span class="line">    FWP_SINGLE_DATA_TYPE_MAX = <span class="number">0xff</span>,</span><br><span class="line">    FWP_V4_ADDR_MASK = (FWP_SINGLE_DATA_TYPE_MAX + <span class="number">1</span>),</span><br><span class="line">    FWP_V6_ADDR_MASK = (FWP_V4_ADDR_MASK + <span class="number">1</span>),</span><br><span class="line">    FWP_RANGE_TYPE = (FWP_V6_ADDR_MASK + <span class="number">1</span>),</span><br><span class="line">    FWP_DATA_TYPE_MAX = (FWP_RANGE_TYPE + <span class="number">1</span>)</span><br><span class="line">&#125; 	FWP_DATA_TYPE;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPM_FILTER_CONDITION0_</span> &#123;</span><br><span class="line">    GUID fieldKey; <span class="comment">//网络数据包字段标识 如数据包远程IP地址字段为FWPM_CONDITION_IP_REMOTE_ADDRESS</span></span><br><span class="line">    FWP_MATCH_TYPE matchType; <span class="comment">//匹配类型</span></span><br><span class="line">    FWP_CONDITION_VALUE0 conditionValue; <span class="comment">//过滤条件的值</span></span><br><span class="line">&#125; 	FWPM_FILTER_CONDITION0;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">FWP_MATCH_TYPE_</span> &#123;</span><br><span class="line">    FWP_MATCH_EQUAL = <span class="number">0</span>, <span class="comment">//fieldKey与conditionValue相等</span></span><br><span class="line">    FWP_MATCH_GREATER = (FWP_MATCH_EQUAL + <span class="number">1</span>), <span class="comment">//大于</span></span><br><span class="line">    FWP_MATCH_LESS = (FWP_MATCH_GREATER + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_GREATER_OR_EQUAL = (FWP_MATCH_LESS + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_LESS_OR_EQUAL = (FWP_MATCH_GREATER_OR_EQUAL + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_RANGE = (FWP_MATCH_LESS_OR_EQUAL + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_FLAGS_ALL_SET = (FWP_MATCH_RANGE + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_FLAGS_ANY_SET = (FWP_MATCH_FLAGS_ALL_SET + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_FLAGS_NONE_SET = (FWP_MATCH_FLAGS_ANY_SET + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_EQUAL_CASE_INSENSITIVE = (FWP_MATCH_FLAGS_NONE_SET + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_NOT_EQUAL = (FWP_MATCH_EQUAL_CASE_INSENSITIVE + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_PREFIX = (FWP_MATCH_NOT_EQUAL + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_NOT_PREFIX = (FWP_MATCH_PREFIX + <span class="number">1</span>),</span><br><span class="line">    FWP_MATCH_TYPE_MAX = (FWP_MATCH_NOT_PREFIX + <span class="number">1</span>)</span><br><span class="line">&#125; 	FWP_MATCH_TYPE;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWP_CONDITION_VALUE0_</span> &#123;</span><br><span class="line">    FWP_DATA_TYPE type;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        UINT8 uint8;</span><br><span class="line">        UINT16 uint16;</span><br><span class="line">        UINT32 uint32;</span><br><span class="line">        PUINT64 uint64;</span><br><span class="line">        INT8 int8;</span><br><span class="line">        INT16 int16;</span><br><span class="line">        INT32 int32;</span><br><span class="line">        PINT64 int64;</span><br><span class="line">        FLOAT float32;</span><br><span class="line">        PDOUBLE double64;</span><br><span class="line">        FWP_BYTE_ARRAY16* byteArray16;</span><br><span class="line">        FWP_BYTE_BLOB* byteBlob;</span><br><span class="line">        SID* sid;</span><br><span class="line">        FWP_BYTE_BLOB* sd;</span><br><span class="line">        FWP_TOKEN_INFORMATION* tokenInformation;</span><br><span class="line">        FWP_BYTE_BLOB* tokenAccessInformation;</span><br><span class="line">        LPWSTR unicodeString;</span><br><span class="line">        FWP_BYTE_ARRAY6* byteArray6;</span><br><span class="line">        FWP_V4_ADDR_AND_MASK* v4AddrMask;</span><br><span class="line">        FWP_V6_ADDR_AND_MASK* v6AddrMask;</span><br><span class="line">        FWP_RANGE0* rangeValue;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; 	FWP_CONDITION_VALUE0;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPM_ACTION0_</span> &#123;</span><br><span class="line">    FWP_ACTION_TYPE type; <span class="comment">//动作类型 过滤条件成立后的动作</span></span><br><span class="line">    	<span class="comment">//FWP_ACTION_BLOCK 拦截</span></span><br><span class="line">    	<span class="comment">//FWP_ACTION_PERMIT 放行</span></span><br><span class="line">    	<span class="comment">//FWP_ACTION_CALLOUT_TERMINATING 回调呼出接口内回调函数 后者始终返回允许或拦截</span></span><br><span class="line">    	<span class="comment">//FWP_ACTION_CALLOUT_INSPECTION 同上 不会返回允许或拦截</span></span><br><span class="line">    	<span class="comment">//FWP_ACTION_CALLOUT_UNKNOWN 同上 可能返回允许或拦截</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        GUID filterType;</span><br><span class="line">        GUID calloutKey; <span class="comment">//呼出接口GUID type取值FWP_ACTION_CALLOUT_*时 过滤器规则命中后WFP回调该GUID对应的呼出接口结构体内回调函数</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125; 	FWPM_ACTION0;</span><br></pre></td></tr></table></figure>

<p>前文提到notifyFn、classifyFn和flowDeleteFn回调函数。当一个过滤器关联了呼出接口且规则被命中时，过滤引擎hi掉呼出接口的classify函数。开发者可在该回调函数中获取网络数据包相关信息，具体信息取决于过滤器所在分层，还可以设置对网络数据包的允许或拦截操作，原型如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID NTAPI <span class="title">classifyFn1</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST FWPS_INCOMING_VALUES0* inFixedValues, <span class="comment">//传入参数 包含网络数据包信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST FWPS_INCOMING_METADATA_VALUES0* inMetaValues, <span class="comment">//元数据值</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_opt_ PVOID layerData, <span class="comment">//被过滤的网络原始数据</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ CONST PVOID classifyContext, <span class="comment">//和呼出接口驱动关联的上下文</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In CONST FWPS_FILTER1* filter, <span class="comment">//相关过滤器指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ UINT64 flowContext, <span class="comment">//和流句柄关联的上下文 可用FwpsFlowAssociateContext0把一个上下文与数据流句柄进行关联</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ FWPS_CLASSIFY_OUT0* classifyOut <span class="comment">//该函数对这个网络数据包的过滤结果</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPS_INCOMING_VALUES0_</span> &#123;</span><br><span class="line">    UINT16 layerId; <span class="comment">//运行时过滤分层标识</span></span><br><span class="line">    UINT32 valueCount; <span class="comment">//incomingValue数组元素个数</span></span><br><span class="line">    FWPS_INCOMING_VALUE0* incomingValue; <span class="comment">//网络数据包相关信息数组</span></span><br><span class="line">&#125; 	FWPS_INCOMING_VALUES0;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPS_INCOMING_VALUE0_</span> &#123;</span><br><span class="line">    FWP_VALUE0 value; <span class="comment">//用法参考上文</span></span><br><span class="line">&#125; 	FWPS_INCOMING_VALUE0;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPS_INCOMING_METADATA_VALUES0_</span> &#123; <span class="comment">//每个成员都为FWPS_METADATA_FIELD_*元数据字段标识符来代表</span></span><br><span class="line">    UINT32 currentMetadataValues; <span class="comment">// Bitmask representing which values are set. 决定本结构体内部有效成员</span></span><br><span class="line">    <span class="comment">// Internal flags;</span></span><br><span class="line">    UINT32 flags;</span><br><span class="line">    <span class="comment">// Reserved for system use.</span></span><br><span class="line">    UINT64 reserved;</span><br><span class="line">    <span class="comment">// Discard module and reason.</span></span><br><span class="line">    FWPS_DISCARD_METADATA0 discardMetadata;</span><br><span class="line">    <span class="comment">// Flow Handle.</span></span><br><span class="line">    UINT64 flowHandle;</span><br><span class="line">    <span class="comment">// IP Header size.</span></span><br><span class="line">    UINT32 ipHeaderSize;</span><br><span class="line">    <span class="comment">// Transport Header size</span></span><br><span class="line">    UINT32 transportHeaderSize;</span><br><span class="line">    <span class="comment">// Process Path.</span></span><br><span class="line">    FWP_BYTE_BLOB* processPath;</span><br><span class="line">    <span class="comment">// Token used for authorization.</span></span><br><span class="line">    UINT64 token;</span><br><span class="line">    <span class="comment">// Process Id.</span></span><br><span class="line">    UINT64 processId;</span><br><span class="line">    <span class="comment">// Source and Destination interface indices for discard indications.</span></span><br><span class="line">    UINT32 sourceInterfaceIndex;</span><br><span class="line">    UINT32 destinationInterfaceIndex;</span><br><span class="line">    <span class="comment">// Compartment Id for injection APIs.</span></span><br><span class="line">    ULONG compartmentId;</span><br><span class="line">    <span class="comment">// Fragment data for inbound fragments.</span></span><br><span class="line">    FWPS_INBOUND_FRAGMENT_METADATA0 fragmentMetadata;</span><br><span class="line">    <span class="comment">// Path MTU for outbound packets (to enable calculation of fragments).</span></span><br><span class="line">    ULONG pathMtu;</span><br><span class="line">    <span class="comment">// Completion handle (required in order to be able to pend at this layer).</span></span><br><span class="line">    HANDLE completionHandle;</span><br><span class="line">    <span class="comment">// Endpoint handle for use in outbound transport layer injection.</span></span><br><span class="line">    UINT64 transportEndpointHandle;</span><br><span class="line">    <span class="comment">// Remote scope id for use in outbound transport layer injection.</span></span><br><span class="line">    SCOPE_ID remoteScopeId;</span><br><span class="line">    <span class="comment">// Socket control data (and length) for use in outbound transport layer injection.</span></span><br><span class="line">    WSACMSGHDR* controlData;</span><br><span class="line">    ULONG controlDataLength;</span><br><span class="line">    <span class="comment">// Direction for the current packet. Only specified for ALE re-authorization.</span></span><br><span class="line">    FWP_DIRECTION packetDirection;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> (NTDDI_VERSION &gt;= NTDDI_WIN6SP1)</span></span><br><span class="line">    <span class="comment">// Raw IP header (and length) if the packet is sent with IP header from a RAW socket.</span></span><br><span class="line">    PVOID headerIncludeHeader;</span><br><span class="line">    ULONG headerIncludeHeaderLength;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> (NTDDI_VERSION &gt;= NTDDI_WIN7)</span></span><br><span class="line">    IP_ADDRESS_PREFIX destinationPrefix;</span><br><span class="line">    UINT16 frameLength;</span><br><span class="line">    UINT64 parentEndpointHandle;</span><br><span class="line">    UINT32 icmpIdAndSequence;</span><br><span class="line">    <span class="comment">// PID of the process that will be accepting the redirected connection</span></span><br><span class="line">    DWORD localRedirectTargetPID;</span><br><span class="line">    <span class="comment">// original destination of a redirected connection</span></span><br><span class="line">    SOCKADDR* originalDestination;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> (NTDDI_VERSION &gt;= NTDDI_WIN8)</span></span><br><span class="line">    HANDLE redirectRecords;</span><br><span class="line">    <span class="comment">// Bitmask representing which L2 values are set.</span></span><br><span class="line">    UINT32 currentL2MetadataValues;</span><br><span class="line">    <span class="comment">// L2 layer Flags;</span></span><br><span class="line">    UINT32 l2Flags;</span><br><span class="line">    UINT32 ethernetMacHeaderSize;</span><br><span class="line">    UINT32 wiFiOperationMode;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> (NDIS_SUPPORT_NDIS630)</span></span><br><span class="line">    NDIS_SWITCH_PORT_ID vSwitchSourcePortId;</span><br><span class="line">    NDIS_SWITCH_NIC_INDEX vSwitchSourceNicIndex;</span><br><span class="line">    NDIS_SWITCH_PORT_ID vSwitchDestinationPortId;</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    UINT32 padding0;</span><br><span class="line">    USHORT padding1;</span><br><span class="line">    UINT32 padding2;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span> <span class="comment">// (NDIS_SUPPORT_NDIS630)</span></span></span><br><span class="line">    HANDLE vSwitchPacketContext;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span> <span class="comment">// (NTDDI_VERSION &gt;= NTDDI_WIN8)</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span> <span class="comment">// (NTDDI_VERSION &gt;= NTDDI_WIN7)</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span> <span class="comment">// (NTDDI_VERSION &gt;= NTDDI_WIN6SP1)</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> (NTDDI_VERSION &gt;= NTDDI_WIN8)</span></span><br><span class="line">    PVOID subProcessTag;</span><br><span class="line">    <span class="comment">// Reserved for system use.</span></span><br><span class="line">    UINT64 reserved1;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; FWPS_INCOMING_METADATA_VALUES0;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_DISCARD_REASON                   0x00000001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_FLOW_HANDLE                      0x00000002</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_IP_HEADER_SIZE                   0x00000004</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_PROCESS_PATH                     0x00000008</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_TOKEN                            0x00000010</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_PROCESS_ID                       0x00000020</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_SYSTEM_FLAGS                     0x00000040</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_RESERVED                         0x00000080</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_SOURCE_INTERFACE_INDEX           0x00000100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_DESTINATION_INTERFACE_INDEX      0x00000200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_TRANSPORT_HEADER_SIZE            0x00000400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_COMPARTMENT_ID                   0x00000800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_FRAGMENT_DATA                    0x00001000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_PATH_MTU                         0x00002000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_COMPLETION_HANDLE                0x00004000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_TRANSPORT_ENDPOINT_HANDLE        0x00008000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_TRANSPORT_CONTROL_DATA           0x00010000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_REMOTE_SCOPE_ID                  0x00020000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_PACKET_DIRECTION                 0x00040000</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NTDDI_VERSION &gt;= NTDDI_WIN6SP1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_PACKET_SYSTEM_CRITICAL           0x00080000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_FORWARD_LAYER_OUTBOUND_PASS_THRU 0x00100000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_FORWARD_LAYER_INBOUND_PASS_THRU  0x00200000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_ALE_CLASSIFY_REQUIRED            0x00400000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_TRANSPORT_HEADER_INCLUDE_HEADER  0x00800000</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NTDDI_VERSION &gt;= NTDDI_WIN7)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_DESTINATION_PREFIX               0x01000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_ETHER_FRAME_LENGTH               0x02000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_PARENT_ENDPOINT_HANDLE           0x04000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_ICMP_ID_AND_SEQUENCE             0x08000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_LOCAL_REDIRECT_TARGET_PID        0x10000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_ORIGINAL_DESTINATION             0x20000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NTDDI_VERSION &gt;= NTDDI_WIN8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_REDIRECT_RECORD_HANDLE           0x40000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_METADATA_FIELD_SUB_PROCESS_TAG                  0x80000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FWPS_IS_METADATA_FIELD_PRESENT(metadataValues, metadataField) (((metadataValues)-&gt;currentMetadataValues &amp; (metadataField)) == (metadataField)) <span class="comment">//用于测试vurrentMetadataValues是否包含某个具体的标识符 返回非0有效 如FWPS_IS_METADATA_FIELD_PRESENT(inMetaValues,FWPS_METADATA_FILED_FLOW_HANDLE)等</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">FWPS_CLASSIFY_OUT0_</span> &#123;</span><br><span class="line">    FWP_ACTION_TYPE actionType; <span class="comment">//动作类型</span></span><br><span class="line">        <span class="comment">//FWP_ACTION_BLOCK 拦截</span></span><br><span class="line">        <span class="comment">//FWP_ACTION_CONTINUE 把早先过滤器设置在数据包上的动作传递给下一个过滤器</span></span><br><span class="line">        <span class="comment">//FWP_ACTION_NONE 不做任何动作或决策</span></span><br><span class="line">        <span class="comment">//FWP_ACTION_NONE_NO_MATCH 因不匹配过滤器数据类型 不做任何动作或决策</span></span><br><span class="line">        <span class="comment">//FWP_ACTION_PERMIT 允许</span></span><br><span class="line">    UINT64 outContext; <span class="comment">//系统保留不可修改</span></span><br><span class="line">    UINT64 filterId; <span class="comment">//系统保留不可修改</span></span><br><span class="line">    UINT32 rights; <span class="comment">//该结构体其他成员是否可修改 如FWPS_RIGHT_ACTION_WRITE表示当前结构体其他非系统保留成员可修改</span></span><br><span class="line">    UINT32 flags; <span class="comment">//过滤动作特性 如FWPS_CALSSIFY_OUT_FLAG_ABSORB表示拦截时系统不审计和记录</span></span><br><span class="line">    UINT32 reserved; <span class="comment">//系统保留不可修改</span></span><br><span class="line">&#125; 	FWPS_CLASSIFY_OUT0;</span><br></pre></td></tr></table></figure>

<p>当过滤器被添加到过滤引擎中或从过滤引擎中移除时，WFP调用该过滤器对应呼出接口的notifyFn1函数。开发者可通过该函数得知呼出接口关联的过滤器的操作情况，原型如下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">notifyFn1</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ FWPS_CALLOUT_NOTIFY_TYPE notifyType, <span class="comment">//通告类型 即本次回调原因</span></span></span></span><br><span class="line"><span class="params"><span class="function">    	<span class="comment">//FWPS_CALLOUT_NOTIFY_ADD_FILTER  过滤器被添加到过滤引擎中</span></span></span></span><br><span class="line"><span class="params"><span class="function">    	<span class="comment">//FWPS_CALLOUT_NOTIFY_DELETE_FILTER 过滤器从过滤引擎中移除</span></span></span></span><br><span class="line"><span class="params"><span class="function">    	<span class="comment">//FWPS_CALLOUT_NOTIFY_TYPE_MAX 无意义 测试用</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST PGUID filterKey, <span class="comment">//过滤器标识 只有notifyType为FWPS_CALLOUT_NOTIFY_ADD_FILTER时该值才非空</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST FWPS_FILTER1* filter <span class="comment">//将要添加或删除的过滤器</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;<span class="comment">//STATUS_SUCCESS表示回调函数接受该事件 其他错误码表示回调函数不接受</span></span><br><span class="line"><span class="comment">//返回错误码时 添加时过滤器不添加到过滤引擎中 删除时也会从过滤引擎中删除</span></span><br></pre></td></tr></table></figure>

<p>当一个网络数据流将要被终止，且该数据流被关联了上下文时，flowDeleteFn被回调，可在该回调函数中清理关联的上下文：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">VOID NTAPI <span class="title">flowDeleteFn</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT16 layerId, <span class="comment">//分层标识</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT32 calloutId, <span class="comment">//相应呼出接口</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT64 flowContext <span class="comment">//关联的上下文指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="WFP操作"><a href="#WFP操作" class="headerlink" title="WFP操作"></a>WFP操作</h2><p>开发者在内核态用WFP提供的API实现网络数据包过滤，分为步骤如下：定义一个或多个呼出接口，向过滤引擎注册呼出接口；添加呼出接口到过滤引擎；设计一个或多个子层，将子层添加到分层中；设计过滤器，把呼出接口、子层、分层和过滤器关联起来。</p>
<p>注册呼出接口时可用<code>FwpsCalloutRegister2</code>，定义如下。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">FwpsCalloutRegister2</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _Inout_ PVOID deviceObject, <span class="comment">//呼出接口驱动创建的设备对象指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST FWPS_CALLOUT2* callout, <span class="comment">//呼出几口对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PUINT32 calloutId <span class="comment">//呼出接口ID 运行时标识</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;<span class="comment">//成功注册STATUS_SUCCESS 已注册STATUS_FWP_ALREADY_EXISTS 其他错误码则发生错误</span></span><br></pre></td></tr></table></figure>

<p>卸载呼出接口用<code>FwpsCalloutUnregisterById</code>或<code>FwpsCalloutUnregisterByKey</code>。前者通过指定呼出接口的运行时标识来对呼出接口进行卸载，后者通过指定呼出接口的GUID来对呼出接口进行卸载。</p>
<p>注册呼出接口后，需要把呼出接口添加到过滤引擎中，在此之前得先用<code>FwpmEngineOpen0</code>打开过滤引擎。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">FwpmEngineOpen0</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ CONST <span class="type">wchar_t</span>* serverName, <span class="comment">//呼出接口驱动必为NULL</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ UINT32 authnService, <span class="comment">//认证服务 呼出接口驱动必为RPC_C_AUTHN_WINNT或RPC_C_AUTHN_DEFAULT</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ SEC_WINNT_AUTH_IDENTIFY_W* authIdentify,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ CONST FWPM_SESSION0* session, <span class="comment">//Session信息</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ HANDLE* engineHandle <span class="comment">//返回打开的过滤引擎句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>用<code>FwpmCalloutAdd0</code>将呼出接口添加到过滤引擎中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">FwpmCalloutAdd0</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE engineHandle, <span class="comment">//过滤引擎句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST FWPM_CALLOUT0* callout, <span class="comment">//呼出接口指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PSECURITY_DESCRIPTOR sd, <span class="comment">//安全描述符</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _out_opt_ PUINT32 id <span class="comment">//返回ID 可用该ID移除已添加的呼出接口</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功添加STATUS_SUCCESS 有相同呼出接口已添加STATUS_FWP_ALREADY_EXISTS 其他错误返回错误码</span></span><br></pre></td></tr></table></figure>

<p>用<code>FwpmCalloutDeleteById0</code>或<code>FwpmCalloutDeleteByKey0</code>可移除添加到过滤引擎中的呼出接口。</p>
<p>用<code>FwpmSubLayerAdd0</code>添加子层：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">FwpmSubLayerAdd0</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE engineHandle, <span class="comment">//过滤引擎句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST FWPM_SUBLAYER0* subLayer, <span class="comment">//要添加的子层对象指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PSECURITY_DESCRIPTOR sd <span class="comment">//安全描述符</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功ERROR_SUCCESS 失败返回错误码</span></span><br></pre></td></tr></table></figure>

<p>用<code>FwpmFilterAdd0</code>添加过滤器：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">FwpmFilterAdd0</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE engineHandle, <span class="comment">//过滤引擎句柄</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ CONST FWPM_FILTER0* filter, <span class="comment">//要添加的过滤器对象指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ PSECURITY_DESCRIPTOR sd, <span class="comment">//安全描述符</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_opt_ PUINT64 id <span class="comment">//成功添加后返回分配的Id来唯一标识该过滤器</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>; <span class="comment">//成功ERROR_SUCCESS 失败返回错误码</span></span><br></pre></td></tr></table></figure>

<p>移除过滤器用<code>FwpmFilterDeleteById0</code>或<code>FwpmFilterDeleteByKey0</code>。</p>
<h2 id="WFP例子"><a href="#WFP例子" class="headerlink" title="WFP例子"></a>WFP例子</h2><p>拦截TCP协议对外连接80端口。驱动入口函数实现：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(__in <span class="keyword">struct</span> _DRIVER_OBJECT* DriverObject, __in PUNICODE_STRING RegistryPath)</span> </span>&#123;</span><br><span class="line">	NTSTATUS nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="built_in">UNREFERENCED_PARAMETER</span>(RegistryPath);</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (DriverObject == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = WfpSampleIRPDispatch;</span><br><span class="line">		DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = WfpSampleIRPDispatch;</span><br><span class="line">		DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = WfpSampleIRPDispatch;</span><br><span class="line">		<span class="keyword">if</span> (FALSE == <span class="built_in">InitRuleInfo</span>())</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		g_pDeviceObj = <span class="built_in">CreateDevice</span>(DriverObject); <span class="comment">//创建设备对象</span></span><br><span class="line">		<span class="keyword">if</span> (g_pDeviceObj == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">InitWfp</span>() != STATUS_SUCCESS) <span class="comment">//初始化WFP所有操作</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">		nStatus = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">if</span> (nStatus != STATUS_SUCCESS) &#123;</span><br><span class="line">		<span class="built_in">UninitWfp</span>();</span><br><span class="line">		<span class="built_in">DeleteDevice</span>();</span><br><span class="line">		<span class="built_in">UninitRuleInfo</span>();</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">InitWfp</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	NTSTATUS nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		g_hEngine = <span class="built_in">OpenEngine</span>(); <span class="comment">//打开过滤引擎 获取句柄</span></span><br><span class="line">		<span class="keyword">if</span> (g_hEngine == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != <span class="built_in">WfpRegisterCallouts</span>(g_pDeviceObj)) <span class="comment">//向过滤引擎注册呼出接口</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != <span class="built_in">WfpAddCallouts</span>()) <span class="comment">//向过滤引擎添加呼出接口</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != <span class="built_in">WfpAddSubLayer</span>()) <span class="comment">//向过滤引擎添加子层</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != <span class="built_in">WfpAddFilters</span>()) <span class="comment">//向过滤引擎添加过滤器</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		nStatus = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">HANDLE <span class="title">OpenEngine</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	FWPM_SESSION0 Session = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	HANDLE hEngine = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="built_in">FwpmEngineOpen</span>(<span class="literal">NULL</span>, RPC_C_AUTHN_WINNT, <span class="literal">NULL</span>, &amp;Session, &amp;hEngine); <span class="comment">//打开过滤引擎 返回句柄</span></span><br><span class="line">	<span class="keyword">return</span> hEngine;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">DEFINE_GUID</span>(WFP_SAMPLE_ESTABLISHED_CALLOUT_V4_GUID, <span class="number">0xd969fc67</span>, <span class="number">0x6fb2</span>, <span class="number">0x4504</span>, <span class="number">0x91</span>, <span class="number">0xce</span>, <span class="number">0xa9</span>, <span class="number">0x7c</span>, <span class="number">0x3c</span>, <span class="number">0x32</span>, <span class="number">0xad</span>, <span class="number">0x36</span>); <span class="comment">// &#123;D969FC67-6FB2-4504-91CE-A97C3C32AD36&#125;</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpRegisterCallouts</span><span class="params">(IN OUT PVOID deviceObject)</span> </span>&#123; <span class="comment">//设备对象指针</span></span><br><span class="line">	NTSTATUS status = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (deviceObject == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		status = <span class="built_in">WfpRegisterCalloutImple</span>(deviceObject, Wfp_Sample_Established_ClassifyFn_V4, Wfp_Sample_Established_NotifyFn_V4, Wfp_Sample_Established_FlowDeleteFn_V4, &amp;WFP_SAMPLE_ESTABLISHED_CALLOUT_V4_GUID, <span class="number">0</span>, &amp;g_uFwpsEstablishedCallOutId); <span class="comment">//注册呼出接口 有仨回调函数 还有个GUID</span></span><br><span class="line">		<span class="keyword">if</span> (status != STATUS_SUCCESS)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		status = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpRegisterCalloutImple</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN OUT <span class="type">void</span>* deviceObject, <span class="comment">//设备对象指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    IN  FWPS_CALLOUT_CLASSIFY_FN ClassifyFunction, IN  FWPS_CALLOUT_NOTIFY_FN NotifyFunction, IN  FWPS_CALLOUT_FLOW_DELETE_NOTIFY_FN FlowDeleteFunction, IN  GUID <span class="type">const</span>* calloutKey, IN  UINT32 flags, OUT UINT32* calloutId)</span> </span>&#123;</span><br><span class="line">	FWPS_CALLOUT sCallout;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;sCallout, <span class="number">0</span>, <span class="built_in">sizeof</span>(FWPS_CALLOUT));</span><br><span class="line">	sCallout.calloutKey = *calloutKey;</span><br><span class="line">	sCallout.flags = flags;</span><br><span class="line">	sCallout.classifyFn = ClassifyFunction;</span><br><span class="line">	sCallout.notifyFn = NotifyFunction;</span><br><span class="line">	sCallout.flowDeleteFn = FlowDeleteFunction;</span><br><span class="line">	status = <span class="built_in">FwpsCalloutRegister</span>(deviceObject, &amp;sCallout, calloutId);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">DEFINE_GUID</span>(WFP_SAMPLE_SUBLAYER_GUID,<span class="number">0xed6a516a</span>, <span class="number">0x36d1</span>, <span class="number">0x4881</span>, <span class="number">0xbc</span>, <span class="number">0xf0</span>, <span class="number">0xac</span>, <span class="number">0xeb</span>, <span class="number">0x4c</span>, <span class="number">0x4</span>, <span class="number">0xc2</span>, <span class="number">0x1c</span>); <span class="comment">// &#123;ED6A516A-36D1-4881-BCF0-ACEB4C04C21C&#125;</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddCallouts</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">	FWPM_CALLOUT fwpmCallout = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	fwpmCallout.flags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (g_hEngine == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		fwpmCallout.displayData.name = (<span class="type">wchar_t</span>*)WFP_SAMPLE_ESTABLISHED_CALLOUT_DISPLAY_NAME;</span><br><span class="line">		fwpmCallout.displayData.description = (<span class="type">wchar_t</span>*)WFP_SAMPLE_ESTABLISHED_CALLOUT_DISPLAY_NAME;</span><br><span class="line">		fwpmCallout.calloutKey = WFP_SAMPLE_ESTABLISHED_CALLOUT_V4_GUID; <span class="comment">//GUID</span></span><br><span class="line">		fwpmCallout.applicableLayer = FWPM_LAYER_ALE_FLOW_ESTABLISHED_V4; <span class="comment">//网络连接的建立 该分层属于ALE层 WFP维护数据包状态 如连接状态</span></span><br><span class="line">		status = <span class="built_in">FwpmCalloutAdd</span>(g_hEngine, &amp;fwpmCallout, <span class="literal">NULL</span>, &amp;g_uFwpmEstablishedCallOutId);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status) &amp;&amp; (status != STATUS_FWP_ALREADY_EXISTS))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		status = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddSubLayer</span><span class="params">(VOID)</span> </span>&#123; <span class="comment">//向过滤引擎增加一个分层 权重为65535</span></span><br><span class="line">	NTSTATUS nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	FWPM_SUBLAYER SubLayer = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	SubLayer.flags = <span class="number">0</span>;</span><br><span class="line">	SubLayer.displayData.description = WFP_SAMPLE_SUB_LAYER_DISPLAY_NAME;</span><br><span class="line">	SubLayer.displayData.name = WFP_SAMPLE_SUB_LAYER_DISPLAY_NAME;</span><br><span class="line">	SubLayer.subLayerKey = WFP_SAMPLE_SUBLAYER_GUID;</span><br><span class="line">	SubLayer.weight = <span class="number">65535</span>;</span><br><span class="line">	<span class="keyword">if</span> (g_hEngine != <span class="literal">NULL</span>)</span><br><span class="line">		nStatus = <span class="built_in">FwpmSubLayerAdd</span>(g_hEngine, &amp;SubLayer, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddFilters</span><span class="params">(VOID)</span> </span>&#123; <span class="comment">//向过滤引擎添加一个过滤器 并和之前定义的呼出接口、子层等关联</span></span><br><span class="line">	NTSTATUS nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		FWPM_FILTER0 Filter = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		FWPM_FILTER_CONDITION FilterCondition[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		FWP_V4_ADDR_AND_MASK AddrAndMask = &#123; <span class="number">0</span> &#125;; <span class="comment">//0</span></span><br><span class="line">		<span class="keyword">if</span> (g_hEngine == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		Filter.displayData.description = WFP_SAMPLE_FILTER_ESTABLISH_DISPLAY_NAME;</span><br><span class="line">		Filter.displayData.name = WFP_SAMPLE_FILTER_ESTABLISH_DISPLAY_NAME;</span><br><span class="line">		Filter.flags = <span class="number">0</span>;</span><br><span class="line">		Filter.layerKey = FWPM_LAYER_ALE_FLOW_ESTABLISHED_V4; <span class="comment">//分层GUID</span></span><br><span class="line">		Filter.subLayerKey = WFP_SAMPLE_SUBLAYER_GUID; <span class="comment">//子层GUID</span></span><br><span class="line">		Filter.weight.type = FWP_EMPTY; <span class="comment">//添加到过滤引擎中后 自动分配一个权重</span></span><br><span class="line">		Filter.numFilterConditions = <span class="number">1</span>;</span><br><span class="line">		Filter.filterCondition = FilterCondition; <span class="comment">//过滤器条件</span></span><br><span class="line">		Filter.action.type = FWP_ACTION_CALLOUT_TERMINATING; <span class="comment">//过滤器动作类型 和呼出接口关联 后者回调函数总返回允许或拦截</span></span><br><span class="line">		Filter.action.calloutKey = WFP_SAMPLE_ESTABLISHED_CALLOUT_V4_GUID; <span class="comment">//呼出接口GUID</span></span><br><span class="line">		FilterCondition[<span class="number">0</span>].fieldKey = FWPM_CONDITION_IP_REMOTE_ADDRESS; <span class="comment">//检查字段为远程IP地址</span></span><br><span class="line">		FilterCondition[<span class="number">0</span>].matchType = FWP_MATCH_EQUAL;</span><br><span class="line">		FilterCondition[<span class="number">0</span>].conditionValue.type = FWP_V4_ADDR_MASK;</span><br><span class="line">		FilterCondition[<span class="number">0</span>].conditionValue.v4AddrMask = &amp;AddrAndMask; <span class="comment">//所有网络数据包都能匹配该过滤条件</span></span><br><span class="line">		nStatus = <span class="built_in">FwpmFilterAdd</span>(g_hEngine, &amp;Filter, <span class="literal">NULL</span>, &amp;g_uEstablishedFilterId);</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != nStatus)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		nStatus = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID NTAPI <span class="title">Wfp_Sample_Established_ClassifyFn_V4</span><span class="params">(IN <span class="type">const</span> FWPS_INCOMING_VALUES* inFixedValues, IN <span class="type">const</span> FWPS_INCOMING_METADATA_VALUES* inMetaValues, IN OUT VOID* layerData, IN OPTIONAL <span class="type">const</span> <span class="type">void</span>* classifyContext, IN <span class="type">const</span> FWPS_FILTER1* filter, IN UINT64  flowContext, OUT FWPS_CLASSIFY_OUT* classifyOut)</span> </span>&#123; <span class="comment">//回调函数</span></span><br><span class="line">	WORD	wDirection = <span class="number">0</span>;</span><br><span class="line">	WORD	wRemotePort = <span class="number">0</span>;</span><br><span class="line">	WORD	wSrcPort = <span class="number">0</span>;</span><br><span class="line">	WORD	wProtocol = <span class="number">0</span>;</span><br><span class="line">	ULONG	ulSrcIPAddress = <span class="number">0</span>;</span><br><span class="line">	ULONG	ulRemoteIPAddress = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (!(classifyOut-&gt;rights &amp; FWPS_RIGHT_ACTION_WRITE))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="comment">//wDirection表示数据包的方向,取值为	//FWP_DIRECTION_INBOUND/FWP_DIRECTION_OUTBOUND</span></span><br><span class="line">	wDirection = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_DIRECTION].value.int8;</span><br><span class="line">	<span class="comment">//wSrcPort表示本地端口，主机序</span></span><br><span class="line">	wSrcPort = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_LOCAL_PORT].value.uint16;</span><br><span class="line">	<span class="comment">//wRemotePort表示远端端口，主机序</span></span><br><span class="line">	wRemotePort = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_REMOTE_PORT].value.uint16;</span><br><span class="line">	<span class="comment">//ulSrcIPAddress 表示源IP</span></span><br><span class="line">	ulSrcIPAddress = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_LOCAL_ADDRESS].value.uint32;</span><br><span class="line">	<span class="comment">//ulRemoteIPAddress 表示远端IP</span></span><br><span class="line">	ulRemoteIPAddress = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_REMOTE_ADDRESS].value.uint32;</span><br><span class="line">	<span class="comment">//wProtocol表示网络协议，可以取值是IPPROTO_ICMP/IPPROTO_UDP/IPPROTO_TCP</span></span><br><span class="line">	wProtocol = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_PROTOCOL].value.uint8;</span><br><span class="line">	<span class="comment">//默认&quot;允许&quot;(PERMIT)</span></span><br><span class="line">	classifyOut-&gt;actionType = FWP_ACTION_PERMIT;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsHitRule</span>(wRemotePort))</span><br><span class="line">		classifyOut-&gt;actionType = FWP_ACTION_BLOCK;</span><br><span class="line">	<span class="comment">//简单的策略判断，读者可以重写这部分</span></span><br><span class="line"><span class="comment">// 	if( (wProtocol == IPPROTO_TCP) &amp;&amp; (wDirection == FWP_DIRECTION_OUTBOUND) &amp;&amp; (wRemotePort == HTTP_DEFAULT_PORT) ) &#123;</span></span><br><span class="line"><span class="comment">// 		//TCP协议尝试发起80端口的访问，拦截(BLOCK)</span></span><br><span class="line"><span class="comment">// 		classifyOut-&gt;actionType = FWP_ACTION_BLOCK;</span></span><br><span class="line"><span class="comment">// 	&#125;;</span></span><br><span class="line">	<span class="comment">//清除FWPS_RIGHT_ACTION_WRITE标记</span></span><br><span class="line">	<span class="keyword">if</span> (filter-&gt;flags &amp; FWPS_FILTER_FLAG_CLEAR_ACTION_RIGHT)</span><br><span class="line">		classifyOut-&gt;rights &amp;= ~FWPS_RIGHT_ACTION_WRITE;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h2><p>WfpSample.c：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NDIS630</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ntddk.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fwpmk.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fwpsk.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INITGUID</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;guiddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;WfpSample.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Fwpmu.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Rule.h&quot;</span></span></span><br><span class="line"><span class="comment">//本例子只是为了介绍WFP的用法，在实际应用中，如果只是根据简单的规则拦截数据包的话，可以通过添加过滤器的方法实现。</span></span><br><span class="line">PDEVICE_OBJECT g_pDeviceObj = <span class="literal">NULL</span>;</span><br><span class="line">UINT32	g_uFwpsEstablishedCallOutId = <span class="number">0</span>;</span><br><span class="line">UINT32	g_uFwpmEstablishedCallOutId = <span class="number">0</span>;</span><br><span class="line">UINT64 g_uEstablishedFilterId = <span class="number">0</span>;</span><br><span class="line">HANDLE	g_hEngine = <span class="literal">NULL</span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(__in <span class="keyword">struct</span> _DRIVER_OBJECT* DriverObject, __in PUNICODE_STRING RegistryPath)</span> </span>&#123;</span><br><span class="line">	NTSTATUS nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="built_in">UNREFERENCED_PARAMETER</span>(RegistryPath);</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (DriverObject == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = WfpSampleIRPDispatch;</span><br><span class="line">		DriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = WfpSampleIRPDispatch;</span><br><span class="line">		DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = WfpSampleIRPDispatch;</span><br><span class="line">		<span class="keyword">if</span> (FALSE == <span class="built_in">InitRuleInfo</span>())</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		g_pDeviceObj = <span class="built_in">CreateDevice</span>(DriverObject);</span><br><span class="line">		<span class="keyword">if</span> (g_pDeviceObj == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">InitWfp</span>() != STATUS_SUCCESS)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">		nStatus = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">if</span> (nStatus != STATUS_SUCCESS) &#123;</span><br><span class="line">		<span class="built_in">UninitWfp</span>();</span><br><span class="line">		<span class="built_in">DeleteDevice</span>();</span><br><span class="line">		<span class="built_in">UninitRuleInfo</span>();</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpSampleIRPDispatch</span><span class="params">(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)</span> </span>&#123;</span><br><span class="line">	NTSTATUS nStatus = STATUS_SUCCESS;</span><br><span class="line">	ULONG	ulInformation = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">UNREFERENCED_PARAMETER</span>(DeviceObject);</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		PIO_STACK_LOCATION	IrpStack = <span class="literal">NULL</span>;</span><br><span class="line">		PVOID pSystemBuffer = <span class="literal">NULL</span>;</span><br><span class="line">		ULONG uInLen = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (Irp == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		pSystemBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">		IrpStack = <span class="built_in">IoGetCurrentIrpStackLocation</span>(Irp);</span><br><span class="line">		<span class="keyword">if</span> (IrpStack == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		uInLen = IrpStack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">		<span class="keyword">if</span> (IrpStack-&gt;MajorFunction != IRP_MJ_DEVICE_CONTROL)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">// 开始处理DeivceIoControl的情况</span></span><br><span class="line">		<span class="keyword">switch</span> (IrpStack-&gt;Parameters.DeviceIoControl.IoControlCode) &#123;</span><br><span class="line">			<span class="keyword">case</span> IOCTL_WFP_SAMPLE_ADD_RULE:&#123;</span><br><span class="line">				BOOLEAN bSucc = FALSE;</span><br><span class="line">				bSucc = <span class="built_in">AddNetRuleInfo</span>(pSystemBuffer, uInLen);</span><br><span class="line">				<span class="keyword">if</span> (bSucc == FALSE)</span><br><span class="line">					nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="keyword">default</span>:&#123;</span><br><span class="line">				ulInformation = <span class="number">0</span>;</span><br><span class="line">				nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">if</span> (Irp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		Irp-&gt;IoStatus.Information = ulInformation;</span><br><span class="line">		Irp-&gt;IoStatus.Status = nStatus;</span><br><span class="line">		<span class="built_in">IoCompleteRequest</span>(Irp, IO_NO_INCREMENT);</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">PDEVICE_OBJECT	<span class="title">CreateDevice</span><span class="params">(__in <span class="keyword">struct</span> _DRIVER_OBJECT* DriverObject)</span> </span>&#123;</span><br><span class="line">	UNICODE_STRING	uDeviceName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	UNICODE_STRING	uSymbolName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	PDEVICE_OBJECT	pDeviceObj = <span class="literal">NULL</span>;</span><br><span class="line">	NTSTATUS nStatsus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;uDeviceName, WFP_DEVICE_NAME);</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;uSymbolName, WFP_SYM_LINK_NAME);</span><br><span class="line">	nStatsus = <span class="built_in">IoCreateDevice</span>(DriverObject, <span class="number">0</span>, &amp;uDeviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, FALSE, &amp;pDeviceObj);</span><br><span class="line">	<span class="keyword">if</span> (pDeviceObj != <span class="literal">NULL</span>)</span><br><span class="line">		pDeviceObj-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">	<span class="built_in">IoCreateSymbolicLink</span>(&amp;uSymbolName, &amp;uDeviceName);</span><br><span class="line">	<span class="keyword">return</span> pDeviceObj;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">DeleteDevice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	UNICODE_STRING uSymbolName = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;uSymbolName, WFP_SYM_LINK_NAME);</span><br><span class="line">	<span class="built_in">IoDeleteSymbolicLink</span>(&amp;uSymbolName);</span><br><span class="line">	<span class="keyword">if</span> (g_pDeviceObj != <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">IoDeleteDevice</span>(g_pDeviceObj);</span><br><span class="line">	g_pDeviceObj = <span class="literal">NULL</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">InitWfp</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	NTSTATUS nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		g_hEngine = <span class="built_in">OpenEngine</span>();</span><br><span class="line">		<span class="keyword">if</span> (g_hEngine == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != <span class="built_in">WfpRegisterCallouts</span>(g_pDeviceObj))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != <span class="built_in">WfpAddCallouts</span>())</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != <span class="built_in">WfpAddSubLayer</span>())</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != <span class="built_in">WfpAddFilters</span>())</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		nStatus = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">UninitWfp</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">WfpRemoveFilters</span>();</span><br><span class="line">	<span class="built_in">WfpRemoveSubLayer</span>();</span><br><span class="line">	<span class="built_in">WfpRemoveCallouts</span>();</span><br><span class="line">	<span class="built_in">WfpUnRegisterCallouts</span>();</span><br><span class="line">	<span class="built_in">CloseEngine</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID  <span class="title">DriverUnload</span><span class="params">(__in <span class="keyword">struct</span> _DRIVER_OBJECT* DriverObject)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">UninitWfp</span>();</span><br><span class="line">	<span class="built_in">DeleteDevice</span>();</span><br><span class="line">	<span class="built_in">UninitRuleInfo</span>();</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">HANDLE <span class="title">OpenEngine</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	FWPM_SESSION0 Session = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	HANDLE hEngine = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="built_in">FwpmEngineOpen</span>(<span class="literal">NULL</span>, RPC_C_AUTHN_WINNT, <span class="literal">NULL</span>, &amp;Session, &amp;hEngine);</span><br><span class="line">	<span class="keyword">return</span> hEngine;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">CloseEngine</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (g_hEngine != <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">FwpmEngineClose</span>(g_hEngine);</span><br><span class="line">	g_hEngine = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpRegisterCalloutImple</span><span class="params">(IN OUT <span class="type">void</span>* deviceObject, IN  FWPS_CALLOUT_CLASSIFY_FN ClassifyFunction, IN  FWPS_CALLOUT_NOTIFY_FN NotifyFunction, IN  FWPS_CALLOUT_FLOW_DELETE_NOTIFY_FN FlowDeleteFunction, IN  GUID <span class="type">const</span>* calloutKey, IN  UINT32 flags, OUT UINT32* calloutId)</span> </span>&#123;</span><br><span class="line">	FWPS_CALLOUT sCallout;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;sCallout, <span class="number">0</span>, <span class="built_in">sizeof</span>(FWPS_CALLOUT));</span><br><span class="line">	sCallout.calloutKey = *calloutKey;</span><br><span class="line">	sCallout.flags = flags;</span><br><span class="line">	sCallout.classifyFn = ClassifyFunction;</span><br><span class="line">	sCallout.notifyFn = NotifyFunction;</span><br><span class="line">	sCallout.flowDeleteFn = FlowDeleteFunction;</span><br><span class="line">	status = <span class="built_in">FwpsCalloutRegister</span>(deviceObject, &amp;sCallout, calloutId);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpRegisterCallouts</span><span class="params">(IN OUT PVOID deviceObject)</span> </span>&#123;</span><br><span class="line">	NTSTATUS status = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (deviceObject == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		status = <span class="built_in">WfpRegisterCalloutImple</span>(deviceObject, Wfp_Sample_Established_ClassifyFn_V4, Wfp_Sample_Established_NotifyFn_V4, Wfp_Sample_Established_FlowDeleteFn_V4, &amp;WFP_SAMPLE_ESTABLISHED_CALLOUT_V4_GUID, <span class="number">0</span>, &amp;g_uFwpsEstablishedCallOutId);</span><br><span class="line">		<span class="keyword">if</span> (status != STATUS_SUCCESS)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		status = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">WfpUnRegisterCallouts</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">FwpsCalloutUnregisterById</span>(g_uFwpsEstablishedCallOutId);</span><br><span class="line">	g_uFwpsEstablishedCallOutId = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddCallouts</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">	FWPM_CALLOUT fwpmCallout = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	fwpmCallout.flags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (g_hEngine == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		fwpmCallout.displayData.name = (<span class="type">wchar_t</span>*)WFP_SAMPLE_ESTABLISHED_CALLOUT_DISPLAY_NAME;</span><br><span class="line">		fwpmCallout.displayData.description = (<span class="type">wchar_t</span>*)WFP_SAMPLE_ESTABLISHED_CALLOUT_DISPLAY_NAME;</span><br><span class="line">		fwpmCallout.calloutKey = WFP_SAMPLE_ESTABLISHED_CALLOUT_V4_GUID;</span><br><span class="line">		fwpmCallout.applicableLayer = FWPM_LAYER_ALE_FLOW_ESTABLISHED_V4;</span><br><span class="line">		status = <span class="built_in">FwpmCalloutAdd</span>(g_hEngine, &amp;fwpmCallout, <span class="literal">NULL</span>, &amp;g_uFwpmEstablishedCallOutId);</span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status) &amp;&amp; (status != STATUS_FWP_ALREADY_EXISTS))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		status = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">WfpRemoveCallouts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (g_hEngine != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">FwpmCalloutDeleteById</span>(g_hEngine, g_uFwpmEstablishedCallOutId);</span><br><span class="line">		g_uFwpmEstablishedCallOutId = <span class="number">0</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddSubLayer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	NTSTATUS nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	FWPM_SUBLAYER SubLayer = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	SubLayer.flags = <span class="number">0</span>;</span><br><span class="line">	SubLayer.displayData.description = WFP_SAMPLE_SUB_LAYER_DISPLAY_NAME;</span><br><span class="line">	SubLayer.displayData.name = WFP_SAMPLE_SUB_LAYER_DISPLAY_NAME;</span><br><span class="line">	SubLayer.subLayerKey = WFP_SAMPLE_SUBLAYER_GUID;</span><br><span class="line">	SubLayer.weight = <span class="number">65535</span>;</span><br><span class="line">	<span class="keyword">if</span> (g_hEngine != <span class="literal">NULL</span>)</span><br><span class="line">		nStatus = <span class="built_in">FwpmSubLayerAdd</span>(g_hEngine, &amp;SubLayer, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">WfpRemoveSubLayer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (g_hEngine != <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">FwpmSubLayerDeleteByKey</span>(g_hEngine, &amp;WFP_SAMPLE_SUBLAYER_GUID);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddFilters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	NTSTATUS nStatus = STATUS_UNSUCCESSFUL;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		FWPM_FILTER0 Filter = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		FWPM_FILTER_CONDITION FilterCondition[<span class="number">1</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		FWP_V4_ADDR_AND_MASK AddrAndMask = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">		<span class="keyword">if</span> (g_hEngine == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		Filter.displayData.description = WFP_SAMPLE_FILTER_ESTABLISH_DISPLAY_NAME;</span><br><span class="line">		Filter.displayData.name = WFP_SAMPLE_FILTER_ESTABLISH_DISPLAY_NAME;</span><br><span class="line">		Filter.flags = <span class="number">0</span>;</span><br><span class="line">		Filter.layerKey = FWPM_LAYER_ALE_FLOW_ESTABLISHED_V4;</span><br><span class="line">		Filter.subLayerKey = WFP_SAMPLE_SUBLAYER_GUID;</span><br><span class="line">		Filter.weight.type = FWP_EMPTY;</span><br><span class="line">		Filter.numFilterConditions = <span class="number">1</span>;</span><br><span class="line">		Filter.filterCondition = FilterCondition;</span><br><span class="line">		Filter.action.type = FWP_ACTION_CALLOUT_TERMINATING;</span><br><span class="line">		Filter.action.calloutKey = WFP_SAMPLE_ESTABLISHED_CALLOUT_V4_GUID;</span><br><span class="line">		FilterCondition[<span class="number">0</span>].fieldKey = FWPM_CONDITION_IP_REMOTE_ADDRESS;</span><br><span class="line">		FilterCondition[<span class="number">0</span>].matchType = FWP_MATCH_EQUAL;</span><br><span class="line">		FilterCondition[<span class="number">0</span>].conditionValue.type = FWP_V4_ADDR_MASK;</span><br><span class="line">		FilterCondition[<span class="number">0</span>].conditionValue.v4AddrMask = &amp;AddrAndMask;</span><br><span class="line">		nStatus = <span class="built_in">FwpmFilterAdd</span>(g_hEngine, &amp;Filter, <span class="literal">NULL</span>, &amp;g_uEstablishedFilterId);</span><br><span class="line">		<span class="keyword">if</span> (STATUS_SUCCESS != nStatus)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		nStatus = STATUS_SUCCESS;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> nStatus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">WfpRemoveFilters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (g_hEngine != <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">FwpmFilterDeleteById</span>(g_hEngine, g_uEstablishedFilterId);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID NTAPI <span class="title">Wfp_Sample_Established_ClassifyFn_V4</span><span class="params">(IN <span class="type">const</span> FWPS_INCOMING_VALUES* inFixedValues, IN <span class="type">const</span> FWPS_INCOMING_METADATA_VALUES* inMetaValues, IN OUT VOID* layerData, IN OPTIONAL <span class="type">const</span> <span class="type">void</span>* classifyContext, IN <span class="type">const</span> FWPS_FILTER1* filter, IN UINT64  flowContext, OUT FWPS_CLASSIFY_OUT* classifyOut)</span> </span>&#123;</span><br><span class="line">	WORD	wDirection = <span class="number">0</span>;</span><br><span class="line">	WORD	wRemotePort = <span class="number">0</span>;</span><br><span class="line">	WORD	wSrcPort = <span class="number">0</span>;</span><br><span class="line">	WORD	wProtocol = <span class="number">0</span>;</span><br><span class="line">	ULONG	ulSrcIPAddress = <span class="number">0</span>;</span><br><span class="line">	ULONG	ulRemoteIPAddress = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (!(classifyOut-&gt;rights &amp; FWPS_RIGHT_ACTION_WRITE))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="comment">//wDirection表示数据包的方向,取值为	//FWP_DIRECTION_INBOUND/FWP_DIRECTION_OUTBOUND</span></span><br><span class="line">	wDirection = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_DIRECTION].value.int8;</span><br><span class="line">	<span class="comment">//wSrcPort表示本地端口，主机序</span></span><br><span class="line">	wSrcPort = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_LOCAL_PORT].value.uint16;</span><br><span class="line">	<span class="comment">//wRemotePort表示远端端口，主机序</span></span><br><span class="line">	wRemotePort = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_REMOTE_PORT].value.uint16;</span><br><span class="line">	<span class="comment">//ulSrcIPAddress 表示源IP</span></span><br><span class="line">	ulSrcIPAddress = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_LOCAL_ADDRESS].value.uint32;</span><br><span class="line">	<span class="comment">//ulRemoteIPAddress 表示远端IP</span></span><br><span class="line">	ulRemoteIPAddress = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_REMOTE_ADDRESS].value.uint32;</span><br><span class="line">	<span class="comment">//wProtocol表示网络协议，可以取值是IPPROTO_ICMP/IPPROTO_UDP/IPPROTO_TCP</span></span><br><span class="line">	wProtocol = inFixedValues-&gt;incomingValue[FWPS_FIELD_ALE_FLOW_ESTABLISHED_V4_IP_PROTOCOL].value.uint8;</span><br><span class="line">	<span class="comment">//默认&quot;允许&quot;(PERMIT)</span></span><br><span class="line">	classifyOut-&gt;actionType = FWP_ACTION_PERMIT;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsHitRule</span>(wRemotePort))</span><br><span class="line">		classifyOut-&gt;actionType = FWP_ACTION_BLOCK;</span><br><span class="line">	<span class="comment">//简单的策略判断，读者可以重写这部分</span></span><br><span class="line"><span class="comment">// 	if( (wProtocol == IPPROTO_TCP) &amp;&amp; (wDirection == FWP_DIRECTION_OUTBOUND) &amp;&amp; (wRemotePort == HTTP_DEFAULT_PORT) ) &#123;</span></span><br><span class="line"><span class="comment">// 		//TCP协议尝试发起80端口的访问，拦截(BLOCK)</span></span><br><span class="line"><span class="comment">// 		classifyOut-&gt;actionType = FWP_ACTION_BLOCK;</span></span><br><span class="line"><span class="comment">// 	&#125;;</span></span><br><span class="line">	<span class="comment">//清除FWPS_RIGHT_ACTION_WRITE标记</span></span><br><span class="line">	<span class="keyword">if</span> (filter-&gt;flags &amp; FWPS_FILTER_FLAG_CLEAR_ACTION_RIGHT)</span><br><span class="line">		classifyOut-&gt;rights &amp;= ~FWPS_RIGHT_ACTION_WRITE;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">Wfp_Sample_Established_NotifyFn_V4</span><span class="params">(IN  FWPS_CALLOUT_NOTIFY_TYPE        notifyType, IN  <span class="type">const</span> GUID* filterKey, IN  <span class="type">const</span> FWPS_FILTER* filter)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID NTAPI <span class="title">Wfp_Sample_Established_FlowDeleteFn_V4</span><span class="params">(IN UINT16  layerId, IN UINT32  calloutId, IN UINT64  flowContext)</span> </span>&#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>WfpSample.h：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MAX_PATH</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PATH	(260)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WFP_DEVICE_NAME				<span class="string">L&quot;\\Device\\wfp_sample_device&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WFP_SYM_LINK_NAME			<span class="string">L&quot;\\DosDevices\\wfp_sample_device&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WFP_SAMPLE_ESTABLISHED_CALLOUT_DISPLAY_NAME	<span class="string">L&quot;WfpSampleEstablishedCalloutName&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WFP_SAMPLE_SUB_LAYER_DISPLAY_NAME	<span class="string">L&quot;WfpSampleSubLayerName&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WFP_SAMPLE_FILTER_ESTABLISH_DISPLAY_NAME	<span class="string">L&quot;WfpSampleFilterEstablishName&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HTTP_DEFAULT_PORT	80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_WFP_SAMPLE_ADD_RULE CTL_CODE(FILE_DEVICE_UNKNOWN,0x801,METHOD_BUFFERED,FILE_READ_ACCESS | FILE_WRITE_ACCESS)</span></span><br><span class="line"><span class="comment">// &#123;D969FC67-6FB2-4504-91CE-A97C3C32AD36&#125;</span></span><br><span class="line"><span class="built_in">DEFINE_GUID</span>(WFP_SAMPLE_ESTABLISHED_CALLOUT_V4_GUID, <span class="number">0xd969fc67</span>, <span class="number">0x6fb2</span>, <span class="number">0x4504</span>, <span class="number">0x91</span>, <span class="number">0xce</span>, <span class="number">0xa9</span>, <span class="number">0x7c</span>, <span class="number">0x3c</span>, <span class="number">0x32</span>, <span class="number">0xad</span>, <span class="number">0x36</span>);</span><br><span class="line"><span class="comment">// &#123;ED6A516A-36D1-4881-BCF0-ACEB4C04C21C&#125;</span></span><br><span class="line"><span class="built_in">DEFINE_GUID</span>(WFP_SAMPLE_SUBLAYER_GUID,<span class="number">0xed6a516a</span>, <span class="number">0x36d1</span>, <span class="number">0x4881</span>, <span class="number">0xbc</span>, <span class="number">0xf0</span>, <span class="number">0xac</span>, <span class="number">0xeb</span>, <span class="number">0x4c</span>, <span class="number">0x4</span>, <span class="number">0xc2</span>, <span class="number">0x1c</span>);</span><br><span class="line"><span class="comment">/*函数原型声明*/</span></span><br><span class="line"><span class="function"><span class="type">void</span>  <span class="title">DriverUnload</span><span class="params">(__in <span class="keyword">struct</span> _DRIVER_OBJECT* DriverObject)</span></span>;</span><br><span class="line"><span class="function">PDEVICE_OBJECT	<span class="title">CreateDevice</span><span class="params">(__in <span class="keyword">struct</span> _DRIVER_OBJECT* DriverObject)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpSampleIRPDispatch</span><span class="params">(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpRegisterCalloutImple</span><span class="params">(IN OUT <span class="type">void</span>* deviceObject,IN  FWPS_CALLOUT_CLASSIFY_FN ClassifyFunction,IN  FWPS_CALLOUT_NOTIFY_FN NotifyFunction,IN  FWPS_CALLOUT_FLOW_DELETE_NOTIFY_FN FlowDeleteFunction,IN  GUID <span class="type">const</span>* calloutKey,IN  UINT32 flags,OUT UINT32* calloutId)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpRegisterCallouts</span><span class="params">(IN OUT <span class="type">void</span>* deviceObject)</span></span>;</span><br><span class="line"><span class="function">VOID NTAPI <span class="title">Wfp_Sample_Established_ClassifyFn_V4</span><span class="params">(IN <span class="type">const</span> FWPS_INCOMING_VALUES0* inFixedValues,IN <span class="type">const</span> FWPS_INCOMING_METADATA_VALUES0* inMetaValues,IN OUT VOID* layerData,IN OPTIONAL <span class="type">const</span> <span class="type">void</span>* classifyContext,IN <span class="type">const</span> FWPS_FILTER1* filter,IN UINT64  flowContext,OUT FWPS_CLASSIFY_OUT0* classifyOut)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">Wfp_Sample_Established_NotifyFn_V4</span><span class="params">(IN FWPS_CALLOUT_NOTIFY_TYPE notifyType, IN <span class="type">const</span> GUID* filterKey, IN <span class="type">const</span> FWPS_FILTER* filter)</span></span>;</span><br><span class="line"><span class="function">VOID NTAPI <span class="title">Wfp_Sample_Established_FlowDeleteFn_V4</span><span class="params">(IN UINT16 layerId, IN UINT32 calloutId, IN UINT64 flowContext)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddCallouts</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpRegisterCallouts</span><span class="params">(IN OUT <span class="type">void</span>* deviceObject)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpRegisterCalloutImple</span><span class="params">(IN OUT <span class="type">void</span>* deviceObject,IN  FWPS_CALLOUT_CLASSIFY_FN ClassifyFunction,IN  FWPS_CALLOUT_NOTIFY_FN NotifyFunction,IN  FWPS_CALLOUT_FLOW_DELETE_NOTIFY_FN FlowDeleteFunction,IN  GUID <span class="type">const</span>* calloutKey,IN  UINT32 flags,OUT UINT32* calloutId)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddSubLayer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">WfpAddFilters</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">WfpUnRegisterCallouts</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">WfpRemoveCallouts</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">WfpRemoveSubLayer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">WfpRemoveFilters</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">HANDLE <span class="title">OpenEngine</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CloseEngine</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">InitWfp</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">UninitWfp</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VOID <span class="title">DeleteDevice</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>Rule.c：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fltkernel.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Rule.h&quot;</span></span></span><br><span class="line">LIST_ENTRY	g_WfpRuleList = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">KSPIN_LOCK  g_RuleLock = <span class="number">0</span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">InitRuleInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">InitializeListHead</span>(&amp;g_WfpRuleList);</span><br><span class="line">	<span class="built_in">KeInitializeSpinLock</span>(&amp;g_RuleLock);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">UninitRuleInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		KIRQL	OldIRQL = <span class="number">0</span>;</span><br><span class="line">		PLIST_ENTRY pInfo = <span class="literal">NULL</span>;</span><br><span class="line">		PST_WFP_NETINFOLIST pRule = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (g_WfpRuleList.Blink == <span class="literal">NULL</span> || g_WfpRuleList.Flink == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="built_in">KeAcquireSpinLock</span>(&amp;g_RuleLock, &amp;OldIRQL);</span><br><span class="line">		<span class="keyword">while</span> (!<span class="built_in">IsListEmpty</span>(&amp;g_WfpRuleList)) &#123;</span><br><span class="line">			pInfo = <span class="built_in">RemoveHeadList</span>(&amp;g_WfpRuleList);</span><br><span class="line">			<span class="keyword">if</span> (pInfo == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			pRule = <span class="built_in">CONTAINING_RECORD</span>(pInfo, ST_WFP_NETINFOLIST, m_linkPointer);</span><br><span class="line">			<span class="built_in">ExFreePoolWithTag</span>(pRule, WFP_TAG);</span><br><span class="line">			pRule = <span class="literal">NULL</span>;</span><br><span class="line">			pInfo = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="built_in">KeReleaseSpinLock</span>(&amp;g_RuleLock, OldIRQL);</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">AddNetRuleInfo</span><span class="params">(PVOID pBuf, ULONG uLen)</span> </span>&#123;</span><br><span class="line">	BOOLEAN bSucc = FALSE;</span><br><span class="line">	PST_WFP_NETINFO	pRuleInfo = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		PST_WFP_NETINFOLIST pRuleNode = <span class="literal">NULL</span>;</span><br><span class="line">		KIRQL	OldIRQL = <span class="number">0</span>;</span><br><span class="line">		pRuleInfo = (PST_WFP_NETINFO)pBuf;</span><br><span class="line">		<span class="keyword">if</span> (pRuleInfo == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (uLen &lt; <span class="built_in">sizeof</span>(ST_WFP_NETINFO))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		pRuleNode = (PST_WFP_NETINFOLIST)<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool, <span class="built_in">sizeof</span>(ST_WFP_NETINFOLIST), WFP_TAG);</span><br><span class="line">		<span class="keyword">if</span> (pRuleNode == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="built_in">memset</span>(pRuleNode, <span class="number">0</span>, <span class="built_in">sizeof</span>(ST_WFP_NETINFOLIST));</span><br><span class="line">		pRuleNode-&gt;m_stWfpNetInfo.m_uSrcPort = pRuleInfo-&gt;m_uSrcPort;</span><br><span class="line">		pRuleNode-&gt;m_stWfpNetInfo.m_uRemotePort = pRuleInfo-&gt;m_uRemotePort;</span><br><span class="line">		pRuleNode-&gt;m_stWfpNetInfo.m_ulSrcIPAddr = pRuleInfo-&gt;m_ulSrcIPAddr;</span><br><span class="line">		pRuleNode-&gt;m_stWfpNetInfo.m_ulRemoteIPAddr = pRuleInfo-&gt;m_ulRemoteIPAddr;</span><br><span class="line">		pRuleNode-&gt;m_stWfpNetInfo.m_ulNetWorkType = pRuleInfo-&gt;m_ulNetWorkType;</span><br><span class="line">		pRuleNode-&gt;m_stWfpNetInfo.m_uDirection = pRuleInfo-&gt;m_uDirection;</span><br><span class="line">		<span class="built_in">KeAcquireSpinLock</span>(&amp;g_RuleLock, &amp;OldIRQL);</span><br><span class="line">		<span class="built_in">InsertHeadList</span>(&amp;g_WfpRuleList, &amp;pRuleNode-&gt;m_linkPointer);</span><br><span class="line">		<span class="built_in">KeReleaseSpinLock</span>(&amp;g_RuleLock, OldIRQL);</span><br><span class="line">		bSucc = TRUE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> bSucc;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">IsHitRule</span><span class="params">(USHORT uRemotePort)</span> </span>&#123;</span><br><span class="line">	BOOLEAN bIsHit = FALSE;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		KIRQL	OldIRQL = <span class="number">0</span>;</span><br><span class="line">		PLIST_ENTRY	pEntry = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (g_WfpRuleList.Blink == <span class="literal">NULL</span> || g_WfpRuleList.Flink == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="built_in">KeAcquireSpinLock</span>(&amp;g_RuleLock, &amp;OldIRQL);</span><br><span class="line">		pEntry = g_WfpRuleList.Flink;</span><br><span class="line">		<span class="keyword">while</span> (pEntry != &amp;g_WfpRuleList) &#123;</span><br><span class="line">			PST_WFP_NETINFOLIST pInfo = <span class="built_in">CONTAINING_RECORD</span>(pEntry, ST_WFP_NETINFOLIST, m_linkPointer);</span><br><span class="line">			<span class="keyword">if</span> (uRemotePort == pInfo-&gt;m_stWfpNetInfo.m_uRemotePort) &#123;</span><br><span class="line">				bIsHit = TRUE;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;;</span><br><span class="line">			pEntry = pEntry-&gt;Flink;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="built_in">KeReleaseSpinLock</span>(&amp;g_RuleLock, OldIRQL);</span><br><span class="line">	&#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">	<span class="keyword">return</span> bIsHit;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Rule.h：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WFP_TAG	<span class="string">&#x27;wfpT&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(push)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(1)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_tagWfp_NetInfo</span> &#123;</span><br><span class="line">	USHORT      m_uSrcPort;	<span class="comment">//源端口</span></span><br><span class="line">	USHORT      m_uRemotePort;	<span class="comment">//目标端口</span></span><br><span class="line">	ULONG       m_ulSrcIPAddr; <span class="comment">//源地址</span></span><br><span class="line">	ULONG       m_ulRemoteIPAddr; <span class="comment">//目标地址</span></span><br><span class="line">	ULONG       m_ulNetWorkType; <span class="comment">//协议</span></span><br><span class="line">	USHORT		m_uDirection;<span class="comment">//数据包的方向，0表示发送，1表示接收</span></span><br><span class="line">&#125; ST_WFP_NETINFO, * PST_WFP_NETINFO;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_tagWfp_NetInfoList</span> &#123;</span><br><span class="line">	LIST_ENTRY		m_linkPointer;</span><br><span class="line">	ST_WFP_NETINFO	m_stWfpNetInfo;</span><br><span class="line">&#125;ST_WFP_NETINFOLIST, * PST_WFP_NETINFOLIST;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(pop)</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">InitRuleInfo</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">UninitRuleInfo</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">AddNetRuleInfo</span><span class="params">(PVOID pRuleInfo, ULONG uLen)</span></span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">IsHitRule</span><span class="params">(USHORT uRemotePort)</span></span>;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-WFP%E8%BF%87%E6%BB%A4%E5%B9%B3%E5%8F%B0/">https://monoceros406.github.io/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-WFP%E8%BF%87%E6%BB%A4%E5%B9%B3%E5%8F%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://monoceros406.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">逆向工程</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8/" title="Windows驱动开发入门-NDIS协议驱动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows驱动开发入门-NDIS协议驱动</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/08/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%85%A5%E9%97%A8/" title="Java代码审计入门"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Java代码审计入门</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/16/Angr%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/" title="Angr做题笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="title">Angr做题笔记</div></div></a></div><div><a href="/2023/10/29/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%AC%94%E8%AE%B0/" title="Angr符号执行笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">Angr符号执行笔记</div></div></a></div><div><a href="/2024/01/13/Artfuscator%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/" title="Artfuscator使用方法"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-13</div><div class="title">Artfuscator使用方法</div></div></a></div><div><a href="/2023/11/09/C-%E7%97%85%E6%AF%92%E6%8A%80%E6%9C%AF/" title="C++病毒技术"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="title">C++病毒技术</div></div></a></div><div><a href="/2024/03/10/C-%E9%80%86%E5%90%91%E5%B8%B8%E8%A7%81%E9%A2%98%E5%9E%8B/" title="C#逆向常见题型"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-10</div><div class="title">C#逆向常见题型</div></div></a></div><div><a href="/2024/01/28/CheatEngine%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/" title="CheatEngine基本操作"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-28</div><div class="title">CheatEngine基本操作</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">智邮普创工作室安全组（退役）/Nepnep联合战队</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">303</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://monoceros406.github.io/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">哪里排版出锅了请告诉我QwQ  QQ:1295625063</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-WFP%E8%BF%87%E6%BB%A4%E5%B9%B3%E5%8F%B0"><span class="toc-number">1.</span> <span class="toc-text">Windows驱动开发入门-WFP过滤平台</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A2%8E%E7%A2%8E%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">碎碎念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">基本对象模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WFP%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.</span> <span class="toc-text">WFP操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WFP%E4%BE%8B%E5%AD%90"><span class="toc-number">1.4.</span> <span class="toc-text">WFP例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">1.5.</span> <span class="toc-text">实例代码</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/07/OpenSSL%E5%85%A5%E9%97%A8-%E6%9D%82%E5%87%91%E5%87%BD%E6%95%B0/" title="OpenSSL入门-杂凑函数">OpenSSL入门-杂凑函数</a><time datetime="2024-12-07T13:20:16.000Z" title="发表于 2024-12-07 21:20:16">2024-12-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/05/WindowsAPI%E7%BC%96%E7%A8%8B%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF-%E5%86%85%E6%A0%B8%E6%9E%9A%E4%B8%BE/" title="WindowsAPI编程核心技术-内核枚举">WindowsAPI编程核心技术-内核枚举</a><time datetime="2024-12-05T01:34:52.000Z" title="发表于 2024-12-05 09:34:52">2024-12-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/30/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E5%AE%89%E5%85%A8%E8%BF%9B%E9%98%B6/" title="Windows驱动开发入门-安全进阶">Windows驱动开发入门-安全进阶</a><time datetime="2024-11-30T08:52:59.000Z" title="发表于 2024-11-30 16:52:59">2024-11-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/29/UEFI%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E5%9B%BE%E5%BD%A2%E4%B8%8E%E6%96%87%E5%AD%97%E6%98%BE%E7%A4%BA/" title="UEFI编程入门-图形与文字显示">UEFI编程入门-图形与文字显示</a><time datetime="2024-11-29T00:55:25.000Z" title="发表于 2024-11-29 08:55:25">2024-11-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/28/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%85%A5%E9%97%A8/" title="机器学习入门">机器学习入门</a><time datetime="2024-11-28T07:06:20.000Z" title="发表于 2024-11-28 15:06:20">2024-11-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>