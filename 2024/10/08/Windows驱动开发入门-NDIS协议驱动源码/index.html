<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Windows驱动开发入门-NDIS协议驱动源码 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Windows驱动开发入门-NDIS协议驱动源码debug.c： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows驱动开发入门-NDIS协议驱动源码">
<meta property="og:url" content="https://monoceros406.github.io/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="Windows驱动开发入门-NDIS协议驱动源码debug.c： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://monoceros406.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-10-08T11:21:15.000Z">
<meta property="article:modified_time" content="2025-05-11T02:15:55.496Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="Win驱动开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://monoceros406.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://monoceros406.github.io/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Windows驱动开发入门-NDIS协议驱动源码',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-11 10:15:55'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="The Blog of Monoceros406" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">330</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Windows驱动开发入门-NDIS协议驱动源码</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-08T11:21:15.000Z" title="发表于 2024-10-08 19:21:15">2024-10-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-11T02:15:55.496Z" title="更新于 2025-05-11 10:15:55">2025-05-11</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Windows驱动开发入门-NDIS协议驱动源码"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Windows驱动开发入门-NDIS协议驱动源码"><a href="#Windows驱动开发入门-NDIS协议驱动源码" class="headerlink" title="Windows驱动开发入门-NDIS协议驱动源码"></a>Windows驱动开发入门-NDIS协议驱动源码</h1><p>debug.c：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment">Copyright (c) 1997  Microsoft Corporation</span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment">    debug.c</span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment">    This module contains all debug-related code.</span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment">Notes:</span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;precomp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILENUMBER <span class="string">&#x27;GBED&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line">INT                  ndisprotDebugLevel = DL_WARN;</span><br><span class="line">NDIS_SPIN_LOCK       ndisprotDbgLogLock;</span><br><span class="line">PNUIOD_ALLOCATION    ndisprotdMemoryHead = (PNUIOD_ALLOCATION)<span class="literal">NULL</span>;</span><br><span class="line">PNUIOD_ALLOCATION    ndisprotdMemoryTail = (PNUIOD_ALLOCATION)<span class="literal">NULL</span>;</span><br><span class="line">ULONG                ndisprotdAllocCount = <span class="number">0</span>;    <span class="comment">// how many allocated so far (unfreed)</span></span><br><span class="line">NDIS_SPIN_LOCK       ndisprotdMemoryLock;</span><br><span class="line">BOOLEAN              ndisprotdInitDone = FALSE;</span><br><span class="line"><span class="function">PVOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAuditAllocMem</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID    pPointer,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG    Size,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG    FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG    LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    PVOID                pBuffer;</span><br><span class="line">    PNUIOD_ALLOCATION    pAllocInfo;</span><br><span class="line">    <span class="keyword">if</span> (!ndisprotdInitDone) &#123;</span><br><span class="line">        <span class="built_in">NdisAllocateSpinLock</span>(&amp;(ndisprotdMemoryLock));</span><br><span class="line">        ndisprotdInitDone = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NdisAllocateMemoryWithTag</span>(</span><br><span class="line">        (PVOID*)&amp;pAllocInfo,</span><br><span class="line">        Size + <span class="built_in">sizeof</span>(NUIOD_ALLOCATION),</span><br><span class="line">        (ULONG)<span class="string">&#x27;oiuN&#x27;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (pAllocInfo == (PNUIOD_ALLOCATION)<span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_VERY_LOUD + <span class="number">50</span>,</span><br><span class="line">               (<span class="string">&quot;ndisprotAuditAllocMem: file %d, line %d, Size %d failed!\n&quot;</span>,</span><br><span class="line">                FileNumber, LineNumber, Size));</span><br><span class="line">        pBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        pBuffer = (PVOID) &amp; (pAllocInfo-&gt;UserData);</span><br><span class="line">        <span class="built_in">NPROT_SET_MEM</span>(pBuffer, <span class="number">0xaf</span>, Size);</span><br><span class="line">        pAllocInfo-&gt;Signature = NUIOD_MEMORY_SIGNATURE;</span><br><span class="line">        pAllocInfo-&gt;FileNumber = FileNumber;</span><br><span class="line">        pAllocInfo-&gt;LineNumber = LineNumber;</span><br><span class="line">        pAllocInfo-&gt;Size = Size;</span><br><span class="line">        pAllocInfo-&gt;Location = (ULONG_PTR)pPointer;</span><br><span class="line">        pAllocInfo-&gt;Next = (PNUIOD_ALLOCATION)<span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">NdisAcquireSpinLock</span>(&amp;(ndisprotdMemoryLock));</span><br><span class="line">        pAllocInfo-&gt;Prev = ndisprotdMemoryTail;</span><br><span class="line">        <span class="keyword">if</span> (ndisprotdMemoryTail == (PNUIOD_ALLOCATION)<span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// empty list</span></span><br><span class="line">            ndisprotdMemoryHead = ndisprotdMemoryTail = pAllocInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            ndisprotdMemoryTail-&gt;Next = pAllocInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        ndisprotdMemoryTail = pAllocInfo;</span><br><span class="line">        ndisprotdAllocCount++;</span><br><span class="line">        <span class="built_in">NdisReleaseSpinLock</span>(&amp;(ndisprotdMemoryLock));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_VERY_LOUD + <span class="number">100</span>,</span><br><span class="line">           (<span class="string">&quot;ndisprotAuditAllocMem: file %c%c%c%c, line %d, %d bytes, [0x%x] &lt;- 0x%x\n&quot;</span>,</span><br><span class="line">            (CHAR)(FileNumber &amp; <span class="number">0xff</span>),</span><br><span class="line">            (CHAR)((FileNumber &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">            (CHAR)((FileNumber &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">            (CHAR)((FileNumber &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">            LineNumber, Size, pPointer, pBuffer));</span><br><span class="line">    <span class="keyword">return</span> (pBuffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAuditFreeMem</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID    Pointer</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    PNUIOD_ALLOCATION    pAllocInfo;</span><br><span class="line">    <span class="built_in">NdisAcquireSpinLock</span>(&amp;(ndisprotdMemoryLock));</span><br><span class="line">    pAllocInfo = <span class="built_in">CONTAINING_RECORD</span>(Pointer, NUIOD_ALLOCATION, UserData);</span><br><span class="line">    <span class="keyword">if</span> (pAllocInfo-&gt;Signature != NUIOD_MEMORY_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_ERROR,</span><br><span class="line">               (<span class="string">&quot;ndisprotAuditFreeMem: unknown buffer 0x%x!\n&quot;</span>, Pointer));</span><br><span class="line">        <span class="built_in">NdisReleaseSpinLock</span>(&amp;(ndisprotdMemoryLock));</span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line">        <span class="built_in">DbgBreakPoint</span>();</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pAllocInfo-&gt;Signature = (ULONG)<span class="string">&#x27;DEAD&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (pAllocInfo-&gt;Prev != (PNUIOD_ALLOCATION)<span class="literal">NULL</span>) &#123;</span><br><span class="line">        pAllocInfo-&gt;Prev-&gt;Next = pAllocInfo-&gt;Next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ndisprotdMemoryHead = pAllocInfo-&gt;Next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pAllocInfo-&gt;Next != (PNUIOD_ALLOCATION)<span class="literal">NULL</span>) &#123;</span><br><span class="line">        pAllocInfo-&gt;Next-&gt;Prev = pAllocInfo-&gt;Prev;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ndisprotdMemoryTail = pAllocInfo-&gt;Prev;</span><br><span class="line">    &#125;</span><br><span class="line">    ndisprotdAllocCount--;</span><br><span class="line">    <span class="built_in">NdisReleaseSpinLock</span>(&amp;(ndisprotdMemoryLock));</span><br><span class="line">    <span class="built_in">NdisFreeMemory</span>(pAllocInfo, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAuditShutdown</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ndisprotdInitDone) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ndisprotdAllocCount != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_ERROR, (<span class="string">&quot;AuditShutdown: unfreed memory, %d blocks!\n&quot;</span>,</span><br><span class="line">                              ndisprotdAllocCount));</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_ERROR, (<span class="string">&quot;MemoryHead: 0x%x, MemoryTail: 0x%x\n&quot;</span>,</span><br><span class="line">                              ndisprotdMemoryHead, ndisprotdMemoryTail));</span><br><span class="line">            <span class="built_in">DbgBreakPoint</span>();</span><br><span class="line">            &#123;</span><br><span class="line">                PNUIOD_ALLOCATION        pAllocInfo;</span><br><span class="line">                <span class="keyword">while</span> (ndisprotdMemoryHead != (PNUIOD_ALLOCATION)<span class="literal">NULL</span>) &#123;</span><br><span class="line">                    pAllocInfo = ndisprotdMemoryHead;</span><br><span class="line">                    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;AuditShutdown: will free 0x%x\n&quot;</span>, pAllocInfo));</span><br><span class="line">                    <span class="built_in">ndisprotAuditFreeMem</span>(&amp;(pAllocInfo-&gt;UserData));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ndisprotdInitDone = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_HD_LENGTH        128</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">DbgPrintHexDump</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    PUCHAR            pBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG            Length</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Print a hex dump of the given contiguous buffer. If the length</span></span></span><br><span class="line"><span class="comment"><span class="function">    is too long, we truncate it.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pBuffer            - Points to start of data to be dumped</span></span></span><br><span class="line"><span class="comment"><span class="function">    Length            - Length of above.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ULONG        i;</span><br><span class="line">    <span class="keyword">if</span> (Length &gt; MAX_HD_LENGTH) &#123;</span><br><span class="line">        Length = MAX_HD_LENGTH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; Length; i++) &#123;</span><br><span class="line">        <span class="comment">//  Check if we are at the end of a line</span></span><br><span class="line">        <span class="keyword">if</span> ((i &gt; <span class="number">0</span>) &amp;&amp; ((i &amp; <span class="number">0xf</span>) == <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//  Print addr if we are at start of a new line</span></span><br><span class="line">        <span class="keyword">if</span> ((i &amp; <span class="number">0xf</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;%08x &quot;</span>, pBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot; %02x&quot;</span>, *pBuffer++);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  Terminate the last line.</span></span><br><span class="line">    <span class="keyword">if</span> (Length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DBG</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG_SPIN_LOCK</span></span><br><span class="line">ULONG    ndisprotdSpinLockInitDone = <span class="number">0</span>;</span><br><span class="line">NDIS_SPIN_LOCK    ndisprotdLockLock;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAllocateSpinLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    PNPROT_LOCK        pLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG                FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG                LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ndisprotdSpinLockInitDone == <span class="number">0</span>) &#123;</span><br><span class="line">        ndisprotdSpinLockInitDone = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">NdisAllocateSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NdisAcquireSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">    pLock-&gt;Signature = NUIOL_SIG;</span><br><span class="line">    pLock-&gt;TouchedByFileNumber = FileNumber;</span><br><span class="line">    pLock-&gt;TouchedInLineNumber = LineNumber;</span><br><span class="line">    pLock-&gt;IsAcquired = <span class="number">0</span>;</span><br><span class="line">    pLock-&gt;OwnerThread = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NdisAllocateSpinLock</span>(&amp;(pLock-&gt;NdisLock));</span><br><span class="line">    <span class="built_in">NdisReleaseSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFreeSpinLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    PNPROT_LOCK        pLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG                FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG                LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">NdisAcquireSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">    pLock-&gt;Signature = NUIOL_SIG;</span><br><span class="line">    pLock-&gt;TouchedByFileNumber = FileNumber;</span><br><span class="line">    pLock-&gt;TouchedInLineNumber = LineNumber;</span><br><span class="line">    pLock-&gt;IsAcquired = <span class="number">0</span>;</span><br><span class="line">    pLock-&gt;OwnerThread = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NdisFreeSpinLock</span>(&amp;(pLock-&gt;NdisLock));</span><br><span class="line">    <span class="built_in">NdisReleaseSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFreeDbgLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(ndisprotdSpinLockInitDone == <span class="number">1</span>);</span><br><span class="line">    ndisprotdSpinLockInitDone = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NdisFreeSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAcquireSpinLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    PNPROT_LOCK        pLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG                FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG                LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    PKTHREAD        pThread;</span><br><span class="line">    pThread = <span class="built_in">KeGetCurrentThread</span>();</span><br><span class="line">    <span class="built_in">NdisAcquireSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">    <span class="keyword">if</span> (pLock-&gt;Signature != NUIOL_SIG) &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;Trying to acquire uninited lock 0x%x, File %c%c%c%c, Line %d\n&quot;</span>,</span><br><span class="line">                 pLock,</span><br><span class="line">                 (CHAR)(FileNumber &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 LineNumber);</span><br><span class="line">        <span class="built_in">DbgBreakPoint</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pLock-&gt;IsAcquired != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pLock-&gt;OwnerThread == pThread) &#123;</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;Detected multiple locking!: pLock 0x%x, File %c%c%c%c, Line %d\n&quot;</span>,</span><br><span class="line">                     pLock,</span><br><span class="line">                     (CHAR)(FileNumber &amp; <span class="number">0xff</span>),</span><br><span class="line">                     (CHAR)((FileNumber &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                     (CHAR)((FileNumber &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                     (CHAR)((FileNumber &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                     LineNumber);</span><br><span class="line">            <span class="built_in">DbgPrint</span>(<span class="string">&quot;pLock 0x%x already acquired in File %c%c%c%c, Line %d\n&quot;</span>,</span><br><span class="line">                     pLock,</span><br><span class="line">                     (CHAR)(pLock-&gt;TouchedByFileNumber &amp; <span class="number">0xff</span>),</span><br><span class="line">                     (CHAR)((pLock-&gt;TouchedByFileNumber &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                     (CHAR)((pLock-&gt;TouchedByFileNumber &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                     (CHAR)((pLock-&gt;TouchedByFileNumber &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                     pLock-&gt;TouchedInLineNumber);</span><br><span class="line">            <span class="built_in">DbgBreakPoint</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pLock-&gt;IsAcquired++;</span><br><span class="line">    <span class="built_in">NdisReleaseSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">    <span class="built_in">NdisAcquireSpinLock</span>(&amp;(pLock-&gt;NdisLock));</span><br><span class="line">    <span class="comment">//  Mark this lock.</span></span><br><span class="line">    pLock-&gt;OwnerThread = pThread;</span><br><span class="line">    pLock-&gt;TouchedByFileNumber = FileNumber;</span><br><span class="line">    pLock-&gt;TouchedInLineNumber = LineNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotReleaseSpinLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    PNPROT_LOCK        pLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG                FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN    ULONG                LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">NdisDprAcquireSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">    <span class="keyword">if</span> (pLock-&gt;Signature != NUIOL_SIG) &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;Trying to release uninited lock 0x%x, File %c%c%c%c, Line %d\n&quot;</span>,</span><br><span class="line">                 pLock,</span><br><span class="line">                 (CHAR)(FileNumber &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 LineNumber);</span><br><span class="line">        <span class="built_in">DbgBreakPoint</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pLock-&gt;IsAcquired == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">DbgPrint</span>(<span class="string">&quot;Detected release of unacquired lock 0x%x, File %c%c%c%c, Line %d\n&quot;</span>,</span><br><span class="line">                 pLock,</span><br><span class="line">                 (CHAR)(FileNumber &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 (CHAR)((FileNumber &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>),</span><br><span class="line">                 LineNumber);</span><br><span class="line">        <span class="built_in">DbgBreakPoint</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    pLock-&gt;TouchedByFileNumber = FileNumber;</span><br><span class="line">    pLock-&gt;TouchedInLineNumber = LineNumber;</span><br><span class="line">    pLock-&gt;IsAcquired--;</span><br><span class="line">    pLock-&gt;OwnerThread = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NdisDprReleaseSpinLock</span>(&amp;(ndisprotdLockLock));</span><br><span class="line">    <span class="built_in">NdisReleaseSpinLock</span>(&amp;(pLock-&gt;NdisLock));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DBG_SPIN_LOCK</span></span></span><br></pre></td></tr></table></figure>

<p>debug.h：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment">Copyright (c) 2000  Microsoft Corporation</span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment">    debug.h</span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment">    Debug macros for NDISPROT</span></span><br><span class="line"><span class="comment">Notes:</span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _NUIODEBUG__H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NUIODEBUG__H</span></span><br><span class="line"><span class="comment">// Message verbosity: lower values indicate higher urgency</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DL_EXTRA_LOUD       20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DL_VERY_LOUD        10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DL_LOUD             8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DL_INFO             6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DL_WARN             4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DL_ERROR            2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DL_FATAL            0</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG_SPIN_LOCK</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NPROT_LOCK</span> &#123;</span><br><span class="line">    ULONG                   Signature;</span><br><span class="line">    ULONG                   IsAcquired;</span><br><span class="line">    PKTHREAD                OwnerThread;</span><br><span class="line">    ULONG                   TouchedByFileNumber;</span><br><span class="line">    ULONG                   TouchedInLineNumber;</span><br><span class="line">    NDIS_SPIN_LOCK          NdisLock;</span><br><span class="line">&#125; NPROT_LOCK, * PNPROT_LOCK;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOL_SIG    <span class="string">&#x27;KCOL&#x27;</span></span></span><br><span class="line"><span class="keyword">extern</span> NDIS_SPIN_LOCK       ndisprotDbgLogLock;</span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAllocateSpinLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNPROT_LOCK          pLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG               FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG               LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFreeSpinLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNPROT_LOCK          pLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG               FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG               LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAcquireSpinLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNPROT_LOCK          pLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG               FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG               LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotReleaseSpinLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNPROT_LOCK          pLock,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG               FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG               LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFreeDbgLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_LOCK_COUNT(Count)                                         \</span></span><br><span class="line"><span class="meta">            &#123;                                                           \</span></span><br><span class="line"><span class="meta">                <span class="keyword">if</span> ((INT)(Count) &lt; 0)                                   \</span></span><br><span class="line"><span class="meta">                &#123;                                                       \</span></span><br><span class="line"><span class="meta">                    DbgPrint(<span class="string">&quot;Lock Count %d is &lt; 0! File %s, Line %d\n&quot;</span>,\</span></span><br><span class="line"><span class="meta">                        Count, __FILE__, __LINE__);                     \</span></span><br><span class="line"><span class="meta">                    DbgBreakPoint();                                    \</span></span><br><span class="line"><span class="meta">                &#125;                                                       \</span></span><br><span class="line"><span class="meta">            &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_LOCK_COUNT(Count)</span></span><br><span class="line"><span class="keyword">typedef</span> NDIS_SPIN_LOCK      NPROT_LOCK;</span><br><span class="line"><span class="keyword">typedef</span> PNDIS_SPIN_LOCK     PNPROT_LOCK;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>    <span class="comment">// DBG_SPIN_LOCK</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line"><span class="keyword">extern</span> INT                ndisprotDebugLevel;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGP(lev, stmt)                                               \</span></span><br><span class="line"><span class="meta">        &#123;                                                               \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> ((lev) &lt;= ndisprotDebugLevel)                             \</span></span><br><span class="line"><span class="meta">            &#123;                                                           \</span></span><br><span class="line"><span class="meta">                DbgPrint(<span class="string">&quot;NdisProt: &quot;</span>); DbgPrint stmt;                   \</span></span><br><span class="line"><span class="meta">            &#125;                                                           \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGPDUMP(lev, pBuf, Len)                                      \</span></span><br><span class="line"><span class="meta">        &#123;                                                               \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> ((lev) &lt;= ndisprotDebugLevel)                             \</span></span><br><span class="line"><span class="meta">            &#123;                                                           \</span></span><br><span class="line"><span class="meta">                DbgPrintHexDump((PUCHAR)(pBuf), (ULONG)(Len));          \</span></span><br><span class="line"><span class="meta">            &#125;                                                           \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_ASSERT(exp)                                                \</span></span><br><span class="line"><span class="meta">        &#123;                                                               \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (!(exp))                                                 \</span></span><br><span class="line"><span class="meta">            &#123;                                                           \</span></span><br><span class="line"><span class="meta">                DbgPrint(<span class="string">&quot;NdisProt: assert &quot;</span> #exp <span class="string">&quot; failed in&quot;</span>           \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot; file %s, line %d\n&quot;</span>, __FILE__, __LINE__);         \</span></span><br><span class="line"><span class="meta">                DbgBreakPoint();                                        \</span></span><br><span class="line"><span class="meta">            &#125;                                                           \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_SET_SIGNATURE(s, t)\</span></span><br><span class="line"><span class="meta">        (s)-&gt;t##_sig = t##_signature;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_STRUCT_ASSERT(s, t)                                        \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> ((s)-&gt;t##_sig != t##_signature)                              \</span></span><br><span class="line"><span class="meta">        &#123;                                                               \</span></span><br><span class="line"><span class="meta">            DbgPrint(<span class="string">&quot;ndisprot: assertion failure&quot;</span>                       \</span></span><br><span class="line"><span class="meta">            <span class="string">&quot; for type &quot;</span> #t <span class="string">&quot; at 0x%x in file %s, line %d\n&quot;</span>,           \</span></span><br><span class="line"><span class="meta">             (PUCHAR)s, __FILE__, __LINE__);                            \</span></span><br><span class="line"><span class="meta">            DbgBreakPoint();                                            \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="comment">// Memory Allocation/Freeing Audit:</span></span><br><span class="line"><span class="comment">// The NUIOD_ALLOCATION structure stores all info about one allocation</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NUIOD_ALLOCATION</span> &#123;</span><br><span class="line">    ULONG                    Signature;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_NUIOD_ALLOCATION</span>* Next;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_NUIOD_ALLOCATION</span>* Prev;</span><br><span class="line">    ULONG                    FileNumber;</span><br><span class="line">    ULONG                    LineNumber;</span><br><span class="line">    ULONG                    Size;</span><br><span class="line">    ULONG_PTR                Location;  <span class="comment">// where the returned ptr was stored</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        ULONGLONG            Alignment;</span><br><span class="line">        UCHAR                    UserData;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; NUIOD_ALLOCATION, * PNUIOD_ALLOCATION;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOD_MEMORY_SIGNATURE    (ULONG)<span class="string">&#x27;CSII&#x27;</span></span></span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">PVOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAuditAllocMem</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID        pPointer,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG        Size,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG        FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG        LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAuditFreeMem</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID        Pointer</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAuditShutdown</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">DbgPrintHexDump</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PUCHAR        pBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG        Length</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="comment">// No debug</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGP(lev, stmt)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUGPDUMP(lev, pBuf, Len)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_ASSERT(exp)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_SET_SIGNATURE(s, t)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_STRUCT_ASSERT(s, t)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>    <span class="comment">// DBG</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _NUIODEBUG__H</span></span></span><br></pre></td></tr></table></figure>

<p>excallbk.c：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment">Copyright (c) Microsoft Corporation.  All rights reserved.</span></span><br><span class="line"><span class="comment">    THIS CODE AND INFORMATION IS PROVIDED &quot;AS IS&quot; WITHOUT WARRANTY OF ANY</span></span><br><span class="line"><span class="comment">    KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE</span></span><br><span class="line"><span class="comment">    IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR</span></span><br><span class="line"><span class="comment">    PURPOSE.</span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment">    ExCallbk.c</span></span><br><span class="line"><span class="comment">Abstract: The routines in this module helps to solve driver load order</span></span><br><span class="line"><span class="comment">          dependency between this sample and NDISWDM sample. These</span></span><br><span class="line"><span class="comment">          routines are not required in a typical protocol driver. By default</span></span><br><span class="line"><span class="comment">          this module is not included in the sample. You include these routines</span></span><br><span class="line"><span class="comment">          by adding EX_CALLBACK defines to the &#x27;sources&#x27; file. Read the</span></span><br><span class="line"><span class="comment">          NDISWDM samples readme file for more information on how ExCallback</span></span><br><span class="line"><span class="comment">          kernel interfaces are used to solve driver load order issue.</span></span><br><span class="line"><span class="comment">Environment:</span></span><br><span class="line"><span class="comment">    Kernel mode</span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;precomp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> EX_CALLBACK</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILENUMBER <span class="string">&#x27;LCxE&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NDISPROT_CALLBACK_NAME  <span class="string">L&quot;\\Callback\\NdisProtCallbackObject&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CALLBACK_SOURCE_NDISPROT    0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CALLBACK_SOURCE_NDISWDM     1</span></span><br><span class="line">PCALLBACK_OBJECT                CallbackObject = <span class="literal">NULL</span>;</span><br><span class="line">PVOID                           CallbackRegisterationHandle = <span class="literal">NULL</span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span><span class="params">(*NOTIFY_PRESENCE_CALLBACK)</span><span class="params">(OUT PVOID Source)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ALLOC_PRAGMA</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> alloc_text(PAGE, ndisprotRegisterExCallBack)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> alloc_text(PAGE, ndisprotUnregisterExCallBack)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// ALLOC_PRAGMA</span></span></span><br><span class="line"><span class="function">BOOLEAN</span></span><br><span class="line"><span class="function"><span class="title">ndisprotRegisterExCallBack</span><span class="params">(VOID)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Create or open an existing callback object and send a</span></span></span><br><span class="line"><span class="comment"><span class="function">    notification. Note that the system calls our notication</span></span></span><br><span class="line"><span class="comment"><span class="function">    callback routine in addition to notifying other</span></span></span><br><span class="line"><span class="comment"><span class="function">    registered clients.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    TRUE or FALSE</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    OBJECT_ATTRIBUTES   ObjectAttr;</span><br><span class="line">    UNICODE_STRING      CallBackObjectName;</span><br><span class="line">    NTSTATUS            Status;</span><br><span class="line">    BOOLEAN             bResult = TRUE;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;--&gt; ndisprotRegisterExCallBack\n&quot;</span>));</span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="built_in">RtlInitUnicodeString</span>(&amp;CallBackObjectName, NDISPROT_CALLBACK_NAME);</span><br><span class="line">        <span class="built_in">InitializeObjectAttributes</span>(&amp;ObjectAttr,</span><br><span class="line">                                   &amp;CallBackObjectName,</span><br><span class="line">                                   OBJ_CASE_INSENSITIVE | OBJ_PERMANENT,</span><br><span class="line">                                   <span class="literal">NULL</span>,</span><br><span class="line">                                   <span class="literal">NULL</span>);</span><br><span class="line">        Status = <span class="built_in">ExCreateCallback</span>(&amp;CallbackObject,</span><br><span class="line">                                  &amp;ObjectAttr,</span><br><span class="line">                                  TRUE,</span><br><span class="line">                                  TRUE);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(Status)) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_ERROR, (<span class="string">&quot;RegisterExCallBack: failed to create callback %lx\n&quot;</span>, Status));</span><br><span class="line">            bResult = FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CallbackRegisterationHandle = <span class="built_in">ExRegisterCallback</span>(CallbackObject,</span><br><span class="line">                                                         ndisprotCallback,</span><br><span class="line">                                                         (PVOID)<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (CallbackRegisterationHandle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_ERROR, (<span class="string">&quot;RegisterExCallBack: failed to register a Callback routine%lx\n&quot;</span>, Status));</span><br><span class="line">            bResult = FALSE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">ExNotifyCallback</span>(CallbackObject,</span><br><span class="line">                         (PVOID)CALLBACK_SOURCE_NDISPROT,</span><br><span class="line">                         (PVOID)<span class="literal">NULL</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="keyword">if</span> (!bResult) &#123;</span><br><span class="line">        <span class="keyword">if</span> (CallbackRegisterationHandle) &#123;</span><br><span class="line">            <span class="built_in">ExUnregisterCallback</span>(CallbackRegisterationHandle);</span><br><span class="line">            CallbackRegisterationHandle = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (CallbackObject) &#123;</span><br><span class="line">            <span class="built_in">ObDereferenceObject</span>(CallbackObject);</span><br><span class="line">            CallbackObject = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;&lt;-- ndisprotRegisterExCallBack\n&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> bResult;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotUnregisterExCallBack</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Unregister out callback routine and also delete the object</span></span></span><br><span class="line"><span class="comment"><span class="function">    by removing the reference on it.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    VOID</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;--&gt; ndisprotUnregisterExCallBack\n&quot;</span>));</span><br><span class="line">    <span class="built_in">PAGED_CODE</span>();</span><br><span class="line">    <span class="keyword">if</span> (CallbackRegisterationHandle) &#123;</span><br><span class="line">        <span class="built_in">ExUnregisterCallback</span>(CallbackRegisterationHandle);</span><br><span class="line">        CallbackRegisterationHandle = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (CallbackObject) &#123;</span><br><span class="line">        <span class="built_in">ObDereferenceObject</span>(CallbackObject);</span><br><span class="line">        CallbackObject = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;&lt;-- ndisprotUnregisterExCallBack\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID   CallBackContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID   Source,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID   CallbackAddr</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    This is the notification callback routine called by the executive</span></span></span><br><span class="line"><span class="comment"><span class="function">    subsystem in the context of the thread that make the notification</span></span></span><br><span class="line"><span class="comment"><span class="function">    on the object we have registered. This routine could be called</span></span></span><br><span class="line"><span class="comment"><span class="function">    by the NDISPROT driver or another instance of our own miniport.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    CallBackContext - This is the context value specified in the</span></span></span><br><span class="line"><span class="comment"><span class="function">                        ExRegisterCallback call. It&#x27;s NULL.</span></span></span><br><span class="line"><span class="comment"><span class="function">    Source - First parameter specified in the call to ExNotifyCallback.</span></span></span><br><span class="line"><span class="comment"><span class="function">                     This is used to indenty the caller. This could be</span></span></span><br><span class="line"><span class="comment"><span class="function">                     either ourself or NDISWDM.</span></span></span><br><span class="line"><span class="comment"><span class="function">    CallbackAddr -  Second parameter specified in the call to ExNotifyCallback.</span></span></span><br><span class="line"><span class="comment"><span class="function">                     This is an additonal context the caller can specify. When it</span></span></span><br><span class="line"><span class="comment"><span class="function">                     comes from NDISWDM, it&#x27;s a routine to call as part of</span></span></span><br><span class="line"><span class="comment"><span class="function">                     the notification.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    VOID</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NOTIFY_PRESENCE_CALLBACK func;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;==&gt;ndisprotoCallback: Source %lx, CallbackAddr %p\n&quot;</span>,</span><br><span class="line">                     Source, CallbackAddr));</span><br><span class="line">    <span class="comment">// if we are the one issuing this notification, just return</span></span><br><span class="line">    <span class="keyword">if</span> (Source == CALLBACK_SOURCE_NDISPROT) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Notification is coming from NDISWDM</span></span><br><span class="line">    <span class="comment">// let it know that you are here</span></span><br><span class="line">    <span class="built_in">ASSERT</span>(Source == (PVOID)CALLBACK_SOURCE_NDISWDM);</span><br><span class="line">    <span class="keyword">if</span> (Source == (PVOID)CALLBACK_SOURCE_NDISWDM) &#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(CallbackAddr);</span><br><span class="line">        <span class="keyword">if</span> (CallbackAddr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_ERROR, (<span class="string">&quot;Callback called with invalid address %p\n&quot;</span>, CallbackAddr));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        func = CallbackAddr;</span><br><span class="line">        <span class="built_in">func</span>(CALLBACK_SOURCE_NDISPROT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;&lt;==ndisprotoCallback: Source,  %lx\n&quot;</span>, Source));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>macros.h：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment">Copyright (c) 2000  Microsoft Corporation</span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment">    macros.h</span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment">    Some macros for NDISPROT.</span></span><br><span class="line"><span class="comment">Environment:</span></span><br><span class="line"><span class="comment">    Kernel mode only.</span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MIN</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN(_a, _b) ((_a) &lt; (_b)? (_a): (_b))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_REF_OPEN(_pOpen)   ndisprotDbgRefOpen(_pOpen, __FILENUMBER, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_DEREF_OPEN(_pOpen) ndisprotDbgDerefOpen(_pOpen, __FILENUMBER, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_REF_OPEN(_pOpen)   ndisprotRefOpen(_pOpen)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_DEREF_OPEN(_pOpen) ndisprotDerefOpen(_pOpen)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//  Spinlock macros</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG_SPIN_LOCK</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_INIT_LOCK(_pLock)              \</span></span><br><span class="line"><span class="meta">           ndisprotAllocateSpinLock(_pLock, __FILENUMBER, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_FREE_LOCK(_pLock)              \</span></span><br><span class="line"><span class="meta">           ndisprotFreeSpinLock(_pLock, __FILENUMBER, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_ACQUIRE_LOCK(_pLock)           \</span></span><br><span class="line"><span class="meta">            ndisprotAcquireSpinLock(_pLock, __FILENUMBER, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_RELEASE_LOCK(_pLock)           \</span></span><br><span class="line"><span class="meta">            ndisprotReleaseSpinLock(_pLock, __FILENUMBER, __LINE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_FREE_DBG_LOCK()                \</span></span><br><span class="line"><span class="meta">           ndisprotFreeDbgLock()</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_INIT_LOCK(_pLock)           NdisAllocateSpinLock(_pLock)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_FREE_LOCK(_pLock)           NdisFreeSpinLock(_pLock)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_ACQUIRE_LOCK(_pLock)        NdisAcquireSpinLock(_pLock)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_RELEASE_LOCK(_pLock)        NdisReleaseSpinLock(_pLock)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_FREE_DBG_LOCK()</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DBG</span></span></span><br><span class="line"><span class="comment">//  List manipulation.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_INIT_LIST_HEAD(_pList)             InitializeListHead(_pList)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_IS_LIST_EMPTY(_pList)              IsListEmpty(_pList)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_INSERT_HEAD_LIST(_pList, _pEnt)    InsertHeadList(_pList, _pEnt)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_INSERT_TAIL_LIST(_pList, _pEnt)    InsertTailList(_pList, _pEnt)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_REMOVE_ENTRY_LIST(_pEnt)           RemoveEntryList(_pEnt)</span></span><br><span class="line"><span class="comment">//  Receive packet queueing.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_LIST_ENTRY_TO_RCV_PKT(_pEnt)   \</span></span><br><span class="line"><span class="meta">    CONTAINING_RECORD(CONTAINING_RECORD(_pEnt, NPROT_RECV_PACKET_RSVD, Link), NDIS_PACKET, ProtocolReserved)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_RCV_PKT_TO_LIST_ENTRY(_pPkt)   \</span></span><br><span class="line"><span class="meta">    (&amp;((PNPROT_RECV_PACKET_RSVD)&amp;((_pPkt)-&gt;ProtocolReserved[0]))-&gt;Link)</span></span><br><span class="line"><span class="comment">//  In case we allocate a receive packet of our own to copy and queue</span></span><br><span class="line"><span class="comment">//  received data, we might have to also allocate an auxiliary NDIS_BUFFER</span></span><br><span class="line"><span class="comment">//  to map part of the receive buffer (skipping the header bytes), so as</span></span><br><span class="line"><span class="comment">//  to satisfy NdisTransferData. In such cases, we keep a pointer to the</span></span><br><span class="line"><span class="comment">//  fully mapped receive buffer in the packet reserved space:</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_RCV_PKT_TO_ORIGINAL_BUFFER(_pPkt)  \</span></span><br><span class="line"><span class="meta">    (((PNPROT_RECV_PACKET_RSVD)&amp;((_pPkt)-&gt;ProtocolReserved[0]))-&gt;pOriginalBuffer)</span></span><br><span class="line"><span class="comment">//  Send packet context.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_IRP_FROM_SEND_PKT(_pPkt)        \</span></span><br><span class="line"><span class="meta">    (((PNPROT_SEND_PACKET_RSVD)&amp;((_pPkt)-&gt;ProtocolReserved[0]))-&gt;pIrp)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_SEND_PKT_RSVD(_pPkt)           \</span></span><br><span class="line"><span class="meta">    ((PNPROT_SEND_PACKET_RSVD)&amp;((_pPkt)-&gt;ProtocolReserved[0]))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_REF_SEND_PKT(_pPkt)            \</span></span><br><span class="line"><span class="meta">    (VOID)NdisInterlockedIncrement((PLONG)&amp;NPROT_SEND_PKT_RSVD(_pPkt)-&gt;RefCount)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_DEREF_SEND_PKT(_pPkt)          \</span></span><br><span class="line"><span class="meta">    &#123;                                                                               \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (NdisInterlockedDecrement((PLONG)&amp;NPROT_SEND_PKT_RSVD(_pPkt)-&gt;RefCount) == 0)    \</span></span><br><span class="line"><span class="meta">        &#123;                                                                           \</span></span><br><span class="line"><span class="meta">            NdisFreePacket(_pPkt);                                                  \</span></span><br><span class="line"><span class="meta">        &#125;                                                                           \</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line"><span class="comment">//  Cancel IDs are generated by using the partial cancel ID we got from</span></span><br><span class="line"><span class="comment">//  NDIS ORed with a monotonically increasing locally generated ID.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_CANCEL_ID_LOW_MASK     (((ULONG_PTR)-1) &gt;&gt; 8) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_GET_NEXT_CANCEL_ID()                                                   \</span></span><br><span class="line"><span class="meta">        (PVOID)(Globals.PartialCancelId |                                           \</span></span><br><span class="line"><span class="meta">         ((NdisInterlockedIncrement((PLONG)&amp;Globals.LocalCancelId)) &amp; NPROT_CANCEL_ID_LOW_MASK))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// NDIS51</span></span></span><br><span class="line"><span class="comment">//  Memory allocation</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_ALLOC_MEM(_pVar, _Size)        \</span></span><br><span class="line"><span class="meta">    (_pVar) = ndisprotAuditAllocMem(         \</span></span><br><span class="line"><span class="meta">                    (PVOID)&amp;(_pVar),        \</span></span><br><span class="line"><span class="meta">                    _Size,                  \</span></span><br><span class="line"><span class="meta">                    __FILENUMBER,           \</span></span><br><span class="line"><span class="meta">                    __LINE__);</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_FREE_MEM(_pMem)                \</span></span><br><span class="line"><span class="meta">    ndisprotAuditFreeMem(_pMem);</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_ALLOC_MEM(_pVar, _Size)        \</span></span><br><span class="line"><span class="meta">    NdisAllocateMemoryWithTag((PVOID *)(&amp;_pVar), (_Size), NPROT_ALLOC_TAG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_FREE_MEM(_pMem)                \</span></span><br><span class="line"><span class="meta">    NdisFreeMemory(_pMem, 0, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DBG</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_ZERO_MEM(_pMem, _ByteCount)        \</span></span><br><span class="line"><span class="meta">    NdisZeroMemory(_pMem, _ByteCount)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_COPY_MEM(_pDst, _pSrc, _ByteCount) \</span></span><br><span class="line"><span class="meta">    NdisMoveMemory(_pDst, _pSrc, _ByteCount)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_MEM_CMP(_p1, _p2, _ByteCount)      \</span></span><br><span class="line"><span class="meta">    NdisEqualMemory(_p1, _p2, _ByteCount)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_SET_MEM(_pMem, _ByteVal, _ByteCount)   \</span></span><br><span class="line"><span class="meta">    NdisFillMemory(_pMem, _ByteCount, _ByteVal)</span></span><br><span class="line"><span class="comment">//  Events.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_INIT_EVENT(_pEvent)            NdisInitializeEvent(_pEvent)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_SIGNAL_EVENT(_pEvent)          NdisSetEvent(_pEvent)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_WAIT_EVENT(_pEvent, _MsToWait) NdisWaitEvent(_pEvent, _MsToWait)</span></span><br><span class="line"><span class="comment">//  Flags</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_SET_FLAGS(_FlagsVar, _Mask, _BitsToSet)    \</span></span><br><span class="line"><span class="meta">        (_FlagsVar) = ((_FlagsVar) &amp; ~(_Mask)) | (_BitsToSet)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_TEST_FLAGS(_FlagsVar, _Mask, _BitsToCheck)    \</span></span><br><span class="line"><span class="meta">        (((_FlagsVar) &amp; (_Mask)) == (_BitsToCheck))</span></span><br><span class="line"><span class="comment">//  Block the calling thread for the given duration:</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_SLEEP(_Seconds)                            \</span></span><br><span class="line"><span class="meta">&#123;                                                       \</span></span><br><span class="line"><span class="meta">    NDIS_EVENT  _SleepEvent;                            \</span></span><br><span class="line"><span class="meta">    NdisInitializeEvent(&amp;_SleepEvent);                  \</span></span><br><span class="line"><span class="meta">    (VOID)NdisWaitEvent(&amp;_SleepEvent, _Seconds*1000);   \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NDIS_STATUS_TO_NT_STATUS(_NdisStatus, _pNtStatus)                           \</span></span><br><span class="line"><span class="meta">&#123;                                                                                   \</span></span><br><span class="line"><span class="meta">    <span class="comment">/*                                                                              \</span></span></span><br><span class="line"><span class="comment"><span class="meta">     *  The following NDIS status codes map directly to NT status codes.            \</span></span></span><br><span class="line"><span class="comment"><span class="meta">     */</span>                                                                             \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (((NDIS_STATUS_SUCCESS == (_NdisStatus)) ||                                  \</span></span><br><span class="line"><span class="meta">        (NDIS_STATUS_PENDING == (_NdisStatus)) ||                                   \</span></span><br><span class="line"><span class="meta">        (NDIS_STATUS_BUFFER_OVERFLOW == (_NdisStatus)) ||                           \</span></span><br><span class="line"><span class="meta">        (NDIS_STATUS_FAILURE == (_NdisStatus)) ||                                   \</span></span><br><span class="line"><span class="meta">        (NDIS_STATUS_RESOURCES == (_NdisStatus)) ||                                 \</span></span><br><span class="line"><span class="meta">        (NDIS_STATUS_NOT_SUPPORTED == (_NdisStatus))))                              \</span></span><br><span class="line"><span class="meta">    &#123;                                                                               \</span></span><br><span class="line"><span class="meta">        *(_pNtStatus) = (NTSTATUS)(_NdisStatus);                                    \</span></span><br><span class="line"><span class="meta">    &#125;                                                                               \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span> (NDIS_STATUS_BUFFER_TOO_SHORT == (_NdisStatus))                         \</span></span><br><span class="line"><span class="meta">    &#123;                                                                               \</span></span><br><span class="line"><span class="meta">        <span class="comment">/*                                                                          \</span></span></span><br><span class="line"><span class="comment"><span class="meta">         *  The above NDIS status codes require a little special casing.            \</span></span></span><br><span class="line"><span class="comment"><span class="meta">         */</span>                                                                         \</span></span><br><span class="line"><span class="meta">        *(_pNtStatus) = STATUS_BUFFER_TOO_SMALL;                                    \</span></span><br><span class="line"><span class="meta">    &#125;                                                                               \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span> (NDIS_STATUS_INVALID_LENGTH == (_NdisStatus))                           \</span></span><br><span class="line"><span class="meta">    &#123;                                                                               \</span></span><br><span class="line"><span class="meta">        *(_pNtStatus) = STATUS_INVALID_BUFFER_SIZE;                                 \</span></span><br><span class="line"><span class="meta">    &#125;                                                                               \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span> (NDIS_STATUS_INVALID_DATA == (_NdisStatus))                             \</span></span><br><span class="line"><span class="meta">    &#123;                                                                               \</span></span><br><span class="line"><span class="meta">        *(_pNtStatus) = STATUS_INVALID_PARAMETER;                                   \</span></span><br><span class="line"><span class="meta">    &#125;                                                                               \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span> (NDIS_STATUS_ADAPTER_NOT_FOUND == (_NdisStatus))                        \</span></span><br><span class="line"><span class="meta">    &#123;                                                                               \</span></span><br><span class="line"><span class="meta">        *(_pNtStatus) = STATUS_NO_MORE_ENTRIES;                                     \</span></span><br><span class="line"><span class="meta">    &#125;                                                                               \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> <span class="keyword">if</span> (NDIS_STATUS_ADAPTER_NOT_READY == (_NdisStatus))                        \</span></span><br><span class="line"><span class="meta">    &#123;                                                                               \</span></span><br><span class="line"><span class="meta">        *(_pNtStatus) = STATUS_DEVICE_NOT_READY;                                    \</span></span><br><span class="line"><span class="meta">    &#125;                                                                               \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span>                                                                            \</span></span><br><span class="line"><span class="meta">    &#123;                                                                               \</span></span><br><span class="line"><span class="meta">        *(_pNtStatus) = STATUS_UNSUCCESSFUL;                                        \</span></span><br><span class="line"><span class="meta">    &#125;                                                                               \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ndisbind.c：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment">Copyright (c) 2000  Microsoft Corporation</span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment">    ndisbind.c</span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment">    NDIS protocol entry points and utility routines to handle binding</span></span><br><span class="line"><span class="comment">    and unbinding from adapters.</span></span><br><span class="line"><span class="comment">Environment:</span></span><br><span class="line"><span class="comment">    Kernel mode only.</span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;precomp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILENUMBER <span class="string">&#x27;DNIB&#x27;</span></span></span><br><span class="line"><span class="function">VOID <span class="title">NdisProtBindAdapter</span><span class="params">(OUT PNDIS_STATUS pStatus, IN NDIS_HANDLE BindContext, IN PNDIS_STRING pDeviceName, IN PVOID SystemSpecific1, IN PVOID SystemSpecific2)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Protocol Bind Handler entry point called when NDIS wants us to bind to an adapter. We go ahead and set up a binding. An OPEN_CONTEXT structure is allocated to keep state about this binding.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pStatus - place to return bind status</span></span></span><br><span class="line"><span class="comment"><span class="function">    BindContext - handle to use with NdisCompleteBindAdapter</span></span></span><br><span class="line"><span class="comment"><span class="function">    DeviceName - adapter to bind to</span></span></span><br><span class="line"><span class="comment"><span class="function">    SystemSpecific1 - used to access protocol-specific registry key for this binding</span></span></span><br><span class="line"><span class="comment"><span class="function">    SystemSpecific2 - unused</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT           pOpenContext;</span><br><span class="line">    NDIS_STATUS                     Status, ConfigStatus;</span><br><span class="line">    NDIS_HANDLE                     ConfigHandle;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(BindContext);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(SystemSpecific2);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//  Allocate our context for this open.</span></span><br><span class="line">        <span class="comment">// 分配空间给每个打开上下文。所谓打开上下文就是每次绑定，用户分配的一片空间，用来保存这次绑定相关的信息。这里用宏NPROT_ALLOC_MEM分配内存是为了调试的方便。实际上本质是用NdisAllocateMemoryWithTag分配空间。读者如果用ExAllocatePoolWithTag代替也是可行的。只是要注意必须是Nonpaged空间。</span></span><br><span class="line">        <span class="built_in">NPROT_ALLOC_MEM</span>(pOpenContext, <span class="built_in">sizeof</span>(NDISPROT_OPEN_CONTEXT));</span><br><span class="line">        <span class="keyword">if</span> (pOpenContext == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            Status = NDIS_STATUS_RESOURCES;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 内存清0。同样用宏。实际上用的NdisZeroMemory。</span></span><br><span class="line">        <span class="built_in">NPROT_ZERO_MEM</span>(pOpenContext, <span class="built_in">sizeof</span>(NDISPROT_OPEN_CONTEXT));</span><br><span class="line">        <span class="comment">// 给这个空间写一个特征数据便于识别判错。</span></span><br><span class="line">        <span class="built_in">NPROT_SET_SIGNATURE</span>(pOpenContext, oc);</span><br><span class="line">        <span class="comment">// 初始化几个用到的数据成员。锁、读队列、写对队列、包队列</span></span><br><span class="line">        <span class="comment">// 电源打开事件</span></span><br><span class="line">        <span class="built_in">NPROT_INIT_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="built_in">NPROT_INIT_LIST_HEAD</span>(&amp;pOpenContext-&gt;PendedReads);</span><br><span class="line">        <span class="built_in">NPROT_INIT_LIST_HEAD</span>(&amp;pOpenContext-&gt;PendedWrites);</span><br><span class="line">        <span class="built_in">NPROT_INIT_LIST_HEAD</span>(&amp;pOpenContext-&gt;RecvPktQueue);</span><br><span class="line">        <span class="built_in">NPROT_INIT_EVENT</span>(&amp;pOpenContext-&gt;PoweredUpEvent);</span><br><span class="line">        <span class="comment">//  Start off by assuming that the device below is powered up.</span></span><br><span class="line">        <span class="comment">// 认为开始的时候电源是打开的。</span></span><br><span class="line">        <span class="built_in">NPROT_SIGNAL_EVENT</span>(&amp;pOpenContext-&gt;PoweredUpEvent);</span><br><span class="line">        <span class="comment">//  Determine the platform we are running on.</span></span><br><span class="line">        <span class="comment">// 下面开始检测我们运行在什么平台。首先假定是Win9x.但是为了去掉多余的部分，实际上我已经去掉了对Win9x的支持。所以下面这一段已经没有意义了。但是下面的代码依然有参考价值。实际上是在读取注册表的配置。</span></span><br><span class="line">        <span class="comment">//pOpenContext-&gt;bRunningOnWin9x = TRUE;</span></span><br><span class="line">        <span class="comment">//NdisOpenProtocolConfiguration(&amp;ConfigStatus,&amp;ConfigHandle,(PNDIS_STRING)SystemSpecific1);</span></span><br><span class="line">        <span class="comment">//if (ConfigStatus == NDIS_STATUS_SUCCESS)&#123;</span></span><br><span class="line">        <span class="comment">//    PNDIS_CONFIGURATION_PARAMETER   pParameter;</span></span><br><span class="line">        <span class="comment">//    NDIS_STRING                     VersionKey = NDIS_STRING_CONST(&quot;Environment&quot;);</span></span><br><span class="line">        <span class="comment">//    NdisReadConfiguration(&amp;ConfigStatus,&amp;pParameter,ConfigHandle,&amp;VersionKey,NdisParameterInteger);</span></span><br><span class="line">        <span class="comment">//    if ((ConfigStatus == NDIS_STATUS_SUCCESS) &amp;&amp; ((pParameter-&gt;ParameterType == NdisParameterInteger) || (pParameter-&gt;ParameterType == NdisParameterHexInteger)))</span></span><br><span class="line">        <span class="comment">//        pOpenContext-&gt;bRunningOnWin9x = (pParameter-&gt;ParameterData.IntegerData == NdisEnvironmentWindows);</span></span><br><span class="line">        <span class="comment">//    NdisCloseConfiguration(ConfigHandle);</span></span><br><span class="line">        <span class="comment">//&#125;;</span></span><br><span class="line">        <span class="built_in">NPROT_REF_OPEN</span>(pOpenContext);</span><br><span class="line">        <span class="comment">//  Add it to the global list.</span></span><br><span class="line">        <span class="comment">// 因为打开上下文已经被分配好。所以这里将这个打开上下文保存到全局链表里以便日后检索。注意这个操作要加锁。实际上这里用的就是读者前面学过的自旋锁。</span></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">        <span class="built_in">NPROT_INSERT_TAIL_LIST</span>(&amp;Globals.OpenList, &amp;pOpenContext-&gt;Link);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">        <span class="comment">// 正式的绑定过程。</span></span><br><span class="line">        Status = <span class="built_in">ndisprotCreateBinding</span>(pOpenContext, (PUCHAR)pDeviceName-&gt;Buffer, pDeviceName-&gt;Length);</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    *pStatus = Status;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtOpenAdapterComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  Status,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  OpenErrorCode</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Completion routine called by NDIS if our call to NdisOpenAdapter</span></span></span><br><span class="line"><span class="comment"><span class="function">    pends. Wake up the thread that called NdisOpenAdapter.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context structure</span></span></span><br><span class="line"><span class="comment"><span class="function">    Status - status of the open</span></span></span><br><span class="line"><span class="comment"><span class="function">    OpenErrorCode - if unsuccessful, additional information</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT           pOpenContext;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(OpenErrorCode);</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    pOpenContext-&gt;BindStatus = Status;</span><br><span class="line">    <span class="built_in">NPROT_SIGNAL_EVENT</span>(&amp;pOpenContext-&gt;BindEvent);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID <span class="title">NdisProtUnbindAdapter</span><span class="params">(OUT PNDIS_STATUS pStatus, IN NDIS_HANDLE ProtocolBindingContext, IN NDIS_HANDLE UnbindContext)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS calls this when it wants us to close the binding to an adapter.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pStatus - place to return status of Unbind</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context structure</span></span></span><br><span class="line"><span class="comment"><span class="function">    UnbindContext - to use in NdisCompleteUnbindAdapter if we return pending</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT           pOpenContext;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(UnbindContext);</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    <span class="comment">//  Mark this open as having seen an Unbind.</span></span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_UNBIND_FLAGS, NUIOO_UNBIND_RECEIVED); <span class="comment">//无条件设置接收到解绑的标记</span></span><br><span class="line">    <span class="comment">//  In case we had threads blocked for the device below to be powered up, wake them up.</span></span><br><span class="line">    <span class="built_in">NPROT_SIGNAL_EVENT</span>(&amp;pOpenContext-&gt;PoweredUpEvent); <span class="comment">//设置事件 通知所有在等待电源启动的线程 避免一些请求无法完成</span></span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="built_in">ndisprotShutdownBinding</span>(pOpenContext); <span class="comment">//解绑</span></span><br><span class="line">    *pStatus = NDIS_STATUS_SUCCESS;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtCloseAdapterComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  Status</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Called by NDIS to complete a pended call to NdisCloseAdapter.</span></span></span><br><span class="line"><span class="comment"><span class="function">    We wake up the thread waiting for this completion.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context structure</span></span></span><br><span class="line"><span class="comment"><span class="function">    Status - Completion status of NdisCloseAdapter</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT           pOpenContext;</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    pOpenContext-&gt;BindStatus = Status;</span><br><span class="line">    <span class="built_in">NPROT_SIGNAL_EVENT</span>(&amp;pOpenContext-&gt;BindEvent);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtPnPEventHandler</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNET_PNP_EVENT               pNetPnPEvent</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Called by NDIS to notify us of a PNP event. The most significant</span></span></span><br><span class="line"><span class="comment"><span class="function">    one for us is power state change.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context structure</span></span></span><br><span class="line"><span class="comment"><span class="function">                this is NULL for global reconfig events.</span></span></span><br><span class="line"><span class="comment"><span class="function">    pNetPnPEvent - pointer to the PNP event</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Our processing status for the PNP event.</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT           pOpenContext;</span><br><span class="line">    NDIS_STATUS                     Status;</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="keyword">switch</span> (pNetPnPEvent-&gt;NetEvent) &#123;</span><br><span class="line">        <span class="keyword">case</span> NetEventSetPower:</span><br><span class="line">            <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">            pOpenContext-&gt;PowerState = *(PNET_DEVICE_POWER_STATE)pNetPnPEvent-&gt;Buffer;</span><br><span class="line">            <span class="keyword">if</span> (pOpenContext-&gt;PowerState &gt; NetDeviceStateD0) &#123;</span><br><span class="line">                <span class="comment">//  The device below is transitioning to a low power state.</span></span><br><span class="line">                <span class="comment">//  Block any threads attempting to query the device while</span></span><br><span class="line">                <span class="comment">//  in this state.</span></span><br><span class="line">                <span class="built_in">NPROT_INIT_EVENT</span>(&amp;pOpenContext-&gt;PoweredUpEvent);</span><br><span class="line">                <span class="comment">//  Wait for any I/O in progress to complete.</span></span><br><span class="line">                <span class="built_in">ndisprotWaitForPendingIO</span>(pOpenContext, FALSE);</span><br><span class="line">                <span class="comment">//  Return any receives that we had queued up.</span></span><br><span class="line">                <span class="built_in">ndisprotFlushReceiveQueue</span>(pOpenContext);</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;PnPEvent: Open %p, SetPower to %d\n&quot;</span>,</span><br><span class="line">                                 pOpenContext, pOpenContext-&gt;PowerState));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//  The device below is powered up.</span></span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;PnPEvent: Open %p, SetPower ON: %d\n&quot;</span>,</span><br><span class="line">                                 pOpenContext, pOpenContext-&gt;PowerState));</span><br><span class="line">                <span class="built_in">NPROT_SIGNAL_EVENT</span>(&amp;pOpenContext-&gt;PoweredUpEvent);</span><br><span class="line">            &#125;</span><br><span class="line">            Status = NDIS_STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> NetEventQueryPower:</span><br><span class="line">            Status = NDIS_STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> NetEventBindsComplete:</span><br><span class="line">            <span class="built_in">NPROT_SIGNAL_EVENT</span>(&amp;Globals.BindsComplete);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">ndisprotRegisterExCallBack</span>()) &#123;</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_ERROR, (<span class="string">&quot;DriverEntry: ndisprotRegisterExCallBack failed\n&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            Status = NDIS_STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> NetEventQueryRemoveDevice:</span><br><span class="line">        <span class="keyword">case</span> NetEventCancelRemoveDevice:</span><br><span class="line">        <span class="keyword">case</span> NetEventReconfigure:</span><br><span class="line">        <span class="keyword">case</span> NetEventBindList:</span><br><span class="line">        <span class="keyword">case</span> NetEventPnPCapabilities:</span><br><span class="line">            Status = NDIS_STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Status = NDIS_STATUS_NOT_SUPPORTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;PnPEvent: Open %p, Event %d, Status %x\n&quot;</span>,</span><br><span class="line">                     pOpenContext, pNetPnPEvent-&gt;NetEvent, Status));</span><br><span class="line">    <span class="keyword">return</span> (Status);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtProtocolUnloadHandler</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS calls this on a usermode request to uninstall us.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ndisprotDoProtocolUnload</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NDIS_STATUS <span class="title">ndisprotCreateBinding</span><span class="params">(IN PNDISPROT_OPEN_CONTEXT pOpenContext,__in_bcount(BindingInfoLength) IN PUCHAR pBindingInfo,IN ULONG BindingInfoLength)</span> </span>&#123;</span><br><span class="line">    NDIS_STATUS Status;</span><br><span class="line">    NDIS_STATUS  OpenErrorCode;</span><br><span class="line">    NDIS_MEDIUM  MediumArray[<span class="number">1</span>] = &#123; NdisMedium802_3 &#125;;</span><br><span class="line">    UINT  SelectedMediumIndex;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT  pTmpOpenContext;</span><br><span class="line">    BOOLEAN  fDoNotDisturb = FALSE;</span><br><span class="line">    BOOLEAN  fOpenComplete = FALSE;</span><br><span class="line">    ULONG  BytesProcessed;</span><br><span class="line">    ULONG GenericUlong = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 输出一句调试信息。</span></span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;CreateBinding: open %p/%x, device [%ws]\n&quot;</span>,pOpenContext, pOpenContext-&gt;Flags, pBindingInfo));</span><br><span class="line">    Status = NDIS_STATUS_SUCCESS;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 检查看看是否已经绑定了这个网卡。如果已经绑定的话，就没有必要再次绑定了，直接返回成功即可。请注意，ndisprotLookupDevice会给这个打开上下文增加一个引用。</span></span><br><span class="line">        pTmpOpenContext = <span class="built_in">ndisprotLookupDevice</span>(pBindingInfo, BindingInfoLength);</span><br><span class="line">        <span class="comment">// 如果没有找到的话，就返回NULL了。</span></span><br><span class="line">        <span class="keyword">if</span> (pTmpOpenContext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: Binding to device %ws already exists on open %p\n&quot;</span>, pTmpOpenContext-&gt;DeviceName.Buffer, pTmpOpenContext));</span><br><span class="line">            <span class="comment">// 减少这个打开上下文的一个引用。</span></span><br><span class="line">            <span class="built_in">NPROT_DEREF_OPEN</span>(pTmpOpenContext);</span><br><span class="line">            Status = NDIS_STATUS_FAILURE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 获得锁。为什么这里要用锁？这是因为只有对空闲的打开上下文</span></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 通过标记来检查...如果绑定标志不是空闲状态，或者解除绑定信息收到了解除绑定的要求，那就直接返回失败。</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_IDLE) || <span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_UNBIND_FLAGS, NUIOO_UNBIND_RECEIVED)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            Status = NDIS_STATUS_NOT_ACCEPTED;</span><br><span class="line">            <span class="comment">// 设置了标记，表示</span></span><br><span class="line">            fDoNotDisturb = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 设置标记，表示我们已经开始绑定了。别人勿操作它。</span></span><br><span class="line">        <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_OPENING);</span><br><span class="line">        <span class="comment">// 释放锁。</span></span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 分配名字。到这里开始绑定了。先分配设备名字符串。</span></span><br><span class="line">        <span class="built_in">NPROT_ALLOC_MEM</span>(pOpenContext-&gt;DeviceName.Buffer, BindingInfoLength + <span class="built_in">sizeof</span>(WCHAR));</span><br><span class="line">        <span class="keyword">if</span> (pOpenContext-&gt;DeviceName.Buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: failed to alloc device name buf (%d bytes)\n&quot;</span>, BindingInfoLength + <span class="built_in">sizeof</span>(WCHAR)));</span><br><span class="line">            Status = NDIS_STATUS_RESOURCES;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 从pBindingInfo中把字符串拷贝出来。</span></span><br><span class="line">        <span class="built_in">NPROT_COPY_MEM</span>(pOpenContext-&gt;DeviceName.Buffer, pBindingInfo, BindingInfoLength);</span><br><span class="line">        <span class="meta">#<span class="keyword">pragma</span> prefast(suppress: 12009, <span class="string">&quot;DeviceName length will not cause overflow&quot;</span>)</span></span><br><span class="line">        * (PWCHAR)((PUCHAR)pOpenContext-&gt;DeviceName.Buffer + BindingInfoLength) = <span class="string">L&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">NdisInitUnicodeString</span>(&amp;pOpenContext-&gt;DeviceName, pOpenContext-&gt;DeviceName.Buffer);</span><br><span class="line">        <span class="comment">// 分配包池。用来做发送缓冲区，容纳将要发送出去的包。</span></span><br><span class="line">        <span class="built_in">NdisAllocatePacketPoolEx</span>(&amp;Status,&amp;pOpenContext-&gt;SendPacketPool,MIN_SEND_PACKET_POOL_SIZE,MAX_SEND_PACKET_POOL_SIZE - MIN_SEND_PACKET_POOL_SIZE,<span class="built_in">sizeof</span>(NPROT_SEND_PACKET_RSVD));</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: failed to alloc send packet pool: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 分配包池，用来容纳</span></span><br><span class="line">        <span class="built_in">NdisAllocatePacketPoolEx</span>(&amp;Status,&amp;pOpenContext-&gt;RecvPacketPool,MIN_RECV_PACKET_POOL_SIZE,MAX_RECV_PACKET_POOL_SIZE - MIN_RECV_PACKET_POOL_SIZE,<span class="built_in">sizeof</span>(NPROT_RECV_PACKET_RSVD));</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: failed to alloc recv packet pool: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 包池。用来做接收缓冲区。</span></span><br><span class="line">        <span class="built_in">NdisAllocateBufferPool</span>(&amp;Status,&amp;pOpenContext-&gt;RecvBufferPool,MAX_RECV_PACKET_POOL_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: failed to alloc recv buffer pool: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 电源状态是打开着的。</span></span><br><span class="line">        pOpenContext-&gt;PowerState = NetDeviceStateD0;</span><br><span class="line">        <span class="comment">// 初始化一个打开事件。（打开就是绑定！）</span></span><br><span class="line">        <span class="built_in">NPROT_INIT_EVENT</span>(&amp;pOpenContext-&gt;BindEvent);</span><br><span class="line">        <span class="built_in">NdisOpenAdapter</span>(&amp;Status,&amp;OpenErrorCode,&amp;pOpenContext-&gt;BindingHandle,&amp;SelectedMediumIndex,&amp;MediumArray[<span class="number">0</span>],<span class="built_in">sizeof</span>(MediumArray) / <span class="built_in">sizeof</span>(NDIS_MEDIUM),Globals.NdisProtocolHandle,(NDIS_HANDLE)pOpenContext,&amp;pOpenContext-&gt;DeviceName,<span class="number">0</span>,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">// 等待请求完成。</span></span><br><span class="line">        <span class="keyword">if</span> (Status == NDIS_STATUS_PENDING) &#123;</span><br><span class="line">            <span class="built_in">NPROT_WAIT_EVENT</span>(&amp;pOpenContext-&gt;BindEvent, <span class="number">0</span>);</span><br><span class="line">            Status = pOpenContext-&gt;BindStatus;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 如果不成功</span></span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: NdisOpenAdapter (%ws) failed: %x\n&quot;</span>, pOpenContext-&gt;DeviceName.Buffer, Status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 记住我们已经成功的绑定了。但是我们还没有更新打开状态。这是为了避免别的线程开始关闭这个绑定。</span></span><br><span class="line">        fOpenComplete = TRUE;</span><br><span class="line">        <span class="comment">// 发请求，获得一个可阅读的名字。不过这并不是非成功不可的。所以不检查返回值。</span></span><br><span class="line">        (VOID)<span class="built_in">NdisQueryAdapterInstanceName</span>(&amp;pOpenContext-&gt;DeviceDescr,pOpenContext-&gt;BindingHandle);</span><br><span class="line">        <span class="comment">// 获得下面网卡的Mac地址</span></span><br><span class="line">        Status = <span class="built_in">ndisprotDoRequest</span>(pOpenContext,NdisRequestQueryInformation,OID_802_3_CURRENT_ADDRESS,&amp;pOpenContext-&gt;CurrentAddress[<span class="number">0</span>],NPROT_MAC_ADDR_LEN,&amp;BytesProcessed);</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: qry current address failed: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 获得网卡选项</span></span><br><span class="line">        Status = <span class="built_in">ndisprotDoRequest</span>(pOpenContext,NdisRequestQueryInformation,OID_GEN_MAC_OPTIONS,&amp;pOpenContext-&gt;MacOptions,<span class="built_in">sizeof</span>(pOpenContext-&gt;MacOptions),&amp;BytesProcessed);</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: qry MAC options failed: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 获得最大帧长</span></span><br><span class="line">        Status = <span class="built_in">ndisprotDoRequest</span>(pOpenContext,NdisRequestQueryInformation,OID_GEN_MAXIMUM_FRAME_SIZE,&amp;pOpenContext-&gt;MaxFrameSize,<span class="built_in">sizeof</span>(pOpenContext-&gt;MaxFrameSize),&amp;BytesProcessed);</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: qry max frame failed: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 获得下层连接状态。</span></span><br><span class="line">        Status = <span class="built_in">ndisprotDoRequest</span>(pOpenContext,NdisRequestQueryInformation,OID_GEN_MEDIA_CONNECT_STATUS,&amp;GenericUlong,<span class="built_in">sizeof</span>(GenericUlong),&amp;BytesProcessed);</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;CreateBinding: qry media connect status failed: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (GenericUlong == NdisMediaStateConnected)</span><br><span class="line">            <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_MEDIA_FLAGS, NUIOO_MEDIA_CONNECTED);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_MEDIA_FLAGS, NUIOO_MEDIA_DISCONNECTED);</span><br><span class="line">        <span class="comment">// 设置标记</span></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE);</span><br><span class="line">        <span class="comment">// 检测是否这时候出现了一个解除绑定请求</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_UNBIND_FLAGS, NUIOO_UNBIND_RECEIVED))</span><br><span class="line">            <span class="comment">// 出现了则这次绑定失败</span></span><br><span class="line">            Status = NDIS_STATUS_FAILURE;</span><br><span class="line">        <span class="comment">// 标记测试完之后就可以解锁了。</span></span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="comment">// 如果没有成功，而且</span></span><br><span class="line">    <span class="keyword">if</span> ((Status != NDIS_STATUS_SUCCESS) &amp;&amp; !fDoNotDisturb) &#123;</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 如果是已经成功的绑定了</span></span><br><span class="line">        <span class="keyword">if</span> (fOpenComplete)</span><br><span class="line">            <span class="comment">// 如果已经绑定结束了，设置已经绑定标记。</span></span><br><span class="line">            <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_OPENING))</span><br><span class="line">            <span class="comment">// 如果是正在绑定过程中，设置绑定失败了。</span></span><br><span class="line">            <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_FAILED);</span><br><span class="line">        <span class="comment">// 释放锁。</span></span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 调用停止绑定函数。这里会释放所有资源。</span></span><br><span class="line">        <span class="built_in">ndisprotShutdownBinding</span>(pOpenContext);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;CreateBinding: OpenContext %p, Status %x\n&quot;</span>,pOpenContext, Status));</span><br><span class="line">    <span class="keyword">return</span> (Status);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID <span class="title">ndisprotShutdownBinding</span><span class="params">(IN PNDISPROT_OPEN_CONTEXT pOpenContext)</span> </span>&#123;</span><br><span class="line">    NDIS_STATUS Status;</span><br><span class="line">    BOOLEAN DoCloseBinding = FALSE;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 检查标记，如果是正在打开的话，立刻退出。放弃解除绑定操作。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_OPENING)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 如果是绑定已经完成的情况，则设置为开始解除绑定。其他的情况则根本不用做下面的操作。因为绑定既然没有完成，也当然不用解除绑定。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_CLOSING);</span><br><span class="line">            DoCloseBinding = TRUE;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="keyword">if</span> (DoCloseBinding) &#123;</span><br><span class="line">            <span class="comment">// 从这里开始解除绑定。</span></span><br><span class="line">            ULONG    PacketFilter = <span class="number">0</span>;</span><br><span class="line">            ULONG    BytesRead = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 把绑定了的网卡的包过滤器设置为0，换句话说，就是从现在开始停止收包。这是为了便于清理资源。</span></span><br><span class="line">            Status = <span class="built_in">ndisprotDoRequest</span>(pOpenContext, NdisRequestSetInformation, OID_GEN_CURRENT_PACKET_FILTER, &amp;PacketFilter, <span class="built_in">sizeof</span>(PacketFilter), &amp;BytesRead);</span><br><span class="line">            <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS)</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;ShutDownBinding: set packet filter failed: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="comment">// 把这个网卡的广播列表设置为NULL.</span></span><br><span class="line">            Status = <span class="built_in">ndisprotDoRequest</span>(pOpenContext, NdisRequestSetInformation, OID_802_3_MULTICAST_LIST, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;BytesRead);</span><br><span class="line">            <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS)</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;ShutDownBinding: set multicast list failed: %x\n&quot;</span>, Status));</span><br><span class="line">            <span class="comment">// 取消所有的提交状态IRP。</span></span><br><span class="line">            <span class="built_in">ndisServiceIndicateStatusIrp</span>(pOpenContext, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>, TRUE);</span><br><span class="line">            <span class="comment">// 等待所有未决IRP完成。</span></span><br><span class="line">            <span class="built_in">ndisprotWaitForPendingIO</span>(pOpenContext, TRUE);</span><br><span class="line">            <span class="comment">// 清理掉接收队列中所有的包。</span></span><br><span class="line">            <span class="built_in">ndisprotFlushReceiveQueue</span>(pOpenContext);</span><br><span class="line">            <span class="comment">// 初始化绑定事件，这个时间将用来等待解除绑定完成。</span></span><br><span class="line">            <span class="built_in">NPROT_INIT_EVENT</span>(&amp;pOpenContext-&gt;BindEvent);</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;ShutdownBinding: Closing OpenContext %p, BindingHandle %p\n&quot;</span>, pOpenContext, pOpenContext-&gt;BindingHandle));</span><br><span class="line">            <span class="comment">// 正式调用解除绑定。</span></span><br><span class="line">            <span class="built_in">NdisCloseAdapter</span>(&amp;Status, pOpenContext-&gt;BindingHandle);</span><br><span class="line">            <span class="keyword">if</span> (Status == NDIS_STATUS_PENDING) &#123;</span><br><span class="line">                <span class="built_in">NPROT_WAIT_EVENT</span>(&amp;pOpenContext-&gt;BindEvent, <span class="number">0</span>);</span><br><span class="line">                Status = pOpenContext-&gt;BindStatus;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>(Status == NDIS_STATUS_SUCCESS);</span><br><span class="line">            pOpenContext-&gt;BindingHandle = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (DoCloseBinding) &#123;</span><br><span class="line">            <span class="comment">// 设置上已经解除绑定的标记。</span></span><br><span class="line">            <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_IDLE);</span><br><span class="line">            <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_UNBIND_FLAGS, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 下面的操作主要是释放资源。</span></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">        <span class="built_in">NPROT_REMOVE_ENTRY_LIST</span>(&amp;pOpenContext-&gt;Link);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">        <span class="built_in">ndisprotFreeBindResources</span>(pOpenContext);</span><br><span class="line">        <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);  <span class="comment">// Shutdown binding</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFreeBindResources</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT       pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Free any resources set up for an NDIS binding.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context block</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pOpenContext-&gt;SendPacketPool != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">NdisFreePacketPool</span>(pOpenContext-&gt;SendPacketPool);</span><br><span class="line">        pOpenContext-&gt;SendPacketPool = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pOpenContext-&gt;RecvPacketPool != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">NdisFreePacketPool</span>(pOpenContext-&gt;RecvPacketPool);</span><br><span class="line">        pOpenContext-&gt;RecvPacketPool = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pOpenContext-&gt;RecvBufferPool != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">NdisFreeBufferPool</span>(pOpenContext-&gt;RecvBufferPool);</span><br><span class="line">        pOpenContext-&gt;RecvBufferPool = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pOpenContext-&gt;SendBufferPool != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">NdisFreeBufferPool</span>(pOpenContext-&gt;SendBufferPool);</span><br><span class="line">        pOpenContext-&gt;SendBufferPool = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pOpenContext-&gt;DeviceName.Buffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">NPROT_FREE_MEM</span>(pOpenContext-&gt;DeviceName.Buffer);</span><br><span class="line">        pOpenContext-&gt;DeviceName.Buffer = <span class="literal">NULL</span>;</span><br><span class="line">        pOpenContext-&gt;DeviceName.Length =</span><br><span class="line">            pOpenContext-&gt;DeviceName.MaximumLength = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pOpenContext-&gt;DeviceDescr.Buffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// this would have been allocated by NdisQueryAdpaterInstanceName.</span></span><br><span class="line">        <span class="built_in">NdisFreeMemory</span>(pOpenContext-&gt;DeviceDescr.Buffer, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        pOpenContext-&gt;DeviceDescr.Buffer = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotWaitForPendingIO</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT            pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN                          DoCancelReads</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Utility function to wait for all outstanding I/O to complete</span></span></span><br><span class="line"><span class="comment"><span class="function">    on an open context. It is assumed that the open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    won&#x27;t go away while we are in this routine.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context structure</span></span></span><br><span class="line"><span class="comment"><span class="function">    DoCancelReads - do we wait for pending reads to go away (and cancel them)?</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NDIS_STATUS     Status;</span><br><span class="line">    ULONG           LoopCount;</span><br><span class="line">    ULONG           PendingCount;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line">    <span class="comment">//  Wait for any pending sends or requests on the binding to complete.</span></span><br><span class="line">    <span class="keyword">for</span> (LoopCount = <span class="number">0</span>; LoopCount &lt; <span class="number">60</span>; LoopCount++) &#123;</span><br><span class="line">        Status = <span class="built_in">NdisQueryPendingIOCount</span>(</span><br><span class="line">            pOpenContext-&gt;BindingHandle,</span><br><span class="line">            &amp;PendingCount);</span><br><span class="line">        <span class="keyword">if</span> ((Status != NDIS_STATUS_SUCCESS) ||</span><br><span class="line">            (PendingCount == <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;WaitForPendingIO: Open %p, %d pending I/O at NDIS\n&quot;</span>,</span><br><span class="line">                         pOpenContext, PendingCount));</span><br><span class="line">        <span class="built_in">NPROT_SLEEP</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NPROT_ASSERT</span>(LoopCount &lt; <span class="number">60</span>);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span> <span class="comment">// NDIS51</span></span></span><br><span class="line">    <span class="comment">//  Make sure any threads trying to send have finished.</span></span><br><span class="line">    <span class="keyword">for</span> (LoopCount = <span class="number">0</span>; LoopCount &lt; <span class="number">60</span>; LoopCount++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pOpenContext-&gt;PendedSendCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;WaitForPendingIO: Open %p, %d pended sends\n&quot;</span>,</span><br><span class="line">                         pOpenContext, pOpenContext-&gt;PendedSendCount));</span><br><span class="line">        <span class="built_in">NPROT_SLEEP</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NPROT_ASSERT</span>(LoopCount &lt; <span class="number">60</span>);</span><br><span class="line">    <span class="keyword">if</span> (DoCancelReads) &#123;</span><br><span class="line">        <span class="comment">//  Wait for any pended reads to complete/cancel.</span></span><br><span class="line">        <span class="keyword">while</span> (pOpenContext-&gt;PendedReadCount != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;WaitForPendingIO: Open %p, %d pended reads\n&quot;</span>,</span><br><span class="line">                             pOpenContext, pOpenContext-&gt;PendedReadCount));</span><br><span class="line">            <span class="comment">//  Cancel any pending reads.</span></span><br><span class="line">            <span class="built_in">ndisprotCancelPendingReads</span>(pOpenContext);</span><br><span class="line">            <span class="built_in">NPROT_SLEEP</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDoProtocolUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Utility routine to handle unload from the NDIS protocol side.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NDIS_HANDLE     ProtocolHandle;</span><br><span class="line">    NDIS_STATUS     Status;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;ProtocolUnload: ProtocolHandle %lx\n&quot;</span>,</span><br><span class="line">                     Globals.NdisProtocolHandle));</span><br><span class="line">    <span class="keyword">if</span> (Globals.NdisProtocolHandle != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ProtocolHandle = Globals.NdisProtocolHandle;</span><br><span class="line">        Globals.NdisProtocolHandle = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">NdisDeregisterProtocol</span>(</span><br><span class="line">            &amp;Status,</span><br><span class="line">            ProtocolHandle</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NDIS_STATUS <span class="title">ndisprotDoRequest</span><span class="params">(IN PNDISPROT_OPEN_CONTEXT pOpenContext, IN NDIS_REQUEST_TYPE RequestType, IN NDIS_OID Oid, IN PVOID InformationBuffer, IN ULONG InformationBufferLength, OUT PULONG pBytesProcessed)</span> </span>&#123;</span><br><span class="line">    NDISPROT_REQUEST ReqContext;</span><br><span class="line">    PNDIS_REQUEST pNdisRequest = &amp;ReqContext.Request;</span><br><span class="line">    NDIS_STATUS Status;</span><br><span class="line">    <span class="comment">// 初始化一个事件。这个事件会在请求完成函数中被设置，以便通知请求完成了。</span></span><br><span class="line">    <span class="built_in">NPROT_INIT_EVENT</span>(&amp;ReqContext.ReqEvent);</span><br><span class="line">    <span class="comment">// 请求的类型。如果只是查询信息，只要用NdisRequestQueryInformation就可以了。</span></span><br><span class="line">    pNdisRequest-&gt;RequestType = RequestType;</span><br><span class="line">    <span class="comment">// 根据不同的请求类型，填写OID和输入输出缓冲区。</span></span><br><span class="line">    <span class="keyword">switch</span> (RequestType) &#123;</span><br><span class="line">        <span class="keyword">case</span> NdisRequestQueryInformation:</span><br><span class="line">        &#123;</span><br><span class="line">            pNdisRequest-&gt;DATA.QUERY_INFORMATION.Oid = Oid;</span><br><span class="line">            pNdisRequest-&gt;DATA.QUERY_INFORMATION.InformationBuffer = InformationBuffer;</span><br><span class="line">            pNdisRequest-&gt;DATA.QUERY_INFORMATION.InformationBufferLength = InformationBufferLength;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> NdisRequestSetInformation:</span><br><span class="line">        &#123;</span><br><span class="line">            pNdisRequest-&gt;DATA.SET_INFORMATION.Oid = Oid;</span><br><span class="line">            pNdisRequest-&gt;DATA.SET_INFORMATION.InformationBuffer = InformationBuffer;</span><br><span class="line">            pNdisRequest-&gt;DATA.SET_INFORMATION.InformationBufferLength = InformationBufferLength;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>(FALSE);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 发送请求</span></span><br><span class="line">    <span class="built_in">NdisRequest</span>(&amp;Status, pOpenContext-&gt;BindingHandle, pNdisRequest);</span><br><span class="line">    <span class="comment">// 如果是未决，则等待事件。这个事件会在完成函数中设置。</span></span><br><span class="line">    <span class="keyword">if</span> (Status == NDIS_STATUS_PENDING) &#123;</span><br><span class="line">        <span class="built_in">NPROT_WAIT_EVENT</span>(&amp;ReqContext.ReqEvent, <span class="number">0</span>);</span><br><span class="line">        Status = ReqContext.Status;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 如果成功了的话...</span></span><br><span class="line">    <span class="keyword">if</span> (Status == NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">        <span class="comment">// 获得结果的长度。这个结果的长度是实际需要的长度。可能比我们实际提供的长度要长。</span></span><br><span class="line">        *pBytesProcessed = (RequestType == NdisRequestQueryInformation) ? pNdisRequest-&gt;DATA.QUERY_INFORMATION.BytesWritten : pNdisRequest-&gt;DATA.SET_INFORMATION.BytesRead;</span><br><span class="line">        <span class="comment">// 如果结果长度比实际上我们提供的缓冲区要长，那么就简单的设置为输入参数中缓冲区的最大长度。</span></span><br><span class="line">        <span class="keyword">if</span> (*pBytesProcessed &gt; InformationBufferLength)</span><br><span class="line">            *pBytesProcessed = InformationBufferLength;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotValidateOpenAndDoRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_REQUEST_TYPE            RequestType,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_OID                     Oid,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID                        InformationBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        InformationBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                      pBytesProcessed,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN                      bWaitForPowerOn</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Utility routine to prevalidate and reference an open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    before calling ndisprotDoRequest. This routine makes sure</span></span></span><br><span class="line"><span class="comment"><span class="function">    we have a valid binding.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to our open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    RequestType - NdisRequest[Set|Query]Information</span></span></span><br><span class="line"><span class="comment"><span class="function">    Oid - the object being set/queried</span></span></span><br><span class="line"><span class="comment"><span class="function">    InformationBuffer - data for the request</span></span></span><br><span class="line"><span class="comment"><span class="function">    InformationBufferLength - length of the above</span></span></span><br><span class="line"><span class="comment"><span class="function">    pBytesProcessed - place to return bytes read/written</span></span></span><br><span class="line"><span class="comment"><span class="function">    bWaitForPowerOn - Wait for the device to be powered on if it isn&#x27;t already.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Status of the set/query request</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NDIS_STATUS             Status;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pOpenContext == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;ValidateOpenAndDoRequest: request on unassociated file object!\n&quot;</span>));</span><br><span class="line">            Status = NDIS_STATUS_INVALID_DATA;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">//  Proceed only if we have a binding.</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            Status = NDIS_STATUS_INVALID_DATA;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pOpenContext-&gt;BindingHandle != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">//  Make sure that the binding does not go away until we</span></span><br><span class="line">        <span class="comment">//  are finished with the request.</span></span><br><span class="line">        <span class="built_in">NdisInterlockedIncrement</span>((PLONG)&amp;pOpenContext-&gt;PendedSendCount);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="keyword">if</span> (bWaitForPowerOn) &#123;</span><br><span class="line">            <span class="comment">//  Wait for the device below to be powered up.</span></span><br><span class="line">            <span class="comment">//  We don&#x27;t wait indefinitely here - this is to avoid</span></span><br><span class="line">            <span class="comment">//  a PROCESS_HAS_LOCKED_PAGES bugcheck that could happen</span></span><br><span class="line">            <span class="comment">//  if the calling process terminates, and this IRP doesn&#x27;t</span></span><br><span class="line">            <span class="comment">//  complete within a reasonable time. An alternative would</span></span><br><span class="line">            <span class="comment">//  be to explicitly handle cancellation of this IRP.</span></span><br><span class="line">            <span class="built_in">NPROT_WAIT_EVENT</span>(&amp;pOpenContext-&gt;PoweredUpEvent, <span class="number">4500</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Status = <span class="built_in">ndisprotDoRequest</span>(</span><br><span class="line">            pOpenContext,</span><br><span class="line">            RequestType,</span><br><span class="line">            Oid,</span><br><span class="line">            InformationBuffer,</span><br><span class="line">            InformationBufferLength,</span><br><span class="line">            pBytesProcessed);</span><br><span class="line">        <span class="comment">//  Let go of the binding.</span></span><br><span class="line">        <span class="built_in">NdisInterlockedDecrement</span>((PLONG)&amp;pOpenContext-&gt;PendedSendCount);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;ValidateOpenAndDoReq: Open %p/%x, OID %x, Status %x\n&quot;</span>,</span><br><span class="line">                     pOpenContext, pOpenContext-&gt;Flags, Oid, Status));</span><br><span class="line">    <span class="keyword">return</span> (Status);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtResetComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  Status</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS entry point indicating that a protocol initiated reset</span></span></span><br><span class="line"><span class="comment"><span class="function">    has completed. Since we never call NdisReset(), this should</span></span></span><br><span class="line"><span class="comment"><span class="function">    never be called.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    Status - status of reset completion</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(ProtocolBindingContext);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(Status);</span><br><span class="line">    <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID <span class="title">NdisProtRequestComplete</span><span class="params">(IN NDIS_HANDLE ProtocolBindingContext, IN PNDIS_REQUEST pNdisRequest, IN NDIS_STATUS Status)</span> </span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    PNDISPROT_REQUEST            pReqContext;</span><br><span class="line">    <span class="comment">// 这两句话起验证的作用，确保输入参数ProtocolBindingContext是合法的。但是对后面的处理没影响。</span></span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    <span class="comment">// 从pNdisRequest中得到请求上下文</span></span><br><span class="line">    pReqContext = <span class="built_in">CONTAINING_RECORD</span>(pNdisRequest, NDISPROT_REQUEST, Request);</span><br><span class="line">    <span class="comment">// 保存结果状态</span></span><br><span class="line">    pReqContext-&gt;Status = Status;</span><br><span class="line">    <span class="comment">// 设置事件</span></span><br><span class="line">    <span class="built_in">NPROT_SIGNAL_EVENT</span>(&amp;pReqContext-&gt;ReqEvent);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtStatus</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                          ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                          GeneralStatus,</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(StatusBufferSize) IN PVOID  StatusBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                                 StatusBufferSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Protocol entry point called by NDIS to indicate a change</span></span></span><br><span class="line"><span class="comment"><span class="function">    in status at the miniport.</span></span></span><br><span class="line"><span class="comment"><span class="function">    We make note of reset and media connect status indications.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    GeneralStatus - status code</span></span></span><br><span class="line"><span class="comment"><span class="function">    StatusBuffer - status-specific additional information</span></span></span><br><span class="line"><span class="comment"><span class="function">    StatusBufferSize - size of the above</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(StatusBuffer);</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(StatusBufferSize);</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;Status: Open %p, Status %x\n&quot;</span>,</span><br><span class="line">                     pOpenContext, GeneralStatus));</span><br><span class="line">    <span class="built_in">ndisServiceIndicateStatusIrp</span>(pOpenContext,</span><br><span class="line">                                 GeneralStatus,</span><br><span class="line">                                 StatusBuffer,</span><br><span class="line">                                 StatusBufferSize,</span><br><span class="line">                                 FALSE);</span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pOpenContext-&gt;PowerState != NetDeviceStateD0) &#123;</span><br><span class="line">            <span class="comment">//  The device is in a low power state.</span></span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;Status: Open %p in power state %d,&quot;</span></span><br><span class="line">                             <span class="string">&quot; Status %x ignored\n&quot;</span>, pOpenContext,</span><br><span class="line">                             pOpenContext-&gt;PowerState, GeneralStatus));</span><br><span class="line">            <span class="comment">//  We continue and make note of status indications</span></span><br><span class="line">            <span class="comment">// break;</span></span><br><span class="line">            <span class="comment">//  NOTE that any actions we take based on these</span></span><br><span class="line">            <span class="comment">//  status indications should take into account</span></span><br><span class="line">            <span class="comment">//  the current device power state.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (GeneralStatus) &#123;</span><br><span class="line">            <span class="keyword">case</span> NDIS_STATUS_RESET_START:</span><br><span class="line">                <span class="built_in">NPROT_ASSERT</span>(!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags,</span><br><span class="line">                                               NUIOO_RESET_FLAGS,</span><br><span class="line">                                               NUIOO_RESET_IN_PROGRESS));</span><br><span class="line">                <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags,</span><br><span class="line">                                NUIOO_RESET_FLAGS,</span><br><span class="line">                                NUIOO_RESET_IN_PROGRESS);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NDIS_STATUS_RESET_END:</span><br><span class="line">                <span class="built_in">NPROT_ASSERT</span>(<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags,</span><br><span class="line">                                              NUIOO_RESET_FLAGS,</span><br><span class="line">                                              NUIOO_RESET_IN_PROGRESS));</span><br><span class="line">                <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags,</span><br><span class="line">                                NUIOO_RESET_FLAGS,</span><br><span class="line">                                NUIOO_NOT_RESETTING);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NDIS_STATUS_MEDIA_CONNECT:</span><br><span class="line">                <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags,</span><br><span class="line">                                NUIOO_MEDIA_FLAGS,</span><br><span class="line">                                NUIOO_MEDIA_CONNECTED);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> NDIS_STATUS_MEDIA_DISCONNECT:</span><br><span class="line">                <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags,</span><br><span class="line">                                NUIOO_MEDIA_FLAGS,</span><br><span class="line">                                NUIOO_MEDIA_DISCONNECTED);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtStatusComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Protocol entry point called by NDIS. We ignore this.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotQueryBinding</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PUCHAR                       pBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        InputLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        OutputLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                      pBytesReturned</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Return information about the specified binding.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pBuffer - pointer to NDISPROT_QUERY_BINDING</span></span></span><br><span class="line"><span class="comment"><span class="function">    InputLength - input buffer size</span></span></span><br><span class="line"><span class="comment"><span class="function">    OutputLength - output buffer size</span></span></span><br><span class="line"><span class="comment"><span class="function">    pBytesReturned - place to return copied byte count.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS_STATUS_SUCCESS if successful, failure code otherwise.</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_QUERY_BINDING      pQueryBinding;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    PLIST_ENTRY                 pEnt;</span><br><span class="line">    ULONG                       Remaining;</span><br><span class="line">    ULONG                       BindingIndex;</span><br><span class="line">    NDIS_STATUS                 Status;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (InputLength &lt; <span class="built_in">sizeof</span>(NDISPROT_QUERY_BINDING)) &#123;</span><br><span class="line">            Status = NDIS_STATUS_RESOURCES;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (OutputLength &lt; <span class="built_in">sizeof</span>(NDISPROT_QUERY_BINDING)) &#123;</span><br><span class="line">            Status = NDIS_STATUS_BUFFER_OVERFLOW;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Remaining = OutputLength - <span class="built_in">sizeof</span>(NDISPROT_QUERY_BINDING);</span><br><span class="line">        pQueryBinding = (PNDISPROT_QUERY_BINDING)pBuffer;</span><br><span class="line">        BindingIndex = pQueryBinding-&gt;BindingIndex;</span><br><span class="line">        Status = NDIS_STATUS_ADAPTER_NOT_FOUND;</span><br><span class="line">        pOpenContext = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">        <span class="keyword">for</span> (pEnt = Globals.OpenList.Flink;</span><br><span class="line">             pEnt != &amp;Globals.OpenList;</span><br><span class="line">             pEnt = pEnt-&gt;Flink) &#123;</span><br><span class="line">            pOpenContext = <span class="built_in">CONTAINING_RECORD</span>(pEnt, NDISPROT_OPEN_CONTEXT, Link);</span><br><span class="line">            <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">            <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="comment">//  Skip if not bound.</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE)) &#123;</span><br><span class="line">                <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (BindingIndex == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//  Got the binding we are looking for. Copy the device</span></span><br><span class="line">                <span class="comment">//  name and description strings to the output buffer.</span></span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_INFO,</span><br><span class="line">                       (<span class="string">&quot;QueryBinding: found open %p\n&quot;</span>, pOpenContext));</span><br><span class="line">                pQueryBinding-&gt;DeviceNameLength = pOpenContext-&gt;DeviceName.Length + <span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line">                pQueryBinding-&gt;DeviceDescrLength = pOpenContext-&gt;DeviceDescr.Length + <span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line">                <span class="keyword">if</span> (Remaining &lt; pQueryBinding-&gt;DeviceNameLength +</span><br><span class="line">                    pQueryBinding-&gt;DeviceDescrLength) &#123;</span><br><span class="line">                    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">                    Status = NDIS_STATUS_BUFFER_OVERFLOW;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">NPROT_ZERO_MEM</span>((PUCHAR)pBuffer + <span class="built_in">sizeof</span>(NDISPROT_QUERY_BINDING),</span><br><span class="line">                               pQueryBinding-&gt;DeviceNameLength +</span><br><span class="line">                               pQueryBinding-&gt;DeviceDescrLength);</span><br><span class="line">                pQueryBinding-&gt;DeviceNameOffset = <span class="built_in">sizeof</span>(NDISPROT_QUERY_BINDING);</span><br><span class="line">                <span class="built_in">NPROT_COPY_MEM</span>((PUCHAR)pBuffer + pQueryBinding-&gt;DeviceNameOffset,</span><br><span class="line">                               pOpenContext-&gt;DeviceName.Buffer,</span><br><span class="line">                               pOpenContext-&gt;DeviceName.Length);</span><br><span class="line">                pQueryBinding-&gt;DeviceDescrOffset = pQueryBinding-&gt;DeviceNameOffset +</span><br><span class="line">                    pQueryBinding-&gt;DeviceNameLength;</span><br><span class="line">                <span class="built_in">NPROT_COPY_MEM</span>((PUCHAR)pBuffer + pQueryBinding-&gt;DeviceDescrOffset,</span><br><span class="line">                               pOpenContext-&gt;DeviceDescr.Buffer,</span><br><span class="line">                               pOpenContext-&gt;DeviceDescr.Length);</span><br><span class="line">                <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">                *pBytesReturned = pQueryBinding-&gt;DeviceDescrOffset + pQueryBinding-&gt;DeviceDescrLength;</span><br><span class="line">                Status = NDIS_STATUS_SUCCESS;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            BindingIndex--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="keyword">return</span> (Status);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">PNDISPROT_OPEN_CONTEXT</span></span><br><span class="line"><span class="function"><span class="title">ndisprotLookupDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(BindingInfoLength) IN PUCHAR    pBindingInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                                    BindingInfoLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Search our global list for an open context structure that</span></span></span><br><span class="line"><span class="comment"><span class="function">    has a binding to the specified device, and return a pointer</span></span></span><br><span class="line"><span class="comment"><span class="function">    to it.</span></span></span><br><span class="line"><span class="comment"><span class="function">    <span class="doctag">NOTE:</span> we reference the open that we return.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pBindingInfo - pointer to unicode device name string</span></span></span><br><span class="line"><span class="comment"><span class="function">    BindingInfoLength - length in bytes of the above.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Pointer to the matching open context if found, else NULL</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    PLIST_ENTRY                 pEnt;</span><br><span class="line">    pOpenContext = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">    <span class="keyword">for</span> (pEnt = Globals.OpenList.Flink;</span><br><span class="line">         pEnt != &amp;Globals.OpenList;</span><br><span class="line">         pEnt = pEnt-&gt;Flink) &#123;</span><br><span class="line">        pOpenContext = <span class="built_in">CONTAINING_RECORD</span>(pEnt, NDISPROT_OPEN_CONTEXT, Link);</span><br><span class="line">        <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">        <span class="comment">//  Check if this has the name we are looking for.</span></span><br><span class="line">        <span class="keyword">if</span> ((pOpenContext-&gt;DeviceName.Length == BindingInfoLength) &amp;&amp;</span><br><span class="line">            <span class="built_in">NPROT_MEM_CMP</span>(pOpenContext-&gt;DeviceName.Buffer, pBindingInfo, BindingInfoLength)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_REF_OPEN</span>(pOpenContext);   <span class="comment">// ref added by LookupDevice</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pOpenContext = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">    <span class="keyword">return</span> (pOpenContext);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotQueryOidValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNDISPROT_OPEN_CONTEXT       pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PVOID                       pDataBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG                       BufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                      pBytesWritten</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Query an arbitrary OID value from the miniport.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context representing our binding to the miniport</span></span></span><br><span class="line"><span class="comment"><span class="function">    pDataBuffer - place to store the returned value</span></span></span><br><span class="line"><span class="comment"><span class="function">    BufferLength - length of the above</span></span></span><br><span class="line"><span class="comment"><span class="function">    pBytesWritten - place to return length returned</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS_STATUS_SUCCESS if we successfully queried the OID.</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS_STATUS_XXX error code otherwise.</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NDIS_STATUS             Status;</span><br><span class="line">    PNDISPROT_QUERY_OID      pQuery;</span><br><span class="line">    NDIS_OID                Oid;</span><br><span class="line">    Oid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (BufferLength &lt; <span class="built_in">sizeof</span>(NDISPROT_QUERY_OID)) &#123;</span><br><span class="line">            Status = NDIS_STATUS_BUFFER_TOO_SHORT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pQuery = (PNDISPROT_QUERY_OID)pDataBuffer;</span><br><span class="line">        Oid = pQuery-&gt;Oid;</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE)) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN,</span><br><span class="line">                   (<span class="string">&quot;QueryOid: Open %p/%x is in invalid state\n&quot;</span>,</span><br><span class="line">                    pOpenContext, pOpenContext-&gt;Flags));</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            Status = NDIS_STATUS_FAILURE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//  Make sure the binding doesn&#x27;t go away.</span></span><br><span class="line">        <span class="built_in">NdisInterlockedIncrement</span>((PLONG)&amp;pOpenContext-&gt;PendedSendCount);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        Status = <span class="built_in">ndisprotDoRequest</span>(</span><br><span class="line">            pOpenContext,</span><br><span class="line">            NdisRequestQueryInformation,</span><br><span class="line">            Oid,</span><br><span class="line">            &amp;pQuery-&gt;Data[<span class="number">0</span>],</span><br><span class="line">            BufferLength - <span class="built_in">FIELD_OFFSET</span>(NDISPROT_QUERY_OID, Data),</span><br><span class="line">            pBytesWritten);</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="built_in">NdisInterlockedDecrement</span>((PLONG)&amp;pOpenContext-&gt;PendedSendCount);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="keyword">if</span> (Status == NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            *pBytesWritten += <span class="built_in">FIELD_OFFSET</span>(NDISPROT_QUERY_OID, Data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;QueryOid: Open %p/%x, OID %x, Status %x\n&quot;</span>,</span><br><span class="line">                     pOpenContext, pOpenContext-&gt;Flags, Oid, Status));</span><br><span class="line">    <span class="keyword">return</span> (Status);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotSetOidValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNDISPROT_OPEN_CONTEXT       pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PVOID                       pDataBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG                       BufferLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Set an arbitrary OID value to the miniport.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context representing our binding to the miniport</span></span></span><br><span class="line"><span class="comment"><span class="function">    pDataBuffer - buffer that contains the value to be set</span></span></span><br><span class="line"><span class="comment"><span class="function">    BufferLength - length of the above</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS_STATUS_SUCCESS if we successfully set the OID</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS_STATUS_XXX error code otherwise.</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NDIS_STATUS             Status;</span><br><span class="line">    PNDISPROT_SET_OID        pSet;</span><br><span class="line">    NDIS_OID                Oid;</span><br><span class="line">    ULONG                   BytesWritten;</span><br><span class="line">    Oid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (BufferLength &lt; <span class="built_in">sizeof</span>(NDISPROT_SET_OID)) &#123;</span><br><span class="line">            Status = NDIS_STATUS_BUFFER_TOO_SHORT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pSet = (PNDISPROT_SET_OID)pDataBuffer;</span><br><span class="line">        Oid = pSet-&gt;Oid;</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE)) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN,</span><br><span class="line">                   (<span class="string">&quot;SetOid: Open %p/%x is in invalid state\n&quot;</span>,</span><br><span class="line">                    pOpenContext, pOpenContext-&gt;Flags));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            Status = NDIS_STATUS_FAILURE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//  Make sure the binding doesn&#x27;t go away.</span></span><br><span class="line">        <span class="built_in">NdisInterlockedIncrement</span>((PLONG)&amp;pOpenContext-&gt;PendedSendCount);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        Status = <span class="built_in">ndisprotDoRequest</span>(</span><br><span class="line">            pOpenContext,</span><br><span class="line">            NdisRequestSetInformation,</span><br><span class="line">            Oid,</span><br><span class="line">            &amp;pSet-&gt;Data[<span class="number">0</span>],</span><br><span class="line">            BufferLength - <span class="built_in">FIELD_OFFSET</span>(NDISPROT_SET_OID, Data),</span><br><span class="line">            &amp;BytesWritten);</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="built_in">NdisInterlockedDecrement</span>((PLONG)&amp;pOpenContext-&gt;PendedSendCount);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;SetOid: Open %p/%x, OID %x, Status %x\n&quot;</span>,</span><br><span class="line">                     pOpenContext, pOpenContext-&gt;Flags, Oid, Status));</span><br><span class="line">    <span class="keyword">return</span> (Status);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotQueueStatusIndicationIrp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNDISPROT_OPEN_CONTEXT       pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PIRP                         pIrp,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                       pBytesReturned</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Queue the IRP in the context structure. This IRP will be completed</span></span></span><br><span class="line"><span class="comment"><span class="function">    one of the following occurs: 1) Status indication is received by</span></span></span><br><span class="line"><span class="comment"><span class="function">    the bound miniport, 2) IRP is cancelled by the sender, 3) We have</span></span></span><br><span class="line"><span class="comment"><span class="function">    been asked to unbind from the miniport either because the device is removed</span></span></span><br><span class="line"><span class="comment"><span class="function">    or user unchecked our binding in the network connection applet.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context representing our binding to the miniport</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NTSTATUS code</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS NtStatus;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;--&gt;ndisprotQueueStatusIndicationIrp\n&quot;</span>));</span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="keyword">if</span> (pOpenContext-&gt;StatusIndicationIrp) &#123;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;Control IRP to indicate status is already pending: %p\n&quot;</span>, pIrp));</span><br><span class="line">        NtStatus = STATUS_DEVICE_BUSY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Since we are queueing the IRP, we should set the cancel routine.</span></span><br><span class="line">        <span class="built_in">IoSetCancelRoutine</span>(pIrp, ndisCancelIndicateStatusIrp);</span><br><span class="line">        <span class="comment">// Let us check to see if the IRP is cancelled at this point.</span></span><br><span class="line">        <span class="keyword">if</span> (pIrp-&gt;Cancel &amp;&amp; <span class="built_in">IoSetCancelRoutine</span>(pIrp, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="comment">// The IRP has been already cancelled but the I/O manager</span></span><br><span class="line">            <span class="comment">// hasn&#x27;t called the cancel routine yet. So complete the</span></span><br><span class="line">            <span class="comment">// IRP after releasing the lock.</span></span><br><span class="line">            NtStatus = STATUS_CANCELLED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Queue the IRP and return status pending.</span></span><br><span class="line">            <span class="built_in">IoMarkIrpPending</span>(pIrp);</span><br><span class="line">            pOpenContext-&gt;StatusIndicationIrp = pIrp;</span><br><span class="line">            NtStatus = STATUS_PENDING;</span><br><span class="line">            <span class="comment">// The IRP shouldn&#x27;t be accessed after the lock is released</span></span><br><span class="line">            <span class="comment">// It could be grabbed by another thread or the cancel routine</span></span><br><span class="line">            <span class="comment">// is running.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *pBytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;&lt;--ndisprotQueueStatusIndicationIrp\n&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> NtStatus;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisServiceIndicateStatusIrp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT                       OpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                                  GeneralStatus,</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount_opt(StatusBufferSize) IN PVOID      StatusBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                                         StatusBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN                                      Cancel</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">   We process the IRP based on the input arguments and complete</span></span></span><br><span class="line"><span class="comment"><span class="function">   the IRP. If the IRP was cancelled for some reason we will let</span></span></span><br><span class="line"><span class="comment"><span class="function">   the cancel routine do the IRP completion.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    GeneralStatus - status code</span></span></span><br><span class="line"><span class="comment"><span class="function">    StatusBuffer - status-specific additional information</span></span></span><br><span class="line"><span class="comment"><span class="function">    StatusBufferSize - size of the above</span></span></span><br><span class="line"><span class="comment"><span class="function">    Cancel - Should the IRP be cancelled right away.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIRP pIrp = <span class="literal">NULL</span>;</span><br><span class="line">    PIO_STACK_LOCATION      pIrpSp = <span class="literal">NULL</span>;</span><br><span class="line">    PNDISPROT_INDICATE_STATUS     pIndicateStatus = <span class="literal">NULL</span>;</span><br><span class="line">    NTSTATUS    ntStatus;</span><br><span class="line">    ULONG   bytes = <span class="number">0</span>;</span><br><span class="line">    ULONG inBufLength, outBufLength;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;--&gt;ndisServiceIndicateStatusIrp\n&quot;</span>));</span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;OpenContext-&gt;Lock);</span><br><span class="line">    pIrp = OpenContext-&gt;StatusIndicationIrp;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pIrp) &#123;</span><br><span class="line">            pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">            pIndicateStatus = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">            inBufLength = pIrpSp-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">            outBufLength = pIrpSp-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line">            <span class="comment">// Clear the cancel routine.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">IoSetCancelRoutine</span>(pIrp, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                <span class="comment">// Cancel routine cannot run now and cannot have already </span></span><br><span class="line">                <span class="comment">// started to run.</span></span><br><span class="line">                ntStatus = STATUS_CANCELLED;</span><br><span class="line">                <span class="keyword">if</span> (!Cancel) &#123;</span><br><span class="line">                    <span class="comment">// Check to see whether the buffer is large enough.</span></span><br><span class="line">                    <span class="keyword">if</span> (outBufLength &gt;= <span class="built_in">sizeof</span>(NDISPROT_INDICATE_STATUS) &amp;&amp;</span><br><span class="line">                        (outBufLength - <span class="built_in">sizeof</span>(NDISPROT_INDICATE_STATUS)) &gt;= StatusBufferSize) &#123;</span><br><span class="line">                        pIndicateStatus-&gt;IndicatedStatus = GeneralStatus;</span><br><span class="line">                        pIndicateStatus-&gt;StatusBufferLength = StatusBufferSize;</span><br><span class="line">                        pIndicateStatus-&gt;StatusBufferOffset = <span class="built_in">sizeof</span>(NDISPROT_INDICATE_STATUS);</span><br><span class="line">                        <span class="built_in">NPROT_COPY_MEM</span>((PUCHAR)pIndicateStatus +</span><br><span class="line">                                       pIndicateStatus-&gt;StatusBufferOffset,</span><br><span class="line">                                       StatusBuffer,</span><br><span class="line">                                       StatusBufferSize);</span><br><span class="line">                        ntStatus = STATUS_SUCCESS;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        ntStatus = STATUS_BUFFER_OVERFLOW;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Since we are completing the IRP below, clear this field.</span></span><br><span class="line">                OpenContext-&gt;StatusIndicationIrp = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="comment">// Number of bytes copied or number of bytes required.</span></span><br><span class="line">                bytes = <span class="built_in">sizeof</span>(NDISPROT_INDICATE_STATUS) + StatusBufferSize;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Cancel rotuine is running. Leave the irp alone.</span></span><br><span class="line">                pIrp = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;OpenContext-&gt;Lock);</span><br><span class="line">    <span class="keyword">if</span> (pIrp) &#123;</span><br><span class="line">        pIrp-&gt;IoStatus.Information = bytes;</span><br><span class="line">        pIrp-&gt;IoStatus.Status = ntStatus;</span><br><span class="line">        <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;&lt;--ndisServiceIndicateStatusIrp\n&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisCancelIndicateStatusIrp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT               pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP                         pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Cancel the pending status indication IRP registered by the app or</span></span></span><br><span class="line"><span class="comment"><span class="function">    another driver.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pDeviceObject - pointer to our device object</span></span></span><br><span class="line"><span class="comment"><span class="function">    pIrp - IRP to be cancelled</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    PIO_STACK_LOCATION          pIrpSp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;--&gt;ndisCancelIndicateStatusIrp\n&quot;</span>));</span><br><span class="line">    <span class="built_in">IoReleaseCancelSpinLock</span>(pIrp-&gt;CancelIrql);</span><br><span class="line">    pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)pIrpSp-&gt;FileObject-&gt;FsContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    pOpenContext-&gt;StatusIndicationIrp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">    pIrp-&gt;IoStatus.Status = STATUS_CANCELLED;</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;&lt;--ndisCancelIndicateStatusIrp\n&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ndisprot.h：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment">Copyright (c) 2000  Microsoft Corporation</span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment">    ndisprot.h</span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment">    Data structures, defines and function prototypes for NDISPROT.</span></span><br><span class="line"><span class="comment">Environment:</span></span><br><span class="line"><span class="comment">    Kernel mode only.</span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __NDISPROT__H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NDISPROT__H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NT_DEVICE_NAME          <span class="string">L&quot;\\Device\\NdisProt&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DOS_DEVICE_NAME         <span class="string">L&quot;\\DosDevices\\NdisProt&quot;</span></span></span><br><span class="line"><span class="comment">//  Abstract types</span></span><br><span class="line"><span class="keyword">typedef</span> NDIS_EVENT              NPROT_EVENT;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_MAC_ADDR_LEN            6</span></span><br><span class="line"><span class="comment">//  The Open Context represents an open of our device object.</span></span><br><span class="line"><span class="comment">//  We allocate this on processing a BindAdapter from NDIS,</span></span><br><span class="line"><span class="comment">//  and free it when all references (see below) to it are gone.</span></span><br><span class="line"><span class="comment">//  Binding/unbinding to an NDIS device:</span></span><br><span class="line"><span class="comment">//  On processing a BindAdapter call from NDIS, we set up a binding</span></span><br><span class="line"><span class="comment">//  to the specified NDIS device (miniport). This binding is</span></span><br><span class="line"><span class="comment">//  torn down when NDIS asks us to Unbind by calling</span></span><br><span class="line"><span class="comment">//  our UnbindAdapter handler.</span></span><br><span class="line"><span class="comment">//  Receiving data:</span></span><br><span class="line"><span class="comment">//  While an NDIS binding exists, read IRPs are queued on this</span></span><br><span class="line"><span class="comment">//  structure, to be processed when packets are received.</span></span><br><span class="line"><span class="comment">//  If data arrives in the absense of a pended read IRP, we</span></span><br><span class="line"><span class="comment">//  queue it, to the extent of one packet, i.e. we save the</span></span><br><span class="line"><span class="comment">//  contents of the latest packet received. We fail read IRPs</span></span><br><span class="line"><span class="comment">//  received when no NDIS binding exists (or is in the process</span></span><br><span class="line"><span class="comment">//  of being torn down).</span></span><br><span class="line"><span class="comment">//  Sending data:</span></span><br><span class="line"><span class="comment">//  Write IRPs are used to send data. Each write IRP maps to</span></span><br><span class="line"><span class="comment">//  a single NDIS packet. Packet send-completion is mapped to</span></span><br><span class="line"><span class="comment">//  write IRP completion. We use NDIS 5.1 CancelSend to support</span></span><br><span class="line"><span class="comment">//  write IRP cancellation. Write IRPs that arrive when we don&#x27;t</span></span><br><span class="line"><span class="comment">//  have an active NDIS binding are failed.</span></span><br><span class="line"><span class="comment">//  Reference count:</span></span><br><span class="line"><span class="comment">//  The following are long-lived references:</span></span><br><span class="line"><span class="comment">//  OPEN_DEVICE ioctl (goes away on processing a Close IRP)</span></span><br><span class="line"><span class="comment">//  Pended read IRPs</span></span><br><span class="line"><span class="comment">//  Queued received packets</span></span><br><span class="line"><span class="comment">//  Uncompleted write IRPs (outstanding sends)</span></span><br><span class="line"><span class="comment">//  Existence of NDIS binding</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_OPEN_CONTEXT</span> &#123;</span><br><span class="line">    LIST_ENTRY              Link;           <span class="comment">// Link into global list</span></span><br><span class="line">    ULONG                   Flags;          <span class="comment">// State information</span></span><br><span class="line">    ULONG                   RefCount;</span><br><span class="line">    NPROT_LOCK               Lock;</span><br><span class="line">    PFILE_OBJECT            pFileObject;    <span class="comment">// Set on OPEN_DEVICE</span></span><br><span class="line">    NDIS_HANDLE             BindingHandle;</span><br><span class="line">    NDIS_HANDLE             SendPacketPool;</span><br><span class="line">    NDIS_HANDLE             SendBufferPool;</span><br><span class="line">    NDIS_HANDLE             RecvPacketPool;</span><br><span class="line">    NDIS_HANDLE             RecvBufferPool;</span><br><span class="line">    ULONG                   MacOptions;</span><br><span class="line">    ULONG                   MaxFrameSize;</span><br><span class="line">    LIST_ENTRY              PendedWrites;   <span class="comment">// pended Write IRPs</span></span><br><span class="line">    ULONG                   PendedSendCount;</span><br><span class="line">    LIST_ENTRY              PendedReads;    <span class="comment">// pended Read IRPs</span></span><br><span class="line">    ULONG                   PendedReadCount;</span><br><span class="line">    LIST_ENTRY              RecvPktQueue;   <span class="comment">// queued rcv packets</span></span><br><span class="line">    ULONG                   RecvPktCount;</span><br><span class="line">    NET_DEVICE_POWER_STATE  PowerState;</span><br><span class="line">    NDIS_EVENT              PoweredUpEvent; <span class="comment">// signalled iff PowerState is D0</span></span><br><span class="line">    NDIS_STRING             DeviceName;     <span class="comment">// used in NdisOpenAdapter</span></span><br><span class="line">    NDIS_STRING                DeviceDescr;    <span class="comment">// friendly name</span></span><br><span class="line">    NDIS_STATUS             BindStatus;     <span class="comment">// for Open/CloseAdapter</span></span><br><span class="line">    NPROT_EVENT              BindEvent;      <span class="comment">// for Open/CloseAdapter</span></span><br><span class="line">    BOOLEAN                 bRunningOnWin9x;<span class="comment">// TRUE if Win98/SE/ME, FALSE if NT</span></span><br><span class="line">    ULONG                   oc_sig;         <span class="comment">// Signature for sanity</span></span><br><span class="line">    UCHAR                   CurrentAddress[NPROT_MAC_ADDR_LEN];</span><br><span class="line">    PIRP                  StatusIndicationIrp;</span><br><span class="line">&#125; NDISPROT_OPEN_CONTEXT, * PNDISPROT_OPEN_CONTEXT;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> oc_signature        <span class="string">&#x27;OiuN&#x27;</span></span></span><br><span class="line"><span class="comment">//  Definitions for Flags above.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_BIND_IDLE             0x00000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_BIND_OPENING          0x00000001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_BIND_FAILED           0x00000002</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_BIND_ACTIVE           0x00000004</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_BIND_CLOSING          0x00000008</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_BIND_FLAGS            0x0000000F  <span class="comment">// State of the binding</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_OPEN_IDLE             0x00000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_OPEN_ACTIVE           0x00000010</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_OPEN_FLAGS            0x000000F0  <span class="comment">// State of the I/O open</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_RESET_IN_PROGRESS     0x00000100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_NOT_RESETTING         0x00000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_RESET_FLAGS           0x00000100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_MEDIA_CONNECTED       0x00000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_MEDIA_DISCONNECTED    0x00000200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_MEDIA_FLAGS           0x00000200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_READ_SERVICING        0x00100000  <span class="comment">// Is the read service</span></span></span><br><span class="line">                                                <span class="comment">// routine running?</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_READ_FLAGS            0x00100000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_UNBIND_RECEIVED       0x10000000  <span class="comment">// Seen NDIS Unbind?</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_UNBIND_FLAGS          0x10000000</span></span><br><span class="line"><span class="comment">//  Globals:</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_GLOBALS</span> &#123;</span><br><span class="line">    PDRIVER_OBJECT          pDriverObject;</span><br><span class="line">    PDEVICE_OBJECT          ControlDeviceObject;</span><br><span class="line">    NDIS_HANDLE             NdisProtocolHandle;</span><br><span class="line">    UCHAR                   PartialCancelId;    <span class="comment">// for cancelling sends</span></span><br><span class="line">    ULONG                   LocalCancelId;</span><br><span class="line">    LIST_ENTRY              OpenList;           <span class="comment">// of OPEN_CONTEXT structures</span></span><br><span class="line">    NPROT_LOCK               GlobalLock;         <span class="comment">// to protect the above</span></span><br><span class="line">    NPROT_EVENT              BindsComplete;      <span class="comment">// have we seen NetEventBindsComplete?</span></span><br><span class="line">&#125; NDISPROT_GLOBALS, * PNDISPROT_GLOBALS;</span><br><span class="line"><span class="comment">//  NDIS Request context structure</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_REQUEST</span> &#123;</span><br><span class="line">    NDIS_REQUEST            Request;</span><br><span class="line">    NPROT_EVENT              ReqEvent;</span><br><span class="line">    ULONG                   Status;</span><br><span class="line">&#125; NDISPROT_REQUEST, * PNDISPROT_REQUEST;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUIOO_PACKET_FILTER  (NDIS_PACKET_TYPE_DIRECTED|    \</span></span><br><span class="line"><span class="meta">                              NDIS_PACKET_TYPE_MULTICAST|   \</span></span><br><span class="line"><span class="meta">                              NDIS_PACKET_TYPE_BROADCAST)</span></span><br><span class="line"><span class="comment">//  Send packet pool bounds</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_SEND_PACKET_POOL_SIZE    20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SEND_PACKET_POOL_SIZE    400</span></span><br><span class="line"><span class="comment">//  ProtocolReserved in sent packets. We save a pointer to the IRP</span></span><br><span class="line"><span class="comment">//  that generated the send.</span></span><br><span class="line"><span class="comment">//  The RefCount is used to determine when to free the packet back</span></span><br><span class="line"><span class="comment">//  to its pool. It is used to synchronize between a thread completing</span></span><br><span class="line"><span class="comment">//  a send and a thread attempting to cancel a send.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NPROT_SEND_PACKET_RSVD</span> &#123;</span><br><span class="line">    PIRP                    pIrp;</span><br><span class="line">    ULONG                   RefCount;</span><br><span class="line">&#125; NPROT_SEND_PACKET_RSVD, * PNPROT_SEND_PACKET_RSVD;</span><br><span class="line"><span class="comment">//  Receive packet pool bounds</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_RECV_PACKET_POOL_SIZE    4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_RECV_PACKET_POOL_SIZE    20</span></span><br><span class="line"><span class="comment">//  Max receive packets we allow to be queued up</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_RECV_QUEUE_SIZE          4</span></span><br><span class="line"><span class="comment">//  ProtocolReserved in received packets: we link these</span></span><br><span class="line"><span class="comment">//  packets up in a queue waiting for Read IRPs.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NPROT_RECV_PACKET_RSVD</span> &#123;</span><br><span class="line">    LIST_ENTRY              Link;</span><br><span class="line">    PNDIS_BUFFER            pOriginalBuffer;    <span class="comment">// used if we had to partial-map</span></span><br><span class="line">&#125; NPROT_RECV_PACKET_RSVD, * PNPROT_RECV_PACKET_RSVD;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pshpack1.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_ETH_HEADER</span> &#123;</span><br><span class="line">    UCHAR       DstAddr[NPROT_MAC_ADDR_LEN];</span><br><span class="line">    UCHAR       SrcAddr[NPROT_MAC_ADDR_LEN];</span><br><span class="line">    USHORT      EthType;</span><br><span class="line">&#125; NDISPROT_ETH_HEADER;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_ETH_HEADER</span> UNALIGNED* PNDISPROT_ETH_HEADER;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poppack.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> NDISPROT_GLOBALS      Globals;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NPROT_ALLOC_TAG      <span class="string">&#x27;oiuN&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NdisGetPoolFromPacket</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NdisGetPoolFromPacket(_Pkt) (_Pkt-&gt;Private.Pool)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NDIS_PACKET_FIRST_NDIS_BUFFER</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NDIS_PACKET_FIRST_NDIS_BUFFER(_Pkt)   ((_Pkt)-&gt;Private.Head)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//  Prototypes.</span></span><br><span class="line">DRIVER_INITIALIZE  DriverEntry;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">DriverEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDRIVER_OBJECT   pDriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PUNICODE_STRING  pRegistryPath</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_UNLOAD  NdisProtUnload;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDRIVER_OBJECT DriverObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_DISPATCH  NdisProtOpen;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT   pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP             pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_DISPATCH NdisProtClose;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtClose</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT   pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP             pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_DISPATCH NdisProtCleanup;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtCleanup</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT   pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP             pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_DISPATCH NdisProtIoControl;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtIoControl</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT   pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP             pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotOpenDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(DeviceNameLength) IN PUCHAR pDeviceName,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                                DeviceNameLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PFILE_OBJECT                         pFileObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PNDISPROT_OPEN_CONTEXT* ppOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotRefOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDerefOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDbgRefOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDbgDerefOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DBG</span></span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtBindAdapter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PNDIS_STATUS                pStatus,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  BindContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDIS_STRING                 DeviceName,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID                        SystemSpecific1,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID                        SystemSpecific2</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtOpenAdapterComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  Status,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  OpenErrorCode</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtUnbindAdapter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PNDIS_STATUS                pStatus,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  UnbindContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtCloseAdapterComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  Status</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtPnPEventHandler</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNET_PNP_EVENT               pNetPnPEvent</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtProtocolUnloadHandler</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotCreateBinding</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT                   pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(BindingInfoLength) IN PUCHAR    pBindingInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                                    BindingInfoLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotShutdownBinding</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFreeBindResources</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotWaitForPendingIO</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN                      DoCancelReads</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDoProtocolUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    VOID</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDoRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_REQUEST_TYPE            RequestType,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_OID                     Oid,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID                        InformationBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        InformationBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                      pBytesProcessed</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotValidateOpenAndDoRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_REQUEST_TYPE            RequestType,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_OID                     Oid,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PVOID                        InformationBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        InformationBufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                      pBytesProcessed,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN                      bWaitForPowerOn</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtResetComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  Status</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtRequestComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDIS_REQUEST                pNdisRequest,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  Status</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtStatus</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                          ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                          GeneralStatus,</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(StatusBufferSize) IN PVOID  StatusBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                                 StatusBufferSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtStatusComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotQueryBinding</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PUCHAR                       pBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        InputLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        OutputLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                      pBytesReturned</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">PNDISPROT_OPEN_CONTEXT</span></span><br><span class="line"><span class="function"><span class="title">ndisprotLookupDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(BindingInfoLength) IN PUCHAR    pBindingInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                                    BindingInfoLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotQueryOidValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNDISPROT_OPEN_CONTEXT       pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PVOID                       pDataBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG                       BufferLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                      pBytesWritten</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotSetOidValue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNDISPROT_OPEN_CONTEXT       pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PVOID                       pDataBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  ULONG                       BufferLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_DISPATCH NdisProtRead;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtRead</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT               pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP                         pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_CANCEL NdisProtCancelRead;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtCancelRead</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT               pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP                         pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotServiceReads</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NDIS_STATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtReceive</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                              ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                              MacReceiveContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(HeaderBufferSize) IN PVOID      pHeaderBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                                     HeaderBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(LookaheadBufferSize) IN PVOID   pLookaheadBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                                     LookaheadBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                                     PacketSize</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtTransferDataComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDIS_PACKET                 pNdisPacket,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  TransferStatus,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                         BytesTransferred</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtReceiveComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">INT</span></span><br><span class="line"><span class="function"><span class="title">NdisProtReceivePacket</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDIS_PACKET                 pNdisPacket</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotShutdownBinding</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotQueueReceivePacket</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDIS_PACKET                 pRcvPacket</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">PNDIS_PACKET</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAllocateReceivePacket</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                         DataLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PUCHAR* ppDataBuffer</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFreeReceivePacket</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDIS_PACKET                 pNdisPacket</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotCancelPendingReads</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFlushReceiveQueue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT            pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_DISPATCH NdisProtWrite;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtWrite</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT       pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP                 pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_CANCEL NdisProtCancelWrite;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtCancelWrite</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT               pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP                         pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtSendComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDIS_PACKET                 pNdisPacket,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                  Status</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ndisprotQueueStatusIndicationIrp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PNDISPROT_OPEN_CONTEXT       pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN  PIRP                         pIrp,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PULONG                       pBytesReturned</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line">DRIVER_CANCEL ndisCancelIndicateStatusIrp;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisCancelIndicateStatusIrp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT               pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP                         pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisServiceIndicateStatusIrp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT               OpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_STATUS                          GeneralStatus,</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(StatusBufferSize) IN PVOID  StatusBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                                 StatusBufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN                              Cancel</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> EX_CALLBACK</span></span><br><span class="line"><span class="function">BOOLEAN</span></span><br><span class="line"><span class="function"><span class="title">ndisprotRegisterExCallBack</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotUnregisterExCallBack</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID   CallBackContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID   Source,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID   NotifyPresenceCallback</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ndisprotRegisterExCallBack() TRUE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ndisprotUnregisterExCallBack() </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// __NDISPROT__H</span></span></span><br></pre></td></tr></table></figure>

<p>ndisp.c：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 2000  Microsoft Corporation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ntdisp.c</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NT Entry points and dispatch routines for NDISPROT.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Environment:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Kernel mode only.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;precomp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILENUMBER <span class="string">&#x27;PSID&#x27;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ALLOC_PRAGMA</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> alloc_text(INIT, DriverEntry)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> alloc_text(PAGE, NdisProtUnload)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> alloc_text(PAGE, NdisProtOpen)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> alloc_text(PAGE, NdisProtClose)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// ALLOC_PRAGMA</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Globals:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">NDISPROT_GLOBALS         Globals = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(IN PDRIVER_OBJECT   pDriverObject, IN PUNICODE_STRING  pRegistryPath)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Called on loading. We create a device object to handle user-mode requests on, and register ourselves as a protocol with NDIS.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pDriverObject - Pointer to driver object created by system.</span></span></span><br><span class="line"><span class="comment"><span class="function">    pRegistryPath - Pointer to the Unicode name of the registry path for this driver.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NT Status code</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NDIS_PROTOCOL_CHARACTERISTICS   protocolChar;</span><br><span class="line">    NTSTATUS                        status = STATUS_SUCCESS;</span><br><span class="line">    NDIS_STRING                     protoName = <span class="built_in">NDIS_STRING_CONST</span>(<span class="string">&quot;NdisProt&quot;</span>);</span><br><span class="line">    UNICODE_STRING                  ntDeviceName;</span><br><span class="line">    UNICODE_STRING                  win32DeviceName;</span><br><span class="line">    BOOLEAN                         fSymbolicLink = FALSE;</span><br><span class="line">    PDEVICE_OBJECT                  deviceObject = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pRegistryPath);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;DriverEntry\n&quot;</span>));</span><br><span class="line">    Globals.pDriverObject = pDriverObject;</span><br><span class="line">    <span class="built_in">NPROT_INIT_EVENT</span>(&amp;Globals.BindsComplete);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// Create our device object using which an application can access NDIS devices.</span></span><br><span class="line">        <span class="built_in">RtlInitUnicodeString</span>(&amp;ntDeviceName, NT_DEVICE_NAME);</span><br><span class="line">        <span class="meta">#<span class="keyword">ifndef</span> WIN9X</span></span><br><span class="line">        status = <span class="built_in">IoCreateDeviceSecure</span>(pDriverObject, <span class="number">0</span>, &amp;ntDeviceName, FILE_DEVICE_NETWORK, FILE_DEVICE_SECURE_OPEN, FALSE, &amp;SDDL_DEVOBJ_SYS_ALL_ADM_ALL, <span class="literal">NULL</span>, &amp;deviceObject);</span><br><span class="line">        <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        status = <span class="built_in">IoCreateDevice</span>(pDriverObject, <span class="number">0</span>, &amp;ntDeviceName, FILE_DEVICE_NETWORK, FILE_DEVICE_SECURE_OPEN, FALSE, &amp;deviceObject);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">            <span class="comment">// Either not enough memory to create a deviceobject or another deviceobject with the same name exits. This could happen if you install another instance of this device.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">RtlInitUnicodeString</span>(&amp;win32DeviceName, DOS_DEVICE_NAME);</span><br><span class="line">        status = <span class="built_in">IoCreateSymbolicLink</span>(&amp;win32DeviceName, &amp;ntDeviceName);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        fSymbolicLink = TRUE;</span><br><span class="line">        deviceObject-&gt;Flags |= DO_DIRECT_IO;</span><br><span class="line">        Globals.ControlDeviceObject = deviceObject;</span><br><span class="line">        <span class="built_in">NPROT_INIT_LIST_HEAD</span>(&amp;Globals.OpenList);</span><br><span class="line">        <span class="built_in">NPROT_INIT_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line">        <span class="comment">// Initialize the protocol characterstic structure</span></span><br><span class="line">        <span class="built_in">NdisZeroMemory</span>(&amp;protocolChar, <span class="built_in">sizeof</span>(NDIS_PROTOCOL_CHARACTERISTICS));</span><br><span class="line">        protocolChar.MajorNdisVersion = <span class="number">5</span>;</span><br><span class="line">        protocolChar.MinorNdisVersion = <span class="number">0</span>;</span><br><span class="line">        protocolChar.Name = protoName;</span><br><span class="line">        protocolChar.OpenAdapterCompleteHandler = NdisProtOpenAdapterComplete;</span><br><span class="line">        protocolChar.CloseAdapterCompleteHandler = NdisProtCloseAdapterComplete;</span><br><span class="line">        protocolChar.SendCompleteHandler = NdisProtSendComplete;</span><br><span class="line">        protocolChar.TransferDataCompleteHandler = NdisProtTransferDataComplete;</span><br><span class="line">        protocolChar.ResetCompleteHandler = NdisProtResetComplete;</span><br><span class="line">        protocolChar.RequestCompleteHandler = NdisProtRequestComplete;</span><br><span class="line">        protocolChar.ReceiveHandler = NdisProtReceive;</span><br><span class="line">        protocolChar.ReceiveCompleteHandler = NdisProtReceiveComplete;</span><br><span class="line">        protocolChar.StatusHandler = NdisProtStatus;</span><br><span class="line">        protocolChar.StatusCompleteHandler = NdisProtStatusComplete;</span><br><span class="line">        protocolChar.BindAdapterHandler = NdisProtBindAdapter;</span><br><span class="line">        protocolChar.UnbindAdapterHandler = NdisProtUnbindAdapter;</span><br><span class="line">        protocolChar.UnloadHandler = <span class="literal">NULL</span>;</span><br><span class="line">        protocolChar.ReceivePacketHandler = NdisProtReceivePacket;</span><br><span class="line">        protocolChar.PnPEventHandler = NdisProtPnPEventHandler;</span><br><span class="line">        <span class="comment">// Register as a protocol driver</span></span><br><span class="line">        <span class="built_in">NdisRegisterProtocol</span>((PNDIS_STATUS)&amp;status, &amp;Globals.NdisProtocolHandle, &amp;protocolChar, <span class="built_in">sizeof</span>(NDIS_PROTOCOL_CHARACTERISTICS));</span><br><span class="line">        <span class="keyword">if</span> (status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;Failed to register protocol with NDIS\n&quot;</span>));</span><br><span class="line">            status = STATUS_UNSUCCESSFUL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line">        Globals.PartialCancelId = <span class="built_in">NdisGeneratePartialCancelId</span>();</span><br><span class="line">        Globals.PartialCancelId &lt;&lt;= ((<span class="built_in">sizeof</span>(PVOID) - <span class="number">1</span>) * <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;DriverEntry: CancelId %lx\n&quot;</span>, Globals.PartialCancelId));</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">// Now set only the dispatch points we would like to handle.</span></span><br><span class="line">        pDriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = NdisProtOpen;</span><br><span class="line">        pDriverObject-&gt;MajorFunction[IRP_MJ_CLOSE] = NdisProtClose;</span><br><span class="line">        pDriverObject-&gt;MajorFunction[IRP_MJ_READ] = NdisProtRead;</span><br><span class="line">        pDriverObject-&gt;MajorFunction[IRP_MJ_WRITE] = NdisProtWrite;</span><br><span class="line">        pDriverObject-&gt;MajorFunction[IRP_MJ_CLEANUP] = NdisProtCleanup;</span><br><span class="line">        pDriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = NdisProtIoControl;</span><br><span class="line">        pDriverObject-&gt;DriverUnload = NdisProtUnload;</span><br><span class="line">        status = STATUS_SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(status)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deviceObject) &#123;</span><br><span class="line">            <span class="built_in">IoDeleteDevice</span>(deviceObject);</span><br><span class="line">            Globals.ControlDeviceObject = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (fSymbolicLink)</span><br><span class="line">            <span class="built_in">IoDeleteSymbolicLink</span>(&amp;win32DeviceName);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtUnload</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDRIVER_OBJECT DriverObject</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Free all the allocated resources, etc.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    DriverObject - pointer to a driver object.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    VOID.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    UNICODE_STRING     win32DeviceName;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(DriverObject);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;Unload Enter\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ndisprotUnregisterExCallBack</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// First delete the Control deviceobject and the corresponding</span></span><br><span class="line">    <span class="comment">// symbolicLink</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>(&amp;win32DeviceName, DOS_DEVICE_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">IoDeleteSymbolicLink</span>(&amp;win32DeviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Globals.ControlDeviceObject) &#123;</span><br><span class="line">        <span class="built_in">IoDeleteDevice</span>(Globals.ControlDeviceObject);</span><br><span class="line">        Globals.ControlDeviceObject = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ndisprotDoProtocolUnload</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line">    <span class="built_in">ndisprotAuditShutdown</span>();</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_FREE_LOCK</span>(&amp;Globals.GlobalLock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_FREE_DBG_LOCK</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;Unload Exit\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT   pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP             pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    This is the dispatch routine for handling IRP_MJ_CREATE.</span></span></span><br><span class="line"><span class="comment"><span class="function">    We simply succeed this.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pDeviceObject - Pointer to the device object.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pIrp - Pointer to the request packet.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Status is returned.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIO_STACK_LOCATION      pIrpSp;</span><br><span class="line">    NTSTATUS                NtStatus = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line"></span><br><span class="line">    pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    pIrpSp-&gt;FileObject-&gt;FsContext = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;Open: FileObject %p\n&quot;</span>, pIrpSp-&gt;FileObject));</span><br><span class="line"></span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">    pIrp-&gt;IoStatus.Status = NtStatus;</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NtStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtClose</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT   pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP             pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    This is the dispatch routine for handling IRP_MJ_CLOSE.</span></span></span><br><span class="line"><span class="comment"><span class="function">    We simply succeed this.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pDeviceObject - Pointer to the device object.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pIrp - Pointer to the request packet.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Status is returned.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    NTSTATUS                NtStatus;</span><br><span class="line">    PIO_STACK_LOCATION      pIrpSp;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line"></span><br><span class="line">    pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    pOpenContext = pIrpSp-&gt;FileObject-&gt;FsContext;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;Close: FileObject %p\n&quot;</span>,</span><br><span class="line">                     <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp)-&gt;FileObject));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pOpenContext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Deref the endpoint</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);  <span class="comment">// Close</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pIrpSp-&gt;FileObject-&gt;FsContext = <span class="literal">NULL</span>;</span><br><span class="line">    NtStatus = STATUS_SUCCESS;</span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">    pIrp-&gt;IoStatus.Status = NtStatus;</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NtStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">NdisProtCleanup</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT   pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP             pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    This is the dispatch routine for handling IRP_MJ_CLEANUP.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pDeviceObject - Pointer to the device object.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pIrp - Pointer to the request packet.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Status is returned.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIO_STACK_LOCATION      pIrpSp;</span><br><span class="line">    NTSTATUS                NtStatus;</span><br><span class="line">    NDIS_STATUS             NdisStatus;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line">    ULONG                   PacketFilter;</span><br><span class="line">    ULONG                   BytesProcessed;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line"></span><br><span class="line">    pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    pOpenContext = pIrpSp-&gt;FileObject-&gt;FsContext;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_VERY_LOUD, (<span class="string">&quot;Cleanup: FileObject %p, Open %p\n&quot;</span>,</span><br><span class="line">                          pIrpSp-&gt;FileObject, pOpenContext));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pOpenContext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Mark this endpoint.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_OPEN_FLAGS, NUIOO_OPEN_IDLE);</span><br><span class="line">        pOpenContext-&gt;pFileObject = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Set the packet filter to 0, telling NDIS that we aren&#x27;t</span></span><br><span class="line">        <span class="comment">//  interested in any more receives.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        PacketFilter = <span class="number">0</span>;</span><br><span class="line">        NdisStatus = <span class="built_in">ndisprotValidateOpenAndDoRequest</span>(</span><br><span class="line">            pOpenContext,</span><br><span class="line">            NdisRequestSetInformation,</span><br><span class="line">            OID_GEN_CURRENT_PACKET_FILTER,</span><br><span class="line">            &amp;PacketFilter,</span><br><span class="line">            <span class="built_in">sizeof</span>(PacketFilter),</span><br><span class="line">            &amp;BytesProcessed,</span><br><span class="line">            FALSE   <span class="comment">// Don&#x27;t wait for device to be powered on</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (NdisStatus != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;Cleanup: Open %p, set packet filter (%x) failed: %x\n&quot;</span>,</span><br><span class="line">                             pOpenContext, PacketFilter, NdisStatus));</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Ignore the result. If this failed, we may continue</span></span><br><span class="line">            <span class="comment">//  to get indicated receives, which will be handled</span></span><br><span class="line">            <span class="comment">//  appropriately.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            NdisStatus = NDIS_STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Cancel any pending reads.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">ndisprotCancelPendingReads</span>(pOpenContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Cancel pending control irp for status indication.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">ndisServiceIndicateStatusIrp</span>(pOpenContext,</span><br><span class="line">                                     <span class="number">0</span>,</span><br><span class="line">                                     <span class="literal">NULL</span>,</span><br><span class="line">                                     <span class="number">0</span>,</span><br><span class="line">                                     TRUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Clean up the receive packet queue</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">ndisprotFlushReceiveQueue</span>(pOpenContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NtStatus = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">    pIrp-&gt;IoStatus.Status = NtStatus;</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;Cleanup: OpenContext %p\n&quot;</span>, pOpenContext));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (NtStatus);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">NdisProtIoControl</span><span class="params">(IN PDEVICE_OBJECT pDeviceObject,IN PIRP pIrp)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    This is the dispatch routine for handling device ioctl requests.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pDeviceObject - Pointer to the device object.</span></span></span><br><span class="line"><span class="comment"><span class="function">    pIrp - Pointer to the request packet.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Status is returned.</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIO_STACK_LOCATION      pIrpSp;</span><br><span class="line">    ULONG                   FunctionCode;</span><br><span class="line">    NTSTATUS                NtStatus;</span><br><span class="line">    NDIS_STATUS             Status;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line">    ULONG                   BytesReturned;</span><br><span class="line">    USHORT                  EthType;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> !DBG</span></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;IoControl: DevObj %p, Irp %p\n&quot;</span>, pDeviceObject, pIrp));</span><br><span class="line">    pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    FunctionCode = pIrpSp-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)pIrpSp-&gt;FileObject-&gt;FsContext;</span><br><span class="line">    BytesReturned = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (FunctionCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_NDISPROT_BIND_WAIT:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 所有的DeviceIoControl请求的都应该是用的缓冲方式。这里只是确认一下。</span></span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>((FunctionCode &amp; <span class="number">0x3</span>) == METHOD_BUFFERED);</span><br><span class="line">            <span class="comment">// 非常简单。等待一个全局事件。这个全局变量会在绑定完成的时候被设置。如果等待到了或者超时了（5秒）则返回。</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">NPROT_WAIT_EVENT</span>(&amp;Globals.BindsComplete, <span class="number">5000</span>))</span><br><span class="line">                NtStatus = STATUS_SUCCESS;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                NtStatus = STATUS_TIMEOUT;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;IoControl: BindWait returning %x\n&quot;</span>, NtStatus));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_NDISPROT_QUERY_BINDING:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>((FunctionCode &amp; <span class="number">0x3</span>) == METHOD_BUFFERED);</span><br><span class="line">            Status = <span class="built_in">ndisprotQueryBinding</span>(pIrp-&gt;AssociatedIrp.SystemBuffer, pIrpSp-&gt;Parameters.DeviceIoControl.InputBufferLength, pIrpSp-&gt;Parameters.DeviceIoControl.OutputBufferLength, &amp;BytesReturned);</span><br><span class="line">            <span class="built_in">NDIS_STATUS_TO_NT_STATUS</span>(Status, &amp;NtStatus);</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;IoControl: QueryBinding returning %x\n&quot;</span>, NtStatus));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_NDISPROT_OPEN_DEVICE:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>((FunctionCode &amp; <span class="number">0x3</span>) == METHOD_BUFFERED);</span><br><span class="line">            <span class="keyword">if</span> (pOpenContext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;IoControl: OPEN_DEVICE: FileObj %p alreadyassociated with open %p\n&quot;</span>, pIrpSp-&gt;FileObject, pOpenContext));</span><br><span class="line">                NtStatus = STATUS_DEVICE_BUSY;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            NtStatus = <span class="built_in">ndisprotOpenDevice</span>(pIrp-&gt;AssociatedIrp.SystemBuffer, pIrpSp-&gt;Parameters.DeviceIoControl.InputBufferLength, pIrpSp-&gt;FileObject, &amp;pOpenContext);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(NtStatus))</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_VERY_LOUD, (<span class="string">&quot;IoControl OPEN_DEVICE: Open %p &lt;-&gt; FileObject %p\n&quot;</span>, pOpenContext, pIrpSp-&gt;FileObject));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_NDISPROT_QUERY_OID_VALUE:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>((FunctionCode &amp; <span class="number">0x3</span>) == METHOD_BUFFERED);</span><br><span class="line">            <span class="keyword">if</span> (pOpenContext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                Status = <span class="built_in">ndisprotQueryOidValue</span>(pOpenContext, pIrp-&gt;AssociatedIrp.SystemBuffer, pIrpSp-&gt;Parameters.DeviceIoControl.OutputBufferLength, &amp;BytesReturned);</span><br><span class="line">                <span class="built_in">NDIS_STATUS_TO_NT_STATUS</span>(Status, &amp;NtStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                NtStatus = STATUS_DEVICE_NOT_CONNECTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_NDISPROT_SET_OID_VALUE:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>((FunctionCode &amp; <span class="number">0x3</span>) == METHOD_BUFFERED);</span><br><span class="line">            <span class="keyword">if</span> (pOpenContext != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                Status = <span class="built_in">ndisprotSetOidValue</span>(pOpenContext, pIrp-&gt;AssociatedIrp.SystemBuffer, pIrpSp-&gt;Parameters.DeviceIoControl.InputBufferLength);</span><br><span class="line">                BytesReturned = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">NDIS_STATUS_TO_NT_STATUS</span>(Status, &amp;NtStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                NtStatus = STATUS_DEVICE_NOT_CONNECTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_NDISPROT_INDICATE_STATUS:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>((FunctionCode &amp; <span class="number">0x3</span>) == METHOD_BUFFERED);</span><br><span class="line">            <span class="keyword">if</span> (pOpenContext != <span class="literal">NULL</span>)</span><br><span class="line">                NtStatus = <span class="built_in">ndisprotQueueStatusIndicationIrp</span>(pOpenContext, pIrp, &amp;BytesReturned);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                NtStatus = STATUS_DEVICE_NOT_CONNECTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            NtStatus = STATUS_NOT_SUPPORTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (NtStatus != STATUS_PENDING) &#123;</span><br><span class="line">        pIrp-&gt;IoStatus.Information = BytesReturned;</span><br><span class="line">        pIrp-&gt;IoStatus.Status = NtStatus;</span><br><span class="line">        <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> NtStatus;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">ndisprotOpenDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    __in_bcount(DeviceNameLength) IN PUCHAR pDeviceName,<span class="comment">// pDeviceName 设备对象名</span></span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG DeviceNameLength,<span class="comment">// DeviceNameLength 设备对象的长度</span></span></span></span><br><span class="line"><span class="params"><span class="function">    IN PFILE_OBJECT pFileObject,<span class="comment">// pFileObject 文件对象指针</span></span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PNDISPROT_OPEN_CONTEXT* ppOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line">    NTSTATUS                NtStatus;</span><br><span class="line">    ULONG                   PacketFilter;</span><br><span class="line">    NDIS_STATUS             NdisStatus;</span><br><span class="line">    ULONG                   BytesProcessed;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pCurrentOpenContext = <span class="literal">NULL</span>;</span><br><span class="line">    pOpenContext = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 根据设备名找到打开上下文。请注意这个中间会调用增加打开上下文引用计数，所以后面要解引用。</span></span><br><span class="line">        pOpenContext = <span class="built_in">ndisprotLookupDevice</span>(pDeviceName, DeviceNameLength);</span><br><span class="line">        <span class="comment">// 如果找不到打开上下文，说明没绑定过...</span></span><br><span class="line">        <span class="keyword">if</span> (pOpenContext == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;ndisprotOpenDevice: couldn&#x27;t find device\n&quot;</span>));</span><br><span class="line">            NtStatus = STATUS_OBJECT_NAME_NOT_FOUND;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 如果找到了，但是不是打开空闲状态，则返回设备忙。</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_OPEN_FLAGS, NUIOO_OPEN_IDLE)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>(pOpenContext-&gt;pFileObject != <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;ndisprotOpenDevice: Open %p/%x already associated with another FileObject %p\n&quot;</span>, pOpenContext, pOpenContext-&gt;Flags, pOpenContext-&gt;pFileObject));</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="comment">// 注意解引用。</span></span><br><span class="line">            <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext); <span class="comment">// ndisprotOpenDevice failure</span></span><br><span class="line">            NtStatus = STATUS_DEVICE_BUSY;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 比较交换。首先比较pFileObject-&gt;FsContext和NULL.如果是NULL,则用pFileObject-&gt;FsContext设置为pOpenContext，然后返回NULL。如果不是NULL，则不交换，并返回pFileObject-&gt;FsContext</span></span><br><span class="line">        <span class="keyword">if</span> ((pCurrentOpenContext = <span class="built_in">InterlockedCompareExchangePointer</span>(&amp;(pFileObject-&gt;FsContext), pOpenContext, <span class="literal">NULL</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// 到了这里，说明另一个打开已经使用了这个文件对象。这个设备不支持两次打开。到这里直接返回失败即可。</span></span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;ndisprotOpenDevice: FileObject %p already associated with another Open %p/%x\n&quot;</span>, pFileObject, pCurrentOpenContext, pCurrentOpenContext-&gt;Flags));  <span class="comment">//BUG</span></span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext); <span class="comment">// ndisprotOpenDevice failure</span></span><br><span class="line">            NtStatus = STATUS_INVALID_DEVICE_REQUEST;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 这个打开上下文被打开了，保存在这个文件对象的FsContext中。这里也保存</span></span><br><span class="line">        pOpenContext-&gt;pFileObject = pFileObject;</span><br><span class="line">        <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_OPEN_FLAGS, NUIOO_OPEN_ACTIVE);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 设置PacketFilter，使之能收到包。</span></span><br><span class="line">        PacketFilter = NUIOO_PACKET_FILTER;</span><br><span class="line">        NdisStatus = <span class="built_in">ndisprotValidateOpenAndDoRequest</span>(pOpenContext, NdisRequestSetInformation, OID_GEN_CURRENT_PACKET_FILTER, &amp;PacketFilter, <span class="built_in">sizeof</span>(PacketFilter), &amp;BytesProcessed, TRUE); <span class="comment">// TRUE:Do wait for power on</span></span><br><span class="line">        <span class="comment">// 不成功的话</span></span><br><span class="line">        <span class="keyword">if</span> (NdisStatus != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;openDevice: Open %p: set packet filter (%x) failed: %x\n&quot;</span>, pOpenContext, PacketFilter, NdisStatus));</span><br><span class="line">            <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="comment">// 不成功的话，去掉FileObject-&gt;FsContext设置，如果pFileObject-&gt;FsContext是pOpenContext，则去掉。</span></span><br><span class="line">            pCurrentOpenContext = <span class="built_in">InterlockedCompareExchangePointer</span>(&amp;(pFileObject-&gt;FsContext), <span class="literal">NULL</span>, pOpenContext);</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>(pCurrentOpenContext == pOpenContext);</span><br><span class="line">            <span class="built_in">NPROT_SET_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_OPEN_FLAGS, NUIOO_OPEN_IDLE);</span><br><span class="line">            pOpenContext-&gt;pFileObject = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext); <span class="comment">// ndisprotOpenDevice failure</span></span><br><span class="line">            <span class="built_in">NDIS_STATUS_TO_NT_STATUS</span>(NdisStatus, &amp;NtStatus);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 返回打开上下文。</span></span><br><span class="line">        *ppOpenContext = pOpenContext;</span><br><span class="line">        NtStatus = STATUS_SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="keyword">return</span> (NtStatus);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotRefOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Reference the given open context.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    <span class="doctag">NOTE:</span> Can be called with or without holding the opencontext lock.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">NdisInterlockedIncrement</span>((PLONG)&amp;pOpenContext-&gt;RefCount);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDerefOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Dereference the given open context. If the ref count goes to zero,</span></span></span><br><span class="line"><span class="comment"><span class="function">    free it.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    <span class="doctag">NOTE:</span> called without holding the opencontext lock</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NdisInterlockedDecrement</span>((PLONG)&amp;pOpenContext-&gt;RefCount) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;DerefOpen: Open %p, Flags %x, ref count is zero!\n&quot;</span>,</span><br><span class="line">                         pOpenContext, pOpenContext-&gt;Flags));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pOpenContext-&gt;BindingHandle == <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pOpenContext-&gt;RefCount == <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pOpenContext-&gt;pFileObject == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        pOpenContext-&gt;oc_sig++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Free it.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">NPROT_FREE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_FREE_MEM</span>(pOpenContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDbgRefOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_VERY_LOUD, (<span class="string">&quot;  RefOpen: Open %p, old ref %d, File %c%c%c%c, line %d\n&quot;</span>,</span><br><span class="line">                          pOpenContext,</span><br><span class="line">                          pOpenContext-&gt;RefCount,</span><br><span class="line">                          (CHAR)(FileNumber),</span><br><span class="line">                          (CHAR)(FileNumber &gt;&gt; <span class="number">8</span>),</span><br><span class="line">                          (CHAR)(FileNumber &gt;&gt; <span class="number">16</span>),</span><br><span class="line">                          (CHAR)(FileNumber &gt;&gt; <span class="number">24</span>),</span><br><span class="line">                          LineNumber));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ndisprotRefOpen</span>(pOpenContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotDbgDerefOpen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        FileNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG                        LineNumber</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_VERY_LOUD, (<span class="string">&quot;DerefOpen: Open %p, old ref %d, File %c%c%c%c, line %d\n&quot;</span>,</span><br><span class="line">                          pOpenContext,</span><br><span class="line">                          pOpenContext-&gt;RefCount,</span><br><span class="line">                          (CHAR)(FileNumber),</span><br><span class="line">                          (CHAR)(FileNumber &gt;&gt; <span class="number">8</span>),</span><br><span class="line">                          (CHAR)(FileNumber &gt;&gt; <span class="number">16</span>),</span><br><span class="line">                          (CHAR)(FileNumber &gt;&gt; <span class="number">24</span>),</span><br><span class="line">                          LineNumber));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ndisprotDerefOpen</span>(pOpenContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// DBG</span></span></span><br></pre></td></tr></table></figure>

<p>nuiouser.h：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 2000  Microsoft Corporation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    nuiouser.h</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Constants and types to access the NDISPROT driver.</span></span><br><span class="line"><span class="comment">    Users must also include ntddndis.h</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Environment:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    User/Kernel mode.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __NUIOUSER__H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NUIOUSER__H</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FSCTL_NDISPROT_BASE      FILE_DEVICE_NETWORK</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NDISPROT_CTL_CODE(_Function, _Method, _Access)  \</span></span><br><span class="line"><span class="meta">            CTL_CODE(FSCTL_NDISPROT_BASE, _Function, _Method, _Access)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_NDISPROT_OPEN_DEVICE   \</span></span><br><span class="line"><span class="meta">            _NDISPROT_CTL_CODE(0x200, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_NDISPROT_QUERY_OID_VALUE   \</span></span><br><span class="line"><span class="meta">            _NDISPROT_CTL_CODE(0x201, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_NDISPROT_SET_OID_VALUE   \</span></span><br><span class="line"><span class="meta">            _NDISPROT_CTL_CODE(0x205, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_NDISPROT_QUERY_BINDING   \</span></span><br><span class="line"><span class="meta">            _NDISPROT_CTL_CODE(0x203, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_NDISPROT_BIND_WAIT   \</span></span><br><span class="line"><span class="meta">            _NDISPROT_CTL_CODE(0x204, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_NDISPROT_INDICATE_STATUS   \</span></span><br><span class="line"><span class="meta">            _NDISPROT_CTL_CODE(0x206, METHOD_BUFFERED, FILE_READ_ACCESS | FILE_WRITE_ACCESS)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Structure to go with IOCTL_NDISPROT_QUERY_OID_VALUE.</span></span><br><span class="line"><span class="comment">//  The Data part is of variable length, determined by</span></span><br><span class="line"><span class="comment">//  the input buffer length passed to DeviceIoControl.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_QUERY_OID</span> &#123;</span><br><span class="line">    NDIS_OID        Oid;</span><br><span class="line">    UCHAR           Data[<span class="built_in">sizeof</span>(ULONG)];</span><br><span class="line"></span><br><span class="line">&#125; NDISPROT_QUERY_OID, * PNDISPROT_QUERY_OID;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Structure to go with IOCTL_NDISPROT_SET_OID_VALUE.</span></span><br><span class="line"><span class="comment">//  The Data part is of variable length, determined</span></span><br><span class="line"><span class="comment">//  by the input buffer length passed to DeviceIoControl.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_SET_OID</span> &#123;</span><br><span class="line">    NDIS_OID        Oid;</span><br><span class="line">    UCHAR           Data[<span class="built_in">sizeof</span>(ULONG)];</span><br><span class="line"></span><br><span class="line">&#125; NDISPROT_SET_OID, * PNDISPROT_SET_OID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Structure to go with IOCTL_NDISPROT_QUERY_BINDING.</span></span><br><span class="line"><span class="comment">//  The input parameter is BindingIndex, which is the</span></span><br><span class="line"><span class="comment">//  index into the list of bindings active at the driver.</span></span><br><span class="line"><span class="comment">//  On successful completion, we get back a device name</span></span><br><span class="line"><span class="comment">//  and a device descriptor (friendly name).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_QUERY_BINDING</span> &#123;</span><br><span class="line">    ULONG            BindingIndex;        <span class="comment">// 0-based binding number</span></span><br><span class="line">    ULONG            DeviceNameOffset;    <span class="comment">// from start of this struct</span></span><br><span class="line">    ULONG            DeviceNameLength;    <span class="comment">// in bytes</span></span><br><span class="line">    ULONG            DeviceDescrOffset;    <span class="comment">// from start of this struct</span></span><br><span class="line">    ULONG            DeviceDescrLength;    <span class="comment">// in bytes</span></span><br><span class="line"></span><br><span class="line">&#125; NDISPROT_QUERY_BINDING, * PNDISPROT_QUERY_BINDING;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Structure to go with IOCTL_NDISPROT_INDICATE_STATUS.</span></span><br><span class="line"><span class="comment">//  NDISPROT copies the status indicated by the NIC and</span></span><br><span class="line"><span class="comment">//  also the data indicated in the StatusBuffer.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NDISPROT_INDICATE_STATUS</span> &#123;</span><br><span class="line">    ULONG            IndicatedStatus;        <span class="comment">// NDIS_STATUS</span></span><br><span class="line">    ULONG            StatusBufferOffset;    <span class="comment">// from start of this struct</span></span><br><span class="line">    ULONG            StatusBufferLength;    <span class="comment">// in bytes</span></span><br><span class="line">&#125; NDISPROT_INDICATE_STATUS, * PNDISPROT_INDICATE_STATUS;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// __NUIOUSER__H</span></span></span><br></pre></td></tr></table></figure>

<p>precomp.h：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4214)   <span class="comment">// bit field types other than int</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4201)   <span class="comment">// nameless struct/union</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4115)   <span class="comment">// named type definition in parentheses</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4127)   <span class="comment">// conditional expression is constant</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4054)   <span class="comment">// cast of function pointer to PVOID</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4244)   <span class="comment">// conversion from &#x27;int&#x27; to &#x27;BOOLEAN&#x27;, possible loss of data</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4206)   <span class="comment">// nonstandard extension used : translation unit is empty</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ndis.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ntddk.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;debug.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ndisprot.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;macros.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;nuiouser.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wdmsec.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>recv.c：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 2000  Microsoft Corporation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    recv.c</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NDIS protocol entry points and utility routines to handle receiving</span></span><br><span class="line"><span class="comment">    data.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Environment:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Kernel mode only.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;precomp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILENUMBER <span class="string">&#x27;VCER&#x27;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 分发函数之一，处理读请求。</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">NdisProtRead</span><span class="params">(IN PDEVICE_OBJECT pDeviceObject, IN PIRP pIrp)</span> </span>&#123;</span><br><span class="line">    PIO_STACK_LOCATION      pIrpSp;</span><br><span class="line">    NTSTATUS                NtStatus;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line">    pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    pOpenContext = pIrpSp-&gt;FileObject-&gt;FsContext;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 检测打开上下文的可靠性</span></span><br><span class="line">        <span class="keyword">if</span> (pOpenContext == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;Read: NULL FsContext on FileObject %p\n&quot;</span>, pIrpSp-&gt;FileObject));</span><br><span class="line">            NtStatus = STATUS_INVALID_HANDLE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">        <span class="comment">// Read和Write都是使用的直接IO操作，所以应该使用MdlAddress来传递缓冲。如果不是，返回非法参数错误。</span></span><br><span class="line">        <span class="keyword">if</span> (pIrp-&gt;MdlAddress == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;Read: NULL MDL address on IRP %p\n&quot;</span>, pIrp));</span><br><span class="line">            NtStatus = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 得到缓冲的虚拟地址。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">MmGetSystemAddressForMdlSafe</span>(pIrp-&gt;MdlAddress, NormalPagePriority) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;Read: MmGetSystemAddr failed for IRP %p, MDL %p\n&quot;</span>, pIrp, pIrp-&gt;MdlAddress));</span><br><span class="line">            NtStatus = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            NtStatus = STATUS_INVALID_HANDLE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 将这个请求插入处理队列里。并把打开上下文引用计数增加就1.把未处理读请求数目增加1.</span></span><br><span class="line">        <span class="built_in">NPROT_INSERT_TAIL_LIST</span>(&amp;pOpenContext-&gt;PendedReads, &amp;pIrp-&gt;Tail.Overlay.ListEntry);</span><br><span class="line">        <span class="built_in">NPROT_REF_OPEN</span>(pOpenContext);  <span class="comment">// pended read IRP</span></span><br><span class="line">        pOpenContext-&gt;PendedReadCount++;</span><br><span class="line">        <span class="comment">// 标记IRP未决。给IRP设置一个取消函数，使之变得可取消。</span></span><br><span class="line">        pIrp-&gt;Tail.Overlay.DriverContext[<span class="number">0</span>] = (PVOID)pOpenContext;</span><br><span class="line">        <span class="built_in">IoMarkIrpPending</span>(pIrp);</span><br><span class="line">        <span class="built_in">IoSetCancelRoutine</span>(pIrp, NdisProtCancelRead);</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        NtStatus = STATUS_PENDING;</span><br><span class="line">        <span class="comment">// 调用一个处理例程来处理所有未决的读请求。</span></span><br><span class="line">        <span class="built_in">ndisprotServiceReads</span>(pOpenContext);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="comment">// 读请求只返回STATUS_PENDING.如果不是，则说明出错，按错误返回。</span></span><br><span class="line">    <span class="keyword">if</span> (NtStatus != STATUS_PENDING) &#123;</span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(NtStatus != STATUS_SUCCESS);</span><br><span class="line">        pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">        pIrp-&gt;IoStatus.Status = NtStatus;</span><br><span class="line">        <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (NtStatus);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtCancelRead</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT               pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP                         pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Cancel a pending read IRP. We unlink the IRP from the open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    queue and complete it.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pDeviceObject - pointer to our device object</span></span></span><br><span class="line"><span class="comment"><span class="function">    pIrp - IRP to be cancelled</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    PLIST_ENTRY                 pIrpEntry;</span><br><span class="line">    BOOLEAN                     Found;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">IoReleaseCancelSpinLock</span>(pIrp-&gt;CancelIrql);</span><br><span class="line"></span><br><span class="line">    Found = FALSE;</span><br><span class="line"></span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)pIrp-&gt;Tail.Overlay.DriverContext[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Locate the IRP in the pended read queue and remove it if found.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">for</span> (pIrpEntry = pOpenContext-&gt;PendedReads.Flink;</span><br><span class="line">         pIrpEntry != &amp;pOpenContext-&gt;PendedReads;</span><br><span class="line">         pIrpEntry = pIrpEntry-&gt;Flink) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pIrp == <span class="built_in">CONTAINING_RECORD</span>(pIrpEntry, IRP, Tail.Overlay.ListEntry)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_REMOVE_ENTRY_LIST</span>(&amp;pIrp-&gt;Tail.Overlay.ListEntry);</span><br><span class="line">            pOpenContext-&gt;PendedReadCount--;</span><br><span class="line">            Found = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Found) &#123;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;CancelRead: Open %p, IRP %p\n&quot;</span>, pOpenContext, pIrp));</span><br><span class="line">        pIrp-&gt;IoStatus.Status = STATUS_CANCELLED;</span><br><span class="line">        pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext); <span class="comment">// Cancel removed pended Read</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">ndisprotServiceReads</span><span class="params">(IN PNDISPROT_OPEN_CONTEXT pOpenContext)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Utility routine to copy received data into user buffers and complete READ IRPs.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIRP                pIrp = <span class="literal">NULL</span>;</span><br><span class="line">    PLIST_ENTRY         pIrpEntry;</span><br><span class="line">    PNDIS_PACKET        pRcvPacket;</span><br><span class="line">    PLIST_ENTRY         pRcvPacketEntry;</span><br><span class="line">    PUCHAR              pSrc, pDst;</span><br><span class="line">    ULONG               BytesRemaining; <span class="comment">// at pDst</span></span><br><span class="line">    PNDIS_BUFFER        pNdisBuffer;</span><br><span class="line">    ULONG               BytesAvailable;</span><br><span class="line">    BOOLEAN             FoundPendingIrp;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_VERY_LOUD, (<span class="string">&quot;ServiceReads: open %p/%x\n&quot;</span>, pOpenContext, pOpenContext-&gt;Flags));</span><br><span class="line">    <span class="built_in">NPROT_REF_OPEN</span>(pOpenContext);  <span class="comment">// temp ref - service reads</span></span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="comment">// 只要读请求队列和接收包队列同时不为空，则可以做...</span></span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">NPROT_IS_LIST_EMPTY</span>(&amp;pOpenContext-&gt;PendedReads) &amp;&amp; !<span class="built_in">NPROT_IS_LIST_EMPTY</span>(&amp;pOpenContext-&gt;RecvPktQueue)) &#123;</span><br><span class="line">        FoundPendingIrp = FALSE;</span><br><span class="line">        <span class="comment">// 获得第一个未决读请求</span></span><br><span class="line">        pIrpEntry = pOpenContext-&gt;PendedReads.Flink;</span><br><span class="line">        <span class="keyword">while</span> (pIrpEntry != &amp;pOpenContext-&gt;PendedReads) &#123;</span><br><span class="line">            <span class="comment">// 从链表节点得到IRP</span></span><br><span class="line">            pIrp = <span class="built_in">CONTAINING_RECORD</span>(pIrpEntry, IRP, Tail.Overlay.ListEntry);</span><br><span class="line">            <span class="comment">// 检查这个请求是否正在被取消。</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">IoSetCancelRoutine</span>(pIrp, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                <span class="comment">// 把这个IRP出列。</span></span><br><span class="line">                <span class="built_in">NPROT_REMOVE_ENTRY_LIST</span>(pIrpEntry);</span><br><span class="line">                FoundPendingIrp = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果是在去掉，则跳过这个IRP即可。使用下一个。</span></span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;ServiceReads: open %p, skipping cancelled IRP %p\n&quot;</span>, pOpenContext, pIrp));</span><br><span class="line">                pIrpEntry = pIrpEntry-&gt;Flink;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 如果没有IRP,直接跳出结束。</span></span><br><span class="line">        <span class="keyword">if</span> (FoundPendingIrp == FALSE)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 得到第一个包（最旧的），出队列。</span></span><br><span class="line">        pRcvPacketEntry = pOpenContext-&gt;RecvPktQueue.Flink;</span><br><span class="line">        <span class="built_in">NPROT_REMOVE_ENTRY_LIST</span>(pRcvPacketEntry);</span><br><span class="line">        pOpenContext-&gt;RecvPktCount--;</span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);</span><br><span class="line">        <span class="comment">// 从节点获得包。</span></span><br><span class="line">        pRcvPacket = <span class="built_in">NPROT_LIST_ENTRY_TO_RCV_PKT</span>(pRcvPacketEntry);</span><br><span class="line">        <span class="comment">//  Copy as much data as possible from the receive packet to the IRP MDL.</span></span><br><span class="line">        <span class="comment">// 得到IRP的输出缓冲地址。然后尽量拷贝更多的数据。</span></span><br><span class="line">        pDst = <span class="built_in">MmGetSystemAddressForMdlSafe</span>(pIrp-&gt;MdlAddress, NormalPagePriority);</span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pDst != <span class="literal">NULL</span>);  <span class="comment">// since it was already mapped</span></span><br><span class="line">        BytesRemaining = <span class="built_in">MmGetMdlByteCount</span>(pIrp-&gt;MdlAddress);</span><br><span class="line">        pNdisBuffer = <span class="built_in">NDIS_PACKET_FIRST_NDIS_BUFFER</span>(pRcvPacket);</span><br><span class="line">        <span class="comment">// 请注意，每个PNDIS_BUFFER都是一个PMDL，同时PNDIS_BUFFER本身都是链表。用NdisGetNextBuffer可以从一个得到它的下面一个。包的数据实际上是保存在一个缓冲描述符链表里的。</span></span><br><span class="line">        <span class="keyword">while</span> (BytesRemaining &amp;&amp; (pNdisBuffer != <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="meta">#<span class="keyword">ifndef</span> WIN9X</span></span><br><span class="line">            <span class="built_in">NdisQueryBufferSafe</span>(pNdisBuffer, &amp;pSrc, &amp;BytesAvailable, NormalPagePriority);</span><br><span class="line">            <span class="keyword">if</span> (pSrc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;ServiceReads: Open %p, QueryBuffer failed for buffer %p\n&quot;</span>, pOpenContext, pNdisBuffer));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="built_in">NdisQueryBuffer</span>(pNdisBuffer, &amp;pSrc, &amp;BytesAvailable);</span><br><span class="line">            <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="comment">// 如果还可以继续拷贝，就继续拷贝。</span></span><br><span class="line">            <span class="keyword">if</span> (BytesAvailable) &#123;</span><br><span class="line">                ULONG       BytesToCopy = <span class="built_in">MIN</span>(BytesAvailable, BytesRemaining);</span><br><span class="line">                <span class="built_in">NPROT_COPY_MEM</span>(pDst, pSrc, BytesToCopy);</span><br><span class="line">                BytesRemaining -= BytesToCopy;</span><br><span class="line">                pDst += BytesToCopy;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="built_in">NdisGetNextBuffer</span>(pNdisBuffer, &amp;pNdisBuffer);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 拷贝好数据之后，结束IRP即可。</span></span><br><span class="line">        pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">        pIrp-&gt;IoStatus.Information = <span class="built_in">MmGetMdlByteCount</span>(pIrp-&gt;MdlAddress) - BytesRemaining;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;ServiceReads: Open %p, IRP %p completed with %d bytes\n&quot;</span>, pOpenContext, pIrp, pIrp-&gt;IoStatus.Information));</span><br><span class="line">        <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">        <span class="comment">// 如果这个包描述符不是从接收包池里分配的，那么就是从网卡驱动里重用的。如果是重用的，调用NdisReturnPackets归还给网卡驱动，让它释放。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NdisGetPoolFromPacket</span>(pRcvPacket) != pOpenContext-&gt;RecvPacketPool)</span><br><span class="line">            <span class="built_in">NdisReturnPackets</span>(&amp;pRcvPacket, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// 否则的话自己释放。</span></span><br><span class="line">            <span class="built_in">ndisprotFreeReceivePacket</span>(pOpenContext, pRcvPacket);</span><br><span class="line">        <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);    <span class="comment">// took out pended Read</span></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        pOpenContext-&gt;PendedReadCount--;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);    <span class="comment">// temp ref - service reads</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NDIS_STATUS <span class="title">NdisProtReceive</span><span class="params">(IN NDIS_HANDLE ProtocolBindingContext, IN NDIS_HANDLE MacReceiveContext, __in_bcount(HeaderBufferSize) IN PVOID pHeaderBuffer, IN UINT HeaderBufferSize, __in_bcount(LookaheadBufferSize) IN PVOID pLookaheadBuffer, IN UINT LookaheadBufferSize, IN UINT PacketSize)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Our protocol receive handler called by NDIS, typically if we have a miniport below that doesn&#x27;t indicate packets.</span></span></span><br><span class="line"><span class="comment"><span class="function">    We make a local packet/buffer copy of this data, queue it up, and kick off the read service routine.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    MacReceiveContext - for use in NdisTransferData</span></span></span><br><span class="line"><span class="comment"><span class="function">    pHeaderBuffer - pointer to data header</span></span></span><br><span class="line"><span class="comment"><span class="function">    HeaderBufferSize - size of the above</span></span></span><br><span class="line"><span class="comment"><span class="function">    pLookaheadBuffer - pointer to buffer containing lookahead data</span></span></span><br><span class="line"><span class="comment"><span class="function">    LookaheadBufferSize - size of the above</span></span></span><br><span class="line"><span class="comment"><span class="function">    PacketSize - size of the entire packet, minus header size.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS_STATUS_NOT_ACCEPTED - if this packet is uninteresting</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS_STATUS_SUCCESS - if we processed this successfully</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line">    NDIS_STATUS             Status;</span><br><span class="line">    PNDIS_PACKET            pRcvPacket;</span><br><span class="line">    PUCHAR                  pRcvData;</span><br><span class="line">    UINT                    BytesTransferred;</span><br><span class="line">    PNDIS_BUFFER            pOriginalNdisBuffer, pPartialNdisBuffer;</span><br><span class="line">    <span class="comment">// 获得绑定句柄。</span></span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    pRcvPacket = <span class="literal">NULL</span>;</span><br><span class="line">    pRcvData = <span class="literal">NULL</span>;</span><br><span class="line">    Status = NDIS_STATUS_SUCCESS;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 如果头长度不是以太网包头的长度，则不接收这个包。本协议只接收以太网包。</span></span><br><span class="line">        <span class="keyword">if</span> (HeaderBufferSize != <span class="built_in">sizeof</span>(NDISPROT_ETH_HEADER)) &#123;</span><br><span class="line">            Status = NDIS_STATUS_NOT_ACCEPTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 这个比较比较奇怪。难道头长度是负数?</span></span><br><span class="line">        <span class="keyword">if</span> ((PacketSize + HeaderBufferSize) &lt; PacketSize) &#123;</span><br><span class="line">            Status = NDIS_STATUS_NOT_ACCEPTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 分配一个包。包括包描述符和缓冲描述符，以及内存空间，一次性分配好。</span></span><br><span class="line">        pRcvPacket = <span class="built_in">ndisprotAllocateReceivePacket</span>(pOpenContext, PacketSize + HeaderBufferSize, &amp;pRcvData);</span><br><span class="line">        <span class="comment">// 如果分配失败了，就不再接收这个包了。</span></span><br><span class="line">        <span class="keyword">if</span> ((pRcvPacket == <span class="literal">NULL</span>) || (pRcvData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            Status = NDIS_STATUS_NOT_ACCEPTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 内存拷贝。先拷贝以太网包头。</span></span><br><span class="line">        <span class="built_in">NdisMoveMappedMemory</span>(pRcvData, pHeaderBuffer, HeaderBufferSize);</span><br><span class="line">        <span class="comment">// 检查前视区里是否包含了完整包的数据。</span></span><br><span class="line">        <span class="keyword">if</span> (PacketSize == LookaheadBufferSize) &#123;</span><br><span class="line">            <span class="comment">// 如果前视区已经包括了整个数据包，那么调用NdisCopyLookaheadData就得到了完整的包，然后调用ndisprotQueueReceivePacket将这个包插入队列即可。</span></span><br><span class="line">            <span class="built_in">NdisCopyLookaheadData</span>(pRcvData + HeaderBufferSize, pLookaheadBuffer, LookaheadBufferSize, pOpenContext-&gt;MacOptions);</span><br><span class="line">            <span class="built_in">ndisprotQueueReceivePacket</span>(pOpenContext, pRcvPacket);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 否则的话，需要分配一个新的缓冲描述符。请注意这个描述符号对应的是从包缓冲区开始之后HeaderBufferSize个字节之后处开始的空间（pRcvData + HeaderBufferSize）。</span></span><br><span class="line">            <span class="built_in">NdisAllocateBuffer</span>(&amp;Status, &amp;pPartialNdisBuffer, pOpenContext-&gt;RecvBufferPool, pRcvData + HeaderBufferSize, PacketSize);</span><br><span class="line">            <span class="keyword">if</span> (Status == NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">                <span class="comment">// 如果成功了，就把包上原有的缓冲解链。使原来的缓冲描述符脱离包描述符。</span></span><br><span class="line">                <span class="built_in">NdisUnchainBufferAtFront</span>(pRcvPacket, &amp;pOriginalNdisBuffer);</span><br><span class="line">                <span class="comment">// 现在把原来的包描述符保存在包描述符中（保留以备后用）</span></span><br><span class="line">                <span class="built_in">NPROT_RCV_PKT_TO_ORIGINAL_BUFFER</span>(pRcvPacket) = pOriginalNdisBuffer;</span><br><span class="line">                <span class="comment">// 然后把新的缓冲描述符连接到包上。</span></span><br><span class="line">                <span class="built_in">NdisChainBufferAtBack</span>(pRcvPacket, pPartialNdisBuffer);</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;Receive: setting up for TransferData: Pkt %p, OriginalBuf %p, PartialBuf %p\n&quot;</span>, pRcvPacket, pOriginalNdisBuffer, pPartialNdisBuffer));</span><br><span class="line">                <span class="comment">// 然后调用NdisTransferData来传输数据包剩余的部分。这个调用完成之后，协议特征中的NdisProtTransferDataComplete会被调用。</span></span><br><span class="line">                <span class="built_in">NdisTransferData</span>(&amp;Status, pOpenContext-&gt;BindingHandle, MacReceiveContext, <span class="number">0</span>, PacketSize, pRcvPacket, &amp;BytesTransferred);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 如果失败了，就不会调用NdisTransferData。但是我们还是要在NdisProtTransferDataComplete中做最后的处理。所以自己填写BytesTransferred。</span></span><br><span class="line">                BytesTransferred = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (Status != NDIS_STATUS_PENDING)</span><br><span class="line">                <span class="comment">// 如果前面就失败了，我们自己调用NdisProtTransferDataComplete。</span></span><br><span class="line">                <span class="built_in">NdisProtTransferDataComplete</span>((NDIS_HANDLE)pOpenContext, pRcvPacket, Status, BytesTransferred);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;Receive: Open %p, Pkt %p, Size %d\n&quot;</span>, pOpenContext, pRcvPacket, PacketSize));</span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">NdisProtTransferDataComplete</span><span class="params">(IN NDIS_HANDLE ProtocolBindingContext, IN PNDIS_PACKET pNdisPacket, IN NDIS_STATUS TransferStatus, IN UINT BytesTransferred)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    NDIS entry point called to signal completion of a call to NdisTransferData that had pended.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    pNdisPacket - our receive packet into which data is transferred</span></span></span><br><span class="line"><span class="comment"><span class="function">    TransferStatus - status of the transfer</span></span></span><br><span class="line"><span class="comment"><span class="function">    BytesTransferred - bytes copied into the packet.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line">    PNDIS_BUFFER            pOriginalBuffer, pPartialBuffer;</span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(BytesTransferred);</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    <span class="comment">// 得到保存过的旧的缓冲描述符。要记得在传输之前，为了让传输的内容正确的写到以太网包头后，我们分配了一个新的缓冲描述符替换了旧的缓冲描述符。现在要恢复它了。</span></span><br><span class="line">    pOriginalBuffer = <span class="built_in">NPROT_RCV_PKT_TO_ORIGINAL_BUFFER</span>(pNdisPacket);</span><br><span class="line">    <span class="keyword">if</span> (pOriginalBuffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 和前面的替换时的操作一样，先Unchain，然后再调用Chain。调用之后已经恢复了使用旧的包描述符。</span></span><br><span class="line">        <span class="built_in">NdisUnchainBufferAtFront</span>(pNdisPacket, &amp;pPartialBuffer);</span><br><span class="line">        <span class="built_in">NdisChainBufferAtBack</span>(pNdisPacket, pOriginalBuffer);</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;TransferComp: Pkt %p, OrigBuf %p, PartialBuf %p\n&quot;</span>, pNdisPacket, pOriginalBuffer, pPartialBuffer));</span><br><span class="line">        <span class="built_in">ASSERT</span>(pPartialBuffer != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">// 那么那个新的包描述符已经没用了，调用NdisFreeBuffer释放它。</span></span><br><span class="line">        <span class="keyword">if</span> (pPartialBuffer != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">NdisFreeBuffer</span>(pPartialBuffer);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (TransferStatus == NDIS_STATUS_SUCCESS)</span><br><span class="line">        <span class="comment">// 如果传输是成功的，将包保存到接收队列中。</span></span><br><span class="line">        <span class="built_in">ndisprotQueueReceivePacket</span>(pOpenContext, pNdisPacket);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// 如果传输失败了，直接释放这个包。</span></span><br><span class="line">        <span class="built_in">ndisprotFreeReceivePacket</span>(pOpenContext, pNdisPacket);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtReceiveComplete</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN NDIS_HANDLE                  ProtocolBindingContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Protocol entry point called by NDIS when the miniport</span></span></span><br><span class="line"><span class="comment"><span class="function">    has finished indicating up a batch of receives.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    We ignore this.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line"></span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">INT <span class="title">NdisProtReceivePacket</span><span class="params">(IN NDIS_HANDLE ProtocolBindingContext, IN PNDIS_PACKET pNdisPacket)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Protocol entry point called by NDIS if the driver below uses NDIS 4 style receive packet indications.</span></span></span><br><span class="line"><span class="comment"><span class="function">    If the miniport allows us to hold on to this packet, we use it as is, otherwise we make a copy.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    ProtocolBindingContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    pNdisPacket - the packet being indicated up.</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line">    PNDIS_BUFFER            pNdisBuffer;</span><br><span class="line">    UINT                    BufferLength;</span><br><span class="line">    PNDISPROT_ETH_HEADER     pEthHeader;</span><br><span class="line">    PNDIS_PACKET            pCopyPacket;</span><br><span class="line">    PUCHAR                  pCopyBuf;</span><br><span class="line">    UINT                    TotalPacketLength;</span><br><span class="line">    UINT                    BytesCopied;</span><br><span class="line">    INT                     RefCount = <span class="number">0</span>;</span><br><span class="line">    NDIS_STATUS             Status;</span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line">    <span class="built_in">NdisGetFirstBufferFromPacketSafe</span>(pNdisPacket, &amp;pNdisBuffer, &amp;pEthHeader, &amp;BufferLength, &amp;TotalPacketLength, NormalPagePriority);</span><br><span class="line">    <span class="keyword">if</span> (pEthHeader == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="comment">//  The system is low on resources. Set up to handle failure below.</span></span><br><span class="line">        BufferLength = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">// 从包描述符中得到第一个缓冲描述符。</span></span><br><span class="line">    <span class="built_in">NdisGetFirstBufferFromPacket</span>(pNdisPacket, &amp;pNdisBuffer, &amp;pEthHeader, &amp;BufferLength, &amp;TotalPacketLength);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 如果这个包的长度比以太网包头还要小，丢弃之。</span></span><br><span class="line">        <span class="keyword">if</span> (BufferLength &lt; <span class="built_in">sizeof</span>(NDISPROT_ETH_HEADER)) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;ReceivePacket: Open %p, runt pkt %p, first buffer length %d\n&quot;</span>, pOpenContext, pNdisPacket, BufferLength));</span><br><span class="line">            Status = NDIS_STATUS_NOT_ACCEPTED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;ReceivePacket: Open %p, interesting pkt %p\n&quot;</span>, pOpenContext, pNdisPacket));</span><br><span class="line">        <span class="comment">// 如果这个包有NDIS_STATUS_RESOURCES状态，则必须拷贝而不能重用该包。当然这样就比较消耗时间和资源了。</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">NDIS_GET_PACKET_STATUS</span>(pNdisPacket) == NDIS_STATUS_RESOURCES) || pOpenContext-&gt;bRunningOnWin9x) &#123;</span><br><span class="line">            <span class="comment">// 下面是分配一个包并拷贝其内容。读者可以参考前面讲过的内容来理解。</span></span><br><span class="line">            pCopyPacket = <span class="built_in">ndisprotAllocateReceivePacket</span>(pOpenContext, TotalPacketLength, &amp;pCopyBuf);</span><br><span class="line">            <span class="keyword">if</span> (pCopyPacket == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;ReceivePacket: Open %p, failed to alloc copy, %d bytes\n&quot;</span>, pOpenContext, TotalPacketLength));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 调用NdisCopyFromPacketToPacket来拷贝包。当然在拷贝之前调用者必须确保目标包的缓冲区长度是足够的。</span></span><br><span class="line">            <span class="built_in">NdisCopyFromPacketToPacket</span>(pCopyPacket, <span class="number">0</span>, TotalPacketLength, pNdisPacket, <span class="number">0</span>, &amp;BytesCopied);</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>(BytesCopied == TotalPacketLength);</span><br><span class="line">            <span class="comment">// 那么现在开始就用新的包了。</span></span><br><span class="line">            pNdisPacket = pCopyPacket;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// 返回值。返回值表示的是我们已经一次引用了这个包。当处理完结的时候，我们就可以调用NdisReturnPackets来要求下层驱动释放这个包了。本函数把RefCount当做返回值。如果返回了0，那么下层驱动会认为我们不再需要这个数据包。</span></span><br><span class="line">            RefCount = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 将数据包放入队列里。</span></span><br><span class="line">        <span class="built_in">ndisprotQueueReceivePacket</span>(pOpenContext, pNdisPacket);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="keyword">return</span> (RefCount);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">ndisprotQueueReceivePacket</span><span class="params">(IN PNDISPROT_OPEN_CONTEXT pOpenContext, IN PNDIS_PACKET pRcvPacket)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function">    Queue up a received packet on the open context structure. If the queue size goes beyond a water mark, discard a packet at the head of the queue.</span></span></span><br><span class="line"><span class="comment"><span class="function">    Finally, run the queue service routine.</span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    pRcvPacket - the received packet</span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PLIST_ENTRY     pEnt;</span><br><span class="line">    PLIST_ENTRY     pDiscardEnt;</span><br><span class="line">    PNDIS_PACKET    pDiscardPkt;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        pEnt = <span class="built_in">NPROT_RCV_PKT_TO_LIST_ENTRY</span>(pRcvPacket);</span><br><span class="line">        <span class="built_in">NPROT_REF_OPEN</span>(pOpenContext);    <span class="comment">// queued rcv packet</span></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 如果处于活动的状态，并且正确的电源状态，那么就把这个包插入接收缓冲链表中。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE) &amp;&amp;</span><br><span class="line">            (pOpenContext-&gt;PowerState == NetDeviceStateD0)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_INSERT_TAIL_LIST</span>(&amp;pOpenContext-&gt;RecvPktQueue, pEnt);</span><br><span class="line">            pOpenContext-&gt;RecvPktCount++;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_VERY_LOUD, (<span class="string">&quot;QueueReceivePacket: open %p, queued pkt %p, queue size %d\n&quot;</span>, pOpenContext, pRcvPacket, pOpenContext-&gt;RecvPktCount));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 否则的话，就直接释放掉这个包即可。</span></span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="built_in">ndisprotFreeReceivePacket</span>(pOpenContext, pRcvPacket);</span><br><span class="line">            <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);  <span class="comment">// dropped rcv packet - bad state</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 如果输入缓冲区里包太多了，就要删除一个。</span></span><br><span class="line">        <span class="keyword">if</span> (pOpenContext-&gt;RecvPktCount &gt; MAX_RECV_QUEUE_SIZE) &#123;</span><br><span class="line">            <span class="comment">// 要删除的包的链节点指针</span></span><br><span class="line">            pDiscardEnt = pOpenContext-&gt;RecvPktQueue.Flink;</span><br><span class="line">            <span class="built_in">NPROT_REMOVE_ENTRY_LIST</span>(pDiscardEnt);</span><br><span class="line">            <span class="comment">// 接收包数量减去1</span></span><br><span class="line">            pOpenContext-&gt;RecvPktCount--;</span><br><span class="line">            <span class="comment">// 可以释放锁了。</span></span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="comment">// 从链节点转换为包的指针</span></span><br><span class="line">            pDiscardPkt = <span class="built_in">NPROT_LIST_ENTRY_TO_RCV_PKT</span>(pDiscardEnt);</span><br><span class="line">            <span class="comment">// 把包释放掉。</span></span><br><span class="line">            <span class="built_in">ndisprotFreeReceivePacket</span>(pOpenContext, pDiscardPkt);</span><br><span class="line">            <span class="comment">// 打开上下文解引用。这是因为每入队一个都要增加一次引用计数。</span></span><br><span class="line">            <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);  <span class="comment">// dropped rcv packet - queue too long</span></span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;QueueReceivePacket: open %p queue too long, discarded pkt %p\n&quot;</span>, pOpenContext, pDiscardPkt));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 服务函数。这个函数看是否有未决的读请求。如果有，就取包来完成这个请求。</span></span><br><span class="line">        <span class="built_in">ndisprotServiceReads</span>(pOpenContext);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">PNDIS_PACKET</span></span><br><span class="line"><span class="function"><span class="title">ndisprotAllocateReceivePacket</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN UINT                         DataLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    OUT PUCHAR* ppDataBuffer</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Allocate resources to copy and queue a received packet.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context for received packet</span></span></span><br><span class="line"><span class="comment"><span class="function">    DataLength - total length in bytes of the packet</span></span></span><br><span class="line"><span class="comment"><span class="function">    ppDataBuffer - place to return pointer to allocated buffer</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Pointer to NDIS packet if successful, else NULL.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDIS_PACKET            pNdisPacket;</span><br><span class="line">    PNDIS_BUFFER            pNdisBuffer;</span><br><span class="line">    PUCHAR                  pDataBuffer;</span><br><span class="line">    NDIS_STATUS             Status;</span><br><span class="line"></span><br><span class="line">    pNdisPacket = <span class="literal">NULL</span>;</span><br><span class="line">    pNdisBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    pDataBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="built_in">NPROT_ALLOC_MEM</span>(pDataBuffer, DataLength);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pDataBuffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;AllocRcvPkt: open %p, failed to alloc&quot;</span></span><br><span class="line">                              <span class="string">&quot; data buffer %d bytes\n&quot;</span>, pOpenContext, DataLength));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Make this an NDIS buffer.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">NdisAllocateBuffer</span>(</span><br><span class="line">            &amp;Status,</span><br><span class="line">            &amp;pNdisBuffer,</span><br><span class="line">            pOpenContext-&gt;RecvBufferPool,</span><br><span class="line">            pDataBuffer,</span><br><span class="line">            DataLength);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;AllocateRcvPkt: open %p, failed to alloc&quot;</span></span><br><span class="line">                              <span class="string">&quot; NDIS buffer, %d bytes\n&quot;</span>, pOpenContext, DataLength));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NdisAllocatePacket</span>(&amp;Status, &amp;pNdisPacket, pOpenContext-&gt;RecvPacketPool);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;AllocateRcvPkt: open %p, failed to alloc&quot;</span></span><br><span class="line">                              <span class="string">&quot; NDIS packet, %d bytes\n&quot;</span>, pOpenContext, DataLength));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NDIS_SET_PACKET_STATUS</span>(pNdisPacket, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">NPROT_RCV_PKT_TO_ORIGINAL_BUFFER</span>(pNdisPacket) = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NdisChainBufferAtFront</span>(pNdisPacket, pNdisBuffer);</span><br><span class="line"></span><br><span class="line">        *ppDataBuffer = pDataBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pNdisPacket == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Clean up</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (pNdisBuffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">NdisFreeBuffer</span>(pNdisBuffer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pDataBuffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">NPROT_FREE_MEM</span>(pDataBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (pNdisPacket);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFreeReceivePacket</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDIS_PACKET                 pNdisPacket</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Free up all resources associated with a received packet. If this</span></span></span><br><span class="line"><span class="comment"><span class="function">    is a local copy, free the packet to our receive pool, else return</span></span></span><br><span class="line"><span class="comment"><span class="function">    this to the miniport.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function">    pNdisPacket - pointer to packet to be freed.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDIS_BUFFER        pNdisBuffer;</span><br><span class="line">    UINT                TotalLength;</span><br><span class="line">    UINT                BufferLength;</span><br><span class="line">    PUCHAR              pCopyData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NdisGetPoolFromPacket</span>(pNdisPacket) == pOpenContext-&gt;RecvPacketPool) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  This is a local copy.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line">        <span class="built_in">NdisGetFirstBufferFromPacketSafe</span>(</span><br><span class="line">            pNdisPacket,</span><br><span class="line">            &amp;pNdisBuffer,</span><br><span class="line">            (PVOID*)&amp;pCopyData,</span><br><span class="line">            &amp;BufferLength,</span><br><span class="line">            &amp;TotalLength,</span><br><span class="line">            NormalPagePriority);</span><br><span class="line">        <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">NdisGetFirstBufferFromPacket</span>(</span><br><span class="line">            pNdisPacket,</span><br><span class="line">            &amp;pNdisBuffer,</span><br><span class="line">            (PVOID*)&amp;pCopyData,</span><br><span class="line">            &amp;BufferLength,</span><br><span class="line">            &amp;TotalLength);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(BufferLength == TotalLength);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pNdisBuffer != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pCopyData != <span class="literal">NULL</span>); <span class="comment">// we would have allocated non-paged pool</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">NdisFreePacket</span>(pNdisPacket);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NdisFreeBuffer</span>(pNdisBuffer);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_FREE_MEM</span>(pCopyData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NdisReturnPackets</span>(&amp;pNdisPacket, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotCancelPendingReads</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT        pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Cancel any pending read IRPs queued on the given open.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIRP                pIrp;</span><br><span class="line">    PLIST_ENTRY         pIrpEntry;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_REF_OPEN</span>(pOpenContext);  <span class="comment">// temp ref - cancel reads</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">NPROT_IS_LIST_EMPTY</span>(&amp;pOpenContext-&gt;PendedReads)) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Get the first pended Read IRP</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        pIrpEntry = pOpenContext-&gt;PendedReads.Flink;</span><br><span class="line">        pIrp = <span class="built_in">CONTAINING_RECORD</span>(pIrpEntry, IRP, Tail.Overlay.ListEntry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Check to see if it is being cancelled.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IoSetCancelRoutine</span>(pIrp, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  It isn&#x27;t being cancelled, and can&#x27;t be cancelled henceforth.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="built_in">NPROT_REMOVE_ENTRY_LIST</span>(pIrpEntry);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Complete the IRP.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            pIrp-&gt;IoStatus.Status = STATUS_CANCELLED;</span><br><span class="line">            pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;CancelPendingReads: Open %p, IRP %p cancelled\n&quot;</span>,</span><br><span class="line">                             pOpenContext, pIrp));</span><br><span class="line"></span><br><span class="line">            <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);    <span class="comment">// took out pended Read for cancelling</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            pOpenContext-&gt;PendedReadCount--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  It is being cancelled, let the cancel routine handle it.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Give the cancel routine some breathing space, otherwise</span></span><br><span class="line">            <span class="comment">//  we might end up examining the same (cancelled) IRP over</span></span><br><span class="line">            <span class="comment">//  and over again.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="built_in">NPROT_SLEEP</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);    <span class="comment">// temp ref - cancel reads</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">ndisprotFlushReceiveQueue</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PNDISPROT_OPEN_CONTEXT            pOpenContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Free any receive packets queued up on the specified open</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pOpenContext - pointer to open context</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PLIST_ENTRY         pRcvPacketEntry;</span><br><span class="line">    PNDIS_PACKET        pRcvPacket;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_REF_OPEN</span>(pOpenContext);  <span class="comment">// temp ref - flushRcvQueue</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">NPROT_IS_LIST_EMPTY</span>(&amp;pOpenContext-&gt;RecvPktQueue)) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Get the first queued receive packet</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        pRcvPacketEntry = pOpenContext-&gt;RecvPktQueue.Flink;</span><br><span class="line">        <span class="built_in">NPROT_REMOVE_ENTRY_LIST</span>(pRcvPacketEntry);</span><br><span class="line"></span><br><span class="line">        pOpenContext-&gt;RecvPktCount--;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">        pRcvPacket = <span class="built_in">NPROT_LIST_ENTRY_TO_RCV_PKT</span>(pRcvPacketEntry);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_LOUD, (<span class="string">&quot;FlushReceiveQueue: open %p, pkt %p\n&quot;</span>,</span><br><span class="line">                         pOpenContext, pRcvPacket));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ndisprotFreeReceivePacket</span>(pOpenContext, pRcvPacket);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);    <span class="comment">// took out pended Read</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);    <span class="comment">// temp ref - flushRcvQueue</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>send.c：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 2000  Microsoft Corporation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    send.c</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NDIS protocol entry points and utility routines to handle sending</span></span><br><span class="line"><span class="comment">    data.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Environment:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Kernel mode only.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Revision History:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;precomp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILENUMBER <span class="string">&#x27;DNES&#x27;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 分发函数，处理写请求（也就是发包请求）。</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">NdisProtWrite</span><span class="params">(IN PDEVICE_OBJECT pDeviceObject,IN PIRP pIrp)</span> </span>&#123;</span><br><span class="line">    PIO_STACK_LOCATION      pIrpSp;</span><br><span class="line">    ULONG                   DataLength;</span><br><span class="line">    NTSTATUS                NtStatus;</span><br><span class="line">    NDIS_STATUS             Status;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT   pOpenContext;</span><br><span class="line">    PNDIS_PACKET            pNdisPacket;</span><br><span class="line">    PNDIS_BUFFER            pNdisBuffer;</span><br><span class="line">    NDISPROT_ETH_HEADER UNALIGNED* pEthHeader;</span><br><span class="line">    <span class="comment">// NDIS51支持写请求取消。但是本书不讨论请求取消的话题。</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line">    PVOID                   CancelId;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line">    <span class="comment">// 首先得到打开上下文。以确认是用哪个网卡发包。</span></span><br><span class="line">    pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    pOpenContext = pIrpSp-&gt;FileObject-&gt;FsContext;</span><br><span class="line">    pNdisPacket = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 检查打开上下文的可靠性。</span></span><br><span class="line">        <span class="keyword">if</span> (pOpenContext == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;Write: FileObject %p not yet associated with a device\n&quot;</span>, pIrpSp-&gt;FileObject));</span><br><span class="line">            NtStatus = STATUS_INVALID_HANDLE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">        <span class="comment">// 确认输入缓冲的可靠性。</span></span><br><span class="line">        <span class="keyword">if</span> (pIrp-&gt;MdlAddress == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;Write: NULL MDL address on IRP %p\n&quot;</span>, pIrp));</span><br><span class="line">            NtStatus = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 得到输入缓冲的虚拟地址。之后进行一系列的检查。第一，输入缓冲虚拟地址不能为NULL，第二，缓冲的长度，至少必须比一个以太网包头要长。否则无法填写以太网包头。第三，发包的长度不能超过这个网卡的最大帧长。第四，</span></span><br><span class="line">        pEthHeader = <span class="built_in">MmGetSystemAddressForMdlSafe</span>(pIrp-&gt;MdlAddress, NormalPagePriority);</span><br><span class="line">        <span class="keyword">if</span> (pEthHeader == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;Write: MmGetSystemAddr failed for IRP %p, MDL %p\n&quot;</span>, pIrp, pIrp-&gt;MdlAddress));</span><br><span class="line">            NtStatus = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        DataLength = <span class="built_in">MmGetMdlByteCount</span>(pIrp-&gt;MdlAddress);</span><br><span class="line">        <span class="keyword">if</span> (DataLength &lt; <span class="built_in">sizeof</span>(NDISPROT_ETH_HEADER)) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;Write: too small to be a valid packet (%d bytes)\n&quot;</span>, DataLength));</span><br><span class="line">            NtStatus = STATUS_BUFFER_TOO_SMALL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (DataLength &gt; (pOpenContext-&gt;MaxFrameSize + <span class="built_in">sizeof</span>(NDISPROT_ETH_HEADER))) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;Write: Open %p: data length (%d) larger than max frame size (%d)\n&quot;</span>, pOpenContext, DataLength, pOpenContext-&gt;MaxFrameSize));</span><br><span class="line">            NtStatus = STATUS_INVALID_BUFFER_SIZE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 下面开始检查，缓冲中是否已经填写了伪造的MAC地址。方法很简单，取得已填写的地址和网卡的MAC地址比较。如果不符合则返回失败。很多情况，网络攻击工具是不会拷贝这段代码的。</span></span><br><span class="line">        <span class="keyword">if</span> ((pIrp-&gt;RequestorMode == UserMode) &amp;&amp; !<span class="built_in">NPROT_MEM_CMP</span>(pEthHeader-&gt;SrcAddr, pOpenContext-&gt;CurrentAddress, NPROT_MAC_ADDR_LEN)) &#123;</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_WARN, (<span class="string">&quot;Write: Failing with invalid Source address&quot;</span>));</span><br><span class="line">            NtStatus = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 确认包可以发送了。下面开始真实的准备发送一个包，首先获得锁，并判断当前网卡是否处于可以发包的状态。</span></span><br><span class="line">        <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">NPROT_TEST_FLAGS</span>(pOpenContext-&gt;Flags, NUIOO_BIND_FLAGS, NUIOO_BIND_ACTIVE)) &#123;</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;Write: Open %p is not bound or in low power state\n&quot;</span>, pOpenContext));</span><br><span class="line">            NtStatus = STATUS_INVALID_HANDLE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 从前面绑定时分配的发送包池中分配一个包描述符。</span></span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pOpenContext-&gt;SendPacketPool != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">NdisAllocatePacket</span>(&amp;Status,&amp;pNdisPacket,pOpenContext-&gt;SendPacketPool);</span><br><span class="line">        <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;Write: open %p, failed to alloc send pkt\n&quot;</span>, pOpenContext));</span><br><span class="line">            NtStatus = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 下面的代码为Win9x编写，本书不讨论。</span></span><br><span class="line">        <span class="keyword">if</span> (pOpenContext-&gt;bRunningOnWin9x) &#123;</span><br><span class="line">            <span class="built_in">NdisAllocateBuffer</span>(&amp;Status,&amp;pNdisBuffer,pOpenContext-&gt;SendBufferPool,pEthHeader,DataLength);</span><br><span class="line">            <span class="keyword">if</span> (Status != NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">                <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">                <span class="built_in">NdisFreePacket</span>(pNdisPacket);</span><br><span class="line">                <span class="built_in">DEBUGP</span>(DL_FATAL, (<span class="string">&quot;Write: open %p, failed to alloc send buf\n&quot;</span>, pOpenContext));</span><br><span class="line">                NtStatus = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            pNdisBuffer = pIrp-&gt;MdlAddress;</span><br><span class="line">        <span class="comment">// 记录发送包又增加了一个。</span></span><br><span class="line">        <span class="built_in">NdisInterlockedIncrement</span>((PLONG)&amp;pOpenContext-&gt;PendedSendCount);</span><br><span class="line">        <span class="comment">// 打开上下文引用计数加1，这是为了防止发包过程中这个绑定被解除。</span></span><br><span class="line">        <span class="built_in">NPROT_REF_OPEN</span>(pOpenContext);  <span class="comment">// pended send</span></span><br><span class="line">        <span class="built_in">IoMarkIrpPending</span>(pIrp);</span><br><span class="line">        <span class="comment">// 初始化包引用计数。这个包会在计数为0的时候释放掉。</span></span><br><span class="line">        <span class="built_in">NPROT_SEND_PKT_RSVD</span>(pNdisPacket)-&gt;RefCount = <span class="number">1</span>;</span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line">        <span class="comment">// NDIS5.1支持取消发送。我们给每个包设置一个取消ID。每个包和一个写IRP关联，把包的指针保存在IRP中。如果IRP获得取消通知，则使用NdisCancelSendPackets去取消包。</span></span><br><span class="line">        CancelId = <span class="built_in">NPROT_GET_NEXT_CANCEL_ID</span>();</span><br><span class="line">        <span class="built_in">NDIS_SET_PACKET_CANCEL_ID</span>(pNdisPacket, CancelId);</span><br><span class="line">        pIrp-&gt;Tail.Overlay.DriverContext[<span class="number">0</span>] = (PVOID)pOpenContext;</span><br><span class="line">        pIrp-&gt;Tail.Overlay.DriverContext[<span class="number">1</span>] = (PVOID)pNdisPacket;</span><br><span class="line">        <span class="built_in">NPROT_INSERT_TAIL_LIST</span>(&amp;pOpenContext-&gt;PendedWrites, &amp;pIrp-&gt;Tail.Overlay.ListEntry);</span><br><span class="line">        <span class="built_in">IoSetCancelRoutine</span>(pIrp, NdisProtCancelWrite);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span> <span class="comment">// NDIS51</span></span></span><br><span class="line">        <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">        <span class="comment">// 记下irp的指针放在包描述符里，以备后用。</span></span><br><span class="line">        <span class="built_in">NPROT_IRP_FROM_SEND_PKT</span>(pNdisPacket) = pIrp;</span><br><span class="line">        <span class="comment">// 把缓冲和包联系起来。状态设置为pending。</span></span><br><span class="line">        NtStatus = STATUS_PENDING;</span><br><span class="line">        pNdisBuffer-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">NdisChainBufferAtFront</span>(pNdisPacket, pNdisBuffer);</span><br><span class="line">        <span class="comment">// 下面的代码仅供调试使用。</span></span><br><span class="line">        <span class="meta">#<span class="keyword">if</span> SEND_DBG&#123;</span></span><br><span class="line">            PUCHAR      pData;</span><br><span class="line">            pData = <span class="built_in">MmGetSystemAddressForMdlSafe</span>(pNdisBuffer, NormalPagePriority);</span><br><span class="line">            <span class="built_in">NPROT_ASSERT</span>(pEthHeader == pData);</span><br><span class="line">            <span class="built_in">DEBUGP</span>(DL_VERY_LOUD,(<span class="string">&quot;Write: MDL %p, MdlFlags %x, SystemAddr %p, %d bytes\n&quot;</span>,pIrp-&gt;MdlAddress, pIrp-&gt;MdlAddress-&gt;MdlFlags, pData, DataLength));</span><br><span class="line">            <span class="built_in">DEBUGPDUMP</span>(DL_VERY_LOUD, pData, <span class="built_in">MIN</span>(DataLength, <span class="number">48</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span> <span class="comment">// SEND_DBG</span></span></span><br><span class="line">        <span class="comment">// 发送包。非常简单。包发送完之后会自动调用协议特征中的一个回调函数NdisProtSendComplete。在其中再完成IRP即可。</span></span><br><span class="line">        <span class="built_in">NdisSendPackets</span>(pOpenContext-&gt;BindingHandle, &amp;pNdisPacket, <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line">    <span class="comment">// 如果正常发送包是STATUS_PENDING。否则是有错的，可以在这里直接完成。</span></span><br><span class="line">    <span class="keyword">if</span> (NtStatus != STATUS_PENDING) &#123;</span><br><span class="line">        pIrp-&gt;IoStatus.Status = NtStatus;</span><br><span class="line">        <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (NtStatus);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line"></span><br><span class="line"><span class="function">VOID</span></span><br><span class="line"><span class="function"><span class="title">NdisProtCancelWrite</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDEVICE_OBJECT               pDeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PIRP                         pIrp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"><span class="comment">/*++</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Routine Description:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    Cancel a pending write IRP. This routine attempt to cancel the NDIS send.</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Arguments:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    pDeviceObject - pointer to our device object</span></span></span><br><span class="line"><span class="comment"><span class="function">    pIrp - IRP to be cancelled</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">Return Value:</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">    None</span></span></span><br><span class="line"><span class="comment"><span class="function"></span></span></span><br><span class="line"><span class="comment"><span class="function">--*/</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    PLIST_ENTRY                 pIrpEntry;</span><br><span class="line">    PNDIS_PACKET                pNdisPacket;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UNREFERENCED_PARAMETER</span>(pDeviceObject);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">IoReleaseCancelSpinLock</span>(pIrp-&gt;CancelIrql);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The NDIS packet representing this Write IRP.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    pNdisPacket = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)pIrp-&gt;Tail.Overlay.DriverContext[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Try to locate the IRP in the pended write queue. The send completion</span></span><br><span class="line">    <span class="comment">//  routine may be running and might have removed it from there.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (pIrpEntry = pOpenContext-&gt;PendedWrites.Flink;</span><br><span class="line">         pIrpEntry != &amp;pOpenContext-&gt;PendedWrites;</span><br><span class="line">         pIrpEntry = pIrpEntry-&gt;Flink) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pIrp == <span class="built_in">CONTAINING_RECORD</span>(pIrpEntry, IRP, Tail.Overlay.ListEntry)) &#123;</span><br><span class="line">            pNdisPacket = (PNDIS_PACKET)pIrp-&gt;Tail.Overlay.DriverContext[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Place a reference on this packet so that it won&#x27;t get</span></span><br><span class="line">            <span class="comment">//  freed/reused until we are done with it.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="built_in">NPROT_REF_SEND_PKT</span>(pNdisPacket);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pNdisPacket != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Either the send completion routine hasn&#x27;t run, or we got a peak</span></span><br><span class="line">        <span class="comment">//  at the IRP/packet before it had a chance to take it out of the</span></span><br><span class="line">        <span class="comment">//  pending IRP queue.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  We do not complete the IRP here - note that we didn&#x27;t dequeue it</span></span><br><span class="line">        <span class="comment">//  above. This is because we always want the send complete routine to</span></span><br><span class="line">        <span class="comment">//  complete the IRP. And this in turn is because the packet that was</span></span><br><span class="line">        <span class="comment">//  prepared from the IRP has a buffer chain pointing to data associated</span></span><br><span class="line">        <span class="comment">//  with this IRP. Therefore we cannot complete the IRP before the driver</span></span><br><span class="line">        <span class="comment">//  below us is done with the data it pointed to.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Request NDIS to cancel this send. The result of this call is that</span></span><br><span class="line">        <span class="comment">//  our SendComplete handler will be called (if not already called).</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;CancelWrite: cancelling pkt %p on Open %p\n&quot;</span>,</span><br><span class="line">                         pNdisPacket, pOpenContext));</span><br><span class="line">        <span class="built_in">NdisCancelSendPackets</span>(</span><br><span class="line">            pOpenContext-&gt;BindingHandle,</span><br><span class="line">            <span class="built_in">NDIS_GET_PACKET_CANCEL_ID</span>(pNdisPacket)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  It is now safe to remove the reference we had placed on the packet.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="built_in">NPROT_DEREF_SEND_PKT</span>(pNdisPacket);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  else the send completion routine has already picked up this IRP.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// NDIS51</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是协议特征集中的一个回调函数。如果调用了NdisSendPacket,那么在发送结束之后，这个函数会被调用。</span></span><br><span class="line"><span class="function">VOID <span class="title">NdisProtSendComplete</span><span class="params">(IN NDIS_HANDLE ProtocolBindingContext, IN PNDIS_PACKET pNdisPacket, IN NDIS_STATUS Status)</span> </span>&#123;</span><br><span class="line">    PIRP                        pIrp;</span><br><span class="line">    PIO_STACK_LOCATION          pIrpSp;</span><br><span class="line">    PNDISPROT_OPEN_CONTEXT       pOpenContext;</span><br><span class="line">    <span class="comment">// 取得打开上下文。</span></span><br><span class="line">    pOpenContext = (PNDISPROT_OPEN_CONTEXT)ProtocolBindingContext;</span><br><span class="line">    <span class="built_in">NPROT_STRUCT_ASSERT</span>(pOpenContext, oc);</span><br><span class="line">    <span class="comment">// 从包描述符中取得IRP的指针。</span></span><br><span class="line">    pIrp = <span class="built_in">NPROT_IRP_FROM_SEND_PKT</span>(pNdisPacket);</span><br><span class="line">    <span class="comment">// 下面的代码只和Win9x有关。本书不讨论。</span></span><br><span class="line">    <span class="keyword">if</span> (pOpenContext-&gt;bRunningOnWin9x) &#123;</span><br><span class="line">        <span class="comment">//  We would have attached our own NDIS_BUFFER. Take it out and free it.</span></span><br><span class="line">        <span class="meta">#<span class="keyword">ifndef</span> NDIS51</span></span><br><span class="line">        PNDIS_BUFFER                pNdisBuffer;</span><br><span class="line">        PVOID                       VirtualAddr;</span><br><span class="line">        UINT                        BufferLength;</span><br><span class="line">        UINT                        TotalLength;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(FALSE); <span class="comment">// NDIS 5.1 not on Win9X!</span></span><br><span class="line">        <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">NdisGetFirstBufferFromPacket</span>(pNdisPacket, &amp;pNdisBuffer, &amp;VirtualAddr, &amp;BufferLength, &amp;TotalLength);</span><br><span class="line">        <span class="built_in">NPROT_ASSERT</span>(pNdisBuffer != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">NdisFreeBuffer</span>(pNdisBuffer);</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 去掉未决取消函数。同时从未决链中删除。</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> NDIS51</span></span><br><span class="line">    <span class="built_in">IoSetCancelRoutine</span>(pIrp, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">NPROT_ACQUIRE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="built_in">NPROT_REMOVE_ENTRY_LIST</span>(&amp;pIrp-&gt;Tail.Overlay.ListEntry);</span><br><span class="line">    <span class="built_in">NPROT_RELEASE_LOCK</span>(&amp;pOpenContext-&gt;Lock);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 数据包解引用。</span></span><br><span class="line">    <span class="built_in">NPROT_DEREF_SEND_PKT</span>(pNdisPacket);</span><br><span class="line">    <span class="comment">// 把请求完成掉。</span></span><br><span class="line">    pIrpSp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(pIrp);</span><br><span class="line">    <span class="keyword">if</span> (Status == NDIS_STATUS_SUCCESS) &#123;</span><br><span class="line">        pIrp-&gt;IoStatus.Information = pIrpSp-&gt;Parameters.Write.Length;</span><br><span class="line">        pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">        pIrp-&gt;IoStatus.Status = STATUS_UNSUCCESSFUL;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">DEBUGP</span>(DL_INFO, (<span class="string">&quot;SendComplete: packet %p/IRP %p/Length %d completed with status %x\n&quot;</span>, pNdisPacket, pIrp, pIrp-&gt;IoStatus.Information, pIrp-&gt;IoStatus.Status));</span><br><span class="line">    <span class="built_in">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);</span><br><span class="line">    <span class="comment">// 未决发送包减少一个。</span></span><br><span class="line">    <span class="built_in">NdisInterlockedDecrement</span>((PLONG)&amp;pOpenContext-&gt;PendedSendCount);</span><br><span class="line">    <span class="built_in">NPROT_DEREF_OPEN</span>(pOpenContext);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81/">https://monoceros406.github.io/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://monoceros406.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Win%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/">Win驱动开发</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%B0%8F%E7%AB%AF%E5%8F%A3%E9%A9%B1%E5%8A%A8/" title="Windows驱动开发入门-NDIS小端口驱动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows驱动开发入门-NDIS小端口驱动</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8/" title="Windows驱动开发入门-NDIS协议驱动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Windows驱动开发入门-NDIS协议驱动</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/05/28/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-Minifilter%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81/" title="Windows驱动开发入门-Minifilter示例代码"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-28</div><div class="title">Windows驱动开发入门-Minifilter示例代码</div></div></a></div><div><a href="/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%B0%8F%E7%AB%AF%E5%8F%A3%E9%A9%B1%E5%8A%A8/" title="Windows驱动开发入门-NDIS小端口驱动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">Windows驱动开发入门-NDIS小端口驱动</div></div></a></div><div><a href="/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8/" title="Windows驱动开发入门-NDIS协议驱动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">Windows驱动开发入门-NDIS协议驱动</div></div></a></div><div><a href="/2024/05/14/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E4%B8%B2%E5%8F%A3%E8%BF%87%E6%BB%A4%E9%A9%B1%E5%8A%A8/" title="Windows驱动开发入门-串口过滤驱动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-14</div><div class="title">Windows驱动开发入门-串口过滤驱动</div></div></a></div><div><a href="/2024/10/08/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-WFP%E8%BF%87%E6%BB%A4%E5%B9%B3%E5%8F%B0/" title="Windows驱动开发入门-WFP过滤平台"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-08</div><div class="title">Windows驱动开发入门-WFP过滤平台</div></div></a></div><div><a href="/2024/05/14/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E5%BA%94%E7%94%A8%E4%B8%8E%E5%86%85%E6%A0%B8%E9%80%9A%E4%BF%A1/" title="Windows驱动开发入门-应用与内核通信"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-14</div><div class="title">Windows驱动开发入门-应用与内核通信</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">Windows系统安全爱好者</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">330</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://monoceros406.github.io/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">哪里排版出锅了请告诉我QwQ  QQ:1295625063</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-NDIS%E5%8D%8F%E8%AE%AE%E9%A9%B1%E5%8A%A8%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">Windows驱动开发入门-NDIS协议驱动源码</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/15/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E6%97%B6%E9%97%B4/" title="Linux编程入门-时间">Linux编程入门-时间</a><time datetime="2025-06-15T12:50:21.000Z" title="发表于 2025-06-15 20:50:21">2025-06-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/15/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E4%B8%8E%E5%AE%89%E5%85%A8/" title="Linux编程入门-用户管理与安全">Linux编程入门-用户管理与安全</a><time datetime="2025-06-15T02:58:13.000Z" title="发表于 2025-06-15 10:58:13">2025-06-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/15/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" title="Linux编程入门-内存管理">Linux编程入门-内存管理</a><time datetime="2025-06-15T01:00:35.000Z" title="发表于 2025-06-15 09:00:35">2025-06-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/14/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E8%BF%9B%E7%A8%8B/" title="Linux编程入门-进程">Linux编程入门-进程</a><time datetime="2025-06-14T14:02:30.000Z" title="发表于 2025-06-14 22:02:30">2025-06-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/08/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6I-O/" title="Linux编程入门-文件I/O">Linux编程入门-文件I/O</a><time datetime="2025-06-08T00:27:36.000Z" title="发表于 2025-06-08 08:27:36">2025-06-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>