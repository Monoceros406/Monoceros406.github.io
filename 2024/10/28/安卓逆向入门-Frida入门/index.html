<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>安卓逆向入门-Frida入门 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="安卓逆向入门-Frida入门环境准备12345678910pip install frida frida-tools objection frida-dexdump jnitrace#objection需要安装比frida晚的版本 有必要时自己指定一下版本号 frida应为14.2.18及之前版本frida --version #根据版本去Github下载相应frida-serveradb pus">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓逆向入门-Frida入门">
<meta property="og:url" content="https://monoceros406.github.io/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Frida%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="安卓逆向入门-Frida入门环境准备12345678910pip install frida frida-tools objection frida-dexdump jnitrace#objection需要安装比frida晚的版本 有必要时自己指定一下版本号 frida应为14.2.18及之前版本frida --version #根据版本去Github下载相应frida-serveradb pus">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://monoceros406.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-10-28T11:01:16.000Z">
<meta property="article:modified_time" content="2024-11-28T02:33:40.941Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="移动安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://monoceros406.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://monoceros406.github.io/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Frida%E5%85%A5%E9%97%A8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '安卓逆向入门-Frida入门',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-28 10:33:40'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="The Blog of Monoceros406" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">309</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">安卓逆向入门-Frida入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-28T11:01:16.000Z" title="发表于 2024-10-28 19:01:16">2024-10-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-28T02:33:40.941Z" title="更新于 2024-11-28 10:33:40">2024-11-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="安卓逆向入门-Frida入门"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="安卓逆向入门-Frida入门"><a href="#安卓逆向入门-Frida入门" class="headerlink" title="安卓逆向入门-Frida入门"></a>安卓逆向入门-Frida入门</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pip install frida frida-tools objection frida-dexdump jnitrace<span class="comment">#objection需要安装比frida晚的版本 有必要时自己指定一下版本号 frida应为14.2.18及之前版本</span></span><br><span class="line">frida --version <span class="comment">#根据版本去Github下载相应frida-server</span></span><br><span class="line">adb push ./frida-server-16.3.3-android-x86_64 /data/local/tmp</span><br><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line"><span class="built_in">cd</span> /data/local/tmp</span><br><span class="line"><span class="built_in">mv</span> ./frida-server-16.3.3-android-x86_64 ./frida-server</span><br><span class="line"><span class="built_in">chmod</span> 777 ./frida-server</span><br><span class="line">./frida-server <span class="comment">#运行不了则尝试setenforce 0关闭SELinux</span></span><br><span class="line">frida-ps -U <span class="comment">#另开一个终端</span></span><br></pre></td></tr></table></figure>

<p>对于Objection 1.11.0的打开\Lib\site-packages\objection\commands\frida_commands.py，注释掉第38行<code>(&#39;Script Filename&#39;, frida_env[&#39;filename&#39;]),</code>。</p>
<p>下载<a target="_blank" rel="noopener" href="https://github.com/hluwa/Wallbreaker">https://github.com/hluwa/Wallbreaker</a> ，随便找个地方放着。</p>
<p>若为Objection 1.11.0，可打开Python\Lib\site-packages\objection\agent.js，修改第18753行如下，这样使用命令<code>android hooking watch class</code>后可对类中所有函数进行Hook，包括改之前不支持的构造函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// start a new job container</span></span><br><span class="line"><span class="keyword">const</span> job = &#123;</span><br><span class="line">    <span class="attr">identifier</span>: jobs_1.<span class="property">jobs</span>.<span class="title function_">identifier</span>(),</span><br><span class="line">    <span class="attr">implementations</span>: [],</span><br><span class="line">    <span class="attr">type</span>: <span class="string">`watch-class for: <span class="subst">$&#123;clazz&#125;</span>`</span>,</span><br><span class="line">&#125;;</span><br><span class="line">uniqueMethods.<span class="title function_">concat</span>([<span class="string">&quot;$init&quot;</span>]).<span class="title function_">forEach</span>(<span class="function">(<span class="params">method</span>) =&gt;</span> &#123; <span class="comment">//这里</span></span><br><span class="line">    clazzInstance[method].<span class="property">overloads</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// get the argument types for this overload</span></span><br><span class="line">        <span class="keyword">const</span> calleeArgTypes = m.<span class="property">argumentTypes</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">arg</span>) =&gt;</span> arg.<span class="property">className</span>);</span><br><span class="line">        <span class="title function_">send</span>(<span class="string">`Hooking <span class="subst">$&#123;color_1.colors.green(clazz)&#125;</span>.<span class="subst">$&#123;color_1.colors.greenBright(method)&#125;</span>(<span class="subst">$&#123;color_1.colors.red(calleeArgTypes.join(<span class="string">&quot;, &quot;</span>))&#125;</span>)`</span>);</span><br><span class="line">        <span class="comment">// replace the implementation of this method</span></span><br><span class="line">        <span class="comment">// tslint:disable-next-line:only-arrow-functions</span></span><br><span class="line">        m.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title function_">send</span>(color_1.<span class="property">colors</span>.<span class="title function_">blackBright</span>(<span class="string">`[<span class="subst">$&#123;job.identifier&#125;</span>] `</span>) +</span><br><span class="line">                <span class="string">`Called <span class="subst">$&#123;color_1.colors.green(clazz)&#125;</span>.<span class="subst">$&#123;color_1.colors.greenBright(m.methodName)&#125;</span>(<span class="subst">$&#123;color_1.colors.red(calleeArgTypes.join(<span class="string">&quot;, &quot;</span>))&#125;</span>)`</span>);</span><br><span class="line">            <span class="comment">// actually run the intended method</span></span><br><span class="line">            <span class="keyword">return</span> m.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// record this implementation override for the job</span></span><br><span class="line">        job.<span class="property">implementations</span>.<span class="title function_">push</span>(m);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><p>例如工程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myapplication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.DialogInterface;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.app.AlertDialog;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Button button=findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span>&#123;</span><br><span class="line">                AlertDialog.Builder alterDialog=<span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">                alterDialog.setTitle(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                alterDialog.setMessage(getString());</span><br><span class="line">                alterDialog.setPositiveButton(<span class="string">&quot;确定&quot;</span>,<span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener()&#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog,<span class="type">int</span> which)</span>&#123;&#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                alterDialog.setNegativeButton(<span class="string">&quot;取消&quot;</span>,<span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener()&#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog,<span class="type">int</span> which)</span>&#123;&#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                alterDialog.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;正常输出&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>布局文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;click&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此时Hook“正常输出”改为“应用已被Hook”。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title function_">send</span>(<span class="string">&quot;starting script&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Activity</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.myapplication.MainActivity&quot;</span>);</span><br><span class="line">        <span class="title class_">Activity</span>.<span class="property">getString</span>.<span class="title function_">overload</span>().<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result=<span class="variable language_">this</span>.<span class="title function_">getString</span>();</span><br><span class="line">            <span class="title function_">send</span>(<span class="string">&quot;getString=&quot;</span>+result);</span><br><span class="line">            <span class="keyword">var</span> newResult=<span class="string">&quot;应用已被Hook!&quot;</span>;</span><br><span class="line">            <span class="title function_">send</span>(newResult);</span><br><span class="line">            <span class="keyword">return</span> newResult;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>先启动APP，再用运行方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l ./frida_hook.js -f com.example.myapplication</span><br></pre></td></tr></table></figure>

<p>还可以把JavaScript写成Python脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida,sys</span><br><span class="line">device=frida.get_usb_device()</span><br><span class="line">session=device.attach(<span class="string">&quot;My Application&quot;</span>)</span><br><span class="line">front_app=device.get_frontmost_application()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;正在运行的应用为：&quot;</span>,front_app)</span><br><span class="line">src=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">setImmediate(function()&#123;</span></span><br><span class="line"><span class="string">    Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">        send(&quot;starting script&quot;);</span></span><br><span class="line"><span class="string">        var Activity=Java.use(&quot;com.example.myapplication.MainActivity&quot;);</span></span><br><span class="line"><span class="string">        Activity.getString.overload().implementation=function()&#123;</span></span><br><span class="line"><span class="string">            var result=this.getString();</span></span><br><span class="line"><span class="string">            send(&quot;getString=&quot;+result);</span></span><br><span class="line"><span class="string">            var newResult=&quot;应用已被Hook!&quot;;</span></span><br><span class="line"><span class="string">            send(newResult);</span></span><br><span class="line"><span class="string">            return newResult;</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message,data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>]==<span class="string">&quot;send&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+]&#123;&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&quot;payload&quot;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-]&#123;&#125;&quot;</span>.<span class="built_in">format</span>(message))</span><br><span class="line">script=session.create_script(src)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>,on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><p>常用命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -U <span class="comment">#查询USB连接设备上进程信息</span></span><br><span class="line">frida-ps -Ua <span class="comment">#显示USB连接设备上活跃的进程信息</span></span><br><span class="line">frida-ps -Uai <span class="comment">#显示USB连接是被上安装的应用信息</span></span><br><span class="line">frida-ls-devices <span class="comment">#列出附加设备</span></span><br><span class="line">frida-discover -n &lt;进程名&gt; <span class="comment">#发现程序内部函数</span></span><br><span class="line">frida-discover -p &lt;进程PID&gt;</span><br><span class="line">frida-trace -i <span class="string">&quot;recv*&quot;</span> -i <span class="string">&quot;send*&quot;</span> &lt;进程名&gt; <span class="comment">#跟踪进程中recv*和send*的API调用</span></span><br><span class="line">frida-trace -m <span class="string">&quot;Objc&quot;</span> &lt;进程名&gt; <span class="comment">#应用程序中跟踪Objc方法的调用</span></span><br><span class="line">frida-trace -U -f &lt;进程名&gt; -I <span class="string">&quot;call&quot;</span> <span class="comment">#打开引用程序并跟踪call函数调用</span></span><br><span class="line">frida-trace -U -i <span class="string">&quot;Java_*&quot;</span> &lt;进程名&gt; <span class="comment">#指定应用中跟踪所有JNI函数调用</span></span><br><span class="line">frida-kill -D &lt;设备ID&gt; &lt;进程ID&gt;</span><br></pre></td></tr></table></figure>

<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>例如Hook foo.so中的<code>strncmp</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida,sys</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message,data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>]==<span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*]&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">jscode=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Java.perform(function()&#123;</span></span><br><span class="line"><span class="string">    console.log(&quot;[*]Hooking calls to System.exit&quot;);</span></span><br><span class="line"><span class="string">    const exitClass=Java.use(&quot;java.lang.System&quot;);</span></span><br><span class="line"><span class="string">    exitClass.exit.implementation=function()&#123;</span></span><br><span class="line"><span class="string">        console.log(&quot;[*]System.exit called&quot;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var strncmp=undefined;</span></span><br><span class="line"><span class="string">    var imports=Module.enumerateImportsSync(&quot;libfoo.so&quot;);</span></span><br><span class="line"><span class="string">    for(var i=0;i&lt;imports.length;i++)&#123;</span></span><br><span class="line"><span class="string">        if(imports[i].name==&quot;strncmp&quot;)&#123;</span></span><br><span class="line"><span class="string">            strncmp=imports[i].address;</span></span><br><span class="line"><span class="string">            break;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    Interceptor.attach(strncmp,&#123;</span></span><br><span class="line"><span class="string">        onEnter:function(args)&#123;</span></span><br><span class="line"><span class="string">            if(Memory.readUtf8String(args[0],23)==&quot;01234567890123456789012&quot;)&#123;</span></span><br><span class="line"><span class="string">                console.log(&quot;[*]Secret string at&quot;+args[1]+&quot;:&quot;+Memory.readUtf8String(args[1],23));</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    console.log(&quot;[*]Intercepting strncmp&quot;);</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">process=frida.get_usb_device().attach(<span class="string">&quot;owasp.mstg.uncrackable2&quot;</span>)</span><br><span class="line">script=process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>,on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>通过以下命令获取当前显示页面的Activity所在类：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys activity | grep <span class="string">&quot;mResume&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><p>框架：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Script loaded successfully&quot;</span>)</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Inside java perform function&quot;</span>)</span><br><span class="line">        <span class="comment">//Frida主代码</span></span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MainActivity</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.roysue.demo02.MainActivity&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">lo</span>(<span class="string">&quot;Java.Use.Successfully!&quot;</span>) <span class="comment">//定位类成功</span></span><br><span class="line">        <span class="title class_">MainActivity</span>.<span class="property">fun</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">x,y</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;x=&gt;&quot;</span>,x,<span class="string">&quot;y=&gt;&quot;</span>,y)</span><br><span class="line">            <span class="keyword">var</span> ret_value=<span class="variable language_">this</span>.<span class="title function_">fun</span>(x,y);</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main) <span class="comment">//立即执行main</span></span><br></pre></td></tr></table></figure>

<p>当fun函数有重载时，可以在第7行指定函数签名，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MainActivity</span>.<span class="property">fun</span>.<span class="title function_">overload</span>(<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span></span><br><span class="line"><span class="title class_">MainActivity</span>.<span class="property">fun</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span></span><br></pre></td></tr></table></figure>

<p>Java类的函数分为类函数和实例方法。类函数用static修饰，和对应类绑定，若类函数被public修饰，则外部可直接通过类调用。实例方法没有static，需要创建对应类的实例再通过该实例调用，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类函数</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MainActivity</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)</span><br><span class="line"><span class="title class_">MainActivity</span>.<span class="title function_">staticSecret</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">//实例方法</span></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>,&#123;</span><br><span class="line">    <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;instance found,total value=&#x27;</span>,instance.<span class="property">total</span>.<span class="property">value</span>)</span><br><span class="line">        instance.<span class="title function_">secret</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;search Complete&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>例如不打算立即执行，可以将main函数改为其他函数名，分别写成函数后在Javascript代码最后进行导出：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpc.<span class="property">exports</span>=&#123;</span><br><span class="line">    <span class="attr">callsecretfunc</span>:<span class="title class_">CallSecretFunc</span>, <span class="comment">//将CallSecretFunc导出为callsecretfunc函数 导出函数名不能有大写字母或下划线</span></span><br><span class="line">    <span class="attr">gettotalvalue</span>:getTotalValue</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后用RPC模式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida,sys</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message,data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>]==<span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*]&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">device=frida.get_usb_device()</span><br><span class="line">process=device.attach(<span class="string">&#x27;com.roysue.demo02&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;4.js&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    jscode=f.read()</span><br><span class="line">script=process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>,on_message)</span><br><span class="line">script.load()</span><br><span class="line"><span class="comment">#...</span></span><br><span class="line">script.exports.callsecretfunc()</span><br><span class="line">script.exports.gettotalvalue()</span><br></pre></td></tr></table></figure>

<h2 id="Objection初探"><a href="#Objection初探" class="headerlink" title="Objection初探"></a>Objection初探</h2><p>Objection有仨部分。第一部分为Objection重打包相关组件，将Frida运行所需frida-gadget.so重打包进App，完成Frida的无root调试。第二部分为Objection本身，和frida-gadget.so交互，运行并分析Frida的Hook。第三部分为Objection从TypeScript项目编译来的agent.js，后者在App运行中插入Frida运行库，支持Objection各功能。</p>
<p>打开“设置”，用Objection注入“设置”应用，并用explore命令进入REPL模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先启动frida-server</span></span><br><span class="line">adb shell dumpsys activity activity top</span><br><span class="line">objection -g com.android.settings explore</span><br></pre></td></tr></table></figure>

<p>REPL模式常用命令有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">help env #展示env命令帮助</span><br><span class="line">jobs list #查看作业相关信息</span><br><span class="line">frida #查看Frida相关信息</span><br><span class="line">android hooking list classes #列出内存中所有类 实用但输出量大 去找历史记录C:\Users\Administrator\.objection</span><br><span class="line">android hooking search classes XXX #内存中搜索包含XXX关键词的类</span><br><span class="line">android hooking search methods XXX #内存中搜索包含XXX关键词的方法</span><br><span class="line">android hooking list class_methods XXX.XXX.XXX.XXX #列出某类所有方法</span><br><span class="line">android hooking list activities #列出当前注入的进程的所有activity</span><br><span class="line">android hooking list services #列出进程所有service 还可改为receivers和providers</span><br><span class="line">android hooking list receivers</span><br><span class="line">android intent launch_activity &lt;Activity类&gt; #启动指定Activity组件</span><br><span class="line">android intent launch_service &lt;Service类&gt;</span><br><span class="line">android hooking watch class &lt;类名&gt;</span><br><span class="line">android hooking watch class_method 方法名 --dump-args --dump-backtrace --dump-return #对指定方法Hook 方法名如java.io.File.$init</span><br><span class="line">android hooking set return_value &lt;类名&gt; false #设置返回值 只支持bool型</span><br><span class="line">android hooking generate simple &lt;类名&gt; #生成Frida的Hook代码</span><br><span class="line">search instances search instances &lt;类名&gt; #搜索指定类的实例 获取实例ID</span><br><span class="line">android heap search instances 类名 #搜索某类的实例</span><br><span class="line">android heap execute 哈希码 方法名 #调用无参数实例方法</span><br><span class="line">android heap evaluate 哈希码 #针对哈希码编写脚本 调用带参实例方法</span><br><span class="line">android sslpinning disable</span><br><span class="line">memory list modules #枚举当前进程模块</span><br><span class="line">memory list exports &lt;库名&gt; #查看指定模块导出函数</span><br><span class="line">memroy list exports &lt;库名&gt; --json result.json</span><br><span class="line">memory search --string --offsets-only</span><br><span class="line">android root disable #对抗root检测</span><br><span class="line">android root simulate #模拟root环境</span><br><span class="line">android ui screenshot &lt;文件名.png&gt;</span><br><span class="line">android shell_exec &lt;命令&gt;</span><br></pre></td></tr></table></figure>

<p>上述命令<code>android hooking list classes</code>比较实用但输出量大，运行后去找历史记录C:\Users\Administrator.objection\objection.log。Visual Studio Code上用Alt+Shift+鼠标进行块状选中，可编写-c选项REPL批处理脚本。</p>
<p>Hook实战例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (samsung: 9) [usb] # android hooking watch class_method java.io.File.$init --dump-args --dump-b</span><br><span class="line">acktrace --dump-return</span><br><span class="line">(agent) Attempting to watch class java.io.File and method $init.</span><br><span class="line">(agent) Hooking java.io.File.$init(java.io.File, java.lang.String)</span><br><span class="line">(agent) Hooking java.io.File.$init(java.lang.String)</span><br><span class="line">(agent) Hooking java.io.File.$init(java.lang.String, int)</span><br><span class="line">(agent) Hooking java.io.File.$init(java.lang.String, java.io.File)</span><br><span class="line">(agent) Hooking java.io.File.$init(java.lang.String, java.lang.String)</span><br><span class="line">(agent) Hooking java.io.File.$init(java.net.URI)</span><br><span class="line">(agent) Registering job 456383. Type: watch-method for: java.io.File.$init</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # jobs list</span><br><span class="line">Job ID  Hooks  Type</span><br><span class="line">------  -----  ------------------------------------</span><br><span class="line">456383      6  watch-method for: java.io.File.$init</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # </span><br><span class="line">// 这里随便点进“设置”一个选项</span><br><span class="line">(agent) [456383] Called java.io.File.File(java.lang.String)</span><br><span class="line">(agent) [456383] Backtrace:</span><br><span class="line">        java.io.File.&lt;init&gt;(Native Method)</span><br><span class="line">        android.content.res.XResources.isFirstLoad(XResources.java:120)</span><br><span class="line">        de.robv.android.xposed.XposedInit.cloneToXResources(XposedInit.java:282)</span><br><span class="line">        de.robv.android.xposed.XposedInit.access$000(XposedInit.java:60)</span><br><span class="line">        de.robv.android.xposed.XposedInit$2.afterHookedMethod(XposedInit.java:145)</span><br><span class="line">        de.robv.android.xposed.XC_MethodHook.callAfterHookedMethod(XC_MethodHook.java:68)</span><br><span class="line">        EdHooker_.hook(Unknown Source:175)</span><br><span class="line">        android.app.ResourcesManager.createBaseActivityResources(ResourcesManager.java:733)</span><br><span class="line">        android.app.ContextImpl.createActivityContext(ContextImpl.java:2384)</span><br><span class="line">        android.app.ActivityThread.createBaseContextForActivity(ActivityThread.java:3043)</span><br><span class="line">        android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2872)</span><br><span class="line">        android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3093)</span><br><span class="line">        android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78)</span><br><span class="line">        android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108)</span><br><span class="line">        android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68)</span><br><span class="line">        android.app.ActivityThread$H.handleMessage(ActivityThread.java:1823)</span><br><span class="line">        android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">        android.os.Looper.loop(Looper.java:193)</span><br><span class="line">        android.app.ActivityThread.main(ActivityThread.java:6840)</span><br><span class="line">        java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">        com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493)</span><br><span class="line">        com.android.internal.os.ZygoteInit.main(ZygoteInit.java:860)</span><br><span class="line"></span><br><span class="line">(agent) [456383] Arguments java.io.File.File(/system/priv-app/Settings/Settings.apk)</span><br><span class="line">(agent) [456383] Return Value: (none)</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # jobs kill 456383</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # jobs list</span><br><span class="line">Job ID  Hooks  Type</span><br><span class="line">------  -----  ----</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # android hooking watch class java.io.File</span><br><span class="line">(agent) Hooking java.io.File.createTempFile(java.lang.String, java.lang.String)</span><br><span class="line">(agent) Hooking java.io.File.createTempFile(java.lang.String, java.lang.String, java.io.File)</span><br><span class="line">(agent) Hooking java.io.File.listRoots()</span><br><span class="line">(agent) Hooking java.io.File.readObject(java.io.ObjectInputStream)</span><br><span class="line">(agent) Hooking java.io.File.slashify(java.lang.String, boolean)</span><br><span class="line">(agent) Hooking java.io.File.writeObject(java.io.ObjectOutputStream)</span><br><span class="line">(agent) Hooking java.io.File.canExecute()</span><br><span class="line">(agent) Hooking java.io.File.canRead()</span><br><span class="line">(agent) Hooking java.io.File.canWrite()</span><br><span class="line">(agent) Hooking java.io.File.compareTo(java.io.File)</span><br><span class="line">(agent) Hooking java.io.File.compareTo(java.lang.Object)</span><br><span class="line">(agent) Hooking java.io.File.createNewFile()</span><br><span class="line">(agent) Hooking java.io.File.delete()</span><br><span class="line">(agent) Hooking java.io.File.deleteOnExit()</span><br><span class="line">(agent) Hooking java.io.File.equals(java.lang.Object)</span><br><span class="line">(agent) Hooking java.io.File.exists()</span><br><span class="line">(agent) Hooking java.io.File.getAbsoluteFile()</span><br><span class="line">(agent) Hooking java.io.File.getAbsolutePath()</span><br><span class="line">(agent) Hooking java.io.File.getCanonicalFile()</span><br><span class="line">(agent) Hooking java.io.File.getCanonicalPath()</span><br><span class="line">(agent) Hooking java.io.File.getFreeSpace()</span><br><span class="line">(agent) Hooking java.io.File.getName()</span><br><span class="line">(agent) Hooking java.io.File.getParent()</span><br><span class="line">(agent) Hooking java.io.File.getParentFile()</span><br><span class="line">(agent) Hooking java.io.File.getPath()</span><br><span class="line">(agent) Hooking java.io.File.getPrefixLength()</span><br><span class="line">(agent) Hooking java.io.File.getTotalSpace()</span><br><span class="line">(agent) Hooking java.io.File.getUsableSpace()</span><br><span class="line">(agent) Hooking java.io.File.hashCode()</span><br><span class="line">(agent) Hooking java.io.File.isAbsolute()</span><br><span class="line">(agent) Hooking java.io.File.isDirectory()</span><br><span class="line">(agent) Hooking java.io.File.isFile()</span><br><span class="line">(agent) Hooking java.io.File.isHidden()</span><br><span class="line">(agent) Hooking java.io.File.isInvalid()</span><br><span class="line">(agent) Hooking java.io.File.lastModified()</span><br><span class="line">(agent) Hooking java.io.File.length()</span><br><span class="line">(agent) Hooking java.io.File.list()</span><br><span class="line">(agent) Hooking java.io.File.list(java.io.FilenameFilter)</span><br><span class="line">(agent) Hooking java.io.File.listFiles()</span><br><span class="line">(agent) Hooking java.io.File.listFiles(java.io.FileFilter)</span><br><span class="line">(agent) Hooking java.io.File.listFiles(java.io.FilenameFilter)</span><br><span class="line">(agent) Hooking java.io.File.mkdir()</span><br><span class="line">(agent) Hooking java.io.File.mkdirs()</span><br><span class="line">(agent) Hooking java.io.File.renameTo(java.io.File)</span><br><span class="line">(agent) Hooking java.io.File.setExecutable(boolean)</span><br><span class="line">(agent) Hooking java.io.File.setExecutable(boolean, boolean)</span><br><span class="line">(agent) Hooking java.io.File.setLastModified(long)</span><br><span class="line">(agent) Hooking java.io.File.setReadOnly()</span><br><span class="line">(agent) Hooking java.io.File.setReadable(boolean)</span><br><span class="line">(agent) Hooking java.io.File.setReadable(boolean, boolean)</span><br><span class="line">(agent) Hooking java.io.File.setWritable(boolean)</span><br><span class="line">(agent) Hooking java.io.File.setWritable(boolean, boolean)</span><br><span class="line">(agent) Hooking java.io.File.toPath()</span><br><span class="line">(agent) Hooking java.io.File.toString()</span><br><span class="line">(agent) Hooking java.io.File.toURI()</span><br><span class="line">(agent) Hooking java.io.File.toURL()</span><br><span class="line">(agent) Registering job 388472. Type: watch-class for: java.io.File</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # jobs list</span><br><span class="line">Job ID  Hooks  Type</span><br><span class="line">------  -----  -----------------------------</span><br><span class="line">388472     56  watch-class for: java.io.File</span><br><span class="line">// 这里随便点进“设置”一个选项</span><br><span class="line">(agent) [388472] Called java.io.File.exists()</span><br><span class="line">(agent) [388472] Called java.io.File.getPath()</span><br><span class="line">(agent) [388472] Called java.io.File.equals(java.lang.Object)</span><br><span class="line">(agent) [388472] Called java.io.File.compareTo(java.io.File)</span><br><span class="line">(agent) [388472] Called java.io.File.getPath()</span><br><span class="line">(agent) [388472] Called java.io.File.getPath()</span><br><span class="line">(agent) [388472] Called java.io.File.equals(java.lang.Object)</span><br><span class="line">(agent) [388472] Called java.io.File.compareTo(java.io.File)</span><br><span class="line">(agent) [388472] Called java.io.File.getPath()</span><br><span class="line">(agent) [388472] Called java.io.File.getPath()</span><br><span class="line">(agent) [388472] Called java.io.File.lastModified()</span><br></pre></td></tr></table></figure>

<p>主动调用实战例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (samsung: 9) [usb] # android heap search instances java.io.File</span><br><span class="line">Class instance enumeration complete for java.io.File</span><br><span class="line">   Hashcode  Class         toString()</span><br><span class="line">-----------  ------------  --------------------------------------------------------------</span><br><span class="line">  133688275  java.io.File  /system/priv-app/Settings/Settings.apk</span><br><span class="line">   47718804  java.io.File  /proc</span><br><span class="line">  137635794  java.io.File  /sys/fs/bpf/traffic_uid_stats_map</span><br><span class="line">-1320040561  java.io.File  /proc/net/xt_qtaguid/iface_stat_all</span><br><span class="line">-1320030053  java.io.File  /proc/net/xt_qtaguid/iface_stat_fmt</span><br><span class="line">-1877617375  java.io.File  /proc/net/xt_qtaguid/stats</span><br><span class="line"> 2048048455  java.io.File  /sys/board_properties/soc/msv</span><br><span class="line">  -54300376  java.io.File  /data/misc/user/0</span><br><span class="line">  -48471265  java.io.File  /data/misc/user/0/cacerts-added</span><br><span class="line"> 2041518079  java.io.File  /data/misc/user/0/cacerts-removed</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line">  114250896  java.io.File  /data/user_de/0/com.android.settings/code_cache</span><br><span class="line">  958541197  java.io.File  /data/user/0/com.android.settings</span><br><span class="line">-1227050545  java.io.File  /data/user_de/0/com.android.settings</span><br><span class="line">-1227050545  java.io.File  /data/user_de/0/com.android.settings</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> 1645413532  java.io.File  /data/user_de/0/com.android.settings/files/condition_state.xml</span><br><span class="line">    1234366  java.io.File  /</span><br><span class="line">-1782362368  java.io.File  /data/user_de/0/com.android.settings/cache</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> 2097462291  java.io.File  /system/priv-app/Settings/lib/x86_64</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line">-1714625846  java.io.File  /system/framework/eddexmaker.jar</span><br><span class="line"> 1190786266  java.io.File  /system/framework/eddalvikdx.jar</span><br><span class="line"> -594014569  java.io.File  /system/framework/edxp.jar</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line">-1782362368  java.io.File  /data/user_de/0/com.android.settings/cache</span><br><span class="line">-1779601385  java.io.File  /data/user_de/0/com.android.settings/files</span><br><span class="line">-1782362368  java.io.File  /data/user_de/0/com.android.settings/cache</span><br><span class="line"> 1433727619  java.io.File  /system/framework/org.apache.http.legacy.boot.jar</span><br><span class="line">  133688275  java.io.File  /system/priv-app/Settings/Settings.apk</span><br><span class="line">-1975059403  java.io.File  /data/misc/keychain/cacerts-added</span><br><span class="line"> -882893419  java.io.File  /data/misc/keychain/cacerts-removed</span><br><span class="line"> 1173056351  java.io.File  /system/etc/security/cacerts</span><br><span class="line"> -853728249  java.io.File  /system/etc/security/ct_known_logs</span><br><span class="line">-2013037938  java.io.File  /data/misc/keychain/trusted_ct_logs/current</span><br><span class="line">   47683016  java.io.File  /data</span><br><span class="line">-1978853580  java.io.File  /mnt/expand</span><br><span class="line">-2123135345  java.io.File  /system</span><br><span class="line">-1575638275  java.io.File  /storage</span><br><span class="line"> 1671863261  java.io.File  /data/cache</span><br><span class="line">     384824  java.io.File  /odm</span><br><span class="line">     384857  java.io.File  /oem</span><br><span class="line">    -533391  java.io.File  /product</span><br><span class="line">-2056170586  java.io.File  /vendor</span><br><span class="line">-1119854388  java.io.File  /cache/recovery/block.map</span><br><span class="line"> -702818824  java.io.File  /system/etc/security/otacerts.zip</span><br><span class="line">-1577688767  java.io.File  /cache/recovery/last_install</span><br><span class="line"> 1902719031  java.io.File  /cache/recovery/log</span><br><span class="line">  405131488  java.io.File  /cache/recovery</span><br><span class="line">  301269365  java.io.File  /cache/recovery/uncrypt_file</span><br><span class="line"> 1310302411  java.io.File  /cache/recovery/uncrypt_status</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> -895673764  java.io.File  /system/vendor/lib64</span><br><span class="line"> 1664757827  java.io.File  /system/lib64</span><br><span class="line">    1234367  java.io.File  .</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # android heap execute 133688275 getPath</span><br><span class="line">Found 2 handles, this is probably a bug, please report it!</span><br><span class="line">Handle 133688275 is to class</span><br><span class="line">        java.io.File</span><br><span class="line">Executing method: getPath()</span><br><span class="line">/system/priv-app/Settings/Settings.apk</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # android heap evaluate 133688275</span><br><span class="line">(The hashcode at `133688275` will be available as the `clazz` variable.)</span><br><span class="line">console.log(&#x27;File is canWrite? =&gt;&#x27;,clazz.canWrite()) //clazz为该File类</span><br><span class="line">clazz.setWritable(false)</span><br><span class="line">console.log(&#x27;File is canWrite? =&gt;&#x27;,clazz.canWrite())</span><br><span class="line">JavaScript capture complete. Evaluating...</span><br><span class="line">Found 2 handles, this is probably a bug, please report it!</span><br><span class="line">Handle 133688275 is to class</span><br><span class="line">        java.io.File</span><br><span class="line">File is canWrite? =&gt; false</span><br><span class="line">File is canWrite? =&gt; false</span><br></pre></td></tr></table></figure>

<p>SSL Pinning称为证书绑定。该方式不仅校验服务器证书是否是系统中可信凭证，通信过程中甚至连系统内置证书都不信任，而只信任指定证书。一旦发现服务器证书为非指定证书即停止通信，导致抓包软件安装到系统信任凭据中也无法生效。</p>
<p>Objection有自带SSL Pinning Bypass功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android sslpinning disable</span><br></pre></td></tr></table></figure>

<p>此外还有ZenTrace工具：<a target="_blank" rel="noopener" href="https://github.com/hluwa/ZenTracer">https://github.com/hluwa/ZenTracer</a> 。使用Match RegEx可添加类的过滤，例如“M:com.cz.babySister”表示Hook，“B:com.cz.babySister”表示不过滤。Start后，ZenTracer对前台证显示的应用所有符合匹配规则的目标类进行Hook，上方显示参数和返回值信息。还可导出为JSON。</p>
<h2 id="逆向工作思路"><a href="#逆向工作思路" class="headerlink" title="逆向工作思路"></a>逆向工作思路</h2><p>找到当前正在运行的Activity：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys activity top</span><br></pre></td></tr></table></figure>

<p>objection注入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.example.junior explore</span><br></pre></td></tr></table></figure>

<p>找出所有Activity：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list activities</span><br></pre></td></tr></table></figure>

<p>找到目标Activity直接启动：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android intent launch_activity com.example.junior.CalculatorActivity</span><br></pre></td></tr></table></figure>

<p>列出该类中方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking list class_methods com.example.junior.CalculatorActivity</span><br></pre></td></tr></table></figure>

<p>对目标方法Hook：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class_method com.example.junior.CalculatorActivity.caculate --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure>

<p>用以下Frida脚本和Objection输出内容相同，但Frida和Objection不能同时Hook同一个方法，得先在Objection里删除该Job。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Arith</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.example.junior.util.Arith&#x27;</span>)</span><br><span class="line">        <span class="title class_">Arith</span>.<span class="property">sub</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>,<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">str1,str2</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> <span class="title class_">JavaString</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.String&#x27;</span>)</span><br><span class="line">            <span class="keyword">var</span> result=<span class="variable language_">this</span>.<span class="title function_">sub</span>(str,<span class="title class_">JavaString</span>.$new(<span class="string">&#x27;123&#x27;</span>)) <span class="comment">//看好目标函数签名</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;str,str2,result=&gt;&#x27;</span>,str,str2,result)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()))</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>主动调用方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">CallSub</span>(<span class="params">a,b</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Arith</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.example.junior.util.Arith&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">JavaString</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.String&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> result=<span class="title class_">Arith</span>.<span class="title function_">sub</span>(<span class="title class_">JavaString</span>.$new(a),<span class="title class_">JavaString</span>.$new(b))</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a,<span class="string">&quot;-&quot;</span>,b,<span class="string">&quot;=&quot;</span>,result)</span><br><span class="line">&#125;</span><br><span class="line">rpc.<span class="property">exports</span>=&#123;</span><br><span class="line">    <span class="attr">sub</span>:<span class="title class_">CallSub</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编写利用脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida,sys</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message,data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>]==<span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*]&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line">device=frida.get_usb_device()</span><br><span class="line">process=device.attach(<span class="string">&#x27;com.example.junior&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;call.js&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    jscode=f.read()</span><br><span class="line">script=process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>,on_message)</span><br><span class="line">script.load()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">30</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">        script.exports.sub(<span class="built_in">str</span>(i),<span class="built_in">str</span>(j))</span><br></pre></td></tr></table></figure>

<p>想做到规模化就应使用Frida的网络模式，服务端运行为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./frida-server -l 0.0.0.0:8888 <span class="comment">#监听手机8888端口</span></span><br><span class="line">netstat --pantul | grep frida</span><br><span class="line">ifconfig <span class="comment">#例如本机为192.168.xxx.xxx</span></span><br></pre></td></tr></table></figure>

<p>进行远程注入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -N -h 192.168.xxx.xxx -p 8888 -g com.xxx.xxx explore</span><br></pre></td></tr></table></figure>

<p>利用脚本中改为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">device=frida.get_device_manager().add_remote_device(<span class="string">&#x27;192.168.xxx.xxx:8888&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h2><p>Wallbreaker是Objection的一个插件，下载后在Objection的REPL模式下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (samsung: 9) [usb] # plugin load D:\Wallbreaker</span><br><span class="line">Loaded plugin: wallbreaker</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # plugin wallbreaker objectsearch java.io.File #跟objection heap search功能一样</span><br><span class="line">[0x2e46]: /proc</span><br><span class="line">...</span><br><span class="line">com.android.settings on (samsung: 9) [usb] # plugin wallbreaker objectdump 0x2e46 #将某实例具体内容打印出来 后面为实例码</span><br><span class="line"></span><br><span class="line">package java.io</span><br><span class="line"></span><br><span class="line">class File &#123;</span><br><span class="line"></span><br><span class="line">        /* static fields */</span><br><span class="line">        static boolean $assertionsDisabled; =&gt; false</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        /* instance fields 重点在这里 观察该实例各成员的值*/</span><br><span class="line">        Path filePath; =&gt; null</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        /* constructor methods */</span><br><span class="line">        java.io.File(File, String);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        /* static methods */</span><br><span class="line">        static File createTempFile(String, String);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        /* instance methods */</span><br><span class="line">        void readObject(ObjectInputStream);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定位弹窗使用的类常见有android.app.AlertDialog、android.app.Dialog、android.widget.PopupWindow等，优先用这几个尝试objectsearch。</p>
<p>设置完Hook后，如果需要在App一运行后就挂载某Hook，可以实现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.xxx.xxx explore -s <span class="string">&quot;android hooking watch class xxx.xxx.xxx&quot;</span></span><br></pre></td></tr></table></figure>

<p>此外，-c命令为App一运行就要跑的REPL命令脚本，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.xxx.xxx explore -c <span class="string">&quot;*.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p>FRIDA-DEXDump为Objection的一个脱壳插件，暴力搜索内存中符合dex格式的数据完成dump。在CLI模式下可以：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frida-dexdump -FU <span class="comment">#dump前台应用</span></span><br><span class="line">frida-dexdump -U -f com.xxx.xxx <span class="comment">#spawn一个App来脱</span></span><br></pre></td></tr></table></figure>

<p>作为Objection插件使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plugin load D:\DEXDump</span><br><span class="line">plugin dexdump dump</span><br></pre></td></tr></table></figure>

<p>脱壳后会提示dump出来的.dex文件存储路径，按照文件从小到大分别改名为classes.dex、classes2.dex、classes3.dex、classes4.dex等，放到并替换原classes.dex目录下。在Jadx搜索找到<code>extends Application</code>的代码，反编译其目录下AndroidManifest.xml，把Application标签内android:name改为完整类名后，即可用apktool重新打包。</p>
<p>项目<a target="_blank" rel="noopener" href="https://github.com/WooyunDota/DroidSSLUnpinning/blob/master/ObjectionUnpinningPlus/hooks.js">https://github.com/WooyunDota/DroidSSLUnpinning/blob/master/ObjectionUnpinningPlus/hooks.js</a> 补充了一些Objection没有的SSL Pinning Bypass方式。</p>
<h2 id="抓包入门"><a href="#抓包入门" class="headerlink" title="抓包入门"></a>抓包入门</h2><p>网络通信相关框架有HttpURLConnection、okhttp、okhttp3等，其中okhttp和okhttp3完全不同。HttpURLConnection的原生库底层使用okhttp。</p>
<h3 id="HttpURLConnection"><a href="#HttpURLConnection" class="headerlink" title="HttpURLConnection"></a>HttpURLConnection</h3><p>一个基本的HttpURLConnection如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;https://www.baidu.com&quot;</span>);</span><br><span class="line">                        <span class="type">HttpURLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line">                        connection.setRequestMethod(<span class="string">&quot;GET&quot;</span>); <span class="comment">//请求方法</span></span><br><span class="line">                        connection.setRequestProperty(<span class="string">&quot;token&quot;</span>,<span class="string">&quot;r0ysue666&quot;</span>); <span class="comment">//请求参数</span></span><br><span class="line">                        connection.setConnectTimeout(<span class="number">8000</span>); <span class="comment">//连接超时时间</span></span><br><span class="line">                        connection.setReadTimeout(<span class="number">8000</span>); <span class="comment">//接收超时时间</span></span><br><span class="line">                        connection.connect(); <span class="comment">// 开始连接</span></span><br><span class="line">                        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> connection.getInputStream(); <span class="comment">//获取服务器返回的输入流</span></span><br><span class="line">                        <span class="comment">//if(in.available() &gt; 0)&#123;</span></span><br><span class="line">                        <span class="comment">// 每次写入1024字节</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">                        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[bufferSize];</span><br><span class="line">                        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">                        <span class="keyword">while</span> ((in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                            sb.append(<span class="keyword">new</span> <span class="title class_">String</span>(buffer));</span><br><span class="line">                        &#125;</span><br><span class="line">                        Log.d(<span class="string">&quot;r0ysue666&quot;</span>, sb.toString());</span><br><span class="line">                        connection.disconnect(); <span class="comment">//关闭连接</span></span><br><span class="line">                       <span class="comment">// &#125;</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在AndroidManifest.xml中加入网络权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一步先Hook整个URL类的构造函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class_method java.net.URL.$init --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure>

<p>自吐脚本为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">URL</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.URL&#x27;</span>)</span><br><span class="line">        <span class="variable constant_">URL</span>.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">urlset</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;url=&gt;&#x27;</span>,urlstr)</span><br><span class="line">            <span class="keyword">var</span> result=<span class="variable language_">this</span>.$init(urlstr)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>  下一步还可以Hook整个HttpURLConnection类所有函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class java.net.HttpURLConnection</span><br><span class="line">android hooking watch class_method java.net.HttpURLConnection.$init --dump-args --dump--backtrace --dump-return</span><br></pre></td></tr></table></figure>

<p>用WallBreaker搜索HttpURLConnection类实例，发现该类其实是个抽象类，但运行时是抽象类的具体实现类在工作。此时关注上述源码中构造该类的<code>openConnection</code>，对后者进行Hook：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable constant_">URL</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.URL&#x27;</span>)</span><br><span class="line">        <span class="variable constant_">URL</span>.<span class="property">openConnection</span>.<span class="title function_">overload</span>().<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result=<span class="variable language_">this</span>.<span class="title function_">openConnection</span>()</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;openConnection() returnType=&gt;&#x27;</span>,result.<span class="property">$className</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>返回值找到具体实现类为com.android.okhttp.internal.huc.HttpURLConnectionImpl类，尝试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class com.android.okhttp.internal.huc.HttpURLConnectionImpl</span><br></pre></td></tr></table></figure>

<p>Hook发现程序中每个函数都被调用到了，最终请求参数自吐脚本如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">HttpURLConnectionImpl</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.android.okhttp.internal.huc.HttpURLConnectionImpl&#x27;</span>)</span><br><span class="line">        <span class="title class_">HttpURLConnectionImpl</span>.<span class="property">setRequestProperty</span>.<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">key,value</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result=<span class="variable language_">this</span>.<span class="title function_">setRequestProperty</span>(key,value)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setRequestProperty=&gt;&#x27;</span>,key,<span class="string">&#x27;:&#x27;</span>,value)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h3 id="okhttp3"><a href="#okhttp3" class="headerlink" title="okhttp3"></a>okhttp3</h3><p>在app&#x2F;build.gradle中添加okhttp3的引用并Sync：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 增加对Okhttp3的依赖</span></span><br><span class="line">    implementation(<span class="string">&quot;com.squareup.okhttp3:okhttp:3.12.0&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中主界面如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.r0ysue.okhttp3demo;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;r0ysue666&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">// 定位发送请求按钮</span></span><br><span class="line">        <span class="type">Button</span> <span class="variable">btn</span> <span class="operator">=</span> findViewById(R.id.mybtn);</span><br><span class="line">        btn.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="comment">// 访问百度首页</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> <span class="string">&quot;https://www.baidu.com/&quot;</span>;</span><br><span class="line">                <span class="type">example</span> <span class="variable">myexample</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">example</span>(); <span class="comment">//example类自己实现</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    myexample.run(requestUrl);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于example类实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.r0ysue.okhttp3demo;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Call;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Callback;</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Response;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">example</span> &#123;</span><br><span class="line">    <span class="comment">// TAG即为日志打印时的标签</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;r0ysue666&quot;</span>;</span><br><span class="line">    <span class="comment">// 新建一个Okhttp客户端</span></span><br><span class="line">    <span class="comment">// OkHttpClient client = new OkHttpClient();</span></span><br><span class="line">    <span class="comment">// 新建一个拦截器</span></span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">                                       <span class="comment">// .addNetworkInterceptor(new LoggingInterceptor()) 添加拦截器 下面会讲</span></span><br><span class="line">                                       <span class="comment">// .readTimeout(5, TimeUnit.SECONDS) 读超时</span></span><br><span class="line">                                       <span class="comment">// .writeTimeout(5, TimeUnit.SECONDS) 写超时</span></span><br><span class="line">                                       <span class="comment">// .connectTimeout(15, TimeUnit.SECONDS) 连接超时</span></span><br><span class="line">                					   <span class="comment">// .retryOnConnectionFailure(true) 是否自动重连</span></span><br><span class="line">                                          .build();</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 构造request</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                                     .url(url)</span><br><span class="line">                                     .header(<span class="string">&quot;token&quot;</span>,<span class="string">&quot;r0ysue&quot;</span>) <span class="comment">//参数</span></span><br><span class="line">                                     .build();</span><br><span class="line">        <span class="comment">// 发起异步请求</span></span><br><span class="line">        client.newCall(request).enqueue( <span class="comment">//发起网络请求</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Callback</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call call, IOException e)</span> &#123;</span><br><span class="line">                        call.cancel();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException &#123; <span class="comment">//处理每次请求结果</span></span><br><span class="line">                        <span class="comment">//打印输出</span></span><br><span class="line">                        Log.d(TAG, response.body().string());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果单纯Hook上述<code>newCall</code>，可能存在Call后没有发出实际请求的情况，该函数实际调用了<code>RealCall.newRealCall</code>。RealCall对象是okhttp3.Call接口的唯一实现，表示一个等待执行的请求且只能被执行以此，到这一步请求仍可被取消。只有Hook了<code>execute</code>和<code>enqueue</code>才能真正保证每个从okhttp出去的请求都能被Hook到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> RealCall <span class="title function_">newRealCall</span><span class="params">(OkHttpClient client, Request originalRequest, <span class="type">boolean</span> forWebSocket)</span>&#123;</span><br><span class="line">    RealCall call=<span class="keyword">new</span> <span class="title class_">RealCall</span>(client,originalRequest,forWebSocket);</span><br><span class="line">    call.eventListener=client.eventListenerFactory().create(call);</span><br><span class="line">    <span class="keyword">return</span> call;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>okhttp3通过拦截器Interceptor完成监控管理、重写和重试请求。每个网络请求和接收都必须经过okhttp3本身存在的五大拦截器。拦截器可对request修改，数据返回时对response做出修改。拦截器机制实际上是一个链条，最上层拦截器首先向下传递一个request，请求下层拦截器返回一个response。传递到最后一个拦截器，它对该request进行处理并返回resposne。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Response <span class="title function_">getResponseWithInterceptorChain</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    List&lt;Interceptor&gt; interceptors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">//空拦截器容器</span></span><br><span class="line">    interceptors.addAll(client.interceptors()); <span class="comment">//用户自定义应用拦截器</span></span><br><span class="line">    interceptors.add(retryAndFollowUpInterceptor); <span class="comment">//重定向拦截器 用于取消、失败重试、重定向</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> <span class="title class_">BridgeInterceptor</span>(client.cookieJar())); <span class="comment">//桥接拦截器 把用户请求转为HTTP请求</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> <span class="title class_">CacheInterceptor</span>(client.internalCache())); <span class="comment">//缓存拦截器 用于读写缓存、根据策略决定是否使用</span></span><br><span class="line">    interceptors.add(<span class="keyword">new</span> <span class="title class_">ConnectInterceptor</span>(client)); <span class="comment">//连接拦截器 建立连接</span></span><br><span class="line">    <span class="keyword">if</span> (!forWebSocket) <span class="comment">//非WebSocket请求 则添加用户自定义网络拦截器</span></span><br><span class="line">        interceptors.addAll(client.networkInterceptors());</span><br><span class="line">    interceptors.add(<span class="keyword">new</span> <span class="title class_">CallServerInterceptor</span>(forWebSocket)); <span class="comment">//发起请求拦截器</span></span><br><span class="line">    Interceptor.<span class="type">Chain</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealInterceptorChain</span>(interceptors, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>, originalRequest, <span class="built_in">this</span>, eventListener, client.connectTimeoutMillis(), client.readTimeoutMillis(), client.writeTimeoutMillis());</span><br><span class="line">    <span class="keyword">return</span> chain.proceed(originalRequest);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这里演示新建一个拦截器类，打印URL和请求headers：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.r0ysue.okhttp3demo;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.EOFException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Connection;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Headers;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Interceptor;</span><br><span class="line"><span class="keyword">import</span> okhttp3.MediaType;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request;</span><br><span class="line"><span class="keyword">import</span> okhttp3.RequestBody;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Response;</span><br><span class="line"><span class="keyword">import</span> okhttp3.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> okhttp3.internal.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> okio.Buffer;</span><br><span class="line"><span class="keyword">import</span> okio.BufferedSource;</span><br><span class="line"><span class="keyword">import</span> okio.GzipSource;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggingInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;okhttpGET&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Charset</span> <span class="variable">UTF8</span> <span class="operator">=</span> Charset.forName(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> chain.request();</span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> request.body();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasRequestBody</span> <span class="operator">=</span> requestBody != <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> chain.connection();</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestStartMessage</span> <span class="operator">=</span> <span class="string">&quot;--&gt; &quot;</span> + request.method() + <span class="string">&#x27; &#x27;</span> + request.url();</span><br><span class="line">        Log.e(TAG, requestStartMessage);</span><br><span class="line">        <span class="keyword">if</span> (hasRequestBody) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requestBody.contentType() != <span class="literal">null</span>)</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Content-Type: &quot;</span> + requestBody.contentType());</span><br><span class="line">            <span class="keyword">if</span> (requestBody.contentLength() != -<span class="number">1</span>)</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Content-Length: &quot;</span> + requestBody.contentLength());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> request.headers();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, count = headers.size(); i &lt; count; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> headers.name(i);</span><br><span class="line">            <span class="comment">// Skip headers from the request body as they are explicitly logged above.</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;Content-Type&quot;</span>.equalsIgnoreCase(name) &amp;&amp; !<span class="string">&quot;Content-Length&quot;</span>.equalsIgnoreCase(name))</span><br><span class="line">                Log.e(TAG, name + <span class="string">&quot;: &quot;</span> + headers.value(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!hasRequestBody)</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;--&gt; END &quot;</span> + request.method());</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bodyHasUnknownEncoding(request.headers()))</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;--&gt; END &quot;</span> + request.method() + <span class="string">&quot; (encoded body omitted)&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Buffer</span>();</span><br><span class="line">            requestBody.writeTo(buffer);</span><br><span class="line">            <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> UTF8;</span><br><span class="line">            <span class="type">MediaType</span> <span class="variable">contentType</span> <span class="operator">=</span> requestBody.contentType();</span><br><span class="line">            <span class="keyword">if</span> (contentType != <span class="literal">null</span>)</span><br><span class="line">                charset = contentType.charset(UTF8);</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (isPlaintext(buffer)) &#123;</span><br><span class="line">                Log.e(TAG, buffer.readString(charset));</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;--&gt; END &quot;</span> + request.method() + <span class="string">&quot; (&quot;</span> + requestBody.contentLength() + <span class="string">&quot;-byte body)&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                Log.e(TAG, <span class="string">&quot;--&gt; END &quot;</span> + request.method() + <span class="string">&quot; (binary &quot;</span>  + requestBody.contentLength() + <span class="string">&quot;-byte body omitted)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startNs</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        Response response;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response = chain.proceed(request);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;&lt;-- HTTP FAILED: &quot;</span> + e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">tookMs</span> <span class="operator">=</span> TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startNs);</span><br><span class="line">        <span class="type">ResponseBody</span> <span class="variable">responseBody</span> <span class="operator">=</span> response.body();</span><br><span class="line">        <span class="type">long</span> <span class="variable">contentLength</span> <span class="operator">=</span> responseBody.contentLength();</span><br><span class="line">        <span class="type">String</span> <span class="variable">bodySize</span> <span class="operator">=</span> contentLength != -<span class="number">1</span> ? contentLength + <span class="string">&quot;-byte&quot;</span> : <span class="string">&quot;unknown-length&quot;</span>;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;&lt;-- &quot;</span> + response.code() + (response.message().isEmpty() ? <span class="string">&quot;&quot;</span> : <span class="string">&#x27; &#x27;</span> + response.message()) + <span class="string">&#x27; &#x27;</span> + response.request().url() + <span class="string">&quot; (&quot;</span> + tookMs + <span class="string">&quot;ms&quot;</span> + (<span class="string">&quot;, &quot;</span> + bodySize + <span class="string">&quot; body:&quot;</span> + <span class="string">&quot;&quot;</span>) + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">        <span class="type">Headers</span> <span class="variable">myheaders</span> <span class="operator">=</span> response.headers();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, count = myheaders.size(); i &lt; count; i++)</span><br><span class="line">            Log.e(TAG, myheaders.name(i) + <span class="string">&quot;: &quot;</span> + myheaders.value(i));</span><br><span class="line">        <span class="keyword">if</span> (!HttpHeaders.hasBody(response))</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;&lt;-- END HTTP&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (bodyHasUnknownEncoding(response.headers()))</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;&lt;-- END HTTP (encoded body omitted)&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">BufferedSource</span> <span class="variable">source</span> <span class="operator">=</span> responseBody.source();</span><br><span class="line">            source.request(Long.MAX_VALUE); <span class="comment">// Buffer the entire body.</span></span><br><span class="line">            <span class="type">Buffer</span> <span class="variable">buffer</span> <span class="operator">=</span> source.buffer();</span><br><span class="line">            <span class="type">Long</span> <span class="variable">gzippedLength</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;gzip&quot;</span>.equalsIgnoreCase(myheaders.get(<span class="string">&quot;Content-Encoding&quot;</span>))) &#123;</span><br><span class="line">                gzippedLength = buffer.size();</span><br><span class="line">                <span class="type">GzipSource</span> <span class="variable">gzippedResponseBody</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    gzippedResponseBody = <span class="keyword">new</span> <span class="title class_">GzipSource</span>(buffer.clone());</span><br><span class="line">                    buffer = <span class="keyword">new</span> <span class="title class_">Buffer</span>();</span><br><span class="line">                    buffer.writeAll(gzippedResponseBody);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (gzippedResponseBody != <span class="literal">null</span>)</span><br><span class="line">                        gzippedResponseBody.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> UTF8;</span><br><span class="line">            <span class="type">MediaType</span> <span class="variable">contentType</span> <span class="operator">=</span> responseBody.contentType();</span><br><span class="line">            <span class="keyword">if</span> (contentType != <span class="literal">null</span>)</span><br><span class="line">                charset = contentType.charset(UTF8);</span><br><span class="line">            <span class="keyword">if</span> (!isPlaintext(buffer)) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;&lt;-- END HTTP (binary &quot;</span> + buffer.size() + <span class="string">&quot;-byte body omitted)&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (contentLength != <span class="number">0</span>) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                Log.e(TAG, buffer.clone().readString(charset));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (gzippedLength != <span class="literal">null</span>)</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;&lt;-- END HTTP (&quot;</span> + buffer.size() + <span class="string">&quot;-byte, &quot;</span>  + gzippedLength + <span class="string">&quot;-gzipped-byte body)&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Log.e(TAG, <span class="string">&quot;&lt;-- END HTTP (&quot;</span> + buffer.size() + <span class="string">&quot;-byte body)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isPlaintext</span><span class="params">(Buffer buffer)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Buffer</span> <span class="variable">prefix</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Buffer</span>();</span><br><span class="line">            <span class="type">long</span> <span class="variable">byteCount</span> <span class="operator">=</span> buffer.size() &lt; <span class="number">64</span> ? buffer.size() : <span class="number">64</span>;</span><br><span class="line">            buffer.copyTo(prefix, <span class="number">0</span>, byteCount);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (prefix.exhausted())</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">codePoint</span> <span class="operator">=</span> prefix.readUtf8CodePoint();</span><br><span class="line">                <span class="keyword">if</span> (Character.isISOControl(codePoint) &amp;&amp; !Character.isWhitespace(codePoint))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (EOFException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// Truncated UTF-8 sequence.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">bodyHasUnknownEncoding</span><span class="params">(Headers myheaders)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">contentEncoding</span> <span class="operator">=</span> myheaders.get(<span class="string">&quot;Content-Encoding&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> contentEncoding != <span class="literal">null</span> &amp;&amp; !contentEncoding.equalsIgnoreCase(<span class="string">&quot;identity&quot;</span>)  &amp;&amp; !contentEncoding.equalsIgnoreCase(<span class="string">&quot;gzip&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上述工程编译为.apk文件，解压出classes.dex，改名为okhttp3loggin.dex放到&#x2F;data&#x2F;local&#x2F;tmp下，用Firda脚本将该拦截器添加到原有的拦截器链条中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_okhttp3</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 1. frida Hook java层的代码必须包裹在Java.perform中，Java.perform会将Hook Java相关API准备就绪。</span></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">openClassFile</span>(<span class="string">&quot;/data/local/tmp/okhttp3logging.dex&quot;</span>).<span class="title function_">load</span>();</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MyInterceptor</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.r0ysue.okhttp3demo.LoggingInterceptor&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">MyInterceptorObj</span> = <span class="title class_">MyInterceptor</span>.$new();</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Builder</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;okhttp3.OkHttpClient$Builder&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Builder</span>);</span><br><span class="line">        <span class="title class_">Builder</span>.<span class="property">build</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">networkInterceptors</span>().<span class="title function_">add</span>(<span class="title class_">MyInterceptorObj</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">build</span>();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook_okhttp3...&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">hook_okhttp3</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>若用attach模式，Hook时机偏后，会带来大量干扰信息， 甚至导致App崩溃。这里用spawn模式，命令为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -f com.xxx.xxx -l hookInterceptor.js --no-pause</span><br></pre></td></tr></table></figure>

<p>okhttp3的证书绑定方法为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client=<span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder().certificatePinner(<span class="keyword">new</span> <span class="title class_">CertificatePinner</span>.Builder().add(<span class="string">&quot;test.com&quot;</span>,<span class="string">&quot;sha512/14cf3JCaO4V...&quot;</span>).build()).build();</span><br></pre></td></tr></table></figure>

<h3 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h3><p>无论有多少三方框架，三方框架是否被混淆，都不可避免地经过系统Socket相关类。Socket由系统完成，相关类一定不会被混淆。先搜索Socket全部类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking search classes socket</span><br></pre></td></tr></table></figure>

<p>找历史记录，每行前面加上<code>android hooking watch class</code>，重新Spawn：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objection -g com.xxx.xxx explore -c xxx.txt</span><br></pre></td></tr></table></figure>

<p>根据Android源码&#x2F;xref&#x2F;libcore&#x2F;ojluni&#x2F;src&#x2F;main&#x2F;java&#x2F;java&#x2F;net&#x2F;SocketOutputStream.java，发现<code>java.net.AbstractPlainSocketImpl.acquireFD</code>被<code>socketWrite</code>调用，第一个参数为网络传输的数据内容。获取request的脚本为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.SocketOutputStream&#x27;</span>).<span class="property">socketWrite</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>,<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">b,off,len</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> result=<span class="variable language_">this</span>.<span class="title function_">socketWrite</span>(b,off,len);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;socketWrite result,b,off,len=&gt;&#x27;</span>,result,b,off,len);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ByteString</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;contents:=&gt;&#x27;</span>,<span class="title class_">ByteString</span>.<span class="title function_">of</span>(b).<span class="title function_">hex</span>());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>先写一个函数，将Java层的byte数组打印出相应字节的dexdump：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">jhexdump</span>(<span class="params">array</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> ptr=<span class="title class_">Memory</span>.<span class="title function_">alloc</span>(array.<span class="property">length</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;array.<span class="property">length</span>;i++)</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">writeS8</span>(ptr.<span class="title function_">add</span>(i),array[i]);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(ptr,&#123;<span class="attr">offset</span>:<span class="number">0</span>,<span class="attr">length</span>:array.<span class="property">length</span>,<span class="attr">header</span>:<span class="literal">false</span>,<span class="attr">ansi</span>:<span class="literal">false</span>&#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于response，找<code>java.net.SocketInputStream.read([B,int,int)</code>函数，得到的是gzip压缩后的数据，解压即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.new.SocketInputStream&#x27;</span>).<span class="property">read</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>,<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">bytearray1,int1,int2</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> result=<span class="variable language_">this</span>.<span class="title function_">read</span>(bytearray1,int1,int2);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;read result,bytearray1,int1,int2=&gt;&#x27;</span>,result,bytearray1,int1,int2);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ByteString</span>=<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line">    <span class="title function_">jhexdump</span>(bytearray1);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上面是HTTP的抓包方法，现在为HTTPS抓包方法。此时关键函数为<code>com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream.write([B,int,int)</code>和<code>com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLInputStream.read([B,int,int)</code>。它们第一个参数为明文数据。</p>
<p>无论是HTTP还是HTTPS，都可Hook函数<code>java.net.InetSocketAddress.InetSocketAddress(java.net.InetAddress,int)</code>。第一个参数转String为IP地址，第二个参数为端口号。</p>
<p>用下面命令翻一下类的结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plugin load D:/plugins/Wallbreaker</span><br><span class="line">plugin wallbreaker classdump java.net.InetAddress</span><br></pre></td></tr></table></figure>

<p>其中<code>isSiteLocalAddress</code>区分是本地地址还是远程地址，最终如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookAddress</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.InetSocketAddress&#x27;</span>).<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.net.InetAddress&#x27;</span>,<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span>=<span class="keyword">function</span>(<span class="params">addr,port</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> result=<span class="variable language_">this</span>.$init(addr,port);</span><br><span class="line">            <span class="keyword">if</span>(addr.<span class="title function_">isSiteLocalAddress</span>())</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Local address=&gt;&#x27;</span>,addr.<span class="title function_">toString</span>(),<span class="string">&#x27;,port is &#x27;</span>,port);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server address=&gt;&#x27;</span>,addr.<span class="title function_">toString</span>(),<span class="string">&#x27;,port is &#x27;</span>,port);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><p>使用WebSocket时，服务器可主动向客户端推送信息，客户端也可主动向服务器发送信息，即全双工通信。WebSocket建立连接后能保持持久化连接，不需要一个request对应一个response。</p>
<h3 id="XMPP"><a href="#XMPP" class="headerlink" title="XMPP"></a>XMPP</h3><p>XMPP用于即时通信，基于XML。一个XML消息实体如下，message标签即为XML Stanza。Android中常用的基于XMPP协议的开发框架为Smack。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xmlversion=&#x27;1.0&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stream:stream</span></span></span><br><span class="line"><span class="tag">    <span class="attr">to</span>=<span class="string">&#x27;Receiver&#x27;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&#x27;jabber:client&#x27;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:stream</span>=<span class="string">&#x27;http_etherx_jabber_org/stream&#x27;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">version</span>=<span class="string">&#x27;1.0&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">message</span></span></span><br><span class="line"><span class="tag">        <span class="attr">from</span>=<span class="string">&#x27;Sender&#x27;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">to</span>=<span class="string">&#x27;Receiver&#x27;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xml:lang</span>=<span class="string">&#x27;zh-cn&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">stream:stream</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h3><p>Protobuf时一种不依赖语言和平台类型、可扩展的用于序列化结构数据的机制，支持多种主流计算机语言，目前主要用proto2和proto3两大版本。Protobuf在直播、弹幕等实时性数据传输业务需求下，能够减少数据在传输过程中占用空间的大小，是JSON性能的100多倍。Protobuf用.proto文件定义数据格式。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax=<span class="string">&quot;proto3&quot;</span> <span class="comment">//版本</span></span><br><span class="line"><span class="keyword">option</span> java_multiple_files=<span class="literal">true</span>;</span><br><span class="line"><span class="keyword">option</span> java_package=<span class="string">&quot;com.xxx.xxx&quot;</span>; <span class="comment">//生成的类放在什么Java包下</span></span><br><span class="line"><span class="keyword">option</span> java_outer_classname=<span class="string">&quot;HelloWorldProto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> objc_class_prefix=<span class="string">&quot;HLW&quot;</span>;</span><br><span class="line"><span class="keyword">package</span> helloworld; <span class="comment">//声明包名</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span>&#123;</span><br><span class="line">    <span class="type">string</span> name=<span class="number">1</span>; <span class="comment">//1为唯一标识符</span></span><br><span class="line">    <span class="type">int32</span> sex=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span>&#123;</span><br><span class="line">    <span class="type">string</span> message=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Protobuf通常与gRPC框架配合使用，后者是个高性能、开源和通用的RPC框架，主要面向移动设计，提供多个语言版本，支持Android和Web。gRPC基于HTTP&#x2F;2标准设计，具有双向流、流控、头部压缩、单TCP连接上的多复用请求等特性，移动设备上更省电、空间占用更少。</p>
<h2 id="图片抓包"><a href="#图片抓包" class="headerlink" title="图片抓包"></a>图片抓包</h2><p>Android通常用BitmapFactory类中函数加载Bitmap对象，通过ImageView控件加载Bitmap对象类型的图片。BitmapFactory类提供的静态方法有<code>decodeFile</code>、<code>decodeResource</code>、<code>decodeStream</code>、<code>decodeByteArray</code>，分别从文件系统、资源、输入流和字节数组中加载Bitmap对象。图片读写非常耗时，下面脚本新建线程进行图片文件写入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">guid</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&#x27;</span>.replace(/[xy]/g,function(c)&#123;</span><br><span class="line">        <span class="keyword">var</span> r=Math.random()*<span class="number">16</span>|<span class="number">0</span>,v=c==<span class="string">&#x27;x&#x27;</span>?r:(r&amp;<span class="number">0x3</span>|<span class="number">0x8</span>);</span><br><span class="line">        <span class="keyword">return</span> v.toString(<span class="number">16</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">function <span class="title function_">saveBitmap_3</span><span class="params">()</span>&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">Runnable</span> <span class="operator">=</span> Java.use(<span class="string">&quot;java.lang.Runnable&quot;</span>);</span><br><span class="line">        <span class="type">var</span> <span class="variable">saveImg</span> <span class="operator">=</span> Java.registerClass(&#123; <span class="comment">//新建一个Java类</span></span><br><span class="line">            name: <span class="string">&quot;com.roysue.runnable&quot;</span>, <span class="comment">//新建类的类名</span></span><br><span class="line">            implements: [Runnable], <span class="comment">//父类对象或接口 这里是java.lang.Runnable</span></span><br><span class="line">            fields: &#123; <span class="comment">//类中成员</span></span><br><span class="line">                bm: <span class="string">&quot;android.graphics.Bitmap&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            methods: &#123; <span class="comment">//类中函数</span></span><br><span class="line">                $init: [&#123;</span><br><span class="line">                    returnType: <span class="string">&quot;void&quot;</span>,</span><br><span class="line">                    argumentTypes: [<span class="string">&quot;android.graphics.Bitmap&quot;</span>],</span><br><span class="line">                    implementation: function (bitmap) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.bm.value = bitmap;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;],</span><br><span class="line">                run: function () &#123;</span><br><span class="line">                    <span class="type">var</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/sdcard/Download/tmp/&quot;</span> + guid() + <span class="string">&quot;.jpg&quot;</span></span><br><span class="line">                    console.log(<span class="string">&quot;path=&gt; &quot;</span>, path)</span><br><span class="line">                    <span class="type">var</span> <span class="variable">file</span> <span class="operator">=</span> Java.use(<span class="string">&quot;java.io.File&quot;</span>).$<span class="keyword">new</span>(path)</span><br><span class="line">                    <span class="type">var</span> <span class="variable">fos</span> <span class="operator">=</span> Java.use(<span class="string">&quot;java.io.FileOutputStream&quot;</span>).$<span class="keyword">new</span>(file);</span><br><span class="line">                    <span class="built_in">this</span>.bm.value.compress(Java.use(<span class="string">&quot;android.graphics.Bitmap$CompressFormat&quot;</span>).JPEG.value, <span class="number">100</span>, fos)</span><br><span class="line">                    console.log(<span class="string">&quot;success!&quot;</span>)</span><br><span class="line">                    fos.flush();</span><br><span class="line">                    fos.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Java.use(<span class="string">&#x27;android.graphics.BitmapFactory&#x27;</span>).decodeByteArray.overload(<span class="string">&#x27;[B&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;android.graphics.BitmapFactory$Options&#x27;</span>).implementation =  function(data,offset,length,opts)&#123;</span><br><span class="line">            <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.decodeByteArray(data,offset,length,opts)</span><br><span class="line">            <span class="type">var</span> <span class="variable">ByteString</span> <span class="operator">=</span> Java.use(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line">            console.log(<span class="string">&quot;data is coming!&quot;</span>)</span><br><span class="line">            <span class="type">var</span> <span class="variable">runable</span> <span class="operator">=</span> saveImg.$<span class="keyword">new</span>(result)</span><br><span class="line">            runable.run()</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面这个脚本针对任意控件点触即输出所在类的脚本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jclazz = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> jobj = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getObjClassName</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!jclazz)</span><br><span class="line">        <span class="keyword">var</span> jclazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!jobj)</span><br><span class="line">        <span class="keyword">var</span> jobj = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> jclazz.<span class="property">getName</span>.<span class="title function_">call</span>(jobj.<span class="property">getClass</span>.<span class="title function_">call</span>(obj));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">obj, mtdName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> listener_name = <span class="title function_">getObjClassName</span>(obj);</span><br><span class="line">    <span class="keyword">var</span> target = <span class="title class_">Java</span>.<span class="title function_">use</span>(listener_name);</span><br><span class="line">    <span class="keyword">if</span> (!target || !mtdName <span class="keyword">in</span> target)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// send(&quot;[WatchEvent] hooking &quot; + mtdName + &quot;: &quot; + listener_name);</span></span><br><span class="line">    target[mtdName].<span class="property">overloads</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">overload</span>) &#123;</span><br><span class="line">        overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="comment">//send(&quot;[WatchEvent] &quot; + mtdName + &quot;: &quot; + getObjClassName(this));</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[WatchEvent] &quot;</span> + mtdName + <span class="string">&quot;: &quot;</span> + <span class="title function_">getObjClassName</span>(<span class="variable language_">this</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>[mtdName].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">OnClickListener</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//以spawn启动进程的模式来attach的话</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.view.View&quot;</span>).<span class="property">setOnClickListener</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">listener</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="literal">null</span>)</span><br><span class="line">                <span class="title function_">watch</span>(listener, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setOnClickListener</span>(listener);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//如果frida以attach的模式进行attch的话</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;android.view.View$ListenerInfo&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span> (<span class="params">instance</span>) &#123;</span><br><span class="line">                instance = instance.<span class="property">mOnClickListener</span>.<span class="property">value</span>;</span><br><span class="line">                <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mOnClickListener name is :&quot;</span> + <span class="title function_">getObjClassName</span>(instance));</span><br><span class="line">                    <span class="title function_">watch</span>(instance, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">OnTouchListener</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//以spawn启动进程的模式来attach的话</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.view.View&quot;</span>).<span class="property">setOnTouchListener</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">listener</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="literal">null</span>)</span><br><span class="line">                <span class="title function_">watch</span>(listener, <span class="string">&#x27;onTouch&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setOnTouchListener</span>(listener);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//如果frida以attach的模式进行attch的话</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;android.view.View$ListenerInfo&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span> (<span class="params">instance</span>) &#123;</span><br><span class="line">                instance = instance.<span class="property">mOnTouchListener</span>;</span><br><span class="line">                <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mOnTouchListener name is :&quot;</span> + <span class="title function_">getObjClassName</span>(instance));</span><br><span class="line">                    <span class="title function_">watch</span>(instance, <span class="string">&#x27;onTouch&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="title class_">OnClickListener</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OnClickListener#onClick(View v)</span></span><br><span class="line"><span class="comment"> * OnTouchListener#onTouch(View v, MotionEvent event) </span></span><br><span class="line"><span class="comment"> * Activity onTouchEvent(MotionEvent event) Activity 触摸事件</span></span><br><span class="line"><span class="comment"> * RecyclerView OnItemTouchListener#onTouchEvent(RecyclerView recyclerView, MotionEvent motionEvent)  RecyclerView条目触摸事件</span></span><br><span class="line"><span class="comment"> * OnFlingListener#onFling(int x, int y)</span></span><br><span class="line"><span class="comment">    或</span></span><br><span class="line"><span class="comment">    OnScrollChangeListener#onScrollChange(View v, int x,int y, int oldX, int oldY)</span></span><br><span class="line"><span class="comment">    或</span></span><br><span class="line"><span class="comment">    OnScrollListener#onScrollStateChanged(RecyclerView recyclerView, int newState)</span></span><br><span class="line"><span class="comment">    或</span></span><br><span class="line"><span class="comment">    OnScrollListener#onScrolled(RecyclerView recyclerView,int dx, int dy) onScroll RecyclerView 滑动事件</span></span><br><span class="line"><span class="comment"> * ListView OnItemClickListener#onItemClick(AdapterView parent,View view, int position, long id) - onViewItemClick - ListView - 条目点击事件</span></span><br><span class="line"><span class="comment"> * OnScrollListener#onScrollStateChanged(AbsListView view, int scrollState) 或</span></span><br><span class="line"><span class="comment">    OnScrollChangeListener#onScrollChange(View v, int scrollX, int scrollY, int oldScrollX, int oldScrollY)  onScroll ListView 滑动事件</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>例如修改某个类的实例变量值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookVIP</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.ilulutv.fulao2.film.l&quot;</span>,&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">ins</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;found ins:=&gt;&quot;</span>,ins)</span><br><span class="line">                ins.<span class="property">q0</span>.<span class="property">value</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;search completed!&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Native-Hook"><a href="#Native-Hook" class="headerlink" title="Native Hook"></a>Native Hook</h2><p>在Java数据类型和JNI数据类型对应中，JNI数据类型为“j+Java数据类型小写”。例如Java下的String、Object对应JNI下的jstring、jobject。</p>
<p>在Objection下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">memory list modules #列出进程中模块、加载地址、文件大小、存储目录</span><br><span class="line">memory list exports lib*.so #查看某模块所有导出符号</span><br></pre></td></tr></table></figure>

<p>在编写Native程序时，函数声明前若不加<code>extern &quot;C&quot;</code>描述符，会被C++的名称粉碎机制而改变函数名，导致无法Java层无法找到相应native实现。例如可以恢复：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿computer)-[~]</span><br><span class="line">└─<span class="comment"># c++filt _Z48Java_com_roysue_r0so_MainActivity_stringFromJNI2P7_JNIEnvP8_jobject</span></span><br><span class="line">Java_com_roysue_r0so_MainActivity_stringFromJNI2(_JNIEnv*, _jobject*)</span><br></pre></td></tr></table></figure>

<p>一个模板如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_native</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>, <span class="string">&quot;Java_com_roysue_r0so_MainActivity_stringFromJNI&quot;</span>); <span class="comment">//找到函数首地址 第一个参数为null则从所有模块中搜索</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr,&#123; <span class="comment">//要Hook的函数地址</span></span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123; <span class="comment">//调用前产生的回调</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;jnienv pointer =&gt;&quot;</span>,args[<span class="number">0</span>])</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;jobj pointer =&gt;&quot;</span>,args[<span class="number">1</span>])</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123; <span class="comment">//函数返回值</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval is =&gt;&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(retval, <span class="literal">null</span>).<span class="title function_">readCString</span>()) <span class="comment">//当前线程JNIEnv readCString从获得的C字符串指针获取内存中对应C字符串</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_native</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>Native层动态注册方法为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  TAG    <span class="string">&quot;r0so2&quot;</span></span></span><br><span class="line"><span class="comment">// 定义info信息</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,TAG,__VA_ARGS__)</span></span><br><span class="line"><span class="comment">// 定义debug信息</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, TAG, __VA_ARGS__)</span></span><br><span class="line"><span class="comment">// 定义error信息</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR,TAG,__VA_ARGS__)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_com_roysue_r0so_MainActivity_stringFromJNI</span><span class="params">(JNIEnv* env,jobject <span class="comment">/* this */</span>)</span> </span>&#123;</span><br><span class="line">    std::string hello = <span class="string">&quot;Hello from C++ r0ysue&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">stringFromJNI3</span><span class="params">(JNIEnv* env,jobject <span class="comment">/*this*/</span>)</span> </span>&#123;</span><br><span class="line">    std::string hello = <span class="string">&quot;Hello from C++ stringFromJNI3 r0ysue &quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span></span>&#123;</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    vm-&gt;<span class="built_in">GetEnv</span>((<span class="type">void</span>**)&amp;env,JNI_VERSION_1_6);</span><br><span class="line">    JNINativeMethod methods[] = &#123;&#123;<span class="string">&quot;sI3&quot;</span>,<span class="string">&quot;()Ljava/lang/String;&quot;</span>,(<span class="type">void</span>*)stringFromJNI3&#125;&#125;;</span><br><span class="line">    env-&gt;<span class="built_in">RegisterNatives</span>(env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;com/roysue/r0so/MainActivity&quot;</span>),methods,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Hook函数<code>RegisterNatives</code>用<a target="_blank" rel="noopener" href="https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_RegisterNatives.js">https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_RegisterNatives.js</a> ，需要在Spawn方法使用，可获取动态注册时相应函数地址，并写脚本对0xf444进行Hook：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_native3</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> libnative_addr =  <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libnative-lib.so&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libnative_addr is =&gt; &quot;</span>,libnative_addr)</span><br><span class="line">    <span class="keyword">var</span> stringfromJNI3 = libnative_addr.<span class="title function_">add</span>(<span class="number">0xf444</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stringfromJNI3 address is =&gt;&quot;</span>,stringfromJNI3);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(stringfromJNI3,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;jnienv pointer =&gt;&quot;</span>,args[<span class="number">0</span>])</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;jobj pointer =&gt;&quot;</span>,args[<span class="number">1</span>])</span><br><span class="line">            <span class="comment">// console.log(&quot;jstring pointer=&gt;&quot;,Java.vm.getEnv().getStringUtfChars(args[2], null).readCString() )</span></span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval is =&gt;&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(retval, <span class="literal">null</span>).<span class="title function_">readCString</span>())</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;=================&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_native3</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>Native层主动调用如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> method01_addr=<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libroysue.so&quot;</span>,<span class="string">&quot;Java_com_roysue_easysol_MainActivity_method01&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;method01 address is=&gt;&quot;</span>,method01_addr);</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> jstring=<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">newStringUtf</span>(<span class="string">&quot;roysue&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> method01=<span class="keyword">new</span> <span class="title class_">NativeFunction</span>(method01_addr,<span class="string">&quot;pointer&quot;</span>,[<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>]); <span class="comment">//第二个为返回值 后三个为参数类型 jstring也是指针</span></span><br><span class="line">        <span class="keyword">var</span> result=<span class="title function_">method01</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>(),jstring,jstring);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Final result is=&gt;&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(result,<span class="literal">null</span>).<span class="title function_">readCString</span>());</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>对于Socket层的抓包，之前函数<code>com.android.org.conscrypt.ConscryptFileDescriptorSocket$SSLOutputStream.write</code>在Native层的实现是boringssl模块中的<code>SSL_write</code>函数。查看boringssl模块的Android.bp编译配置文件可知最终编译生成模块有libcrypto.so和libssl.so，此时查看这俩模块导出函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">memory list exports libcrypto.so --json libcrypto.so.json</span><br><span class="line">memory list exports libssl.so --json libssl.so.json</span><br></pre></td></tr></table></figure>

<p>吐出libssl.so中<code>SSL_write</code>的接收到的数据包信息脚本如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_ssl_write</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> addr = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&quot;libssl.so&quot;</span>, <span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(addr,&#123;   </span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n&quot;</span>,<span class="title function_">hexdump</span>(args[<span class="number">1</span>],&#123;<span class="attr">length</span>: args[<span class="number">2</span>].<span class="title function_">toInt32</span>()&#125;))</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">           <span class="comment">// console.log(&quot;retval is =&gt;&quot;,Java.vm.getEnv().getStringUtfChars(retval, null).readCString())</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;================== onLeave =================&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Entering main&quot;</span>)</span><br><span class="line">    <span class="title function_">hook_ssl_write</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>接下来trace一下libssl.so中所有符号函数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -UF -I libssl.so</span><br></pre></td></tr></table></figure>

<p>Frida还可便利进程所有模块，和某模块所有导出符号，实现类似Objection的功能：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">traceNativeExports</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules=<span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span>=<span class="variable language_">module</span>[i];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libssl.so&quot;</span>)&lt;<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span>=<span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;<span class="built_in">exports</span>.<span class="property">length</span>;j++)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;module name is=&gt;&quot;</span>,<span class="variable language_">module</span>.<span class="property">name</span>,<span class="string">&quot;symbol name is=&gt;&quot;</span>,<span class="built_in">exports</span>[j].<span class="property">name</span>,<span class="string">&quot;address:&quot;</span>+<span class="built_in">exports</span>[j].<span class="property">address</span>,<span class="string">&quot;offset=&gt;&quot;</span>,(<span class="built_in">exports</span>[j].<span class="property">address</span>.<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traceNativeSymbols</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules=<span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span>=modules[i];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libssl.so&quot;</span>)&lt;<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span>=<span class="variable language_">module</span>.<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;<span class="built_in">exports</span>.<span class="property">length</span>;j++)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;module name is=&gt;&quot;</span>,<span class="variable language_">module</span>.<span class="property">name</span>,<span class="string">&quot;symbol name is=&gt;&quot;</span>,<span class="built_in">exports</span>[j].<span class="property">name</span>,<span class="string">&quot;address:&quot;</span>+<span class="built_in">exports</span>[j].<span class="property">address</span>,<span class="string">&quot;offset=&gt;&quot;</span>,(<span class="built_in">exports</span>[j].<span class="property">address</span>.<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Frida还可以写文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">writeSomething</span>(<span class="params">path, contents</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> fopen_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fputs_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fputs&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fclose_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fclose&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fopen_addr, <span class="string">&quot;pointer&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>])</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fputs_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;pointer&quot;</span>])</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fclose_addr, <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>])</span><br><span class="line">    <span class="keyword">var</span> fileName = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(path);</span><br><span class="line">    <span class="keyword">var</span> mode = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;a+&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> fp = <span class="title function_">fopen</span>(fileName, mode);</span><br><span class="line">    <span class="keyword">var</span> contentHello = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(contents);</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="title function_">fputs</span>(contentHello,fp)</span><br><span class="line">    <span class="title function_">fclose</span>(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再对所有函数追踪：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">attach</span>(<span class="params">name,address</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;attaching &quot;</span>,name);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(address,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Entering =&gt; &quot;</span> ,name)</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">traceNativeExport</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">module</span>.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;libssl.so&quot;</span>)&lt;<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;module.addr&#x27;</span>,<span class="variable language_">module</span>.<span class="property">base</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>;j&lt;<span class="built_in">exports</span>.<span class="property">length</span>;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">exports</span>[j].<span class="property">type</span> == <span class="string">&quot;function&quot;</span>)</span><br><span class="line">                <span class="title function_">attach</span>(<span class="built_in">exports</span>[j].<span class="property">name</span>,<span class="built_in">exports</span>[j].<span class="property">address</span>)</span><br><span class="line">            <span class="keyword">var</span> path = <span class="string">&quot;/data/data/com.roysue.httpurlconnectiondemo/&quot;</span>+<span class="variable language_">module</span>.<span class="property">name</span>+<span class="string">&quot;.txt&quot;</span></span><br><span class="line">            <span class="title function_">writeSomething</span>(path,<span class="string">&quot;type: &quot;</span>+<span class="built_in">exports</span>[j].<span class="property">type</span>+<span class="string">&quot; function name :&quot;</span>+<span class="built_in">exports</span>[j].<span class="property">name</span>+<span class="string">&quot; address : &quot;</span>+<span class="built_in">exports</span>[j].<span class="property">address</span>+<span class="string">&quot; offset =&gt; 0x&quot;</span>+(<span class="built_in">exports</span>[j].<span class="property">address</span> - (modules[i].<span class="property">base</span>)).<span class="title function_">toString</span>(<span class="number">16</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Frida还可以反调试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">replaceKill</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> kill_addr=<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;kill&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(kill_addr,<span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">arg0,arg1</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg0=&gt;&quot;</span>,arg0);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg1=&gt;&quot;</span>,arg1);</span><br><span class="line">    &#125;,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Frida集成了Capstone，方法为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dis</span>(<span class="params">adress,number</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;number;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> ins=<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(address);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span>+address+<span class="string">&quot;--dis:&quot;</span>+ins.<span class="title function_">toString</span>());</span><br><span class="line">        address=ins.<span class="property">next</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> stringFromJniaddr=<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libroysue.so&quot;</span>,<span class="string">&quot;Java_com_roysue_easysol_MainActivity_stringFromJNI&quot;</span>);</span><br><span class="line">    <span class="title function_">dis</span>(stringFromJniaddr,<span class="number">10</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Frida还可对SO动态库中函数地址进行Hook：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> base_address=<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libdebug.so&quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(base_address)&#123;</span><br><span class="line">    <span class="keyword">var</span> func_offset=<span class="number">0x1F17C</span>;</span><br><span class="line">    <span class="keyword">var</span> addr_func=base_address.<span class="title function_">add</span>(func_offset);</span><br><span class="line">    <span class="keyword">var</span> pfunc=<span class="keyword">new</span> <span class="title class_">NativePointer</span>(addr_func);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pfunc,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;call func with args:&quot;</span>+args[<span class="number">0</span>],args[<span class="number">1</span>]);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;func return:&quot;</span>,retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="安全加固"><a href="#安全加固" class="headerlink" title="安全加固"></a>安全加固</h2><h3 id="ProGuard"><a href="#ProGuard" class="headerlink" title="ProGuard"></a>ProGuard</h3><p>build.gradle中添加：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buildTypes&#123;</span><br><span class="line">    release&#123;</span><br><span class="line">        minifyEnabled <span class="literal">true</span></span><br><span class="line">        proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-optimize.txt&#x27;</span>),<span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="签名校验"><a href="#签名校验" class="headerlink" title="签名校验"></a>签名校验</h3><p>上文说PMS返回值可能被替换，这里直接绕过系统API，直接读取data&#x2F;app&#x2F;包名&#x2F;base.apk中签名文件，获取原始签名信息。系统PackageParser服务对APK进行解析并获取文件信息，但该系统不对外暴露，需要用反射调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MainActivity</span></span><br><span class="line"><span class="keyword">package</span> com.verify.signature;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.DialogInterface;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AlertDialog;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> com.verify.signature.databinding.ActivityMainBinding;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ActivityMainBinding binding;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        binding = ActivityMainBinding.inflate(getLayoutInflater());</span><br><span class="line">        setContentView(binding.getRoot());</span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> getApplicationContext();</span><br><span class="line">        Log.i(<span class="string">&quot;Current sign ===&gt;&quot;</span>, Tools.getAppSignature(context));</span><br><span class="line">        Log.i(<span class="string">&quot;Reflect sign ===&gt;&quot;</span>, Tools.getReflectSignature(context));</span><br><span class="line">        Log.i(<span class="string">&quot;Native sign ===&gt;&quot;</span>, Tools.getSignByJni(context));</span><br><span class="line">        binding.fab.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                Tools.getSignatureFileCrc(context);</span><br><span class="line">                <span class="keyword">if</span> (!Tools.checkSignature(context))&#123;</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>).setTitle(<span class="string">&quot;安全提醒&quot;</span>)<span class="comment">//设置对话框标题</span></span><br><span class="line">                    .setMessage(<span class="string">&quot;当前使用的客户端为非官方版本，存在极大的安全隐患。为了您的财产安全请在官方渠道下载重新安装！&quot;</span>)</span><br><span class="line">                    .setPositiveButton(<span class="string">&quot;确定&quot;</span>, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                            System.exit(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Tools</span></span><br><span class="line"><span class="keyword">package</span> com.verify.signature;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageInfo;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageManager;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.Signature;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipFile;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tools</span> &#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.loadLibrary(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">getSignByJni</span><span class="params">(Context mContext)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkSignature</span><span class="params">(Context context)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sign</span> <span class="operator">=</span> <span class="string">&quot;8b34e97425e0e682e3a73bd55830fc28ce34a4e8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (sign.equals(getReflectSignature(context)))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getSignatureFileCrc</span><span class="params">(Context context)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ZipFile zf;</span><br><span class="line">            String path= context.getPackageManager().getApplicationInfo(context.getPackageName(), <span class="number">0</span>).publicSourceDir;</span><br><span class="line">            zf = <span class="keyword">new</span> <span class="title class_">ZipFile</span>(path);</span><br><span class="line">            <span class="type">ZipEntry</span> <span class="variable">ze</span> <span class="operator">=</span> zf.getEntry(<span class="string">&quot;META-INF/MANIFEST.MF&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">crcValue</span> <span class="operator">=</span> String.valueOf(ze.getCrc());</span><br><span class="line">            Log.i(<span class="string">&quot;Test MANIFEST Crc ====&gt;&quot;</span>,crcValue);</span><br><span class="line">            <span class="keyword">return</span> crcValue;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getAppSignature</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> sha1(getSignature(context));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getSignature(Context context) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PackageInfo</span> <span class="variable">packageInfo</span> <span class="operator">=</span> context.getPackageManager().getPackageInfo(context.getPackageName(), PackageManager.GET_SIGNATURES);</span><br><span class="line">            Signature[] signatures = packageInfo.signatures;</span><br><span class="line">            <span class="keyword">if</span> (signatures != <span class="literal">null</span>) &#123;</span><br><span class="line">                Log.i(<span class="string">&quot;Test ===&gt;&quot;</span>, signatures[<span class="number">0</span>].toCharsString());</span><br><span class="line">                <span class="keyword">return</span> signatures[<span class="number">0</span>].toByteArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getReflectSignature</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String path= context.getPackageManager().getApplicationInfo(context.getPackageName(), <span class="number">0</span>).publicSourceDir;</span><br><span class="line">            <span class="keyword">return</span> sha1(getApkSignatureByReflect(path));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sha1</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;SHA1&quot;</span>);</span><br><span class="line">            md.update(bytes);</span><br><span class="line">            <span class="type">byte</span>[] b = md.digest();</span><br><span class="line">            <span class="type">int</span> i;</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">byte</span> value : b) &#123;</span><br><span class="line">                i = value;</span><br><span class="line">                <span class="keyword">if</span> (i &lt; <span class="number">0</span>)</span><br><span class="line">                    i += <span class="number">256</span>;</span><br><span class="line">                <span class="keyword">if</span> (i &lt; <span class="number">16</span>)</span><br><span class="line">                    sb.append(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">                sb.append(Integer.toHexString(i));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getApkSignatureByReflect(String apkPath) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fullPackageParserPath</span> <span class="operator">=</span> <span class="string">&quot;android.content.pm.PackageParser&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">packageParserClass</span> <span class="operator">=</span> Class.forName(fullPackageParserPath);</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">pkgParserConstructor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">pkgParserIns</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt; <span class="number">20</span>)&#123;</span><br><span class="line">                pkgParserConstructor = packageParserClass.getConstructor();</span><br><span class="line">                pkgParserIns = pkgParserConstructor.newInstance();</span><br><span class="line">                Class[] args = &#123;File.class, Integer.TYPE&#125;;;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">parsePackageMethod</span> <span class="operator">=</span> packageParserClass.getDeclaredMethod(<span class="string">&quot;parsePackage&quot;</span>, args);</span><br><span class="line">                Object[] valueArgs  = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">2</span>];</span><br><span class="line">                valueArgs[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">File</span>(apkPath);</span><br><span class="line">                valueArgs[<span class="number">1</span>] = PackageManager.GET_SIGNATURES;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">parserPackage</span> <span class="operator">=</span> parsePackageMethod.invoke(pkgParserIns, valueArgs);</span><br><span class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT&gt;=<span class="number">28</span>)&#123;</span><br><span class="line">                    Class[] typeArgs = &#123;parserPackage.getClass(),Boolean.TYPE&#125;;</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">collectCertificatesMethod</span> <span class="operator">=</span> packageParserClass.getDeclaredMethod(<span class="string">&quot;collectCertificates&quot;</span>, typeArgs);</span><br><span class="line">                    Object[] valueArgs2 = &#123;parserPackage, Build.VERSION.SDK_INT&gt;<span class="number">28</span>&#125;;</span><br><span class="line">                    collectCertificatesMethod.invoke(pkgParserIns, valueArgs2);</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">mSignatures</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span>(Build.VERSION.SDK_INT&gt;=<span class="number">29</span>)</span><br><span class="line">                        mSignatures = parserPackage.getClass().getDeclaredField(<span class="string">&quot;mSigningDetails&quot;</span>);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        mSignatures = parserPackage.getClass().getDeclaredField(<span class="string">&quot;mSignatures&quot;</span>);</span><br><span class="line">                    mSignatures.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">mSigningDetails</span> <span class="operator">=</span>  mSignatures.get(parserPackage);</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">infoField</span> <span class="operator">=</span> mSigningDetails.getClass().getDeclaredField(<span class="string">&quot;signatures&quot;</span>);</span><br><span class="line">                    infoField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    Signature[] info = (Signature[]) infoField.get(mSigningDetails);</span><br><span class="line">                    Log.i(<span class="string">&quot;ReflectSignature ===&gt;&quot;</span>, info[<span class="number">0</span>].toCharsString());</span><br><span class="line">                    <span class="keyword">return</span> info[<span class="number">0</span>].toByteArray();</span><br><span class="line">                &#125;</span><br><span class="line">                Class[] typeArgs = &#123;parserPackage.getClass(),Integer.TYPE&#125;;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">collectCertificatesMethod</span> <span class="operator">=</span> packageParserClass.getDeclaredMethod(<span class="string">&quot;collectCertificates&quot;</span>, typeArgs);</span><br><span class="line">                Object[] valueArgs2 = &#123;parserPackage, PackageManager.GET_SIGNATURES&#125;;</span><br><span class="line">                collectCertificatesMethod.invoke(pkgParserIns, valueArgs2);</span><br><span class="line">                <span class="comment">// 应用程序信息包, 这个公开的, 不过有些函数, 变量没公开</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">packageInfoFld</span> <span class="operator">=</span> parserPackage.getClass().getDeclaredField(<span class="string">&quot;mSignatures&quot;</span>);</span><br><span class="line">                Signature[] info = (Signature[]) packageInfoFld.get(parserPackage);</span><br><span class="line">                Log.i(<span class="string">&quot;ReflectSignature ===&gt;&quot;</span>, info[<span class="number">0</span>].toCharsString());</span><br><span class="line">                <span class="keyword">return</span> info[<span class="number">0</span>].toByteArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JNI层：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//signature</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  TAG    <span class="string">&quot;Test&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>  LOGI(...)  __android_log_print(ANDROID_LOG_INFO, TAG, __VA_ARGS__)</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *APP_SIGNATURE = <span class="string">&quot;10645EA8A12BE7A2C04B1F81DF3B4D90&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteToHexStr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *source, <span class="type">char</span> *dest, <span class="type">int</span> sourceLen)</span> </span>&#123;</span><br><span class="line">    <span class="type">short</span> i;</span><br><span class="line">    <span class="type">char</span> highByte, lowByte;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; sourceLen; i++) &#123;</span><br><span class="line">        highByte = source[i] &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        lowByte = source[i] &amp; <span class="number">0x0f</span>;</span><br><span class="line">        highByte += <span class="number">0x30</span>;</span><br><span class="line">        <span class="keyword">if</span> (highByte &gt; <span class="number">0x39</span>)</span><br><span class="line">            dest[i * <span class="number">2</span>] = highByte + <span class="number">0x07</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            dest[i * <span class="number">2</span>] = highByte;</span><br><span class="line">        lowByte += <span class="number">0x30</span>;</span><br><span class="line">        <span class="keyword">if</span> (lowByte &gt; <span class="number">0x39</span>)</span><br><span class="line">            dest[i * <span class="number">2</span> + <span class="number">1</span>] = lowByte + <span class="number">0x07</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            dest[i * <span class="number">2</span> + <span class="number">1</span>] = lowByte;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">jstring <span class="title">sha1</span><span class="params">(JNIEnv *env, jbyteArray source)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// MessageDigest类</span></span><br><span class="line">    jclass classMessageDigest = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/security/MessageDigest&quot;</span>);</span><br><span class="line">    <span class="comment">// MessageDigest.getInstance()静态方法</span></span><br><span class="line">    jmethodID midGetInstance = env-&gt;<span class="built_in">GetStaticMethodID</span>(classMessageDigest, <span class="string">&quot;getInstance&quot;</span>,<span class="string">&quot;(Ljava/lang/String;)Ljava/security/MessageDigest;&quot;</span>);</span><br><span class="line">    <span class="comment">// MessageDigest object</span></span><br><span class="line">    jobject objMessageDigest = env-&gt;<span class="built_in">CallStaticObjectMethod</span>(classMessageDigest,midGetInstance,env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;sha1&quot;</span>));</span><br><span class="line">    <span class="comment">// update方法，这个函数的返回值是void，写V</span></span><br><span class="line">    jmethodID midUpdate = env-&gt;<span class="built_in">GetMethodID</span>(classMessageDigest, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;([B)V&quot;</span>);</span><br><span class="line">    env-&gt;<span class="built_in">CallVoidMethod</span>(objMessageDigest, midUpdate, source);</span><br><span class="line">    <span class="comment">// digest方法</span></span><br><span class="line">    jmethodID midDigest = env-&gt;<span class="built_in">GetMethodID</span>(classMessageDigest, <span class="string">&quot;digest&quot;</span>, <span class="string">&quot;()[B&quot;</span>);</span><br><span class="line">    jbyteArray objArraySign = (jbyteArray) env-&gt;<span class="built_in">CallObjectMethod</span>(objMessageDigest, midDigest);</span><br><span class="line">    jsize intArrayLength = env-&gt;<span class="built_in">GetArrayLength</span>(objArraySign);</span><br><span class="line">    jbyte *byte_array_elements = env-&gt;<span class="built_in">GetByteArrayElements</span>(objArraySign, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">size_t</span> length = (<span class="type">size_t</span>) intArrayLength * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="type">char</span> *char_result = (<span class="type">char</span> *) <span class="built_in">malloc</span>(length);</span><br><span class="line">    <span class="built_in">memset</span>(char_result, <span class="number">0</span>, length);</span><br><span class="line">    <span class="comment">// 将byte数组转换成16进制字符串，发现这里不用强转，jbyte和unsigned char应该字节数是一样的</span></span><br><span class="line">    <span class="built_in">ByteToHexStr</span>((<span class="type">const</span> <span class="type">char</span> *) byte_array_elements, char_result, intArrayLength);</span><br><span class="line">    <span class="comment">// 在末尾补\0</span></span><br><span class="line">    *(char_result + intArrayLength * <span class="number">2</span>) = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    jstring stringResult = env-&gt;<span class="built_in">NewStringUTF</span>(char_result);</span><br><span class="line">    <span class="comment">// release</span></span><br><span class="line">    env-&gt;<span class="built_in">ReleaseByteArrayElements</span>(objArraySign, byte_array_elements, JNI_ABORT);</span><br><span class="line">    <span class="comment">// 释放指针使用free</span></span><br><span class="line">    <span class="built_in">free</span>(char_result);</span><br><span class="line">    env-&gt;<span class="built_in">DeleteLocalRef</span>(classMessageDigest);</span><br><span class="line">    env-&gt;<span class="built_in">DeleteLocalRef</span>(objMessageDigest);</span><br><span class="line">    <span class="keyword">return</span> stringResult;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> jobject <span class="title">getContext</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    jobject application = <span class="literal">NULL</span>;</span><br><span class="line">    jclass activity_thread_clz = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;android/app/ActivityThread&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (activity_thread_clz != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        jmethodID currentApplication = env-&gt;<span class="built_in">GetStaticMethodID</span>(activity_thread_clz, <span class="string">&quot;currentApplication&quot;</span>, <span class="string">&quot;()Landroid/app/Application;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (currentApplication != <span class="literal">NULL</span>)</span><br><span class="line">            application = env-&gt;<span class="built_in">CallStaticObjectMethod</span>(activity_thread_clz, currentApplication);</span><br><span class="line">        env-&gt;<span class="built_in">DeleteLocalRef</span>(activity_thread_clz);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> application;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">getSignByJni</span><span class="params">(JNIEnv *env, jobject thiz, jobject context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得Context类</span></span><br><span class="line">    jclass cls = env-&gt;<span class="built_in">GetObjectClass</span>(context);</span><br><span class="line">    <span class="comment">// 得到getPackageManager方法的ID</span></span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetMethodID</span>(cls, <span class="string">&quot;getPackageManager&quot;</span>,<span class="string">&quot;()Landroid/content/pm/PackageManager;&quot;</span>);</span><br><span class="line">    <span class="comment">// 获得应用包的管理器</span></span><br><span class="line">    jobject pm = env-&gt;<span class="built_in">CallObjectMethod</span>(context, mid);</span><br><span class="line">    <span class="comment">// 得到getPackageName方法的ID</span></span><br><span class="line">    mid = env-&gt;<span class="built_in">GetMethodID</span>(cls, <span class="string">&quot;getPackageName&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="comment">// 获得当前应用包名</span></span><br><span class="line">    jstring packageName = (jstring) env-&gt;<span class="built_in">CallObjectMethod</span>(context, mid);</span><br><span class="line">    <span class="comment">// 获得PackageManager类</span></span><br><span class="line">    cls = env-&gt;<span class="built_in">GetObjectClass</span>(pm);</span><br><span class="line">    <span class="comment">// 得到getPackageInfo方法的ID</span></span><br><span class="line">    mid = env-&gt;<span class="built_in">GetMethodID</span>(cls, <span class="string">&quot;getPackageInfo&quot;</span>,<span class="string">&quot;(Ljava/lang/String;I)Landroid/content/pm/PackageInfo;&quot;</span>);</span><br><span class="line">    <span class="comment">// 获得应用包的信息</span></span><br><span class="line">    jobject packageInfo = env-&gt;<span class="built_in">CallObjectMethod</span>(pm, mid, packageName, <span class="number">0x40</span>); <span class="comment">//GET_SIGNATURES = 64;</span></span><br><span class="line">    <span class="comment">// 获得PackageInfo 类</span></span><br><span class="line">    cls = env-&gt;<span class="built_in">GetObjectClass</span>(packageInfo);</span><br><span class="line">    <span class="comment">// 获得签名数组属性的ID</span></span><br><span class="line">    jfieldID fid = env-&gt;<span class="built_in">GetFieldID</span>(cls, <span class="string">&quot;signatures&quot;</span>, <span class="string">&quot;[Landroid/content/pm/Signature;&quot;</span>);</span><br><span class="line">    <span class="comment">// 得到签名数组</span></span><br><span class="line">    jobjectArray signatures = (jobjectArray) env-&gt;<span class="built_in">GetObjectField</span>(packageInfo, fid);</span><br><span class="line">    <span class="comment">// 得到签名</span></span><br><span class="line">    jobject signature = env-&gt;<span class="built_in">GetObjectArrayElement</span>(signatures, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 获得Signature类</span></span><br><span class="line">    cls = env-&gt;<span class="built_in">GetObjectClass</span>(signature);</span><br><span class="line">    <span class="comment">// 得到toCharsString方法的ID</span></span><br><span class="line">    mid = env-&gt;<span class="built_in">GetMethodID</span>(cls, <span class="string">&quot;toByteArray&quot;</span>, <span class="string">&quot;()[B&quot;</span>);</span><br><span class="line">    <span class="comment">// 返回当前应用签名信息</span></span><br><span class="line">    jbyteArray signatureByteArray = (jbyteArray) env-&gt;<span class="built_in">CallObjectMethod</span>(signature, mid);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sha1</span>(env, signatureByteArray);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SO防护"><a href="#SO防护" class="headerlink" title="SO防护"></a>SO防护</h3><p>对不想对外暴露的函数进行隐藏：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((<span class="built_in">visibility</span>(<span class="string">&quot;hidden&quot;</span>))) <span class="function"><span class="type">int</span> <span class="title">test</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="反调试"><a href="#反调试" class="headerlink" title="反调试"></a>反调试</h3><p>调试工具附加到目标进程时需要用<code>ptrace</code>系统调用操作，以建立其与目标程序的跟踪关系。正常情况下每个进程同一时间只能被附加一次，若应用程序启动后fork一个子进程抢先一步附加到自身进程，则调试器将无法正常附加，达到调试目的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_debug_by_ptrace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> ppid = <span class="built_in">getppid</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ptrace</span>(PTRACE_ATTACH, ppid, <span class="literal">NULL</span>, <span class="literal">NULL</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">waitpid</span>(ppid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">ptrace</span>(PTRACE_CONT, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可直接用PTRACE_TRACEME参数，在进程启动时主动请求被监控跟踪：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">anti_debug_by_ptrace</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">ptrace</span>(PTRACE_TRACEME,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当攻击者使用调试器进行动态分析时，需要设置断点将应用挂起，此时调试器发出SIGTRAP信号。可以在应用中主动添加SIGTRAP信号监听代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">signal_handle</span><span class="params">(<span class="type">int</span> sig)</span></span>&#123; </span><br><span class="line">    <span class="comment">// 自定义信号处理函数</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_debug_by_signal</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 设置SIGTRAP信号的处理函数为signal_handle</span></span><br><span class="line">    <span class="type">long</span> ret = (<span class="type">long</span>)<span class="built_in">signal</span>(SIGTRAP, signal_handle);</span><br><span class="line">    <span class="built_in">raise</span>(SIGTRAP);  <span class="comment">// 主动发送SIGTRAP信号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进程被附加后有些属性值被改变：</p>
<table>
<thead>
<tr>
<th>特征文件名</th>
<th>特征值</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;proc&#x2F;pid&#x2F;status和&#x2F;proc&#x2F;pid&#x2F;task&#x2F;pid&#x2F;status</td>
<td>进程status值中TracePid值非0时处于调试状态</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;pid&#x2F;stat和&#x2F;proc&#x2F;pid&#x2F;task&#x2F;pid&#x2F;stat</td>
<td>进程stat值中括号后跟随的第一个字母为t时处于调试状态</td>
</tr>
<tr>
<td>&#x2F;proc&#x2F;pid&#x2F;wchan和&#x2F;proc&#x2F;pid&#x2F;task&#x2F;pid&#x2F;wchan</td>
<td>进程wchan状态值为ptrace_stop时处于调试状态</td>
</tr>
</tbody></table>
<p>提取特征值为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_debug_by_tracerpid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> debug_file[<span class="number">56</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> state = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> pid = <span class="built_in">getpid</span>(); </span><br><span class="line">    <span class="built_in">sprintf</span>(debug_file, <span class="string">&quot;/proc/%d/status&quot;</span>, pid);</span><br><span class="line">    FILE* fp = <span class="built_in">fopen</span>(debug_file, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="type">char</span> line[<span class="number">1024</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">fgets</span>(line, <span class="number">1024</span>, fp))&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strncmp</span>(line, <span class="string">&quot;TracerPid&quot;</span>, <span class="number">9</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            state = <span class="built_in">atoi</span>(&amp;line[<span class="number">10</span>]);</span><br><span class="line">            <span class="keyword">if</span> (state != <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">fclose</span>(fp);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(line, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可监测代码执行时间，可能出现单步调试现象：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_debug_by_time</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">time_t</span> start_time;</span><br><span class="line">    <span class="type">time_t</span> end_time;</span><br><span class="line">    <span class="built_in">time</span>(&amp;start_time);</span><br><span class="line">    <span class="comment">// 此处添加需要监控的核心代码</span></span><br><span class="line">    <span class="built_in">time</span>(&amp;end_time);</span><br><span class="line">    <span class="comment">// 时间差根据实际情况变动</span></span><br><span class="line">    <span class="keyword">if</span>(end_time - start_time &gt; <span class="number">10</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行调试时需要开启并监听指定端口，若设备开启这些端口则说明在和调试器通信，处于调试状态：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * IDA调试的默认端口23946，对应的十六进制值5D8A</span></span><br><span class="line"><span class="comment"> * Frida默认会占用的两个端口27402、27403，对应的十六进制值6B0A、6B0B</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_debug_by_port</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> buff[BUFF_LEN];</span><br><span class="line">    <span class="type">char</span> line[BUFF_LEN];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* dir = <span class="string">&quot;/proc/net/tcp&quot;</span>;</span><br><span class="line">    FILE *fp = <span class="built_in">fopen</span>(dir, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(buff, BUFF_LEN, fp) != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buff, <span class="string">&quot;5D8A&quot;</span>) != <span class="literal">NULL</span> || <span class="built_in">strstr</span>(buff, <span class="string">&quot;6B0A&quot;</span>) != <span class="literal">NULL</span> || <span class="built_in">strstr</span>(buff, <span class="string">&quot;6B0B&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fclose</span>(fp);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">    FILE *fd = <span class="built_in">popen</span>(<span class="string">&quot;netstat -apn&quot;</span>, <span class="string">&quot;r&quot;</span>);  </span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(line, <span class="built_in">sizeof</span>(line), fd) != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;23946&quot;</span>) != <span class="literal">NULL</span> || <span class="built_in">strstr</span>(line, <span class="string">&quot;27402&quot;</span>) != <span class="literal">NULL</span> || <span class="built_in">strstr</span>(line, <span class="string">&quot;27403&quot;</span>) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="built_in">fclose</span>(fd);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="built_in">pclose</span>(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为防Hook，可建立动态库黑名单机制，将动态库来源路径中非系统目录或其他不可信路径收集整理为黑名单。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">hook注入检测</span></span><br><span class="line"><span class="comment">返回值为0 说明没有异常库信息</span></span><br><span class="line"><span class="comment">正常返回异常库的个数。</span></span><br><span class="line"><span class="comment">根据type的值不同 检测hook框架和注入</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">check_inject</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> pFilePath[<span class="number">32</span>];</span><br><span class="line">    <span class="type">char</span> pLibInfo[<span class="number">256</span>];</span><br><span class="line">    <span class="type">char</span> *pLibPath = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span> *savePtr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> pid = <span class="built_in">getpid</span>();</span><br><span class="line">    <span class="built_in">sprintf</span>(pFilePath, <span class="string">&quot;/proc/%d/maps&quot;</span>, pid);</span><br><span class="line">    FILE *fp = <span class="built_in">fopen</span>(pFilePath, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fgets</span>(pLibInfo, <span class="built_in">sizeof</span>(pLibInfo), fp) != <span class="literal">NULL</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strtok_r</span>(pLibInfo, <span class="string">&quot; \t&quot;</span>, &amp;savePtr); <span class="comment">// 地址信息</span></span><br><span class="line">        <span class="built_in">strtok_r</span>(<span class="literal">NULL</span>, <span class="string">&quot; \t&quot;</span>, &amp;savePtr); <span class="comment">// 权限信息</span></span><br><span class="line">        <span class="built_in">strtok_r</span>(<span class="literal">NULL</span>, <span class="string">&quot; \t&quot;</span>, &amp;savePtr); <span class="comment">// 偏移信息</span></span><br><span class="line">        <span class="built_in">strtok_r</span>(<span class="literal">NULL</span>, <span class="string">&quot; \t&quot;</span>, &amp;savePtr); <span class="comment">// 设备信息</span></span><br><span class="line">        <span class="built_in">strtok_r</span>(<span class="literal">NULL</span>, <span class="string">&quot; \t&quot;</span>, &amp;savePtr); <span class="comment">// 节点信息</span></span><br><span class="line">        pLibPath = <span class="built_in">strtok_r</span>(<span class="literal">NULL</span>, <span class="string">&quot; \t&quot;</span>, &amp;savePtr); <span class="comment">// 路径信息</span></span><br><span class="line">        <span class="keyword">if</span> (pLibPath != <span class="literal">NULL</span>) <span class="comment">// 判断是否有路径信息</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">check_block_list</span>(pLibPath) == <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(pLibInfo, <span class="number">0</span>, <span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="完整性校验"><a href="#完整性校验" class="headerlink" title="完整性校验"></a>完整性校验</h3><p>对应用安装包中文件计算CRC值，与原始CRC值对比，其中CRC值应保存到服务器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MainActivity</span></span><br><span class="line"><span class="keyword">package</span> com.test.integritycheck_android;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="type">Button</span> <span class="variable">btn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Context</span> <span class="variable">mContext</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mContext = getApplicationContext();</span><br><span class="line">        btn = findViewById(R.id.check);</span><br><span class="line">        btn.setOnClickListener(<span class="keyword">new</span> <span class="title class_">MyClick</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MyClick</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    UtilTools.getFileCrc(mContext);</span><br><span class="line">                    UtilTools.getAllFileCrc(mContext);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//UtilTools</span></span><br><span class="line"><span class="keyword">package</span> com.test.integritycheck_android;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipFile;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UtilTools</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] fileArray = &#123;<span class="string">&quot;META-INF/MANIFEST.MF&quot;</span>,<span class="string">&quot;classes.dex&quot;</span>,<span class="string">&quot;resources.arsc&quot;</span>,<span class="string">&quot;AndroidManifest.xml&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">getFileCrc</span><span class="params">(Context context)</span>&#123;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String path= context.getPackageManager().getApplicationInfo(context.getPackageName(), <span class="number">0</span>).publicSourceDir;</span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipFile</span>(path);</span><br><span class="line">            ZipEntry ze;</span><br><span class="line">            <span class="keyword">for</span>(String item:fileArray)&#123;</span><br><span class="line">                ze = zf.getEntry(item);</span><br><span class="line">                <span class="keyword">if</span> (ze != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">crcValue</span> <span class="operator">=</span> String.valueOf(ze.getCrc());</span><br><span class="line">                    result.put(item, crcValue);</span><br><span class="line">                    Log.i(item+ <span class="string">&quot; CRC ======&gt;&quot;</span>,crcValue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">getAllFileCrc</span><span class="params">(Context context)</span>&#123;</span><br><span class="line">        <span class="type">Map</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String path= context.getPackageManager().getApplicationInfo(context.getPackageName(), <span class="number">0</span>).publicSourceDir;</span><br><span class="line">            <span class="type">ZipFile</span> <span class="variable">zf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipFile</span>(path);</span><br><span class="line">            Enumeration&lt;? <span class="keyword">extends</span> <span class="title class_">ZipEntry</span>&gt; entries = zf.entries();</span><br><span class="line">            <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">                <span class="comment">// get the zip entry</span></span><br><span class="line">                <span class="type">ZipEntry</span> <span class="variable">entry</span> <span class="operator">=</span> entries.nextElement();</span><br><span class="line">                <span class="type">String</span> <span class="variable">crcValue</span> <span class="operator">=</span> String.valueOf(entry.getCrc());</span><br><span class="line">                result.put(entry.getName(), crcValue);</span><br><span class="line">                Log.i(entry.getName()+ <span class="string">&quot; CRC ======&gt;&quot;</span>,crcValue);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Frida%E5%85%A5%E9%97%A8/">https://monoceros406.github.io/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Frida%E5%85%A5%E9%97%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://monoceros406.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Unicorn%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Unicorn入门"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">安卓逆向入门-Unicorn入门</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-%E5%AE%89%E5%85%A8%E5%9F%BA%E7%BA%BF/" title="安卓逆向入门-安全基线"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">安卓逆向入门-安全基线</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/14/Android%E5%8F%8D%E8%B0%83%E8%AF%95/" title="Android反调试"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-14</div><div class="title">Android反调试</div></div></a></div><div><a href="/2023/11/02/Android%E5%85%A5%E9%97%A8/" title="Android入门"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-02</div><div class="title">Android入门</div></div></a></div><div><a href="/2023/10/23/Frida%E5%88%9D%E4%BD%93%E9%AA%8C/" title="Frida初体验"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-23</div><div class="title">Frida初体验</div></div></a></div><div><a href="/2023/10/23/Jadx%E5%9C%A8%E9%9B%B7%E7%94%B5%E6%A8%A1%E6%8B%9F%E5%99%A8%E4%B8%8B%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/" title="Jadx在雷电模拟器下的远程动态调试笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-23</div><div class="title">Jadx在雷电模拟器下的远程动态调试笔记</div></div></a></div><div><a href="/2024/03/10/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8%E5%88%9D%E6%8E%A2/" title="安卓安全初探"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-10</div><div class="title">安卓安全初探</div></div></a></div><div><a href="/2024/11/09/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Android%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Android后端开发入门"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-09</div><div class="title">安卓逆向入门-Android后端开发入门</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">智邮普创工作室安全组（退役）/Nepnep联合战队</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">309</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://monoceros406.github.io/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">哪里排版出锅了请告诉我QwQ  QQ:1295625063</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Frida%E5%85%A5%E9%97%A8"><span class="toc-number">1.</span> <span class="toc-text">安卓逆向入门-Frida入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">1.2.</span> <span class="toc-text">入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">1.4.</span> <span class="toc-text">实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">基础语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Objection%E5%88%9D%E6%8E%A2"><span class="toc-number">1.6.</span> <span class="toc-text">Objection初探</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E5%B7%A5%E4%BD%9C%E6%80%9D%E8%B7%AF"><span class="toc-number">1.7.</span> <span class="toc-text">逆向工作思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="toc-number">1.8.</span> <span class="toc-text">常用插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%93%E5%8C%85%E5%85%A5%E9%97%A8"><span class="toc-number">1.9.</span> <span class="toc-text">抓包入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpURLConnection"><span class="toc-number">1.9.1.</span> <span class="toc-text">HttpURLConnection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#okhttp3"><span class="toc-number">1.9.2.</span> <span class="toc-text">okhttp3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Socket"><span class="toc-number">1.9.3.</span> <span class="toc-text">Socket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket"><span class="toc-number">1.9.4.</span> <span class="toc-text">WebSocket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XMPP"><span class="toc-number">1.9.5.</span> <span class="toc-text">XMPP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Protobuf"><span class="toc-number">1.9.6.</span> <span class="toc-text">Protobuf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BE%E7%89%87%E6%8A%93%E5%8C%85"><span class="toc-number">1.10.</span> <span class="toc-text">图片抓包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Native-Hook"><span class="toc-number">1.11.</span> <span class="toc-text">Native Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA"><span class="toc-number">1.12.</span> <span class="toc-text">安全加固</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProGuard"><span class="toc-number">1.12.1.</span> <span class="toc-text">ProGuard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.12.2.</span> <span class="toc-text">签名校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SO%E9%98%B2%E6%8A%A4"><span class="toc-number">1.12.3.</span> <span class="toc-text">SO防护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="toc-number">1.12.4.</span> <span class="toc-text">反调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.12.5.</span> <span class="toc-text">完整性校验</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/11/OpenSSL%E5%85%A5%E9%97%A8-SM2%E5%AE%9E%E8%B7%B5/" title="OpenSSL入门-SM2实践">OpenSSL入门-SM2实践</a><time datetime="2024-12-11T14:39:50.000Z" title="发表于 2024-12-11 22:39:50">2024-12-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/11/OpenSSL%E5%85%A5%E9%97%A8-SSL-TLS%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/" title="OpenSSL入门-SSL-TLS编程实战">OpenSSL入门-SSL-TLS编程实战</a><time datetime="2024-12-11T12:35:44.000Z" title="发表于 2024-12-11 20:35:44">2024-12-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/10/OpenSSL%E5%85%A5%E9%97%A8-PKI%E5%AE%9E%E6%88%98/" title="OpenSSL入门-PKI实战">OpenSSL入门-PKI实战</a><time datetime="2024-12-10T10:50:27.000Z" title="发表于 2024-12-10 18:50:27">2024-12-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/08/OpenSSL%E5%85%A5%E9%97%A8-%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF/" title="OpenSSL入门-椭圆曲线">OpenSSL入门-椭圆曲线</a><time datetime="2024-12-08T14:00:05.000Z" title="发表于 2024-12-08 22:00:05">2024-12-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/08/OpenSSL%E5%85%A5%E9%97%A8-RSA%E7%BB%BC%E5%90%88/" title="OpenSSL入门-RSA综合">OpenSSL入门-RSA综合</a><time datetime="2024-12-08T08:27:56.000Z" title="发表于 2024-12-08 16:27:56">2024-12-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>