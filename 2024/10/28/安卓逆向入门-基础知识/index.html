<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>安卓逆向入门-基础知识 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="安卓逆向入门-基础知识adb常用命令： 12345678910111213141516171819adb devicesadb install *.apkadb install -r -t *.apk #升级&#x2F;覆盖 测试模式adb uninstall *.apk #卸载adb push 本地路径 设备路径adb pull 设备路径 本地路径 #若所在文件夹需要root 则先转移到&#x2F;sdcard再拉">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓逆向入门-基础知识">
<meta property="og:url" content="https://monoceros406.github.io/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="安卓逆向入门-基础知识adb常用命令： 12345678910111213141516171819adb devicesadb install *.apkadb install -r -t *.apk #升级&#x2F;覆盖 测试模式adb uninstall *.apk #卸载adb push 本地路径 设备路径adb pull 设备路径 本地路径 #若所在文件夹需要root 则先转移到&#x2F;sdcard再拉">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://monoceros406.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-10-28T10:59:59.000Z">
<meta property="article:modified_time" content="2024-11-28T02:36:56.294Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="移动安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://monoceros406.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://monoceros406.github.io/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '安卓逆向入门-基础知识',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-28 10:36:56'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="The Blog of Monoceros406" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">330</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">安卓逆向入门-基础知识</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-10-28T10:59:59.000Z" title="发表于 2024-10-28 18:59:59">2024-10-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-28T02:36:56.294Z" title="更新于 2024-11-28 10:36:56">2024-11-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="安卓逆向入门-基础知识"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="安卓逆向入门-基础知识"><a href="#安卓逆向入门-基础知识" class="headerlink" title="安卓逆向入门-基础知识"></a>安卓逆向入门-基础知识</h1><h2 id="adb"><a href="#adb" class="headerlink" title="adb"></a>adb</h2><p>常用命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">adb devices</span><br><span class="line">adb install *.apk</span><br><span class="line">adb install -r -t *.apk <span class="comment">#升级/覆盖 测试模式</span></span><br><span class="line">adb uninstall *.apk <span class="comment">#卸载</span></span><br><span class="line">adb push 本地路径 设备路径</span><br><span class="line">adb pull 设备路径 本地路径 <span class="comment">#若所在文件夹需要root 则先转移到/sdcard再拉取</span></span><br><span class="line">adb logcat &gt; log.txt</span><br><span class="line">adb shell dumpsys package 包名 <span class="comment">#获取指定应用详细信息 包名如com.example.myapp</span></span><br><span class="line">adb shell dumpsys activity top <span class="comment">#查看当前应用activity信息</span></span><br><span class="line">adb shell dumpsys dbinfo 包名 <span class="comment">#查看数据库信息、执行操作的查询语句等</span></span><br><span class="line">adb shell dumpsys meminfo 包名/进程ID <span class="comment">#查看内存信息</span></span><br><span class="line">adb shell input text <span class="string">&quot;xxx&quot;</span> <span class="comment">#在屏幕选中输入框内输入文字 不能中文</span></span><br><span class="line">adb shell pm list packages <span class="comment">#列出所有安装的包</span></span><br><span class="line">adb shell am start-activity -D -N com.example.network/.MainActivity <span class="comment">#以Debug模式启动App</span></span><br><span class="line">adb shell screencap -p 设备路径/screen.png <span class="comment">#手机截屏</span></span><br><span class="line">adb shell screenrecord 设备路径/screen.mp4 <span class="comment">#手机录屏</span></span><br><span class="line">adb forward tcp:本地端口 tcp:设备端口 <span class="comment">#端口转发 发送到本地端口的数据将被转发到设备端口</span></span><br><span class="line">adb tcpip 5555</span><br><span class="line">adb connect 10.203.171.25:5555</span><br></pre></td></tr></table></figure>

<p>其他常用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm list packages</span><br><span class="line">adb shell pm list packages -s <span class="comment">#系统应用</span></span><br><span class="line">adb shell pm list packages -3 <span class="comment">#用户自己安装的应用</span></span><br><span class="line">adb shell pm list packages <span class="string">&#x27;test&#x27;</span></span><br><span class="line">adb shell am start -n com.xxx.xxx <span class="comment">#启动指定服务</span></span><br><span class="line">adb shell am broadcast -a android.NET.conn.CONNECTIVITY_CAHNGE <span class="comment">#向系统发送一条指定广播</span></span><br><span class="line">adb shell am force-stop com.xxx.xxx <span class="comment">#强行停止指定应用进程</span></span><br><span class="line">adb shell input keyevent &lt;keycode&gt; <span class="comment">#模拟按键输入 3-HOME键 4-返回键 26-电源键 82-菜单键 187-切换应用 224-系统休眠</span></span><br><span class="line">adb shell input swipe 500 300 100 300 <span class="comment">#(500,300)滑向(100,300)</span></span><br><span class="line">adb shell input tap 100 300 <span class="comment">#单击</span></span><br><span class="line">adb reboot bootloader</span><br><span class="line">adb reboot recovery</span><br></pre></td></tr></table></figure>

<h2 id="APK文件"><a href="#APK文件" class="headerlink" title="APK文件"></a>APK文件</h2><p>APK根目录下目录文件有：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>简介</th>
</tr>
</thead>
<tbody><tr>
<td>META-INF</td>
<td>元数据，如签名、证书等</td>
</tr>
<tr>
<td>AndroidManifest.xml</td>
<td>全局配置文件</td>
</tr>
<tr>
<td>assets</td>
<td>资源文件夹，不编译不占APK内存</td>
</tr>
<tr>
<td>classes.dex</td>
<td>编译并打包后源码</td>
</tr>
<tr>
<td>lib</td>
<td>二进制共享库文件夹</td>
</tr>
<tr>
<td>res</td>
<td>资源文件夹，被映射到R.java中，访问资源R.id.filename</td>
</tr>
<tr>
<td>resources.arsc</td>
<td>编译res中的文件</td>
</tr>
<tr>
<td>kotlin</td>
<td>Kotlin相关</td>
</tr>
<tr>
<td>original</td>
<td>反编译产生，保存一些文件备份</td>
</tr>
<tr>
<td>Unknown</td>
<td>反编译产生，暂时无法被处理的文件</td>
</tr>
<tr>
<td>Apktool.yml</td>
<td>Apktool描述文件，记录反编译信息</td>
</tr>
</tbody></table>
<p>res中可能的目录有：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>简介</th>
</tr>
</thead>
<tbody><tr>
<td>anim</td>
<td>编译后动画xml文件</td>
</tr>
<tr>
<td>color</td>
<td>编译后选择器xml文件</td>
</tr>
<tr>
<td>layout</td>
<td>编译后布局xml文件</td>
</tr>
<tr>
<td>menu</td>
<td>编译后菜单xml文件</td>
</tr>
<tr>
<td>raw</td>
<td>不编译的资源文件，音视频等</td>
</tr>
<tr>
<td>xml</td>
<td>编译后自定义xml文件</td>
</tr>
<tr>
<td>drawable-*</td>
<td>按分辨率存放的图片</td>
</tr>
</tbody></table>
<p>APK打包时首先处理Java文件、Java代码和Android代码，整体项目编译为class文件，再将class文件转换为Dex文件，再把资源文件、Dex文件和其他文件通过APKbuilder进行合并，打包为一个APK，完成签名后发布。</p>
<p>DEX即Dalvik Executable，Dalvik是Android系统的可执行文件，包含应用程序全部操作指令及运行时数据，结构为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">DexFile</span>&#123;</span><br><span class="line">    DexHeader Header; <span class="comment">//文件头 有版本表示、文件各部分大小及偏移</span></span><br><span class="line">    DexStringId StringIds[stringIdsSize]; <span class="comment">//字符串标识符列表</span></span><br><span class="line">    DexTypeId TypeIds[typeIdsSize]; <span class="comment">//数据类型</span></span><br><span class="line">    DexFieldId FieldIds[fieldIdsSize]; <span class="comment">//字段信息</span></span><br><span class="line">    DexMethodId MethodIds[methodIdsSize]; <span class="comment">//方法信息</span></span><br><span class="line">    DexProtoId ProtoIds[protoIdsSize]; <span class="comment">//原型信息</span></span><br><span class="line">    DexClassDef ClassDefs[classDefsSize]; <span class="comment">//类信息 </span></span><br><span class="line">    DexData Data; <span class="comment">//数据区</span></span><br><span class="line">    DexLink LinkData; <span class="comment">//静态链接数据区</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h3><p>有些工具自己去Android Studio的Android SDK目录找，没有的自己下载。</p>
<p>对APK解包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apktool d ./crackme02.apk</span><br></pre></td></tr></table></figure>

<p>对反汇编结果进行修改，再重新打包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apktool b ./crackme02</span><br></pre></td></tr></table></figure>

<p>接下来是签名：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apksigner verify ./crackme02.apk <span class="comment">#先检查是否有签名</span></span><br><span class="line">zipalign -v 4 ./crackme02.apk ./crackme02-aligned.apk <span class="comment">#对齐 若失败则再来一次</span></span><br><span class="line">keytool -genkey -v -keystore keystore1.ks -<span class="built_in">alias</span> ks1 -keyalg RSA -keysize 2048 -validity 10000 <span class="comment">#生成密钥库keystore1.ks 别名ks1 算法RSA 有效期10000天 接下来会询问密钥等问题</span></span><br><span class="line">apksigner sign --ks keystore1.ks --ks-key-alias ks1 --out crackme02-signed.apk crackme02-aligned.apk <span class="comment">#签名 且会询问上一步的密码</span></span><br><span class="line">apksigner verify --verbose ./crackme02-signed.apk <span class="comment">#验证是否签名</span></span><br><span class="line">apksigner verify --print-certs ./crackme02-signed.apk <span class="comment">#查看签名证书</span></span><br></pre></td></tr></table></figure>

<p>对于apksigner其他参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--v1-signing-enabled 使用jar包签名方式</span><br><span class="line">--v2-signing-enabled 使用全apk包签名方式</span><br></pre></td></tr></table></figure>

<p>v1版本签名方案便利apk中左右条目，提取处包中文件消息摘要并写入MANIFEST.MF中，对后者二次摘要生成CERT.SF并用私钥对后者签名，仨文件一块打包保存到META-INF文件夹中。v2签名方案验证归档中所有字节，并在原apk块中增加一个新签名块用于存储签名、摘要、签名算法、证书链等属性信息。v2支持将apk分割成小块，分别计算小块摘要，再计算最终摘要。v1和v2可共存，有v2签名块则必须通过v2校验流程，否则降级v1签名降级流程。</p>
<p>对于Apktool的解包时，-r或--no-res在反编译时不处理resource.arsc和AndroidManifest.xml，适用于只需要Dex或资源文件解码错误，二次打包时资源文件将原封不动打回去。-s或--no-src指定反编译时Dex不被反编译为Smali，只解码resource.arsc和AndroidManifest.xml。</p>
<h3 id="Dalvik字节码生成"><a href="#Dalvik字节码生成" class="headerlink" title="Dalvik字节码生成"></a>Dalvik字节码生成</h3><p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Hello.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">foo</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (a+b)*(a-b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argc)</span>&#123;</span><br><span class="line">        Hello hello=<span class="keyword">new</span> <span class="title class_">Hello</span>();</span><br><span class="line">        System.out.println(hello.foo(<span class="number">5</span>,<span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译为Java字节码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">javac Hello.java <span class="comment">#编译为Hello.class文件</span></span><br><span class="line">d8 --output . ./Hello.class <span class="comment">#编译为classes.dex文件</span></span><br><span class="line">javap ./Hello.class <span class="comment">#反编译.dex文件为java源码</span></span><br><span class="line">javap -c ./Hello.class <span class="comment">#反编译.dex文件为java字节码</span></span><br></pre></td></tr></table></figure>

<p>结果有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Compiled from &quot;Hello.java&quot;</span><br><span class="line">public class Hello &#123;</span><br><span class="line">  public Hello();</span><br><span class="line">    Code:</span><br><span class="line">       0: aload_0</span><br><span class="line">       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">       4: return</span><br><span class="line"></span><br><span class="line">  public int foo(int, int);</span><br><span class="line">    Code:</span><br><span class="line">       0: iload_1</span><br><span class="line">       1: iload_2</span><br><span class="line">       2: iadd</span><br><span class="line">       3: iload_1</span><br><span class="line">       4: iload_2</span><br><span class="line">       5: isub</span><br><span class="line">       6: imul</span><br><span class="line">       7: ireturn</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    Code:</span><br><span class="line">       0: new           #7                  // class Hello</span><br><span class="line">       3: dup</span><br><span class="line">       4: invokespecial #9                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">       7: astore_1</span><br><span class="line">       8: getstatic     #10                 // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      11: aload_1</span><br><span class="line">      12: iconst_5</span><br><span class="line">      13: iconst_3</span><br><span class="line">      14: invokevirtual #16                 // Method foo:(II)I</span><br><span class="line">      17: invokevirtual #20                 // Method java/io/PrintStream.println:(I)V</span><br><span class="line">      20: return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看Dalvik字节码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dexdump -d ./classes.dex</span><br></pre></td></tr></table></figure>

<p>结果有删减：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Processing &#x27;./classes.dex&#x27;...</span><br><span class="line">Opened &#x27;./classes.dex&#x27;, DEX version &#x27;035&#x27;</span><br><span class="line">Class #0            -</span><br><span class="line">  Class descriptor  : &#x27;LHello;&#x27;</span><br><span class="line">  Access flags      : 0x0001 (PUBLIC)</span><br><span class="line">  Superclass        : &#x27;Ljava/lang/Object;&#x27;</span><br><span class="line">  Interfaces        -</span><br><span class="line">  Static fields     -</span><br><span class="line">  Instance fields   -</span><br><span class="line">  Direct methods    -</span><br><span class="line">    #0              : (in LHello;)</span><br><span class="line">      name          : &#x27;&lt;init&gt;&#x27;</span><br><span class="line">      type          : &#x27;()V&#x27;</span><br><span class="line">      access        : 0x10001 (PUBLIC CONSTRUCTOR)</span><br><span class="line">      code          -</span><br><span class="line">      registers     : 1</span><br><span class="line">      ins           : 1</span><br><span class="line">      outs          : 1</span><br><span class="line">      insns size    : 4 16-bit code units</span><br><span class="line">00016c:                                        |[00016c] Hello.&lt;init&gt;:()V</span><br><span class="line">00017c: 7010 0400 0000                         |0000: invoke-direct &#123;v0&#125;, Ljava/lang/Object;.&lt;init&gt;:()V // method@0004</span><br><span class="line">000182: 0e00                                   |0003: return-void</span><br><span class="line">...</span><br><span class="line">000184:                                        |[000184] Hello.main:([Ljava/lang/String;)V</span><br><span class="line">000194: 2203 0100                              |0000: new-instance v3, LHello; // type@0001</span><br><span class="line">000198: 7010 0000 0300                         |0002: invoke-direct &#123;v3&#125;, LHello;.&lt;init&gt;:()V // method@0000</span><br><span class="line">00019e: 6200 0000                              |0005: sget-object v0, Ljava/lang/System;.out:Ljava/io/PrintStream; // field@0000</span><br><span class="line">0001a2: 1251                                   |0007: const/4 v1, #int 5 // #5</span><br><span class="line">0001a4: 1232                                   |0008: const/4 v2, #int 3 // #3</span><br><span class="line">0001a6: 6e30 0100 1302                         |0009: invoke-virtual &#123;v3, v1, v2&#125;, LHello;.foo:(II)I // method@0001</span><br><span class="line">0001ac: 0a03                                   |000c: move-result v3</span><br><span class="line">0001ae: 6e20 0300 3000                         |000d: invoke-virtual &#123;v0, v3&#125;, Ljava/io/PrintStream;.println:(I)V // method@0003</span><br><span class="line">0001b4: 0e00                                   |0010: return-void</span><br><span class="line">...</span><br><span class="line">000150:                                        |[000150] Hello.foo:(II)I</span><br><span class="line">000160: 9000 0203                              |0000: add-int v0, v2, v3</span><br><span class="line">000164: b132                                   |0002: sub-int/2addr v2, v3</span><br><span class="line">000166: 9200 0002                              |0003: mul-int v0, v0, v2</span><br><span class="line">00016a: 0f00                                   |0005: return v0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>还有用BakSmali进行反汇编：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">baksmali d ./classes.dex <span class="comment">#输出在out文件夹中</span></span><br></pre></td></tr></table></figure>

<p>结果有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">.class public LHello;</span><br><span class="line">.super Ljava/lang/Object;</span><br><span class="line">.source &quot;Hello.java&quot;</span><br><span class="line"></span><br><span class="line"># direct methods</span><br><span class="line">.method public constructor &lt;init&gt;()V</span><br><span class="line">    .registers 1</span><br><span class="line">    </span><br><span class="line">    .line 1</span><br><span class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class="line">    return-void</span><br><span class="line">.end method</span><br><span class="line"></span><br><span class="line">.method public static main([Ljava/lang/String;)V</span><br><span class="line">    .registers 4</span><br><span class="line"></span><br><span class="line">    .line 6</span><br><span class="line">    new-instance p0, LHello;</span><br><span class="line">    invoke-direct &#123;p0&#125;, LHello;-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">    .line 7</span><br><span class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</span><br><span class="line">    const/4 v1, 0x5</span><br><span class="line">    const/4 v2, 0x3</span><br><span class="line">    invoke-virtual &#123;p0, v1, v2&#125;, LHello;-&gt;foo(II)I</span><br><span class="line">    move-result p0</span><br><span class="line">    invoke-virtual &#123;v0, p0&#125;, Ljava/io/PrintStream;-&gt;println(I)V</span><br><span class="line"></span><br><span class="line">    .line 8</span><br><span class="line">    return-void</span><br><span class="line">.end method</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># virtual methods</span><br><span class="line">.method public foo(II)I</span><br><span class="line">    .registers 4</span><br><span class="line"></span><br><span class="line">    .line 3</span><br><span class="line">    add-int v0, p1, p2</span><br><span class="line">    sub-int/2addr p1, p2</span><br><span class="line">    mul-int v0, v0, p1</span><br><span class="line">    return v0</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>除了BakSmali还有Dedexer：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ddx -d . ./classes.dex <span class="comment">#输出Hello.ddx 用记事本打开就行</span></span><br></pre></td></tr></table></figure>

<p>结果有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">.class public Hello</span><br><span class="line">.super java/lang/Object</span><br><span class="line">.source Hello.java</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.method public &lt;init&gt;()V</span><br><span class="line">.limit registers 1</span><br><span class="line">; this: v0 (LHello;)</span><br><span class="line">.line 1</span><br><span class="line">    invoke-direct    &#123;v0&#125;,java/lang/Object/&lt;init&gt;    ; &lt;init&gt;()V</span><br><span class="line">    return-void    </span><br><span class="line">.end method</span><br><span class="line"></span><br><span class="line">.method public static main([Ljava/lang/String;)V</span><br><span class="line">.limit registers 4</span><br><span class="line">; parameter[0] : v3 ([Ljava/lang/String;)</span><br><span class="line">.line 6</span><br><span class="line">    new-instance    v3,Hello</span><br><span class="line">    invoke-direct    &#123;v3&#125;,Hello/&lt;init&gt;    ; &lt;init&gt;()V</span><br><span class="line">.line 7</span><br><span class="line">    sget-object    v0,java/lang/System.out Ljava/io/PrintStream;</span><br><span class="line">    const/4    v1,5</span><br><span class="line">    const/4    v2,3</span><br><span class="line">    invoke-virtual    &#123;v3,v1,v2&#125;,Hello/foo    ; foo(II)I</span><br><span class="line">    move-result    v3</span><br><span class="line">    invoke-virtual    &#123;v0,v3&#125;,java/io/PrintStream/println    ; println(I)V</span><br><span class="line">.line 8</span><br><span class="line">    return-void    </span><br><span class="line">.end method</span><br><span class="line"></span><br><span class="line">.method public foo(II)I</span><br><span class="line">.limit registers 4</span><br><span class="line">; this: v1 (LHello;)</span><br><span class="line">; parameter[0] : v2 (I)</span><br><span class="line">; parameter[1] : v3 (I)</span><br><span class="line">.line 3</span><br><span class="line">    add-int    v0,v2,v3</span><br><span class="line">    sub-int/2addr    v2,v3</span><br><span class="line">    mul-int    v0,v0,v2</span><br><span class="line">    return    v0</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>再编写HelloWorld.smali：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">.class public LHelloWorld;</span><br><span class="line">.super Ljava/lang/Object;</span><br><span class="line">.method public static main([Ljava/lang/String;)V</span><br><span class="line">    .registers 4</span><br><span class="line">    .prologue</span><br><span class="line">    #空指令</span><br><span class="line">    nop</span><br><span class="line">    nop</span><br><span class="line">    nop</span><br><span class="line">    nop</span><br><span class="line">    #数据定义指令</span><br><span class="line">    const/16 v0, 0x8</span><br><span class="line">    const/4 v1, 0x5</span><br><span class="line">    const/4 v2, 0x3</span><br><span class="line">    #数据操作指令</span><br><span class="line">    move v1, v2</span><br><span class="line">    #数组操作指令</span><br><span class="line">    new-array v0, v0, [I</span><br><span class="line">    array-length v1, v0</span><br><span class="line">    #实例操作指令</span><br><span class="line">    new-instance v1, Ljava/lang/StringBuilder;</span><br><span class="line">    #方法调用指令</span><br><span class="line">    invoke-direct &#123;v1&#125;, Ljava/lang/StringBuilder;-&gt;&lt;init&gt;()V</span><br><span class="line">    #跳转指令</span><br><span class="line">    if-nez v0, :cond_0</span><br><span class="line">    goto :goto_0</span><br><span class="line">    :cond_0</span><br><span class="line">    #数据转换指令</span><br><span class="line">    int-to-float v2, v2</span><br><span class="line">    #数据运算指令</span><br><span class="line">    add-float v2, v2, v2</span><br><span class="line">    #比较指令</span><br><span class="line">    cmpl-float v0, v2, v2</span><br><span class="line">    #字段操作指令</span><br><span class="line">    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;</span><br><span class="line">    const-string v1, &quot;Hello World&quot; #构造字符串</span><br><span class="line">    #方法调用指令</span><br><span class="line">    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</span><br><span class="line">    #返回指令</span><br><span class="line">    :goto_0</span><br><span class="line">    return-void</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>将HelloWorld.smali编译为out.dex：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smali assemble ./HelloWorld.smali</span><br></pre></td></tr></table></figure>

<h2 id="NDK开发入门"><a href="#NDK开发入门" class="headerlink" title="NDK开发入门"></a>NDK开发入门</h2><p>不需要Android Studio啥的，直接新建MainActivity.java：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test.example;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"><span class="keyword">import</span> android.widget.LinearLayout;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span>&#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;jni_test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        LinearLayout lla=<span class="keyword">new</span> <span class="title class_">LinearLayout</span>(<span class="built_in">this</span>);</span><br><span class="line">        Button b=<span class="keyword">new</span> <span class="title class_">Button</span>(<span class="built_in">this</span>);</span><br><span class="line">        b.setText(<span class="string">&quot;click&quot;</span>);</span><br><span class="line">        lla.addView(b);</span><br><span class="line">        <span class="built_in">this</span>.setContentView(lla);</span><br><span class="line">        <span class="keyword">final</span> Activity _this=<span class="built_in">this</span>;</span><br><span class="line">        b.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span>&#123;</span><br><span class="line">                Toast.makeText(_this,stringFromJNI(),Toast.LENGTH_LONG).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac --class-path=D:\AndroidSDK\platforms\android-34\android.jar -d . ./MainActivity.java <span class="comment">#生成class文件 生成test文件夹</span></span><br><span class="line">javac -h ./test/example/jni -classpath D:\AndroidSDK\platforms\android-34\android.jar -d . ./MainActivity.java <span class="comment">#生成h头文件</span></span><br></pre></td></tr></table></figure>

<p>此时在.&#x2F;test&#x2F;example&#x2F;jni目录下生成头文件test_example_MainActivity.h，并在该目录下新建jni.c文件：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;test_example_MainActivity.h&quot;</span></span></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_test_example_MainActivity_stringFromJNI</span><span class="params">(JNIEnv* env,jobject _this)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;<span class="built_in">NewStringUTF</span>(env,<span class="string">&quot;return from c&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同目录下再新建Android.mk文件，声明如何编译动态链接库：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:=<span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE:=jni_test</span><br><span class="line">LOCAL_SRC_FILES:=jni.c</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span></span><br></pre></td></tr></table></figure>

<p>在同目录下编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="built_in">test</span>/example/jni</span><br><span class="line">ndk-build</span><br></pre></td></tr></table></figure>

<p>此时在.&#x2F;test&#x2F;example&#x2F;libs目录会生成各种架构的动态链接库。</p>
<p>当某个.so文件在运行时发生异常，<code>adb logcat</code>将会记录下来。通过查看日志找到.so发生错误的PC寄存器值和.so文件offset后，可用addr2line来定位对应c语言行数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llvm-addr2line -C -f -e *.so XXXXXXXXXXXXXXXX <span class="comment">#后面参数为pc寄存器+动态链接库offset</span></span><br></pre></td></tr></table></figure>

<p>可用readelf查看ELF格式文件信息，能看好多信息，这里举例文件头信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; llvm-readelf -h ./libjni_test.so</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian #2补码 小端序</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              DYN (Shared object file)</span></span><br><span class="line"><span class="string">  Machine:                           AArch64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x0 #入口点地址</span></span><br><span class="line"><span class="string">  Start of program headers:          64 (bytes into file) #程序头起点</span></span><br><span class="line"><span class="string">  Start of section headers:          2624 (bytes into file) #section段头部起点</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes) #头部大小</span></span><br><span class="line"><span class="string">  Size of program headers:           56 (bytes) #程序头部大小</span></span><br><span class="line"><span class="string">  Number of program headers:         8 #程序头部数量</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes) #section段头部大小</span></span><br><span class="line"><span class="string">  Number of section headers:         23 #section段头部数量</span></span><br><span class="line"><span class="string">  Section header string table index: 22 #section段头部字符表索引</span></span><br></pre></td></tr></table></figure>

<h2 id="Dalvik汇编-Smali字节码"><a href="#Dalvik汇编-Smali字节码" class="headerlink" title="Dalvik汇编&#x2F;Smali字节码"></a>Dalvik汇编&#x2F;Smali字节码</h2><h3 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h3><p>Smali&#x2F;bakSmali是Android的Java VM实现dalvik使用的Dex格式的汇编&#x2F;反汇编程序。对应Java基础类型有：</p>
<table>
<thead>
<tr>
<th>Java</th>
<th>Smali</th>
</tr>
</thead>
<tbody><tr>
<td>void</td>
<td>V</td>
</tr>
<tr>
<td>boolean</td>
<td>Z</td>
</tr>
<tr>
<td>byte</td>
<td>B</td>
</tr>
<tr>
<td>short</td>
<td>S</td>
</tr>
<tr>
<td>char</td>
<td>C</td>
</tr>
<tr>
<td>int</td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td>J</td>
</tr>
<tr>
<td>float</td>
<td>F</td>
</tr>
<tr>
<td>double</td>
<td>D</td>
</tr>
</tbody></table>
<p>语法关键词有：</p>
<table>
<thead>
<tr>
<th>关键词</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>.class</code></td>
<td>定义Java类名</td>
</tr>
<tr>
<td><code>.super</code></td>
<td>定义父类名</td>
</tr>
<tr>
<td><code>.source</code></td>
<td>定义Java源文件名</td>
</tr>
<tr>
<td><code>.field</code></td>
<td>定义字段</td>
</tr>
<tr>
<td><code>.method</code></td>
<td>定义方法</td>
</tr>
<tr>
<td><code>.end method</code></td>
<td>定义方法结束</td>
</tr>
<tr>
<td><code>.annotation</code></td>
<td>定义注释</td>
</tr>
<tr>
<td><code>.end annotation</code></td>
<td>定义注释结束</td>
</tr>
<tr>
<td><code>.implements</code></td>
<td>定义接口指令</td>
</tr>
<tr>
<td><code>.local</code></td>
<td>方法内局部变量个数</td>
</tr>
<tr>
<td><code>.registers</code></td>
<td>方法内使用寄存器的总数</td>
</tr>
<tr>
<td><code>.prologue</code></td>
<td>方法中代码开始处</td>
</tr>
<tr>
<td><code>.line</code></td>
<td>Java源文件中指定行</td>
</tr>
<tr>
<td><code>.parameter</code></td>
<td>方法参数</td>
</tr>
</tbody></table>
<p>Smali字段表示方法如<code>Ljava/lang/String</code>。表述参数类型时若有多个，如int,int,String可表示为<code>IILjava/lang/String</code>。对于数组String[]、int[][]可表示为<code>[Ljava/lang/String</code>、<code>[[I</code>。多维数组维数最大为255个。</p>
<p>常见参数语法约定有：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>vX</td>
<td>寄存器</td>
</tr>
<tr>
<td>#+X</td>
<td>常量数字</td>
</tr>
<tr>
<td>+X</td>
<td>相对指令的地址偏移</td>
</tr>
<tr>
<td>kind@X</td>
<td>常量池索引值</td>
</tr>
</tbody></table>
<p>上述“kind”表示常量池类型，可以是字符串常量池索引string、类型常量池索引type、字段常量池索引field、方法常量池索引meth。</p>
<p>例如方法格式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// methd(I[[IILjava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;</span></span><br><span class="line">String <span class="title function_">method</span><span class="params">(<span class="type">int</span>,<span class="type">int</span>[][],<span class="type">int</span>,String,Object[])</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>BakSmali版在<code>.method</code>指令前可能有<code># virtual method</code>表示虚方法，<code># direct methods</code>表示直接方法。BakSmali字段以<code>.field</code>开头，<code># instance field</code>表示实例字段，<code># static field</code>表示静态字段。</p>
<p>实例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># BakSmali版</span><br><span class="line"># virtual methods</span><br><span class="line">.method public foo(II)I</span><br><span class="line">    .register 5</span><br><span class="line">    .parameter</span><br><span class="line">    .parameter</span><br><span class="line">    .prologue</span><br><span class="line">    .line 3</span><br><span class="line">    add-int v0,p1,p2</span><br><span class="line">    sub-int v1,p1,p2</span><br><span class="line">    mul-int/2addr v0,v1</span><br><span class="line">    return v0</span><br><span class="line">.end method</span><br><span class="line"></span><br><span class="line">; Dedexer版</span><br><span class="line">.method public foo(II)I</span><br><span class="line">.limit registers 5</span><br><span class="line">; this: v2 (LHello;)</span><br><span class="line">; parameter[0] : v3 (I)</span><br><span class="line">; parameter[1] : v4 (I)</span><br><span class="line">.line 3</span><br><span class="line">    add-int v0,v3,v4</span><br><span class="line">    sub-int v1,v3,v4</span><br><span class="line">    mul-int/2addr v0,v1</span><br><span class="line">    return v0</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<h3 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h3><p>Dalvik虚拟机中每个寄存器都32位的，64位常规类型添加<code>-wide</code>后缀。特殊类型字节码根据具体类型添加后缀，可以是<code>-boolean</code>、<code>-byte</code>、<code>-char</code>、<code>-short</code>、<code>-int</code>、<code>-long</code>、<code>-float</code>、<code>-double</code>、<code>-object</code>、<code>-string</code>、<code>-class</code>、<code>-void</code>。宽度值中每个大写字母表示4位。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move-wide/from16 vAA,vBBBB</span><br></pre></td></tr></table></figure>

<p>move位基础字节码。wide位名称后缀。from16位字节码后缀，标识源位一个16位寄存器引用变量。vAA和vBBBB分别为目的寄存器和源寄存器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">nop #空操作指令 值00</span><br><span class="line"></span><br><span class="line">move vA,vB #将vB寄存器值赋给vA寄存器</span><br><span class="line">move/from16 vAA,vBBBB</span><br><span class="line">move/16 vAAAA,vBBBB</span><br><span class="line">move-wide vA,vB</span><br><span class="line">move-wide/from16 vAA,vBBBB</span><br><span class="line">move-object vA,vB</span><br><span class="line">move-object/from16 vAA,vBBBB</span><br><span class="line">move-object vA,vB</span><br><span class="line">move-object/from16 vAA,vBBBB</span><br><span class="line">move-object/16 vAAAA,vBBBB</span><br><span class="line">move-result vAA #将上个invoke类型指令操作的单字节非对象结果赋给vAA寄存器</span><br><span class="line">move-result-wide vAA</span><br><span class="line">move-result-object vAA</span><br><span class="line">move-exception vAA #保存一个运行时发生的异常到vAA寄存器 必须异常发生时的异常处理器的一条指令 否则无效</span><br><span class="line"></span><br><span class="line">return-void</span><br><span class="line">return vAA #返回一个32位非对象类型</span><br><span class="line">return-wide vAA</span><br><span class="line">return-object vAA</span><br><span class="line"></span><br><span class="line">const/4 vA,#+B #将数值B符号扩展为32位后赋值给寄存器vA</span><br><span class="line">const/16 vAA,#+BBBB</span><br><span class="line">const vAA,#+BBBBBBBB</span><br><span class="line">const/high16 vAA,#+BBBB0000</span><br><span class="line">const-wide/16 vAA,#+BBBB</span><br><span class="line">const-wide/32 vAA,#+BBBBBBBB</span><br><span class="line">const-wide vAA,#+BBBBBBBBBBBBBBBB</span><br><span class="line">const-wide/high16 vAA,#+BBBB000000000000</span><br><span class="line">const-string vAA,string@BBBB #通过字符串索引构造一个字符串并赋给寄存器vAA</span><br><span class="line">const-string/jumbo vAA,string@BBBBBBBB</span><br><span class="line">const-class vAA,type@BBBB</span><br><span class="line">const-class/jumbo vAAAA,type@BBBBBBBB</span><br><span class="line"></span><br><span class="line">monitor-enter vAA #为指定对象获取锁</span><br><span class="line">monitor-exit vAA #释放指定对象的锁</span><br><span class="line"></span><br><span class="line">check-cast vAA,type@BBBB #将vAA中对象引用转换成指定类型 失败抛出ClassCastException异常 若B为基本类型且A为非基本类型则运行始终失败</span><br><span class="line">instance-of vA,vB,type@CCCC #判断vB对象引用是否可转换为指定类型 可以则vA赋值1 否则0</span><br><span class="line">new-instance vAA,type@BBBB #构造指定类型对象新实例 对象引用赋值给vAA type不能是数组类</span><br><span class="line">check-cast/jumbo vAAAA,type@BBBBBBBB</span><br><span class="line">instance-of/jumbo vAAAA,vBBBB,type@CCCCCCCC</span><br><span class="line">new-instance/jumbo vAAAA,type@BBBBBBBB</span><br><span class="line"></span><br><span class="line">array-length vA,vB #获取vB数组长度并赋值给vA</span><br><span class="line">new-array vA,vB,type@CCCC #构造type类型与vB大小的数组 赋值给vA</span><br><span class="line">filled-new-array &#123;vC,vD,vE,vF,vG&#125;,type@BBBB</span><br><span class="line">filled-new-array/range &#123;vCCCC..vNNNN&#125;,type@BBBB</span><br><span class="line">fill-array-data vAA,+BBBBBBBB #用指定的B数据表填充基础类型数组vAA</span><br><span class="line">new-array/jumbo vAAAA,vBBBB,type@CCCCCCCC</span><br><span class="line">fileed-new-array/jumbo &#123;vCCCC..vNNNN&#125;,type@BBBBBBBB</span><br><span class="line"></span><br><span class="line">throw vAA #抛出vAA指定类型的异常</span><br><span class="line"></span><br><span class="line">goto +AA #无条件跳转到指定偏移处 AA不能为0</span><br><span class="line">goto/16 +AAAA</span><br><span class="line">goto/32 +AAAAAAAA</span><br><span class="line">packed-switch vAA,+BBBBBBBB #vAA为switch分支中要判断的值 B指向一个packed-switch-payload格式偏移表</span><br><span class="line">sparse-switch vAA,+BBBBBBBB #同上 B指向sparse-switch-payload格式偏移表</span><br><span class="line"></span><br><span class="line">if-eq vA,vB,+CCCC #若vA==vB则跳转C偏移处</span><br><span class="line">if-ne vA,vB,+CCCC #!=</span><br><span class="line">if-lt vA,vB,+CCCC #&lt;</span><br><span class="line">if-ge vA,vB,+CCCC #&gt;=</span><br><span class="line">if-gt vA,vB,+CCCC #&gt;</span><br><span class="line">if-le vA,vB,+CCCC #&lt;=</span><br><span class="line">if-eqz vA,vB,+CCCC #vAA==0</span><br><span class="line">if-nez vA,vB,+CCCC #vAA!=0</span><br><span class="line">if-ltz vA,vB,+CCCC #vAA&lt;0</span><br><span class="line">if-gez vA,vB,+CCCC #vAA&gt;=0</span><br><span class="line">if-gtz vA,vB,+CCCC #vAA&gt;0</span><br><span class="line">if-lez vA,vB,+CCCC #vAA&lt;=0</span><br><span class="line"></span><br><span class="line">cmpl-float vAA,vBB,vCC #vBB&gt;vCC则vA为-1 相等0 小于1</span><br><span class="line">cmpg-float vAA,vBB,vCC #vBB&gt;vCC则vA为1 相等0 小于-1</span><br><span class="line">cmpl-double vAA,vBB,vCC</span><br><span class="line">cmpg-double vAA,vBB,vCC</span><br><span class="line">cmp-long vAA,vBB,vCC #vBB&gt;vCC则vA为1 相等0 小于-1</span><br><span class="line"></span><br><span class="line">i* vA,vB,field@CCCC #普通字段</span><br><span class="line">s* vAA,field@BBBB #静态字段</span><br><span class="line"></span><br><span class="line">invoke-virtual &#123;vC,vD,vE,vF,vG&#125;,meth@BBBB #调用实例虚方法</span><br><span class="line">invoke-super &#123;vC,vD,vE,vF,vG&#125;,meth@BBBB #调用实例父方法</span><br><span class="line">invoke-direct &#123;vC,vD,vE,vF,vG&#125;,meth@BBBB #调用实例直接方法</span><br><span class="line">invoke-static &#123;vC,vD,vE,vF,vG&#125;,meth@BBBB #调用实例静态方法</span><br><span class="line">invoke-interface &#123;vC,vD,vE,vF,vG&#125;,meth@BBBB #调用实例接口方法</span><br><span class="line">invoke-*/range &#123;vCCCC..vNNNN&#125;,meth@BBBB</span><br><span class="line">invoke-*/jumbo &#123;vCCCC..vNNNN&#125;,meth@BBBBBBBB</span><br><span class="line"></span><br><span class="line">neg-int vA,vB #vB转换类型到vA 求补</span><br><span class="line">not-int vA,vB #求反</span><br><span class="line">#其他：neg-long not-long neg-float neg-double int-to-long int-to-float int-to-double long-to-int long-to-float long-to-double float-to-int float-to-long float-to-double double-to-int double-to-long double-to-float int-to-byte int-to-char int-to-short</span><br><span class="line"></span><br><span class="line">add-* vAA,vBB,vCC #vAA=vBB+vCC</span><br><span class="line">#其他：sub-* mul-* div-* rem-* and-* or-* xor-* shl-* shr-* ushr-* 后面类型可以是-int -long -float -double</span><br><span class="line">*/2addr vA,vB #vA=vA运算vB</span><br><span class="line">*/lit116 vA,vB,#+CCCC #vA=vB运算C</span><br><span class="line">*/lit8 vAA,vBB,#+CC #vAA=vBB运算C</span><br></pre></td></tr></table></figure>

<h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3><p>smali文件头格式为：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.class &lt;访问权限&gt; [修饰关键字] &lt;类名&gt;</span><br><span class="line">.super &lt;父类名&gt;</span><br><span class="line">.source &lt;源文件名&gt;</span><br></pre></td></tr></table></figure>

<p>访问权限可以是public、private、protected之一，修饰关键字可以是synthetic等。例如MainActivity.smali前3行为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.class public Lcom/droider/crackme0502/MainActivity;</span><br><span class="line">.super Landroid/app/Activity;</span><br><span class="line">.source &quot;MainActivity.java&quot;</span><br></pre></td></tr></table></figure>

<p>两种实例声明格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#static fields</span><br><span class="line">.field &lt;访问权限&gt; static [修饰关键字] &lt;字段名&gt;:&lt;字段类型&gt;</span><br><span class="line"></span><br><span class="line">#instance fields</span><br><span class="line">.field &lt;访问权限&gt; [修饰关键字] &lt;字段名&gt;:&lt;字段类型&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># instance fields</span><br><span class="line">.field private btnAnno:Landroid/widget/Button;</span><br></pre></td></tr></table></figure>

<p>方法声明格式为：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#direct methods</span><br><span class="line">.method &lt;访问权限&gt; [修饰关键字] &lt;方法原型&gt;</span><br><span class="line">    &lt;.locals&gt;</span><br><span class="line">    [.parameter]</span><br><span class="line">    [.prologue]</span><br><span class="line">    [.line]</span><br><span class="line">    &lt;代码体&gt;</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>虚方法声明则开头改为“virtual methods”。<code>.locals</code>指定局部变量个数，每一个<code>.parameter</code>表明使用一个参数，有几个参数则有几条<code>.parameter</code>。<code>.prologue</code>指定代码开始处。</p>
<p>接口格式为：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#interfaces</span><br><span class="line">.implements &lt;接口名&gt;</span><br></pre></td></tr></table></figure>

<p>注解格式如下。</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#annotations</span><br><span class="line">.annotation [注解属性] &lt;注解类名&gt;</span><br><span class="line">    [注解字段=值]</span><br><span class="line">.end annotation</span><br></pre></td></tr></table></figure>

<p>注解的作用范围可以是类、方法或字段。若作用范围是类，该指令直接定义在smali文件中。若是方法或字段，该指令包含在方法或字段定义中，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># instance fields</span><br><span class="line">.field public sayWhat:Ljava/lang/String;</span><br><span class="line">    .annotation runtime Lcom/droider/anno/MyAnnoField;</span><br><span class="line">        info = &quot;Hello my friend&quot;</span><br><span class="line">    .end annotation</span><br><span class="line">.end field</span><br></pre></td></tr></table></figure>

<p>转为Java代码为：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@com</span>.droider.anno <span class="title function_">MyAnnoField</span><span class="params">(info=<span class="string">&quot;Hello my friend&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> String sayWhat;</span><br></pre></td></tr></table></figure>

<h3 id="类"><a href="#类" class="headerlink" title="类"></a>类</h3><p>例如下面的类，反编译后生成Outer.smali和Outer$Inner.smali，内部类文件名格式为“[外部类]$[内部类].smali”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Outer</span>&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Inner</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有时遇到实例字段定义如下，synthetic属性表明是被编译器合成的、虚构的，而不是代码作者声明的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># instance fields</span><br><span class="line">.field final synthetic this$0:Lcom/droider/crackme0502/MainActivity;</span><br></pre></td></tr></table></figure>

<p>当内部类层数过多时，有自动保留的指向所在外部类的引用：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Outer</span> &#123; <span class="comment">//this$0</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstInner</span> &#123; <span class="comment">//this$1</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondInner</span> &#123; <span class="comment">//this$2</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThirdInner</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于一个非静态方法而言，若有两条<code>.parameter</code>语句，则实际上使用了p0~p2共3个参数寄存器。此时隐含使用p0寄存器当作类的this引用。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># direct methods</span><br><span class="line">.method public constructor &lt;init&gt;(Lcom/droider/crackme0502/MainActivity;Ljava/lang/String;)V</span><br><span class="line">    .registers 3</span><br><span class="line">    .param p2, &quot;sn&quot;    # Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    .line 83</span><br><span class="line">    iput-object p1, p0, Lcom/droider/crackme0502/MainActivity$SNChecker;-&gt;this$0:Lcom/droider/crackme0502/MainActivity;</span><br><span class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">    .line 84</span><br><span class="line">    iput-object p2, p0, Lcom/droider/crackme0502/MainActivity$SNChecker;-&gt;sn:Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">    .line 85</span><br><span class="line">    return-void</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>监听器一般用匿名内部类形式实现，例如：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># virtual methods</span><br><span class="line">.method public onCreate(Landroid/os/Bundle;)V</span><br><span class="line">    .registers 4</span><br><span class="line">    .param p1, &quot;savedInstanceState&quot;    # Landroid/os/Bundle;</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    ...</span><br><span class="line">    .line 32</span><br><span class="line">    iget-object v0, p0, Lcom/droider/crackme0502/MainActivity;-&gt;btnAnno:Landroid/widget/Button;</span><br><span class="line">    new-instance v1, Lcom/droider/crackme0502/MainActivity$1;</span><br><span class="line">    invoke-direct &#123;v1, p0&#125;, Lcom/droider/crackme0502/MainActivity$1;-&gt;&lt;init&gt;(Lcom/droider/crackme0502/MainActivity;)V</span><br><span class="line">    invoke-virtual &#123;v0, v1&#125;, Landroid/widget/Button;-&gt;setOnClickListener(Landroid/view/View$OnClickListener;)V</span><br><span class="line"></span><br><span class="line">    .line 40</span><br><span class="line">    iget-object v0, p0, Lcom/droider/crackme0502/MainActivity;-&gt;btnCheckSN:Landroid/widget/Button;</span><br><span class="line">    new-instance v1, Lcom/droider/crackme0502/MainActivity$2;</span><br><span class="line">    invoke-direct &#123;v1, p0&#125;, Lcom/droider/crackme0502/MainActivity$2;-&gt;&lt;init&gt;(Lcom/droider/crackme0502/MainActivity;)V</span><br><span class="line">    invoke-virtual &#123;v0, v1&#125;, Landroid/widget/Button;-&gt;setOnClickListener(Landroid/view/View$OnClickListener;)V</span><br><span class="line"></span><br><span class="line">    .line 50</span><br><span class="line">    return-void</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>有MemberClass注解如下，该注解为一个系统注解，为父类提供一个MemberClass子类成员列表，即内部类列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># annotations</span><br><span class="line">.annotation system Ldalvik/annotation/MemberClasses;</span><br><span class="line">    value = &#123;</span><br><span class="line">        Lcom/droider/crackme0502/MainActivity$SNChecker;</span><br><span class="line">    &#125;</span><br><span class="line">.end annotation</span><br></pre></td></tr></table></figure>

<p>有EnclosingMethod注解如下，说明整个MainActivity$1匿名类的作用范围，注解value表明它位于MainActivity的<code>onCreate</code>中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># annotations</span><br><span class="line">.annotation system Ldalvik/annotation/EnclosingMethod;</span><br><span class="line">    value = Lcom/droider/crackme0502/MainActivity;-&gt;onCreate(Landroid/os/Bundle;)V</span><br><span class="line">.end annotation</span><br></pre></td></tr></table></figure>

<p>例如还有EnclosingClass注解，value标识MainActivity$SNChecker作用于MainActivity类。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># annotations</span><br><span class="line">.annotation system Ldalvik/annotation/EnclosingClass;</span><br><span class="line">    value = Lcom/droider/crackme0502/MainActivity;</span><br><span class="line">.end annotation</span><br><span class="line"></span><br><span class="line">.annotation system Ldalvik/annotation/InnerClass;</span><br><span class="line">    accessFlags = 0x1</span><br><span class="line">    name = &quot;SNChecker&quot;</span><br><span class="line">.end annotation</span><br></pre></td></tr></table></figure>

<p>EnclosingClass后跟着InnerClass注解，其中accessFlags访问标志位一个枚举值，name位内部类名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    kDexVisibilityBuild=<span class="number">0x00</span>,</span><br><span class="line">    kDexVisibilityRuntime=<span class="number">0x01</span>, <span class="comment">//Runtime属性</span></span><br><span class="line">    kDexVisibilitySystem=<span class="number">0x02</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>若注解类在生命是提供了默认值，则程序中会用到AnnotationDefault注解：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># annotations</span><br><span class="line">.annotation system Ldalvik/annotation/AnnotationDefault;</span><br><span class="line">    value = .subannotation Lcom/droider/anno/MyAnnoClass;</span><br><span class="line">        value = &quot;MyAnnoClass&quot;</span><br><span class="line">    .end subannotation</span><br><span class="line">.end annotation</span><br></pre></td></tr></table></figure>

<p>Signature注解用于验证方法签名：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.method public onItemClick(Landroid/widget/AdapterView;Landroid/view/View;IJ)V</span><br><span class="line">    .locals 6</span><br><span class="line">    .parameter</span><br><span class="line">    .parameter &quot;v&quot;</span><br><span class="line">    .parameter &quot;position&quot;</span><br><span class="line">    .parameter &quot;id&quot;</span><br><span class="line">    .annotation system Ldalvik/annotation/Signature;</span><br><span class="line">        value=&#123;</span><br><span class="line">            &quot;(&quot;,</span><br><span class="line">            &quot;Landroid/widget/AdapterView&quot;,</span><br><span class="line">            &quot;&lt;*&gt;;&quot;,</span><br><span class="line">            &quot;Landroid/view/View;&quot;,</span><br><span class="line">            &quot;IJ)V&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    .end annotation</span><br><span class="line">    ...</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>若方法声明中使用<code>throws</code>关键字抛出异常，则生成相应Throws注解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.method public final get()Ljava/lang/Object;</span><br><span class="line">    .locals 1</span><br><span class="line">    .annotation system Ldalvik/annotation/Throws;</span><br><span class="line">        value=&#123;</span><br><span class="line">            Ljava/lang/InterruptedException;,</span><br><span class="line">            Ljava/util/concurrent/ExecutionException;</span><br><span class="line">        &#125;</span><br><span class="line">    .end annotation</span><br><span class="line">    ...</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>其对应Java代码为：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外Android SDK还自动生成一些类，有R、BuildConfig等类。R类如下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.droider.crackme0502;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* renamed from: com.droider.crackme0502.R */</span></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">C0039R</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: com.droider.crackme0502.R$attr */</span></span><br><span class="line">    <span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">attr</span> &#123; <span class="comment">//属性</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: com.droider.crackme0502.R$dimen */</span></span><br><span class="line">    <span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">dimen</span> &#123; <span class="comment">//尺寸</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">padding_large</span> <span class="operator">=</span> <span class="number">2130968578</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">padding_medium</span> <span class="operator">=</span> <span class="number">2130968577</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">padding_small</span> <span class="operator">=</span> <span class="number">2130968576</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: com.droider.crackme0502.R$drawable */</span></span><br><span class="line">    <span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">drawable</span> &#123; <span class="comment">//图片</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ic_action_search</span> <span class="operator">=</span> <span class="number">2130837504</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ic_launcher</span> <span class="operator">=</span> <span class="number">2130837505</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: com.droider.crackme0502.R$id */</span></span><br><span class="line">    <span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">C0040id</span> &#123; <span class="comment">//id标识</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">btn_annotation</span> <span class="operator">=</span> <span class="number">2131230720</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">btn_checksn</span> <span class="operator">=</span> <span class="number">2131230722</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">edt_sn</span> <span class="operator">=</span> <span class="number">2131230721</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">menu_settings</span> <span class="operator">=</span> <span class="number">2131230723</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: com.droider.crackme0502.R$layout */</span></span><br><span class="line">    <span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">layout</span> &#123; <span class="comment">//布局</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">activity_main</span> <span class="operator">=</span> <span class="number">2130903040</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: com.droider.crackme0502.R$menu */</span></span><br><span class="line">    <span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">menu</span> &#123; <span class="comment">//菜单</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">activity_main</span> <span class="operator">=</span> <span class="number">2131165184</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: com.droider.crackme0502.R$string */</span></span><br><span class="line">    <span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">string</span> &#123; <span class="comment">//字符串</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">app_name</span> <span class="operator">=</span> <span class="number">2131034112</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">hello_world</span> <span class="operator">=</span> <span class="number">2131034113</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">menu_settings</span> <span class="operator">=</span> <span class="number">2131034114</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">title_activity_main</span> <span class="operator">=</span> <span class="number">2131034115</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* renamed from: com.droider.crackme0502.R$style */</span></span><br><span class="line">    <span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">style</span> &#123; <span class="comment">//样式</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">AppTheme</span> <span class="operator">=</span> <span class="number">2131099648</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BuildConfig类有：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.droider.crackme0502;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BuildConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">DEBUG</span> <span class="operator">=</span> <span class="literal">true</span>; <span class="comment">//调试版本发布</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="反编译"><a href="#反编译" class="headerlink" title="反编译"></a>反编译</h3><p>例如迭代器for方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">.method private iterator()V</span><br><span class="line">    .registers 8</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    .line 34</span><br><span class="line">    const-string v4, &quot;activity&quot;</span><br><span class="line">    invoke-virtual &#123;p0, v4&#125;, Lcom/droider/circulate/MainActivity;-&gt;getSystemService(Ljava/lang/String;)Ljava/lang/Object;</span><br><span class="line">    move-result-object v0</span><br><span class="line">    check-cast v0, Landroid/app/ActivityManager;</span><br><span class="line"></span><br><span class="line">    .line 35</span><br><span class="line">    .local v0, &quot;activityManager&quot;:Landroid/app/ActivityManager;</span><br><span class="line">    invoke-virtual &#123;v0&#125;, Landroid/app/ActivityManager;-&gt;getRunningAppProcesses()Ljava/util/List;</span><br><span class="line">    move-result-object v2</span><br><span class="line"></span><br><span class="line">    .line 36</span><br><span class="line">    .local v2, &quot;psInfos&quot;:Ljava/util/List;, &quot;Ljava/util/List&lt;Landroid/app/ActivityManager$RunningAppProcessInfo;&gt;;&quot;</span><br><span class="line">    new-instance v3, Ljava/lang/StringBuilder;</span><br><span class="line">    invoke-direct &#123;v3&#125;, Ljava/lang/StringBuilder;-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">    .line 37</span><br><span class="line">    .local v3, &quot;sb&quot;:Ljava/lang/StringBuilder;</span><br><span class="line">    invoke-interface &#123;v2&#125;, Ljava/util/List;-&gt;iterator()Ljava/util/Iterator;</span><br><span class="line">    move-result-object v4</span><br><span class="line">    :goto_15</span><br><span class="line">    invoke-interface &#123;v4&#125;, Ljava/util/Iterator;-&gt;hasNext()Z</span><br><span class="line">    move-result v5</span><br><span class="line">    if-nez v5, :cond_28</span><br><span class="line"></span><br><span class="line">    .line 40</span><br><span class="line">    invoke-virtual &#123;v3&#125;, Ljava/lang/StringBuilder;-&gt;toString()Ljava/lang/String;</span><br><span class="line">    move-result-object v4</span><br><span class="line">    const/4 v5, 0x0</span><br><span class="line">    invoke-static &#123;p0, v4, v5&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class="line">    move-result-object v4</span><br><span class="line">    invoke-virtual &#123;v4&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class="line"></span><br><span class="line">    .line 41</span><br><span class="line">    return-void</span><br><span class="line"></span><br><span class="line">    .line 37</span><br><span class="line">    :cond_28</span><br><span class="line">    invoke-interface &#123;v4&#125;, Ljava/util/Iterator;-&gt;next()Ljava/lang/Object;</span><br><span class="line">    move-result-object v1</span><br><span class="line">    check-cast v1, Landroid/app/ActivityManager$RunningAppProcessInfo;</span><br><span class="line"></span><br><span class="line">    .line 38</span><br><span class="line">    .local v1, &quot;info&quot;:Landroid/app/ActivityManager$RunningAppProcessInfo;</span><br><span class="line">    new-instance v5, Ljava/lang/StringBuilder;</span><br><span class="line">    iget-object v6, v1, Landroid/app/ActivityManager$RunningAppProcessInfo;-&gt;processName:Ljava/lang/String;</span><br><span class="line">    invoke-static &#123;v6&#125;, Ljava/lang/String;-&gt;valueOf(Ljava/lang/Object;)Ljava/lang/String;</span><br><span class="line">    move-result-object v6</span><br><span class="line">    invoke-direct &#123;v5, v6&#125;, Ljava/lang/StringBuilder;-&gt;&lt;init&gt;(Ljava/lang/String;)V</span><br><span class="line">    const/16 v6, 0xa</span><br><span class="line">    invoke-virtual &#123;v5, v6&#125;, Ljava/lang/StringBuilder;-&gt;append(C)Ljava/lang/StringBuilder;</span><br><span class="line">    move-result-object v5</span><br><span class="line">    invoke-virtual &#123;v5&#125;, Ljava/lang/StringBuilder;-&gt;toString()Ljava/lang/String;</span><br><span class="line">    move-result-object v5</span><br><span class="line">    invoke-virtual &#123;v3, v5&#125;, Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">    goto :goto_15</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>反编译结果为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ActivityManager</span> <span class="variable">activityManager</span> <span class="operator">=</span> (ActivityManager) getSystemService(<span class="string">&quot;activity&quot;</span>);</span><br><span class="line">    List&lt;ActivityManager.RunningAppProcessInfo&gt; psInfos = activityManager.getRunningAppProcesses();</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (ActivityManager.RunningAppProcessInfo info : psInfos) &#123;</span><br><span class="line">        sb.append(String.valueOf(info.processName) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Toast.makeText(<span class="built_in">this</span>, sb.toString(), <span class="number">0</span>).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例如传统for方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">.method private forCirculate()V</span><br><span class="line">    .registers 9</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    .line 47</span><br><span class="line">    invoke-virtual &#123;p0&#125;, Lcom/droider/circulate/MainActivity;-&gt;getApplicationContext()Landroid/content/Context;</span><br><span class="line">    move-result-object v6</span><br><span class="line">    invoke-virtual &#123;v6&#125;, Landroid/content/Context;-&gt;getPackageManager()Landroid/content/pm/PackageManager;</span><br><span class="line">    move-result-object v3</span><br><span class="line"></span><br><span class="line">    .line 49</span><br><span class="line">    .local v3, &quot;pm&quot;:Landroid/content/pm/PackageManager;</span><br><span class="line">    const/16 v6, 0x2000</span><br><span class="line"></span><br><span class="line">    .line 48</span><br><span class="line">    invoke-virtual &#123;v3, v6&#125;, Landroid/content/pm/PackageManager;-&gt;getInstalledApplications(I)Ljava/util/List;</span><br><span class="line">    move-result-object v0</span><br><span class="line"></span><br><span class="line">    .line 50</span><br><span class="line">    .local v0, &quot;appInfos&quot;:Ljava/util/List;, &quot;Ljava/util/List&lt;Landroid/content/pm/ApplicationInfo;&gt;;&quot;</span><br><span class="line">    invoke-interface &#123;v0&#125;, Ljava/util/List;-&gt;size()I</span><br><span class="line">    move-result v5</span><br><span class="line"></span><br><span class="line">    .line 51</span><br><span class="line">    .local v5, &quot;size&quot;:I</span><br><span class="line">    new-instance v4, Ljava/lang/StringBuilder;</span><br><span class="line">    invoke-direct &#123;v4&#125;, Ljava/lang/StringBuilder;-&gt;&lt;init&gt;()V</span><br><span class="line"></span><br><span class="line">    .line 52</span><br><span class="line">    .local v4, &quot;sb&quot;:Ljava/lang/StringBuilder;</span><br><span class="line">    const/4 v1, 0x0</span><br><span class="line">    .local v1, &quot;i&quot;:I</span><br><span class="line">    :goto_18</span><br><span class="line">    if-lt v1, v5, :cond_27</span><br><span class="line">    </span><br><span class="line">    .line 56</span><br><span class="line">    invoke-virtual &#123;v4&#125;, Ljava/lang/StringBuilder;-&gt;toString()Ljava/lang/String;</span><br><span class="line">    move-result-object v6</span><br><span class="line">    const/4 v7, 0x0</span><br><span class="line">    invoke-static &#123;p0, v6, v7&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class="line">    move-result-object v6</span><br><span class="line">    invoke-virtual &#123;v6&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class="line"></span><br><span class="line">    .line 57</span><br><span class="line">    return-void</span><br><span class="line"></span><br><span class="line">    .line 53</span><br><span class="line">    :cond_27</span><br><span class="line">    invoke-interface &#123;v0, v1&#125;, Ljava/util/List;-&gt;get(I)Ljava/lang/Object;</span><br><span class="line">    move-result-object v2</span><br><span class="line">    check-cast v2, Landroid/content/pm/ApplicationInfo;</span><br><span class="line"></span><br><span class="line">    .line 54</span><br><span class="line">    .local v2, &quot;info&quot;:Landroid/content/pm/ApplicationInfo;</span><br><span class="line">    new-instance v6, Ljava/lang/StringBuilder;</span><br><span class="line">    iget-object v7, v2, Landroid/content/pm/ApplicationInfo;-&gt;packageName:Ljava/lang/String;</span><br><span class="line">    invoke-static &#123;v7&#125;, Ljava/lang/String;-&gt;valueOf(Ljava/lang/Object;)Ljava/lang/String;</span><br><span class="line">    move-result-object v7</span><br><span class="line">    invoke-direct &#123;v6, v7&#125;, Ljava/lang/StringBuilder;-&gt;&lt;init&gt;(Ljava/lang/String;)V</span><br><span class="line">    const/16 v7, 0xa</span><br><span class="line">    invoke-virtual &#123;v6, v7&#125;, Ljava/lang/StringBuilder;-&gt;append(C)Ljava/lang/StringBuilder;</span><br><span class="line">    move-result-object v6</span><br><span class="line">    invoke-virtual &#123;v6&#125;, Ljava/lang/StringBuilder;-&gt;toString()Ljava/lang/String;</span><br><span class="line">    move-result-object v6</span><br><span class="line">    invoke-virtual &#123;v4, v6&#125;, Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line"></span><br><span class="line">    .line 52</span><br><span class="line">    add-int/lit8 v1, v1, 0x1</span><br><span class="line">    goto :goto_18</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>反编译结果为：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">forCirculate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> getApplicationContext().getPackageManager();</span><br><span class="line">    List&lt;ApplicationInfo&gt; appInfos = pm.getInstalledApplications(<span class="number">8192</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> appInfos.size();</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="type">ApplicationInfo</span> <span class="variable">info</span> <span class="operator">=</span> appInfos.get(i);</span><br><span class="line">        sb.append(String.valueOf(info.packageName) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Toast.makeText(<span class="built_in">this</span>, sb.toString(), <span class="number">0</span>).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>switch语句有两种不同的Smali表现形式，分别为packedSwitch和sparseSwitch。例如packedSwitch形式：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">.method private packedSwitch(I)Ljava/lang/String;</span><br><span class="line">    .registers 3</span><br><span class="line">    .param p1, &quot;i&quot;    # I</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    .line 21</span><br><span class="line">    const/4 v0, 0x0</span><br><span class="line"></span><br><span class="line">    .line 22</span><br><span class="line">    .local v0, &quot;str&quot;:Ljava/lang/String;</span><br><span class="line">    packed-switch p1, :pswitch_data_14</span><br><span class="line"></span><br><span class="line">    .line 36</span><br><span class="line">    const-string v0, &quot;she is a person&quot;</span><br><span class="line"></span><br><span class="line">    .line 39</span><br><span class="line">    :goto_6</span><br><span class="line">    return-object v0</span><br><span class="line"></span><br><span class="line">    .line 24</span><br><span class="line">    :pswitch_7</span><br><span class="line">    const-string v0, &quot;she is a baby&quot;</span><br><span class="line"></span><br><span class="line">    .line 25</span><br><span class="line">    goto :goto_6</span><br><span class="line"></span><br><span class="line">    .line 27</span><br><span class="line">    :pswitch_a</span><br><span class="line">    const-string v0, &quot;she is a girl&quot;</span><br><span class="line"></span><br><span class="line">    .line 28</span><br><span class="line">    goto :goto_6</span><br><span class="line"></span><br><span class="line">    .line 30</span><br><span class="line">    :pswitch_d</span><br><span class="line">    const-string v0, &quot;she is a woman&quot;</span><br><span class="line"></span><br><span class="line">    .line 31</span><br><span class="line">    goto :goto_6</span><br><span class="line"></span><br><span class="line">    .line 33</span><br><span class="line">    :pswitch_10</span><br><span class="line">    const-string v0, &quot;she is an obasan&quot;</span><br><span class="line"></span><br><span class="line">    .line 34</span><br><span class="line">    goto :goto_6</span><br><span class="line"></span><br><span class="line">    .line 22</span><br><span class="line">    nop</span><br><span class="line"></span><br><span class="line">    :pswitch_data_14</span><br><span class="line">    .packed-switch 0x0</span><br><span class="line">        :pswitch_7</span><br><span class="line">        :pswitch_a</span><br><span class="line">        :pswitch_d</span><br><span class="line">        :pswitch_10</span><br><span class="line">    .end packed-switch</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>packed-switch指令前面讲过，结构格式如下，用二进制编辑器可分析.dex文件，这里不展开。</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">packed</span>-<span class="keyword">switch</span>-payload &#123;</span><br><span class="line">    ushort ident; <span class="comment">//固定0x0100</span></span><br><span class="line">    ushort size; <span class="comment">//case数目</span></span><br><span class="line">    <span class="type">int</span> first_key; <span class="comment">//初始case值</span></span><br><span class="line">    <span class="type">int</span>[] targets; <span class="comment">//每个case相对switch指令处偏移</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>反汇编结果为：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">packedSwitch</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;she is a baby&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;she is a girl&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;she is a woman&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;she is an obasan&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;she is a person&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sparseSwitch形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">.method private sparseSwitch(I)Ljava/lang/String;</span><br><span class="line">    .registers 3</span><br><span class="line">    .param p1, &quot;age&quot;    # I</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    .line 43</span><br><span class="line">    const/4 v0, 0x0</span><br><span class="line"></span><br><span class="line">    .line 44</span><br><span class="line">    .local v0, &quot;str&quot;:Ljava/lang/String;</span><br><span class="line">    sparse-switch p1, :sswitch_data_14</span><br><span class="line"></span><br><span class="line">    .line 58</span><br><span class="line">    const-string v0, &quot;he is a person&quot;</span><br><span class="line"></span><br><span class="line">    .line 61</span><br><span class="line">    :goto_6</span><br><span class="line">    return-object v0</span><br><span class="line"></span><br><span class="line">    .line 46</span><br><span class="line">    :sswitch_7</span><br><span class="line">    const-string v0, &quot;he is a baby&quot;</span><br><span class="line"></span><br><span class="line">    .line 47</span><br><span class="line">    goto :goto_6</span><br><span class="line"></span><br><span class="line">    .line 49</span><br><span class="line">    :sswitch_a</span><br><span class="line">    const-string v0, &quot;he is a student&quot;</span><br><span class="line"></span><br><span class="line">    .line 50</span><br><span class="line">    goto :goto_6</span><br><span class="line"></span><br><span class="line">    .line 52</span><br><span class="line">    :sswitch_d</span><br><span class="line">    const-string v0, &quot;he is a father&quot;</span><br><span class="line"></span><br><span class="line">    .line 53</span><br><span class="line">    goto :goto_6</span><br><span class="line"></span><br><span class="line">    .line 55</span><br><span class="line">    :sswitch_10</span><br><span class="line">    const-string v0, &quot;he is a grandpa&quot;</span><br><span class="line"></span><br><span class="line">    .line 56</span><br><span class="line">    goto :goto_6</span><br><span class="line"></span><br><span class="line">    .line 44</span><br><span class="line">    nop</span><br><span class="line"></span><br><span class="line">    :sswitch_data_14</span><br><span class="line">    .sparse-switch</span><br><span class="line">        0x5 -&gt; :sswitch_7</span><br><span class="line">        0xf -&gt; :sswitch_a</span><br><span class="line">        0x23 -&gt; :sswitch_d</span><br><span class="line">        0x41 -&gt; :sswitch_10</span><br><span class="line">    .end sparse-switch</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>sparse-switch指令上面也讲过，格式为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sparse</span>-<span class="keyword">switch</span>-payload&#123;</span><br><span class="line">    ushort ident; <span class="comment">//固定0x0200</span></span><br><span class="line">    ushort size; <span class="comment">//case数目</span></span><br><span class="line">    <span class="type">int</span>[] keys; <span class="comment">//每个case值 从低到高</span></span><br><span class="line">    <span class="type">int</span>[] targets; <span class="comment">//每个case相对switch指令处偏移</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>对于try&#x2F;catch语句有：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">.method private tryCatch(ILjava/lang/String;)V</span><br><span class="line">    .registers 13</span><br><span class="line">    .param p1, &quot;drumsticks&quot;    # I</span><br><span class="line">    .param p2, &quot;peple&quot;    # Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">    .prologue</span><br><span class="line">    const/4 v9, 0x0</span><br><span class="line"></span><br><span class="line">    .line 19</span><br><span class="line">    :try_start_1</span><br><span class="line">    invoke-static &#123;p2&#125;, Ljava/lang/Integer;-&gt;parseInt(Ljava/lang/String;)I</span><br><span class="line">    :try_end_4</span><br><span class="line">    .catch Ljava/lang/NumberFormatException; &#123;:try_start_1 .. :try_end_4&#125; :catch_45</span><br><span class="line">    move-result v1</span><br><span class="line"></span><br><span class="line">    .line 21</span><br><span class="line">    .local v1, &quot;i&quot;:I</span><br><span class="line">    :try_start_5</span><br><span class="line">    div-int v2, p1, v1</span><br><span class="line"></span><br><span class="line">    .line 22</span><br><span class="line">    .local v2, &quot;m&quot;:I</span><br><span class="line">    mul-int v5, v2, v1</span><br><span class="line">    sub-int v3, p1, v5</span><br><span class="line"></span><br><span class="line">    .line 23</span><br><span class="line">    .local v3, &quot;n&quot;:I</span><br><span class="line">    const-string v5, &quot;共有%d只鸡腿，%d个人平分，每人可分得%d只，还剩下%d只&quot;</span><br><span class="line">    const/4 v6, 0x4</span><br><span class="line">    new-array v6, v6, [Ljava/lang/Object;</span><br><span class="line">    const/4 v7, 0x0</span><br><span class="line"></span><br><span class="line">    .line 24</span><br><span class="line">    invoke-static &#123;p1&#125;, Ljava/lang/Integer;-&gt;valueOf(I)Ljava/lang/Integer;</span><br><span class="line">    move-result-object v8</span><br><span class="line">    aput-object v8, v6, v7</span><br><span class="line">    const/4 v7, 0x1</span><br><span class="line">    invoke-static &#123;v1&#125;, Ljava/lang/Integer;-&gt;valueOf(I)Ljava/lang/Integer;</span><br><span class="line">    move-result-object v8</span><br><span class="line">    aput-object v8, v6, v7</span><br><span class="line">    const/4 v7, 0x2</span><br><span class="line">    invoke-static &#123;v2&#125;, Ljava/lang/Integer;-&gt;valueOf(I)Ljava/lang/Integer;</span><br><span class="line">    move-result-object v8</span><br><span class="line">    aput-object v8, v6, v7</span><br><span class="line">    const/4 v7, 0x3</span><br><span class="line">    invoke-static &#123;v3&#125;, Ljava/lang/Integer;-&gt;valueOf(I)Ljava/lang/Integer;</span><br><span class="line">    move-result-object v8</span><br><span class="line">    aput-object v8, v6, v7</span><br><span class="line"></span><br><span class="line">    .line 23</span><br><span class="line">    invoke-static &#123;v5, v6&#125;, Ljava/lang/String;-&gt;format(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;</span><br><span class="line">    move-result-object v4</span><br><span class="line"></span><br><span class="line">    .line 25</span><br><span class="line">    .local v4, &quot;str&quot;:Ljava/lang/String;</span><br><span class="line">    const/4 v5, 0x0</span><br><span class="line">    invoke-static &#123;p0, v4, v5&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class="line">    move-result-object v5</span><br><span class="line">    invoke-virtual &#123;v5&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class="line">    :try_end_38</span><br><span class="line">    .catch Ljava/lang/ArithmeticException; &#123;:try_start_5 .. :try_end_38&#125; :catch_39</span><br><span class="line">    .catch Ljava/lang/NumberFormatException; &#123;:try_start_5 .. :try_end_38&#125; :catch_45</span><br><span class="line"></span><br><span class="line">    .line 33</span><br><span class="line">    .end local v1    # &quot;i&quot;:I</span><br><span class="line">    .end local v2    # &quot;m&quot;:I</span><br><span class="line">    .end local v3    # &quot;n&quot;:I</span><br><span class="line">    .end local v4    # &quot;str&quot;:Ljava/lang/String;</span><br><span class="line">    :goto_38</span><br><span class="line">    return-void</span><br><span class="line"></span><br><span class="line">    .line 26</span><br><span class="line">    .restart local v1    # &quot;i&quot;:I</span><br><span class="line">    :catch_39</span><br><span class="line">    move-exception v0</span><br><span class="line"></span><br><span class="line">    .line 27</span><br><span class="line">    .local v0, &quot;e&quot;:Ljava/lang/ArithmeticException;</span><br><span class="line">    :try_start_3a</span><br><span class="line">    const-string v5, &quot;人数不能为0&quot;</span><br><span class="line">    const/4 v6, 0x0</span><br><span class="line">    invoke-static &#123;p0, v5, v6&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class="line">    move-result-object v5</span><br><span class="line">    invoke-virtual &#123;v5&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class="line">    :try_end_44</span><br><span class="line">    .catch Ljava/lang/NumberFormatException; &#123;:try_start_3a .. :try_end_44&#125; :catch_45</span><br><span class="line">    goto :goto_38</span><br><span class="line"></span><br><span class="line">    .line 29</span><br><span class="line">    .end local v0    # &quot;e&quot;:Ljava/lang/ArithmeticException;</span><br><span class="line">    .end local v1    # &quot;i&quot;:I</span><br><span class="line">    :catch_45</span><br><span class="line">    move-exception v0</span><br><span class="line"></span><br><span class="line">    .line 30</span><br><span class="line">    .local v0, &quot;e&quot;:Ljava/lang/NumberFormatException;</span><br><span class="line">    const-string v5, &quot;无效的数值字符串&quot;</span><br><span class="line">    invoke-static &#123;p0, v5, v9&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;</span><br><span class="line">    move-result-object v5</span><br><span class="line">    invoke-virtual &#123;v5&#125;, Landroid/widget/Toast;-&gt;show()V</span><br><span class="line">    goto :goto_38</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>

<p>反汇编结果为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">tryCatch</span><span class="params">(<span class="type">int</span> drumsticks, String peple)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Integer.parseInt(peple);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> drumsticks / i;</span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> drumsticks - (m * i);</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> String.format(<span class="string">&quot;共有%d只鸡腿，%d个人平分，每人可分得%d只，还剩下%d只&quot;</span>, Integer.valueOf(drumsticks), Integer.valueOf(i), Integer.valueOf(m), Integer.valueOf(n));</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, str, <span class="number">0</span>).show();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArithmeticException e) &#123;</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;人数不能为0&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e2) &#123;</span><br><span class="line">        Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;无效的数值字符串&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ARM入门"><a href="#ARM入门" class="headerlink" title="ARM入门"></a>ARM入门</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>ARM有31个通用寄存器，6个状态寄存器。其中通用寄存器分为16种，分别为R0到R15，状态寄存器分为CPSR和SPSR两种。</p>
<p>通用寄存器：</p>
<table>
<thead>
<tr>
<th>寄存器</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>R0~R3</td>
<td>传入函数参数，传出函数返回值</td>
</tr>
<tr>
<td>R4~R11</td>
<td>函数局部变量</td>
</tr>
<tr>
<td>R12</td>
<td>内部调用暂时寄存器，被调用函数返回前不必恢复</td>
</tr>
<tr>
<td>R13</td>
<td>栈指针寄存器SP，存放堆栈栈顶地址</td>
</tr>
<tr>
<td>R14</td>
<td>链接寄存器LR，存放子程序返回地址</td>
</tr>
<tr>
<td>R15</td>
<td>程序计数器PC，保存当前正在执行的指令在内存中的地址</td>
</tr>
</tbody></table>
<p>状态寄存器：</p>
<table>
<thead>
<tr>
<th>寄存器</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>CPSR一个</td>
<td>状态寄存器。保存程序当前状态</td>
</tr>
<tr>
<td>SPSR五个</td>
<td>备份程序状态寄存器，异常返回后回复异常发生时的工作状态</td>
</tr>
</tbody></table>
<h3 id="汇编基础"><a href="#汇编基础" class="headerlink" title="汇编基础"></a>汇编基础</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:000082E0                 ; int __fastcall main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:000082E0                                 EXPORT main</span><br><span class="line">.text:000082E0                 main                                    ; CODE XREF: j_main↓j</span><br><span class="line">.text:000082E0</span><br><span class="line">.text:000082E0                 var_C           = -0xC</span><br><span class="line">.text:000082E0                 var_8           = -8</span><br><span class="line">.text:000082E0</span><br><span class="line">.text:000082E0 000 00 48 2D E9                 PUSH    &#123;R11,LR&#125;        ; Push registers</span><br><span class="line">.text:000082E4 008 04 B0 8D E2                 ADD     R11, SP, #4     ; Rd = Op1 + Op2</span><br><span class="line">.text:000082E8 008 08 D0 4D E2                 SUB     SP, SP, #8      ; Rd = Op1 - Op2</span><br><span class="line">.text:000082EC 010 08 00 0B E5                 STR     R0, [R11,#var_8] ; Store to Memory</span><br><span class="line">.text:000082F0 010 0C 10 0B E5                 STR     R1, [R11,#var_C] ; Store to Memory</span><br><span class="line">.text:000082F4 010 18 30 9F E5                 LDR     R3, =(aHelloArm - 0x8300) ; Load from Memory</span><br><span class="line">.text:000082F8 010 03 30 8F E0                 ADD     R3, PC, R3      ; Rd = Op1 + Op2</span><br><span class="line">.text:000082FC 010 03 00 A0 E1                 MOV     R0, R3          ; s</span><br><span class="line">.text:00008300 010 ED FF FF EB                 BL      puts            ; Branch with Link</span><br><span class="line">.text:00008304 010 00 30 A0 E3                 MOV     R3, #0          ; Rd = Op2</span><br><span class="line">.text:00008308 010 03 00 A0 E1                 MOV     R0, R3          ; Rd = Op2</span><br><span class="line">.text:0000830C 010 04 D0 4B E2                 SUB     SP, R11, #4     ; Rd = Op1 - Op2</span><br><span class="line">.text:00008310 008 00 88 BD E8                 POP     &#123;R11,PC&#125;        ; Pop registers</span><br><span class="line">.text:00008310                 ; End of function main</span><br><span class="line">.text:00008310</span><br><span class="line">.text:00008310                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00008314 50 00 00 00     off_8314        DCD aHelloArm - 0x8300  ; DATA XREF: main+14↑r</span><br><span class="line">.text:00008314                                                         ; &quot;Hello ARM!&quot;</span><br></pre></td></tr></table></figure>

<p>ARM处理器有ARM和Thumb两种状态，处理器可在这两种之间随意切换。处于ARM状态时32位字对齐，Thumb状态16位对齐。Thumb状态下FP、IP、SP、LP和PC对应ARM状态下R11、R12、R13、R14和R15。IDA动调时没法区分这两种，得手动切换。</p>
<p>指令条件码cond：</p>
<table>
<thead>
<tr>
<th>条件码</th>
<th>标志</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>EQ</td>
<td>Z=1</td>
<td>相等</td>
</tr>
<tr>
<td>NE</td>
<td>Z=0</td>
<td>不相等</td>
</tr>
<tr>
<td>CS&#x2F;HS</td>
<td>C=1</td>
<td>无符号大于等于</td>
</tr>
<tr>
<td>CC&#x2F;LO</td>
<td>C=0</td>
<td>无符号小于</td>
</tr>
<tr>
<td>MI</td>
<td>N=1</td>
<td>负数</td>
</tr>
<tr>
<td>PL</td>
<td>N=0</td>
<td>正数或0</td>
</tr>
<tr>
<td>VS</td>
<td>V=1</td>
<td>溢出</td>
</tr>
<tr>
<td>VC</td>
<td>V=0</td>
<td>无溢出</td>
</tr>
<tr>
<td>HI</td>
<td>C=1,Z=0</td>
<td>无符号大于</td>
</tr>
<tr>
<td>LS</td>
<td>C=0,Z=1</td>
<td>无符号小于等于</td>
</tr>
<tr>
<td>GE</td>
<td>N=V</td>
<td>符号大于等于</td>
</tr>
<tr>
<td>LT</td>
<td>N!=V</td>
<td>符号小于</td>
</tr>
<tr>
<td>GT</td>
<td>Z=0,N=V</td>
<td>符号大于</td>
</tr>
<tr>
<td>LE</td>
<td>Z=1,N!=V</td>
<td>符号小于等于</td>
</tr>
<tr>
<td>AL</td>
<td>任何</td>
<td>无条件</td>
</tr>
</tbody></table>
<p>后缀S表示影响CPSR的值，操作数据大小type有：</p>
<table>
<thead>
<tr>
<th>type</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>B</td>
<td>无符号字节</td>
</tr>
<tr>
<td>SB</td>
<td>有符号字节</td>
</tr>
<tr>
<td>H</td>
<td>无符号半字</td>
</tr>
<tr>
<td>SH</td>
<td>有符号半字</td>
</tr>
</tbody></table>
<p>递增含义addr_mode：</p>
<table>
<thead>
<tr>
<th>addr_mode</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>IA</td>
<td>执行后增加</td>
</tr>
<tr>
<td>IB</td>
<td>执行前增加</td>
</tr>
<tr>
<td>DA</td>
<td>执行后减少</td>
</tr>
<tr>
<td>DB</td>
<td>执行前减少</td>
</tr>
<tr>
<td>FD</td>
<td>满递减堆栈</td>
</tr>
<tr>
<td>FA</td>
<td>满递增堆栈</td>
</tr>
<tr>
<td>ED</td>
<td>空递减堆栈</td>
</tr>
<tr>
<td>EA</td>
<td>空递增堆栈</td>
</tr>
</tbody></table>
<p>常用汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">B&#123;cond&#125; label @cond满足则跳到label继续执行</span><br><span class="line">BL&#123;cond&#125; label @先将下一条指令地址拷贝到R14即LR中 再跳转</span><br><span class="line">BX&#123;cond&#125; Rm @cond满足 若Rm[0]为1则跳转且CPSR置位T标志 切换至Thumb状态 否则CPSR标志T复位 切换到Thumb状态</span><br><span class="line">BLX&#123;cond&#125; Rm</span><br><span class="line"></span><br><span class="line">LDR&#123;type&#125;&#123;cond&#125; Rd,label</span><br><span class="line">LDRD&#123;cond&#125; Rd,Rd2,label</span><br><span class="line">STR&#123;type&#125;&#123;cond&#125; Rd,label</span><br><span class="line">STRD&#123;cond&#125; Rd,Rd2,label</span><br><span class="line">LDM&#123;addr_mode&#125;&#123;cond&#125; Rn&#123;!&#125; reglist</span><br><span class="line">STM&#123;addr_mode&#125;&#123;cond&#125; Rn&#123;!&#125; reglist</span><br><span class="line">PUSH&#123;cond&#125; reglist</span><br><span class="line">POP&#123;cond&#125; reglist</span><br><span class="line">SWP&#123;B&#125;&#123;cond&#125; Rd,Rm,[Rn]</span><br><span class="line"></span><br><span class="line">MOV&#123;cond&#125;&#123;S&#125; Rd,operand2</span><br><span class="line">MVN&#123;cond&#125;&#123;S&#125; Rd,operand2 @按位取反后MOV</span><br><span class="line">ADD&#123;cond&#125;&#123;S&#125; Rd,Rn,operand2</span><br><span class="line">ADC&#123;cond&#125;&#123;S&#125; Rd,Rn,operand2</span><br><span class="line">SUB&#123;cond&#125;&#123;S&#125; Rd,Rn,operand2</span><br><span class="line">RSB&#123;cond&#125;&#123;S&#125; Rd,Rn,operand2 @Rd=operand2-Rn</span><br><span class="line">SBC&#123;cond&#125;&#123;S&#125; Rd,Rn,operand2</span><br><span class="line">RSC&#123;cond&#125;&#123;S&#125; Rd,Rn,operand2</span><br><span class="line">MUL&#123;cond&#125;&#123;S&#125; Rd,Rm,Rn @Rd=Rm*Rn</span><br><span class="line">@其他MLA UMULL UMLAL SMULL SMLAL SMLAD SMLSD SDIV UDIV ASR ADD ORR EOR BIC LSL LSR ROR RRX CMP CMN TST TEQ</span><br><span class="line"></span><br><span class="line">SWI&#123;cond&#125;,immed_24 @软中断</span><br><span class="line">NOP</span><br><span class="line">MRS Rd,psr</span><br><span class="line">MSR Rd,psr_fields,operand2</span><br></pre></td></tr></table></figure>

<h2 id="Android原生逆向"><a href="#Android原生逆向" class="headerlink" title="Android原生逆向"></a>Android原生逆向</h2><p>常见函数结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">;函数头</span><br><span class="line">STMFD SP1,&#123;FP,LR&#125; ;栈帧指针FP和</span><br><span class="line">ADD R11,SP,#0 ;设置栈帧起始位置</span><br><span class="line">SUB SP,SP,#16 ;为栈中程序变量分配存储空间</span><br><span class="line"></span><br><span class="line">;函数体</span><br><span class="line">MOV R3,#5</span><br><span class="line">STR R3,[SP]</span><br><span class="line">MOV R0,#1</span><br><span class="line">MOV R1,#2</span><br><span class="line">MOV R2,#3</span><br><span class="line">MOV R3,#4</span><br><span class="line">BL SUM</span><br><span class="line"></span><br><span class="line">;函数尾</span><br><span class="line">MOV R0,R0</span><br><span class="line">MOV R0,R3</span><br><span class="line">SUB SP,SP,#4</span><br><span class="line">LDMFD SP1,&#123;FP,PC&#125;</span><br></pre></td></tr></table></figure>

<p>例如展示了两种for循环的调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:000085FC                 ; int __fastcall main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:000085FC                 main                                    ; CODE XREF: j_main↑j</span><br><span class="line">.text:000085FC                 ; __unwind &#123;</span><br><span class="line">.text:000085FC 000 10 40 2D E9                 PUSH    &#123;R4,LR&#125;         ; Push registers</span><br><span class="line">.text:00008600 008 05 00 A0 E3                 MOV     R0, #5          ; Rd = Op2</span><br><span class="line">.text:00008604 008 E1 FF FF EB                 BL      sub_8590        ; Branch with Link</span><br><span class="line">.text:00008608 008 00 10 A0 E1                 MOV     R1, R0          ; Rd = Op2</span><br><span class="line">.text:0000860C 008 24 00 9F E5                 LDR     R0, =(aFor1D - 0x8618) ; Load from Memory</span><br><span class="line">.text:00008610 008 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:00008614 008 BC FF FF EB                 BL      printf          ; Branch with Link</span><br><span class="line">.text:00008618 008 05 00 A0 E3                 MOV     R0, #5          ; Rd = Op2</span><br><span class="line">.text:0000861C 008 E6 FF FF EB                 BL      sub_85BC        ; Branch with Link</span><br><span class="line">.text:00008620 008 00 10 A0 E1                 MOV     R1, R0          ; Rd = Op2</span><br><span class="line">.text:00008624 008 10 00 9F E5                 LDR     R0, =(aFor2D - 0x8630) ; Load from Memory</span><br><span class="line">.text:00008628 008 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:0000862C 008 B6 FF FF EB                 BL      printf          ; Branch with Link</span><br><span class="line">.text:00008630 008 00 00 A0 E3                 MOV     R0, #0          ; Rd = Op2</span><br><span class="line">.text:00008634 008 10 80 BD E8                 POP     &#123;R4,PC&#125;         ; Pop registers</span><br><span class="line">.text:00008634                 ; End of function main</span><br><span class="line">.text:00008634</span><br><span class="line">.text:00008634                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00008638 18 15 00 00     off_8638        DCD aFor1D - 0x8618     ; DATA XREF: main+10↑r</span><br><span class="line">.text:00008638                                                         ; &quot;for1:%d\n&quot;</span><br><span class="line">.text:0000863C 10 15 00 00     off_863C        DCD aFor2D - 0x8630     ; DATA XREF: main+28↑r</span><br><span class="line">.text:0000863C                 ; &#125; // starts at 85FC                   ; &quot;for2:%d\n&quot;</span><br></pre></td></tr></table></figure>

<p>源码为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> nums[<span class="number">5</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">for1</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;    <span class="comment">//普通for循环</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">        s += i * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">for2</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;    <span class="comment">//访问全局数组</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">        s += i * i + nums[n<span class="number">-1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;for1:%d\n&quot;</span>, for1(<span class="number">5</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;for2:%d\n&quot;</span>, for2(<span class="number">5</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里看第二种for：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text:000085BC     ; int __fastcall sub_85BC(int)</span><br><span class="line">.text:000085BC     sub_85BC                                ; CODE XREF: main+20↓p</span><br><span class="line">.text:000085BC     ; __unwind &#123;</span><br><span class="line">.text:000085BC 000                 SUBS    R1, R0, #0      ; Rd = Op1 - Op2</span><br><span class="line">.text:000085C0 000                 MOVLE   R0, #0          ; Rd = Op2</span><br><span class="line">.text:000085C4 000                 BXLE    LR              ; Branch to/from Thumb mode</span><br><span class="line">.text:000085C8 000                 LDR     R3, =(__data_start_ptr - 0x85DC) ; Load from Memory</span><br><span class="line">.text:000085CC 000                 SUB     R2, R1, #1      ; Rd = Op1 - Op2</span><br><span class="line">.text:000085D0 000                 MOV     R0, #0          ; Rd = Op2</span><br><span class="line">.text:000085D4 000                 LDR     R3, [PC,R3]     ; __data_start</span><br><span class="line">.text:000085D8 000                 LDR     R12, [R3,R2,LSL#2] ; Load from Memory</span><br><span class="line">.text:000085DC 000                 MOV     R3, R0          ; Rd = Op2</span><br><span class="line">.text:000085E0</span><br><span class="line">.text:000085E0     loc_85E0                                ; CODE XREF: sub_85BC+34↓j</span><br><span class="line">.text:000085E0 000                 MLA     R2, R3, R3, R12 ; Multiply-Accumulate</span><br><span class="line">.text:000085E4 000                 ADD     R3, R3, #1      ; Rd = Op1 + Op2</span><br><span class="line">.text:000085E8 000                 CMP     R3, R1          ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:000085EC 000                 ADD     R0, R0, R2      ; Rd = Op1 + Op2</span><br><span class="line">.text:000085F0 000                 BNE     loc_85E0        ; Branch</span><br><span class="line">.text:000085F4 000                 BX      LR              ; Branch to/from Thumb mode</span><br><span class="line">.text:000085F4     ; End of function sub_85BC</span><br><span class="line">.text:000085F4</span><br><span class="line">.text:000085F4     ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085F8     off_85F8        DCD __data_start_ptr - 0x85DC</span><br><span class="line">.text:000085F8                                             ; DATA XREF: sub_85BC+C↑r</span><br><span class="line">.text:000085F8     ; &#125; // starts at 85BC</span><br></pre></td></tr></table></figure>

<p>再如if语句：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">if1</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;    <span class="comment">//if else语句</span></span><br><span class="line">    <span class="keyword">if</span>(n &lt; <span class="number">10</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;the number less than 10\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;the number greater than or equal to 10\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">if2</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;        <span class="comment">//多重if else语句</span></span><br><span class="line">    <span class="keyword">if</span>(n &lt; <span class="number">16</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;he is a boy\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(n &lt; <span class="number">30</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;he is a young man\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(n &lt; <span class="number">45</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;he is a strong man\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;he is an old man\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    if1(<span class="number">5</span>);</span><br><span class="line">    if2(<span class="number">35</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if1为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:000085C8                 sub_85C8                                ; CODE XREF: main+8↓p</span><br><span class="line">.text:000085C8                 ; __unwind &#123;</span><br><span class="line">.text:000085C8 000 09 00 50 E3                 CMP     R0, #9          ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:000085CC 000 02 00 00 DA                 BLE     loc_85DC        ; Branch</span><br><span class="line">.text:000085D0 000 10 00 9F E5                 LDR     R0, =(aTheNumberGreat - 0x85DC) ; Load from Memory</span><br><span class="line">.text:000085D4 000 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:000085D8 000 C9 FF FF EA                 B       puts            ; Branch</span><br><span class="line">.text:000085DC                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085DC</span><br><span class="line">.text:000085DC                 loc_85DC                                ; CODE XREF: sub_85C8+4↑j</span><br><span class="line">.text:000085DC 000 08 00 9F E5                 LDR     R0, =(aTheNumberLessT - 0x85E8) ; Load from Memory</span><br><span class="line">.text:000085E0 000 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:000085E4 000 C6 FF FF EA                 B       puts            ; Branch</span><br><span class="line">.text:000085E4                 ; End of function sub_85C8</span><br><span class="line">.text:000085E4</span><br><span class="line">.text:000085E4                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085E8 94 15 00 00     off_85E8        DCD aTheNumberGreat - 0x85DC</span><br><span class="line">.text:000085E8                                                         ; DATA XREF: sub_85C8+8↑r</span><br><span class="line">.text:000085E8                                                         ; &quot;the number greater than or equal to 10&quot;</span><br><span class="line">.text:000085EC 70 15 00 00     off_85EC        DCD aTheNumberLessT - 0x85E8</span><br><span class="line">.text:000085EC                                                         ; DATA XREF: sub_85C8:loc_85DC↑r</span><br><span class="line">.text:000085EC                 ; &#125; // starts at 85C8                   ; &quot;the number less than 10&quot;</span><br></pre></td></tr></table></figure>

<p>if2为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">.text:00008570                 sub_8570                                ; CODE XREF: main+10↓p</span><br><span class="line">.text:00008570                 ; __unwind &#123;</span><br><span class="line">.text:00008570 000 0F 00 50 E3                 CMP     R0, #0xF        ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:00008574 000 09 00 00 DA                 BLE     loc_85A0        ; Branch</span><br><span class="line">.text:00008578 000 1D 00 50 E3                 CMP     R0, #0x1D       ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:0000857C 000 0A 00 00 DA                 BLE     loc_85AC        ; Branch</span><br><span class="line">.text:00008580 000 2C 00 50 E3                 CMP     R0, #0x2C ; &#x27;,&#x27; ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:00008584 000 02 00 00 DA                 BLE     loc_8594        ; Branch</span><br><span class="line">.text:00008588 000 28 00 9F E5                 LDR     R0, =(aHeIsAnOldMan - 0x8594) ; Load from Memory</span><br><span class="line">.text:0000858C 000 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:00008590 000 DB FF FF EA                 B       puts            ; Branch</span><br><span class="line">.text:00008594                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00008594</span><br><span class="line">.text:00008594                 loc_8594                                ; CODE XREF: sub_8570+14↑j</span><br><span class="line">.text:00008594 000 20 00 9F E5                 LDR     R0, =(aHeIsAStrongMan - 0x85A0) ; Load from Memory</span><br><span class="line">.text:00008598 000 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:0000859C 000 D8 FF FF EA                 B       puts            ; Branch</span><br><span class="line">.text:000085A0                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085A0</span><br><span class="line">.text:000085A0                 loc_85A0                                ; CODE XREF: sub_8570+4↑j</span><br><span class="line">.text:000085A0 000 18 00 9F E5                 LDR     R0, =(aHeIsABoy - 0x85AC) ; Load from Memory</span><br><span class="line">.text:000085A4 000 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:000085A8 000 D5 FF FF EA                 B       puts            ; Branch</span><br><span class="line">.text:000085AC                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085AC</span><br><span class="line">.text:000085AC                 loc_85AC                                ; CODE XREF: sub_8570+C↑j</span><br><span class="line">.text:000085AC 000 10 00 9F E5                 LDR     R0, =(aHeIsAYoungMan - 0x85B8) ; Load from Memory</span><br><span class="line">.text:000085B0 000 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:000085B4 000 D2 FF FF EA                 B       puts            ; Branch</span><br><span class="line">.text:000085B4                 ; End of function sub_8570</span><br><span class="line">.text:000085B4</span><br><span class="line">.text:000085B4                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085B8 AC 15 00 00     off_85B8        DCD aHeIsAnOldMan - 0x8594</span><br><span class="line">.text:000085B8                                                         ; DATA XREF: sub_8570+18↑r</span><br><span class="line">.text:000085B8                                                         ; &quot;he is an old man&quot;</span><br><span class="line">.text:000085BC 88 15 00 00     off_85BC        DCD aHeIsAStrongMan - 0x85A0</span><br><span class="line">.text:000085BC                                                         ; DATA XREF: sub_8570:loc_8594↑r</span><br><span class="line">.text:000085BC                                                         ; &quot;he is a strong man&quot;</span><br><span class="line">.text:000085C0 54 15 00 00     off_85C0        DCD aHeIsABoy - 0x85AC  ; DATA XREF: sub_8570:loc_85A0↑r</span><br><span class="line">.text:000085C0                                                         ; &quot;he is a boy&quot;</span><br><span class="line">.text:000085C4 58 15 00 00     off_85C4        DCD aHeIsAYoungMan - 0x85B8</span><br><span class="line">.text:000085C4                                                         ; DATA XREF: sub_8570:loc_85AC↑r</span><br><span class="line">.text:000085C4                 ; &#125; // starts at 8570                   ; &quot;he is a young man&quot;</span><br></pre></td></tr></table></figure>

<p>再例如while循环：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">dowhile</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        s += i;</span><br><span class="line">    &#125;<span class="keyword">while</span>(i++ &lt; n);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">whiledo</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> s = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt;= n)&#123;</span><br><span class="line">        s += i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;dowhile:%d\n&quot;</span>, <span class="built_in">dowhile</span>(<span class="number">100</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;while:%d\n&quot;</span>, whiledo(<span class="number">100</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dowhile有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.text:00008570                 ; int __fastcall sub_8570(int)</span><br><span class="line">.text:00008570                 sub_8570                                ; CODE XREF: main+8↓p</span><br><span class="line">.text:00008570                 ; __unwind &#123;</span><br><span class="line">.text:00008570 000 00 20 A0 E3                 MOV     R2, #0          ; Rd = Op2</span><br><span class="line">.text:00008574 000 01 30 A0 E3                 MOV     R3, #1          ; Rd = Op2</span><br><span class="line">.text:00008578</span><br><span class="line">.text:00008578                 loc_8578                                ; CODE XREF: sub_8570+18↓j</span><br><span class="line">.text:00008578 000 03 20 82 E0                 ADD     R2, R2, R3      ; Rd = Op1 + Op2</span><br><span class="line">.text:0000857C 000 01 30 83 E2                 ADD     R3, R3, #1      ; Rd = Op1 + Op2</span><br><span class="line">.text:00008580 000 01 10 43 E2                 SUB     R1, R3, #1      ; Rd = Op1 - Op2</span><br><span class="line">.text:00008584 000 01 00 50 E1                 CMP     R0, R1          ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:00008588 000 FA FF FF CA                 BGT     loc_8578        ; Branch</span><br><span class="line">.text:0000858C 000 02 00 A0 E1                 MOV     R0, R2          ; Rd = Op2</span><br><span class="line">.text:00008590 000 1E FF 2F E1                 BX      LR              ; Branch to/from Thumb mode</span><br><span class="line">.text:00008590                 ; &#125; // starts at 8570</span><br><span class="line">.text:00008590                 ; End of function sub_8570</span><br><span class="line">.text:00008590</span><br><span class="line">.text:00008594</span><br><span class="line">.text:00008594                 ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:00008594</span><br><span class="line">.text:00008594</span><br><span class="line">.text:00008594                 ; int __fastcall sub_8594(_DWORD)</span><br><span class="line">.text:00008594                 sub_8594                                ; CODE XREF: main+20↓p</span><br><span class="line">.text:00008594                 ; __unwind &#123;</span><br><span class="line">.text:00008594 000 00 20 50 E2                 SUBS    R2, R0, #0      ; Rd = Op1 - Op2</span><br><span class="line">.text:00008598 000 00 00 A0 D3                 MOVLE   R0, #0          ; Rd = Op2</span><br><span class="line">.text:0000859C 000 1E FF 2F D1                 BXLE    LR              ; Branch to/from Thumb mode</span><br><span class="line">.text:000085A0 000 00 00 A0 E3                 MOV     R0, #0          ; Rd = Op2</span><br><span class="line">.text:000085A4 000 01 30 A0 E3                 MOV     R3, #1          ; Rd = Op2</span><br><span class="line">.text:000085A8</span><br><span class="line">.text:000085A8                 loc_85A8                                ; CODE XREF: sub_8594+20↓j</span><br><span class="line">.text:000085A8 000 03 00 80 E0                 ADD     R0, R0, R3      ; Rd = Op1 + Op2</span><br><span class="line">.text:000085AC 000 01 30 83 E2                 ADD     R3, R3, #1      ; Rd = Op1 + Op2</span><br><span class="line">.text:000085B0 000 03 00 52 E1                 CMP     R2, R3          ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:000085B4 000 FB FF FF AA                 BGE     loc_85A8        ; Branch</span><br><span class="line">.text:000085B8 000 1E FF 2F E1                 BX      LR              ; Branch to/from Thumb mode</span><br><span class="line">.text:000085B8                 ; &#125; // starts at 8594</span><br><span class="line">.text:000085B8                 ; End of function sub_8594</span><br></pre></td></tr></table></figure>

<p>switch语句如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">switch1</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> i)</span></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (i)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> a - b;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> a * b;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">return</span> a / b;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;switch1:%d\n&quot;</span>, switch1(<span class="number">3</span>, <span class="number">5</span>, <span class="number">3</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">.text:000085A0                 ; int __fastcall sub_85A0(int, int, int)</span><br><span class="line">.text:000085A0                 sub_85A0                                ; CODE XREF: main+10↓p</span><br><span class="line">.text:000085A0                 ; __unwind &#123;</span><br><span class="line">.text:000085A0 000 01 20 42 E2                 SUB     R2, R2, #1      ; Rd = Op1 - Op2</span><br><span class="line">.text:000085A4 000 10 40 2D E9                 PUSH    &#123;R4,LR&#125;         ; Push registers</span><br><span class="line">.text:000085A8 008 00 30 A0 E1                 MOV     R3, R0          ; Rd = Op2</span><br><span class="line">.text:000085AC 008 03 00 52 E3                 CMP     R2, #3          ; switch 4 cases</span><br><span class="line">.text:000085B0 008 02 F1 8F 90                 ADDLS   PC, PC, R2,LSL#2 ; switch jump switch语句的标志</span><br><span class="line">.text:000085B4                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085B4</span><br><span class="line">.text:000085B4                 loc_85B4                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085B4 008 0B 00 00 EA                 B       def_85B0        ; jumptable 000085B0 default case</span><br><span class="line">.text:000085B8                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085B8</span><br><span class="line">.text:000085B8                 loc_85B8                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085B8 008 08 00 00 EA                 B       loc_85E0        ; jumptable 000085B0 case 0</span><br><span class="line">.text:000085BC                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085BC</span><br><span class="line">.text:000085BC                 loc_85BC                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085BC 008 05 00 00 EA                 B       loc_85D8        ; jumptable 000085B0 case 1</span><br><span class="line">.text:000085C0                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085C0</span><br><span class="line">.text:000085C0                 loc_85C0                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085C0 008 02 00 00 EA                 B       loc_85D0        ; jumptable 000085B0 case 2</span><br><span class="line">.text:000085C4                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085C4</span><br><span class="line">.text:000085C4                 loc_85C4                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085C4 008 FF FF FF EA                 B       loc_85C8        ; jumptable 000085B0 case 3</span><br><span class="line">.text:000085C8                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085C8</span><br><span class="line">.text:000085C8                 loc_85C8                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085C8                                                         ; sub_85A0:loc_85C4↑j</span><br><span class="line">.text:000085C8 008 14 00 00 EB                 BL      sub_8620        ; jumptable 000085B0 case 3</span><br><span class="line">.text:000085CC 008 10 80 BD E8                 POP     &#123;R4,PC&#125;         ; Pop registers</span><br><span class="line">.text:000085D0                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085D0</span><br><span class="line">.text:000085D0                 loc_85D0                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085D0                                                         ; sub_85A0:loc_85C0↑j</span><br><span class="line">.text:000085D0 008 93 01 00 E0                 MUL     R0, R3, R1      ; jumptable 000085B0 case 2</span><br><span class="line">.text:000085D4 008 10 80 BD E8                 POP     &#123;R4,PC&#125;         ; Pop registers</span><br><span class="line">.text:000085D8                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085D8</span><br><span class="line">.text:000085D8                 loc_85D8                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085D8                                                         ; sub_85A0:loc_85BC↑j</span><br><span class="line">.text:000085D8 008 00 00 61 E0                 RSB     R0, R1, R0      ; jumptable 000085B0 case 1</span><br><span class="line">.text:000085DC 008 10 80 BD E8                 POP     &#123;R4,PC&#125;         ; Pop registers</span><br><span class="line">.text:000085E0                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085E0</span><br><span class="line">.text:000085E0                 loc_85E0                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085E0                                                         ; sub_85A0:loc_85B8↑j</span><br><span class="line">.text:000085E0 008 00 00 81 E0                 ADD     R0, R1, R0      ; jumptable 000085B0 case 0</span><br><span class="line">.text:000085E4 008 10 80 BD E8                 POP     &#123;R4,PC&#125;         ; Pop registers</span><br><span class="line">.text:000085E8                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000085E8</span><br><span class="line">.text:000085E8                 def_85B0                                ; CODE XREF: sub_85A0+10↑j</span><br><span class="line">.text:000085E8                                                         ; sub_85A0:loc_85B4↑j</span><br><span class="line">.text:000085E8 008 00 00 81 E0                 ADD     R0, R1, R0      ; jumptable 000085B0 default case</span><br><span class="line">.text:000085EC 008 10 80 BD E8                 POP     &#123;R4,PC&#125;         ; Pop registers</span><br><span class="line">.text:000085EC                 ; &#125; // starts at 85A0</span><br><span class="line">.text:000085EC                 ; End of function sub_85A0</span><br></pre></td></tr></table></figure>

<p>再例如C++的类：</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">aclass</span>&#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> m;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">aclass</span>(<span class="type">int</span> i, <span class="type">char</span> ch) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Constructor called.\n&quot;</span>);</span><br><span class="line">            <span class="keyword">this</span>-&gt;m = i;</span><br><span class="line">            <span class="keyword">this</span>-&gt;c = ch;</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">aclass</span>() &#123;<span class="comment">//定义析构函数   </span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Destructor called.\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">int</span> <span class="title">getM</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">setM</span><span class="params">(<span class="type">int</span> m)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;m = m;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">char</span> <span class="title">getC</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">setC</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;c = c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, a+b);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    aclass *a = <span class="keyword">new</span> <span class="built_in">aclass</span>(<span class="number">3</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line">    a-&gt;<span class="built_in">setM</span>(<span class="number">5</span>);</span><br><span class="line">    a-&gt;<span class="built_in">setC</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    a-&gt;<span class="built_in">add</span>(<span class="number">2</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, a-&gt;<span class="built_in">getM</span>());</span><br><span class="line">    <span class="keyword">delete</span> a;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">.text:00008600                 ; int __fastcall main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:00008600                 main                                    ; CODE XREF: j_main↑j</span><br><span class="line">.text:00008600                 ; __unwind &#123;</span><br><span class="line">.text:00008600 000 70 40 2D E9                 PUSH    &#123;R4-R6,LR&#125;      ; Push registers</span><br><span class="line">.text:00008604 010 08 00 A0 E3                 MOV     R0, #8          ; unsigned int</span><br><span class="line">.text:00008608 010 EC FF FF EB                 BL      _Znwj           ; Branch with Link new操作符</span><br><span class="line">.text:0000860C 010 00 40 A0 E1                 MOV     R4, R0          ; Rd = Op2</span><br><span class="line">.text:00008610 010 50 00 9F E5                 LDR     R0, =(aConstructorCal - 0x8620) ; Load from Memory</span><br><span class="line">.text:00008614 010 50 50 9F E5                 LDR     R5, =(aD - 0x862C) ; Load from Memory</span><br><span class="line">.text:00008618 010 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:0000861C 010 D5 FF FF EB                 BL      puts            ; Branch with Link</span><br><span class="line">.text:00008620 010 05 30 A0 E3                 MOV     R3, #5          ; Rd = Op2</span><br><span class="line">.text:00008624 010 05 50 8F E0                 ADD     R5, PC, R5      ; Rd = Op1 + Op2</span><br><span class="line">.text:00008628 010 00 30 84 E5                 STR     R3, [R4]        ; Store to Memory</span><br><span class="line">.text:0000862C 010 61 30 A0 E3                 MOV     R3, #0x61 ; &#x27;a&#x27; ; Rd = Op2</span><br><span class="line">.text:00008630 010 04 30 C4 E5                 STRB    R3, [R4,#4]     ; Store to Memory</span><br><span class="line">.text:00008634 010 0A 10 A0 E3                 MOV     R1, #0xA        ; Rd = Op2</span><br><span class="line">.text:00008638 010 05 00 A0 E1                 MOV     R0, R5          ; format</span><br><span class="line">.text:0000863C 010 C4 FF FF EB                 BL      printf          ; Branch with Link</span><br><span class="line">.text:00008640 010 00 10 94 E5                 LDR     R1, [R4]        ; Load from Memory</span><br><span class="line">.text:00008644 010 05 00 A0 E1                 MOV     R0, R5          ; format</span><br><span class="line">.text:00008648 010 C1 FF FF EB                 BL      printf          ; Branch with Link</span><br><span class="line">.text:0000864C 010 1C 00 9F E5                 LDR     R0, =(aDestructorCall - 0x8658) ; Load from Memory</span><br><span class="line">.text:00008650 010 00 00 8F E0                 ADD     R0, PC, R0      ; Rd = Op1 + Op2</span><br><span class="line">.text:00008654 010 C7 FF FF EB                 BL      puts            ; Branch with Link</span><br><span class="line">.text:00008658 010 04 00 A0 E1                 MOV     R0, R4          ; void *</span><br><span class="line">.text:0000865C 010 C8 FF FF EB                 BL      _ZdlPv          ; Branch with Link</span><br><span class="line">.text:00008660 010 00 00 A0 E3                 MOV     R0, #0          ; Rd = Op2</span><br><span class="line">.text:00008664 010 70 80 BD E8                 POP     &#123;R4-R6,PC&#125;      ; Pop registers</span><br><span class="line">.text:00008664                 ; End of function main</span><br><span class="line">.text:00008664</span><br><span class="line">.text:00008664                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00008668 48 15 00 00     off_8668        DCD aConstructorCal - 0x8620</span><br><span class="line">.text:00008668                                                         ; DATA XREF: main+10↑r</span><br><span class="line">.text:00008668                                                         ; &quot;Constructor called.&quot;</span><br><span class="line">.text:0000866C 54 15 00 00     off_866C        DCD aD - 0x862C         ; DATA XREF: main+14↑r</span><br><span class="line">.text:0000866C                                                         ; &quot;%d\n&quot;</span><br><span class="line">.text:00008670 30 15 00 00     off_8670        DCD aDestructorCall - 0x8658</span><br><span class="line">.text:00008670                                                         ; DATA XREF: main+4C↑r</span><br><span class="line">.text:00008670                 ; &#125; // starts at 8600                   ; &quot;Destructor called.&quot;</span><br></pre></td></tr></table></figure>

<p>静态链接STL：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">aclass</span>&#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> m;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">aclass</span>(<span class="type">int</span> i, <span class="type">char</span> ch) &#123;</span><br><span class="line">            cout&lt;&lt;<span class="string">&quot;Constructor called.&quot;</span>&lt;&lt;endl;</span><br><span class="line">            <span class="keyword">this</span>-&gt;m = i;</span><br><span class="line">            <span class="keyword">this</span>-&gt;c = ch;</span><br><span class="line">        &#125;</span><br><span class="line">        ~<span class="built_in">aclass</span>() &#123;<span class="comment">//定义析构函数   </span></span><br><span class="line">            cout&lt;&lt;<span class="string">&quot;Destructor called.&quot;</span>&lt;&lt;endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">int</span> <span class="title">getM</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">setM</span><span class="params">(<span class="type">int</span> m)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;m = m;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">char</span> <span class="title">getC</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">setC</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;c = c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>&#123;</span><br><span class="line">            cout&lt;&lt;a+b;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    aclass *a = <span class="keyword">new</span> <span class="built_in">aclass</span>(<span class="number">3</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line">    a-&gt;<span class="built_in">setM</span>(<span class="number">5</span>);</span><br><span class="line">    a-&gt;<span class="built_in">setC</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    a-&gt;<span class="built_in">add</span>(<span class="number">2</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="comment">//printf(&quot;%d\n&quot;, a-&gt;getM());</span></span><br><span class="line">    cout&lt;&lt;a-&gt;<span class="built_in">getM</span>()&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">delete</span> a;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下，C++符号是自己手补的，一般IDA只能恢复动态链接符号，静态链接不行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">.text:0000998C                 ; int __fastcall main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:0000998C                 main                                    ; CODE XREF: j_main↑j</span><br><span class="line">.text:0000998C                 ; __unwind &#123;</span><br><span class="line">.text:0000998C 000 F0 47 2D E9                 PUSH    &#123;R4-R10,LR&#125;     ; Push registers</span><br><span class="line">.text:00009990 020 08 00 A0 E3                 MOV     R0, #8          ; unsigned int</span><br><span class="line">.text:00009994 020 C0 93 00 EB                 BL      _Znwj           ; Branch with Link</span><br><span class="line">.text:00009998 020 7C 41 9F E5                 LDR     R4, =(_GLOBAL_OFFSET_TABLE_ - 0x99AC) ; Load from Memory</span><br><span class="line">.text:0000999C 020 7C 61 9F E5                 LDR     R6, =(off_3D990 - 0x3D6D4) ; Load from Memory</span><br><span class="line">.text:000099A0 020 7C 11 9F E5                 LDR     R1, =(aConstructorCal - 0x99C0) ; Load from Memory</span><br><span class="line">.text:000099A4 020 04 40 8F E0                 ADD     R4, PC, R4      ; _GLOBAL_OFFSET_TABLE_</span><br><span class="line">.text:000099A8 020 06 50 94 E7                 LDR     R5, [R4,R6]     ; dword_3DDAC</span><br><span class="line">.text:000099AC 020 00 70 A0 E1                 MOV     R7, R0          ; Rd = Op2 aclass *a</span><br><span class="line">.text:000099B0 020 13 20 A0 E3                 MOV     R2, #0x13       ; Rd = Op2 需要输出的字符个数</span><br><span class="line">.text:000099B4 020 05 00 A0 E1                 MOV     R0, R5          ; Rd = Op2</span><br><span class="line">.text:000099B8 020 01 10 8F E0                 ADD     R1, PC, R1      ; Rd = Op1 + Op2</span><br><span class="line">.text:000099BC 020 17 44 00 EB                 BL      ZSt16__ostream_insertIcSt11char_traitsIcEERSt13 ; Branch with Link cout</span><br><span class="line">.text:000099C0 020 00 30 95 E5                 LDR     R3, [R5]        ; Load from Memory</span><br><span class="line">.text:000099C4 020 0C 30 13 E5                 LDR     R3, [R3,#-0xC]  ; Load from Memory</span><br><span class="line">.text:000099C8 020 03 30 85 E0                 ADD     R3, R5, R3      ; Rd = Op1 + Op2</span><br><span class="line">.text:000099CC 020 7C 80 93 E5                 LDR     R8, [R3,#0x7C]  ; Load from Memory</span><br><span class="line">.text:000099D0 020 00 00 58 E3                 CMP     R8, #0          ; Set cond. codes on Op1 - Op2 判断返回的cout是否为空</span><br><span class="line">.text:000099D4 020 4F 00 00 0A                 BEQ     throw_badcast   ; Branch</span><br><span class="line">.text:000099D8 020 1C 30 D8 E5                 LDRB    R3, [R8,#0x1C]  ; Load from Memory</span><br><span class="line">.text:000099DC 020 00 00 53 E3                 CMP     R3, #0          ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:000099E0 020 27 10 D8 15                 LDRBNE  R1, [R8,#0x27]  ; Load from Memory</span><br><span class="line">.text:000099E4 020 07 00 00 1A                 BNE     loc_9A08        ; Branch</span><br><span class="line">.text:000099E8 020 08 00 A0 E1                 MOV     R0, R8          ; Rd = Op2</span><br><span class="line">.text:000099EC 020 D2 00 00 EB                 BL      _ZNKSt5ctypeIcE13_M_widen_initEv ; Branch with Link</span><br><span class="line">.text:000099F0 020 0A 10 A0 E3                 MOV     R1, #0xA        ; Rd = Op2</span><br><span class="line">.text:000099F4 020 08 00 A0 E1                 MOV     R0, R8          ; Rd = Op2</span><br><span class="line">.text:000099F8 020 00 30 98 E5                 LDR     R3, [R8]        ; Load from Memory</span><br><span class="line">.text:000099FC 020 0F E0 A0 E1                 MOV     LR, PC          ; Rd = Op2</span><br><span class="line">.text:00009A00 020 18 F0 93 E5                 LDR     PC, [R3,#0x18]  ; Indirect Jump</span><br><span class="line">.text:00009A04 020 00 10 A0 E1                 MOV     R1, R0          ; Rd = Op2</span><br><span class="line">.text:00009A08</span><br><span class="line">.text:00009A08                 loc_9A08                                ; CODE XREF: main+58↑j</span><br><span class="line">.text:00009A08 020 06 80 94 E7                 LDR     R8, [R4,R6]     ; dword_3DDAC</span><br><span class="line">.text:00009A0C 020 08 00 A0 E1                 MOV     R0, R8          ; Rd = Op2 以下这两行为cout&lt;&lt;endl;</span><br><span class="line">.text:00009A10 020 17 43 00 EB                 BL      _ZNSo3putEc     ; Branch with Link std::ostream::put(char)</span><br><span class="line">.text:00009A14 020 A2 42 00 EB                 BL      _ZNSo5flushEv   ; Branch with Link std::ostream:flush(void)</span><br><span class="line">.text:00009A18 020 05 30 A0 E3                 MOV     R3, #5          ; Rd = Op2 5</span><br><span class="line">.text:00009A1C 020 00 30 87 E5                 STR     R3, [R7]        ; Store to Memory a-&gt;setM(5)</span><br><span class="line">.text:00009A20 020 61 30 A0 E3                 MOV     R3, #0x61 ; &#x27;a&#x27; ; Rd = Op2 &#x27;a&#x27;</span><br><span class="line">.text:00009A24 020 04 30 C7 E5                 STRB    R3, [R7,#4]     ; Store to Memory a-&gt;setC(&#x27;a&#x27;)</span><br><span class="line">.text:00009A28 020 0A 10 A0 E3                 MOV     R1, #0xA        ; Rd = Op2 a+b=10</span><br><span class="line">.text:00009A2C 020 08 00 A0 E1                 MOV     R0, R8          ; Rd = Op2 返回的cout对象</span><br><span class="line">.text:00009A30 020 F9 43 00 EB                 BL      _ZNSolsEi       ; Branch with Link cout&lt;&lt;a+b</span><br><span class="line">.text:00009A34 020 08 00 A0 E1                 MOV     R0, R8          ; Rd = Op2</span><br><span class="line">.text:00009A38 020 00 10 97 E5                 LDR     R1, [R7]        ; Load from Memory R7为aclass类首地址</span><br><span class="line">.text:00009A3C 020 F6 43 00 EB                 BL      _ZNSolsEi       ; Branch with Link cout&lt;&lt;a-&gt;getM()</span><br><span class="line">.text:00009A40 020 00 30 90 E5                 LDR     R3, [R0]        ; Load from Memory</span><br><span class="line">.text:00009A44 020 00 80 A0 E1                 MOV     R8, R0          ; Rd = Op2</span><br><span class="line">.text:00009A48 020 0C 30 13 E5                 LDR     R3, [R3,#-0xC]  ; Load from Memory</span><br><span class="line">.text:00009A4C 020 03 30 80 E0                 ADD     R3, R0, R3      ; Rd = Op1 + Op2</span><br><span class="line">.text:00009A50 020 7C A0 93 E5                 LDR     R10, [R3,#0x7C] ; Load from Memory</span><br><span class="line">.text:00009A54 020 00 00 5A E3                 CMP     R10, #0         ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:00009A58 020 2E 00 00 0A                 BEQ     throw_badcast   ; Branch</span><br><span class="line">.text:00009A5C 020 1C 30 DA E5                 LDRB    R3, [R10,#0x1C] ; Load from Memory</span><br><span class="line">.text:00009A60 020 00 00 53 E3                 CMP     R3, #0          ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:00009A64 020 27 10 DA 15                 LDRBNE  R1, [R10,#0x27] ; Load from Memory</span><br><span class="line">.text:00009A68 020 07 00 00 1A                 BNE     loc_9A8C        ; Branch 下面两行为cout&lt;&lt;endl;</span><br><span class="line">.text:00009A6C 020 0A 00 A0 E1                 MOV     R0, R10         ; Rd = Op2</span><br><span class="line">.text:00009A70 020 B1 00 00 EB                 BL      _ZNKSt5ctypeIcE13_M_widen_initEv ; Branch with Link</span><br><span class="line">.text:00009A74 020 0A 10 A0 E3                 MOV     R1, #0xA        ; Rd = Op2</span><br><span class="line">.text:00009A78 020 0A 00 A0 E1                 MOV     R0, R10         ; Rd = Op2</span><br><span class="line">.text:00009A7C 020 00 30 9A E5                 LDR     R3, [R10]       ; Load from Memory</span><br><span class="line">.text:00009A80 020 0F E0 A0 E1                 MOV     LR, PC          ; Rd = Op2</span><br><span class="line">.text:00009A84 020 18 F0 93 E5                 LDR     PC, [R3,#0x18]  ; Indirect Jump</span><br><span class="line">.text:00009A88 020 00 10 A0 E1                 MOV     R1, R0          ; Rd = Op2</span><br><span class="line">.text:00009A8C</span><br><span class="line">.text:00009A8C                 loc_9A8C                                ; CODE XREF: main+DC↑j</span><br><span class="line">.text:00009A8C 020 08 00 A0 E1                 MOV     R0, R8          ; Rd = Op2</span><br><span class="line">.text:00009A90 020 F7 42 00 EB                 BL      _ZNSo3putEc     ; Branch with Link</span><br><span class="line">.text:00009A94 020 82 42 00 EB                 BL      _ZNSo5flushEv   ; Branch with Link</span><br><span class="line">.text:00009A98 020 06 80 94 E7                 LDR     R8, [R4,R6]     ; dword_3DDAC</span><br><span class="line">.text:00009A9C 020 84 10 9F E5                 LDR     R1, =(aDestructorCall - 0x9AB0) ; Load from Memory</span><br><span class="line">.text:00009AA0 020 12 20 A0 E3                 MOV     R2, #0x12       ; Rd = Op2</span><br><span class="line">.text:00009AA4 020 08 00 A0 E1                 MOV     R0, R8          ; Rd = Op2</span><br><span class="line">.text:00009AA8 020 01 10 8F E0                 ADD     R1, PC, R1      ; Rd = Op1 + Op2</span><br><span class="line">.text:00009AAC 020 DB 43 00 EB                 BL      ZSt16__ostream_insertIcSt11char_traitsIcEERSt13 ; Branch with Link</span><br><span class="line">.text:00009AB0 020 00 30 98 E5                 LDR     R3, [R8]        ; Load from Memory</span><br><span class="line">.text:00009AB4 020 0C 30 13 E5                 LDR     R3, [R3,#-0xC]  ; Load from Memory</span><br><span class="line">.text:00009AB8 020 03 50 85 E0                 ADD     R5, R5, R3      ; Rd = Op1 + Op2</span><br><span class="line">.text:00009ABC 020 7C 50 95 E5                 LDR     R5, [R5,#0x7C]  ; Load from Memory</span><br><span class="line">.text:00009AC0 020 00 00 55 E3                 CMP     R5, #0          ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:00009AC4 020 13 00 00 0A                 BEQ     throw_badcast   ; Branch</span><br><span class="line">.text:00009AC8 020 1C 30 D5 E5                 LDRB    R3, [R5,#0x1C]  ; Load from Memory</span><br><span class="line">.text:00009ACC 020 00 00 53 E3                 CMP     R3, #0          ; Set cond. codes on Op1 - Op2</span><br><span class="line">.text:00009AD0 020 27 10 D5 15                 LDRBNE  R1, [R5,#0x27]  ; Load from Memory</span><br><span class="line">.text:00009AD4 020 06 00 00 0A                 BEQ     loc_9AF4        ; Branch</span><br><span class="line">.text:00009AD8</span><br><span class="line">.text:00009AD8                 loc_9AD8                                ; CODE XREF: main+188↓j</span><br><span class="line">.text:00009AD8 020 06 00 94 E7                 LDR     R0, [R4,R6]     ; dword_3DDAC</span><br><span class="line">.text:00009ADC 020 E4 42 00 EB                 BL      _ZNSo3putEc     ; Branch with Link</span><br><span class="line">.text:00009AE0 020 6F 42 00 EB                 BL      _ZNSo5flushEv   ; Branch with Link</span><br><span class="line">.text:00009AE4 020 07 00 A0 E1                 MOV     R0, R7          ; void * R7为aclass类首地址</span><br><span class="line">.text:00009AE8 020 81 8A 00 EB                 BL      _ZdlPv          ; Branch with Link 删除a指针</span><br><span class="line">.text:00009AEC 020 00 00 A0 E3                 MOV     R0, #0          ; Rd = Op2</span><br><span class="line">.text:00009AF0 020 F0 87 BD E8                 POP     &#123;R4-R10,PC&#125;     ; Pop registers</span><br><span class="line">.text:00009AF4                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00009AF4</span><br><span class="line">.text:00009AF4                 loc_9AF4                                ; CODE XREF: main+148↑j</span><br><span class="line">.text:00009AF4 020 05 00 A0 E1                 MOV     R0, R5          ; Rd = Op2</span><br><span class="line">.text:00009AF8 020 8F 00 00 EB                 BL      _ZNKSt5ctypeIcE13_M_widen_initEv ; Branch with Link</span><br><span class="line">.text:00009AFC 020 0A 10 A0 E3                 MOV     R1, #0xA        ; Rd = Op2</span><br><span class="line">.text:00009B00 020 05 00 A0 E1                 MOV     R0, R5          ; Rd = Op2</span><br><span class="line">.text:00009B04 020 00 30 95 E5                 LDR     R3, [R5]        ; Load from Memory</span><br><span class="line">.text:00009B08 020 0F E0 A0 E1                 MOV     LR, PC          ; Rd = Op2</span><br><span class="line">.text:00009B0C 020 18 F0 93 E5                 LDR     PC, [R3,#0x18]  ; Indirect Jump</span><br><span class="line">.text:00009B10 020 00 10 A0 E1                 MOV     R1, R0          ; Rd = Op2</span><br><span class="line">.text:00009B14 020 EF FF FF EA                 B       loc_9AD8        ; Branch</span><br><span class="line">.text:00009B18                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00009B18</span><br><span class="line">.text:00009B18                 throw_badcast                           ; CODE XREF: main+48↑j</span><br><span class="line">.text:00009B18                                                         ; main+CC↑j ...</span><br><span class="line">.text:00009B18 020 F4 00 00 EB                 BL      sub_9EF0        ; Branch with Link</span><br><span class="line">.text:00009B18                 ; End of function main</span><br><span class="line">.text:00009B18</span><br><span class="line">.text:00009B18                 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00009B1C 28 3D 03 00     off_9B1C        DCD _GLOBAL_OFFSET_TABLE_ - 0x99AC</span><br><span class="line">.text:00009B1C                                                         ; DATA XREF: main+C↑r</span><br><span class="line">.text:00009B20 BC 02 00 00     off_9B20        DCD off_3D990 - 0x3D6D4 ; DATA XREF: main+10↑r</span><br><span class="line">.text:00009B24 70 D0 02 00     off_9B24        DCD aConstructorCal - 0x99C0</span><br><span class="line">.text:00009B24                                                         ; DATA XREF: main+14↑r</span><br><span class="line">.text:00009B24                                                         ; &quot;Constructor called.&quot;</span><br><span class="line">.text:00009B28 98 CF 02 00     off_9B28        DCD aDestructorCall - 0x9AB0</span><br><span class="line">.text:00009B28                                                         ; DATA XREF: main+110↑r</span><br><span class="line">.text:00009B28                 ; &#125; // starts at 998C                   ; &quot;Destructor called.&quot;</span><br></pre></td></tr></table></figure>

<p>Android NDK的jni.h中声明了所有可用的JNI接口函数，其中有JNINativeInterface和JNIInvokeInterface两个结构体。JNINativeInterface为JNI本地接口，实质是个接口函数指针表，每一项都为JNI接口函数指针，所有原生代码可调用这些接口函数。JNIInvokeInterface为JNI调用接口，用于访问全局JNI接口，用于原生多线程程序开发。可以在IDA导入Android SDK目录下的\ndk\28.0.12433566\toolchains\llvm\prebuilt\windows-x86_64\sysroot\usr\include\jni.h文件，但需要先将开头包含的其他库语句删掉。例如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;jniMethods.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGV(...) __android_log_print(ANDROID_LOG_VERBOSE, <span class="string">&quot;com.droider.jnimethods&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, <span class="string">&quot;com.droider.jnimethods&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;com.droider.jnimethods&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGW(...) __android_log_print(ANDROID_LOG_WARN, <span class="string">&quot;com.droider.jnimethods&quot;</span>, __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, <span class="string">&quot;com.droider.jnimethods&quot;</span>, __VA_ARGS__)</span></span><br><span class="line">JNIEnv *g_env;</span><br><span class="line">JavaVM *g_vm;    <span class="comment">//下面多线程程序用到</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> thread_mutex;</span><br><span class="line">jclass native_class;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NELEM <span class="comment">//计算结构元素个数</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> NELEM(x) ((int) (sizeof(x) / sizeof((x)[0])))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="function">JNIEXPORT jstring <span class="title">nativeMethod</span><span class="params">(JNIEnv* env, jclass clazz)</span></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * chs = <span class="string">&quot;你好!NativeMethod&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, chs);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> <span class="title">Java_com_droider_jnimethods_TestJniMethods_test</span><span class="params">(JNIEnv* env, jobject object)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> version = (*env)-&gt;<span class="built_in">GetVersion</span>(env);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetVersion() --&gt; jni version:%2x&quot;</span>, version);</span><br><span class="line">    jclass build_class = (*env)-&gt;<span class="built_in">FindClass</span>(env, <span class="string">&quot;android/os/Build&quot;</span>);  <span class="comment">//加载一个本地类</span></span><br><span class="line">    jfieldID brand_id = (*env)-&gt;<span class="built_in">GetStaticFieldID</span>(env,build_class, <span class="string">&quot;MODEL&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);<span class="comment">//获取类的静态字段ID</span></span><br><span class="line">    jstring brand_obj = (jstring)(*env)-&gt;<span class="built_in">GetStaticObjectField</span>(env,build_class, brand_id);<span class="comment">//获取类的静态字段的值ֵ</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *nativeString = (*env)-&gt;<span class="built_in">GetStringUTFChars</span>(env, brand_obj, <span class="number">0</span>); <span class="comment">//通过jstring生成char*</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetStringUTFChars() --&gt; MODEL:%s&quot;</span>, nativeString);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetStaticFieldID() --&gt; %s&quot;</span>, nativeString);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;ReleaseStringUTFChars() --&gt; %s&quot;</span>, nativeString);</span><br><span class="line">    (*env)-&gt;<span class="built_in">ReleaseStringUTFChars</span>(env, brand_obj, nativeString); <span class="comment">//释放GetStringUTFChars()生成的char*</span></span><br><span class="line">    jclass test_class = (*env)-&gt;<span class="built_in">FindClass</span>(env, <span class="string">&quot;com/droider/jnimethods/TestClass&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((*env)-&gt;<span class="built_in">ExceptionCheck</span>(env))&#123;</span><br><span class="line">        (*env)-&gt;<span class="built_in">ExceptionDescribe</span>(env);</span><br><span class="line">        (*env)-&gt;<span class="built_in">ExceptionClear</span>(env);</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;ExceptionCheck()&quot;</span>);</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;ExceptionDescribe()&quot;</span>);</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;ExceptionClear()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    jmethodID constructor = (*env)-&gt;<span class="built_in">GetMethodID</span>(env, test_class, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>); <span class="comment">//获取构造函数</span></span><br><span class="line">    jobject obj = (*env)-&gt;<span class="built_in">NewObject</span>(env, test_class, constructor);  <span class="comment">//创建一个对象</span></span><br><span class="line">    jthrowable throwable = (*env)-&gt;<span class="built_in">ExceptionOccurred</span>(env);</span><br><span class="line">    <span class="keyword">if</span> (throwable)&#123;      <span class="comment">//有异常发生,还可以使用ExceptionCheck()函数来判断</span></span><br><span class="line">        (*env)-&gt;<span class="built_in">ExceptionDescribe</span>(env);</span><br><span class="line">        (*env)-&gt;<span class="built_in">ExceptionClear</span>(env);</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;ExceptionOccurred()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (obj)&#123;</span><br><span class="line">        (*env)-&gt;<span class="built_in">MonitorEnter</span>(env, obj); <span class="comment">//同步操作</span></span><br><span class="line">        jfieldID stringfieldID = (*env)-&gt;<span class="built_in">GetFieldID</span>(env,test_class, <span class="string">&quot;aStringField&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);<span class="comment">//获取String类型的字段</span></span><br><span class="line">        jstring stringfieldValue = (jstring)(*env)-&gt;<span class="built_in">GetObjectField</span>(env,obj, stringfieldID);<span class="comment">//获取String字段的值ֵ</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *stringValue = (*env)-&gt;<span class="built_in">GetStringUTFChars</span>(env,stringfieldValue, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;GetObjectField() --&gt; aStringField:%s&quot;</span>, stringValue);</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *myValue = <span class="string">&quot;def&quot;</span>;        <span class="comment">//设置字段的值</span></span><br><span class="line">        (*env)-&gt;<span class="built_in">SetObjectField</span>(env, obj, stringfieldID, (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, myValue));</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;SetObjectField() --&gt; aStringField:def&quot;</span>);</span><br><span class="line">        (*env)-&gt;<span class="built_in">ReleaseStringUTFChars</span>(env, stringfieldValue, stringValue);</span><br><span class="line">        jfieldID intfieldID = (*env)-&gt;<span class="built_in">GetFieldID</span>(env,test_class, <span class="string">&quot;aIntField&quot;</span>, <span class="string">&quot;I&quot;</span>);<span class="comment">//获取int类型的字段</span></span><br><span class="line">        jint fieldValue = (*env)-&gt;<span class="built_in">GetIntField</span>(env, obj, intfieldID); <span class="comment">//获取int字段的值ֵ</span></span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;GetIntField() --&gt; aField:%d&quot;</span>, fieldValue);</span><br><span class="line">        (*env)-&gt;<span class="built_in">SetIntField</span>(env, obj, intfieldID, (jint)<span class="number">123</span>); <span class="comment">// 设置int字段的值ֵ</span></span><br><span class="line">        fieldValue = (*env)-&gt;<span class="built_in">GetIntField</span>(env, obj, intfieldID);</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;SetIntField() --&gt; aField:%d&quot;</span>, fieldValue);</span><br><span class="line">        jclass parent_class = (*env)-&gt;<span class="built_in">GetSuperclass</span>(env, test_class);</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;GetSuperclass() --&gt; &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(JNI_OK == (*env)-&gt;<span class="built_in">EnsureLocalCapacity</span>(env, <span class="number">5</span>))&#123; <span class="comment">//检测是否还可以创建5个局部引用</span></span><br><span class="line">                <span class="built_in">LOGV</span>(<span class="string">&quot;EnsureLocalCapacity() --&gt; ensure 5 locals&quot;</span>);</span><br><span class="line">                jmethodID obj2_voidmethod = (*env)-&gt;<span class="built_in">GetMethodID</span>(env,test_class, <span class="string">&quot;aVoidMethod&quot;</span>, <span class="string">&quot;()V&quot;</span>);<span class="comment">//获取一个void方法</span></span><br><span class="line">                (*env)-&gt;<span class="built_in">CallVoidMethod</span>(env, obj, obj2_voidmethod);</span><br><span class="line">                <span class="built_in">LOGV</span>(<span class="string">&quot;CallVoidMethod()&quot;</span>);</span><br><span class="line">                jmethodID obj2_Staticmethod = (*env)-&gt;<span class="built_in">GetStaticMethodID</span>(env,test_class, <span class="string">&quot;aStaticMethod&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>);<span class="comment">//获取static方法</span></span><br><span class="line">                <span class="built_in">LOGV</span>(<span class="string">&quot;GetStaticMethodID()&quot;</span>);</span><br><span class="line">                <span class="type">const</span> <span class="type">char</span> *fromJni = <span class="string">&quot;this string from jni&quot;</span>;</span><br><span class="line">                jstring jstr_static = (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, fromJni);</span><br><span class="line">                (*env)-&gt;<span class="built_in">CallStaticVoidMethod</span>(env, test_class, obj2_Staticmethod, jstr_static); <span class="comment">//调用一个静态方法</span></span><br><span class="line">                jmethodID obj2_chinesemethod = (*env)-&gt;<span class="built_in">GetMethodID</span>(env,test_class, <span class="string">&quot;getChineseString&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);<span class="comment">//传递中文字符串</span></span><br><span class="line">                jstring obj2_chinesejstring = (jstring)(*env)-&gt;<span class="built_in">CallObjectMethod</span>(env, obj, obj2_chinesemethod);</span><br><span class="line">                jsize chinese_size = (*env)-&gt;<span class="built_in">GetStringLength</span>(env, obj2_chinesejstring);  <span class="comment">//获取UTF-16字符串长度</span></span><br><span class="line">                <span class="built_in">LOGV</span>(<span class="string">&quot;GetStringLength() --&gt; %d&quot;</span>, chinese_size);</span><br><span class="line">                jchar buff_jchar[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                (*env)-&gt;<span class="built_in">GetStringRegion</span>(env, obj2_chinesejstring, <span class="number">0</span>, <span class="number">3</span>, buff_jchar);</span><br><span class="line">                <span class="built_in">LOGV</span>(<span class="string">&quot;GetStringRegion() --&gt;&quot;</span>);</span><br><span class="line">                <span class="type">const</span> jchar * obj2_chinesechars = (*env)-&gt;<span class="built_in">GetStringChars</span>(env, obj2_chinesejstring, <span class="literal">NULL</span>);</span><br><span class="line">                jstring new_chinesestring = (*env)-&gt;<span class="built_in">NewString</span>(env, obj2_chinesechars, chinese_size);</span><br><span class="line">                (*env)-&gt;<span class="built_in">CallStaticVoidMethod</span>(env, test_class, obj2_Staticmethod, new_chinesestring); <span class="comment">//调用一个静态方法</span></span><br><span class="line">                (*env)-&gt;<span class="built_in">ReleaseStringChars</span>(env, obj2_chinesejstring, obj2_chinesechars); <span class="comment">//释放GetStringChars获取的jchar*</span></span><br><span class="line">                <span class="built_in">LOGV</span>(<span class="string">&quot;CallStaticVoidMethod()&quot;</span>);</span><br><span class="line">                jmethodID obj2_sqrtmethod = (*env)-&gt;<span class="built_in">GetStaticMethodID</span>(env,test_class, <span class="string">&quot;sqrt&quot;</span>, <span class="string">&quot;(I)I&quot;</span>);<span class="comment">//获取一个static方法</span></span><br><span class="line">                jint int_sqrt = (*env)-&gt;<span class="built_in">CallStaticIntMethod</span>(env,test_class, obj2_sqrtmethod, (jint)<span class="number">5</span>);<span class="comment">//计算5的平方</span></span><br><span class="line">                <span class="built_in">LOGV</span>(<span class="string">&quot;CallStaticIntMethod() --&gt;5 sqrt is:%d&quot;</span>, int_sqrt);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span>(JNI_TRUE == (*env)-&gt;<span class="built_in">IsAssignableFrom</span>(env, test_class, parent_class))&#123;</span><br><span class="line">            <span class="built_in">LOGV</span>(<span class="string">&quot;IsAssignableFrom() --&gt; yes&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            jclass newExceptionClazz = (*env)-&gt;<span class="built_in">FindClass</span>(env,<span class="string">&quot;java/lang/RuntimeException&quot;</span>); <span class="comment">//实例化一个异常</span></span><br><span class="line">            <span class="keyword">if</span>(newExceptionClazz != <span class="literal">NULL</span>)</span><br><span class="line">                (*env)-&gt;<span class="built_in">ThrowNew</span>(env, newExceptionClazz,<span class="string">&quot;这里永远不会被执行的！&quot;</span>);</span><br><span class="line">            <span class="built_in">LOGE</span>(<span class="string">&quot;ThrowNew()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        jclass obj_clazz = (*env)-&gt;<span class="built_in">GetObjectClass</span>(env, obj); <span class="comment">//获取对象的类</span></span><br><span class="line">        <span class="keyword">if</span>(JNI_TRUE == (*env)-&gt;<span class="built_in">IsInstanceOf</span>(env, obj, obj_clazz))&#123;</span><br><span class="line">            <span class="built_in">LOGV</span>(<span class="string">&quot;IsInstanceOf() --&gt; Yes&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            (*env)-&gt;<span class="built_in">FatalError</span>(env, <span class="string">&quot;fatal error!&quot;</span>); <span class="comment">//抛出致命错误</span></span><br><span class="line">            <span class="built_in">LOGE</span>(<span class="string">&quot;FatalError()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        (*env)-&gt;<span class="built_in">PushLocalFrame</span>(env, <span class="number">2</span>);    <span class="comment">//申请局部引用空间，增加局部引用的管理</span></span><br><span class="line">        jobject obj_localref = (*env)-&gt;<span class="built_in">NewLocalRef</span>(env, obj); <span class="comment">//创建一个局部引用</span></span><br><span class="line">        jobject obj_globalref = (*env)-&gt;<span class="built_in">NewGlobalRef</span>(env, obj); <span class="comment">//创建一个全局引用</span></span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;PushLocalFrame()&quot;</span>);</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;NewLocalRef()&quot;</span>);</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;NewGlobalRef()&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (JNI_TRUE == (*env)-&gt;<span class="built_in">IsSameObject</span>(env, obj_localref, obj_globalref))&#123;</span><br><span class="line">            <span class="built_in">LOGV</span>(<span class="string">&quot;IsSameObject() --&gt; Yes&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        (*env)-&gt;<span class="built_in">DeleteLocalRef</span>(env, obj_localref);   <span class="comment">//删除一个局部引用</span></span><br><span class="line">        (*env)-&gt;<span class="built_in">DeleteGlobalRef</span>(env, obj_globalref); <span class="comment">//删除一个全局引用</span></span><br><span class="line">        (*env)-&gt;<span class="built_in">PopLocalFrame</span>(env, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;DeleteLocalRef()&quot;</span>);</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;DeleteGlobalRef()&quot;</span>);</span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;PopLocalFrame()&quot;</span>);</span><br><span class="line">        (*env)-&gt;<span class="built_in">MonitorExit</span>(env, obj);</span><br><span class="line">    &#125;</span><br><span class="line">    jclass sub_class = (*env)-&gt;<span class="built_in">FindClass</span>(env,<span class="string">&quot;com/droider/jnimethods/TestSubClass&quot;</span>); <span class="comment">//查询子类</span></span><br><span class="line">    jobject sub_obj = (*env)-&gt;<span class="built_in">AllocObject</span>(env, sub_class);</span><br><span class="line">    jmethodID sub_methodID = (*env)-&gt;<span class="built_in">GetMethodID</span>(env,sub_class, <span class="string">&quot;aVoidMethod&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    (*env)-&gt;<span class="built_in">CallNonvirtualVoidMethod</span>(env,sub_obj, sub_class, sub_methodID); <span class="comment">//调用子类的方法</span></span><br><span class="line">    (*env)-&gt;<span class="built_in">CallNonvirtualVoidMethod</span>(env,sub_obj, test_class, sub_methodID);    <span class="comment">//根据调用类的不同调用父类的方法</span></span><br><span class="line">    jfieldID sub_fieldID = (*env)-&gt;<span class="built_in">GetStaticFieldID</span>(env,sub_class, <span class="string">&quot;subFloatField&quot;</span>, <span class="string">&quot;F&quot;</span>);<span class="comment">//获取子类静态字段</span></span><br><span class="line">    (*env)-&gt;<span class="built_in">SetStaticFloatField</span>(env, sub_class, sub_fieldID, (jfloat)<span class="number">33.88f</span>);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;SetStaticFloatField() --&gt; %.2f&quot;</span>,(*env)-&gt;<span class="built_in">GetStaticFloatField</span>(env, sub_class, sub_fieldID));</span><br><span class="line">    jclass class_string = (*env)-&gt;<span class="built_in">FindClass</span>(env, <span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    jarray string_array = (*env)-&gt;<span class="built_in">NewObjectArray</span>(env, <span class="number">3</span>, class_string, <span class="number">0</span>); <span class="comment">//创建String数组</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;NewObjectArray()&quot;</span>);</span><br><span class="line">    jsize array_size = (*env)-&gt;<span class="built_in">GetArrayLength</span>(env, string_array);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetArrayLength() --&gt; %d&quot;</span>, array_size);</span><br><span class="line">    jstring array_string1 = (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, <span class="string">&quot;one&quot;</span>);</span><br><span class="line">    <span class="type">char</span> buff_char[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    (*env)-&gt;<span class="built_in">GetStringUTFRegion</span>(env, array_string1, <span class="number">0</span>, <span class="number">3</span>, buff_char);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetStringUTFRegion() --&gt; %s&quot;</span>, buff_char);</span><br><span class="line">    (*env)-&gt;<span class="built_in">SetObjectArrayElement</span>(env, string_array, <span class="number">0</span>, array_string1); <span class="comment">//设置数组元素的值</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;SetObjectArrayElement() --&gt; one&quot;</span>);</span><br><span class="line">    array_string1 = (jstring)(*env)-&gt;<span class="built_in">GetObjectArrayElement</span>(env, string_array, <span class="number">0</span>); <span class="comment">//获取数组元素的值</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* array_elemchars = (*env)-&gt;<span class="built_in">GetStringUTFChars</span>(env, array_string1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetObjectArrayElement() --&gt; %s&quot;</span>, array_elemchars);</span><br><span class="line">    (*env)-&gt;<span class="built_in">ReleaseStringUTFChars</span>(env, array_string1, array_elemchars);</span><br><span class="line">    jintArray int_array = (*env)-&gt;<span class="built_in">NewIntArray</span>(env, <span class="number">5</span>);     <span class="comment">//创建int数组</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;NewIntArray() --&gt; %d&quot;</span>, (*env)-&gt;<span class="built_in">GetArrayLength</span>(env, int_array)); <span class="comment">//获取数组长度</span></span><br><span class="line">    <span class="type">const</span> jint ints[] = &#123;<span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>&#125;;</span><br><span class="line">    (*env)-&gt;<span class="built_in">SetIntArrayRegion</span>(env, int_array, <span class="number">0</span>, <span class="number">5</span>, ints); <span class="comment">//设置数组一个范围的值ֵ</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;SetIntArrayRegion() --&gt; %d,%d,%d,%d,%d&quot;</span>,ints[<span class="number">0</span>], ints[<span class="number">1</span>], ints[<span class="number">2</span>], ints[<span class="number">3</span>], ints[<span class="number">4</span>]);</span><br><span class="line">    jint ints2[<span class="number">2</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    (*env)-&gt;<span class="built_in">GetIntArrayRegion</span>(env, int_array, <span class="number">1</span>, <span class="number">2</span>, ints2); <span class="comment">//获取数组一个范围的值</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetIntArrayRegion() --&gt; %d,%d&quot;</span>, ints2[<span class="number">0</span>], ints2[<span class="number">1</span>]);</span><br><span class="line">    jint* array_ints = (*env)-&gt;<span class="built_in">GetIntArrayElements</span>(env, int_array, <span class="literal">NULL</span>); <span class="comment">//获取指向所有元素的指针</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetIntArrayElements() --&gt; %d,%d,%d,%d,%d&quot;</span>,array_ints[<span class="number">0</span>], array_ints[<span class="number">1</span>], array_ints[<span class="number">2</span>], array_ints[<span class="number">3</span>], array_ints[<span class="number">4</span>]);</span><br><span class="line">    (*env)-&gt;<span class="built_in">ReleaseIntArrayElements</span>(env, int_array, array_ints, <span class="number">0</span>); <span class="comment">//释放指向所有元素的指针</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;ReleaseIntArrayElements()&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">thread_func</span><span class="params">(<span class="type">void</span> *arg)</span></span>&#123;</span><br><span class="line">    JNIEnv *env;</span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;thread_mutex);</span><br><span class="line">    <span class="keyword">if</span> (JNI_OK != (*g_vm)-&gt;<span class="built_in">AttachCurrentThread</span>(g_vm, &amp;env, <span class="literal">NULL</span>))&#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;AttachCurrentThread() failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;AttachCurrentThread() --&gt; thread:%d&quot;</span>, (jint)arg);</span><br><span class="line">    (*g_vm)-&gt;<span class="built_in">DetachCurrentThread</span>(g_vm);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;DetachCurrentThread() --&gt; thread:%d&quot;</span>, (jint)arg);</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;thread_mutex);</span><br><span class="line">    <span class="built_in">pthread_exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> <span class="title">newJniThreads</span><span class="params">(JNIEnv* env, jobject obj, jint nums)</span></span>&#123;</span><br><span class="line">    (*env)-&gt;<span class="built_in">GetJavaVM</span>(env, &amp;g_vm);    <span class="comment">//保存全局JavaVM</span></span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetJavaVM()&quot;</span>);</span><br><span class="line">    <span class="type">pthread_t</span>* pt = (<span class="type">pthread_t</span>*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">pthread_t</span>)* nums);</span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;thread_mutex, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; nums; i++)&#123;</span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;pt[i], <span class="literal">NULL</span>, &amp;thread_func, (<span class="type">void</span>*)i); <span class="comment">//创建线程</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(pt);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">JNIEXPORT jobject <span class="title">allocNativeBuffer</span><span class="params">(JNIEnv* env, jobject obj, jlong size)</span></span>&#123;</span><br><span class="line">    <span class="type">void</span>* buffer = <span class="built_in">malloc</span>(size);</span><br><span class="line">    jobject directBuffer = (*env)-&gt;<span class="built_in">NewDirectByteBuffer</span>(env, buffer, size);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;NewDirectByteBuffer() --&gt; %d&quot;</span>, (<span class="type">int</span>)size);</span><br><span class="line">    <span class="keyword">return</span> directBuffer;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> <span class="title">freeNativeBuffer</span><span class="params">(JNIEnv* env, jobject obj, jobject bufferRef)</span></span>&#123;</span><br><span class="line">    <span class="type">void</span> *buffer = (*env)-&gt;<span class="built_in">GetDirectBufferAddress</span>(env, bufferRef);</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;GetDirectBufferAddress() --&gt; %s&quot;</span>, buffer);</span><br><span class="line">    <span class="built_in">free</span>(buffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> JNINativeMethod methods[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;nativeMethod&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, (<span class="type">void</span>*)nativeMethod&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;newJniThreads&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, (<span class="type">void</span>*)newJniThreads&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;allocNativeBuffer&quot;</span>, <span class="string">&quot;(J)Ljava/lang/Object;&quot;</span>, (<span class="type">void</span>*)allocNativeBuffer&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;freeNativeBuffer&quot;</span>, <span class="string">&quot;(Ljava/lang/Object;)V&quot;</span>, (<span class="type">void</span>*)freeNativeBuffer&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(JNI_OK != (*vm)-&gt;<span class="built_in">GetEnv</span>(vm, (<span class="type">void</span>**)&amp;g_env, JNI_VERSION_1_6))&#123; <span class="comment">//加载指定版本的JNI</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;JNI_OnLoad()&quot;</span>);</span><br><span class="line">    native_class = (*g_env)-&gt;<span class="built_in">FindClass</span>(g_env, <span class="string">&quot;com/droider/jnimethods/TestJniMethods&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (JNI_OK ==(*g_env)-&gt;<span class="built_in">RegisterNatives</span>(g_env,native_class, methods, <span class="built_in">NELEM</span>(methods)))&#123;<span class="comment">//注册未声明的本地方法</span></span><br><span class="line">        <span class="built_in">LOGV</span>(<span class="string">&quot;RegisterNatives() --&gt; nativeMethod() ok&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;RegisterNatives() --&gt; nativeMethod() failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">jstring <span class="title">stoJstring</span><span class="params">( JNIEnv* env, <span class="type">const</span> <span class="type">char</span>* pat )</span></span>&#123;</span><br><span class="line">    jclass strClass = (*env)-&gt;<span class="built_in">FindClass</span>(env, <span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    jmethodID ctorID =  (*env)-&gt;<span class="built_in">GetMethodID</span>(env,strClass, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;([BLjava/lang/String;)V&quot;</span>);</span><br><span class="line">    jbyteArray bytes = (*env)-&gt;<span class="built_in">NewByteArray</span>(env, <span class="built_in">strlen</span>(pat));</span><br><span class="line">    (*env)-&gt;<span class="built_in">SetByteArrayRegion</span>(env, bytes, <span class="number">0</span>, <span class="built_in">strlen</span>(pat), pat);</span><br><span class="line">    jstring encoding = (*env)-&gt;<span class="built_in">NewStringUTF</span>(env, <span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (jstring)(*env)-&gt;<span class="built_in">NewObject</span>(env,strClass, ctorID, bytes, encoding);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">JNI_OnUnLoad</span><span class="params">(JavaVM* vm, <span class="type">void</span>* reserved)</span></span>&#123;</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;JNI_OnUnLoad()&quot;</span>);</span><br><span class="line">    (*g_env)-&gt;<span class="built_in">UnregisterNatives</span>(g_env, native_class);</span><br><span class="line">    <span class="built_in">LOGV</span>(<span class="string">&quot;UnregisterNatives()&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h2><p>可修改Smali，用android.util.Log类输出调试信息，如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Log.v(<span class="string">&quot;com.droider.jnimethods&quot;</span>,<span class="string">&quot;jni test a void subclass method, this run in java&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>除了v还有d、i、w、e方法，分别为VERBOSE、DEBUG、INFO、WARN、ERROR类型信息。第一个字符串为Tag标记，第二个为调试信息。命令行查看输出为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb logcat -s com.droider.jnimethods:V</span><br></pre></td></tr></table></figure>

<p>此时添加的反汇编代码为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const-string v3,&quot;SN&quot;</span><br><span class="line">invoke-static &#123;v3,v0&#125;,Landroid/util/Log;-&gt;v(Ljava/lang/String;Ljava/lang/String;)I</span><br></pre></td></tr></table></figure>

<p>也可以用异常来进行栈跟踪：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;print trace&quot;</span>).printStackTrace();</span><br></pre></td></tr></table></figure>

<p>对应反汇编代码为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">new-instance v0,Ljava/lang/Exception;</span><br><span class="line">const-string v1,&quot;print trace&quot;</span><br><span class="line">invoke-direct &#123;v0,v1&#125;,Ljava/lang/Exception;-&gt;&lt;init&gt;(Ljava/lang/String;)V</span><br><span class="line">invoke-virtual &#123;v0&#125;,Ljava/lang/Exception;-&gt;printStackTrace()V</span><br></pre></td></tr></table></figure>

<p>栈跟踪信息的Tag为System.err，WARN级别，运行时需要：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb logcat -s System.err:V *:W</span><br></pre></td></tr></table></figure>

<p>当调试Android原生程序时，需要：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">adb push .\debugnativeapp /data/local/tmp</span><br><span class="line">adb push D:\IDA9RC1\dbgsrv\android_server /data/local/tmp</span><br><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line"><span class="built_in">cd</span> /data/local/tmp</span><br><span class="line"><span class="built_in">chmod</span> 755 ./android_server</span><br><span class="line"><span class="built_in">chmod</span> 755 ./debugnativeapp</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">adb forward tcp:23946 tcp:23946</span><br><span class="line">adb shell /data/local/tmp/android_server</span><br></pre></td></tr></table></figure>

<p>然后设置IDA远程参数，Application为&#x2F;data&#x2F;local&#x2F;tmp&#x2F;debugnativeapp，Directory为&#x2F;data&#x2F;local&#x2F;tmp，Hostname为localhost。</p>
<p>当要调试动态链接库时，先开启端口转发与服务端，IDA再用Attach方法附加一个进程。可以在Debug options中设置各种初始化断点。但Android 5.0以上强制开启PIE，得找对应链接库所在的段，再计算函数相对偏移量去找。</p>
<p>IDA还可以Dump Android应用内存，即.so文件。IDA动调附加并设置断点后，在Modules窗口或下面命令查看.so文件起始地址和大小：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/pid/maps</span><br></pre></td></tr></table></figure>

<p>在IDA的Execute script中输入：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> file,fname,i,address,size,x;</span><br><span class="line">address=<span class="number">0x710D827000</span>; <span class="comment">//起始地址</span></span><br><span class="line">size=<span class="number">0xB25B000</span>; <span class="comment">//大小</span></span><br><span class="line">fname=<span class="string">&quot;D:\dump.so&quot;</span>;</span><br><span class="line">file=<span class="built_in">fopen</span>(fname,<span class="string">&quot;wb&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;size;i++,address++)&#123;</span><br><span class="line">    x=<span class="built_in">DbgByte</span>(address);</span><br><span class="line">    <span class="built_in">fputc</span>(x,file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">fclose</span>(file);</span><br></pre></td></tr></table></figure>

<p>还可以用JDB搭配Android Studio进行动调。下载<a target="_blank" rel="noopener" href="https://bitbucket.org/JesusFreke/smali/downloads/">https://bitbucket.org/JesusFreke/smali/downloads/</a> 下的smalidea-0.05.zip插件并安装到Android Stdio中，把用Apktool反编译的Smali源码导入Android Studio并Mark Directory as-&gt;Resources Root，标记为资源根目录。然后Run&#x2F;Debug Configurations下新建一个Remote调试配置，填写localhost和5005，然后在Android Device Monitor中查看pid并设置端口转发：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb shell ps | grep com.example</span><br><span class="line">adb forward tcp:5005 jdwp:29688</span><br></pre></td></tr></table></figure>

<h2 id="Android入门"><a href="#Android入门" class="headerlink" title="Android入门"></a>Android入门</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Android系统启动时，第一个启动的是init进程，后者根据读取&#x2F;init.rc中配置创建并启动App_process进程，也就是Zygote孵化器进程。Zygote启动后创建SystemServer进程，开始创建应用程序进程。Zygote是Android中所有应用的父进程，它开启Socket接口来监听请求，执行一个Android应用程序时，SystemServer通过Binder IPC发送命令给Zygote，后者通过自身的Dalvik虚拟机实例来启动应用程序。</p>
<p>SystermServer是Android核心进程之一，提供大部分Android基础服务，如AMS、WMS、PMS等。AMS为调度器，负责系统组件和应用程序的启动、切换、调度等工作。</p>
<p>Android应用启动时，手机屏幕是一个Activity，也叫做Launcher。Android应用一般通过触发来产生启动条件，Launcher进程接收事件并通知AMS，后者收到消息后，差u女鬼剑Taks启动指定Activity，此时AMS与Zygote通信，去Fork一个实例来执行应用。</p>
<p>Zygote提供三种创建进程的方法：<code>fork()</code>创建一个Zygote进程，<code>forkAndSpecialize()</code>创建一个非Zygote进程，<code>forkSystemServer()</code>创建一个系统服务进程。Zygote进程可再<code>fork()</code>处其他进程，而非Zygote进程不能fork其他进程，系统服务进程再终止后它的子进程也必需终止。</p>
<p>进程fork成功后，执行的工作交给Dalvik虚拟机，后者通过<code>loadClassFromDex()</code>完成类的装载，每个类成功解析后会拥有一个ClassObject类型的数据结构存储再运行时环境中。虚拟机用<code>gDvm.loadedClasses</code>全局哈希表来 存储与查询所有装载进来的类。随后字节码验证器用<code>dvmVerifyCodeFlow()</code>对装入的代码进行校验，接着虚拟机用<code>FindClass()</code>查找并装载main方法类，随后用<code>dvmInterpret()</code>初始化解释器并执行字节码流。</p>
<p>对于Android源码的下载，这里下载Android 4.1，Linux内核3.4。下载需要安装repo，这里略，安装后更新.bashrc为：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> REPO_URL=<span class="string">&#x27;https://mirrors.tuna.tsinghua.edu.cn/git/git-repo&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后初始化并同步：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-4.1.2_r1</span><br><span class="line">repo <span class="built_in">sync</span></span><br></pre></td></tr></table></figure>

<p>完全拉下来得好几十个GB，这里也建议直接在线阅读<a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/android-4.1.2_r2.1">https://cs.android.com/android/platform/superproject/+/android-4.1.2_r2.1</a>: 。</p>
<h3 id="关键代码定位"><a href="#关键代码定位" class="headerlink" title="关键代码定位"></a>关键代码定位</h3><p>一个Android程序由一个或多个Activity以及其他组件组成，每个Activity都是相同级别的。每个Android程序有且只有一个主Activity，隐藏程序除外。</p>
<p>例如找到AndroidManifest.xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.droider.crackme0502&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;8&quot;</span> <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;15&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme&quot;</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/ic_launcher&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.droider.crackme0502.MyApp&quot;</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/title_activity_main&quot;</span> <span class="attr">android:name</span>=<span class="string">&quot;com.droider.crackme0502.MainActivity&quot;</span>&gt;</span> <span class="comment">&lt;!--标题、类--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span> <span class="comment">&lt;!--启动意图--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span>/&gt;</span> <span class="comment">&lt;!--该Activity为主Activity--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span>/&gt;</span> <span class="comment">&lt;!--该Activity可通过LAUNCHER启动--&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>找到该主Activity后去找它的<code>OnCreate</code>方法即可。</p>
<p>有时可能出现Application类，用于程序组件间传递全局变量、在Activity启动前做初始化工作等。使用Application类时需要在程序中添加一个类继承自android.app.Application，并重写它的<code>OnCreate</code>。Application类启动比其他类要早，某些商业软件将授权验证代码转移到该类中。</p>
<h3 id="破解基础"><a href="#破解基础" class="headerlink" title="破解基础"></a>破解基础</h3><p>方法<code>createPackageContext</code>创建其他程序的Context，通过该Context可访问其他软件包资源，甚至执行其他软件包代码。该方法可能抛出java.lang.SecurityException安全异常，因为一个软件不能创建其他程序Context，除非两个软件拥有相同的用户ID与签名。用户ID在AndroidManifest.xml的manifest标签中指定，格式为android:sharedUserId&#x3D;&quot;xxx.xxx.xxx&quot;。当两个程序指定相同用户ID时，这两个程序运行在同一个进程空间，他们之间资源可相互访问，签名相同还可相互执行软件包之间代码。</p>
<p>抓包可用Shell自带的tcpdump，记录：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -p -vv -s 0 -w /sdcard/Download/capture.pcap</span><br></pre></td></tr></table></figure>

<p>用Ctrl+C结束，用adb拉下来，再用Wireshark分析。</p>
<p>有时Dalvik层定义的原生函数无法在Native层找到相同的函数名，可能是在<code>JNI_OnLoad</code>方法中注册其他函数与Java层方法关联了，找到<code>__data_start</code>即可。</p>
<p>APK可能在AndroidManifest.xml中Application标签加入<code>android:debuggable=&quot;false&quot;</code>，但实测没啥用。判断该值是否被修改过：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((getApplicationInfo().flags&amp;=ApplicationInfo.FLAG_DEBUGGABLE)!=<span class="number">0</span>)&#123;</span><br><span class="line">    Log.e(<span class="string">&quot;com.droider.antidebug&quot;</span>,<span class="string">&quot;程序被修改为可调试状态&quot;</span>);</span><br><span class="line">    android.os.Process.killProcess(android.os.Process.myPid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有种方法检测调试器是否已经连接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.os.Debug.isDebuggerConnected()</span><br></pre></td></tr></table></figure>

<p>可通过以下命令查看Android属性值，其中一些差异如下，不过现在模拟器都隐藏地很好了：</p>
<table>
<thead>
<tr>
<th>属性值</th>
<th>模拟器</th>
<th>正常手机</th>
</tr>
</thead>
<tbody><tr>
<td>ro.product.model</td>
<td>sdk</td>
<td>手机型号</td>
</tr>
<tr>
<td>ro.build.tags</td>
<td>test-keys</td>
<td>release-keys</td>
</tr>
<tr>
<td>ro.kernel.qemu</td>
<td>1</td>
<td>没有该值</td>
</tr>
</tbody></table>
<p>例如检测ro.kernel.qemu属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.droider.checkqemu;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.DataOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.Menu;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TextView text_info;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        setTitle(<span class="string">&quot;模拟器检测演示程序&quot;</span>);</span><br><span class="line">        text_info = (TextView) findViewById(R.id.textView1);</span><br><span class="line">        <span class="keyword">if</span> (isRunningInEmualtor()) &#123;    <span class="comment">//检测模拟器</span></span><br><span class="line">            text_info.setTextColor(Color.RED);</span><br><span class="line">            text_info.setText(<span class="string">&quot;程序运行在模拟器中！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            text_info.setTextColor(Color.GREEN);</span><br><span class="line">            text_info.setText(<span class="string">&quot;程序运行在真实设备中！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isRunningInEmualtor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">qemuKernel</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">DataOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;  </span><br><span class="line">            process = Runtime.getRuntime().exec(<span class="string">&quot;getprop ro.kernel.qemu&quot;</span>);  </span><br><span class="line">            os = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(process.getOutputStream());</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(),<span class="string">&quot;GBK&quot;</span>));</span><br><span class="line">            os.writeBytes(<span class="string">&quot;exit\n&quot;</span>);  </span><br><span class="line">            os.flush();</span><br><span class="line">            process.waitFor();</span><br><span class="line">            qemuKernel = (Integer.valueOf(in.readLine()) == <span class="number">1</span>);</span><br><span class="line">            Log.d(<span class="string">&quot;com.droider.checkqemu&quot;</span>, <span class="string">&quot;检测到模拟器:&quot;</span> + qemuKernel);             </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;  </span><br><span class="line">            qemuKernel = <span class="literal">false</span>;</span><br><span class="line">            Log.d(<span class="string">&quot;com.droider.checkqemu&quot;</span>, <span class="string">&quot;run failed&quot;</span> + e.getMessage()); </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;  </span><br><span class="line">                <span class="keyword">if</span> (os != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    os.close();  </span><br><span class="line">                &#125;  </span><br><span class="line">                process.destroy();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;  </span><br><span class="line">            Log.d(<span class="string">&quot;com.droider.checkqemu&quot;</span>, <span class="string">&quot;run finally&quot;</span>); </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> qemuKernel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getProp</span><span class="params">(Context context, String property)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> context.getClassLoader();</span><br><span class="line">            <span class="type">Class</span> <span class="variable">SystemProperties</span> <span class="operator">=</span> cl.loadClass(<span class="string">&quot;android.os.SystemProperties&quot;</span>);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> SystemProperties.getMethod(<span class="string">&quot;get&quot;</span>, String.class);</span><br><span class="line">            Object[] params = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">1</span>];</span><br><span class="line">            params[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">String</span>(property);</span><br><span class="line">            <span class="keyword">return</span> (String)method.invoke(SystemProperties, params);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> &#123;</span><br><span class="line">        getMenuInflater().inflate(R.menu.activity_main, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用PackageManager进行签名校验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.droider.checksignature;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageInfo;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.PackageManager;</span><br><span class="line"><span class="keyword">import</span> android.content.pm.Signature;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.view.Menu;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TextView text_info;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        setTitle(<span class="string">&quot;签名检查演示程序&quot;</span>);</span><br><span class="line">        text_info = (TextView) findViewById(R.id.textView1);</span><br><span class="line">        <span class="type">int</span> <span class="variable">sig</span> <span class="operator">=</span> getSignature(<span class="string">&quot;com.droider.checksignature&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sig != <span class="number">2071749217</span>) &#123;</span><br><span class="line">            text_info.setTextColor(Color.RED);</span><br><span class="line">            text_info.setText(<span class="string">&quot;检测到程序签名不一致，该程序被重新打包过！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            text_info.setTextColor(Color.GREEN);</span><br><span class="line">            text_info.setText(<span class="string">&quot;该程序没有被重新打包过！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSignature</span><span class="params">(String packageName)</span> &#123;      </span><br><span class="line">        <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> <span class="built_in">this</span>.getPackageManager();</span><br><span class="line">        <span class="type">PackageInfo</span> <span class="variable">pi</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sig</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pi = pm.getPackageInfo(packageName, PackageManager.GET_SIGNATURES);</span><br><span class="line">            Signature[] s = pi.signatures;</span><br><span class="line">            sig = s[<span class="number">0</span>].hashCode();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">            sig = <span class="number">0</span>;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sig;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> &#123;</span><br><span class="line">        getMenuInflater().inflate(R.menu.activity_main, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CRC校验classes.dex文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.droider.checkcrc;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipFile;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.Menu;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TextView text_info;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        setTitle(<span class="string">&quot;校验保护演示程序&quot;</span>);</span><br><span class="line">        text_info = (TextView) findViewById(R.id.textView1);</span><br><span class="line">        <span class="keyword">if</span> (checkCRC()) &#123;    <span class="comment">//对比classes.dex的校验和</span></span><br><span class="line">            text_info.setTextColor(Color.GREEN);</span><br><span class="line">            text_info.setText(<span class="string">&quot;程序正常！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            text_info.setTextColor(Color.RED);</span><br><span class="line">            text_info.setText(<span class="string">&quot;程序被修改过！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkCRC</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">beModified</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">crc</span> <span class="operator">=</span> Long.parseLong(getString(R.string.crc));</span><br><span class="line">        ZipFile zf;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zf = <span class="keyword">new</span> <span class="title class_">ZipFile</span>(getApplicationContext().getPackageCodePath());</span><br><span class="line">            <span class="type">ZipEntry</span> <span class="variable">ze</span> <span class="operator">=</span> zf.getEntry(<span class="string">&quot;classes.dex&quot;</span>);</span><br><span class="line">            Log.d(<span class="string">&quot;com.droider.checkcrc&quot;</span>, String.valueOf(ze.getCrc()));</span><br><span class="line">            <span class="keyword">if</span> (ze.getCrc() == crc) &#123;</span><br><span class="line">                beModified = <span class="literal">true</span>;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            beModified = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beModified;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> &#123;</span><br><span class="line">        getMenuInflater().inflate(R.menu.activity_main, menu);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://monoceros406.github.io/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">https://monoceros406.github.io/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://monoceros406.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/">移动安全</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-%E5%AE%89%E5%85%A8%E5%9F%BA%E7%BA%BF/" title="安卓逆向入门-安全基线"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">安卓逆向入门-安全基线</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/20/Web%E5%85%A5%E9%97%A8-JS%E9%80%86%E5%90%91/" title="Web入门-JS逆向"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Web入门-JS逆向</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/14/Android%E5%8F%8D%E8%B0%83%E8%AF%95/" title="Android反调试"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-14</div><div class="title">Android反调试</div></div></a></div><div><a href="/2023/11/02/Android%E5%85%A5%E9%97%A8/" title="Android入门"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-02</div><div class="title">Android入门</div></div></a></div><div><a href="/2023/10/23/Frida%E5%88%9D%E4%BD%93%E9%AA%8C/" title="Frida初体验"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-23</div><div class="title">Frida初体验</div></div></a></div><div><a href="/2023/10/23/Jadx%E5%9C%A8%E9%9B%B7%E7%94%B5%E6%A8%A1%E6%8B%9F%E5%99%A8%E4%B8%8B%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/" title="Jadx在雷电模拟器下的远程动态调试笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-23</div><div class="title">Jadx在雷电模拟器下的远程动态调试笔记</div></div></a></div><div><a href="/2024/03/10/%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8%E5%88%9D%E6%8E%A2/" title="安卓安全初探"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-10</div><div class="title">安卓安全初探</div></div></a></div><div><a href="/2024/11/09/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Android%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Android后端开发入门"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-09</div><div class="title">安卓逆向入门-Android后端开发入门</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">Windows系统安全爱好者</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">330</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">30</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://monoceros406.github.io/atom.xml" target="_blank" title=""><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">哪里排版出锅了请告诉我QwQ  QQ:1295625063</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">安卓逆向入门-基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#adb"><span class="toc-number">1.1.</span> <span class="toc-text">adb</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#APK%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">APK文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">1.3.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%90%8D"><span class="toc-number">1.3.1.</span> <span class="toc-text">签名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dalvik%E5%AD%97%E8%8A%82%E7%A0%81%E7%94%9F%E6%88%90"><span class="toc-number">1.3.2.</span> <span class="toc-text">Dalvik字节码生成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NDK%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8"><span class="toc-number">1.4.</span> <span class="toc-text">NDK开发入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dalvik%E6%B1%87%E7%BC%96-Smali%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">1.5.</span> <span class="toc-text">Dalvik汇编&#x2F;Smali字节码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">1.5.1.</span> <span class="toc-text">入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="toc-number">1.5.2.</span> <span class="toc-text">常用指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.5.3.</span> <span class="toc-text">文件格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB"><span class="toc-number">1.5.4.</span> <span class="toc-text">类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91"><span class="toc-number">1.5.5.</span> <span class="toc-text">反编译</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARM%E5%85%A5%E9%97%A8"><span class="toc-number">1.6.</span> <span class="toc-text">ARM入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.6.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80"><span class="toc-number">1.6.2.</span> <span class="toc-text">汇编基础</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android%E5%8E%9F%E7%94%9F%E9%80%86%E5%90%91"><span class="toc-number">1.7.</span> <span class="toc-text">Android原生逆向</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">1.8.</span> <span class="toc-text">动态调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android%E5%85%A5%E9%97%A8"><span class="toc-number">1.9.</span> <span class="toc-text">Android入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.9.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.9.2.</span> <span class="toc-text">关键代码定位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A0%B4%E8%A7%A3%E5%9F%BA%E7%A1%80"><span class="toc-number">1.9.3.</span> <span class="toc-text">破解基础</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/15/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E6%97%B6%E9%97%B4/" title="Linux编程入门-时间">Linux编程入门-时间</a><time datetime="2025-06-15T12:50:21.000Z" title="发表于 2025-06-15 20:50:21">2025-06-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/15/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E4%B8%8E%E5%AE%89%E5%85%A8/" title="Linux编程入门-用户管理与安全">Linux编程入门-用户管理与安全</a><time datetime="2025-06-15T02:58:13.000Z" title="发表于 2025-06-15 10:58:13">2025-06-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/15/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" title="Linux编程入门-内存管理">Linux编程入门-内存管理</a><time datetime="2025-06-15T01:00:35.000Z" title="发表于 2025-06-15 09:00:35">2025-06-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/14/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E8%BF%9B%E7%A8%8B/" title="Linux编程入门-进程">Linux编程入门-进程</a><time datetime="2025-06-14T14:02:30.000Z" title="发表于 2025-06-14 22:02:30">2025-06-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/08/Linux%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6I-O/" title="Linux编程入门-文件I/O">Linux编程入门-文件I/O</a><time datetime="2025-06-08T00:27:36.000Z" title="发表于 2025-06-08 08:27:36">2025-06-08</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>