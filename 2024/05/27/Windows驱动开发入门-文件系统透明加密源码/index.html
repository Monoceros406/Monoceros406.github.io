<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Windows驱动开发入门-文件系统透明加密源码 | The Blog of Monoceros406</title><meta name="author" content="Monoceros406"><meta name="copyright" content="Monoceros406"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Windows驱动开发入门-文件系统透明加密源码上一节的源码。 源代码cf_create.c1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows驱动开发入门-文件系统透明加密源码">
<meta property="og:url" content="http://monoceros.github.io/2024/05/27/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%80%8F%E6%98%8E%E5%8A%A0%E5%AF%86%E6%BA%90%E7%A0%81/index.html">
<meta property="og:site_name" content="The Blog of Monoceros406">
<meta property="og:description" content="Windows驱动开发入门-文件系统透明加密源码上一节的源码。 源代码cf_create.c1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://monoceros.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-05-27T13:36:24.000Z">
<meta property="article:modified_time" content="2024-05-27T13:45:39.331Z">
<meta property="article:author" content="Monoceros406">
<meta property="article:tag" content="逆向工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://monoceros.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="http://monoceros.github.io/2024/05/27/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%80%8F%E6%98%8E%E5%8A%A0%E5%AF%86%E6%BA%90%E7%A0%81/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Windows驱动开发入门-文件系统透明加密源码',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-27 21:45:39'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">257</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/ycy')"><nav id="nav"><span id="blog-info"><a href="/" title="The Blog of Monoceros406"><span class="site-name">The Blog of Monoceros406</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Windows驱动开发入门-文件系统透明加密源码</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-27T13:36:24.000Z" title="发表于 2024-05-27 21:36:24">2024-05-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-27T13:45:39.331Z" title="更新于 2024-05-27 21:45:39">2024-05-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Windows驱动开发入门-文件系统透明加密源码"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Windows驱动开发入门-文件系统透明加密源码"><a href="#Windows驱动开发入门-文件系统透明加密源码" class="headerlink" title="Windows驱动开发入门-文件系统透明加密源码"></a>Windows驱动开发入门-文件系统透明加密源码</h1><p>上一节的源码。</p>
<h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><h3 id="cf-create-c"><a href="#cf-create-c" class="headerlink" title="cf_create.c"></a>cf_create.c</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_create.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-2-4</span></span><br><span class="line"><span class="comment">/// @brief      实现对create irp的处理。 </span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 免责声明</span></span><br><span class="line"><span class="comment">/// 本代码为示例代码。未经详尽测试，不保证可靠性。作者对</span></span><br><span class="line"><span class="comment">/// 任何人使用此代码导致的直接和间接损失不负责任。</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是楚狂人与wowocock为《寒江独</span></span><br><span class="line"><span class="comment">/// 钓——Windows内核编程与信息安全》所编写的文件透明加密</span></span><br><span class="line"><span class="comment">/// 示例。本工程仅仅支持WindowsXP下，FastFat文件系统下记事</span></span><br><span class="line"><span class="comment">/// 本的加密。未测试与杀毒软件或者其他文件过滤驱动并存的</span></span><br><span class="line"><span class="comment">/// 情况。本代码全部权利为作者保留，仅供读者学习和阅读使</span></span><br><span class="line"><span class="comment">/// 用。未经两位作者书面授权，不得直接复制、或者基于此代</span></span><br><span class="line"><span class="comment">/// 码进行修改、利用此代码提供的全部或者部分技术用于商业</span></span><br><span class="line"><span class="comment">/// 的软件开发、或者其他的获利行为。如有违反，作者保留起</span></span><br><span class="line"><span class="comment">/// 诉和获取赔偿之权力。阅读此代码，则自动视为接受以上授</span></span><br><span class="line"><span class="comment">/// 权协议。如不接受此协议者，请不要阅读此代码。</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;..\inc\sfilter\sfilter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_list.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_file_irp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CF_FILE_HEADER_SIZE (1024*4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CF_MEM_TAG <span class="string">&#x27;cfct&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在create之前的时候，获得完整的路径。</span></span><br><span class="line"><span class="function">ULONG</span></span><br><span class="line"><span class="function"><span class="title">cfFileFullPathPreCreate</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">						PFILE_OBJECT file,</span></span></span><br><span class="line"><span class="params"><span class="function">                        PUNICODE_STRING path</span></span></span><br><span class="line"><span class="params"><span class="function">						)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	POBJECT_NAME_INFORMATION  obj_name_info = <span class="literal">NULL</span>;</span><br><span class="line">	WCHAR buf[<span class="number">64</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="type">void</span> *obj_ptr;</span><br><span class="line">	ULONG length = <span class="number">0</span>;</span><br><span class="line">	BOOLEAN need_split = FALSE;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ASSERT</span>( file != <span class="literal">NULL</span> );</span><br><span class="line">	<span class="keyword">if</span>(file == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(file-&gt;FileName.Buffer == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	obj_name_info = (POBJECT_NAME_INFORMATION)buf;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取FileName前面的部分（设备路径或者根目录路径）</span></span><br><span class="line">		<span class="keyword">if</span>(file-&gt;RelatedFileObject != <span class="literal">NULL</span>)</span><br><span class="line">			obj_ptr = (<span class="type">void</span> *)file-&gt;RelatedFileObject;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			obj_ptr= (<span class="type">void</span> *)file-&gt;DeviceObject;</span><br><span class="line">		status = <span class="built_in">ObQueryNameString</span>(obj_ptr,obj_name_info,<span class="number">64</span>*<span class="built_in">sizeof</span>(WCHAR),&amp;length);</span><br><span class="line">		<span class="keyword">if</span>(status == STATUS_INFO_LENGTH_MISMATCH)</span><br><span class="line">		&#123;</span><br><span class="line">			obj_name_info = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool,length,CF_MEM_TAG);</span><br><span class="line">			<span class="keyword">if</span>(obj_name_info == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">			<span class="built_in">RtlZeroMemory</span>(obj_name_info,length);</span><br><span class="line">			status = <span class="built_in">ObQueryNameString</span>(obj_ptr,obj_name_info,length,&amp;length);            </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 失败了就直接跳出即可</span></span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 判断二者之间是否需要多一个斜杠。这需要两个条件:</span></span><br><span class="line">		<span class="comment">// FileName第一个字符不是斜杠。obj_name_info最后一个</span></span><br><span class="line">		<span class="comment">// 字符不是斜杠。</span></span><br><span class="line">		<span class="keyword">if</span>( file-&gt;FileName.Length &gt; <span class="number">2</span> &amp;&amp;</span><br><span class="line">			file-&gt;FileName.Buffer[ <span class="number">0</span> ] != <span class="string">L&#x27;\\&#x27;</span> &amp;&amp;</span><br><span class="line">			obj_name_info-&gt;Name.Buffer[ obj_name_info-&gt;Name.Length / <span class="built_in">sizeof</span>(WCHAR) - <span class="number">1</span> ] != <span class="string">L&#x27;\\&#x27;</span> )</span><br><span class="line">			need_split = TRUE;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获总体名字的长度。如果长度不足，也直接返回。</span></span><br><span class="line">		length = obj_name_info-&gt;Name.Length + file-&gt;FileName.Length;</span><br><span class="line">		<span class="keyword">if</span>(need_split)</span><br><span class="line">			length += <span class="built_in">sizeof</span>(WCHAR);</span><br><span class="line">		<span class="keyword">if</span>(path-&gt;MaximumLength &lt; length)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 先把设备名拷贝进去。</span></span><br><span class="line">		<span class="built_in">RtlCopyUnicodeString</span>(path,&amp;obj_name_info-&gt;Name);</span><br><span class="line">		<span class="keyword">if</span>(need_split)</span><br><span class="line">			<span class="comment">// 追加一个斜杠</span></span><br><span class="line">			<span class="built_in">RtlAppendUnicodeToString</span>(path,<span class="string">L&quot;\\&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 然后追加FileName</span></span><br><span class="line">		<span class="built_in">RtlAppendUnicodeStringToString</span>(path,&amp;file-&gt;FileName);</span><br><span class="line">	&#125; <span class="keyword">while</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果分配过空间就释放掉。</span></span><br><span class="line">	<span class="keyword">if</span>((<span class="type">void</span> *)obj_name_info != (<span class="type">void</span> *)buf)</span><br><span class="line">		<span class="built_in">ExFreePool</span>(obj_name_info);</span><br><span class="line">	<span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用IoCreateFileSpecifyDeviceObjectHint来打开文件。</span></span><br><span class="line"><span class="comment">// 这个文件打开之后不进入加密链表，所以可以直接</span></span><br><span class="line"><span class="comment">// Read和Write,不会被加密。</span></span><br><span class="line"><span class="function">HANDLE <span class="title">cfCreateFileAccordingIrp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">   IN PDEVICE_OBJECT dev,</span></span></span><br><span class="line"><span class="params"><span class="function">   IN PUNICODE_STRING file_full_path,</span></span></span><br><span class="line"><span class="params"><span class="function">   IN PIO_STACK_LOCATION irpsp,</span></span></span><br><span class="line"><span class="params"><span class="function">   OUT NTSTATUS *status,</span></span></span><br><span class="line"><span class="params"><span class="function">   OUT PFILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">   OUT PULONG information)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE file_h = <span class="literal">NULL</span>;</span><br><span class="line">	IO_STATUS_BLOCK io_status;</span><br><span class="line">	ULONG desired_access;</span><br><span class="line">	ULONG disposition;</span><br><span class="line">	ULONG create_options;</span><br><span class="line">	ULONG share_access;</span><br><span class="line">	ULONG file_attri;</span><br><span class="line">    OBJECT_ATTRIBUTES obj_attri;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ASSERT</span>(irpsp-&gt;MajorFunction == IRP_MJ_CREATE);</span><br><span class="line"></span><br><span class="line">    *information = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 填写object attribute</span></span><br><span class="line">    <span class="built_in">InitializeObjectAttributes</span>(</span><br><span class="line">        &amp;obj_attri,</span><br><span class="line">        file_full_path,</span><br><span class="line">        OBJ_KERNEL_HANDLE|OBJ_CASE_INSENSITIVE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得IRP中的参数。</span></span><br><span class="line">	desired_access = irpsp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess;</span><br><span class="line">	disposition = (irpsp-&gt;Parameters.Create.Options&gt;&gt;<span class="number">24</span>);</span><br><span class="line">	create_options = (irpsp-&gt;Parameters.Create.Options &amp; <span class="number">0x00ffffff</span>);</span><br><span class="line">	share_access = irpsp-&gt;Parameters.Create.ShareAccess;</span><br><span class="line">	file_attri = irpsp-&gt;Parameters.Create.FileAttributes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用IoCreateFileSpecifyDeviceObjectHint打开文件。</span></span><br><span class="line">    *status = <span class="built_in">IoCreateFileSpecifyDeviceObjectHint</span>(</span><br><span class="line">        &amp;file_h,</span><br><span class="line">        desired_access,</span><br><span class="line">        &amp;obj_attri,</span><br><span class="line">        &amp;io_status,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        file_attri,</span><br><span class="line">        share_access,</span><br><span class="line">        disposition,</span><br><span class="line">        create_options,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        CreateFileTypeNone,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(*status))</span><br><span class="line">        <span class="keyword">return</span> file_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记住information,便于外面使用。</span></span><br><span class="line">    *information = io_status.Information;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从句柄得到一个fileobject便于后面的操作。记得一定要解除</span></span><br><span class="line">    <span class="comment">// 引用。</span></span><br><span class="line">    *status = <span class="built_in">ObReferenceObjectByHandle</span>(</span><br><span class="line">        file_h,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        *IoFileObjectType,</span><br><span class="line">        KernelMode,</span><br><span class="line">        file,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果失败了就关闭，假设没打开文件。但是这个实际上是不</span></span><br><span class="line">    <span class="comment">// 应该出现的。</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(*status))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">        <span class="built_in">ZwClose</span>(file_h);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> file_h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入一个文件头。</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">cfWriteAHeader</span><span class="params">(PFILE_OBJECT file,PDEVICE_OBJECT next_dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> WCHAR header_flags[CF_FILE_HEADER_SIZE/<span class="built_in">sizeof</span>(WCHAR)] = &#123;<span class="string">L&#x27;C&#x27;</span>,<span class="string">L&#x27;F&#x27;</span>,<span class="string">L&#x27;H&#x27;</span>,<span class="string">L&#x27;D&#x27;</span>&#125;;</span><br><span class="line">    LARGE_INTEGER file_size,offset;</span><br><span class="line">    ULONG length = CF_FILE_HEADER_SIZE;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    offset.QuadPart = <span class="number">0</span>;</span><br><span class="line">    file_size.QuadPart = CF_FILE_HEADER_SIZE;</span><br><span class="line">    <span class="comment">// 首先设置文件的大小为4k。</span></span><br><span class="line">    status = <span class="built_in">cfFileSetFileSize</span>(next_dev,file,&amp;file_size);</span><br><span class="line">    <span class="keyword">if</span>(status != STATUS_SUCCESS)</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 然后写入8个字节的头。</span></span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">cfFileReadWrite</span>(next_dev,file,&amp;offset,&amp;length,header_flags,FALSE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开预处理。</span></span><br><span class="line"><span class="function">ULONG <span class="title">cfIrpCreatePre</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PIRP irp,</span></span></span><br><span class="line"><span class="params"><span class="function">    PIO_STACK_LOCATION irpsp,</span></span></span><br><span class="line"><span class="params"><span class="function">    PFILE_OBJECT file,</span></span></span><br><span class="line"><span class="params"><span class="function">    PDEVICE_OBJECT next_dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UNICODE_STRING path = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// 首先获得要打开文件的路径。</span></span><br><span class="line">    ULONG length = <span class="built_in">cfFileFullPathPreCreate</span>(file,&amp;path);</span><br><span class="line">    NTSTATUS status;</span><br><span class="line">    ULONG ret = SF_IRP_PASS;</span><br><span class="line">    PFILE_OBJECT my_file = <span class="literal">NULL</span>;</span><br><span class="line">    HANDLE file_h;</span><br><span class="line">    ULONG information = <span class="number">0</span>;</span><br><span class="line">    LARGE_INTEGER file_size,offset = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    BOOLEAN dir,sec_file;</span><br><span class="line">    <span class="comment">// 获得打开访问期望。</span></span><br><span class="line">	ULONG desired_access = irpsp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess;</span><br><span class="line">    WCHAR header_flags[<span class="number">4</span>] = &#123;<span class="string">L&#x27;C&#x27;</span>,<span class="string">L&#x27;F&#x27;</span>,<span class="string">L&#x27;H&#x27;</span>,<span class="string">L&#x27;D&#x27;</span>&#125;;</span><br><span class="line">    WCHAR header_buf[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ULONG disp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无法得到路径，直接放过即可。</span></span><br><span class="line">    <span class="keyword">if</span>(length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果只是想打开目录的话，直接放过</span></span><br><span class="line">    <span class="keyword">if</span>(irpsp-&gt;Parameters.Create.Options &amp; FILE_DIRECTORY_FILE)</span><br><span class="line">        <span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 给path分配缓冲区</span></span><br><span class="line">        path.Buffer = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool,length+<span class="number">4</span>,CF_MEM_TAG);</span><br><span class="line">        path.Length = <span class="number">0</span>;</span><br><span class="line">        path.MaximumLength = (USHORT)length + <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span>(path.Buffer == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 内存不够，这个请求直接挂掉</span></span><br><span class="line">            status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">            ret = SF_IRP_COMPLETED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        length = <span class="built_in">cfFileFullPathPreCreate</span>(file,&amp;path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到了路径，打开这个文件。</span></span><br><span class="line">        file_h = <span class="built_in">cfCreateFileAccordingIrp</span>(</span><br><span class="line">            next_dev,</span><br><span class="line">            &amp;path,</span><br><span class="line">            irpsp,</span><br><span class="line">            &amp;status,</span><br><span class="line">            &amp;my_file,</span><br><span class="line">            &amp;information);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果没有成功的打开，那么说明这个请求可以结束了</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">        &#123;</span><br><span class="line">            ret = SF_IRP_COMPLETED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到了my_file之后，首先判断这个文件是不是已经在</span></span><br><span class="line">        <span class="comment">// 加密的文件之中。如果在，直接返回passthru即可</span></span><br><span class="line">        <span class="built_in">cfListLock</span>();</span><br><span class="line">        sec_file = <span class="built_in">cfIsFileCrypting</span>(my_file);</span><br><span class="line">        <span class="built_in">cfListUnlock</span>();</span><br><span class="line">        <span class="keyword">if</span>(sec_file)</span><br><span class="line">        &#123;</span><br><span class="line">            ret = SF_IRP_PASS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 现在虽然打开，但是这依然可能是一个目录。在这里</span></span><br><span class="line">        <span class="comment">// 判断一下。同时也可以得到文件的大小。</span></span><br><span class="line">        status = <span class="built_in">cfFileGetStandInfo</span>(</span><br><span class="line">	        next_dev,</span><br><span class="line">	        my_file,</span><br><span class="line">	        <span class="literal">NULL</span>,</span><br><span class="line">	        &amp;file_size,</span><br><span class="line">	        &amp;dir);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询失败。禁止打开。</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">        &#123;</span><br><span class="line">            ret = SF_IRP_COMPLETED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果这是一个目录，那么不管它了。</span></span><br><span class="line">        <span class="keyword">if</span>(dir)</span><br><span class="line">        &#123;</span><br><span class="line">            ret = SF_IRP_PASS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果文件大小为0，且有写入或者追加数据的意图，</span></span><br><span class="line">        <span class="comment">// 就应该加密文件。应该在这里写入文件头。这也是唯</span></span><br><span class="line">        <span class="comment">// 一需要写入文件头的地方。</span></span><br><span class="line">        <span class="keyword">if</span>(file_size.QuadPart == <span class="number">0</span> &amp;&amp; </span><br><span class="line">            (desired_access &amp; </span><br><span class="line">                (FILE_WRITE_DATA| </span><br><span class="line">		        FILE_APPEND_DATA)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 不管是否成功。一定要写入头。</span></span><br><span class="line">            <span class="built_in">cfWriteAHeader</span>(my_file,next_dev);</span><br><span class="line">            <span class="comment">// 写入头之后，这个文件属于必须加密的文件</span></span><br><span class="line">            ret = SF_IRP_GO_ON;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这个文件有大小，而且大小小于头长度。不需要加密。</span></span><br><span class="line">        <span class="keyword">if</span>(file_size.QuadPart &lt; CF_FILE_HEADER_SIZE)</span><br><span class="line">        &#123;</span><br><span class="line">            ret = SF_IRP_PASS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 现在读取文件。比较来看是否需要加密，直接读个8字</span></span><br><span class="line">        <span class="comment">// 节就足够了。这个文件有大小，而且比CF_FILE_HEADER_SIZE</span></span><br><span class="line">        <span class="comment">// 长。此时读出前8个字节，判断是否要加密。</span></span><br><span class="line">        length = <span class="number">8</span>;</span><br><span class="line">        status = <span class="built_in">cfFileReadWrite</span>(next_dev,my_file,&amp;offset,&amp;length,header_buf,TRUE);</span><br><span class="line">        <span class="keyword">if</span>(status != STATUS_SUCCESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果失败了就不加密了。</span></span><br><span class="line">            <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">            ret = SF_IRP_PASS;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 读取到内容，比较和加密标志是一致的，加密。</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">RtlCompareMemory</span>(header_flags,header_buf,<span class="number">8</span>) == <span class="number">8</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 到这里认为是必须加密的。这种情况下，必须返回GO_ON.</span></span><br><span class="line">            ret = SF_IRP_GO_ON;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 其他的情况都是不需要加密的。</span></span><br><span class="line">        ret = SF_IRP_PASS;</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(path.Buffer != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">ExFreePool</span>(path.Buffer);    </span><br><span class="line">    <span class="keyword">if</span>(file_h != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">ZwClose</span>(file_h);</span><br><span class="line">    <span class="keyword">if</span>(ret == SF_IRP_GO_ON)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 要加密的，这里清一下缓冲。避免文件头出现在缓冲里。</span></span><br><span class="line">        <span class="built_in">cfFileCacheClear</span>(my_file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(my_file != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">ObDereferenceObject</span>(my_file);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果要返回完成，则必须把这个请求完成。这一般都是</span></span><br><span class="line">    <span class="comment">// 以错误作为结局的。</span></span><br><span class="line">    <span class="keyword">if</span>(ret == SF_IRP_COMPLETED)</span><br><span class="line">    &#123;</span><br><span class="line">		irp-&gt;IoStatus.Status = status;</span><br><span class="line">		irp-&gt;IoStatus.Information = information;</span><br><span class="line">        <span class="built_in">IoCompleteRequest</span>(irp, IO_NO_INCREMENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要注意:</span></span><br><span class="line">    <span class="comment">// 1.文件的CREATE改为OPEN.</span></span><br><span class="line">    <span class="comment">// 2.文件的OVERWRITE去掉。不管是不是要加密的文件，</span></span><br><span class="line">    <span class="comment">// 都必须这样做。否则的话，本来是试图生成文件的，</span></span><br><span class="line">    <span class="comment">// 结果发现文件已经存在了。本来试图覆盖文件的，再</span></span><br><span class="line">    <span class="comment">// 覆盖一次会去掉加密头。</span></span><br><span class="line">    disp = FILE_OPEN;</span><br><span class="line">    irpsp-&gt;Parameters.Create.Options &amp;= <span class="number">0x00ffffff</span>;</span><br><span class="line">    irpsp-&gt;Parameters.Create.Options |= (disp &lt;&lt; <span class="number">24</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="cf-file-irp-c"><a href="#cf-file-irp-c" class="headerlink" title="cf_file_irp.c"></a>cf_file_irp.c</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_file_irp.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-1-29</span></span><br><span class="line"><span class="comment">/// @brief       对文件的操作，直接发送irp来避免重入</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 免责声明</span></span><br><span class="line"><span class="comment">/// 本代码为示例代码。未经详尽测试，不保证可靠性。作者对</span></span><br><span class="line"><span class="comment">/// 任何人使用此代码导致的直接和间接损失不负责任。</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是楚狂人与wowocock为《寒江独</span></span><br><span class="line"><span class="comment">/// 钓——Windows内核编程与信息安全》所编写的文件透明加密</span></span><br><span class="line"><span class="comment">/// 示例。本工程仅仅支持WindowsXP下，FastFat文件系统下记事</span></span><br><span class="line"><span class="comment">/// 本的加密。未测试与杀毒软件或者其他文件过滤驱动并存的</span></span><br><span class="line"><span class="comment">/// 情况。本代码全部权利为作者保留，仅供读者学习和阅读使</span></span><br><span class="line"><span class="comment">/// 用。未经两位作者书面授权，不得直接复制、或者基于此代</span></span><br><span class="line"><span class="comment">/// 码进行修改、利用此代码提供的全部或者部分技术用于商业</span></span><br><span class="line"><span class="comment">/// 的软件开发、或者其他的获利行为。如有违反，作者保留起</span></span><br><span class="line"><span class="comment">/// 诉和获取赔偿之权力。阅读此代码，则自动视为接受以上授</span></span><br><span class="line"><span class="comment">/// 权协议。如不接受此协议者，请不要阅读此代码。</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CF_MEM_TAG <span class="string">&#x27;cffi&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> NTSTATUS <span class="title">cfFileIrpComp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PDEVICE_OBJECT dev,</span></span></span><br><span class="line"><span class="params"><span class="function">    PIRP irp,</span></span></span><br><span class="line"><span class="params"><span class="function">    PVOID context</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *irp-&gt;UserIosb = irp-&gt;IoStatus;</span><br><span class="line">    <span class="built_in">KeSetEvent</span>(irp-&gt;UserEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">    <span class="built_in">IoFreeIrp</span>(irp);</span><br><span class="line">    <span class="keyword">return</span> STATUS_MORE_PROCESSING_REQUIRED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自发送SetInformation请求.</span></span><br><span class="line"><span class="function">NTSTATUS </span></span><br><span class="line"><span class="function"><span class="title">cfFileSetInformation</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">    DEVICE_OBJECT *dev, </span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_INFORMATION_CLASS infor_class,</span></span></span><br><span class="line"><span class="params"><span class="function">	FILE_OBJECT *set_file,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>* buf,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG buf_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIRP irp;</span><br><span class="line">    KEVENT event;</span><br><span class="line">    IO_STATUS_BLOCK IoStatusBlock;</span><br><span class="line">    PIO_STACK_LOCATION ioStackLocation;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">KeInitializeEvent</span>(&amp;event, SynchronizationEvent, FALSE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 分配irp</span></span><br><span class="line">    irp = <span class="built_in">IoAllocateIrp</span>(dev-&gt;StackSize, FALSE);</span><br><span class="line">    <span class="keyword">if</span>(irp == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 填写irp的主体</span></span><br><span class="line">    irp-&gt;AssociatedIrp.SystemBuffer = buf;</span><br><span class="line">    irp-&gt;UserEvent = &amp;event;</span><br><span class="line">    irp-&gt;UserIosb = &amp;IoStatusBlock;</span><br><span class="line">    irp-&gt;Tail.Overlay.Thread = <span class="built_in">PsGetCurrentThread</span>();</span><br><span class="line">    irp-&gt;Tail.Overlay.OriginalFileObject = file;</span><br><span class="line">    irp-&gt;RequestorMode = KernelMode;</span><br><span class="line">    irp-&gt;Flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置irpsp</span></span><br><span class="line">    ioStackLocation = <span class="built_in">IoGetNextIrpStackLocation</span>(irp);</span><br><span class="line">    ioStackLocation-&gt;MajorFunction = IRP_MJ_SET_INFORMATION;</span><br><span class="line">    ioStackLocation-&gt;DeviceObject = dev;</span><br><span class="line">    ioStackLocation-&gt;FileObject = file;</span><br><span class="line">    ioStackLocation-&gt;Parameters.SetFile.FileObject = set_file;</span><br><span class="line">    ioStackLocation-&gt;Parameters.SetFile.Length = buf_len;</span><br><span class="line">    ioStackLocation-&gt;Parameters.SetFile.FileInformationClass = infor_class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置结束例程</span></span><br><span class="line">    <span class="built_in">IoSetCompletionRoutine</span>(irp, cfFileIrpComp, <span class="number">0</span>, TRUE, TRUE, TRUE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 发送请求并等待结束</span></span><br><span class="line">    (<span class="type">void</span>) <span class="built_in">IoCallDriver</span>(dev, irp);</span><br><span class="line">    <span class="built_in">KeWaitForSingleObject</span>(&amp;event, Executive, KernelMode, TRUE, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> IoStatusBlock.Status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">cfFileQueryInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DEVICE_OBJECT *dev, </span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_INFORMATION_CLASS infor_class,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>* buf,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG buf_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIRP irp;</span><br><span class="line">    KEVENT event;</span><br><span class="line">    IO_STATUS_BLOCK IoStatusBlock;</span><br><span class="line">    PIO_STACK_LOCATION ioStackLocation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为我们打算让这个请求同步完成，所以初始化一个事件</span></span><br><span class="line">    <span class="comment">// 用来等待请求完成。</span></span><br><span class="line">    <span class="built_in">KeInitializeEvent</span>(&amp;event, SynchronizationEvent, FALSE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 分配irp</span></span><br><span class="line">    irp = <span class="built_in">IoAllocateIrp</span>(dev-&gt;StackSize, FALSE);</span><br><span class="line">    <span class="keyword">if</span>(irp == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 填写irp的主体</span></span><br><span class="line">    irp-&gt;AssociatedIrp.SystemBuffer = buf;</span><br><span class="line">    irp-&gt;UserEvent = &amp;event;</span><br><span class="line">    irp-&gt;UserIosb = &amp;IoStatusBlock;</span><br><span class="line">    irp-&gt;Tail.Overlay.Thread = <span class="built_in">PsGetCurrentThread</span>();</span><br><span class="line">    irp-&gt;Tail.Overlay.OriginalFileObject = file;</span><br><span class="line">    irp-&gt;RequestorMode = KernelMode;</span><br><span class="line">    irp-&gt;Flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置irpsp</span></span><br><span class="line">    ioStackLocation = <span class="built_in">IoGetNextIrpStackLocation</span>(irp);</span><br><span class="line">    ioStackLocation-&gt;MajorFunction = IRP_MJ_QUERY_INFORMATION;</span><br><span class="line">    ioStackLocation-&gt;DeviceObject = dev;</span><br><span class="line">    ioStackLocation-&gt;FileObject = file;</span><br><span class="line">    ioStackLocation-&gt;Parameters.QueryFile.Length = buf_len;</span><br><span class="line">    ioStackLocation-&gt;Parameters.QueryFile.FileInformationClass = infor_class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置结束例程</span></span><br><span class="line">    <span class="built_in">IoSetCompletionRoutine</span>(irp, cfFileIrpComp, <span class="number">0</span>, TRUE, TRUE, TRUE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 发送请求并等待结束</span></span><br><span class="line">    (<span class="type">void</span>) <span class="built_in">IoCallDriver</span>(dev, irp);</span><br><span class="line">    <span class="built_in">KeWaitForSingleObject</span>(&amp;event, Executive, KernelMode, TRUE, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> IoStatusBlock.Status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">cfFileSetFileSize</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	DEVICE_OBJECT *dev,</span></span></span><br><span class="line"><span class="params"><span class="function">	FILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">	LARGE_INTEGER *file_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FILE_END_OF_FILE_INFORMATION end_of_file;</span><br><span class="line">	end_of_file.EndOfFile.QuadPart = file_size-&gt;QuadPart;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">cfFileSetInformation</span>(</span><br><span class="line">		dev,file,FileEndOfFileInformation,</span><br><span class="line">		<span class="literal">NULL</span>,(<span class="type">void</span> *)&amp;end_of_file,</span><br><span class="line">		<span class="built_in">sizeof</span>(FILE_END_OF_FILE_INFORMATION));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">cfFileGetStandInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	PDEVICE_OBJECT dev,</span></span></span><br><span class="line"><span class="params"><span class="function">	PFILE_OBJECT file,</span></span></span><br><span class="line"><span class="params"><span class="function">	PLARGE_INTEGER allocate_size,</span></span></span><br><span class="line"><span class="params"><span class="function">	PLARGE_INTEGER file_size,</span></span></span><br><span class="line"><span class="params"><span class="function">	BOOLEAN *dir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	PFILE_STANDARD_INFORMATION infor = <span class="literal">NULL</span>;</span><br><span class="line">	infor = (PFILE_STANDARD_INFORMATION)</span><br><span class="line">		<span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool,<span class="built_in">sizeof</span>(FILE_STANDARD_INFORMATION),CF_MEM_TAG);</span><br><span class="line">	<span class="keyword">if</span>(infor == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">	status = <span class="built_in">cfFileQueryInformation</span>(dev,file,</span><br><span class="line">		FileStandardInformation,(<span class="type">void</span> *)infor,</span><br><span class="line">		<span class="built_in">sizeof</span>(FILE_STANDARD_INFORMATION));</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">NT_SUCCESS</span>(status))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(allocate_size != <span class="literal">NULL</span>)</span><br><span class="line">			*allocate_size = infor-&gt;AllocationSize;</span><br><span class="line">		<span class="keyword">if</span>(file_size != <span class="literal">NULL</span>)</span><br><span class="line">			*file_size = infor-&gt;EndOfFile;</span><br><span class="line">		<span class="keyword">if</span>(dir != <span class="literal">NULL</span>)</span><br><span class="line">			*dir = infor-&gt;Directory;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">ExFreePool</span>(infor);</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS </span></span><br><span class="line"><span class="function"><span class="title">cfFileReadWrite</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">    DEVICE_OBJECT *dev, </span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">    LARGE_INTEGER *offset,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG *length,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span> *buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOLEAN read_write)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG i;</span><br><span class="line">    PIRP irp;</span><br><span class="line">    KEVENT event;</span><br><span class="line">    PIO_STACK_LOCATION ioStackLocation;</span><br><span class="line">	IO_STATUS_BLOCK IoStatusBlock = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">KeInitializeEvent</span>(&amp;event, SynchronizationEvent, FALSE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 分配irp.</span></span><br><span class="line">    irp = <span class="built_in">IoAllocateIrp</span>(dev-&gt;StackSize, FALSE);</span><br><span class="line">    <span class="keyword">if</span>(irp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 填写主体。</span></span><br><span class="line">    irp-&gt;AssociatedIrp.SystemBuffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">// 在paging io的情况下，似乎必须要使用MDL才能正常进行。不能使用UserBuffer.</span></span><br><span class="line">	<span class="comment">// 但是我并不肯定这一点。所以这里加一个断言。以便我可以跟踪错误。</span></span><br><span class="line">    irp-&gt;MdlAddress = <span class="literal">NULL</span>;</span><br><span class="line">    irp-&gt;UserBuffer = buffer;</span><br><span class="line">    irp-&gt;UserEvent = &amp;event;</span><br><span class="line">    irp-&gt;UserIosb = &amp;IoStatusBlock;</span><br><span class="line">    irp-&gt;Tail.Overlay.Thread = <span class="built_in">PsGetCurrentThread</span>();</span><br><span class="line">    irp-&gt;Tail.Overlay.OriginalFileObject = file;</span><br><span class="line">    irp-&gt;RequestorMode = KernelMode;</span><br><span class="line">	<span class="keyword">if</span>(read_write)</span><br><span class="line">		irp-&gt;Flags = IRP_DEFER_IO_COMPLETION|IRP_READ_OPERATION|IRP_NOCACHE;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		irp-&gt;Flags = IRP_DEFER_IO_COMPLETION|IRP_WRITE_OPERATION|IRP_NOCACHE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 填写irpsp</span></span><br><span class="line">    ioStackLocation = <span class="built_in">IoGetNextIrpStackLocation</span>(irp);</span><br><span class="line">	<span class="keyword">if</span>(read_write)</span><br><span class="line">		ioStackLocation-&gt;MajorFunction = IRP_MJ_READ;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ioStackLocation-&gt;MajorFunction = IRP_MJ_WRITE;</span><br><span class="line">    ioStackLocation-&gt;MinorFunction = IRP_MN_NORMAL;</span><br><span class="line">    ioStackLocation-&gt;DeviceObject = dev;</span><br><span class="line">    ioStackLocation-&gt;FileObject = file;</span><br><span class="line">	<span class="keyword">if</span>(read_write)</span><br><span class="line">	&#123;</span><br><span class="line">		ioStackLocation-&gt;Parameters.Read.ByteOffset = *offset;</span><br><span class="line">		ioStackLocation-&gt;Parameters.Read.Length = *length;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		ioStackLocation-&gt;Parameters.Write.ByteOffset = *offset;</span><br><span class="line">		ioStackLocation-&gt;Parameters.Write.Length = *length;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置完成</span></span><br><span class="line">    <span class="built_in">IoSetCompletionRoutine</span>(irp, cfFileIrpComp, <span class="number">0</span>, TRUE, TRUE, TRUE);</span><br><span class="line">    (<span class="type">void</span>) <span class="built_in">IoCallDriver</span>(dev, irp);</span><br><span class="line">    <span class="built_in">KeWaitForSingleObject</span>(&amp;event, Executive, KernelMode, TRUE, <span class="number">0</span>);</span><br><span class="line">	*length = IoStatusBlock.Information;</span><br><span class="line">    <span class="keyword">return</span> IoStatusBlock.Status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理缓冲</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfFileCacheClear</span><span class="params">(PFILE_OBJECT pFileObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   PFSRTL_COMMON_FCB_HEADER pFcb;</span><br><span class="line">   LARGE_INTEGER liInterval;</span><br><span class="line">   BOOLEAN bNeedReleaseResource = FALSE;</span><br><span class="line">   BOOLEAN bNeedReleasePagingIoResource = FALSE;</span><br><span class="line">   KIRQL irql;</span><br><span class="line"></span><br><span class="line">   pFcb = (PFSRTL_COMMON_FCB_HEADER)pFileObject-&gt;FsContext;</span><br><span class="line">   <span class="keyword">if</span>(pFcb == <span class="literal">NULL</span>)</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">   irql = <span class="built_in">KeGetCurrentIrql</span>();</span><br><span class="line">   <span class="keyword">if</span> (irql &gt;= DISPATCH_LEVEL)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   liInterval.QuadPart = <span class="number">-1</span> * (LONGLONG)<span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span> (TRUE)</span><br><span class="line">   &#123;</span><br><span class="line">       BOOLEAN bBreak = TRUE;</span><br><span class="line">       BOOLEAN bLockedResource = FALSE;</span><br><span class="line">       BOOLEAN bLockedPagingIoResource = FALSE;</span><br><span class="line">       bNeedReleaseResource = FALSE;</span><br><span class="line">       bNeedReleasePagingIoResource = FALSE;</span><br><span class="line"></span><br><span class="line">	   <span class="comment">// 到fcb中去拿锁。</span></span><br><span class="line">       <span class="keyword">if</span> (pFcb-&gt;PagingIoResource)</span><br><span class="line">           bLockedPagingIoResource = <span class="built_in">ExIsResourceAcquiredExclusiveLite</span>(pFcb-&gt;PagingIoResource);</span><br><span class="line"></span><br><span class="line">	   <span class="comment">// 总之一定要拿到这个锁。</span></span><br><span class="line">       <span class="keyword">if</span> (pFcb-&gt;Resource)</span><br><span class="line">       &#123;</span><br><span class="line">           bLockedResource = TRUE;</span><br><span class="line">           <span class="keyword">if</span> (<span class="built_in">ExIsResourceAcquiredExclusiveLite</span>(pFcb-&gt;Resource) == FALSE)</span><br><span class="line">           &#123;</span><br><span class="line">               bNeedReleaseResource = TRUE;</span><br><span class="line">               <span class="keyword">if</span> (bLockedPagingIoResource)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">ExAcquireResourceExclusiveLite</span>(pFcb-&gt;Resource, FALSE) == FALSE)</span><br><span class="line">                   &#123;</span><br><span class="line">                       bBreak = FALSE;</span><br><span class="line">                       bNeedReleaseResource = FALSE;</span><br><span class="line">                       bLockedResource = FALSE;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">                   <span class="built_in">ExAcquireResourceExclusiveLite</span>(pFcb-&gt;Resource, TRUE);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="keyword">if</span> (bLockedPagingIoResource == FALSE)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">if</span> (pFcb-&gt;PagingIoResource)</span><br><span class="line">           &#123;</span><br><span class="line">               bLockedPagingIoResource = TRUE;</span><br><span class="line">               bNeedReleasePagingIoResource = TRUE;</span><br><span class="line">               <span class="keyword">if</span> (bLockedResource)</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="built_in">ExAcquireResourceExclusiveLite</span>(pFcb-&gt;PagingIoResource, FALSE) == FALSE)</span><br><span class="line">                   &#123;</span><br><span class="line">                       bBreak = FALSE;</span><br><span class="line">                       bLockedPagingIoResource = FALSE;</span><br><span class="line">                       bNeedReleasePagingIoResource = FALSE;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="built_in">ExAcquireResourceExclusiveLite</span>(pFcb-&gt;PagingIoResource, TRUE);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (bBreak)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> (bNeedReleasePagingIoResource)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">ExReleaseResourceLite</span>(pFcb-&gt;PagingIoResource);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (bNeedReleaseResource)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">ExReleaseResourceLite</span>(pFcb-&gt;Resource);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (irql == PASSIVE_LEVEL)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="built_in">KeDelayExecutionThread</span>(KernelMode, FALSE, &amp;liInterval);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">       &#123;</span><br><span class="line">           KEVENT waitEvent;</span><br><span class="line">           <span class="built_in">KeInitializeEvent</span>(&amp;waitEvent, NotificationEvent, FALSE);</span><br><span class="line">           <span class="built_in">KeWaitForSingleObject</span>(&amp;waitEvent, Executive, KernelMode, FALSE, &amp;liInterval);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (pFileObject-&gt;SectionObjectPointer)</span><br><span class="line">   &#123;</span><br><span class="line">		IO_STATUS_BLOCK ioStatus;</span><br><span class="line">		<span class="built_in">CcFlushCache</span>(pFileObject-&gt;SectionObjectPointer, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;ioStatus);</span><br><span class="line">		<span class="keyword">if</span> (pFileObject-&gt;SectionObjectPointer-&gt;ImageSectionObject)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">MmFlushImageSection</span>(pFileObject-&gt;SectionObjectPointer,MmFlushForWrite); <span class="comment">// MmFlushForDelete</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">CcPurgeCacheSection</span>(pFileObject-&gt;SectionObjectPointer, <span class="literal">NULL</span>, <span class="number">0</span>, FALSE);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (bNeedReleasePagingIoResource)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">ExReleaseResourceLite</span>(pFcb-&gt;PagingIoResource);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (bNeedReleaseResource)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">ExReleaseResourceLite</span>(pFcb-&gt;Resource);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="cf-list-c"><a href="#cf-list-c" class="headerlink" title="cf_list.c"></a>cf_list.c</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_list.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-1-29</span></span><br><span class="line"><span class="comment">/// @brief      实现一个链表，保存所有正在加密打开着的文件。</span></span><br><span class="line"><span class="comment">///                请注意只支持WindowsXP下的FastFat文件系统。</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 免责声明</span></span><br><span class="line"><span class="comment">/// 本代码为示例代码。未经详尽测试，不保证可靠性。作者对</span></span><br><span class="line"><span class="comment">/// 任何人使用此代码导致的直接和间接损失不负责任。</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是楚狂人与wowocock为《寒江独</span></span><br><span class="line"><span class="comment">/// 钓——Windows内核编程与信息安全》所编写的文件透明加密</span></span><br><span class="line"><span class="comment">/// 示例。本工程仅仅支持WindowsXP下，FastFat文件系统下记事</span></span><br><span class="line"><span class="comment">/// 本的加密。未测试与杀毒软件或者其他文件过滤驱动并存的</span></span><br><span class="line"><span class="comment">/// 情况。本代码全部权利为作者保留，仅供读者学习和阅读使</span></span><br><span class="line"><span class="comment">/// 用。未经两位作者书面授权，不得直接复制、或者基于此代</span></span><br><span class="line"><span class="comment">/// 码进行修改、利用此代码提供的全部或者部分技术用于商业</span></span><br><span class="line"><span class="comment">/// 的软件开发、或者其他的获利行为。如有违反，作者保留起</span></span><br><span class="line"><span class="comment">/// 诉和获取赔偿之权力。阅读此代码，则自动视为接受以上授</span></span><br><span class="line"><span class="comment">/// 权协议。如不接受此协议者，请不要阅读此代码。</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_file_irp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/fat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/nodetype.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/fatstruc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CF_MEM_TAG <span class="string">&#x27;cfls&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CF_FILE_HEADER_SIZE (1024*4)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    LIST_ENTRY list_entry;</span><br><span class="line">    FCB *fcb;</span><br><span class="line">&#125; CF_NODE,*PCF_NODE;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> LIST_ENTRY s_cf_list;</span><br><span class="line"><span class="type">static</span> KSPIN_LOCK s_cf_list_lock;</span><br><span class="line"><span class="type">static</span> KIRQL s_cf_list_lock_irql;</span><br><span class="line"><span class="type">static</span> BOOLEAN s_cf_list_inited = FALSE;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfListInited</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s_cf_list_inited;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfListLock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(s_cf_list_inited);</span><br><span class="line">    <span class="built_in">KeAcquireSpinLock</span>(&amp;s_cf_list_lock,&amp;s_cf_list_lock_irql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfListUnlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(s_cf_list_inited);</span><br><span class="line">    <span class="built_in">KeReleaseSpinLock</span>(&amp;s_cf_list_lock,s_cf_list_lock_irql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfListInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">InitializeListHead</span>(&amp;s_cf_list);</span><br><span class="line">    <span class="built_in">KeInitializeSpinLock</span>(&amp;s_cf_list_lock);</span><br><span class="line">    s_cf_list_inited = TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 任意给定一个文件，判断是否在加密链表中。这个函数没加锁。</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfIsFileCrypting</span><span class="params">(PFILE_OBJECT file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PLIST_ENTRY p;</span><br><span class="line">    PCF_NODE node;</span><br><span class="line">   <span class="keyword">for</span>(p = s_cf_list.Flink; p != &amp;s_cf_list; p = p-&gt;Flink)</span><br><span class="line">    &#123;</span><br><span class="line">	    node = (PCF_NODE)p;</span><br><span class="line">        <span class="keyword">if</span>(node-&gt;fcb == file-&gt;FsContext)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//KdPrint((&quot;cfIsFileCrypting: file %wZ is crypting. fcb = %x \r\n&quot;,&amp;file-&gt;FileName,file-&gt;FsContext));</span></span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 追加一个正在使用的机密文件。这个函数有加锁来保证只插入一</span></span><br><span class="line"><span class="comment">// 个，不会重复插入。</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfFileCryptAppendLk</span><span class="params">(PFILE_OBJECT file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先分配空间</span></span><br><span class="line">    PCF_NODE node = (PCF_NODE)</span><br><span class="line">        <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool,<span class="built_in">sizeof</span>(CF_NODE),CF_MEM_TAG);</span><br><span class="line">    node-&gt;fcb = (PFCB)file-&gt;FsContext;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cfFileCacheClear</span>(file);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加锁并查找，如果已经有了，这是一个致命的错误。直接报错即可。</span></span><br><span class="line">    <span class="built_in">cfListLock</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">cfIsFileCrypting</span>(file))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(node-&gt;fcb-&gt;UncleanCount &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 要成功的加入，必须要符合一个条件。就是FCB-&gt;UncleanCount &lt;= 1.</span></span><br><span class="line">        <span class="comment">// 这样的话说明没有其他程序打开着这个文件。否则的话可能是一个普</span></span><br><span class="line">        <span class="comment">// 通进程打开着它。此时不能加密。返回拒绝打开。</span></span><br><span class="line">        <span class="built_in">cfListUnlock</span>();</span><br><span class="line">        <span class="comment">// 释放掉。</span></span><br><span class="line">        <span class="built_in">ExFreePool</span>(node);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 否则的话，在这里插入到链表里。</span></span><br><span class="line">    <span class="built_in">InsertHeadList</span>(&amp;s_cf_list, (PLIST_ENTRY)node);</span><br><span class="line">    <span class="built_in">cfListUnlock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//cfFileCacheClear(file);</span></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当有文件被clean up的时候调用此函数。如果检查发现</span></span><br><span class="line"><span class="comment">// FileObject-&gt;FsContext在列表中</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfCryptFileCleanupComplete</span><span class="params">(PFILE_OBJECT file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PLIST_ENTRY p;</span><br><span class="line">    PCF_NODE node;</span><br><span class="line">    FCB *fcb = (FCB *)file-&gt;FsContext;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">KdPrint</span>((<span class="string">&quot;cfCryptFileCleanupComplete: file name = %wZ, fcb-&gt;UncleanCount = %d\r\n&quot;</span>,</span><br><span class="line">        &amp;file-&gt;FileName,fcb-&gt;UncleanCount));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必须首先清文件缓冲。然后再从链表中移除。否则的话，清缓</span></span><br><span class="line">    <span class="comment">// 冲时的写操作就不会加密了。</span></span><br><span class="line">    <span class="keyword">if</span>(fcb-&gt;UncleanCount &lt;= <span class="number">1</span> || (fcb-&gt;FcbState &amp; FCB_STATE_DELETE_ON_CLOSE) )</span><br><span class="line">        <span class="built_in">cfFileCacheClear</span>(file);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cfListLock</span>();</span><br><span class="line">   <span class="keyword">for</span>(p = s_cf_list.Flink; p != &amp;s_cf_list; p = p-&gt;Flink)</span><br><span class="line">   &#123;</span><br><span class="line">	    node = (PCF_NODE)p;</span><br><span class="line">        <span class="keyword">if</span>(node-&gt;fcb == file-&gt;FsContext &amp;&amp; </span><br><span class="line">            (node-&gt;fcb-&gt;UncleanCount == <span class="number">0</span> ||</span><br><span class="line">            (fcb-&gt;FcbState &amp; FCB_STATE_DELETE_ON_CLOSE)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 从链表中移除。</span></span><br><span class="line">            <span class="built_in">RemoveEntryList</span>((PLIST_ENTRY)node);</span><br><span class="line">            <span class="built_in">cfListUnlock</span>();</span><br><span class="line">            <span class="comment">//  释放内存。</span></span><br><span class="line">            <span class="built_in">ExFreePool</span>(node);</span><br><span class="line">            <span class="keyword">return</span> TRUE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="built_in">cfListUnlock</span>();</span><br><span class="line">   <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="cf-modify-irp-c"><a href="#cf-modify-irp-c" class="headerlink" title="cf_modify_irp.c"></a>cf_modify_irp.c</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_modify_irp.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu wowocock</span></span><br><span class="line"><span class="comment">/// @date       2009-2-1</span></span><br><span class="line"><span class="comment">/// @brief      实现对irp请求和结果的修改 </span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 免责声明</span></span><br><span class="line"><span class="comment">/// 本代码为示例代码。未经详尽测试，不保证可靠性。作者对</span></span><br><span class="line"><span class="comment">/// 任何人使用此代码导致的直接和间接损失不负责任。</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是楚狂人与wowocock为《寒江独</span></span><br><span class="line"><span class="comment">/// 钓——Windows内核编程与信息安全》所编写的文件透明加密</span></span><br><span class="line"><span class="comment">/// 示例。本工程仅仅支持WindowsXP下，FastFat文件系统下记事</span></span><br><span class="line"><span class="comment">/// 本的加密。未测试与杀毒软件或者其他文件过滤驱动并存的</span></span><br><span class="line"><span class="comment">/// 情况。本代码全部权利为作者保留，仅供读者学习和阅读使</span></span><br><span class="line"><span class="comment">/// 用。未经两位作者书面授权，不得直接复制、或者基于此代</span></span><br><span class="line"><span class="comment">/// 码进行修改、利用此代码提供的全部或者部分技术用于商业</span></span><br><span class="line"><span class="comment">/// 的软件开发、或者其他的获利行为。如有违反，作者保留起</span></span><br><span class="line"><span class="comment">/// 诉和获取赔偿之权力。阅读此代码，则自动视为接受以上授</span></span><br><span class="line"><span class="comment">/// 权协议。如不接受此协议者，请不要阅读此代码。</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_file_irp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_list.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/fat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/nodetype.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/fatstruc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CF_FILE_HEADER_SIZE (1024*4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CF_MEM_TAG <span class="string">&#x27;cfmi&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对这些set information给予修改，使之隐去前面的4k文件头。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpSetInforPre</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PIRP irp,</span></span></span><br><span class="line"><span class="params"><span class="function">    PIO_STACK_LOCATION irpsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PUCHAR buffer = irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">    NTSTATUS status;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ASSERT</span>(irpsp-&gt;MajorFunction == IRP_MJ_SET_INFORMATION);</span><br><span class="line">    <span class="keyword">switch</span>(irpsp-&gt;Parameters.SetFile.FileInformationClass)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> FileAllocationInformation:</span><br><span class="line">        &#123;</span><br><span class="line">		    PFILE_ALLOCATION_INFORMATION alloc_infor = </span><br><span class="line">                (PFILE_ALLOCATION_INFORMATION)buffer;</span><br><span class="line">		    alloc_infor-&gt;AllocationSize.QuadPart += CF_FILE_HEADER_SIZE;        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> FileEndOfFileInformation:</span><br><span class="line">        &#123;</span><br><span class="line">		    PFILE_END_OF_FILE_INFORMATION end_infor = </span><br><span class="line">                (PFILE_END_OF_FILE_INFORMATION)buffer;</span><br><span class="line">		    end_infor-&gt;EndOfFile.QuadPart += CF_FILE_HEADER_SIZE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> FileValidDataLengthInformation:</span><br><span class="line">        &#123;</span><br><span class="line">		    PFILE_VALID_DATA_LENGTH_INFORMATION valid_length = </span><br><span class="line">                (PFILE_VALID_DATA_LENGTH_INFORMATION)buffer;</span><br><span class="line">		    valid_length-&gt;ValidDataLength.QuadPart += CF_FILE_HEADER_SIZE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="keyword">case</span> FilePositionInformation:</span><br><span class="line">		&#123;</span><br><span class="line">			PFILE_POSITION_INFORMATION position_infor = </span><br><span class="line">				(PFILE_POSITION_INFORMATION)buffer;</span><br><span class="line">			position_infor-&gt;CurrentByteOffset.QuadPart += CF_FILE_HEADER_SIZE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">case</span> FileStandardInformation:</span><br><span class="line">		((PFILE_STANDARD_INFORMATION)buffer)-&gt;EndOfFile.QuadPart += CF_FILE_HEADER_SIZE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FileAllInformation:</span><br><span class="line">		((PFILE_ALL_INFORMATION)buffer)-&gt;PositionInformation.CurrentByteOffset.QuadPart += CF_FILE_HEADER_SIZE;</span><br><span class="line">		((PFILE_ALL_INFORMATION)buffer)-&gt;StandardInformation.EndOfFile.QuadPart += CF_FILE_HEADER_SIZE;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpQueryInforPost</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PUCHAR buffer = irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">    <span class="built_in">ASSERT</span>(irpsp-&gt;MajorFunction == IRP_MJ_QUERY_INFORMATION);</span><br><span class="line">    <span class="keyword">switch</span>(irpsp-&gt;Parameters.QueryFile.FileInformationClass)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> FileAllInformation:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 注意FileAllInformation，是由以下结构组成。即使长度不够，</span></span><br><span class="line">            <span class="comment">// 依然可以返回前面的字节。</span></span><br><span class="line">            <span class="comment">//typedef struct _FILE_ALL_INFORMATION &#123;</span></span><br><span class="line">            <span class="comment">//    FILE_BASIC_INFORMATION BasicInformation;</span></span><br><span class="line">            <span class="comment">//    FILE_STANDARD_INFORMATION StandardInformation;</span></span><br><span class="line">            <span class="comment">//    FILE_INTERNAL_INFORMATION InternalInformation;</span></span><br><span class="line">            <span class="comment">//    FILE_EA_INFORMATION EaInformation;</span></span><br><span class="line">            <span class="comment">//    FILE_ACCESS_INFORMATION AccessInformation;</span></span><br><span class="line">            <span class="comment">//    FILE_POSITION_INFORMATION PositionInformation;</span></span><br><span class="line">            <span class="comment">//    FILE_MODE_INFORMATION ModeInformation;</span></span><br><span class="line">            <span class="comment">//    FILE_ALIGNMENT_INFORMATION AlignmentInformation;</span></span><br><span class="line">            <span class="comment">//    FILE_NAME_INFORMATION NameInformation;</span></span><br><span class="line">            <span class="comment">//&#125; FILE_ALL_INFORMATION, *PFILE_ALL_INFORMATION;</span></span><br><span class="line">            <span class="comment">// 我们需要注意的是返回的字节里是否包含了StandardInformation</span></span><br><span class="line">            <span class="comment">// 这个可能影响文件的大小的信息。</span></span><br><span class="line">            PFILE_ALL_INFORMATION all_infor = (PFILE_ALL_INFORMATION)buffer;</span><br><span class="line">            <span class="keyword">if</span>(irp-&gt;IoStatus.Information &gt;= </span><br><span class="line">                <span class="built_in">sizeof</span>(FILE_BASIC_INFORMATION) + </span><br><span class="line">                <span class="built_in">sizeof</span>(FILE_STANDARD_INFORMATION))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">ASSERT</span>(all_infor-&gt;StandardInformation.EndOfFile.QuadPart &gt;= CF_FILE_HEADER_SIZE);</span><br><span class="line">				all_infor-&gt;StandardInformation.EndOfFile.QuadPart -= CF_FILE_HEADER_SIZE;</span><br><span class="line">                all_infor-&gt;StandardInformation.AllocationSize.QuadPart -= CF_FILE_HEADER_SIZE;</span><br><span class="line">                <span class="keyword">if</span>(irp-&gt;IoStatus.Information &gt;= </span><br><span class="line">                    <span class="built_in">sizeof</span>(FILE_BASIC_INFORMATION) + </span><br><span class="line">                    <span class="built_in">sizeof</span>(FILE_STANDARD_INFORMATION) +</span><br><span class="line">                    <span class="built_in">sizeof</span>(FILE_INTERNAL_INFORMATION) +</span><br><span class="line">                    <span class="built_in">sizeof</span>(FILE_EA_INFORMATION) +</span><br><span class="line">                    <span class="built_in">sizeof</span>(FILE_ACCESS_INFORMATION) +</span><br><span class="line">                    <span class="built_in">sizeof</span>(FILE_POSITION_INFORMATION))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(all_infor-&gt;PositionInformation.CurrentByteOffset.QuadPart &gt;= CF_FILE_HEADER_SIZE)</span><br><span class="line">                        all_infor-&gt;PositionInformation.CurrentByteOffset.QuadPart -= CF_FILE_HEADER_SIZE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> FileAllocationInformation:</span><br><span class="line">        &#123;</span><br><span class="line">		    PFILE_ALLOCATION_INFORMATION alloc_infor = </span><br><span class="line">                (PFILE_ALLOCATION_INFORMATION)buffer;</span><br><span class="line">            <span class="built_in">ASSERT</span>(alloc_infor-&gt;AllocationSize.QuadPart &gt;= CF_FILE_HEADER_SIZE);</span><br><span class="line">		    alloc_infor-&gt;AllocationSize.QuadPart -= CF_FILE_HEADER_SIZE;        </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> FileValidDataLengthInformation:</span><br><span class="line">        &#123;</span><br><span class="line">		    PFILE_VALID_DATA_LENGTH_INFORMATION valid_length = </span><br><span class="line">                (PFILE_VALID_DATA_LENGTH_INFORMATION)buffer;</span><br><span class="line">            <span class="built_in">ASSERT</span>(valid_length-&gt;ValidDataLength.QuadPart &gt;= CF_FILE_HEADER_SIZE);</span><br><span class="line">		    valid_length-&gt;ValidDataLength.QuadPart -= CF_FILE_HEADER_SIZE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> FileStandardInformation:</span><br><span class="line">        &#123;</span><br><span class="line">            PFILE_STANDARD_INFORMATION stand_infor = (PFILE_STANDARD_INFORMATION)buffer;</span><br><span class="line">            <span class="built_in">ASSERT</span>(stand_infor-&gt;AllocationSize.QuadPart &gt;= CF_FILE_HEADER_SIZE);</span><br><span class="line">            stand_infor-&gt;AllocationSize.QuadPart -= CF_FILE_HEADER_SIZE;            </span><br><span class="line">            stand_infor-&gt;EndOfFile.QuadPart -= CF_FILE_HEADER_SIZE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> FileEndOfFileInformation:</span><br><span class="line">        &#123;</span><br><span class="line">		    PFILE_END_OF_FILE_INFORMATION end_infor = </span><br><span class="line">                (PFILE_END_OF_FILE_INFORMATION)buffer;</span><br><span class="line">            <span class="built_in">ASSERT</span>(end_infor-&gt;EndOfFile.QuadPart &gt;= CF_FILE_HEADER_SIZE);</span><br><span class="line">		    end_infor-&gt;EndOfFile.QuadPart -= CF_FILE_HEADER_SIZE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="keyword">case</span> FilePositionInformation:</span><br><span class="line">		&#123;</span><br><span class="line">			PFILE_POSITION_INFORMATION PositionInformation =</span><br><span class="line">				(PFILE_POSITION_INFORMATION)buffer; </span><br><span class="line">            <span class="keyword">if</span>(PositionInformation-&gt;CurrentByteOffset.QuadPart &gt; CF_FILE_HEADER_SIZE)</span><br><span class="line">			    PositionInformation-&gt;CurrentByteOffset.QuadPart -= CF_FILE_HEADER_SIZE;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读请求。将偏移量前移。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpReadPre</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PLARGE_INTEGER offset;</span><br><span class="line">    PFCB fcb = (PFCB)irpsp-&gt;FileObject-&gt;FsContext;</span><br><span class="line">	offset = &amp;irpsp-&gt;Parameters.Read.ByteOffset;</span><br><span class="line">    <span class="keyword">if</span>(offset-&gt;LowPart ==  FILE_USE_FILE_POINTER_POSITION &amp;&amp;  offset-&gt;HighPart == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">// 记事本不会出现这样的情况。</span></span><br><span class="line">        <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 偏移必须修改为增加4k。</span></span><br><span class="line">    offset-&gt;QuadPart += CF_FILE_HEADER_SIZE;</span><br><span class="line">    <span class="built_in">KdPrint</span>((<span class="string">&quot;cfIrpReadPre: offset = %8x\r\n&quot;</span>,</span><br><span class="line">        offset-&gt;LowPart));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读请求结束，需要解密。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpReadPost</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 得到缓冲区，然后解密之。解密很简单，就是xor 0x77.</span></span><br><span class="line">    PUCHAR buffer;</span><br><span class="line">    ULONG i,length = irp-&gt;IoStatus.Information;</span><br><span class="line">    <span class="built_in">ASSERT</span>(irp-&gt;MdlAddress != <span class="literal">NULL</span> || irp-&gt;UserBuffer != <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span>(irp-&gt;MdlAddress != <span class="literal">NULL</span>)</span><br><span class="line">		buffer = <span class="built_in">MmGetSystemAddressForMdlSafe</span>(irp-&gt;MdlAddress,NormalPagePriority);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		buffer = irp-&gt;UserBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解密也很简单，xor 0x77</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;length;++i)</span><br><span class="line">        buffer[i] ^= <span class="number">0X77</span>;</span><br><span class="line">    <span class="comment">// 打印解密之后的内容</span></span><br><span class="line">    <span class="built_in">KdPrint</span>((<span class="string">&quot;cfIrpReadPost: flags = %x length = %x content = %c%c%c%c%c\r\n&quot;</span>,</span><br><span class="line">        irp-&gt;Flags,length,buffer[<span class="number">0</span>],buffer[<span class="number">1</span>],buffer[<span class="number">2</span>],buffer[<span class="number">3</span>],buffer[<span class="number">4</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分配一个MDL，带有一个长度为length的缓冲区。</span></span><br><span class="line"><span class="function">PMDL <span class="title">cfMdlMemoryAlloc</span><span class="params">(ULONG length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">void</span> *buf = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool,length,CF_MEM_TAG);</span><br><span class="line">    PMDL mdl;</span><br><span class="line">    <span class="keyword">if</span>(buf == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    mdl = <span class="built_in">IoAllocateMdl</span>(buf,length,FALSE,FALSE,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(mdl == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ExFreePool</span>(buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">MmBuildMdlForNonPagedPool</span>(mdl);</span><br><span class="line">    mdl-&gt;Next = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> mdl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放掉带有MDL的缓冲区。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfMdlMemoryFree</span><span class="params">(PMDL mdl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">void</span> *buffer = <span class="built_in">MmGetSystemAddressForMdlSafe</span>(mdl,NormalPagePriority);</span><br><span class="line">    <span class="built_in">IoFreeMdl</span>(mdl);</span><br><span class="line">    <span class="built_in">ExFreePool</span>(buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写请求上下文。因为写请求必须恢复原来的irp-&gt;MdlAddress</span></span><br><span class="line"><span class="comment">// 或者irp-&gt;UserBuffer，所以才需要记录上下文。</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">CF_WRITE_CONTEXT_</span>&#123;</span><br><span class="line">    PMDL mdl_address;</span><br><span class="line">    PVOID user_buffer;</span><br><span class="line">&#125; CF_WRITE_CONTEXT,*PCF_WRITE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写请求需要重新分配缓冲区，而且有可能失败。如果失败</span></span><br><span class="line"><span class="comment">// 了就直接报错了。所以要有一个返回。TRUE表示成功，可</span></span><br><span class="line"><span class="comment">// 以继续GO_ON。FALSE表示失败了，错误已经填好，直接</span></span><br><span class="line"><span class="comment">// 完成即可</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfIrpWritePre</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp, PVOID *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PLARGE_INTEGER offset;</span><br><span class="line">    ULONG i,length = irpsp-&gt;Parameters.Write.Length;</span><br><span class="line">    PUCHAR buffer,new_buffer;</span><br><span class="line">    PMDL new_mdl = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先准备一个上下文</span></span><br><span class="line">    PCF_WRITE_CONTEXT my_context = (PCF_WRITE_CONTEXT)</span><br><span class="line">        <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool,<span class="built_in">sizeof</span>(CF_WRITE_CONTEXT),CF_MEM_TAG);</span><br><span class="line">    <span class="keyword">if</span>(my_context == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        irp-&gt;IoStatus.Status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 在这里得到缓冲进行加密。要注意的是写请求的缓冲区</span></span><br><span class="line">    <span class="comment">// 是不可以直接改写的。必须重新分配。</span></span><br><span class="line">    <span class="built_in">ASSERT</span>(irp-&gt;MdlAddress != <span class="literal">NULL</span> || irp-&gt;UserBuffer != <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span>(irp-&gt;MdlAddress != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">		buffer = <span class="built_in">MmGetSystemAddressForMdlSafe</span>(irp-&gt;MdlAddress,NormalPagePriority);</span><br><span class="line">        new_mdl = <span class="built_in">cfMdlMemoryAlloc</span>(length);</span><br><span class="line">        <span class="keyword">if</span>(new_mdl == <span class="literal">NULL</span>)</span><br><span class="line">            new_buffer = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            new_buffer = <span class="built_in">MmGetSystemAddressForMdlSafe</span>(new_mdl,NormalPagePriority);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">		buffer = irp-&gt;UserBuffer;</span><br><span class="line">        new_buffer = <span class="built_in">ExAllocatePoolWithTag</span>(NonPagedPool,length,CF_MEM_TAG);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果缓冲区分配失败了，直接退出即可。</span></span><br><span class="line">    <span class="keyword">if</span>(new_buffer == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        irp-&gt;IoStatus.Status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">ExFreePool</span>(my_context);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">RtlCopyMemory</span>(new_buffer,buffer,length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 到了这里一定成功，可以设置上下文了。</span></span><br><span class="line">    my_context-&gt;mdl_address = irp-&gt;MdlAddress;</span><br><span class="line">    my_context-&gt;user_buffer = irp-&gt;UserBuffer;</span><br><span class="line">    *context = (<span class="type">void</span> *)my_context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给irp指定行的mdl，到完成之后再恢复回来。</span></span><br><span class="line">    <span class="keyword">if</span>(new_mdl == <span class="literal">NULL</span>)</span><br><span class="line">        irp-&gt;UserBuffer = new_buffer;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        irp-&gt;MdlAddress = new_mdl;</span><br><span class="line"></span><br><span class="line">	offset = &amp;irpsp-&gt;Parameters.Write.ByteOffset;</span><br><span class="line">    <span class="built_in">KdPrint</span>((<span class="string">&quot;cfIrpWritePre: fileobj = %x flags = %x offset = %8x length = %x content = %c%c%c%c%c\r\n&quot;</span>,</span><br><span class="line">        irpsp-&gt;FileObject,irp-&gt;Flags,offset-&gt;LowPart,length,buffer[<span class="number">0</span>],buffer[<span class="number">1</span>],buffer[<span class="number">2</span>],buffer[<span class="number">3</span>],buffer[<span class="number">4</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加密也很简单，xor 0x77</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;length;++i)</span><br><span class="line">        new_buffer[i] ^= <span class="number">0x77</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(offset-&gt;LowPart ==  FILE_USE_FILE_POINTER_POSITION &amp;&amp;  offset-&gt;HighPart == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">// 记事本不会出现这样的情况。</span></span><br><span class="line">        <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 偏移必须修改为增加4KB。</span></span><br><span class="line">    offset-&gt;QuadPart += CF_FILE_HEADER_SIZE;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请注意无论结果如何，都必须进入WritePost.否则会出现无法恢复</span></span><br><span class="line"><span class="comment">// Write的内容，释放已分配的空间的情况。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpWritePost</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp,<span class="type">void</span> *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PCF_WRITE_CONTEXT my_context = (PCF_WRITE_CONTEXT) context;</span><br><span class="line">    <span class="comment">// 到了这里，可以恢复irp的内容了。</span></span><br><span class="line">    <span class="keyword">if</span>(irp-&gt;MdlAddress != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">cfMdlMemoryFree</span>(irp-&gt;MdlAddress);</span><br><span class="line">    <span class="keyword">if</span>(irp-&gt;UserBuffer != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">ExFreePool</span>(irp-&gt;UserBuffer);</span><br><span class="line">    irp-&gt;MdlAddress = my_context-&gt;mdl_address;</span><br><span class="line">    irp-&gt;UserBuffer = my_context-&gt;user_buffer;</span><br><span class="line">    <span class="built_in">ExFreePool</span>(my_context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="cf-proc-c"><a href="#cf-proc-c" class="headerlink" title="cf_proc.c"></a>cf_proc.c</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_proc.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-1-30</span></span><br><span class="line"><span class="comment">/// @brief      获得当前进程的名字。 </span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 免责声明</span></span><br><span class="line"><span class="comment">/// 本代码为示例代码。未经详尽测试，不保证可靠性。作者对</span></span><br><span class="line"><span class="comment">/// 任何人使用此代码导致的直接和间接损失不负责任。</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是楚狂人与wowocock为《寒江独</span></span><br><span class="line"><span class="comment">/// 钓——Windows内核编程与信息安全》所编写的文件透明加密</span></span><br><span class="line"><span class="comment">/// 示例。本工程仅仅支持WindowsXP下，FastFat文件系统下记事</span></span><br><span class="line"><span class="comment">/// 本的加密。未测试与杀毒软件或者其他文件过滤驱动并存的</span></span><br><span class="line"><span class="comment">/// 情况。本代码全部权利为作者保留，仅供读者学习和阅读使</span></span><br><span class="line"><span class="comment">/// 用。未经两位作者书面授权，不得直接复制、或者基于此代</span></span><br><span class="line"><span class="comment">/// 码进行修改、利用此代码提供的全部或者部分技术用于商业</span></span><br><span class="line"><span class="comment">/// 的软件开发、或者其他的获利行为。如有违反，作者保留起</span></span><br><span class="line"><span class="comment">/// 诉和获取赔偿之权力。阅读此代码，则自动视为接受以上授</span></span><br><span class="line"><span class="comment">/// 权协议。如不接受此协议者，请不要阅读此代码。</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个函数必须在DriverEntry中调用，否则cfCurProcName将不起作用。</span></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span> s_cf_proc_name_offset = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfCurProcNameInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG i;</span><br><span class="line">	PEPROCESS  curproc;</span><br><span class="line">	curproc = <span class="built_in">PsGetCurrentProcess</span>();</span><br><span class="line">	<span class="comment">// 搜索EPROCESS结构，在其中找到字符串</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">3</span>*<span class="number">4</span>*<span class="number">1024</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="built_in">strncmp</span>(<span class="string">&quot;System&quot;</span>,(PCHAR)curproc+i,<span class="built_in">strlen</span>(<span class="string">&quot;System&quot;</span>))) </span><br><span class="line">		&#123;</span><br><span class="line">			s_cf_proc_name_offset = i;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下函数可以获得进程名。返回获得的长度。</span></span><br><span class="line"><span class="function">ULONG <span class="title">cfCurProcName</span><span class="params">(PUNICODE_STRING name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PEPROCESS  curproc;</span><br><span class="line">	ULONG	i,need_len;</span><br><span class="line">    ANSI_STRING ansi_name;</span><br><span class="line">	<span class="keyword">if</span>(s_cf_proc_name_offset == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得当前进程PEB,然后移动一个偏移得到进程名所在位置。</span></span><br><span class="line">	curproc = <span class="built_in">PsGetCurrentProcess</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个名字是ansi字符串，现在转化为unicode字符串。</span></span><br><span class="line">    <span class="built_in">RtlInitAnsiString</span>(&amp;ansi_name,((PCHAR)curproc + s_cf_proc_name_offset));</span><br><span class="line">    need_len = <span class="built_in">RtlAnsiStringToUnicodeSize</span>(&amp;ansi_name);</span><br><span class="line">    <span class="keyword">if</span>(need_len &gt; name-&gt;MaximumLength)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">RtlAnsiStringToUnicodeSize</span>(&amp;ansi_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">RtlAnsiStringToUnicodeString</span>(name,&amp;ansi_name,FALSE);</span><br><span class="line">	<span class="keyword">return</span> need_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断当前进程是不是notepad.exe</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfIsCurProcSec</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WCHAR name_buf[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    UNICODE_STRING proc_name = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    UNICODE_STRING note_pad = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ULONG length;</span><br><span class="line">    <span class="built_in">RtlInitEmptyUnicodeString</span>(&amp;proc_name,name_buf,<span class="number">32</span>*<span class="built_in">sizeof</span>(WCHAR));</span><br><span class="line">    length = <span class="built_in">cfCurProcName</span>(&amp;proc_name);</span><br><span class="line">    <span class="built_in">RtlInitUnicodeString</span>(&amp;note_pad,<span class="string">L&quot;notepad.exe&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">RtlCompareUnicodeString</span>(&amp;note_pad,&amp;proc_name,TRUE) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> TRUE;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="cf-sfilter-c"><a href="#cf-sfilter-c" class="headerlink" title="cf_sfilter.c"></a>cf_sfilter.c</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_sfilter.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-1-29</span></span><br><span class="line"><span class="comment">/// @brief      实现sfilter的回调函数。 </span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 免责声明</span></span><br><span class="line"><span class="comment">/// 本代码为示例代码。未经详尽测试，不保证可靠性。作者对</span></span><br><span class="line"><span class="comment">/// 任何人使用此代码导致的直接和间接损失不负责任。</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是楚狂人与wowocock为《寒江独</span></span><br><span class="line"><span class="comment">/// 钓——Windows内核编程与信息安全》所编写的文件透明加密</span></span><br><span class="line"><span class="comment">/// 示例。本工程仅仅支持WindowsXP下，FastFat文件系统下记事</span></span><br><span class="line"><span class="comment">/// 本的加密。未测试与杀毒软件或者其他文件过滤驱动并存的</span></span><br><span class="line"><span class="comment">/// 情况。本代码全部权利为作者保留，仅供读者学习和阅读使</span></span><br><span class="line"><span class="comment">/// 用。未经两位作者书面授权，不得直接复制、或者基于此代</span></span><br><span class="line"><span class="comment">/// 码进行修改、利用此代码提供的全部或者部分技术用于商业</span></span><br><span class="line"><span class="comment">/// 的软件开发、或者其他的获利行为。如有违反，作者保留起</span></span><br><span class="line"><span class="comment">/// 诉和获取赔偿之权力。阅读此代码，则自动视为接受以上授</span></span><br><span class="line"><span class="comment">/// 权协议。如不接受此协议者，请不要阅读此代码。</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;..\inc\sfilter\sfilter.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_proc.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_list.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_modify_irp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cf_create.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/fat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/nodetype.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fat_headers/fatstruc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CF_FILE_HEADER_SIZE (1024*4)</span></span><br><span class="line"></span><br><span class="line"><span class="function">SF_RET <span class="title">OnSfilterIrpPre</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT dev,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT next_dev,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PVOID extension,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PIRP irp,</span></span></span><br><span class="line"><span class="params"><span class="function">		OUT NTSTATUS *status,</span></span></span><br><span class="line"><span class="params"><span class="function">		PVOID *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获得当前调用栈</span></span><br><span class="line">		PIO_STACK_LOCATION irpsp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(irp);</span><br><span class="line">    PFILE_OBJECT file = irpsp-&gt;FileObject;</span><br><span class="line">    <span class="comment">// 看当前进程是否是加密进程</span></span><br><span class="line">    BOOLEAN proc_sec = <span class="built_in">cfIsCurProcSec</span>();</span><br><span class="line">    BOOLEAN file_sec;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 我仅仅过滤文件请求。 FileObject不存在的情况一律passthru.</span></span><br><span class="line">	<span class="keyword">if</span>(file == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 首要决定哪些请求是我们必须过滤的。多余的提前passthru掉。</span></span><br><span class="line">	<span class="keyword">if</span>( irpsp-&gt;MajorFunction != IRP_MJ_CREATE &amp;&amp;</span><br><span class="line">		irpsp-&gt;MajorFunction != IRP_MJ_CLOSE &amp;&amp;</span><br><span class="line">		irpsp-&gt;MajorFunction != IRP_MJ_READ &amp;&amp;</span><br><span class="line">		irpsp-&gt;MajorFunction != IRP_MJ_WRITE &amp;&amp;</span><br><span class="line">		irpsp-&gt;MajorFunction != IRP_MJ_CLOSE  &amp;&amp;</span><br><span class="line">		irpsp-&gt;MajorFunction != IRP_MJ_CLEANUP &amp;&amp;</span><br><span class="line">		irpsp-&gt;MajorFunction != IRP_MJ_SET_INFORMATION &amp;&amp;</span><br><span class="line">		irpsp-&gt;MajorFunction != IRP_MJ_DIRECTORY_CONTROL &amp;&amp;</span><br><span class="line">		irpsp-&gt;MajorFunction != IRP_MJ_QUERY_INFORMATION)</span><br><span class="line">		<span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">cfListInited</span>())</span><br><span class="line">        <span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于文件打开，用cfIrpCreatePre统一处理。</span></span><br><span class="line">    <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_CREATE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(proc_sec)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">cfIrpCreatePre</span>(irp,irpsp,file,next_dev);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 其他的情况，作为普通进程，不允许打开一个正在加</span></span><br><span class="line">            <span class="comment">// 密的文件。但是在这里无法判断这个文件是否正在加</span></span><br><span class="line">            <span class="comment">// 密，所以返回GO_ON来判断。</span></span><br><span class="line">            <span class="keyword">return</span> SF_IRP_GO_ON;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cfListLock</span>();</span><br><span class="line">    file_sec = <span class="built_in">cfIsFileCrypting</span>(file);</span><br><span class="line">    <span class="built_in">cfListUnlock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不是加密的文件的话，就可以直接passthru了，没有别</span></span><br><span class="line">    <span class="comment">// 的事情了。</span></span><br><span class="line">    <span class="keyword">if</span>(!file_sec)</span><br><span class="line">        <span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是close就可以删除节点了 </span></span><br><span class="line">    <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_CLOSE)</span><br><span class="line">        <span class="keyword">return</span> SF_IRP_GO_ON;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">// 操作上有偏移。以下三种请求必须特殊处理。进行GO_ON</span></span><br><span class="line">    <span class="comment">// 处理。其他的set information操作不需要处理。</span></span><br><span class="line">	<span class="comment">// 1.SET FILE_ALLOCATION_INFORMATION</span></span><br><span class="line">	<span class="comment">// 2.SET FILE_END_OF_FILE_INFORMATION</span></span><br><span class="line">	<span class="comment">// 3.SET FILE_VALID_DATA_LENGTH_INFORMATION</span></span><br><span class="line">    <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_SET_INFORMATION &amp;&amp;</span><br><span class="line">		(irpsp-&gt;Parameters.SetFile.FileInformationClass == FileAllocationInformation ||</span><br><span class="line">		 irpsp-&gt;Parameters.SetFile.FileInformationClass == FileEndOfFileInformation ||</span><br><span class="line">		 irpsp-&gt;Parameters.SetFile.FileInformationClass == FileValidDataLengthInformation ||</span><br><span class="line">		 irpsp-&gt;Parameters.SetFile.FileInformationClass == FileStandardInformation ||</span><br><span class="line">		 irpsp-&gt;Parameters.SetFile.FileInformationClass == FileAllInformation ||</span><br><span class="line">		 irpsp-&gt;Parameters.SetFile.FileInformationClass == FilePositionInformation))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 对这些set information给予修改，使之隐去前面的4k文件头。</span></span><br><span class="line">        <span class="built_in">cfIrpSetInforPre</span>(irp,irpsp<span class="comment">/*,next_dev,file*/</span>);</span><br><span class="line">		<span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_QUERY_INFORMATION)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 要对这些read information的结果给予修改。所以返回go on.</span></span><br><span class="line">        <span class="comment">// 结束后会调用cfIrpQueryInforPost(irp,irpsp);</span></span><br><span class="line">        <span class="keyword">if</span>(irpsp-&gt;Parameters.QueryFile.FileInformationClass == FileAllInformation ||</span><br><span class="line">         irpsp-&gt;Parameters.QueryFile.FileInformationClass == FileAllocationInformation ||</span><br><span class="line">		 irpsp-&gt;Parameters.QueryFile.FileInformationClass == FileEndOfFileInformation ||</span><br><span class="line">         irpsp-&gt;Parameters.QueryFile.FileInformationClass == FileStandardInformation ||</span><br><span class="line">		 irpsp-&gt;Parameters.QueryFile.FileInformationClass == FilePositionInformation ||</span><br><span class="line">         irpsp-&gt;Parameters.QueryFile.FileInformationClass == FileValidDataLengthInformation)</span><br><span class="line">            <span class="keyword">return</span> SF_IRP_GO_ON;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// KdPrint((&quot;OnSfilterIrpPre: %x\r\n&quot;,irpsp-&gt;Parameters.QueryFile.FileInformationClass));</span></span><br><span class="line">            <span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 暂时不处理。</span></span><br><span class="line">	<span class="comment">//if(irpsp-&gt;MajorFunction == IRP_MJ_DIRECTORY_CONTROL)</span></span><br><span class="line">	<span class="comment">//&#123;</span></span><br><span class="line">	<span class="comment">//	// 要对这些read information的结果给予修改。所以返回go on.</span></span><br><span class="line">	<span class="comment">//	// 结束后会调用cfIrpQueryInforPost(irp,irpsp);</span></span><br><span class="line">	<span class="comment">//	if(irpsp-&gt;Parameters.QueryDirectory.FileInformationClass == FileDirectoryInformation ||</span></span><br><span class="line">	<span class="comment">//		irpsp-&gt;Parameters.QueryDirectory.FileInformationClass == FileFullDirectoryInformation ||</span></span><br><span class="line">	<span class="comment">//		irpsp-&gt;Parameters.QueryDirectory.FileInformationClass == FileBothDirectoryInformation)</span></span><br><span class="line">	<span class="comment">//		return SF_IRP_GO_ON;</span></span><br><span class="line">	<span class="comment">//	else</span></span><br><span class="line">	<span class="comment">//	&#123;</span></span><br><span class="line">    <span class="comment">//           KdPrint((&quot;OnSfilterIrpPre: Query information: %x passthru.\r\n&quot;,</span></span><br><span class="line">    <span class="comment">//               irpsp-&gt;Parameters.QueryDirectory.FileInformationClass));</span></span><br><span class="line">	<span class="comment">//		return SF_IRP_PASS;</span></span><br><span class="line">	<span class="comment">//	&#125;</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后两种是read和write，这两种都要修改请求后再下传。同时，read要有完成</span></span><br><span class="line">    <span class="comment">// 处理。请注意：只处理直接读硬盘的请求。对缓冲文件请求不处理。</span></span><br><span class="line">    <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_READ &amp;&amp;</span><br><span class="line">       (irp-&gt;Flags &amp; (IRP_PAGING_IO|IRP_SYNCHRONOUS_PAGING_IO|IRP_NOCACHE)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cfIrpReadPre</span>(irp,irpsp);</span><br><span class="line">        <span class="keyword">return</span> SF_IRP_GO_ON;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_WRITE &amp;&amp;</span><br><span class="line">       (irp-&gt;Flags &amp; (IRP_PAGING_IO|IRP_SYNCHRONOUS_PAGING_IO|IRP_NOCACHE)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">cfIrpWritePre</span>(irp,irpsp,context))</span><br><span class="line">            <span class="keyword">return</span> SF_IRP_GO_ON;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">IoCompleteRequest</span>(irp, IO_NO_INCREMENT);</span><br><span class="line">            <span class="keyword">return</span> SF_IRP_COMPLETED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不加任何处理，直接返回。</span></span><br><span class="line">    <span class="keyword">return</span> SF_IRP_PASS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">OnSfilterIrpPost</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT dev,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT next_dev,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PVOID extension,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PIRP irp,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN NTSTATUS status,</span></span></span><br><span class="line"><span class="params"><span class="function">		PVOID context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获得当前调用栈</span></span><br><span class="line">		PIO_STACK_LOCATION irpsp = <span class="built_in">IoGetCurrentIrpStackLocation</span>(irp);</span><br><span class="line">    BOOLEAN crypting,sec_proc,need_crypt,need_write_header;</span><br><span class="line">    PFILE_OBJECT file = irpsp-&gt;FileObject;</span><br><span class="line">    ULONG desired_access;</span><br><span class="line">    BOOLEAN proc_sec = <span class="built_in">cfIsCurProcSec</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前进程是否是加密进程</span></span><br><span class="line">    sec_proc = <span class="built_in">cfIsCurProcSec</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果操作不成功，就没有必要处理。</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">NT_SUCCESS</span>(status) &amp;&amp;</span><br><span class="line">        !(irpsp-&gt;MajorFunction == IRP_MJ_QUERY_INFORMATION &amp;&amp;</span><br><span class="line">            irpsp-&gt;Parameters.QueryFile.FileInformationClass == FileAllInformation &amp;&amp;</span><br><span class="line">            irp-&gt;IoStatus.Information &gt; <span class="number">0</span>) &amp;&amp;</span><br><span class="line">        irpsp-&gt;MajorFunction != IRP_MJ_WRITE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_READ)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">KdPrint</span>((<span class="string">&quot;OnSfilterIrpPost: IRP_MJ_READ failed. status = %x information = %x\r\n&quot;</span>,</span><br><span class="line">                status,irp-&gt;IoStatus.Information));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_WRITE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">KdPrint</span>((<span class="string">&quot;OnSfilterIrpPost: IRP_MJ_WRITE failed. status = %x information = %x\r\n&quot;</span>,</span><br><span class="line">                status,irp-&gt;IoStatus.Information));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 是否是一个已经被加密进程打开的文件</span></span><br><span class="line">    <span class="built_in">cfListLock</span>();</span><br><span class="line">    <span class="comment">// 如果是create,不需要恢复文件长度。如果是其他请求，在pre的</span></span><br><span class="line">    <span class="comment">// 时候就应该已经恢复了。</span></span><br><span class="line">    crypting = <span class="built_in">cfIsFileCrypting</span>(file);</span><br><span class="line">    <span class="built_in">cfListUnlock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对所有的文件打开，都用如下的过程操作：</span></span><br><span class="line">    <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_CREATE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(proc_sec)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">ASSERT</span>(crypting == FALSE);</span><br><span class="line">            <span class="comment">// 如果是加密进程，则追加进去即可。</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">cfFileCryptAppendLk</span>(file))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">IoCancelFileOpen</span>(next_dev,file);</span><br><span class="line">			    irp-&gt;IoStatus.Status = STATUS_ACCESS_DENIED;</span><br><span class="line">			    irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">KdPrint</span>((<span class="string">&quot;OnSfilterIrpPost: file %wZ failed to call cfFileCryptAppendLk!!!\r\n&quot;</span>,&amp;file-&gt;FileName));            </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">KdPrint</span>((<span class="string">&quot;OnSfilterIrpPost: file %wZ begin to crypting.\r\n&quot;</span>,&amp;file-&gt;FileName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 是普通进程。根据是否是加密文件。如果是加密文件，</span></span><br><span class="line">            <span class="comment">// 否决这个操作。</span></span><br><span class="line">            <span class="keyword">if</span>(crypting)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">IoCancelFileOpen</span>(next_dev,file);</span><br><span class="line">			    irp-&gt;IoStatus.Status = STATUS_ACCESS_DENIED;</span><br><span class="line">			    irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_CLOSE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// clean up结束了。这里删除加密节点，删除缓冲。</span></span><br><span class="line">        <span class="built_in">ASSERT</span>(crypting);</span><br><span class="line">        <span class="built_in">cfCryptFileCleanupComplete</span>(file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_QUERY_INFORMATION)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(crypting);</span><br><span class="line">        <span class="built_in">cfIrpQueryInforPost</span>(irp,irpsp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_READ)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(crypting);</span><br><span class="line">        <span class="built_in">cfIrpReadPost</span>(irp,irpsp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(irpsp-&gt;MajorFunction == IRP_MJ_WRITE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(crypting);</span><br><span class="line">        <span class="built_in">cfIrpWritePost</span>(irp,irpsp,context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">OnSfilterDriverEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PDRIVER_OBJECT DriverObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    IN PUNICODE_STRING RegistryPath,</span></span></span><br><span class="line"><span class="params"><span class="function">	OUT PUNICODE_STRING userNameString,</span></span></span><br><span class="line"><span class="params"><span class="function">	OUT PUNICODE_STRING syblnkString,</span></span></span><br><span class="line"><span class="params"><span class="function">	OUT PULONG extensionSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	UNICODE_STRING user_name,syb_name;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line"><span class="comment">//    _asm int 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化加密链表</span></span><br><span class="line">    <span class="built_in">cfListInit</span>();</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 确定控制设备的名字和符号链接。</span></span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;user_name,<span class="string">L&quot;crypt_file_cdo&quot;</span>);</span><br><span class="line">	<span class="built_in">RtlInitUnicodeString</span>(&amp;syb_name,<span class="string">L&quot;crypt_file_cdo_syb&quot;</span>);</span><br><span class="line">	<span class="built_in">RtlCopyUnicodeString</span>(userNameString,&amp;user_name);</span><br><span class="line">	<span class="built_in">RtlCopyUnicodeString</span>(syblnkString,&amp;syb_name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置控制设备为所有用户可用</span></span><br><span class="line">	<span class="built_in">sfilterSetCdoAccessForAll</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化进程名字查找</span></span><br><span class="line">    <span class="built_in">cfCurProcNameInit</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">OnSfilterDriverUnload</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 没什么要做的...;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">OnSfilterCDODispatch</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT DeviceObject,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PIRP Irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">OnSfilterAttachPre</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT ourDevice,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT theDeviceToAttach,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PUNICODE_STRING DeviceName,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PVOID extension)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 直接返回TRUE，所有设备都绑定</span></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">OnSfilterAttachPost</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT ourDevice,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT theDeviceToAttach,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PDEVICE_OBJECT theDeviceToAttached,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN PVOID extension,</span></span></span><br><span class="line"><span class="params"><span class="function">		IN NTSTATUS status)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 不需要做什么。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h2><h3 id="cf-create-h"><a href="#cf-create-h" class="headerlink" title="cf_create.h"></a>cf_create.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_create.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-2-4</span></span><br><span class="line"><span class="comment">/// @brief      实现对create irp的处理。 </span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是crazy_chu为《寒江独钓——</span></span><br><span class="line"><span class="comment">/// Windows内核编程与信息安全》所编写的文件透明加密示例。</span></span><br><span class="line"><span class="comment">/// 本工程仅仅支持WindowsXP下，FastFat文件系统下记事本的</span></span><br><span class="line"><span class="comment">/// 加密。未测试与杀毒软件或者其他文件过滤驱动并存的情况。</span></span><br><span class="line"><span class="comment">/// 本代码全部权利为作者保留，仅供读者学习和阅读使用。阅</span></span><br><span class="line"><span class="comment">/// 读者须承诺：不直接复制、或者基于此代码进行修改、利用</span></span><br><span class="line"><span class="comment">/// 此代码提供的全部或者部分技术用于商业的软件开发、或者</span></span><br><span class="line"><span class="comment">/// 其他的获利行为。如有违反，同意付出获利十倍之赔偿。</span></span><br><span class="line"><span class="comment">/// 阅读此代码，则自动视为接受以上授权协议。如不接受此协</span></span><br><span class="line"><span class="comment">/// 议者，请不要阅读此代码。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CF_CREATE_HEADER_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CF_CREATE_HEADER_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开预处理。请注意，只有当前进程为加密进程，才需要调</span></span><br><span class="line"><span class="comment">// 用这个预处理来处理。</span></span><br><span class="line"><span class="function">ULONG <span class="title">cfIrpCreatePre</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PIRP irp,</span></span></span><br><span class="line"><span class="params"><span class="function">    PIO_STACK_LOCATION irpsp,</span></span></span><br><span class="line"><span class="params"><span class="function">    PFILE_OBJECT file,</span></span></span><br><span class="line"><span class="params"><span class="function">    PDEVICE_OBJECT next_dev)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _CF_CREATE_HEADER_</span></span></span><br></pre></td></tr></table></figure>
<h3 id="cf-file-irp-h"><a href="#cf-file-irp-h" class="headerlink" title="cf_file_irp.h"></a>cf_file_irp.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_file_irp.h</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-1-29</span></span><br><span class="line"><span class="comment">/// @brief       对文件的操作，直接发送irp来避免重入</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CF_FILE_IRP_HEADER_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CF_FILE_IRP_HEADER_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自发送SetInformation请求.</span></span><br><span class="line"><span class="function">NTSTATUS </span></span><br><span class="line"><span class="function"><span class="title">cfFileSetInformation</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">    DEVICE_OBJECT *dev, </span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_INFORMATION_CLASS infor_class,</span></span></span><br><span class="line"><span class="params"><span class="function">	FILE_OBJECT *set_file,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>* buf,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG buf_len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">cfFileQueryInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DEVICE_OBJECT *dev, </span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_INFORMATION_CLASS infor_class,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">void</span>* buf,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG buf_len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS </span></span><br><span class="line"><span class="function"><span class="title">cfFileReadWrite</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">    DEVICE_OBJECT *dev, </span></span></span><br><span class="line"><span class="params"><span class="function">    FILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">    LARGE_INTEGER *offset,</span></span></span><br><span class="line"><span class="params"><span class="function">	ULONG *length,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="type">void</span> *buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">	BOOLEAN read_write)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">cfFileGetStandInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	PDEVICE_OBJECT dev,</span></span></span><br><span class="line"><span class="params"><span class="function">	PFILE_OBJECT file,</span></span></span><br><span class="line"><span class="params"><span class="function">	PLARGE_INTEGER allocate_size,</span></span></span><br><span class="line"><span class="params"><span class="function">	PLARGE_INTEGER file_size,</span></span></span><br><span class="line"><span class="params"><span class="function">	BOOLEAN *dir)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">cfFileSetFileSize</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	DEVICE_OBJECT *dev,</span></span></span><br><span class="line"><span class="params"><span class="function">	FILE_OBJECT *file,</span></span></span><br><span class="line"><span class="params"><span class="function">	LARGE_INTEGER *file_size)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理缓冲</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfFileCacheClear</span><span class="params">(PFILE_OBJECT pFileObject)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _CF_FILE_IRP_HEADER_</span></span></span><br></pre></td></tr></table></figure>
<h3 id="cf-list-h"><a href="#cf-list-h" class="headerlink" title="cf_list.h"></a>cf_list.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_list.h</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-1-29</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CF_LIST_HEADER_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CF_LIST_HEADER_</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfListInit</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfListInited</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfListLock</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfListUnlock</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 任意给定一个文件，判断是否在加密链表中。</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfIsFileCrypting</span><span class="params">(PFILE_OBJECT file)</span></span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfFileCryptAppendLk</span><span class="params">(PFILE_OBJECT file)</span></span>;</span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfIsFileNeedCrypt</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PFILE_OBJECT file,</span></span></span><br><span class="line"><span class="params"><span class="function">    PDEVICE_OBJECT next_dev,</span></span></span><br><span class="line"><span class="params"><span class="function">    ULONG desired_access,</span></span></span><br><span class="line"><span class="params"><span class="function">    BOOLEAN *need_write_header)</span></span>;</span><br><span class="line"><span class="comment">// 当有文件被clean up的时候调用此函数。如果检查发现</span></span><br><span class="line"><span class="comment">// FileObject-&gt;FsContext在列表中</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfCryptFileCleanupComplete</span><span class="params">(PFILE_OBJECT file)</span></span>;</span><br><span class="line"><span class="function">NTSTATUS <span class="title">cfWriteAHeader</span><span class="params">(PFILE_OBJECT file,PDEVICE_OBJECT next_dev)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _CF_LIST_HEADER_</span></span></span><br></pre></td></tr></table></figure>
<h3 id="cf-modify-irp-h"><a href="#cf-modify-irp-h" class="headerlink" title="cf_modify_irp.h"></a>cf_modify_irp.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_modify_irp.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-2-1</span></span><br><span class="line"><span class="comment">/// @brief      实现对irp请求和结果的修改 </span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是crazy_chu为《寒江独钓——</span></span><br><span class="line"><span class="comment">/// Windows内核编程与信息安全》所编写的文件透明加密示例。</span></span><br><span class="line"><span class="comment">/// 本工程仅仅支持WindowsXP下，FastFat文件系统下记事本的</span></span><br><span class="line"><span class="comment">/// 加密。未测试与杀毒软件或者其他文件过滤驱动并存的情况。</span></span><br><span class="line"><span class="comment">/// 本代码全部权利为作者保留，仅供读者学习和阅读使用。阅</span></span><br><span class="line"><span class="comment">/// 读者须承诺：不直接复制、或者基于此代码进行修改、利用</span></span><br><span class="line"><span class="comment">/// 此代码提供的全部或者部分技术用于商业的软件开发、或者</span></span><br><span class="line"><span class="comment">/// 其他的获利行为。如有违反，同意付出获利十倍之赔偿。</span></span><br><span class="line"><span class="comment">/// 阅读此代码，则自动视为接受以上授权协议。如不接受此协</span></span><br><span class="line"><span class="comment">/// 议者，请不要阅读此代码。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CF_MODIFY_IRP_HEADER_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CF_MODIFY_IRP_HEADER_</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpSetInforPre</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    PIRP irp,</span></span></span><br><span class="line"><span class="params"><span class="function">    PIO_STACK_LOCATION irpsp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpQueryInforPost</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpDirectoryControlPost</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpReadPre</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpReadPost</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfIrpWritePre</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp,<span class="type">void</span> **context)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfIrpWritePost</span><span class="params">(PIRP irp,PIO_STACK_LOCATION irpsp,<span class="type">void</span> *context)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _CF_MODIFY_IRP_HEADER_</span></span></span><br></pre></td></tr></table></figure>
<h3 id="cf-proc-h"><a href="#cf-proc-h" class="headerlink" title="cf_proc.h"></a>cf_proc.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @file         cf_proc.c</span></span><br><span class="line"><span class="comment">/// @author    crazy_chu</span></span><br><span class="line"><span class="comment">/// @date       2009-1-30</span></span><br><span class="line"><span class="comment">/// @brief      获得当前进程的名字。 </span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 授权协议</span></span><br><span class="line"><span class="comment">/// 本代码从属于工程crypt_file.是crazy_chu为《寒江独钓——</span></span><br><span class="line"><span class="comment">/// Windows内核编程与信息安全》所编写的文件透明加密示例。</span></span><br><span class="line"><span class="comment">/// 本工程仅仅支持WindowsXP下，FastFat文件系统下记事本的</span></span><br><span class="line"><span class="comment">/// 加密。未测试与杀毒软件或者其他文件过滤驱动并存的情况。</span></span><br><span class="line"><span class="comment">/// 本代码全部权利为作者保留，仅供读者学习和阅读使用。阅</span></span><br><span class="line"><span class="comment">/// 读者须承诺：不直接复制、或者基于此代码进行修改、利用</span></span><br><span class="line"><span class="comment">/// 此代码提供的全部或者部分技术用于商业的软件开发、或者</span></span><br><span class="line"><span class="comment">/// 其他的获利行为。如有违反，同意付出获利十倍之赔偿。</span></span><br><span class="line"><span class="comment">/// 阅读此代码，则自动视为接受以上授权协议。如不接受此协</span></span><br><span class="line"><span class="comment">/// 议者，请不要阅读此代码。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _CF_PROC_HEADER_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CF_PROC_HEADER_</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cfCurProcNameInit</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下函数可以获得进程名。返回获得的长度。</span></span><br><span class="line"><span class="function">ULONG <span class="title">cfCurProcName</span><span class="params">(PUNICODE_STRING name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断当前进程是不是notepad.exe</span></span><br><span class="line"><span class="function">BOOLEAN <span class="title">cfIsCurProcSec</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _CF_PROC_HEADER_</span></span></span><br></pre></td></tr></table></figure>
<h3 id="fat-headers-fat-h"><a href="#fat-headers-fat-h" class="headerlink" title="fat_headers\\fat.h"></a>fat_headers\\fat.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 1989-2000 Microsoft Corporation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Fat.h</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This module defines the on-disk structure of the Fat file system.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _FAT_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FAT_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The following nomenclature is used to describe the Fat on-disk</span></span><br><span class="line"><span class="comment">//  structure:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      LBN - is the number of a sector relative to the start of the disk.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      VBN - is the number of a sector relative to the start of a file,</span></span><br><span class="line"><span class="comment">//          directory, or allocation.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      LBO - is a byte offset relative to the start of the disk.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      VBO - is a byte offset relative to the start of a file, directory</span></span><br><span class="line"><span class="comment">//          or allocation.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LONGLONG LBO;    <span class="comment">/* for Fat32, LBO is &gt;32 bits */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LBO *PLBO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG32 VBO;</span><br><span class="line"><span class="keyword">typedef</span> VBO *PVBO;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The boot sector is the first physical sector (LBN == 0) on the volume.</span></span><br><span class="line"><span class="comment">//  Part of the sector contains a BIOS Parameter Block.  The BIOS in the</span></span><br><span class="line"><span class="comment">//  sector is packed (i.e., unaligned) so we&#x27;ll supply a unpacking macro</span></span><br><span class="line"><span class="comment">//  to translate a packed BIOS into its unpacked equivalent.  The unpacked</span></span><br><span class="line"><span class="comment">//  BIOS structure is already defined in ntioapi.h so we only need to define</span></span><br><span class="line"><span class="comment">//  the packed BIOS.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Define the Packed and Unpacked BIOS Parameter Block</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PACKED_BIOS_PARAMETER_BLOCK</span> &#123;</span><br><span class="line">    UCHAR  BytesPerSector[<span class="number">2</span>];                       <span class="comment">// offset = 0x000  0</span></span><br><span class="line">    UCHAR  SectorsPerCluster[<span class="number">1</span>];                    <span class="comment">// offset = 0x002  2</span></span><br><span class="line">    UCHAR  ReservedSectors[<span class="number">2</span>];                      <span class="comment">// offset = 0x003  3</span></span><br><span class="line">    UCHAR  Fats[<span class="number">1</span>];                                 <span class="comment">// offset = 0x005  5</span></span><br><span class="line">    UCHAR  RootEntries[<span class="number">2</span>];                          <span class="comment">// offset = 0x006  6</span></span><br><span class="line">    UCHAR  Sectors[<span class="number">2</span>];                              <span class="comment">// offset = 0x008  8</span></span><br><span class="line">    UCHAR  Media[<span class="number">1</span>];                                <span class="comment">// offset = 0x00A 10</span></span><br><span class="line">    UCHAR  SectorsPerFat[<span class="number">2</span>];                        <span class="comment">// offset = 0x00B 11</span></span><br><span class="line">    UCHAR  SectorsPerTrack[<span class="number">2</span>];                      <span class="comment">// offset = 0x00D 13</span></span><br><span class="line">    UCHAR  Heads[<span class="number">2</span>];                                <span class="comment">// offset = 0x00F 15</span></span><br><span class="line">    UCHAR  HiddenSectors[<span class="number">4</span>];                        <span class="comment">// offset = 0x011 17</span></span><br><span class="line">    UCHAR  LargeSectors[<span class="number">4</span>];                         <span class="comment">// offset = 0x015 21</span></span><br><span class="line">&#125; PACKED_BIOS_PARAMETER_BLOCK;                      <span class="comment">// sizeof = 0x019 25</span></span><br><span class="line"><span class="keyword">typedef</span> PACKED_BIOS_PARAMETER_BLOCK *PPACKED_BIOS_PARAMETER_BLOCK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PACKED_BIOS_PARAMETER_BLOCK_EX</span> &#123;</span><br><span class="line">    UCHAR  BytesPerSector[<span class="number">2</span>];                       <span class="comment">// offset = 0x000  0</span></span><br><span class="line">    UCHAR  SectorsPerCluster[<span class="number">1</span>];                    <span class="comment">// offset = 0x002  2</span></span><br><span class="line">    UCHAR  ReservedSectors[<span class="number">2</span>];                      <span class="comment">// offset = 0x003  3</span></span><br><span class="line">    UCHAR  Fats[<span class="number">1</span>];                                 <span class="comment">// offset = 0x005  5</span></span><br><span class="line">    UCHAR  RootEntries[<span class="number">2</span>];                          <span class="comment">// offset = 0x006  6</span></span><br><span class="line">    UCHAR  Sectors[<span class="number">2</span>];                              <span class="comment">// offset = 0x008  8</span></span><br><span class="line">    UCHAR  Media[<span class="number">1</span>];                                <span class="comment">// offset = 0x00A 10</span></span><br><span class="line">    UCHAR  SectorsPerFat[<span class="number">2</span>];                        <span class="comment">// offset = 0x00B 11</span></span><br><span class="line">    UCHAR  SectorsPerTrack[<span class="number">2</span>];                      <span class="comment">// offset = 0x00D 13</span></span><br><span class="line">    UCHAR  Heads[<span class="number">2</span>];                                <span class="comment">// offset = 0x00F 15</span></span><br><span class="line">    UCHAR  HiddenSectors[<span class="number">4</span>];                        <span class="comment">// offset = 0x011 17</span></span><br><span class="line">    UCHAR  LargeSectors[<span class="number">4</span>];                         <span class="comment">// offset = 0x015 21</span></span><br><span class="line">    UCHAR  LargeSectorsPerFat[<span class="number">4</span>];                   <span class="comment">// offset = 0x019 25</span></span><br><span class="line">    UCHAR  ExtendedFlags[<span class="number">2</span>];                        <span class="comment">// offset = 0x01D 29</span></span><br><span class="line">    UCHAR  FsVersion[<span class="number">2</span>];                            <span class="comment">// offset = 0x01F 31</span></span><br><span class="line">    UCHAR  RootDirFirstCluster[<span class="number">4</span>];                  <span class="comment">// offset = 0x021 33</span></span><br><span class="line">    UCHAR  FsInfoSector[<span class="number">2</span>];                         <span class="comment">// offset = 0x025 37</span></span><br><span class="line">    UCHAR  BackupBootSector[<span class="number">2</span>];                     <span class="comment">// offset = 0x027 39</span></span><br><span class="line">    UCHAR  Reserved[<span class="number">12</span>];                            <span class="comment">// offset = 0x029 41</span></span><br><span class="line">&#125; PACKED_BIOS_PARAMETER_BLOCK_EX;                   <span class="comment">// sizeof = 0x035 53</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> PACKED_BIOS_PARAMETER_BLOCK_EX *PPACKED_BIOS_PARAMETER_BLOCK_EX;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The IsBpbFat32 macro is defined to work with both packed and unpacked</span></span><br><span class="line"><span class="comment">//  BPB structures.  Since we are only checking for zero, the byte order</span></span><br><span class="line"><span class="comment">//  does not matter.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IsBpbFat32(bpb) (*(USHORT *)(&amp;(bpb)-&gt;SectorsPerFat) == 0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">BIOS_PARAMETER_BLOCK</span> &#123;</span><br><span class="line">    USHORT BytesPerSector;</span><br><span class="line">    UCHAR  SectorsPerCluster;</span><br><span class="line">    USHORT ReservedSectors;</span><br><span class="line">    UCHAR  Fats;</span><br><span class="line">    USHORT RootEntries;</span><br><span class="line">    USHORT Sectors;</span><br><span class="line">    UCHAR  Media;</span><br><span class="line">    USHORT SectorsPerFat;</span><br><span class="line">    USHORT SectorsPerTrack;</span><br><span class="line">    USHORT Heads;</span><br><span class="line">    ULONG32  HiddenSectors;</span><br><span class="line">    ULONG32  LargeSectors;</span><br><span class="line">    ULONG32  LargeSectorsPerFat;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        USHORT ExtendedFlags;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            ULONG ActiveFat:<span class="number">4</span>;</span><br><span class="line">            ULONG Reserved0:<span class="number">3</span>;</span><br><span class="line">            ULONG MirrorDisabled:<span class="number">1</span>;</span><br><span class="line">            ULONG Reserved1:<span class="number">8</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    USHORT FsVersion;</span><br><span class="line">    ULONG32 RootDirFirstCluster;</span><br><span class="line">    USHORT FsInfoSector;</span><br><span class="line">    USHORT BackupBootSector;</span><br><span class="line">&#125; BIOS_PARAMETER_BLOCK, *PBIOS_PARAMETER_BLOCK;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This macro takes a Packed BIOS and fills in its Unpacked equivalent</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatUnpackBios(Bios,Pbios) &#123;                                         \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;BytesPerSector,    &amp;(Pbios)-&gt;BytesPerSector[0]   ); \</span></span><br><span class="line"><span class="meta">    CopyUchar1(&amp;(Bios)-&gt;SectorsPerCluster, &amp;(Pbios)-&gt;SectorsPerCluster[0]); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;ReservedSectors,   &amp;(Pbios)-&gt;ReservedSectors[0]  ); \</span></span><br><span class="line"><span class="meta">    CopyUchar1(&amp;(Bios)-&gt;Fats,              &amp;(Pbios)-&gt;Fats[0]             ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;RootEntries,       &amp;(Pbios)-&gt;RootEntries[0]      ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;Sectors,           &amp;(Pbios)-&gt;Sectors[0]          ); \</span></span><br><span class="line"><span class="meta">    CopyUchar1(&amp;(Bios)-&gt;Media,             &amp;(Pbios)-&gt;Media[0]            ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;SectorsPerFat,     &amp;(Pbios)-&gt;SectorsPerFat[0]    ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;SectorsPerTrack,   &amp;(Pbios)-&gt;SectorsPerTrack[0]  ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;Heads,             &amp;(Pbios)-&gt;Heads[0]            ); \</span></span><br><span class="line"><span class="meta">    CopyUchar4(&amp;(Bios)-&gt;HiddenSectors,     &amp;(Pbios)-&gt;HiddenSectors[0]    ); \</span></span><br><span class="line"><span class="meta">    CopyUchar4(&amp;(Bios)-&gt;LargeSectors,      &amp;(Pbios)-&gt;LargeSectors[0]     ); \</span></span><br><span class="line"><span class="meta">    CopyUchar4(&amp;(Bios)-&gt;LargeSectorsPerFat,&amp;((PPACKED_BIOS_PARAMETER_BLOCK_EX)Pbios)-&gt;LargeSectorsPerFat[0]  ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;ExtendedFlags,     &amp;((PPACKED_BIOS_PARAMETER_BLOCK_EX)Pbios)-&gt;ExtendedFlags[0]       ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;FsVersion,         &amp;((PPACKED_BIOS_PARAMETER_BLOCK_EX)Pbios)-&gt;FsVersion[0]           ); \</span></span><br><span class="line"><span class="meta">    CopyUchar4(&amp;(Bios)-&gt;RootDirFirstCluster,                                \</span></span><br><span class="line"><span class="meta">                                           &amp;((PPACKED_BIOS_PARAMETER_BLOCK_EX)Pbios)-&gt;RootDirFirstCluster[0] ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;FsInfoSector,      &amp;((PPACKED_BIOS_PARAMETER_BLOCK_EX)Pbios)-&gt;FsInfoSector[0]        ); \</span></span><br><span class="line"><span class="meta">    CopyUchar2(&amp;(Bios)-&gt;BackupBootSector,  &amp;((PPACKED_BIOS_PARAMETER_BLOCK_EX)Pbios)-&gt;BackupBootSector[0]    ); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Define the boot sector</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PACKED_BOOT_SECTOR</span> &#123;</span><br><span class="line">    UCHAR Jump[<span class="number">3</span>];                                  <span class="comment">// offset = 0x000   0</span></span><br><span class="line">    UCHAR Oem[<span class="number">8</span>];                                   <span class="comment">// offset = 0x003   3</span></span><br><span class="line">    PACKED_BIOS_PARAMETER_BLOCK PackedBpb;          <span class="comment">// offset = 0x00B  11</span></span><br><span class="line">    UCHAR PhysicalDriveNumber;                      <span class="comment">// offset = 0x024  36</span></span><br><span class="line">    UCHAR CurrentHead;                              <span class="comment">// offset = 0x025  37</span></span><br><span class="line">    UCHAR Signature;                                <span class="comment">// offset = 0x026  38</span></span><br><span class="line">    UCHAR Id[<span class="number">4</span>];                                    <span class="comment">// offset = 0x027  39</span></span><br><span class="line">    UCHAR VolumeLabel[<span class="number">11</span>];                          <span class="comment">// offset = 0x02B  43</span></span><br><span class="line">    UCHAR SystemId[<span class="number">8</span>];                              <span class="comment">// offset = 0x036  54</span></span><br><span class="line">&#125; PACKED_BOOT_SECTOR;                               <span class="comment">// sizeof = 0x03E  62</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> PACKED_BOOT_SECTOR *PPACKED_BOOT_SECTOR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PACKED_BOOT_SECTOR_EX</span> &#123;</span><br><span class="line">    UCHAR Jump[<span class="number">3</span>];                                  <span class="comment">// offset = 0x000   0</span></span><br><span class="line">    UCHAR Oem[<span class="number">8</span>];                                   <span class="comment">// offset = 0x003   3</span></span><br><span class="line">    PACKED_BIOS_PARAMETER_BLOCK_EX PackedBpb;       <span class="comment">// offset = 0x00B  11</span></span><br><span class="line">    UCHAR PhysicalDriveNumber;                      <span class="comment">// offset = 0x040  64</span></span><br><span class="line">    UCHAR CurrentHead;                              <span class="comment">// offset = 0x041  65</span></span><br><span class="line">    UCHAR Signature;                                <span class="comment">// offset = 0x042  66</span></span><br><span class="line">    UCHAR Id[<span class="number">4</span>];                                    <span class="comment">// offset = 0x043  67</span></span><br><span class="line">    UCHAR VolumeLabel[<span class="number">11</span>];                          <span class="comment">// offset = 0x047  71</span></span><br><span class="line">    UCHAR SystemId[<span class="number">8</span>];                              <span class="comment">// offset = 0x058  88</span></span><br><span class="line">&#125; PACKED_BOOT_SECTOR_EX;                            <span class="comment">// sizeof = 0x060  96</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> PACKED_BOOT_SECTOR_EX *PPACKED_BOOT_SECTOR_EX;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Define the FAT32 FsInfo sector.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FSINFO_SECTOR</span> &#123;</span><br><span class="line">    ULONG SectorBeginSignature;                     <span class="comment">// offset = 0x000   0</span></span><br><span class="line">    UCHAR ExtraBootCode[<span class="number">480</span>];                       <span class="comment">// offset = 0x004   4</span></span><br><span class="line">    ULONG FsInfoSignature;                          <span class="comment">// offset = 0x1e4 484</span></span><br><span class="line">    ULONG FreeClusterCount;                         <span class="comment">// offset = 0x1e8 488</span></span><br><span class="line">    ULONG NextFreeCluster;                          <span class="comment">// offset = 0x1ec 492</span></span><br><span class="line">    UCHAR Reserved[<span class="number">12</span>];                             <span class="comment">// offset = 0x1f0 496</span></span><br><span class="line">    ULONG SectorEndSignature;                       <span class="comment">// offset = 0x1fc 508</span></span><br><span class="line">&#125; FSINFO_SECTOR, *PFSINFO_SECTOR;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FSINFO_SECTOR_BEGIN_SIGNATURE   0x41615252</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FSINFO_SECTOR_END_SIGNATURE     0xAA550000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FSINFO_SIGNATURE                0x61417272</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  We use the CurrentHead field for our dirty partition info.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BOOT_SECTOR_DIRTY            0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BOOT_SECTOR_TEST_SURFACE     0x02</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Define a Fat Entry type.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This type is used when representing a fat table entry.  It also used</span></span><br><span class="line"><span class="comment">//  to be used when dealing with a fat table index and a count of entries,</span></span><br><span class="line"><span class="comment">//  but the ensuing type casting nightmare sealed this fate.  These other</span></span><br><span class="line"><span class="comment">//  two types are represented as ULONGs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG32 FAT_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT32_ENTRY_MASK 0x0FFFFFFFUL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  We use these special index values to set the dirty info for</span></span><br><span class="line"><span class="comment">//  DOS/Win9x compatibility.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_CLEAN_VOLUME        (~FAT32_ENTRY_MASK | 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRTY_VOLUME        (~FAT32_ENTRY_MASK | 1)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRTY_BIT_INDEX     1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Physically, the entry is fully set if clean, and the high</span></span><br><span class="line"><span class="comment">//  bit knocked out if it is dirty (i.e., it is really a clean</span></span><br><span class="line"><span class="comment">//  bit).  This means it is different per-FAT size.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_CLEAN_ENTRY         (~0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT12_DIRTY_ENTRY       0x7ff</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT16_DIRTY_ENTRY       0x7fff</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT32_DIRTY_ENTRY       0x7fffffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The following constants the are the valid Fat index values.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_CLUSTER_AVAILABLE            (FAT_ENTRY)0x00000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_CLUSTER_RESERVED             (FAT_ENTRY)0x0ffffff0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_CLUSTER_BAD                  (FAT_ENTRY)0x0ffffff7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_CLUSTER_LAST                 (FAT_ENTRY)0x0fffffff</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Fat files have the following time/date structures.  Note that the</span></span><br><span class="line"><span class="comment">//  following structure is a 32 bits long but USHORT aligned.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FAT_TIME</span> &#123;</span><br><span class="line"></span><br><span class="line">    USHORT DoubleSeconds : <span class="number">5</span>;</span><br><span class="line">    USHORT Minute        : <span class="number">6</span>;</span><br><span class="line">    USHORT Hour          : <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">&#125; FAT_TIME;</span><br><span class="line"><span class="keyword">typedef</span> FAT_TIME *PFAT_TIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FAT_DATE</span> &#123;</span><br><span class="line"></span><br><span class="line">    USHORT Day           : <span class="number">5</span>;</span><br><span class="line">    USHORT Month         : <span class="number">4</span>;</span><br><span class="line">    USHORT Year          : <span class="number">7</span>; <span class="comment">// Relative to 1980</span></span><br><span class="line"></span><br><span class="line">&#125; FAT_DATE;</span><br><span class="line"><span class="keyword">typedef</span> FAT_DATE *PFAT_DATE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FAT_TIME_STAMP</span> &#123;</span><br><span class="line"></span><br><span class="line">    FAT_TIME Time;</span><br><span class="line">    FAT_DATE Date;</span><br><span class="line"></span><br><span class="line">&#125; FAT_TIME_STAMP;</span><br><span class="line"><span class="keyword">typedef</span> FAT_TIME_STAMP *PFAT_TIME_STAMP;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Fat files have 8 character file names and 3 character extensions</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> UCHAR FAT8DOT3[<span class="number">11</span>];</span><br><span class="line"><span class="keyword">typedef</span> FAT8DOT3 *PFAT8DOT3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The directory entry record exists for every file/directory on the</span></span><br><span class="line"><span class="comment">//  disk except for the root directory.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PACKED_DIRENT</span> &#123;</span><br><span class="line">    FAT8DOT3       FileName;                         <span class="comment">//  offset =  0</span></span><br><span class="line">    UCHAR          Attributes;                       <span class="comment">//  offset = 11</span></span><br><span class="line">    UCHAR          NtByte;                           <span class="comment">//  offset = 12</span></span><br><span class="line">    UCHAR          CreationMSec;                     <span class="comment">//  offset = 13</span></span><br><span class="line">    FAT_TIME_STAMP CreationTime;                     <span class="comment">//  offset = 14</span></span><br><span class="line">    FAT_DATE       LastAccessDate;                   <span class="comment">//  offset = 18</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        USHORT     ExtendedAttributes;               <span class="comment">//  offset = 20</span></span><br><span class="line">        USHORT     FirstClusterOfFileHi;             <span class="comment">//  offset = 20</span></span><br><span class="line">    &#125;;</span><br><span class="line">    FAT_TIME_STAMP LastWriteTime;                    <span class="comment">//  offset = 22</span></span><br><span class="line">    USHORT         FirstClusterOfFile;               <span class="comment">//  offset = 26</span></span><br><span class="line">    ULONG32        FileSize;                         <span class="comment">//  offset = 28</span></span><br><span class="line">&#125; PACKED_DIRENT;                                     <span class="comment">//  sizeof = 32</span></span><br><span class="line"><span class="keyword">typedef</span> PACKED_DIRENT *PPACKED_DIRENT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  A packed dirent is already quadword aligned so simply declare a dirent as a</span></span><br><span class="line"><span class="comment">//  packed dirent</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> PACKED_DIRENT DIRENT;</span><br><span class="line"><span class="keyword">typedef</span> DIRENT *PDIRENT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The first byte of a dirent describes the dirent.  There is also a routine</span></span><br><span class="line"><span class="comment">//  to help in deciding how to interpret the dirent.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_NEVER_USED            0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_REALLY_0E5            0x05</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_DIRECTORY_ALIAS       0x2e</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_DELETED               0xe5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Define the NtByte bits.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_NT_BYTE_8_LOWER_CASE  0x08</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_NT_BYTE_3_LOWER_CASE  0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Define the various dirent attributes</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_ATTR_READ_ONLY        0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_ATTR_HIDDEN           0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_ATTR_SYSTEM           0x04</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_ATTR_VOLUME_ID        0x08</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_ATTR_DIRECTORY        0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_ATTR_ARCHIVE          0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_ATTR_DEVICE           0x40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_DIRENT_ATTR_LFN              (FAT_DIRENT_ATTR_READ_ONLY | \</span></span><br><span class="line"><span class="meta">                                          FAT_DIRENT_ATTR_HIDDEN |    \</span></span><br><span class="line"><span class="meta">                                          FAT_DIRENT_ATTR_SYSTEM |    \</span></span><br><span class="line"><span class="meta">                                          FAT_DIRENT_ATTR_VOLUME_ID)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  These macros convert a number of fields in the Bpb to bytes from sectors</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      ULONG</span></span><br><span class="line"><span class="comment">//      FatBytesPerCluster (</span></span><br><span class="line"><span class="comment">//          IN PBIOS_PARAMETER_BLOCK Bios</span></span><br><span class="line"><span class="comment">//      );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      ULONG</span></span><br><span class="line"><span class="comment">//      FatBytesPerFat (</span></span><br><span class="line"><span class="comment">//          IN PBIOS_PARAMETER_BLOCK Bios</span></span><br><span class="line"><span class="comment">//      );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      ULONG</span></span><br><span class="line"><span class="comment">//      FatReservedBytes (</span></span><br><span class="line"><span class="comment">//          IN PBIOS_PARAMETER_BLOCK Bios</span></span><br><span class="line"><span class="comment">//      );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatBytesPerCluster(B) ((ULONG)((B)-&gt;BytesPerSector * (B)-&gt;SectorsPerCluster))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatBytesPerFat(B) (IsBpbFat32(B)?                           \</span></span><br><span class="line"><span class="meta">    ((ULONG)((B)-&gt;BytesPerSector * (B)-&gt;LargeSectorsPerFat)) :      \</span></span><br><span class="line"><span class="meta">    ((ULONG)((B)-&gt;BytesPerSector * (B)-&gt;SectorsPerFat)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatReservedBytes(B) ((ULONG)((B)-&gt;BytesPerSector * (B)-&gt;ReservedSectors))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This macro returns the size of the root directory dirent area in bytes</span></span><br><span class="line"><span class="comment">//  For Fat32, the root directory is variable in length.  This macro returns</span></span><br><span class="line"><span class="comment">//  0 because it is also used to determine the location of cluster 2.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      ULONG</span></span><br><span class="line"><span class="comment">//      FatRootDirectorySize (</span></span><br><span class="line"><span class="comment">//          IN PBIOS_PARAMETER_BLOCK Bios</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatRootDirectorySize(B) ((ULONG)((B)-&gt;RootEntries * sizeof(DIRENT)))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This macro returns the first Lbo (zero based) of the root directory on</span></span><br><span class="line"><span class="comment">//  the device.  This area is after the reserved and fats.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  For Fat32, the root directory is moveable.  This macro returns the LBO</span></span><br><span class="line"><span class="comment">//  for cluster 2 because it is used to determine the location of cluster 2.</span></span><br><span class="line"><span class="comment">//  FatRootDirectoryLbo32() returns the actual LBO of the beginning of the</span></span><br><span class="line"><span class="comment">//  actual root directory.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      LBO</span></span><br><span class="line"><span class="comment">//      FatRootDirectoryLbo (</span></span><br><span class="line"><span class="comment">//          IN PBIOS_PARAMETER_BLOCK Bios</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatRootDirectoryLbo(B) (FatReservedBytes(B) + ((B)-&gt;Fats * FatBytesPerFat(B)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatRootDirectoryLbo32(B) (FatFileAreaLbo(B)+((B)-&gt;RootDirFirstCluster-2)*FatBytesPerCluster(B))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This macro returns the first Lbo (zero based) of the file area on the</span></span><br><span class="line"><span class="comment">//  the device.  This area is after the reserved, fats, and root directory.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      LBO</span></span><br><span class="line"><span class="comment">//      FatFirstFileAreaLbo (</span></span><br><span class="line"><span class="comment">//          IN PBIOS_PARAMTER_BLOCK Bios</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatFileAreaLbo(B) (FatRootDirectoryLbo(B) + FatRootDirectorySize(B))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This macro returns the number of clusters on the disk.  This value is</span></span><br><span class="line"><span class="comment">//  computed by taking the total sectors on the disk subtracting up to the</span></span><br><span class="line"><span class="comment">//  first file area sector and then dividing by the sectors per cluster count.</span></span><br><span class="line"><span class="comment">//  Note that I don&#x27;t use any of the above macros since far too much</span></span><br><span class="line"><span class="comment">//  superfluous sector/byte conversion would take place.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      ULONG</span></span><br><span class="line"><span class="comment">//      FatNumberOfClusters (</span></span><br><span class="line"><span class="comment">//          IN PBIOS_PARAMETER_BLOCK Bios</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// for prior to MS-DOS Version 3.2</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// After DOS 4.0, at least one of these, Sectors or LargeSectors, will be zero.</span></span><br><span class="line"><span class="comment">// but DOS version 3.2 case, both of these value might contains some value,</span></span><br><span class="line"><span class="comment">// because, before 3.2, we don&#x27;t have Large Sector entry, some disk might have</span></span><br><span class="line"><span class="comment">// unexpected value in the field, we will use LargeSectors if Sectors eqaul to zero.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatNumberOfClusters(B) (                                         \</span></span><br><span class="line"><span class="meta">                                                                         \</span></span><br><span class="line"><span class="meta">  IsBpbFat32(B) ?                                                        \</span></span><br><span class="line"><span class="meta">                                                                         \</span></span><br><span class="line"><span class="meta">    ((((B)-&gt;Sectors ? (B)-&gt;Sectors : (B)-&gt;LargeSectors)                  \</span></span><br><span class="line"><span class="meta">                                                                         \</span></span><br><span class="line"><span class="meta">        -   ((B)-&gt;ReservedSectors +                                      \</span></span><br><span class="line"><span class="meta">             (B)-&gt;Fats * (B)-&gt;LargeSectorsPerFat ))                      \</span></span><br><span class="line"><span class="meta">                                                                         \</span></span><br><span class="line"><span class="meta">                                    /                                    \</span></span><br><span class="line"><span class="meta">                                                                         \</span></span><br><span class="line"><span class="meta">                        (B)-&gt;SectorsPerCluster)                          \</span></span><br><span class="line"><span class="meta">  :                                                                      \</span></span><br><span class="line"><span class="meta">    ((((B)-&gt;Sectors ? (B)-&gt;Sectors : (B)-&gt;LargeSectors)                  \</span></span><br><span class="line"><span class="meta">                                                                         \</span></span><br><span class="line"><span class="meta">        -   ((B)-&gt;ReservedSectors +                                      \</span></span><br><span class="line"><span class="meta">             (B)-&gt;Fats * (B)-&gt;SectorsPerFat +                            \</span></span><br><span class="line"><span class="meta">             (B)-&gt;RootEntries * sizeof(DIRENT) / (B)-&gt;BytesPerSector ) ) \</span></span><br><span class="line"><span class="meta">                                                                         \</span></span><br><span class="line"><span class="meta">                                    /                                    \</span></span><br><span class="line"><span class="meta">                                                                         \</span></span><br><span class="line"><span class="meta">                        (B)-&gt;SectorsPerCluster)                          \</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This macro returns the fat table bit size (i.e., 12 or 16 bits)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      ULONG</span></span><br><span class="line"><span class="comment">//      FatIndexBitSize (</span></span><br><span class="line"><span class="comment">//          IN PBIOS_PARAMETER_BLOCK Bios</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatIndexBitSize(B)  \</span></span><br><span class="line"><span class="meta">    ((UCHAR)(IsBpbFat32(B) ? 32 : (FatNumberOfClusters(B) &lt; 4087 ? 12 : 16)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This macro raises STATUS_FILE_CORRUPT and marks the Fcb bad if an</span></span><br><span class="line"><span class="comment">//  index value is not within the proper range.</span></span><br><span class="line"><span class="comment">//  Note that the first two index values are invalid (0, 1), so we must</span></span><br><span class="line"><span class="comment">//  add two from the top end to make sure the everything is within range</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      VOID</span></span><br><span class="line"><span class="comment">//      FatVerifyIndexIsValid (</span></span><br><span class="line"><span class="comment">//          IN PIRP_CONTEXT IrpContext,</span></span><br><span class="line"><span class="comment">//          IN PVCB Vcb,</span></span><br><span class="line"><span class="comment">//          IN ULONG Index</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatVerifyIndexIsValid(IC,V,I) &#123;                                       \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (((I) <span class="string">&lt; 2) || ((I) &gt;</span> ((V)-&gt;AllocationSupport.NumberOfClusters + 1))) &#123; \</span></span><br><span class="line"><span class="meta">        FatRaiseStatus(IC,STATUS_FILE_CORRUPT_ERROR);                         \</span></span><br><span class="line"><span class="meta">    &#125;                                                                         \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  These two macros are used to translate between Logical Byte Offsets,</span></span><br><span class="line"><span class="comment">//  and fat entry indexes.  Note the use of variables stored in the Vcb.</span></span><br><span class="line"><span class="comment">//  These two macros are used at a higher level than the other macros</span></span><br><span class="line"><span class="comment">//  above.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Note, these indexes are true cluster numbers.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  LBO</span></span><br><span class="line"><span class="comment">//  GetLboFromFatIndex (</span></span><br><span class="line"><span class="comment">//      IN FAT_ENTRY Fat_Index,</span></span><br><span class="line"><span class="comment">//      IN PVCB Vcb</span></span><br><span class="line"><span class="comment">//      );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  FAT_ENTRY</span></span><br><span class="line"><span class="comment">//  GetFatIndexFromLbo (</span></span><br><span class="line"><span class="comment">//      IN LBO Lbo,</span></span><br><span class="line"><span class="comment">//      IN PVCB Vcb</span></span><br><span class="line"><span class="comment">//      );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatGetLboFromIndex(VCB,FAT_INDEX) (                                       \</span></span><br><span class="line"><span class="meta">    ( (LBO)                                                                       \</span></span><br><span class="line"><span class="meta">        (VCB)-&gt;AllocationSupport.FileAreaLbo +                                    \</span></span><br><span class="line"><span class="meta">        (((LBO)((FAT_INDEX) - 2)) <span class="string">&lt;&lt; (VCB)-&gt;</span>AllocationSupport.LogOfBytesPerCluster) \</span></span><br><span class="line"><span class="meta">    )                                                                             \</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatGetIndexFromLbo(VCB,LBO) (                      \</span></span><br><span class="line"><span class="meta">    (ULONG) (                                              \</span></span><br><span class="line"><span class="meta">        (((LBO) - (VCB)-&gt;AllocationSupport.FileAreaLbo) &gt;&gt; \</span></span><br><span class="line"><span class="meta">        (VCB)-&gt;AllocationSupport.LogOfBytesPerCluster) + 2 \</span></span><br><span class="line"><span class="meta">    )                                                      \</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The following macro does the shifting and such to lookup an entry</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  VOID</span></span><br><span class="line"><span class="comment">//  FatLookup12BitEntry(</span></span><br><span class="line"><span class="comment">//      IN PVOID Fat,</span></span><br><span class="line"><span class="comment">//      IN FAT_ENTRY Index,</span></span><br><span class="line"><span class="comment">//      OUT PFAT_ENTRY Entry</span></span><br><span class="line"><span class="comment">//      );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatLookup12BitEntry(FAT,INDEX,ENTRY) &#123;                              \</span></span><br><span class="line"><span class="meta">                                                                            \</span></span><br><span class="line"><span class="meta">    CopyUchar2((PUCHAR)(ENTRY), (PUCHAR)(FAT) + (INDEX) * 3 / 2);           \</span></span><br><span class="line"><span class="meta">                                                                            \</span></span><br><span class="line"><span class="meta">    *ENTRY = (FAT_ENTRY)(0xfff &amp; (((INDEX) &amp; 1) ? (*(ENTRY) &gt;&gt; 4) :         \</span></span><br><span class="line"><span class="meta">                                                   *(ENTRY)));              \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The following macro does the tmp shifting and such to store an entry</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  VOID</span></span><br><span class="line"><span class="comment">//  FatSet12BitEntry(</span></span><br><span class="line"><span class="comment">//      IN PVOID Fat,</span></span><br><span class="line"><span class="comment">//      IN FAT_ENTRY Index,</span></span><br><span class="line"><span class="comment">//      IN FAT_ENTRY Entry</span></span><br><span class="line"><span class="comment">//      );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatSet12BitEntry(FAT,INDEX,ENTRY) &#123;                            \</span></span><br><span class="line"><span class="meta">                                                                       \</span></span><br><span class="line"><span class="meta">    FAT_ENTRY TmpFatEntry;                                             \</span></span><br><span class="line"><span class="meta">                                                                       \</span></span><br><span class="line"><span class="meta">    CopyUchar2((PUCHAR)&amp;TmpFatEntry, (PUCHAR)(FAT) + (INDEX) * 3 / 2); \</span></span><br><span class="line"><span class="meta">                                                                       \</span></span><br><span class="line"><span class="meta">    TmpFatEntry = (FAT_ENTRY)                                          \</span></span><br><span class="line"><span class="meta">                (((INDEX) &amp; 1) ? ((ENTRY) &lt;&lt; 4) | (TmpFatEntry &amp; 0xf)  \</span></span><br><span class="line"><span class="meta">                               : (ENTRY) | (TmpFatEntry &amp; 0xf000));    \</span></span><br><span class="line"><span class="meta">                                                                       \</span></span><br><span class="line"><span class="meta">    *((UNALIGNED UCHAR2 *)((PUCHAR)(FAT) + (INDEX) * 3 / 2)) = *((UNALIGNED UCHAR2 *)(&amp;TmpFatEntry)); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The following macro compares two FAT_TIME_STAMPs</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatAreTimesEqual(TIME1,TIME2) (                     \</span></span><br><span class="line"><span class="meta">    RtlEqualMemory((TIME1),(TIME2), sizeof(FAT_TIME_STAMP)) \</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_FILE_SIGNATURE                (0x4445) <span class="comment">// &quot;ED&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_SET_SIGNATURE                 (0x4145) <span class="comment">// &quot;EA&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  If the volume contains any ea data then there is one EA file called</span></span><br><span class="line"><span class="comment">//  &quot;EA DATA. SF&quot; located in the root directory as Hidden, System and</span></span><br><span class="line"><span class="comment">//  ReadOnly.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_EA_FILE_HEADER</span> &#123;</span><br><span class="line">    USHORT Signature;           <span class="comment">// offset = 0</span></span><br><span class="line">    USHORT FormatType;          <span class="comment">// offset = 2</span></span><br><span class="line">    USHORT LogType;             <span class="comment">// offset = 4</span></span><br><span class="line">    USHORT Cluster1;            <span class="comment">// offset = 6</span></span><br><span class="line">    USHORT NewCValue1;          <span class="comment">// offset = 8</span></span><br><span class="line">    USHORT Cluster2;            <span class="comment">// offset = 10</span></span><br><span class="line">    USHORT NewCValue2;          <span class="comment">// offset = 12</span></span><br><span class="line">    USHORT Cluster3;            <span class="comment">// offset = 14</span></span><br><span class="line">    USHORT NewCValue3;          <span class="comment">// offset = 16</span></span><br><span class="line">    USHORT Handle;              <span class="comment">// offset = 18</span></span><br><span class="line">    USHORT NewHOffset;          <span class="comment">// offset = 20</span></span><br><span class="line">    UCHAR  Reserved[<span class="number">10</span>];        <span class="comment">// offset = 22</span></span><br><span class="line">    USHORT EaBaseTable[<span class="number">240</span>];    <span class="comment">// offset = 32</span></span><br><span class="line">&#125; EA_FILE_HEADER;               <span class="comment">// sizeof = 512</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> EA_FILE_HEADER *PEA_FILE_HEADER;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> USHORT EA_OFF_TABLE[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> EA_OFF_TABLE *PEA_OFF_TABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Every file with an extended attribute contains in its dirent an index</span></span><br><span class="line"><span class="comment">//  into the EaMapTable.  The map table contains an offset within the ea</span></span><br><span class="line"><span class="comment">//  file (cluster aligned) of the ea data for the file.  The individual</span></span><br><span class="line"><span class="comment">//  ea data for each file is prefaced with an Ea Data Header.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_EA_SET_HEADER</span> &#123;</span><br><span class="line">    USHORT Signature;           <span class="comment">// offset = 0</span></span><br><span class="line">    USHORT OwnEaHandle;         <span class="comment">// offset = 2</span></span><br><span class="line">    ULONG32  NeedEaCount;         <span class="comment">// offset = 4</span></span><br><span class="line">    UCHAR  OwnerFileName[<span class="number">14</span>];   <span class="comment">// offset = 8</span></span><br><span class="line">    UCHAR  Reserved[<span class="number">4</span>];         <span class="comment">// offset = 22</span></span><br><span class="line">    UCHAR  cbList[<span class="number">4</span>];           <span class="comment">// offset = 26</span></span><br><span class="line">    UCHAR  PackedEas[<span class="number">1</span>];        <span class="comment">// offset = 30</span></span><br><span class="line">&#125; EA_SET_HEADER;                <span class="comment">// sizeof = 30</span></span><br><span class="line"><span class="keyword">typedef</span> EA_SET_HEADER *PEA_SET_HEADER;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_OF_EA_SET_HEADER       30</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXIMUM_EA_SIZE             0x0000ffff</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GetcbList(EASET) (((EASET)-&gt;cbList[0] &lt;&lt;  0) + \</span></span><br><span class="line"><span class="meta">                          ((EASET)-&gt;cbList[1] &lt;&lt;  8) + \</span></span><br><span class="line"><span class="meta">                          ((EASET)-&gt;cbList[2] &lt;&lt; 16) + \</span></span><br><span class="line"><span class="meta">                          ((EASET)-&gt;cbList[3] &lt;&lt; 24))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SetcbList(EASET,CB) &#123;                \</span></span><br><span class="line"><span class="meta">    (EASET)-&gt;cbList[0] = (CB &gt;&gt;  0) &amp; 0x0ff; \</span></span><br><span class="line"><span class="meta">    (EASET)-&gt;cbList[1] = (CB &gt;&gt;  8) &amp; 0x0ff; \</span></span><br><span class="line"><span class="meta">    (EASET)-&gt;cbList[2] = (CB &gt;&gt; 16) &amp; 0x0ff; \</span></span><br><span class="line"><span class="meta">    (EASET)-&gt;cbList[3] = (CB &gt;&gt; 24) &amp; 0x0ff; \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Every individual ea in an ea set is declared the following packed ea</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PACKED_EA</span> &#123;</span><br><span class="line">    UCHAR Flags;</span><br><span class="line">    UCHAR EaNameLength;</span><br><span class="line">    UCHAR EaValueLength[<span class="number">2</span>];</span><br><span class="line">    CHAR  EaName[<span class="number">1</span>];</span><br><span class="line">&#125; PACKED_EA;</span><br><span class="line"><span class="keyword">typedef</span> PACKED_EA *PPACKED_EA;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The following two macros are used to get and set the ea value length</span></span><br><span class="line"><span class="comment">//  field of a packed ea</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      VOID</span></span><br><span class="line"><span class="comment">//      GetEaValueLength (</span></span><br><span class="line"><span class="comment">//          IN PPACKED_EA Ea,</span></span><br><span class="line"><span class="comment">//          OUT PUSHORT ValueLength</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      VOID</span></span><br><span class="line"><span class="comment">//      SetEaValueLength (</span></span><br><span class="line"><span class="comment">//          IN PPACKED_EA Ea,</span></span><br><span class="line"><span class="comment">//          IN USHORT ValueLength</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GetEaValueLength(EA,LEN) &#123;               \</span></span><br><span class="line"><span class="meta">    *(LEN) = 0;                                  \</span></span><br><span class="line"><span class="meta">    CopyUchar2( (LEN), (EA)-&gt;EaValueLength );    \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SetEaValueLength(EA,LEN) &#123;               \</span></span><br><span class="line"><span class="meta">    CopyUchar2( &amp;((EA)-&gt;EaValueLength), (LEN) ); \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The following macro is used to get the size of a packed ea</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      VOID</span></span><br><span class="line"><span class="comment">//      SizeOfPackedEa (</span></span><br><span class="line"><span class="comment">//          IN PPACKED_EA Ea,</span></span><br><span class="line"><span class="comment">//          OUT PUSHORT EaSize</span></span><br><span class="line"><span class="comment">//          );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SizeOfPackedEa(EA,SIZE) &#123;          \</span></span><br><span class="line"><span class="meta">    ULONG _NL,_DL; _NL = 0; _DL = 0;       \</span></span><br><span class="line"><span class="meta">    CopyUchar1(&amp;_NL, &amp;(EA)-&gt;EaNameLength); \</span></span><br><span class="line"><span class="meta">    GetEaValueLength(EA, &amp;_DL);            \</span></span><br><span class="line"><span class="meta">    *(SIZE) = 1 + 1 + 2 + _NL + 1 + _DL;   \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_NEED_EA_FLAG                 0x80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_EA_HANDLE                   1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EA_HANDLE                   30719</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNUSED_EA_HANDLE                0xffff</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_CBLIST_OFFSET                0x1a</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EA_BASE_INDEX               240</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_EA_OFFSET_INDEX             128</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _FAT_</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="fat-headers-fatstruc-h"><a href="#fat-headers-fatstruc-h" class="headerlink" title="fat_headers\\fatstruc.h"></a>fat_headers\\fatstruc.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 1989-2000 Microsoft Corporation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    FatStruc.h</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This module defines the data structures that make up the major internal</span></span><br><span class="line"><span class="comment">    part of the Fat file system.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _FATSTRUC_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FATSTRUC_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> PVOID PBCB;     <span class="comment">//**** Bcb&#x27;s are now part of the cache module</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The FAT_DATA record is the top record in the Fat file system in-memory</span></span><br><span class="line"><span class="comment">//  data structure.  This structure must be allocated from non-paged pool.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FAT_DATA</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The type and size of this record (must be FAT_NTC_DATA_HEADER)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    NODE_TYPE_CODE NodeTypeCode;</span><br><span class="line">    NODE_BYTE_SIZE NodeByteSize;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    PVOID LazyWriteThread;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A queue of all the devices that are mounted by the file system.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LIST_ENTRY VcbQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to the Driver object we were initialized with</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PDRIVER_OBJECT DriverObject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to the filesystem device objects we created.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PVOID DiskFileSystemDeviceObject;</span><br><span class="line">    PVOID CdromFileSystemDeviceObject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A resource variable to control access to the global Fat data record</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ERESOURCE Resource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to our EPROCESS struct, which is a required input to the</span></span><br><span class="line">    <span class="comment">//  Cache Management subsystem.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PEPROCESS OurProcess;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following tells us if we should use Chicago extensions.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    BOOLEAN ChicagoMode:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field tells us if we are running on a Fujitsu</span></span><br><span class="line">    <span class="comment">//  FMR Series. These machines supports extra formats on the</span></span><br><span class="line">    <span class="comment">//  FAT file system.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    BOOLEAN FujitsuFMR:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Inidicates that FspClose is currently processing closes.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    BOOLEAN AsyncCloseActive:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following BOOLEAN says shutdown has started on FAT.  It</span></span><br><span class="line">    <span class="comment">//  instructs FspClose to not keep the Vcb resources anymore.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    BOOLEAN ShutdownStarted:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following flag tells us if we are going to generate LFNs</span></span><br><span class="line">    <span class="comment">//  for valid 8.3 names with extended characters.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    BOOLEAN CodePageInvariant:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following flags tell us if we are in an aggresive push to lower</span></span><br><span class="line">    <span class="comment">//  the size of the deferred close queues.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    BOOLEAN HighAsync:<span class="number">1</span>;</span><br><span class="line">    BOOLEAN HighDelayed:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following list entry is used for performing closes that can&#x27;t</span></span><br><span class="line">    <span class="comment">//  be done in the context of the original caller.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG AsyncCloseCount;</span><br><span class="line">    LIST_ENTRY AsyncCloseList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following two fields record if we are delaying a close.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG DelayedCloseCount;</span><br><span class="line">    LIST_ENTRY DelayedCloseList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This is the ExWorkerItem that does both kinds of deferred closes.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PIO_WORKITEM FatCloseItem;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This spinlock protects several rapid-fire operations. <span class="doctag">NOTE:</span> this is</span></span><br><span class="line">    <span class="comment">//  pretty horrible style.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    KSPIN_LOCK GeneralSpinLock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Cache manager call back structures, which must be passed on each call</span></span><br><span class="line">    <span class="comment">//  to CcInitializeCacheMap.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    CACHE_MANAGER_CALLBACKS CacheManagerCallbacks;</span><br><span class="line">    CACHE_MANAGER_CALLBACKS CacheManagerNoOpCallbacks;</span><br><span class="line"></span><br><span class="line">&#125; FAT_DATA;</span><br><span class="line"><span class="keyword">typedef</span> FAT_DATA *PFAT_DATA;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// An array of these structures will keep</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FAT_WINDOW</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ULONG FirstCluster;       <span class="comment">// The first cluster in this window.</span></span><br><span class="line">    ULONG LastCluster;        <span class="comment">// The last cluster in this window.</span></span><br><span class="line">    ULONG ClustersFree;       <span class="comment">// The number of clusters free in this window.</span></span><br><span class="line"></span><br><span class="line">&#125; FAT_WINDOW;</span><br><span class="line"><span class="keyword">typedef</span> FAT_WINDOW *PFAT_WINDOW;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Forward reference some circular referenced structures.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_VCB</span> VCB;</span><br><span class="line"><span class="keyword">typedef</span> VCB *PVCB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FCB</span> FCB;</span><br><span class="line"><span class="keyword">typedef</span> FCB *PFCB;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This structure is used to keep track of information needed to do a</span></span><br><span class="line"><span class="comment">//  deferred close.  It is now embedded in a CCB so we don&#x27;t have to</span></span><br><span class="line"><span class="comment">//  allocate one in the close path (with mustsucceed).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Two sets of links, one for the global list and one for closes</span></span><br><span class="line">    <span class="comment">//  on a particular volume.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    </span><br><span class="line">    LIST_ENTRY GlobalLinks;</span><br><span class="line">    LIST_ENTRY VcbLinks;</span><br><span class="line"></span><br><span class="line">    PVCB Vcb;</span><br><span class="line">    PFCB Fcb;</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">_TYPE_OF_OPEN</span> TypeOfOpen;</span><br><span class="line">    BOOLEAN Free;</span><br><span class="line"></span><br><span class="line">&#125; CLOSE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> CLOSE_CONTEXT *PCLOSE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The Vcb (Volume control Block) record corresponds to every volume mounted</span></span><br><span class="line"><span class="comment">//  by the file system.  They are ordered in a queue off of FatData.VcbQueue.</span></span><br><span class="line"><span class="comment">//  This structure must be allocated from non-paged pool</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_VCB_CONDITION</span> &#123;</span><br><span class="line">    VcbGood = <span class="number">1</span>,</span><br><span class="line">    VcbNotMounted,</span><br><span class="line">    VcbBad</span><br><span class="line">&#125; VCB_CONDITION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_VCB</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This is a common head for the FAT volume file</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    FSRTL_ADVANCED_FCB_HEADER VolumeFileHeader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The links for the device queue off of FatData.VcbQueue</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LIST_ENTRY VcbLinks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer the device object passed in by the I/O system on a mount</span></span><br><span class="line">    <span class="comment">//  This is the target device object that the file system talks to when it</span></span><br><span class="line">    <span class="comment">//  needs to do any I/O (e.g., the disk stripper device object).</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PDEVICE_OBJECT TargetDeviceObject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to the VPB for the volume passed in by the I/O system on</span></span><br><span class="line">    <span class="comment">//  a mount.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PVPB Vpb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The internal state of the device.  This is a collection of fsd device</span></span><br><span class="line">    <span class="comment">//  state flags.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG VcbState;</span><br><span class="line">    VCB_CONDITION VcbCondition;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to the root DCB for this volume</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_FCB</span> *RootDcb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  If the FAT has so many entries that the free cluster bitmap would</span></span><br><span class="line">    <span class="comment">//  be too large, we split the FAT into buckets, and only one bucket&#x27;s</span></span><br><span class="line">    <span class="comment">//  worth of bits are kept in the bitmap.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG NumberOfWindows;</span><br><span class="line">    PFAT_WINDOW Windows;</span><br><span class="line">    PFAT_WINDOW CurrentWindow;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A count of the number of file objects that have opened the volume</span></span><br><span class="line">    <span class="comment">//  for direct access, and their share access state.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    CLONG DirectAccessOpenCount;</span><br><span class="line">    SHARE_ACCESS ShareAccess;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A count of the number of file objects that have any file/directory</span></span><br><span class="line">    <span class="comment">//  opened on this volume, not including direct access.  And also the</span></span><br><span class="line">    <span class="comment">//  count of the number of file objects that have a file opened for</span></span><br><span class="line">    <span class="comment">//  only read access (i.e., they cannot be modifying the disk).</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    CLONG OpenFileCount;</span><br><span class="line">    CLONG ReadOnlyCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The bios parameter block field contains</span></span><br><span class="line">    <span class="comment">//  an unpacked copy of the bpb for the volume, it is initialized</span></span><br><span class="line">    <span class="comment">//  during mount time and can be read by everyone else after that.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    BIOS_PARAMETER_BLOCK Bpb;</span><br><span class="line"></span><br><span class="line">    PUCHAR First0x24BytesOfBootSector;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following structure contains information useful to the</span></span><br><span class="line">    <span class="comment">//  allocation support routines.  Many of them are computed from</span></span><br><span class="line">    <span class="comment">//  elements of the Bpb, but are too involved to recompute every time</span></span><br><span class="line">    <span class="comment">//  they are needed.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">        LBO RootDirectoryLbo;       <span class="comment">// Lbo of beginning of root directory</span></span><br><span class="line">        LBO FileAreaLbo;            <span class="comment">// Lbo of beginning of file area</span></span><br><span class="line">        ULONG RootDirectorySize;    <span class="comment">// size of root directory in bytes</span></span><br><span class="line"></span><br><span class="line">        ULONG NumberOfClusters;     <span class="comment">// total number of clusters on the volume</span></span><br><span class="line">        ULONG NumberOfFreeClusters; <span class="comment">// number of free clusters on the volume</span></span><br><span class="line"></span><br><span class="line">        UCHAR FatIndexBitSize;      <span class="comment">// indicates if 12, 16, or 32 bit fat table</span></span><br><span class="line"></span><br><span class="line">        UCHAR LogOfBytesPerSector;  <span class="comment">// Log(Bios-&gt;BytesPerSector)</span></span><br><span class="line">        UCHAR LogOfBytesPerCluster; <span class="comment">// Log(Bios-&gt;SectorsPerCluster)</span></span><br><span class="line"></span><br><span class="line">    &#125; AllocationSupport;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following Mcb is used to keep track of dirty sectors in the Fat.</span></span><br><span class="line">    <span class="comment">//  Runs of holes denote clean sectors while runs of LBO == VBO denote</span></span><br><span class="line">    <span class="comment">//  dirty sectors.  The VBOs are that of the volume file, starting at</span></span><br><span class="line">    <span class="comment">//  0.  The granuality of dirt is one sectors, and additions are only</span></span><br><span class="line">    <span class="comment">//  made in sector chunks to prevent problems with several simultaneous</span></span><br><span class="line">    <span class="comment">//  updaters.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LARGE_MCB DirtyFatMcb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The FreeClusterBitMap keeps track of all the clusters in the fat.</span></span><br><span class="line">    <span class="comment">//  A 1 means occupied while a 0 means free.  It allows quick location</span></span><br><span class="line">    <span class="comment">//  of contiguous runs of free clusters.  It is initialized on mount</span></span><br><span class="line">    <span class="comment">//  or verify.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    RTL_BITMAP FreeClusterBitMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following fast mutex controls access to the free cluster bit map</span></span><br><span class="line">    <span class="comment">//  and the buckets.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    FAST_MUTEX FreeClusterBitMapMutex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A resource variable to control access to the volume specific data</span></span><br><span class="line">    <span class="comment">//  structures</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ERESOURCE Resource;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A resource to make sure no one changes the volume bitmap while</span></span><br><span class="line">    <span class="comment">//  you&#x27;re using it.  Only for volumes with NumberOfWindows &gt; 1.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ERESOURCE ChangeBitMapResource;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field points to the file object used to do I/O to</span></span><br><span class="line">    <span class="comment">//  the virtual volume file.  The virtual volume file maps sectors</span></span><br><span class="line">    <span class="comment">//  0 through the end of fat and is of a fixed size (determined during</span></span><br><span class="line">    <span class="comment">//  mount)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PFILE_OBJECT VirtualVolumeFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field contains a record of special pointers used by</span></span><br><span class="line">    <span class="comment">//  MM and Cache to manipluate section objects.  Note that the values</span></span><br><span class="line">    <span class="comment">//  are set outside of the file system.  However the file system on an</span></span><br><span class="line">    <span class="comment">//  open/create will set the file object&#x27;s SectionObject field to point</span></span><br><span class="line">    <span class="comment">//  to this field</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    SECTION_OBJECT_POINTERS SectionObjectPointers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following fields is a hint cluster index used by the file system</span></span><br><span class="line">    <span class="comment">//  when allocating a new cluster.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG ClusterHint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This field contains the &quot;DeviceObject&quot; that this volume is</span></span><br><span class="line">    <span class="comment">//  currently mounted on.  Note Vcb-&gt;Vpb-&gt;RealDevice is constant.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PDEVICE_OBJECT CurrentDevice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This is a pointer to the file object and the Fcb which represent the ea data.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PFILE_OBJECT VirtualEaFile;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_FCB</span> *EaFcb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field is a pointer to the file object that has the</span></span><br><span class="line">    <span class="comment">//  volume locked. if the VcbState has the locked flag set.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PFILE_OBJECT FileObjectWithVcbLocked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following is the head of a list of notify Irps.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LIST_ENTRY DirNotifyList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following is used to synchronize the dir notify list.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PNOTIFY_SYNC NotifySync;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following fast mutex is used to synchronize directory stream</span></span><br><span class="line">    <span class="comment">//  file object creation.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    FAST_MUTEX DirectoryFileCreationMutex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This field holds the thread address of the current (or most recent</span></span><br><span class="line">    <span class="comment">//  depending on VcbState) thread doing a verify operation on this volume.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PKTHREAD VerifyThread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following two structures are used for CleanVolume callbacks.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    KDPC CleanVolumeDpc;</span><br><span class="line">    KTIMER CleanVolumeTimer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This field records the last time FatMarkVolumeDirty was called, and</span></span><br><span class="line">    <span class="comment">//  avoids excessive calls to push the CleanVolume forward in time.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LARGE_INTEGER LastFatMarkVolumeDirtyCall;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following fields holds a pointer to a struct which is used to</span></span><br><span class="line">    <span class="comment">//  hold performance counters.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_FILE_SYSTEM_STATISTICS</span> *Statistics;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The property tunneling cache for this volume</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    TUNNEL Tunnel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The media change count is returned by IOCTL_CHECK_VERIFY and</span></span><br><span class="line">    <span class="comment">//  is used to verify that no user-mode app has swallowed a media change</span></span><br><span class="line">    <span class="comment">//  notification.  This is only meaningful for removable media.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG ChangeCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Preallocated VPB for swapout, so we are not forced to consider</span></span><br><span class="line">    <span class="comment">//  must succeed pool.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PVPB SwapVpb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Per volume threading of the close queues.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LIST_ENTRY AsyncCloseList;</span><br><span class="line">    LIST_ENTRY DelayedCloseList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Fast mutex used by the ADVANCED FCB HEADER in this structure</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    FAST_MUTEX AdvancedFcbHeaderMutex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This is the close context associated with the Virtual Volume File.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PCLOSE_CONTEXT CloseContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  How many close contexts were preallocated on this Vcb</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DBG</span></span><br><span class="line">    ULONG CloseContextCount;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; VCB;</span><br><span class="line"><span class="keyword">typedef</span> VCB *PVCB;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_LOCKED              (0x00000001)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_REMOVABLE_MEDIA     (0x00000002)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_VOLUME_DIRTY        (0x00000004)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_MOUNTED_DIRTY       (0x00000010)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_SHUTDOWN            (0x00000040)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_CLOSE_IN_PROGRESS   (0x00000080)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_DELETED_FCB         (0x00000100)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_CREATE_IN_PROGRESS  (0x00000200)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_BOOT_OR_PAGING_FILE (0x00000800)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_DEFERRED_FLUSH      (0x00001000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_ASYNC_CLOSE_ACTIVE  (0x00002000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_WRITE_PROTECTED     (0x00004000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_REMOVAL_PREVENTED   (0x00008000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_FLAG_VOLUME_DISMOUNTED   (0x00010000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VCB_STATE_VPB_NOT_ON_DEVICE        (0x00020000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  N.B - VOLUME_DISMOUNTED is an indication that FSCTL_DISMOUNT volume was</span></span><br><span class="line"><span class="comment">//  executed on a volume. It does not replace VcbCondition as an indication</span></span><br><span class="line"><span class="comment">//  that the volume is invalid/unrecoverable.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Define the file system statistics struct.  Vcb-&gt;Statistics points to an</span></span><br><span class="line"><span class="comment">//  array of these (one per processor) and they must be 64 byte aligned to</span></span><br><span class="line"><span class="comment">//  prevent cache line tearing.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_SYSTEM_STATISTICS</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  This contains the actual data.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        FILESYSTEM_STATISTICS Common;</span><br><span class="line">        FAT_STATISTICS Fat;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Pad this structure to a multiple of 64 bytes.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        UCHAR Pad[<span class="number">64</span>-(<span class="built_in">sizeof</span>(FILESYSTEM_STATISTICS)+<span class="built_in">sizeof</span>(FAT_STATISTICS))%<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line">&#125; FILE_SYSTEM_STATISTICS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> FILE_SYSTEM_STATISTICS *PFILE_SYSTEM_STATISTICS;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The Volume Device Object is an I/O system device object with a workqueue</span></span><br><span class="line"><span class="comment">//  and an VCB record appended to the end.  There are multiple of these</span></span><br><span class="line"><span class="comment">//  records, one for every mounted volume, and are created during</span></span><br><span class="line"><span class="comment">//  a volume mount operation.  The work queue is for handling an overload of</span></span><br><span class="line"><span class="comment">//  work requests to the volume.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_VOLUME_DEVICE_OBJECT</span> &#123;</span><br><span class="line"></span><br><span class="line">    DEVICE_OBJECT DeviceObject;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field tells how many requests for this volume have</span></span><br><span class="line">    <span class="comment">//  either been enqueued to ExWorker threads or are currently being</span></span><br><span class="line">    <span class="comment">//  serviced by ExWorker threads.  If the number goes above</span></span><br><span class="line">    <span class="comment">//  a certain threshold, put the request on the overflow queue to be</span></span><br><span class="line">    <span class="comment">//  executed later.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG PostedRequestCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field indicates the number of IRP&#x27;s waiting</span></span><br><span class="line">    <span class="comment">//  to be serviced in the overflow queue.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG OverflowQueueCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field contains the queue header of the overflow queue.</span></span><br><span class="line">    <span class="comment">//  The Overflow queue is a list of IRP&#x27;s linked via the IRP&#x27;s ListEntry</span></span><br><span class="line">    <span class="comment">//  field.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LIST_ENTRY OverflowQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following spinlock protects access to all the above fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    KSPIN_LOCK OverflowQueueSpinLock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This is a common head for the FAT volume file</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    FSRTL_COMMON_FCB_HEADER VolumeFileHeader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This is the file system specific volume control block.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    VCB Vcb;</span><br><span class="line"></span><br><span class="line">&#125; VOLUME_DEVICE_OBJECT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> VOLUME_DEVICE_OBJECT *PVOLUME_DEVICE_OBJECT;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This is the structure used to contains the short name for a file</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FILE_NAME_NODE</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This points back to the Fcb for this file.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_FCB</span> *Fcb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This is the name of this node.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line"></span><br><span class="line">        OEM_STRING Oem;</span><br><span class="line"></span><br><span class="line">        UNICODE_STRING Unicode;</span><br><span class="line"></span><br><span class="line">    &#125; Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Marker so we can figure out what kind of name we opened up in</span></span><br><span class="line">    <span class="comment">//  Fcb searches</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    BOOLEAN FileNameDos;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  And the links.  Our parent Dcb has a pointer to the root entry.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    RTL_SPLAY_LINKS Links;</span><br><span class="line"></span><br><span class="line">&#125; FILE_NAME_NODE;</span><br><span class="line"><span class="keyword">typedef</span> FILE_NAME_NODE *PFILE_NAME_NODE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This structure contains fields which must be in non-paged pool.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_NON_PAGED_FCB</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field contains a record of special pointers used by</span></span><br><span class="line">    <span class="comment">//  MM and Cache to manipluate section objects.  Note that the values</span></span><br><span class="line">    <span class="comment">//  are set outside of the file system.  However the file system on an</span></span><br><span class="line">    <span class="comment">//  open/create will set the file object&#x27;s SectionObject field to point</span></span><br><span class="line">    <span class="comment">//  to this field</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    SECTION_OBJECT_POINTERS SectionObjectPointers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This context is non-zero only if the file currently has asynchronous</span></span><br><span class="line">    <span class="comment">//  non-cached valid data length extending writes.  It allows</span></span><br><span class="line">    <span class="comment">//  synchronization between pending writes and other operations.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG OutstandingAsyncWrites;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This event is set when OutstandingAsyncWrites transitions to zero.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PKEVENT OutstandingAsyncEvent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This is the mutex that is inserted into the FCB_ADVANCED_HEADER</span></span><br><span class="line">    <span class="comment">//  FastMutex field</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    FAST_MUTEX AdvancedFcbHeaderMutex;</span><br><span class="line"></span><br><span class="line">&#125; NON_PAGED_FCB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> NON_PAGED_FCB *PNON_PAGED_FCB;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The Fcb/Dcb record corresponds to every open file and directory, and to</span></span><br><span class="line"><span class="comment">//  every directory on an opened path.  They are ordered in two queues, one</span></span><br><span class="line"><span class="comment">//  queue contains every Fcb/Dcb record off of FatData.FcbQueue, the other</span></span><br><span class="line"><span class="comment">//  queue contains only device specific records off of Vcb.VcbSpecificFcbQueue</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_FCB_CONDITION</span> &#123;</span><br><span class="line">    FcbGood = <span class="number">1</span>,</span><br><span class="line">    FcbBad,</span><br><span class="line">    FcbNeedsToBeVerified</span><br><span class="line">&#125; FCB_CONDITION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FCB</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field is used for fast I/O</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following comments refer to the use of the AllocationSize field</span></span><br><span class="line">    <span class="comment">//  of the FsRtl-defined header to the nonpaged Fcb.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  For a directory when we create a Dcb we will not immediately</span></span><br><span class="line">    <span class="comment">//  initialize the cache map, instead we will postpone it until our first</span></span><br><span class="line">    <span class="comment">//  call to FatReadDirectoryFile or FatPrepareWriteDirectoryFile.</span></span><br><span class="line">    <span class="comment">//  At that time we will search the Fat to find out the current allocation</span></span><br><span class="line">    <span class="comment">//  size (by calling FatLookupFileAllocationSize) and then initialize the</span></span><br><span class="line">    <span class="comment">//  cache map to this allocation size.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  For a file when we create an Fcb we will not immediately initialize</span></span><br><span class="line">    <span class="comment">//  the cache map, instead we will postpone it until we need it and</span></span><br><span class="line">    <span class="comment">//  then we determine the allocation size from either searching the</span></span><br><span class="line">    <span class="comment">//  fat to determine the real file allocation, or from the allocation</span></span><br><span class="line">    <span class="comment">//  that we&#x27;ve just allocated if we&#x27;re creating a file.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A value of -1 indicates that we do not know what the current allocation</span></span><br><span class="line">    <span class="comment">//  size really is, and need to examine the fat to find it.  A value</span></span><br><span class="line">    <span class="comment">//  of than -1 is the real file/directory allocation size.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Whenever we need to extend the allocation size we call</span></span><br><span class="line">    <span class="comment">//  FatAddFileAllocation which (if we&#x27;re really extending the allocation)</span></span><br><span class="line">    <span class="comment">//  will modify the Fat, Mcb, and update this field.  The caller</span></span><br><span class="line">    <span class="comment">//  of FatAddFileAllocation is then responsible for altering the Cache</span></span><br><span class="line">    <span class="comment">//  map size.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  We are now using the ADVANCED fcb header to support filter contexts</span></span><br><span class="line">    <span class="comment">//  at the stream level</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    FSRTL_ADVANCED_FCB_HEADER Header;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This structure contains fields which must be in non-paged pool.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PNON_PAGED_FCB NonPaged;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The head of the fat alloaction chain.  FirstClusterOfFile == 0</span></span><br><span class="line">    <span class="comment">//  means that the file has no current allocation.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG FirstClusterOfFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The links for the queue of all fcbs for a specific dcb off of</span></span><br><span class="line">    <span class="comment">//  Dcb.ParentDcbQueue.  For the root directory this queue is empty</span></span><br><span class="line">    <span class="comment">//  For a non-existent fcb this queue is off of the non existent</span></span><br><span class="line">    <span class="comment">//  fcb queue entry in the vcb.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LIST_ENTRY ParentDcbLinks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to the Dcb that is the parent directory containing</span></span><br><span class="line">    <span class="comment">//  this fcb.  If this record itself is the root dcb then this field</span></span><br><span class="line">    <span class="comment">//  is null.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_FCB</span> *ParentDcb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to the Vcb containing this Fcb</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PVCB Vcb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The internal state of the Fcb.  This is a collection Fcb state flags.</span></span><br><span class="line">    <span class="comment">//  Also the shared access for each time this file/directory is opened.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG FcbState;</span><br><span class="line">    FCB_CONDITION FcbCondition;</span><br><span class="line">    SHARE_ACCESS ShareAccess;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SYSCACHE_COMPILE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  For syscache we keep a bitmask that tells us if we have dispatched IO for</span></span><br><span class="line">    <span class="comment">//  the page aligned chunks of the stream.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PULONG WriteMask;</span><br><span class="line">    ULONG WriteMaskData;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A count of the number of file objects that have been opened for</span></span><br><span class="line">    <span class="comment">//  this file/directory, but not yet been cleaned up yet.  This count</span></span><br><span class="line">    <span class="comment">//  is only used for data file objects, not for the Acl or Ea stream</span></span><br><span class="line">    <span class="comment">//  file objects.  This count gets decremented in FatCommonCleanup,</span></span><br><span class="line">    <span class="comment">//  while the OpenCount below gets decremented in FatCommonClose.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    CLONG UncleanCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A count of the number of file objects that have opened</span></span><br><span class="line">    <span class="comment">//  this file/directory.  For files &amp; directories the FsContext of the</span></span><br><span class="line">    <span class="comment">//  file object points to this record.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    CLONG OpenCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A count of how many of &quot;UncleanCount&quot; handles were opened for</span></span><br><span class="line">    <span class="comment">//  non-cached I/O.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    CLONG NonCachedUncleanCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field is used to locate the dirent for this fcb/dcb.</span></span><br><span class="line">    <span class="comment">//  All directory are opened as mapped files so the only additional</span></span><br><span class="line">    <span class="comment">//  information we need to locate this dirent (beside its parent directory)</span></span><br><span class="line">    <span class="comment">//  is the byte offset for the dirent.  Note that for the root dcb</span></span><br><span class="line">    <span class="comment">//  this field is not used.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    VBO DirentOffsetWithinDirectory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field is filled in when there is an Lfn associated</span></span><br><span class="line">    <span class="comment">//  with this file.  It is the STARTING offset of the Lfn.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    VBO LfnOffsetWithinDirectory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Thess entries is kept in ssync with the dirent.  It allows a more</span></span><br><span class="line">    <span class="comment">//  accurate verify capability and speeds up FatFastQueryBasicInfo().</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LARGE_INTEGER CreationTime;</span><br><span class="line">    LARGE_INTEGER LastAccessTime;</span><br><span class="line">    LARGE_INTEGER LastWriteTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Valid data to disk</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG ValidDataToDisk;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field contains the retrieval mapping structure</span></span><br><span class="line">    <span class="comment">//  for the file/directory.  Note that for the Root Dcb this</span></span><br><span class="line">    <span class="comment">//  structure is set at mount time.  Also note that in this</span></span><br><span class="line">    <span class="comment">//  implementation of Fat the Mcb really maps VBOs to LBOs and not</span></span><br><span class="line">    <span class="comment">//  VBNs to LBNs.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LARGE_MCB Mcb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following union is cased off of the node type code for the fcb.</span></span><br><span class="line">    <span class="comment">//  There is a seperate case for the directory versus file fcbs.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  A Directory Control Block (Dcb)</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  A queue of all the fcbs/dcbs that are opened under this</span></span><br><span class="line">            <span class="comment">//  Dcb.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            LIST_ENTRY ParentDcbQueue;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The following field points to the file object used to do I/O to</span></span><br><span class="line">            <span class="comment">//  the directory file for this dcb.  The directory file maps the</span></span><br><span class="line">            <span class="comment">//  sectors for the directory.  This field is initialized by</span></span><br><span class="line">            <span class="comment">//  CreateRootDcb but is left null by CreateDcb.  It isn&#x27;t</span></span><br><span class="line">            <span class="comment">//  until we try to read/write the directory file that we</span></span><br><span class="line">            <span class="comment">//  create the stream file object for non root dcbs.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            ULONG DirectoryFileOpenCount;</span><br><span class="line">            PFILE_OBJECT DirectoryFile;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  If the UnusedDirentVbo is != 0xffffffff, then the dirent at this</span></span><br><span class="line">            <span class="comment">//  offset is guarenteed to unused.  A value of 0xffffffff means</span></span><br><span class="line">            <span class="comment">//  it has yet to be initialized.  Note that a value beyond the</span></span><br><span class="line">            <span class="comment">//  end of allocation means that there an unused dirent, but we</span></span><br><span class="line">            <span class="comment">//  will have to allocate another cluster to use it.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  DeletedDirentHint contains lowest possible VBO of a deleted</span></span><br><span class="line">            <span class="comment">//  dirent (assuming as above that it is not 0xffffffff).</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            VBO UnusedDirentVbo;</span><br><span class="line">            VBO DeletedDirentHint;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The following two entries links together all the Fcbs</span></span><br><span class="line">            <span class="comment">//  opened under this Dcb sorted in a splay tree by name.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  I&#x27;d like to go into why we have (and must have) two separate</span></span><br><span class="line">            <span class="comment">//  splay trees within the current fastfat architecture.  I will</span></span><br><span class="line">            <span class="comment">//  provide some insight into what would have to change if we</span></span><br><span class="line">            <span class="comment">//  wanted to have a single UNICODE tree.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  What makes FAT unique is that both Oem and Unicode names sit</span></span><br><span class="line">            <span class="comment">//  side by side on disk.  Several unique UNICODE names coming</span></span><br><span class="line">            <span class="comment">//  into fastfat can match a single OEM on-disk name, and there</span></span><br><span class="line">            <span class="comment">//  is really no way to enumerate all the possible UNICODE</span></span><br><span class="line">            <span class="comment">//  source strings that can map to a given OEM name.  This argues</span></span><br><span class="line">            <span class="comment">//  for converting the incomming UNICODE name into OEM, and then</span></span><br><span class="line">            <span class="comment">//  running through an OEM splay tree of the open files.  This</span></span><br><span class="line">            <span class="comment">//  works well when there are only OEM names on disk.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The UNICODE name on disk can be VERY different from the short</span></span><br><span class="line">            <span class="comment">//  name in the DIRENT and not even representable in the OEM code</span></span><br><span class="line">            <span class="comment">//  page.  Even if it were representable in OEM, it is possible</span></span><br><span class="line">            <span class="comment">//  that a case varient of the original UNICODE name would match</span></span><br><span class="line">            <span class="comment">//  a different OEM name, causing us to miss the Fcb in the</span></span><br><span class="line">            <span class="comment">//  prefix lookup phase.  In these cases, we must put UNICODE</span></span><br><span class="line">            <span class="comment">//  name in the splay to guarentee that we find any case varient</span></span><br><span class="line">            <span class="comment">//  of the input UNICODE name.  See the routine description of</span></span><br><span class="line">            <span class="comment">//  FatConstructNamesInFcb() for a detailed analysis of how we</span></span><br><span class="line">            <span class="comment">//  detect this case.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The fundamental limitation we are imposing here is that if</span></span><br><span class="line">            <span class="comment">//  an Fcb exists for an open file, we MUST find it during the</span></span><br><span class="line">            <span class="comment">//  prefix stage.  This is a basic premise of the create path</span></span><br><span class="line">            <span class="comment">//  in fastfat.  In fact if we later find it gravelling through</span></span><br><span class="line">            <span class="comment">//  the disk (but not the splay tree), we will bug check if we</span></span><br><span class="line">            <span class="comment">//  try to add a duplicate entry to the splay tree (not to</span></span><br><span class="line">            <span class="comment">//  mention having two Fcbs).  If we had some mechanism to deal</span></span><br><span class="line">            <span class="comment">//  with cases (and they would be rare) that we don&#x27;t find the</span></span><br><span class="line">            <span class="comment">//  entry in the splay tree, but the Fcb is actually in there,</span></span><br><span class="line">            <span class="comment">//  then we could go to a single UNICODE splay tree.  While</span></span><br><span class="line">            <span class="comment">//  this uses more pool for the splay tree, and makes string</span></span><br><span class="line">            <span class="comment">//  compares maybe take a bit as longer, it would eliminate the</span></span><br><span class="line">            <span class="comment">//  need for any NLS conversion during the prefix phase, so it</span></span><br><span class="line">            <span class="comment">//  might really be a net win.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The current scheme was optimized for non-extended names</span></span><br><span class="line">            <span class="comment">//  (i.e. US names).  As soon as you start using extended</span></span><br><span class="line">            <span class="comment">//  characters, then it is clearly a win as many code paths</span></span><br><span class="line">            <span class="comment">//  become active that would otherwise not be needed if we</span></span><br><span class="line">            <span class="comment">//  only had a single UNICODE splay tree.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  We may think about changing this someday.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            PRTL_SPLAY_LINKS RootOemNode;</span><br><span class="line">            PRTL_SPLAY_LINKS RootUnicodeNode;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The following field keeps track of free dirents, i.e.,</span></span><br><span class="line">            <span class="comment">//  dirents that are either unallocated for deleted.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            RTL_BITMAP FreeDirentBitmap;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Since the FCB specific part of this union is larger, use</span></span><br><span class="line">            <span class="comment">//  the slack here for an initial bitmap buffer.  Currently</span></span><br><span class="line">            <span class="comment">//  there is enough space here for an 8K cluster.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            ULONG FreeDirentBitmapBuffer[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        &#125; Dcb;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  A File Control Block (Fcb)</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The following field is used by the filelock module</span></span><br><span class="line">            <span class="comment">//  to maintain current byte range locking information.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            FILE_LOCK FileLock;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The following field is used by the oplock module</span></span><br><span class="line">            <span class="comment">//  to maintain current oplock information.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            OPLOCK Oplock;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  This pointer is used to detect writes that eminated in the</span></span><br><span class="line">            <span class="comment">//  cache manager&#x27;s lazywriter.  It prevents lazy writer threads,</span></span><br><span class="line">            <span class="comment">//  who already have the Fcb shared, from trying to acquire it</span></span><br><span class="line">            <span class="comment">//  exclusive, and thus causing a deadlock.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            PVOID LazyWriteThread;</span><br><span class="line"></span><br><span class="line">        &#125; Fcb;</span><br><span class="line"></span><br><span class="line">    &#125; Specific;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field is used to verify that the Ea&#x27;s for a file</span></span><br><span class="line">    <span class="comment">//  have not changed between calls to query for Ea&#x27;s.  It is compared</span></span><br><span class="line">    <span class="comment">//  with a similar field in a Ccb.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  IMPORTANT!! **** DO NOT MOVE THIS FIELD ****</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//              The slack space in the union above is computed from</span></span><br><span class="line">    <span class="comment">//              the field offset of the EaModificationCount.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG EaModificationCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field is the fully qualified file name for this FCB/DCB</span></span><br><span class="line">    <span class="comment">//  starting from the root of the volume, and last file name in the</span></span><br><span class="line">    <span class="comment">//  fully qualified name.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    FILE_NAME_NODE ShortName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field is only filled in if it is needed with the user&#x27;s</span></span><br><span class="line">    <span class="comment">//  opened path</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    UNICODE_STRING FullFileName;</span><br><span class="line"></span><br><span class="line">    USHORT FinalNameLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  To make life simpler we also keep in the Fcb/Dcb a current copy of</span></span><br><span class="line">    <span class="comment">//  the fat attribute byte for the file/directory.  This field must</span></span><br><span class="line">    <span class="comment">//  also be updated when we create the Fcb, modify the File, or verify</span></span><br><span class="line">    <span class="comment">//  the Fcb</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    UCHAR DirentFatFlags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The case preserved long filename</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    UNICODE_STRING ExactCaseLongName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  If the UNICODE Lfn is fully expressible in the system Oem code</span></span><br><span class="line">    <span class="comment">//  page, then we will store it in a prefix table, otherwise we will</span></span><br><span class="line">    <span class="comment">//  store the last UNICODE name in the Fcb.  In both cases the name</span></span><br><span class="line">    <span class="comment">//  has been upcased.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Note that we may need neither of these fields if an LFN was strict</span></span><br><span class="line">    <span class="comment">//  8.3 or differed only in case.  Indeed if there wasn&#x27;t an LFN, we</span></span><br><span class="line">    <span class="comment">//  don&#x27;t need them at all.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  This first field is present if FCB_STATE_HAS_OEM_LONG_NAME</span></span><br><span class="line">        <span class="comment">//  is set in the FcbState.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        FILE_NAME_NODE Oem;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  This first field is present if FCB_STATE_HAS_UNICODE_LONG_NAME</span></span><br><span class="line">        <span class="comment">//  is set in the FcbState.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        FILE_NAME_NODE Unicode;</span><br><span class="line"></span><br><span class="line">    &#125; LongName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Defragmentation / ReallocateOnWrite synchronization object.  This</span></span><br><span class="line">    <span class="comment">//  is filled in by FatMoveFile() and affects the read and write paths.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PKEVENT MoveFileEvent;</span><br><span class="line"></span><br><span class="line">&#125; FCB, *PFCB;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BUILDING_FSKDEXT</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  DCB clashes with a type defined outside the filesystems,  in headers</span></span><br><span class="line"><span class="comment">//  pulled in by FSKD.  We don&#x27;t need this typedef for fskd anyway....</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">typedef</span> FCB DCB;</span><br><span class="line"><span class="keyword">typedef</span> DCB *PDCB;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Here are the Fcb state fields.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_DELETE_ON_CLOSE        (0x00000001)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_TRUNCATE_ON_CLOSE      (0x00000002)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_PAGING_FILE            (0x00000004)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_FORCE_MISS_IN_PROGRESS (0x00000008)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_FLUSH_FAT              (0x00000010)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_TEMPORARY              (0x00000020)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_SYSTEM_FILE            (0x00000080)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_NAMES_IN_SPLAY_TREE    (0x00000100)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_HAS_OEM_LONG_NAME      (0x00000200)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_HAS_UNICODE_LONG_NAME  (0x00000400)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_DELAY_CLOSE            (0x00000800)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Copies of the dirent&#x27;s FAT_DIRENT_NT_BYTE_* flags for</span></span><br><span class="line"><span class="comment">//  preserving case of the short name of a file</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_8_LOWER_CASE           (0x00001000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_STATE_3_LOWER_CASE           (0x00002000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This is the slack allocation in the Dcb part of the UNION above</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DCB_UNION_SLACK_SPACE ((ULONG)                       \</span></span><br><span class="line"><span class="meta">    (FIELD_OFFSET(DCB, EaModificationCount) -                \</span></span><br><span class="line"><span class="meta">     FIELD_OFFSET(DCB, Specific.Dcb.FreeDirentBitmapBuffer)) \</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This is the special (64bit) allocation size that indicates the</span></span><br><span class="line"><span class="comment">//  real size must be retrieved from disk.  Define it here so we</span></span><br><span class="line"><span class="comment">//  avoid excessive magic numbering around the driver.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FCB_LOOKUP_ALLOCATIONSIZE_HINT   ((LONGLONG) -1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The Ccb record is allocated for every file object.  Note that this</span></span><br><span class="line"><span class="comment">//  record is exactly 0x34 long on x86 so that it will fit into a 0x40</span></span><br><span class="line"><span class="comment">//  piece of pool.  Please carefully consider modifications.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Define the Flags field.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_MATCH_ALL               (0x0001)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_SKIP_SHORT_NAME_COMPARE (0x0002)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This tells us whether we allocated buffers to hold search templates.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_FREE_OEM_BEST_FIT       (0x0004)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_FREE_UNICODE            (0x0008)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  These flags prevents cleanup from updating the modify time, etc.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_USER_SET_LAST_WRITE     (0x0010)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_USER_SET_LAST_ACCESS    (0x0020)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_USER_SET_CREATION       (0x0040)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This bit says the file object associated with this Ccb was opened for</span></span><br><span class="line"><span class="comment">//  read only access.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_READ_ONLY               (0x0080)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  These flags, are used is DASD handles in read and write.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_DASD_FLUSH_DONE         (0x0100)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_DASD_PURGE_DONE         (0x0200)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This flag keeps track of a handle that was opened for</span></span><br><span class="line"><span class="comment">//  DELETE_ON_CLOSE.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_DELETE_ON_CLOSE         (0x0400)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This flag keeps track of which side of the name pair on the file</span></span><br><span class="line"><span class="comment">//  associated with the handle was opened</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_OPENED_BY_SHORTNAME     (0x0800)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This flag indicates that the query template has not been upcased</span></span><br><span class="line"><span class="comment">// (i.e., query should be case-insensitive)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_QUERY_TEMPLATE_MIXED    (0x1000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This flag indicates that reads and writes via this DASD handle</span></span><br><span class="line"><span class="comment">//  are allowed to start or extend past the end of file.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_ALLOW_EXTENDED_DASD_IO  (0x2000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This flag indicates we want to match volume labels in directory</span></span><br><span class="line"><span class="comment">//  searches (important for the root dir defrag).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_MATCH_VOLUME_ID         (0x4000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This flag indicates the ccb has been converted over into a</span></span><br><span class="line"><span class="comment">//  close context for asynchronous/delayed closing of the handle.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_CLOSE_CONTEXT           (0x8000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This flag indicates that when the handle is closed, we want</span></span><br><span class="line"><span class="comment">//  a physical dismount to occur.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_COMPLETE_DISMOUNT       (0x10000)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This flag indicates the handle may not call priveleged</span></span><br><span class="line"><span class="comment">//  FSCTL which modify the volume.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CCB_FLAG_MANAGE_VOLUME_ACCESS    (0x20000)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_CCB</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Type and size of this record (must be FAT_NTC_CCB)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    NODE_TYPE_CODE NodeTypeCode;</span><br><span class="line">    NODE_BYTE_SIZE NodeByteSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Define a 24bit wide field for Flags, but a UCHAR for Wild Cards Present</span></span><br><span class="line">    <span class="comment">//  since it is used so often.  Line these up on byte boundaries for grins.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    ULONG Flags:<span class="number">24</span>;</span><br><span class="line">    BOOLEAN ContainsWildCards;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Overlay a close context on the data of the CCB.  The remaining</span></span><br><span class="line">    <span class="comment">//  fields are not useful during close, and we would like to avoid</span></span><br><span class="line">    <span class="comment">//  paying extra pool for it.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  Save the offset to start search from.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            VBO OffsetToStartSearchFrom;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The query template is used to filter directory query requests.</span></span><br><span class="line">            <span class="comment">//  It originally is set to null and on the first call the NtQueryDirectory</span></span><br><span class="line">            <span class="comment">//  it is set to the input filename or &quot;*&quot; if the name is not supplied.</span></span><br><span class="line">            <span class="comment">//  All subsquent queries then use this template.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The Oem structure are unions because if the name is wild we store</span></span><br><span class="line">            <span class="comment">//  the arbitrary length string, while if the name is constant we store</span></span><br><span class="line">            <span class="comment">//  8.3 representation for fast comparison.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">union</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//  If the template contains a wild card use this.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">                OEM_STRING Wild;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//  If the name is constant, use this part.</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">                FAT8DOT3 Constant;</span><br><span class="line"></span><br><span class="line">            &#125; OemQueryTemplate;</span><br><span class="line"></span><br><span class="line">            UNICODE_STRING UnicodeQueryTemplate;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The field is compared with the similar field in the Fcb to determine</span></span><br><span class="line">            <span class="comment">//  if the Ea&#x27;s for a file have been modified.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            ULONG EaModificationCount;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//  The following field is used as an offset into the Eas for a</span></span><br><span class="line">            <span class="comment">//  particular file.  This will be the offset for the next</span></span><br><span class="line">            <span class="comment">//  Ea to return.  A value of 0xffffffff indicates that the</span></span><br><span class="line">            <span class="comment">//  Ea&#x27;s are exhausted.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            ULONG OffsetOfNextEaToReturn;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        CLOSE_CONTEXT CloseContext;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">&#125; CCB;</span><br><span class="line"><span class="keyword">typedef</span> CCB *PCCB;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The Irp Context record is allocated for every orginating Irp.  It is</span></span><br><span class="line"><span class="comment">//  created by the Fsd dispatch routines, and deallocated by the FatComplete</span></span><br><span class="line"><span class="comment">//  request routine.  It contains a structure called of type REPINNED_BCBS</span></span><br><span class="line"><span class="comment">//  which is used to retain pinned bcbs needed to handle abnormal termination</span></span><br><span class="line"><span class="comment">//  unwinding.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REPINNED_BCBS_ARRAY_SIZE         (4)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_REPINNED_BCBS</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to the next structure contains additional repinned bcbs</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_REPINNED_BCBS</span> *Next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A fixed size array of pinned bcbs.  Whenever a new bcb is added to</span></span><br><span class="line">    <span class="comment">//  the repinned bcb structure it is added to this array.  If the</span></span><br><span class="line">    <span class="comment">//  array is already full then another repinned bcb structure is allocated</span></span><br><span class="line">    <span class="comment">//  and pointed to with Next.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PBCB Bcb[ REPINNED_BCBS_ARRAY_SIZE ];</span><br><span class="line"></span><br><span class="line">&#125; REPINNED_BCBS;</span><br><span class="line"><span class="keyword">typedef</span> REPINNED_BCBS *PREPINNED_BCBS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IRP_CONTEXT</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Type and size of this record (must be FAT_NTC_IRP_CONTEXT)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    NODE_TYPE_CODE NodeTypeCode;</span><br><span class="line">    NODE_BYTE_SIZE NodeByteSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  This structure is used for posting to the Ex worker threads.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    WORK_QUEUE_ITEM WorkQueueItem;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  A pointer to the originating Irp.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PIRP OriginatingIrp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Originating Device (required for workque algorithms)</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PDEVICE_OBJECT RealDevice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Originating Vcb (required for exception handling)</span></span><br><span class="line">    <span class="comment">//  On mounts, this will be set before any exceptions</span></span><br><span class="line">    <span class="comment">//  indicating corruption can be thrown.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PVCB Vcb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Major and minor function codes copied from the Irp</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    UCHAR MajorFunction;</span><br><span class="line">    UCHAR MinorFunction;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following fields indicate if we can wait/block for a resource</span></span><br><span class="line">    <span class="comment">//  or I/O, if we are to do everything write through, and if this</span></span><br><span class="line">    <span class="comment">//  entry into the Fsd is a recursive call.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    UCHAR PinCount;</span><br><span class="line"></span><br><span class="line">    ULONG Flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following field contains the NTSTATUS value used when we are</span></span><br><span class="line">    <span class="comment">//  unwinding due to an exception</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    NTSTATUS ExceptionStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  The following context block is used for non-cached Io</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_FAT_IO_CONTEXT</span> *FatIoContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  For a abnormal termination unwinding this field contains the Bcbs</span></span><br><span class="line">    <span class="comment">//  that are kept pinned until the Irp is completed.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    REPINNED_BCBS Repinned;</span><br><span class="line"></span><br><span class="line">&#125; IRP_CONTEXT;</span><br><span class="line"><span class="keyword">typedef</span> IRP_CONTEXT *PIRP_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_DISABLE_DIRTY              (0x00000001)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_WAIT                       (0x00000002)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_WRITE_THROUGH              (0x00000004)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_DISABLE_WRITE_THROUGH      (0x00000008)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_RECURSIVE_CALL             (0x00000010)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_DISABLE_POPUPS             (0x00000020)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_DEFERRED_WRITE             (0x00000040)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_VERIFY_READ                (0x00000080)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_STACK_IO_CONTEXT                (0x00000100)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_IN_FSP                     (0x00000200)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_USER_IO                    (0x00000400)       <span class="comment">// for performance counters</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_DISABLE_RAISE              (0x00000800)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_CONTEXT_FLAG_PARENT_BY_CHILD (0x80000000)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Context structure for non-cached I/O calls.  Most of these fields</span></span><br><span class="line"><span class="comment">//  are actually only required for the Read/Write Multiple routines, but</span></span><br><span class="line"><span class="comment">//  the caller must allocate one as a local variable anyway before knowing</span></span><br><span class="line"><span class="comment">//  whether there are multiple requests are not.  Therefore, a single</span></span><br><span class="line"><span class="comment">//  structure is used for simplicity.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_FAT_IO_CONTEXT</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  These two field are used for multiple run Io</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    LONG IrpCount;</span><br><span class="line">    PIRP MasterIrp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  MDL to describe partial sector zeroing</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    PMDL ZeroMdl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  This element handles the asychronous non-cached Io</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            PERESOURCE Resource;</span><br><span class="line">            PERESOURCE Resource2;</span><br><span class="line">            ERESOURCE_THREAD ResourceThreadId;</span><br><span class="line">            ULONG RequestedByteCount;</span><br><span class="line">            PFILE_OBJECT FileObject;</span><br><span class="line">            PNON_PAGED_FCB NonPagedFcb;</span><br><span class="line">        &#125; Async;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  and this element the sycnrhonous non-cached Io</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        KEVENT SyncEvent;</span><br><span class="line"></span><br><span class="line">    &#125; Wait;</span><br><span class="line"></span><br><span class="line">&#125; FAT_IO_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> FAT_IO_CONTEXT *PFAT_IO_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  An array of these structures is passed to FatMultipleAsync describing</span></span><br><span class="line"><span class="comment">//  a set of runs to execute in parallel.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IO_RUNS</span> &#123;</span><br><span class="line"></span><br><span class="line">    LBO Lbo;</span><br><span class="line">    VBO Vbo;</span><br><span class="line">    ULONG Offset;</span><br><span class="line">    ULONG ByteCount;</span><br><span class="line">    PIRP SavedIrp;</span><br><span class="line"></span><br><span class="line">&#125; IO_RUN;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> IO_RUN *PIO_RUN;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This structure is used by FatDeleteDirent to preserve the first cluster</span></span><br><span class="line"><span class="comment">//  and file size info for undelete utilities.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DELETE_CONTEXT</span> &#123;</span><br><span class="line"></span><br><span class="line">    ULONG FileSize;</span><br><span class="line">    ULONG FirstClusterOfFile;</span><br><span class="line"></span><br><span class="line">&#125; DELETE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> DELETE_CONTEXT *PDELETE_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This record is used with to set a flush to go off one second after the</span></span><br><span class="line"><span class="comment">//  first write on slow devices with a physical indication of activity, like</span></span><br><span class="line"><span class="comment">//  a floppy.  This is an attempt to keep the red light on.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_DEFERRED_FLUSH_CONTEXT</span> &#123;</span><br><span class="line"></span><br><span class="line">    KDPC Dpc;</span><br><span class="line">    KTIMER Timer;</span><br><span class="line">    WORK_QUEUE_ITEM Item;</span><br><span class="line"></span><br><span class="line">    PFILE_OBJECT File;</span><br><span class="line"></span><br><span class="line">&#125; DEFERRED_FLUSH_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> DEFERRED_FLUSH_CONTEXT *PDEFERRED_FLUSH_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This structure is used for the FatMarkVolumeClean callbacks.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_CLEAN_AND_DIRTY_VOLUME_PACKET</span> &#123;</span><br><span class="line"></span><br><span class="line">    WORK_QUEUE_ITEM Item;</span><br><span class="line">    PIRP Irp;</span><br><span class="line">    PVCB Vcb;</span><br><span class="line">    PKEVENT Event;</span><br><span class="line">&#125; CLEAN_AND_DIRTY_VOLUME_PACKET, *PCLEAN_AND_DIRTY_VOLUME_PACKET;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This structure is used when a page fault is running out of stack.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PAGING_FILE_OVERFLOW_PACKET</span> &#123;</span><br><span class="line">    PIRP Irp;</span><br><span class="line">    PFCB Fcb;</span><br><span class="line">&#125; PAGING_FILE_OVERFLOW_PACKET, *PPAGING_FILE_OVERFLOW_PACKET;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This structure is used to access the EaFile.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_BCB_ARRAY_SIZE                   8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_EA_RANGE</span> &#123;</span><br><span class="line"></span><br><span class="line">    PCHAR Data;</span><br><span class="line">    ULONG StartingVbo;</span><br><span class="line">    ULONG Length;</span><br><span class="line">    USHORT BcbChainLength;</span><br><span class="line">    BOOLEAN AuxilaryBuffer;</span><br><span class="line">    PBCB *BcbChain;</span><br><span class="line">    PBCB BcbArray[EA_BCB_ARRAY_SIZE];</span><br><span class="line"></span><br><span class="line">&#125; EA_RANGE, *PEA_RANGE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EA_RANGE_HEADER_SIZE        (FIELD_OFFSET( EA_RANGE, BcbArray ))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  These symbols are used by the upcase/downcase routines.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WIDE_LATIN_CAPITAL_A    (0xff21)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WIDE_LATIN_CAPITAL_Z    (0xff3a)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WIDE_LATIN_SMALL_A      (0xff41)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WIDE_LATIN_SMALL_Z      (0xff5a)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  These values are returned by FatInterpretClusterType.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">_CLUSTER_TYPE</span> &#123;</span><br><span class="line">    FatClusterAvailable,</span><br><span class="line">    FatClusterReserved,</span><br><span class="line">    FatClusterBad,</span><br><span class="line">    FatClusterLast,</span><br><span class="line">    FatClusterNext</span><br><span class="line">&#125; CLUSTER_TYPE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _FATSTRUC_</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="fat-headers-lfn-h"><a href="#fat-headers-lfn-h" class="headerlink" title="fat_headers\\lfn.h"></a>fat_headers\\lfn.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 1989-2000 Microsoft Corporation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Lfn.h</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This module defines the on-disk structure of long file names on FAT.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _LFN_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _LFN_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This strucure defines the on disk format on long file name dirents.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PACKED_LFN_DIRENT</span> &#123;</span><br><span class="line">    UCHAR     Ordinal;    <span class="comment">//  offset =  0</span></span><br><span class="line">    UCHAR     Name1[<span class="number">10</span>];  <span class="comment">//  offset =  1 (Really 5 chars, but not WCHAR aligned)</span></span><br><span class="line">    UCHAR     Attributes; <span class="comment">//  offset = 11</span></span><br><span class="line">    UCHAR     Type;       <span class="comment">//  offset = 12</span></span><br><span class="line">    UCHAR     Checksum;   <span class="comment">//  offset = 13</span></span><br><span class="line">    WCHAR     Name2[<span class="number">6</span>];   <span class="comment">//  offset = 14</span></span><br><span class="line">    USHORT    MustBeZero; <span class="comment">//  offset = 26</span></span><br><span class="line">    WCHAR     Name3[<span class="number">2</span>];   <span class="comment">//  offset = 28</span></span><br><span class="line">&#125; PACKED_LFN_DIRENT;      <span class="comment">//  sizeof = 32</span></span><br><span class="line"><span class="keyword">typedef</span> PACKED_LFN_DIRENT *PPACKED_LFN_DIRENT;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_LAST_LONG_ENTRY             0x40 <span class="comment">// Ordinal field</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_LONG_NAME_COMP              0x0  <span class="comment">// Type field</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  A packed lfn dirent is already quadword aligned so simply declare a</span></span><br><span class="line"><span class="comment">//  lfn dirent as a packed lfn dirent.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> PACKED_LFN_DIRENT LFN_DIRENT;</span><br><span class="line"><span class="keyword">typedef</span> LFN_DIRENT *PLFN_DIRENT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  This is the largest size buffer we would ever need to read an Lfn</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_LFN_CHARACTERS              260</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_LFN_DIRENTS                 20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_LFN_DIRENTS_NEEDED(NAME) (((NAME)-&gt;Length/sizeof(WCHAR) + 12)/13)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _LFN_</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="fat-headers-nodetype-h"><a href="#fat-headers-nodetype-h" class="headerlink" title="fat_headers\\nodetype.h"></a>fat_headers\\nodetype.h</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Copyright (c) 1989-2000 Microsoft Corporation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Module Name:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    NodeType.h</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Abstract:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This module defines all of the node type codes used in this development</span></span><br><span class="line"><span class="comment">    shell.  Every major data structure in the file system is assigned a node</span></span><br><span class="line"><span class="comment">    type code that is.  This code is the first CSHORT in the structure and is</span></span><br><span class="line"><span class="comment">    followed by a CSHORT containing the size, in bytes, of the structure.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _FATNODETYPE_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FATNODETYPE_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> CSHORT NODE_TYPE_CODE;</span><br><span class="line"><span class="keyword">typedef</span> NODE_TYPE_CODE *PNODE_TYPE_CODE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NTC_UNDEFINED                    ((NODE_TYPE_CODE)0x0000)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_NTC_DATA_HEADER              ((NODE_TYPE_CODE)0x0500)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_NTC_VCB                      ((NODE_TYPE_CODE)0x0501)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_NTC_FCB                      ((NODE_TYPE_CODE)0x0502)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_NTC_DCB                      ((NODE_TYPE_CODE)0x0503)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_NTC_ROOT_DCB                 ((NODE_TYPE_CODE)0x0504)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_NTC_CCB                      ((NODE_TYPE_CODE)0x0507)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_NTC_IRP_CONTEXT              ((NODE_TYPE_CODE)0x0508)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> CSHORT NODE_BYTE_SIZE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NodeType</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  So all records start with</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  typedef struct _RECORD_NAME &#123;</span></span><br><span class="line"><span class="comment">//      NODE_TYPE_CODE NodeTypeCode;</span></span><br><span class="line"><span class="comment">//      NODE_BYTE_SIZE NodeByteSize;</span></span><br><span class="line"><span class="comment">//          :</span></span><br><span class="line"><span class="comment">//  &#125; RECORD_NAME;</span></span><br><span class="line"><span class="comment">//  typedef RECORD_NAME *PRECORD_NAME;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NodeType(Ptr) (*((PNODE_TYPE_CODE)(Ptr)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  The following definitions are used to generate meaningful blue bugcheck</span></span><br><span class="line"><span class="comment">//  screens.  On a bugcheck the file system can output 4 ulongs of useful</span></span><br><span class="line"><span class="comment">//  information.  The first ulong will have encoded in it a source file id</span></span><br><span class="line"><span class="comment">//  (in the high word) and the line number of the bugcheck (in the low word).</span></span><br><span class="line"><span class="comment">//  The other values can be whatever the caller of the bugcheck routine deems</span></span><br><span class="line"><span class="comment">//  necessary.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Each individual file that calls bugcheck needs to have defined at the</span></span><br><span class="line"><span class="comment">//  start of the file a constant called BugCheckFileId with one of the</span></span><br><span class="line"><span class="comment">//  FAT_BUG_CHECK_ values defined below and then use FatBugCheck to bugcheck</span></span><br><span class="line"><span class="comment">//  the system.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_ACCHKSUP           (0x00010000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_ALLOCSUP           (0x00020000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_CACHESUP           (0x00030000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_CLEANUP            (0x00040000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_CLOSE              (0x00050000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_CREATE             (0x00060000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_DEVCTRL            (0x00070000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_DEVIOSUP           (0x00080000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_DIRCTRL            (0x00090000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_DIRSUP             (0x000a0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_DUMPSUP            (0x000b0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_EA                 (0x000c0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_EASUP              (0x000d0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_FATDATA            (0x000e0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_FATINIT            (0x000f0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_FILEINFO           (0x00100000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_FILOBSUP           (0x00110000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_FLUSH              (0x00120000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_FSCTRL             (0x00130000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_FSPDISP            (0x00140000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_LOCKCTRL           (0x00150000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_NAMESUP            (0x00160000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_PNP                (0x00170000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_READ               (0x00180000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_RESRCSUP           (0x00190000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_SHUTDOWN           (0x001a0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_SPLAYSUP           (0x001b0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_STRUCSUP           (0x001c0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_TIMESUP            (0x001d0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_VERFYSUP           (0x001e0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_VOLINFO            (0x001f0000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_WORKQUE            (0x00200000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAT_BUG_CHECK_WRITE              (0x00210000)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FatBugCheck(A,B,C) &#123; KeBugCheckEx(FAT_FILE_SYSTEM, BugCheckFileId | __LINE__, A, B, C ); &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  In this module we&#x27;ll also define some globally known constants</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_NUL                        0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_SOH                        0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_STX                        0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_ETX                        0x03</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_EOT                        0x04</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_ENQ                        0x05</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_ACK                        0x06</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_BEL                        0x07</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_BS                         0x08</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_HT                         0x09</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_LF                         0x0a</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_VT                         0x0b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_FF                         0x0c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_CR                         0x0d</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_SO                         0x0e</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_SI                         0x0f</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_DLE                        0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_DC1                        0x11</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_DC2                        0x12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_DC3                        0x13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_DC4                        0x14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_NAK                        0x15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_SYN                        0x16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_ETB                        0x17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_CAN                        0x18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_EM                         0x19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_SUB                        0x1a</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_ESC                        0x1b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_FS                         0x1c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_GS                         0x1d</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_RS                         0x1e</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_US                         0x1f</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UCHAR_SP                         0x20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> BUILDING_FSKDEXT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  These are the tags we use to uniquely identify pool allocations.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_CCB                         <span class="string">&#x27;CtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_FCB                         <span class="string">&#x27;FtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_FCB_NONPAGED                <span class="string">&#x27;NtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_ERESOURCE                   <span class="string">&#x27;EtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_IRP_CONTEXT                 <span class="string">&#x27;ItaF&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_BCB                         <span class="string">&#x27;btaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_DIRENT                      <span class="string">&#x27;DtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_DIRENT_BITMAP               <span class="string">&#x27;TtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_EA_DATA                     <span class="string">&#x27;dtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_EA_SET_HEADER               <span class="string">&#x27;etaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_EVENT                       <span class="string">&#x27;vtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_FAT_BITMAP                  <span class="string">&#x27;BtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_FAT_CLOSE_CONTEXT           <span class="string">&#x27;xtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_FAT_IO_CONTEXT              <span class="string">&#x27;XtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_FAT_WINDOW                  <span class="string">&#x27;WtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_FILENAME_BUFFER             <span class="string">&#x27;ntaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_IO_RUNS                     <span class="string">&#x27;itaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_REPINNED_BCB                <span class="string">&#x27;RtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_STASHED_BPB                 <span class="string">&#x27;StaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_VCB_STATS                   <span class="string">&#x27;VtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_DEFERRED_FLUSH_CONTEXT      <span class="string">&#x27;ftaF&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_VPB                         <span class="string">&#x27;vtaF&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_VERIFY_BOOTSECTOR           <span class="string">&#x27;staF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_VERIFY_ROOTDIR              <span class="string">&#x27;rtaF&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_OUTPUT_MAPPINGPAIRS         <span class="string">&#x27;PtaF&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_ENTRY_LOOKUP_BUFFER         <span class="string">&#x27;LtaF&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_IO_BUFFER                   <span class="string">&#x27;OtaF&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_IO_USER_BUFFER              <span class="string">&#x27;QtaF&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TAG_DYNAMIC_NAME_BUFFER         <span class="string">&#x27;ctaF&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _NODETYPE_</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="sfilter-h"><a href="#sfilter-h" class="headerlink" title="sfilter.h"></a>sfilter.h</h3><p>之前有了，这里就不放了。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://Monoceros.github.io">Monoceros406</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://monoceros.github.io/2024/05/27/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%80%8F%E6%98%8E%E5%8A%A0%E5%AF%86%E6%BA%90%E7%A0%81/">http://monoceros.github.io/2024/05/27/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%80%8F%E6%98%8E%E5%8A%A0%E5%AF%86%E6%BA%90%E7%A0%81/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://Monoceros.github.io" target="_blank">The Blog of Monoceros406</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">逆向工程</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/28/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%BE%AE%E8%BF%87%E6%BB%A4%E9%A9%B1%E5%8A%A8/" title="Windows驱动开发入门-文件系统微过滤驱动"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Windows驱动开发入门-文件系统微过滤驱动</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/26/Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%80%8F%E6%98%8E%E5%8A%A0%E5%AF%86/" title="Windows驱动开发入门-文件系统透明加密"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Windows驱动开发入门-文件系统透明加密</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/11/16/Angr%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/" title="Angr做题笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="title">Angr做题笔记</div></div></a></div><div><a href="/2023/10/29/Angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%AC%94%E8%AE%B0/" title="Angr符号执行笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">Angr符号执行笔记</div></div></a></div><div><a href="/2023/11/09/C-%E7%97%85%E6%AF%92%E6%8A%80%E6%9C%AF/" title="C++病毒技术"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-09</div><div class="title">C++病毒技术</div></div></a></div><div><a href="/2023/11/15/CvxPy%E6%95%B4%E6%95%B0%E8%A7%84%E5%88%92%E7%AC%94%E8%AE%B0/" title="CvxPy整数规划笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-15</div><div class="title">CvxPy整数规划笔记</div></div></a></div><div><a href="/2023/10/21/IDA%E5%9C%A8Kali-Linux%E4%B8%8B%E7%9A%84%E8%BF%9C%E7%A8%8B%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E7%AC%94%E8%AE%B0/" title="IDA在Kali Linux下的远程动态调试笔记"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-21</div><div class="title">IDA在Kali Linux下的远程动态调试笔记</div></div></a></div><div><a href="/2023/10/29/IDA%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/" title="IDA脚本编程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-29</div><div class="title">IDA脚本编程</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Monoceros406</div><div class="author-info__description">智邮普创工作室安全组/Nepnep联合战队</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">257</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">23</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Monoceros406"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Monoceros406" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:monoceros406@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">QQ:1295625063（不找对象）</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E9%80%8F%E6%98%8E%E5%8A%A0%E5%AF%86%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">Windows驱动开发入门-文件系统透明加密源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.</span> <span class="toc-text">源代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-create-c"><span class="toc-number">1.1.1.</span> <span class="toc-text">cf_create.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-file-irp-c"><span class="toc-number">1.1.2.</span> <span class="toc-text">cf_file_irp.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-list-c"><span class="toc-number">1.1.3.</span> <span class="toc-text">cf_list.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-modify-irp-c"><span class="toc-number">1.1.4.</span> <span class="toc-text">cf_modify_irp.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-proc-c"><span class="toc-number">1.1.5.</span> <span class="toc-text">cf_proc.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-sfilter-c"><span class="toc-number">1.1.6.</span> <span class="toc-text">cf_sfilter.c</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">头文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-create-h"><span class="toc-number">1.2.1.</span> <span class="toc-text">cf_create.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-file-irp-h"><span class="toc-number">1.2.2.</span> <span class="toc-text">cf_file_irp.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-list-h"><span class="toc-number">1.2.3.</span> <span class="toc-text">cf_list.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-modify-irp-h"><span class="toc-number">1.2.4.</span> <span class="toc-text">cf_modify_irp.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf-proc-h"><span class="toc-number">1.2.5.</span> <span class="toc-text">cf_proc.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fat-headers-fat-h"><span class="toc-number">1.2.6.</span> <span class="toc-text">fat_headers\\fat.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fat-headers-fatstruc-h"><span class="toc-number">1.2.7.</span> <span class="toc-text">fat_headers\\fatstruc.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fat-headers-lfn-h"><span class="toc-number">1.2.8.</span> <span class="toc-text">fat_headers\\lfn.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fat-headers-nodetype-h"><span class="toc-number">1.2.9.</span> <span class="toc-text">fat_headers\\nodetype.h</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sfilter-h"><span class="toc-number">1.2.10.</span> <span class="toc-text">sfilter.h</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/26/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-WinSock%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" title="WindowsAPI查缺补漏-WinSock网络编程">WindowsAPI查缺补漏-WinSock网络编程</a><time datetime="2024-07-26T07:48:34.000Z" title="发表于 2024-07-26 15:48:34">2024-07-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/25/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E5%9E%AB%E7%89%87/" title="Windows软件调试初探-垫片">Windows软件调试初探-垫片</a><time datetime="2024-07-25T12:51:47.000Z" title="发表于 2024-07-25 20:51:47">2024-07-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/25/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E7%89%B9%E6%AE%8A%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8/" title="Windows软件调试初探-特殊过程调用">Windows软件调试初探-特殊过程调用</a><time datetime="2024-07-25T00:55:09.000Z" title="发表于 2024-07-25 08:55:09">2024-07-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/23/Windows%E8%BD%AF%E4%BB%B6%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" title="Windows软件调试初探-启动过程">Windows软件调试初探-启动过程</a><time datetime="2024-07-23T14:58:16.000Z" title="发表于 2024-07-23 22:58:16">2024-07-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/22/WindowsAPI%E6%9F%A5%E7%BC%BA%E8%A1%A5%E6%BC%8F-%E6%9D%82%E8%B0%88/" title="WindowsAPI查缺补漏-杂谈">WindowsAPI查缺补漏-杂谈</a><time datetime="2024-07-22T12:36:50.000Z" title="发表于 2024-07-22 20:36:50">2024-07-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Monoceros406</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="docsearch-wrap"><div id="docsearch" style="display:none"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css/dist/style.min.css"/><script src="https://cdn.jsdelivr.net/npm/@docsearch/js/dist/umd/index.min.js"></script><script>(() => {
  docsearch(Object.assign({
    appId: '',
    apiKey: '',
    indexName: '',
    container: '#docsearch',
  }, null))

  const handleClick = () => {
    document.querySelector('.DocSearch-Button').click()
  }

  const searchClickFn = () => {
    btf.addEventListenerPjax(document.querySelector('#search-button > .search'), 'click', handleClick)
  }

  searchClickFn()
  window.addEventListener('pjax:complete', searchClickFn)
})()</script></div></div></body></html>